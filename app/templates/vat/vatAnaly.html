{% extends 'components/base.html' %}
{% load static %}

{% block styles %}
<!-- Styles -->
<style>
  #chartdiv {
    width: 100%;
    height: 500px;
  }

</style>
{% endblock %}
    
{% block content %}
<!-- PAGE-HEADER -->
<div class="page-header">
  <div id="divH1"> </div>  
  <!-- <div>
    <h1 class="page-title" id="maintitle"></h1>
  </div> -->
  <div class="ms-auto pageheader-btn">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">ì‹ ê³ í˜„í™©</li>
      <li class="breadcrumb-item">ë¶€ê°€ê°€ì¹˜ì„¸</li>
      <li class="breadcrumb-item active" aria-current="page"><a href="javascript:void(0);">ì‹ ê³ ë‚´ì—­ ë¶„ì„</a></li>
    </ol>
  </div>
</div>
<!-- PAGE-HEADER END -->        
<!-- ROW-2 -->
<div class="row">
  <div class="col-sm-12 col-md-12 col-xl-4 col-lg-6">
    <div class="row">
      <div class="col-lg-12 col-xl-12 col-md-6 col-sm-12">
        <div class="card">
          <div class="panel panel-primary tab-style-underline">
            <div class="title-head mb-0" id="divTitleHead">
              <div class=" tab-menu-heading border-bottom-0 ms-3" style="border-left:0px">
                <div class="tabs-menu1 ">
                  <ul class="nav panel-tabs">
                    <li><a id="anchor1" href="#tab1" data-bs-toggle="tab" class="active me-1 text-default my-1" >ë§¤ì¶œë‚´ì—­</a></li>
                    <li><a id="anchor2" href="#tab2" data-bs-toggle="tab" class="me-1 text-default my-1">ë§¤ì…ë‚´ì—­</a></li>
                  </ul>
                </div>
              </div>
              <div class="panel-body tabs-menu-body border-1  mb-0">
                <div class="tab-content" id="tabContent"></div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
      <div class="col-xl-12 col-lg-12 col-md-6 col-sm-12">
        <div class="card overflow-hidden">
          <div class="card-header border-bottom">
            <h4 class="card-title fw-semibold">ì ê²€ì‚¬í•­</h4>
            <a href="#" class="ms-auto" id="anchor3"></a>
          </div>
          
          <div class="card-body p-0 customers mt-1" id="divListGroup">
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ë§‰ëŒ€ê·¸ë˜í”„ -->
  <div class="col-sm-12 col-md-12 col-lg-6 col-xl-8">
    <div class="card">
      <!-- <div class="card-header border-bottom">
        <h3 class="card-title">Sales</h3> 
        <div class="ms-auto">
          <div class="btn-group p-0 ms-auto">
            <button class="btn btn-primary-light btn-sm disabled" type="button">2021</button>
            <button class="btn btn-primary-light btn-sm" type="button">2022</button>
            <button class="btn btn-primary-light btn-sm disabled" type="button">2023</button>
           </div>
        </div>
      </div>  -->
      <div class="card-body">
        <div class="sales-stats d-flex">
          <div>
            <div class="text-muted fs-13">
              <span class="p-2 br-5 text-success ms-3"><i class="fe fe-alert-circle"></i></span>
              ë§‰ëŒ€ê·¸ë˜í”„ë¥¼ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ê¸°ìˆ˜ë³„ ìƒì„¸ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
        <div id="chartdiv"></div>
      </div>
    </div>
  </div>
</div>
<!-- ROW-2 END -->
<!-- ROW-3 -->
<div class="row">
  <div class="col-xl-4 col-md-12">
    <div class="card"  style="overflow: visible;">
      <div class="card-header border-bottom">
        <h4 class="card-title fw-semibold">ë§¤ì¶œ ê±°ë˜ì²˜</h4>
        <a href="#" class="ms-auto" id="anchor4"></a>
      </div>
      <div class="card-body" style=" overflow: visible;">
        <table class="table">
          <tbody id="tbody_sale"></tbody>
        </table>
        <nav aria-label="Page navigation example">		
          <ul id="sale_ul" class="pagination" style="justify-content: center;">
          </ul>
        </nav>
        <div id="donut_sale" style="width: 100%; height: 250px; margin-top:10px;"></div>  
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-12">
    <div class="card overflow-hidden">
      <div class="card-header border-bottom">
        <h3 class="card-title  fw-semibold">ë§¤ì… ê±°ë˜ì²˜</h3>
        <a href="#" class="ms-auto" id="anchor5"></a>
      </div>
      <div class="card-body" style=" overflow: visible;">
        <table class="table">
          <tbody id="tbody_cost"></tbody>
        </table>
        <nav aria-label="Page navigation example">		
          <ul id="cost_ul" class="pagination" style="justify-content: center;">
          </ul>
        </nav>
        <div id="donut_cost" style="width:100%; height:250px; margin-top:10px;"></div>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-12">
    <div class="card overflow-hidden">
      <div class="card-header title-submenu border-bottom">
        <h3 class="card-title">ì¹´ë“œê³µì œ ì‚¬ìš©ë‚´ì—­</h3>
        <a href="#" class="ms-auto" id="anchor6"></a>
      </div>
      <div class="card-body">
        <table class="table">
          <tbody id="tbody_card"></tbody>
        </table>
        <nav aria-label="Page navigation example">		
          <ul id="card_ul" class="pagination" style="justify-content: center;">
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="traderModal" tabindex="-1" aria-hidden="true"></div>
<!-- ROW-3 END -->
     
{% endblock %}

{% block scripts %}        
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script> <!-- ë„ë„›ì°¨íŠ¸ìš© -->
<script>
var totIssueList = "{{totIssueList|escapejs}}";
totIssueList = JSON.parse(totIssueList.replaceAll("'","\""));
const reversedList = [...totIssueList].reverse();

$(document).ready(function(){
  console.log(totIssueList)
  if (Array.isArray(totIssueList)) {
    if (totIssueList.length > 0) changeAll(totIssueList[0]);
  } else if (totIssueList) {
    changeAll(totIssueList);
  }
})
am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  var data = reversedList;
  root.setThemes([
    am5themes_Animated.new(root)
  ]);
  root.numberFormatter.setAll({
    numberFormat: "#a",
    bigNumberPrefixes: [
      { "number": 1e+4, "suffix": "ë§Œ" },
      { "number": 1e+6, "suffix": "ë°±ë§Œ" },
      { "number": 1e+8, "suffix": "ì–µ" }
    ],
    smallNumberPrefixes: []
  });
  var chart = root.container.children.push(am5xy.XYChart.new(root, {
    panX: true,
    panY: false,
    wheelX: "panX",
    wheelY: "zoomX",
    layout: root.verticalLayout
  }));

  //ìƒë‹¨ìŠ¤í¬ë¡¤ë°”
  // chart.set("scrollbarX", am5.Scrollbar.new(root, {
  //   orientation: "horizontal"
  // }));
  var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
    categoryField: "ê³¼ì„¸ê¸°ê°„",
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {
      themeTags: ["axis"],
      animationDuration: 200
    })
  }));
  xAxis.data.setAll(data);

  var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
    min: 0,
    renderer: am5xy.AxisRendererY.new(root, {})
  }));
  var zAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
    min: 0,
    renderer: am5xy.AxisRendererY.new(root, {})
  }));

  var series0 = chart.series.push(am5xy.ColumnSeries.new(root, {
    name: "ë§¤ì…í•©ê³„",
    xAxis: xAxis,
    yAxis: yAxis,
    valueYField: "ë§¤ì…í•©ê³„",
    categoryXField: "ê³¼ì„¸ê¸°ê°„",
    clustered: false,
    tooltip: am5.Tooltip.new(root, {
      labelText: "ë§¤ì…í•©ê³„: {valueY}"
    })
  }));
  series0.columns.template.setAll({
    width: am5.percent(80),
    tooltipY: 0
  });
  series0.data.setAll(data);
  
  var series1 = chart.series.push(am5xy.ColumnSeries.new(root, {
    name: "ë§¤ì¶œí•©ê³„",
    xAxis: xAxis,
    yAxis: yAxis,
    valueYField: "ë§¤ì¶œí•©ê³„",
    categoryXField: "ê³¼ì„¸ê¸°ê°„",
    clustered: false,
    tooltip: am5.Tooltip.new(root, {
      labelText: "ë§¤ì¶œí•©ê³„: {valueY}"
    })
  }));
  series1.columns.template.setAll({
    width: am5.percent(50),
    tooltipY: 0
  });
  series1.data.setAll(data);

  var series2 = chart.series.push(am5xy.LineSeries.new(root, {
    name: "ë‚©ë¶€ì„¸ì•¡",
    xAxis: xAxis,
    yAxis: yAxis,
    valueYField: "ë‚©ë¶€ì„¸ì•¡",
    categoryXField: "ê³¼ì„¸ê¸°ê°„",
    clustered: false,
    tooltip: am5.Tooltip.new(root, {
      labelText: "ë‚©ë¶€ì„¸ì•¡: {valueY}"
    })
  }));
  series2.strokes.template.setAll({ strokeWidth: 2 });
  series2.bullets.push(function() {
    return am5.Bullet.new(root, {
      sprite: am5.Circle.new(root, {
        strokeWidth: 3,
        stroke: series2.get("stroke"),
        radius: 5,
        fill: root.interfaceColors.get("background")
      })
    });
  });
  series2.data.setAll(data);  

  //ìƒ‰ìƒ
  series0.set("fill", am5.color(0xFF9E9B));   //ë§¤ì…ì•¡
  series1.set("fill", am5.color(0x87cefa));   //ë§¤ì¶œì•¡
  series2.set("fill", am5.color(0x50b300));   //ë‚©ë¶€ì„¸ì•¡

  series1.columns.template.events.on("click", function(ev) {
    const ctx = (ev.target.dataItem && ev.target.dataItem.dataContext) ||
                (ev.target._dataItem && ev.target._dataItem.dataContext);
    changeAll(ctx);
  });
  series0.columns.template.events.on("click", function(ev) {
    const ctx = (ev.target.dataItem && ev.target.dataItem.dataContext) ||
                (ev.target._dataItem && ev.target._dataItem.dataContext);
    changeAll(ctx);
  });
  var cursor = chart.set("cursor", am5xy.XYCursor.new(root, {}));
  chart.appear(1000, 100);
  series0.appear();
  series1.appear();
}); // end am5.ready()
am5.addLicense("AM5C372573951");
const setDivInspect = (tmpIssueList) => {
  var costCard = tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ê¸°íƒ€ì¹´ë“œ*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í˜„ê¸ˆì˜ìˆ˜ì¦*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í™”ë¬¼ë³µì§€*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ì‚¬ì—…ìš©ì¹´ë“œ*1;
  $("#divListGroup").empty();
  var tmpHtml="";
  tmpHtml += "            <div class='list-group py-1'>"
  tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
  tmpHtml += "                <div class='list-group-item border-0'>"
  tmpHtml += "                  <div class='media mt-0 align-items-center'>"
  tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-chevrons-right'></i>"
  tmpHtml += "                    </div>"
  tmpHtml += "                    <div class='media-body'>"
  tmpHtml += "                      <div class='d-flex align-items-center'>"
  tmpHtml += "                        <div class='mt-0'>"
  tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë¶€ê°€ìœ¨</h5>"
  tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>(ë‚©ë¶€ì„¸ì•¡+ê³ ì •ìì‚°ë§¤ì…ì„¸ì•¡)/ë§¤ì¶œì„¸ì•¡</p>"
  tmpHtml += "                        </div>"
  tmpHtml += "                        <span class='ms-auto fs-13'>"
  tmpHtml += "                          <span class='float-end text-dark'>"+((tmpIssueList.ë‚©ë¶€í™˜ê¸‰ì„¸ì•¡+tmpIssueList.ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œìˆ˜ì·¨ê³ ì •ìì‚°ì„¸ì•¡)/tmpIssueList.ì‚°ì¶œì„¸ì•¡*100).toFixed(2)+" %</span>"
  tmpHtml += "                        </span>"
  tmpHtml += "                      </div>"
  tmpHtml += "                    </div>"
  tmpHtml += "                  </div>"
  tmpHtml += "                </div>"
  tmpHtml += "              </a>"
  tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
  tmpHtml += "                <div class='list-group-item border-0'>"
  tmpHtml += "                  <div class='media mt-0 align-items-center'>"
  tmpHtml += "                    <div class='transaction-icon'>"
  tmpHtml += "                      <i class='fe fe-scissors'></i>"
  tmpHtml += "                    </div>"
  tmpHtml += "                    <div class='media-body'>"
  tmpHtml += "                      <div class='d-flex align-items-center'>"
  tmpHtml += "                        <div class='mt-0'>"
  tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë§¤ì…ì„¸ì•¡ <span class='fs-13 fw-semibold ms-1'>ë¶ˆê³µì œ</span></h5>"
  tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ìŠ¹ìš©ì°¨ê´€ë ¨Â·ì ‘ëŒ€ë¹„Â·í† ì§€ê´€ë ¨ ë“±</p>"
  tmpHtml += "                        </div>"
  tmpHtml += "                        <span class='ms-auto fs-13'>"
  tmpHtml += "                          <span class='float-end text-dark'>"+numberWithCommas(tmpIssueList.ë¶ˆê³µì œ)+"</span>"
  tmpHtml += "                        </span>"
  tmpHtml += "                      </div>"
  tmpHtml += "                    </div>"
  tmpHtml += "                  </div>"
  tmpHtml += "                </div>"
  tmpHtml += "              </a>"
  tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
  tmpHtml += "                <div class='list-group-item border-0'>"
  tmpHtml += "                  <div class='media mt-0 align-items-center'>"
  tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-briefcase'></i>"
  tmpHtml += "                    </div>"
  tmpHtml += "                    <div class='media-body'>"
  tmpHtml += "                      <div class='d-flex align-items-center'>"
  tmpHtml += "                        <div class='mt-0'>"
  tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ì‹ ìš©ì¹´ë“œ <span class='fs-13 fw-semibold ms-1'>ë§¤ì…ì„¸ì•¡ ê³µì œìœ¨</span></h5>"
  tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ì´ ì¹´ë“œì‚¬ìš©ì•¡ "+numberWithCommas(tmpIssueList.ì¹´ë“œí˜„ì˜ì‚¬ìš©ì´ì•¡)+"</p>"
  tmpHtml += "                        </div>"
  tmpHtml += "                        <span class='ms-auto fs-13'>"
  tmpHtml += "                          <span class='float-end text-dark'>"+(costCard/tmpIssueList.ì¹´ë“œí˜„ì˜ì‚¬ìš©ì´ì•¡*100).toFixed(2)+" %</span>"
  tmpHtml += "                        </span>"
  tmpHtml += "                      </div>"
  tmpHtml += "                    </div>"
  tmpHtml += "                  </div>"
  tmpHtml += "                </div>"
  tmpHtml += "              </a>"
  tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
  tmpHtml += "                <div class='list-group-item border-0'>"
  tmpHtml += "                  <div class='media mt-0 align-items-center'>"
  tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-file-text'></i>"
  tmpHtml += "                    </div>"
  tmpHtml += "                    <div class='media-body'>"
  tmpHtml += "                      <div class='d-flex align-items-center'>"
  tmpHtml += "                        <div class='mt-0'>"
  tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë¶€ê°€ê°€ì¹˜ì„¸ <span class='fs-13 fw-semibold ms-1'>ê°€ì‚°ì„¸</span></h5>"
  tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ì „ìì„¸ê¸ˆê³„ì‚°ì„œê´€ë ¨Â·ë¶ˆì„±ì‹¤ ë“±</p>"
  tmpHtml += "                        </div>"
  tmpHtml += "                        <span class='ms-auto fs-13'>"
  tmpHtml += "                          <span class='float-end text-dark'>"+numberWithCommas(tmpIssueList.ê°€ì‚°ì„¸ì•¡ê³„)+"</span>"
  tmpHtml += "                        </span>"
  tmpHtml += "                      </div>"
  tmpHtml += "                    </div>"
  tmpHtml += "                  </div>"
  tmpHtml += "                </div>"
  tmpHtml += "              </a>"
  tmpHtml += "            </div>"
  document.getElementById('divListGroup').innerHTML = tmpHtml;
}
const setDivTitle = (tmpIssueList) => {  
  $("#divH1").empty();
  var divH1 = document.getElementById('divH1');
  var h1 = document.createElement('h1');
  h1.setAttribute("class","page-title")
  h1.innerText = "ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ë‚´ì—­ ë¶„ì„ :: " + tmpIssueList.ê³¼ì„¸ê¸°ê°„;
  divH1.appendChild(h1);

  var anchor3 = document.getElementById("anchor3")
  var anchor4 = document.getElementById("anchor4")
  var anchor5 = document.getElementById("anchor5")
  var anchor6 = document.getElementById("anchor6")
  anchor3.innerText = tmpIssueList.ê³¼ì„¸ê¸°ê°„.substring(0,5)+" "+tmpIssueList.startDt + " ~ " + tmpIssueList.endDt
  anchor4.innerText = tmpIssueList.ê³¼ì„¸ê¸°ê°„.substring(0,5)+" "+tmpIssueList.startDt + " ~ " + tmpIssueList.endDt
  anchor5.innerText = tmpIssueList.ê³¼ì„¸ê¸°ê°„.substring(0,5)+" "+tmpIssueList.startDt + " ~ " + tmpIssueList.endDt
  anchor6.innerText = tmpIssueList.ê³¼ì„¸ê¸°ê°„.substring(0,5)+" "+tmpIssueList.startDt + " ~ " + tmpIssueList.endDt
}
const setTabContent = (tmpIssueList) => {
  var totalSale = tmpIssueList.ë§¤ì¶œí•©ê³„;
  var saleTI = tmpIssueList.ë§¤ì¶œì„¸ê¸ˆê³„ì‚°ì„œ;
  var saleNonTI = tmpIssueList.ë©´ì„¸ë§¤ì¶œ;
  var saleZeroTI = tmpIssueList.ì˜ì„¸ìœ¨ë§¤ì¶œ;
  var saleCard = tmpIssueList.ì¹´ë“œë§¤ì¶œ;
  var saleKita = tmpIssueList.ê¸°íƒ€ë§¤ì¶œ;
  var anchor1 = document.getElementById("anchor1")
  var anchor2 = document.getElementById("anchor2")  
  anchor1.setAttribute("class","active me-1 text-default my-1");
  anchor2.setAttribute("class","me-1 text-default my-1");  
  $("#tabContent").empty();
  var tmpHtml="";
  tmpHtml += "<div class='tab-pane active' id='tab1'>"
  tmpHtml += "	<div class='storage-percent'>"
  tmpHtml += "	  <div class='progress fileprogress h-auto ps-0 shadow1'>"
  if (Math.round(saleTI / totalSale *100)>0 ) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleTI / totalSale *100)+" bg-primary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round((saleNonTI+saleZeroTI) / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round((saleNonTI+saleZeroTI) / totalSale *100)+" bg-secondary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round(saleCard / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleCard / totalSale *100)+" bg-custom-yellow' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round(saleKita / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleKita / totalSale *100)+" bg-teritary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  tmpHtml += "	  </div>"
  tmpHtml += "	  <div class='remaining-storage'>"
  tmpHtml += "		<div class='text-muted fs-13 mb-1 mt-3'>ë§¤ì¶œ ê³µê¸‰ê°€ì•¡</div>"
  tmpHtml += "		<div class='fw-semibold fs-14 mb-1 mt-3'>"+numberWithCommas(totalSale)+"</div>"
  tmpHtml += "	  </div>"
  tmpHtml += "	</div>"
  tmpHtml += "	<div class='content-main mt-5'>"
  tmpHtml += "	  <ul class='task-list1 row mx-auto'>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-primary me-3'></i>ì„¸ê¸ˆê³„ì‚°ì„œ</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(saleTI)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-secondary'></i>ì˜ì„¸ìœ¨Â·ê³„ì‚°ì„œ</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(saleZeroTI+saleNonTI)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-custom-yellow'></i>ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(saleCard)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6 mb-xl-0'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-teritary'></i>ê¸°íƒ€(ì˜¨ë¼ì¸Â·í˜„ê¸ˆ)</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(saleKita)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "	  </ul>"
  tmpHtml += "	</div>"
  tmpHtml += "</div>"

  //var totalCost = tmpIssueList.ë§¤ì…í•©ê³„;
  var costTI = tmpIssueList.ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œ - tmpIssueList.ë¶ˆê³µì œ;
  var costNonTI = tmpIssueList.ë©´ì„¸ë§¤ì…;
  var costBulgong = tmpIssueList.ë¶ˆê³µì œ;
  var costCard = tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ê¸°íƒ€ì¹´ë“œ*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í˜„ê¸ˆì˜ìˆ˜ì¦*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í™”ë¬¼ë³µì§€*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ì‚¬ì—…ìš©ì¹´ë“œ*1;
  var costRevive = tmpIssueList.ì˜ì œë§¤ì…ì„¸ì•¡ê³µì œ*1 + tmpIssueList.ì¬í™œìš©íìì›ë“±ë§¤ì…ì„¸ì•¡*1
  var costGongje = tmpIssueList.ê²½ê°ê³µì œì„¸ì•¡;
  var totalCost = costTI + costNonTI + costCard + costRevive

  tmpHtml += "<div class='tab-pane ' id='tab2'>"
  tmpHtml += "	<div class='storage-percent'>"
  tmpHtml += "	  <div class='progress fileprogress h-auto ps-0 shadow1'>"
  if (Math.round(costTI / totalCost *100)>0 ) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costTI / totalCost *100)+" bg-primary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round(costNonTI / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costNonTI / totalCost *100)+" bg-secondary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round(costCard / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costCard / totalCost *100)+" bg-custom-yellow' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  if (Math.round(costRevive / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costRevive / totalCost *100)+" bg-teritary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
  tmpHtml += "	  </div>"
  tmpHtml += "	  <div class='remaining-storage'>"
  tmpHtml += "		<div class='text-muted fs-13 mb-1 mt-3'>ë§¤ì… ê³µê¸‰ê°€ì•¡</div>"
  tmpHtml += "		<div class='fw-semibold fs-14 mb-1 mt-3'>"+numberWithCommas(totalCost)+"</div>"
  tmpHtml += "	  </div>"
  tmpHtml += "	</div>"
  tmpHtml += "	<div class='content-main mt-5'>"
  tmpHtml += "	  <ul class='task-list1 row mx-auto'>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-primary me-3'></i>ì„¸ê¸ˆê³„ì‚°ì„œ</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(costTI)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-secondary'></i>ê³„ì‚°ì„œ</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(costNonTI)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-custom-yellow'></i>ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(costCard)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "		<li class='col-xl-6 mb-xl-0'>"
  tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-teritary'></i>ì˜ì œÂ·ì¬í™œìš©ë§¤ì…</span>"
  tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
  tmpHtml += "			<span class=''>"+numberWithCommas(costRevive)+"</span>"
  tmpHtml += "		  </span>"
  tmpHtml += "		</li>"
  tmpHtml += "	  </ul>"
  tmpHtml += "	</div>"
  tmpHtml += "</div>"
  document.getElementById('tabContent').innerHTML = tmpHtml;
}
const changeAll = (tmpIssueList)=>{
  // changeAll expects a single issue object; guard against arrays/empty values.
  console.debug('[vatAnaly] changeAll input:', tmpIssueList);
  if (Array.isArray(tmpIssueList)) tmpIssueList = tmpIssueList[0];
  if (!tmpIssueList) {
    console.warn('[vatAnaly] changeAll aborted: empty input');
    return;
  }
  waitingDialog.show('ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ë°ì´í„°ë¥¼ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤.',{
    progressType: 'success',
    onShow: function () {
      $.ajax({
        url:"{% url 'getTraderList' %}",
        type: "GET",
        data:{
          seq_no: tmpIssueList.seq_no,
          work_YY: tmpIssueList.work_YY,          
          period:tmpIssueList.ê³¼ì„¸ê¸°ê°„,
          youhyung:tmpIssueList.ê³¼ì„¸ìœ í˜•
        },
        dataType:"json",
        success:function(data){
          try {
            setDivInspect(tmpIssueList);    //ì ê²€ì‚¬í•­
            setDivTitle(tmpIssueList);      //ì‹ ê³ ê¸°ê°„ íƒ€ì´í‹€ ì„¤ì •
            setTabContent(tmpIssueList);    //ë§¤ì¶œ/ë§¤ì…ë‚´ì—­

            const saleList = Array.isArray(data.sale) ? data.sale : [];
            const costList = Array.isArray(data.cost) ? data.cost : [];
            const cardList = Array.isArray(data.card) ? data.card : [];

            pageInsert(saleList,1,"sale");
            pageInsert(costList,1,"cost");
            pageInsert(cardList,1,"card");

            createDonut("donut_sale", saleList, "ë§¤ì¶œ",tmpIssueList.work_YY+"ë…„ "+tmpIssueList.work_QT, "#87CBF4")
            createDonut("donut_cost", costList, "ë§¤ì…",tmpIssueList.work_YY+"ë…„ "+tmpIssueList.work_QT, "#F3A1A1")          
          } catch (e) {
            console.error('[vatAnaly] changeAll render error:', e, { tmpIssueList, data });
          }
          if (window.waitingDialog && typeof waitingDialog.hide === 'function') waitingDialog.hide();
        },
        error:function(request,status,error){
          console.log('fail:'+error);
          if (window.waitingDialog && typeof waitingDialog.hide === 'function') waitingDialog.hide();
        }
      })

    }
  });
  
  // âœ… ê³µí†µ ë„ë„›ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
  function createDonut(divId, sourceData, MainText,SubText, baseColor) {
    // ë°ì´í„° ì •ë¦¬ (Top5 + ê¸°íƒ€)
    var sortedData = sourceData.sort((a, b) => Number(b.ê¸ˆì•¡) - Number(a.ê¸ˆì•¡));
    var top5 = sortedData.slice(0, 5);
    var others = sortedData.slice(5);
    if (others.length > 0) {
      var otherSum = others.reduce((acc, cur) => acc + Number(cur.ê¸ˆì•¡), 0);
      top5.push({ ê±°ë˜ì²˜ëª…: "ê¸°íƒ€", ê¸ˆì•¡: otherSum });
    }

    var chartData = top5.map(item => ({
      category: item.ê±°ë˜ì²˜ëª…,
      value: Number(item.ê¸ˆì•¡) || 0
    }));

    am5.ready(function() {
      am5.registry.rootElements.forEach(root => {
        if (root.dom.id === divId) root.dispose();
      });

      var root = am5.Root.new(divId);
      root.setThemes([am5themes_Animated.new(root)]);

      // âœ… ë„ë„› í¬ê¸° ê³ ì •
      var chart = root.container.children.push(
        am5percent.PieChart.new(root, {
          layout: root.verticalLayout,
          innerRadius: am5.percent(50),  // ë„ë„› ë‘ê»˜
          radius: am5.percent(70)        // âœ… ë„ë„› í¬ê¸° ì¼ì •í•˜ê²Œ ìœ ì§€
        })
      );

      var series = chart.series.push(
        am5percent.PieSeries.new(root, {
          valueField: "value",
          categoryField: "category"
        })
      );

      var colorSet = am5.ColorSet.new(root, {
        colors: [am5.color(baseColor)]
      });
      series.set("colors", colorSet);

      series.data.setAll(chartData);

      // âœ… ë©”ì¸ ë¼ë²¨ (í° ê¸€ì”¨)
      series.children.push(
        am5.Label.new(root, {
          text: MainText,
          fontSize: 22,       // âœ… í¬ê²Œ
          fontWeight: "bold",
          centerX: am5.p50,
          centerY: am5.p50,
          textAlign: "center"
        })
      );

      // âœ… ì„œë¸Œ ë¼ë²¨ (ì‘ì€ ê¸€ì”¨, ì•„ë˜ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™)
      series.children.push(
        am5.Label.new(root, {
          text: SubText,
          fontSize: 14,       // âœ… ì‘ê²Œ
          centerX: am5.p50,
          centerY: am5.p50,
          dy: 18,             // âœ… ì•„ë˜ìª½ìœ¼ë¡œ 18px ë‚´ë ¤ì„œ ë°°ì¹˜
          textAlign: "center"
        })
      );

      // âœ… ë²”ë¡€ (ì°¨íŠ¸ ì•„ë˜ìª½ ë°°ì¹˜)
      var legend = chart.children.push(
        am5.Legend.new(root, {
          centerX: am5.p50,
          x: am5.p50,
          marginTop: 10,
          maxHeight: 100,
          scrollable: true
        })
      );
      legend.data.setAll(series.dataItems);
    });
  }
  am5.addLicense("AM5C372573951");

}//const changeAll

var tmpSaleList; 
var tmpCostList; 
var tmpCardList; 
const pageList = 5; // í•œê°œì˜ í˜ì´ì§€ì— ë³´ì—¬ì§ˆ ëª©ë¡ ê°œìˆ˜
const pageMax = 3; // ìµœëŒ€ ìƒì„±ë  í˜ì´ì§€ ê°œìˆ˜  	


function pageInsert(tableList,newIndex,flagName){
  if(flagName=="sale")    tmpSaleList = tableList;
  if(flagName=="cost")    tmpCostList = tableList;
  if(flagName=="card")    tmpCardList = tableList;
  

  $("#"+flagName+"_ul").empty();
  var startIndex = newIndex;  // ìƒì„± ì‹œì‘ í˜ì´ì§€    		
  var endIndex = tableList.length;
  var pageCount = 0;
  var pagePlus = 0;
  if(endIndex > pageList){ // tr í–‰ ê°œìˆ˜ê°€ 5 ì´ìƒì¸ ê²½ìš° (ì„ì˜ë¡œ ì„¤ì •)
    pageCount = Math.floor(endIndex / pageList); //ìƒì„±ë  í˜ì´ì§€ ìˆ˜ (ì†Œìˆ˜ì  ë²„ë¦¼)
    pagePlus = endIndex % pageList; //ì¶”ê°€ ë‚˜ë¨¸ì§€ ìì‹ ìˆ˜
    if(pagePlus > 0){ //ì¶”ê°€ ìì‹ìˆ˜ê°€ ìˆëŠ”ê²½ìš° >> í˜ì´ì§€ ì¶”ê°€
      pageCount = pageCount + 1;
    }
  }
  if(startIndex > pageCount){ //ê¸¸ì´ ì´ˆê³¼ ì‹œ ê¸°ì¡´êº¼ë¡œ ë‹¤ì‹œ ì €ì¥
    startIndex = newIndex;
  }
  else if(startIndex < 0){ //ê¸¸ì´ ë¯¸ë§Œ ì‹œ ê¸°ì¡´êº¼ë¡œ ë‹¤ì‹œ ì €ì¥
    startIndex = newIndex;
  }
  else {
    page = startIndex;
  }
  if(pageCount == 1){ //ìƒì„±í•´ì•¼í•  í˜ì´ì§€
    var insertUl = "<li class='page-item'>"; 
    insertUl += insertUl + "<a class='page-link' href='javascript:void(0)' onclick = 'newPage(1,\""+flagName+"\");'>";
    insertUl += insertUl + i;
    insertUl += insertUl + "</a></li>";
    $("#"+flagName+"_ul").append(insertUl);
  }
  else if(pageCount >= 2){ 
    // ì´ì „ í˜ì´ì§€ ì¶”ê°€ ì‹¤ì‹œ 
    var insertSTR = "<li class='page-item'>";
    insertSTR = insertSTR + "<a class='page-link' href='javascript:void(0)' onclick = 'newPage("+"-1"+",\""+flagName+"\");'>";
    insertSTR = insertSTR + "<i class='fe fe-chevron-left'></i>";
    insertSTR = insertSTR + "</a></li>";
    $("#"+flagName+"_ul").append(insertSTR);     			
    // íŠ¹ì • 1, 2, 3 .. í˜ì´ì§€ ì¶”ê°€ 
    var count = 1;
    for(var i=startIndex; i<=pageCount; i++){
      if(count > pageMax){ //ìµœëŒ€ë¡œ ìƒì„±ë  í˜ì´ì§€ ê°œìˆ˜ 
        page = i - pageMax; //ìƒì„±ëœ í˜ì´ì§€ ì´ˆê¸°ê°’
        break; 
      }
      var insertUl = "<li class='page-item'>"; 
      insertUl = insertUl + "<a class='page-link' href='javascript:void(0)' onclick = 'newPage("+i+",\""+flagName+"\");'>";
      insertUl = insertUl + String(i);
      insertUl = insertUl + "</a></li>";
      $("#"+flagName+"_ul").append(insertUl); 
      count ++;
    }
    // ë‹¤ìŒ í˜ì´ì§€ ì¶”ê°€ 
    var insertEND = "<li class='page-item'>"; 
    insertEND = insertEND + "<a class='page-link' href='javascript:void(0)' onclick = 'newPage("+"0"+",\""+flagName+"\");'>";
    insertEND = insertEND + "<i class='fe fe-chevron-right'></i>";
    insertEND = insertEND + "</a></li>";
    $("#"+flagName+"_ul").append(insertEND); 
  }
  $("#tbody_"+flagName).empty(); //tbody tr ì „ì²´ ì‚­ì œ 
  // [ìƒˆë¡­ê²Œ í˜ì´ì§€ ëª©ë¡ ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ ]
  newPage(startIndex,flagName);
};

function newPage(pageCurrent,flagName){
  var tmpList;
  if(flagName=="sale")    tmpList = tmpSaleList;
  if(flagName=="cost")    tmpList = tmpCostList;
  if(flagName=="card")    tmpList = tmpCardList;
  
  if(pageCurrent == -1){ // ì´ì „ í˜ì´ì§€
    $("#tbody_"+flagName).empty();
    var newIdx = page - pageMax;
    
    pageInsert(tmpList,newIdx,flagName); 
  } 
  else if(pageCurrent == 0){ 
    $("#tbody_"+flagName).empty(); 
    var newIdx = page + pageMax;
    pageInsert(tmpList,newIdx,flagName); 
  }
  else { // ì¼ë°˜ í…Œì´ë¸” ëª©ë¡ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    $("#tbody_"+flagName).empty();
    idx = (pageCurrent * pageList) - pageList;
    var checkCount = 1;

    for (var i = idx; i < tmpList.length; i++) {
      if (checkCount > pageList) { // í•œí˜ì´ì§€ì— í‘œì‹œë  ëª©ë¡ì„ ì´ˆê³¼í•œ ê²½ìš°
        return;
      }
      // json ë°ì´í„° íŒŒì‹± ì‹¤ì‹œ
      var jsonObject = JSON.parse(JSON.stringify(tmpList[i])); //ê° ë°°ì—´ì— ìˆëŠ” jsonObject ì°¸ì¡°
      idx = i + 1;
      var trader_code = jsonObject.ê±°ë˜ì²˜ì½”ë“œ;
      var name = jsonObject.ê±°ë˜ì²˜ëª…;
      var amt = jsonObject.ê¸ˆì•¡;

      var insertTr = ""; // ë³€ìˆ˜ ì„ ì–¸
      insertTr += "<tr style='cursor:pointer' onclick=\"openTraderModal('" + trader_code + "', '" + flagName + "', '" + name + "')\">";  
      insertTr += "<th scope='row'>" + idx + "</th>";
      insertTr += "<td>" + name + "</td>";
      insertTr += "<td style='text-align:right'>" + numberWithCommas(Math.round(amt)) + "</td>";
      insertTr += "</tr>";

      $("#tbody_" + flagName).append(insertTr);
      checkCount++;
    }						
  }
};

function openTraderModal(trader_code, trader_flag, name) {
  var tmpHtml = `
    <div class="modal-dialog modal-dialog-centered modal-xl task-view-modal" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">${name}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- âœ… ì°¨íŠ¸ #1: ìµœê·¼ 5ê°œë…„ ë¶„ê¸°ë³„ ë§¤ì¶œ -->
          <h6 class="fw-bold mt-2">ğŸ“Š ìµœê·¼ 5ê°œë…„ ë¶„ê¸°ë³„ ë§¤ì¶œ</h6>
          <div id="chartdiv_quartered" style="width:100%; height:400px;"></div>
          
          <hr>

          <!-- âœ… ì°¨íŠ¸ #2: ì‘ë…„ ë™ì›” ëŒ€ë¹„ -->
          <h6 class="fw-bold mt-3">ğŸ“ˆ ì‘ë…„ ë™ì›” ëŒ€ë¹„</h6>
          <div id="chartdiv_comparison" style="width:100%; height:400px;"></div>
        </div>
        <div class="modal-footer w-100 text-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  `;

  // âœ… ëª¨ë‹¬ ì „ì²´ HTML êµì²´
  document.getElementById('traderModal').innerHTML = tmpHtml;

  // âœ… Bootstrap ëª¨ë‹¬ ë„ìš°ê¸°
  var modal = new bootstrap.Modal(document.getElementById('traderModal'));
  modal.show();

  // âœ… ë°ì´í„° ë¡œë“œ & ì°¨íŠ¸ í˜¸ì¶œ
  loadQuarter(trader_code, trader_flag);        // âœ… ê¸°ì¡´ ë¶„ê¸°ë³„ ë§¤ì¶œ ì°¨íŠ¸ í•¨ìˆ˜
  loadComparisonChart(trader_code, trader_flag);          // âœ… "ì‘ë…„ ë™ì›” ëŒ€ë¹„" í•¨ìˆ˜ (ìƒˆë¡œ ë§Œë“  í•¨ìˆ˜)
}
function loadQuarter(trader_code,trader_flag) {
  $.ajax({
    url: "{% url 'get_QuarteredGraph' %}",
    type: "GET",
    data: { 
      trader_code: trader_code,
      trader_flag: trader_flag 
    },
    dataType: "json",
    success: function(response) {
      drawQuarterChart(response);
    }
  });
}

function drawQuarterChart(data) {
  am5.ready(function() {
    am5.registry.rootElements.forEach(root => {
      if (root.dom.id === "chartdiv_quartered") {
        root.dispose();
      }
    });

    var root = am5.Root.new("chartdiv_quartered");
    root.setThemes([am5themes_Animated.new(root)]);

    var chart = root.container.children.push(am5xy.XYChart.new(root, {
      layout: root.verticalLayout,
      panX: false,
      panY: false
    }));

    var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
      categoryField: "year",
      renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 20 })
    }));
    xAxis.data.setAll(data);

    var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    }));

    var colors = {
      "Q1": am5.color(0xA3D8F4),
      "Q2": am5.color(0x91C7B1),
      "Q3": am5.color(0xF9D39B),
      "Q4": am5.color(0xF7AFAF)
    };

    let lastSeries = null;

    // âœ… Q1 ~ Q4 ì‹œë¦¬ì¦ˆ ìƒì„±
    ["Q1", "Q2", "Q3", "Q4"].forEach(function(quarter) {
      var series = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: quarter,
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: quarter,
        categoryXField: "year",
        stacked: true,
        tooltip: am5.Tooltip.new(root, { labelText: "{name}: {valueY}" })
      }));

      series.columns.template.setAll({
        fill: colors[quarter],
        stroke: colors[quarter],
        width: am5.percent(80)
      });

      // âœ… ê° ë¶„ê¸°ë³„ ë¼ë²¨
      series.bullets.push(function(root, series, dataItem) {
        return am5.Bullet.new(root, {
          locationY: 0.5,
          sprite: am5.Label.new(root, {
            text: dataItem.dataContext[quarter].toLocaleString(),
            centerX: am5.p50,
            centerY: am5.p50,
            fill: am5.color(0xffffff),
            fontSize: 13,
            fontWeight: "bold"
          })
        });
      });

      series.data.setAll(data);
      lastSeries = series; // âœ… ë§ˆì§€ë§‰ series(Q4) ì €ì¥
    });

    // âœ… Q4 ì‹œë¦¬ì¦ˆ ìœ„ì— â€œì „ì²´ í•©ê³„ ë¼ë²¨â€ ì¶”ê°€
    lastSeries.bullets.push(function(root, series, dataItem) {
      // âœ… ì´í•© ê³„ì‚°
      var total = (dataItem.dataContext.Q1 || 0)
                + (dataItem.dataContext.Q2 || 0)
                + (dataItem.dataContext.Q3 || 0)
                + (dataItem.dataContext.Q4 || 0);

      return am5.Bullet.new(root, {
        locationY: 1,  // âœ… ë§‰ëŒ€ ê¼­ëŒ€ê¸°
        sprite: am5.Label.new(root, {
          text: total.toLocaleString() + "ì›",
          centerX: am5.p50,
          centerY: am5.p100,
          dy: -10,
          fontSize: 15,
          fontWeight: "bold",
          fill: am5.color(0x000000)
        })
      });
    });

    var legend = chart.children.push(am5.Legend.new(root, {
      centerX: am5.p50,
      x: am5.p50
    }));
    legend.data.setAll(chart.series.values);

    chart.appear(1000, 100);
  });
}

function loadComparisonChart(trader_code, trader_flag) {
  $.ajax({
    url: "{% url 'get_monthly_comparison' %}",
    type: "GET",
    data: { trader_flag: trader_flag, trader_code: trader_code },
    success: function(response) {
      drawComparisonChart(response);
    }
  });
}

function drawComparisonChart(data) {
  am5.ready(function() {
    // âœ… ê¸°ì¡´ Root ì œê±°
    am5.registry.rootElements.forEach(root => {
      if (root.dom.id === "chartdiv_comparison") {
        root.dispose();
      }
    });

    var root = am5.Root.new("chartdiv_comparison");
    root.setThemes([am5themes_Animated.new(root)]);

    // âœ… ì°¨íŠ¸ ìƒì„±
    var chart = root.container.children.push(am5xy.XYChart.new(root, {
      layout: root.verticalLayout,
      panX: false,
      panY: false     
    }));

    // âœ… ìˆ«ì í¬ë§· í•¨ìˆ˜ (ì–µ/ë§Œ ë‹¨ìœ„ ë³€í™˜)
    function formatToKoreanUnit(value) {
      if (value >= 100000000) {
        return (value / 100000000).toFixed(1) + "ì–µ"; // ì–µ ë‹¨ìœ„
      } else if (value >= 10000) {
        return (value / 10000).toFixed(1) + "ë§Œ"; // ë§Œ ë‹¨ìœ„
      }
      return value.toLocaleString(); // ê·¸ ì™¸ëŠ” ì½¤ë§ˆ ì²˜ë¦¬
    }

    // âœ… Xì¶• (1ì›”~12ì›”)
    var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
      categoryField: "month",
      renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 20 })
    }));
    xAxis.data.setAll(data);


    // âœ… Yì¶•
    var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    }));

    // âœ… ì˜¬í•´ / ì‘ë…„ ì‹œë¦¬ì¦ˆ ìƒ‰ìƒ
    var colors = {
      "thisYear": am5.color(0x62C1DD), // ì˜¬í•´: íŒŒìŠ¤í…” ë¸”ë£¨
      "lastYear": am5.color(0x9370DB)  // ì‘ë…„: íŒŒìŠ¤í…” í¼í”Œ
    };

    // âœ… ì˜¬í•´ ë°ì´í„° ì‹œë¦¬ì¦ˆ
    var thisYearSeries = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: "ì˜¬í•´",
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: "thisYear",
      categoryXField: "month",
      clustered: true,
      tooltip: am5.Tooltip.new(root, { labelText: "ì˜¬í•´: {valueY}" })
    }));
    thisYearSeries.columns.template.setAll({
      fill: colors.thisYear,
      stroke: colors.thisYear,
      width: am5.percent(40)
    });

    // âœ… ì‘ë…„ ë°ì´í„° ì‹œë¦¬ì¦ˆ
    var lastYearSeries = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: "ì‘ë…„",
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: "lastYear",
      categoryXField: "month",
      clustered: true,
      tooltip: am5.Tooltip.new(root, { labelText: "ì‘ë…„: {valueY}" })
    }));
    lastYearSeries.columns.template.setAll({
      fill: colors.lastYear,
      stroke: colors.lastYear,
      width: am5.percent(40)
    });

    // âœ… **ë§‰ëŒ€ ìœ„ì— ì–µ/ë§Œ ë‹¨ìœ„ Label í‘œì‹œ**
    function addLabels(series, field) {
      series.bullets.push(function(root, series, dataItem) {
        var value = dataItem.dataContext[field];
        return am5.Bullet.new(root, {
          locationY: 1,  // âœ… ë§‰ëŒ€ì˜ ëì„ ê¸°ì¤€ì ìœ¼ë¡œ
          sprite: am5.Label.new(root, {
            text: formatToKoreanUnit(value),   // âœ… "2.7ì–µ" í˜•íƒœë¡œ ë³€í™˜
            centerX: am5.p50,
            centerY: am5.p100,
            dy: -2,            // âœ… ë§‰ëŒ€ë³´ë‹¤ 35px ìœ„ â†’ ì—¬ìœ  ìˆê²Œ ë„ì›€
            fontSize: 14,
            fontWeight: "bold",
            fill: am5.color(0x000000)  // âœ… ê²€ì •ìƒ‰ ê¸€ì
          })
        });
      });
    }

    addLabels(thisYearSeries, "thisYear");
    addLabels(lastYearSeries, "lastYear");

    // âœ… ë°ì´í„° ì ìš©
    thisYearSeries.data.setAll(data);
    lastYearSeries.data.setAll(data);

    // âœ… ë²”ë¡€
    var legend = chart.children.push(am5.Legend.new(root, {
      centerX: am5.p50,
      x: am5.p50
    }));
    legend.data.setAll(chart.series.values);

    chart.appear(1000, 100);
  });
}



</script>

{% endblock %}
