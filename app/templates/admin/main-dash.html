{% extends 'components/admin-base.html' %}
{% load static %}
{% load humanize %}

{% block styles %}
<style>
    .project-main-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 5px;
    }

    .stat-box {
        text-align: center;
        padding: 15px;
    }

    .stat-box h3 {
        font-size: 2rem;
        margin: 0;
        font-weight: bold;
    }

    .stat-box p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .d-day-urgent {
        background-color: #dc3545;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 0.85rem;
    }

    .d-day-warning {
        background-color: #ffc107;
        color: #000;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 0.85rem;
    }

    .d-day-normal {
        background-color: #28a745;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 0.85rem;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state i {
        font-size: 4rem;
        color: #28a745;
        margin-bottom: 20px;
    }

    .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .tabs-menu4 .nav-link {
        font-weight: 500;
        color: #495057;
    }

    .tabs-menu4 .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff !important;
    }

    .filter-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block tab_content_wrapper %}
<!-- PAGE-HEADER -->
<div class="page-header">
    <div>
        <h1 class="page-title">일정관리 대시보드</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">관리자</li>
            <li class="breadcrumb-item active" aria-current="page">일정관리</li>
        </ol>
    </div>
</div>
<!-- PAGE-HEADER END -->

<!--ROW OPENED-->
<div class="row">
    <div class="col-md-12">
        <!-- 필터 섹션 -->
        <div class="filter-card">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="staffFilter" class="form-label">담당자 필터</label>
                    <select id="staffFilter" class="form-control form-select">
                        <option value="">전체</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadAllData()">
                        <i class="fe fe-refresh-cw me-2"></i>새로고침
                    </button>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="card">
            <div class="card-body project-main-stats">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="pendingCount">0</h3>
                            <p>미신고 업체</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="receivableCount">0</h3>
                            <p>미수금 업체</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="renewalCount">0</h3>
                            <p>임원등기 연임</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="newCompanyCount">0</h3>
                            <p>신규업체 (30일)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer p-0">
                <!-- Tabs -->
                <div class="tabs-menu4 py-5">
                    <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
                        <a class="nav-link border py-1 mb-2 mb-lg-0 br-lg-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#tab_pending">
                            담당자별 할일 <span class="badge bg-danger" id="pendingBadge">0</span>
                        </a>
                        <a class="nav-link border py-1 mb-2 mb-lg-0 br-lg-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#tab_receivable">
                            미수금 현황 <span class="badge bg-warning text-dark" id="receivableBadge">0</span>
                        </a>
                        <a class="nav-link border py-1 mb-2 mb-lg-0 br-lg-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#tab_renewal">
                            임원등기 연임안내 <span class="badge bg-info" id="renewalBadge">0</span>
                        </a>
                        <a class="nav-link border py-1 mb-2 mb-lg-0 br-lg-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#tab_newcompany">
                            신규업체 관리 <span class="badge bg-success" id="newCompanyBadge">0</span>
                        </a>
                    </nav>
                </div><!-- /Tabs -->
            </div>
        </div>
    </div>

    <div class="col-md-12">
        <div class="tab-content">
            <!-- 담당자별 할일 -->
            <div class="tab-pane active" id="tab_pending">
                <div class="card">
                    <div class="card-header border-bottom">
                        <h3 class="card-title">신고기한 임박 업체 목록</h3>
                    </div>
                    <div class="card-body" id="pendingFilingsContent">
                        <div class="loading">
                            <i class="fa fa-spinner fa-spin"></i> 데이터 로딩 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 미수금 현황 -->
            <div class="tab-pane" id="tab_receivable">
                <div class="card">
                    <div class="card-header border-bottom">
                        <h3 class="card-title">미수금 현황</h3>
                    </div>
                    <div class="card-body" id="receivablesContent">
                        <div class="loading">
                            <i class="fa fa-spinner fa-spin"></i> 데이터 로딩 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 임원등기 연임안내 -->
            <div class="tab-pane" id="tab_renewal">
                <div class="card">
                    <div class="card-header border-bottom">
                        <h3 class="card-title">임원등기 연임 예정 법인</h3>
                    </div>
                    <div class="card-body" id="renewalsContent">
                        <div class="loading">
                            <i class="fa fa-spinner fa-spin"></i> 데이터 로딩 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 신규업체 관리 -->
            <div class="tab-pane" id="tab_newcompany">
                <div class="card">
                    <div class="card-header border-bottom">
                        <h3 class="card-title">최근 신규 등록 업체</h3>
                    </div>
                    <div class="card-body" id="newCompaniesContent">
                        <div class="loading">
                            <i class="fa fa-spinner fa-spin"></i> 데이터 로딩 중...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--ROW CLOSED-->
{% endblock %}

{% block modal %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // 담당자 목록 로드
        loadStaffList();

        // 초기 데이터 로드
        loadAllData();

        // 담당자 필터 변경시
        $('#staffFilter').change(function() {
            loadAllData();
        });
    });

    function loadStaffList() {
        $.ajax({
            url: '/admin/dsboard/api/staff-list/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const select = $('#staffFilter');
                    response.data.forEach(staff => {
                        select.append(`<option value="${staff}">${staff}</option>`);
                    });
                }
            },
            error: function(xhr) {
                console.error('담당자 목록 로드 실패:', xhr);
            }
        });
    }

    function loadAllData() {
        loadPendingFilings();
        loadReceivables();
        loadRenewals();
        loadNewCompanies();
    }

    function getStaffFilter() {
        const staff = $('#staffFilter').val();
        return staff ? `?staff=${encodeURIComponent(staff)}` : '';
    }

    function loadPendingFilings() {
        const filter = getStaffFilter();

        $.ajax({
            url: '/admin/dsboard/api/pending-filings/' + filter,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    renderPendingFilings(response.data);
                    updateStats('pending', response.count);
                }
            },
            error: function(xhr) {
                $('#pendingFilingsContent').html(`
                    <div class="alert alert-danger">
                        <i class="fe fe-alert-triangle me-2"></i>
                        데이터 로드 실패: ${xhr.responseJSON?.error || '알 수 없는 오류'}
                    </div>
                `);
            }
        });
    }

    function renderPendingFilings(data) {
        if (data.length === 0) {
            $('#pendingFilingsContent').html(`
                <div class="empty-state">
                    <i class="fe fe-check-circle"></i>
                    <h4>신고기한이 임박한 업체가 없습니다</h4>
                    <p class="text-muted">모든 업체가 정상적으로 신고를 완료했습니다.</p>
                </div>
            `);
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">D-Day</th>
                            <th>신고유형</th>
                            <th>업체명</th>
                            <th>사업자번호</th>
                            <th>담당자</th>
                            <th>과세기간</th>
                            <th>신고마감일</th>
                            <th>대표자</th>
                            <th>연락처</th>
                            <th>비고</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.forEach(item => {
            let dDayClass, dDayText;
            if (item.D_day <= 0) {
                dDayClass = 'd-day-urgent';
                dDayText = `D+${Math.abs(item.D_day)}`;
            } else if (item.D_day <= 3) {
                dDayClass = 'd-day-warning';
                dDayText = `D-${item.D_day}`;
            } else {
                dDayClass = 'd-day-normal';
                dDayText = `D-${item.D_day}`;
            }

            const 비고 = item.비고 || '';

            html += `
                <tr>
                    <td class="text-center"><span class="${dDayClass}">${dDayText}</span></td>
                    <td><span class="badge bg-primary">${item.신고유형}</span></td>
                    <td><strong>${item.업체명}</strong></td>
                    <td>${item.사업자번호}</td>
                    <td>${item.담당자}</td>
                    <td>${item.과세기간}</td>
                    <td>${item.신고마감일}</td>
                    <td>${item.대표자}</td>
                    <td>${item.연락처}</td>
                    <td><small class="text-muted">${비고}</small></td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#pendingFilingsContent').html(html);
    }

    function loadReceivables() {
        const filter = getStaffFilter();

        $.ajax({
            url: '/admin/dsboard/api/receivables/' + filter,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    renderReceivables(response.data, response.message);
                    updateStats('receivable', response.count);
                }
            },
            error: function(xhr) {
                $('#receivablesContent').html(`
                    <div class="alert alert-danger">
                        <i class="fe fe-alert-triangle me-2"></i>
                        데이터 로드 실패: ${xhr.responseJSON?.error || '알 수 없는 오류'}
                    </div>
                `);
            }
        });
    }

    function renderReceivables(data, message) {
        if (message) {
            $('#receivablesContent').html(`
                <div class="alert alert-info">
                    <i class="fe fe-info me-2"></i>${message}
                </div>
            `);
            return;
        }

        if (data.length === 0) {
            $('#receivablesContent').html(`
                <div class="empty-state">
                    <i class="fe fe-check-circle"></i>
                    <h4>미수금이 있는 업체가 없습니다</h4>
                    <p class="text-muted">모든 업체의 수임료가 정상 입금되었습니다.</p>
                </div>
            `);
            return;
        }

        // TODO: 실제 미수금 데이터 렌더링 로직
    }

    function loadRenewals() {
        const filter = getStaffFilter();

        $.ajax({
            url: '/admin/dsboard/api/executive-renewals/' + filter,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    renderRenewals(response.data);
                    updateStats('renewal', response.count);
                }
            },
            error: function(xhr) {
                $('#renewalsContent').html(`
                    <div class="alert alert-danger">
                        <i class="fe fe-alert-triangle me-2"></i>
                        데이터 로드 실패: ${xhr.responseJSON?.error || '알 수 없는 오류'}
                    </div>
                `);
            }
        });
    }

    function renderRenewals(data) {
        if (data.length === 0) {
            $('#renewalsContent').html(`
                <div class="empty-state">
                    <i class="fe fe-check-circle"></i>
                    <h4>임원등기 연임이 필요한 법인이 없습니다</h4>
                    <p class="text-muted">6개월 이내 연임 예정인 법인이 없습니다.</p>
                </div>
            `);
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">D-Day</th>
                            <th>업체명</th>
                            <th>사업자번호</th>
                            <th>담당자</th>
                            <th>대표자</th>
                            <th>설립일</th>
                            <th>연임예정일</th>
                            <th>연락처</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.forEach(item => {
            const dDayClass = item.D_day <= 30 ? 'd-day-urgent' :
                             item.D_day <= 90 ? 'd-day-warning' : 'd-day-normal';

            html += `
                <tr>
                    <td class="text-center"><span class="${dDayClass}">D-${item.D_day}</span></td>
                    <td><strong>${item.업체명}</strong></td>
                    <td>${item.사업자번호}</td>
                    <td>${item.담당자}</td>
                    <td>${item.대표자}</td>
                    <td>${item.설립일}</td>
                    <td>${item.연임예정일}</td>
                    <td>${item.연락처}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#renewalsContent').html(html);
    }

    function loadNewCompanies() {
        const filter = getStaffFilter();

        $.ajax({
            url: '/admin/dsboard/api/new-companies/' + filter,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    renderNewCompanies(response.data);
                    updateStats('newCompany', response.count);
                }
            },
            error: function(xhr) {
                $('#newCompaniesContent').html(`
                    <div class="alert alert-danger">
                        <i class="fe fe-alert-triangle me-2"></i>
                        데이터 로드 실패: ${xhr.responseJSON?.error || '알 수 없는 오류'}
                    </div>
                `);
            }
        });
    }

    function renderNewCompanies(data) {
        if (data.length === 0) {
            $('#newCompaniesContent').html(`
                <div class="empty-state">
                    <i class="fe fe-inbox"></i>
                    <h4>최근 등록된 업체가 없습니다</h4>
                    <p class="text-muted">최근 30일 내 신규 등록 업체가 없습니다.</p>
                </div>
            `);
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th>등록일</th>
                            <th>업체명</th>
                            <th>사업자번호</th>
                            <th>업체유형</th>
                            <th>담당자</th>
                            <th>대표자</th>
                            <th>연락처</th>
                            <th>이메일</th>
                            <th>업태/종목</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.forEach(item => {
            html += `
                <tr>
                    <td>${item.등록일}</td>
                    <td><strong>${item.업체명}</strong></td>
                    <td>${item.사업자번호}</td>
                    <td><span class="badge bg-info">${item.업체유형}</span></td>
                    <td>${item.담당자}</td>
                    <td>${item.대표자}</td>
                    <td>${item.연락처}</td>
                    <td>${item.이메일}</td>
                    <td>${item.업태} / ${item.종목}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#newCompaniesContent').html(html);
    }

    function updateStats(type, count) {
        $(`#${type}Count`).text(count);
        $(`#${type}Badge`).text(count);
    }
</script>
{% endblock %}