{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }    

    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table {
        width: auto !important; 
        margin: 0 !important;
    }
    
    /* ê·¸ë¦¬ë“œ ë˜í¼ */
    .ext-grid-wrapper {
        width: 100%;
        /* ë†’ì´ëŠ” JSì—ì„œ ì„¤ì • */
    }
</style>  

<div class="ext-grid-wrapper"></div>

<div class="modal fade unique-summit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div class="summitModalTitle"></div>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <div class="tabs-menu4 modal-tabs-menu"></div>
        <div class="tab-content modal-tab-content"></div>
      </div>
    </div>
  </div>
</div>	

<script>
(function() {
    // 1. ê·¸ë¦¬ë“œ ë³€ìˆ˜ ë¯¸ë¦¬ ì„ ì–¸
    var mainGrid;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [1] DOM ìš”ì†Œ í™•ë³´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ë‚´ìš©ë¬¼ì´ ì—†ëŠ”(ì•„ì§ ê·¸ë¦¬ë“œê°€ ì•ˆ ê·¸ë ¤ì§„) ë§ˆì§€ë§‰ ë˜í¼ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    var renderTarget = $('.ext-grid-wrapper').filter(function() {
        return $(this).children().length === 0;
    }).last()[0];

    // ë§Œì•½ ëª» ì°¾ìœ¼ë©´ í™œì„± íƒ­ ë‚´ë¶€ì—ì„œ ì¬ì‹œë„
    if (!renderTarget) {
        renderTarget = $('div.tab-pane.active .ext-grid-wrapper')
            .filter(function () { return $(this).children().length === 0; })
            .last()[0];
    }

    if (!renderTarget) {
        console.warn('ë Œë” íƒ€ê²Ÿì´ ì—†ì–´ì„œ ê·¸ë¦¬ë“œë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    // ëª¨ë‹¬ ID ìƒì„± ë° í• ë‹¹
    var $wrapper = $(renderTarget).parent(); 
    var modalUniqueId = 'summitModal_' + Math.floor(Math.random() * 100000);
    var $modal = $wrapper.find('.unique-summit-modal');
    $modal.attr('id', modalUniqueId);

    function findInModal(selector) { return $modal.find(selector); }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getGridHeight() {
        var height = window.innerHeight - 180;
        return height > 300 ? height : 300;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [3] ë³€ìˆ˜ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var adminBizLevel = '{{ admin_biz_level }}'.trim();
    const isSuperuser = '{{ admin_grade }}' === 'SA';
    var ADID = '{{ ADID }}'.trim();        
    var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
    var flag = '{{ flag }}';
    var work_YY = '{{ request.session.workyearCorp }}';
    var work_MM = new Date().getMonth() + 1;
    
    if(!work_YY && typeof getWorkYearAndMonth === 'function'){
      work_YY = getWorkYearAndMonth('mng_corp').work_YY;
    }
    const currentYear = getWorkYearAndMonth('mng_corp').work_YY;
    var corpYear, selectedPeriod, selectedSheetID, selectedSheetName="";
    
// ğŸŒŸ ê¸°ì¡´ ë°©ë¬¸ ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ê°ì²´
    var previousValues = {};

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [4] ì „ì—­ í•¨ìˆ˜ ì •ì˜ (onclick ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // 1. renderTopic
    window.renderTopic = function(value, p, record) {
        let recordKey = `record_${record.data.seq_no}`;
        window[recordKey] = record.data;
        return Ext.String.format(
            `<div style="cursor:pointer; color:blue;" 
                onclick="window.summitModal(window['${recordKey}'], ${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, 'Corp');">
                ${Ext.String.htmlEncode(value)}
            </div>`
        );
    };
    // 2. summitModal
    window.summitModal = async function(record, seq_no, biz_name, wYY, flag) {
        // showLoading("loading...");

        let recordKey = `record_${seq_no}`;
        delete window[recordKey];  
        window[recordKey] = record;

        previousValues = {};  
        registerInputEventListeners(seq_no, wYY, work_MM);

        let tmpHead = `
            <nav aria-label='breadcrumb'>
            <ol class='breadcrumb breadcrumb-style'>
                <li class='breadcrumb-item'>${biz_name}</li>
                <li class='breadcrumb-item'>${wYY}ë…„</li>
                <li class='breadcrumb-item active'>ë²•ì¸ì„¸ ì •ê¸°ì‹ ê³ </li>
            </ol>
            </nav>`;  
        findInModal('.summitModalTitle').html(tmpHead);

        let tmpTab = `
            <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-0">ë²•ì¸ì„¸ì‹ ê³ ì„œ</a>      
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-1">ì‹ ê³ ë„ì›€ ì•ˆë‚´</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-2">ì‹ ê³ ê²°ê³¼/ë¶„ì„</a>      
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-3">ê³ ìš©ì¦ëŒ€</a>      
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-4">ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´</a>                  
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-5">ë³´ë‚¸ ë©”ì¼</a>
            </nav>`;
        
        let tmpTab_Content = `
            <div class="tab-pane active task-files-tab" id="task-0">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3 mt-2 ps-5" style="flex-basis: 35%;">
                <div class="btn-group">
                    <button id="btn_selectedYear" type="button" class="btn btn-info dropdown-toggle mb-2" data-bs-toggle="dropdown">
                    ${wYY} ë…„<span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                    <li class="dropdown-plus-title">ì‘ì—…ì—°ë„<b class="fa fa-angle-up"></b></li>
                    <div class="list-group">
                        {% for node in corpYears %}
                        <li class="list-group-item list-group-item-action">
                            <a href="javascript:window.handleButtonClose(${seq_no}, '${biz_name}', {{ node }})">{{ node }}ë…„</a>
                        </li>
                        {% endfor %}
                    </div>
                    </ul>
                </div>          
                <div class="panel-group1" id="accordionLeft" role="tablist" aria-expanded="false" style="max-height: 860px; overflow-y: auto;"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 65%;">
                <div class="card-body">
                    <iframe id="singoseoPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
                </div>
            </div>              
            </div>
            <div class="tab-pane task-files-tab" id="task-1">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="CorpIntro"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                    <iframe id="introPDFIframe" width="100%" height="800px" frameborder="0"></iframe>
                </div>
                </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend1"></div>
            </div>
            <div class="tab-pane task-files-tab" id="task-2">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="CorpResult"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                    <div class="container" id="resultDiagnosys"></div>
                </div>
                </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend2"></div>
            </div>
            <div class="tab-pane task-files-tab" id="task-4">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="CorpFee"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-header border-bottom">
                    <h4 class="card-title fw-bold" id="DiscountHeader">ì„¸ë¬´ì¡°ì •ë£Œ í• ì¸ì •ì±… / ì œë³¸ë¶€ìˆ˜</h4>
                </div>
                <div class="card-body">
                    <div class="container" id="feeDiagnosys"></div>
                </div>
                </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend4"></div>
            </div>
            <div class="tab-pane task-files-tab" id="task-5">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="sentMailTable"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                    <iframe id="mailIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
                </div>
            </div>    
            </div>  
        `;

        findInModal('.modal-tabs-menu').html(tmpTab);  
        findInModal('.modal-tab-content').html(tmpTab_Content);  

        await treeLoad(seq_no, biz_name, wYY);
        await setMailContent(seq_no, wYY, work_MM, 'CorpIntro');
        await setIntroPDF(seq_no, wYY, biz_name);
        setDiscount(record, seq_no, wYY);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡ (jQuery ì¤‘ë³µ ë°©ì§€)
        $(document).off("change", "#AdditionDC_YJ, #AdditionDC_Ddct");
        $(document).off("change", 'input[name="discountRate"]');
        $(document).off("change", "#AdditionDC_JBCnt");

        $(document).on("change", "#AdditionDC_YJ, #AdditionDC_Ddct", debounce(function () {
            let field = $(this).attr("id");
            let value = $(this).prop("checked") ? 1 : 0;
            if (previousValues[field] !== value) {
                previousValues[field] = value;
                window.updateDiscountData(field, value, seq_no, wYY, work_MM);
            }
        }, 300));

        $(document).on("change", 'input[name="discountRate"]', debounce(function () {
            let value = $(this).val();
            if (previousValues["discountRate"] !== value) {
                previousValues["discountRate"] = value;
                window.updateDiscountData("AdditionDC_Stnd", value, seq_no, wYY, work_MM);
            }
        }, 300));

        $(document).on("change", "#AdditionDC_JBCnt", function () {
            let value = $(this).val();
            if (previousValues["AdditionDC_JBCnt"] !== value) {
                previousValues["AdditionDC_JBCnt"] = value;
                window.updateDiscountData("AdditionDC_JBCnt", value, seq_no, wYY, work_MM);
            }
        });

        // í•˜ë‹¨ ë²„íŠ¼ ìƒì„±
        let tmpBtn1 = `<button class="btn btn-info" onclick="window.sendMailAndKakao(${seq_no},'${biz_name}', ${wYY}, ${work_MM}, 'CorpIntro')">
            <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
            </button> 
            <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
        $modal.find('#btnKakaoSend1').html(tmpBtn1);    

        await setMailContent(seq_no, wYY, work_MM, 'CorpResult');
        let tmpBtn2 = `<button class="btn btn-info" onclick="window.sendMailAndKakao(${seq_no},'${biz_name}', ${wYY}, ${work_MM}, 'CorpResult')">
            <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
            </button> 
            <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
        $modal.find('#btnKakaoSend2').html(tmpBtn2); 

        await setMailContent(seq_no, wYY, work_MM, 'CorpFee');
        let tmpBtn4 = `<button class="btn btn-info" onclick="window.sendMailAndKakao(${seq_no},'${biz_name}', ${wYY}, ${work_MM}, 'CorpFee')">
            <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
            </button> 
            <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
        $modal.find('#btnKakaoSend4').html(tmpBtn4); 

        await sentMailList(seq_no, flag, "{% url 'getSentMails' %}");
        $modal.modal('show');
        // hideLoading();
    };
    // 3. check
    window.check = function(seq_no, target, wYY, val){
        $.ajax({
            url: "{% url 'mng_corp_update' %}",
            type: "POST",
            data: {
                seq_no: seq_no, target: target, work_YY: wYY, val: val,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            dataType: "json",
            success: function (data, textStatus, jqXHR) {},
            error: function (jqXHR) { Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ ì‹¤íŒ¨", "error"); }
        });
    };
    window.handleButtonClose = function(seq_no, biz_name, ev) {
        const btnElement = document.getElementById('btn_selectedYear');
        if(btnElement) btnElement.innerHTML = ev + " ë…„";
        treeLoad(seq_no, biz_name, ev);
    };

    window.changeSheet = function(selSheetID,selPeriod,selSheetName,file_path){
      selPeriod = decodeURIComponent(selPeriod);
      selSheetName = decodeURIComponent(selSheetName);
      file_path = decodeURIComponent(file_path);

      //ì¢Œì¸¡ ì»¨íŠ¸ë¡¤
      if(document.getElementById(selectedSheetID)){
        document.getElementById(selectedSheetID).setAttribute('class',"nav-link thumb")
      }
      if(document.getElementById(selSheetID)){
        document.getElementById(selSheetID).setAttribute('class',"nav-link thumb active")
      }
      file_path = decodeURIComponent(file_path);
      let iframe = document.getElementById("singoseoPDFIframe");
      if (iframe) {
          iframe.src = file_path;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
      } else {
        iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ì„œê°€ ë°”ë¥´ê²Œ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }    
      selectedSheetID = selSheetID;
      selectedPeriod = selPeriod;
      selectedSheetName = selSheetName;
    }
    window.updateDiscountData = function(field, value, seq_no, work_YY, work_MM){
        $.ajax({
            url: "{% url 'update_discount_data' %}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ seq_no: seq_no, [field]: value }),
            dataType: "json",
            success: function (response) {
                setMailContent(seq_no, work_YY, work_MM, 'CorpFee');
            },
            error: function (xhr) { console.error("AJAX ì˜¤ë¥˜:", error); }
        });
    }
    window.sendMailAndKakao = async function(seq_no, biz_name, work_YY, work_MM, mail_class)  {
      const objectUrl = "{% url 'sendMail' %}";
      const objectUrl_kakao = "{% url 'send_kakao_notification' %}";
      const user_path = `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ`;
      var user_file_names = []
      var targetUrl = '';
      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      let allIsGood = true;

      if(mail_class=="CorpIntro"){
        targetUrl = 'admin/mail/corp_intro.html';
        checkfileName = "98.pdf";
        let filePath = `${user_path}/${checkfileName}`;
        let exists = await fileExists(filePath);
        if (!exists) {
          allIsGood = false;
          alert(`íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
        } else {
          user_file_names.push(checkfileName)
          // console.log(user_file_names)
        }   
      } 
      else if(mail_class=="CorpResult"){
        targetUrl = 'admin/mail/corp_result.html';   
        checkfileNames = ["198.pdf","199.pdf","200.pdf","201.pdf","202.pdf","203.pdf"];
        for (let fileName of checkfileNames) {
          let filePath = `${user_path}/${fileName}`;
          let exists = await fileExists(filePath);
          if (!exists) {
            if (fileName=="198.pdf"){
              allIsGood = false;
              alert(`ì ‘ìˆ˜ì¦ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
              break;
            }
          }else{
            user_file_names.push(fileName)        
          }
        }
      } 
      else if(mail_class=="CorpFee"){
        targetUrl = 'admin/mail/corp_fee.html';
        checkYN8(seq_no, work_YY).then(function (exists) {
            if (!exists) {
                allIsGood = false;
                alert("ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });
      }
      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      if (allIsGood) {
        sendMail(seq_no, work_YY, work_MM, mail_class, objectUrl, targetUrl,user_file_names, user_path);
        sendKakao(seq_no, work_YY, work_MM, mail_class, objectUrl_kakao);
      } else {
        alert("ë©”ì¼ê³¼ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì†¡ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    };
    // ìˆ«ìë¥¼ ì„¸ìë¦¬ ì½¤ë§ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    window.formatNumberInput = function(input) {
      // ìŒìˆ˜ì™€ ìˆ«ìë§Œ í—ˆìš©
      let value = input.value.replace(/[^0-9-]/g, '');

      // ìŒìˆ˜ ì²˜ë¦¬
      let isNegative = value.startsWith('-');
      if (isNegative) {
        value = value.slice(1).replace(/[^0-9]/g, '');
      } else {
        value = value.replace(/[^0-9]/g, '');
      }

      // ë¹ˆ ì…ë ¥ ì²˜ë¦¬
      if (!value) {
        input.value = '';
        return;
      }

      // í¬ë§·íŒ…
      let number = Number(value);
      input.value = (isNegative ? '-' : '') + number.toLocaleString('en-US', { minimumFractionDigits: 0 });
    }
    var store = Ext.create('Ext.data.Store', {
    storeId: 'corpStore_' + Math.random(),
    autoLoad: true, // Storeê°€ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¡œë“œ
    proxy: {
        type: 'ajax', // Ajaxë¥¼ í†µí•´ ì„œë²„ì™€ í†µì‹ 
        url: '{% url "mng_corp_jungki" %}', // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
        extraParams: {
            ADID:ADID,
            work_YY:work_YY
        },        
        reader: {
            type: 'json', // ì„œë²„ì—ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
            rootProperty: 'data', // ì‘ë‹µ JSONì—ì„œ ë°ì´í„° ë°°ì—´ì˜ ì†ì„± ì´ë¦„
            totalProperty: 'total', // ì‘ë‹µ JSONì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì†ì„± ì´ë¦„
        },
    },   
    fields: [ // í•„ë“œ ì •ì˜ (ë°ì´í„°ì˜ ê° ì—´)
        {name: 'groupManager',type: 'string'},
        {name: 'seq_no'},
        {name: 'biz_name', type: 'string'}, 
        {name: 'revenue',type: 'number'},
        {name: 'expense',type: 'number'},
        {name: 'income',type: 'number'},
        {name: 'YN_4',type: 'number'},
        {name: 'YN_5',type: 'number'},
        {name: 'YN_6', type: 'bool'},         //ë§ˆê°
        {name: 'MailGrade', type: 'string'},
        {name: 'YN_8',type: 'number'},        //ìˆ˜ìˆ˜ë£Œ
        {name: 'YN_7', type: 'bool'},        //ìˆ˜ê¸ˆ
        {name: 'YN_10',type: 'date', dateFormat: 'Y-m-d'},     //ê²°ì¬ì¼
        {name: 'YN_11',type: 'bool'},         //ë°œí–‰
        {name: 'YN_12', type: 'date', dateFormat: 'Y-m-d'},       //ë°œí–‰ì¼
        {name: 'YN_13',type: 'bool'},         //ì…ê¸ˆ
        {name: 'YN_14',type: 'bool'},         //ì¹´ë“œ
        {name: 'YN_15',type: 'bool'},         //cms
        {name: 'YN_9', type: 'string'}, //ë¹„ê³ 
        {name: 'isIssue', type: 'string'},
        {name: 'JupsuID',type: 'string'}
    ],
    ... (ADID === "ì „ì²´" ? { groupField: 'groupManager' } : {}) // âœ… ADIDê°€ "ì „ì²´"ì¼ ë•Œë§Œ groupField ì¶”ê°€
});

    var comboDataStore = Ext.create('Ext.data.Store', { fields: ['id', 'name'], data: [] });
    var checkboxRender = function(value) { return "<input type='checkbox'" + (value ? "checked='checked'" : "") + ">"; };
    function formatDate(value){ return value ? Ext.Date.dateFormat(value, 'y-m-d') : ''; }
    Ext.tip.QuickTipManager.init();
    if (isSuperuser){
        Ext.Ajax.request({
            url: '{% url "kijang_admin_combolist" %}', method: 'GET',
            success: function (response) { comboDataStore.loadData(Ext.decode(response.responseText)); }
        });
    }
    
    const onItemClickHandlerWithFilter = function(newADID) {
        ADID = newADID;
        store.getProxy().extraParams.ADID = ADID;
        store.load();
        updateScrollMenuText(newADID);        
    };
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandlerWithFilter);

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
          edit: function (editor, e) {
              var field = e.field; 
              var value = e.value; 
              if (field === "YN_9" && value === null) value = "";
              Ext.Ajax.request({
                  url: "{% url 'mng_corp_update' %}",
                  method: "POST",
                  params: {
                      seq_no: e.record.get('seq_no'),
                      target: field,
                      work_YY: work_YY,
                      val: value,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                  },
                  success: function () {},
                  failure: function (response) { Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜", "error"); }
              });
          }
      }
    });    

    mainGrid = Ext.create('Ext.grid.Panel', {
      renderTo: renderTarget,
      title: '{{ gridTitle }}',
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      tools: [  //ìµœìƒë‹¨ ì˜¤ë¥¸ìª½ íˆ´ë°”
          {
            xtype: 'button',
            text: 'ì ‘ìˆ˜ë²ˆí˜¸ì €ì¥',
            iconCls: 'fa fa-floppy-o',
            handler: function (btn) {
              Ext.create('Ext.window.Window', {
                title: 'ë°ì´í„° ë¶™ì—¬ë„£ê¸°',
                modal: true,
                frame:false,
                width: 800,
                height: 200,
                layout: 'fit',
                items: [{
                    xtype: 'textarea',
                    name: 'clipboardData',
                    emptyText: 'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'
                }],
                buttons: [
                  {
                    text: 'ì €ì¥',
                    handler: function(btn) {
                        var win = btn.up('window');
                        var clipboardData = win.down('textarea').getValue();
                        Ext.Ajax.request({
                          url: "{% url 'save_clipboard_Corp' %}",
                          method: 'POST',
                          params: {
                              clipboardData: clipboardData,
                              csrfmiddlewaretoken: "{{ csrf_token }}"
                          },
                          success: function(response) {
                            win.close();
                            Swal.fire({
                              title: 'ì‘ì—… ì„±ê³µ',
                              text: 'ì „ìì‹ ê³ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                              icon: 'success',
                              //timer: 500,  // Set the timer to 3 seconds (3000 ms)
                              showConfirmButton: true,  // Hide the confirm button
                              willClose: () => {
                                let store = Ext.getCmp('mainGrid').getStore();
                                Ext.each(response.sqnos, function (item) {
                                    let record = store.findRecord('seq_no', item.seq_no);
                                    if (record) {
                                        record.set('isIssue', "ğŸ’™"); // userIDì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                    }
                                });
                                store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                              }
                            });                              
                          },
                          failure: function(response) {
                            Swal.fire("ì˜¤ë¥˜", "ì €ì¥ì˜¤ë¥˜ : " + response.message, "error");
                          }
                        });
                        win.close();
                    }
                  },
                  {
                    text: 'ì·¨ì†Œ',
                    handler: function(btn) {
                        btn.up('window').close();
                    }
                  }]
              }).show();
            },
            style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },      
          {
            xtype: 'button',
            text: 'ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œ',
            iconCls: 'fa fa-cloud-upload',
            handler: function () {
              let uploadWindow = Ext.create('Ext.window.Window', {
                    title: 'íŒŒì¼ ì—…ë¡œë“œ',
                    modal: true,
                    layout: 'fit',
                    items: [{
                        xtype: 'form',
                        bodyPadding: 10,
                        fileUpload: true,
                        items: [{
                            xtype: 'filefield',
                            name: 'uploadFile',
                            fieldLabel: 'íŒŒì¼ ì„ íƒ',
                            labelWidth: 70,
                            msgTarget: 'side',
                            allowBlank: false,
                            anchor: '100%',
                            buttonText: 'íŒŒì¼ ì°¾ê¸°...'
                        }],
                        buttons: [{
                            text: 'ì—…ë¡œë“œ',
                            handler: function (btn) {
                                var form = btn.up('form').getForm();
                                if (form.isValid()) {
                                  form.submit({
                                    url: "{% url 'save_elecfile_Corp' %}", // Django ì—…ë¡œë“œ URL
                                    params: {
                                        csrfmiddlewaretoken: "{{ csrf_token }}"
                                    },
                                    waitMsg: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...',
                                    success: function (form, action) {
                                        Ext.Msg.alert('ì„±ê³µ', 'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                        let response = action.result;
                                        uploadWindow.close();
                                        let store = Ext.getCmp('mainGrid').getStore();
                                        let record = store.findRecord('seq_no', response.seq_no);
                                        record.set('JupsuID', response.userID.slice(-2));  
                                        store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                                    },
                                    failure: function (form, action) {
                                        Ext.Msg.alert('ì‹¤íŒ¨', 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                    }
                                  });
                                }
                            }
                        }]
                    }]
                }).show();
            },
            style: 'margin-right: 10px;'
          },              
          {
              xtype: 'textfield',
              emptyText: 'ê²€ìƒ‰ì–´ ì…ë ¥',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // ê·¸ë¦¬ë“œì˜ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // í•„í„° ì œê±°
                      } else {
                          store.clearFilter(true); // ê¸°ì¡´ í•„í„° ì œê±°
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              const ceoName = record.get('ceo_name')?.toLowerCase() || '';
                              return (
                                  bizName.includes(searchValue) || ceoName.includes(searchValue)
                              );
                          });
                      }
                  }
              }
              
          },
          {
              xtype: 'button',
              iconCls: 'icon icon-refresh',
              handler: function (btn) {
                  location.reload();
              },
              style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },
      ],            
      width:'100%',
      height: getGridHeight(), // ì´ˆê¸° ë†’ì´ ì„¤ì •
      scrollable: 'y', // ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
      store: store,
      columnLines: true,
      ... (ADID === "ì „ì²´" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}),        
      plugins: [cellEditing],
      columns: [
        {   xtype: 'rownumberer',width: 30,	sortable: false}, 
        {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0        }, 
        {   header: 'SEQ', dataIndex: 'seq_no',width: 0        }, 
        {   id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',flex:1,minWidth: 130,renderer: renderTopic }, 
        {  
          header: '<center>ìˆ˜ì…ê¸ˆì•¡</center>', dataIndex: 'revenue',  width: 120, xtype: 'numbercolumn', align:'right',format:'0,000'//, editor: { allowBlank: false }
          , summaryType: 'sum', summaryRenderer: function(value) {  return Ext.util.Format.number(value, '0,000');}
        },{  
          header: '<center>íŒê´€ë¹„ ë“±</center>', dataIndex: 'expense',  width: 110,xtype: 'numbercolumn',align:'right', format:'0,000'            
          , summaryType: 'sum', summaryRenderer: function(value) {  return Ext.util.Format.number(value, '0,000');}
        },{
          header: '<center>ë‹¹ê¸°ìˆœì†ìµ</center>', dataIndex: 'income',  width: 110,xtype: 'numbercolumn',align:'right', format:'0,000'            
          , summaryType: 'sum', summaryRenderer: function(value) {  return Ext.util.Format.number(value, '0,000');}
        },{  header: '<center>ì¤‘ê°„ì˜ˆë‚©<br>(í™•ì¸í•˜ê¸°)</center>', dataIndex: 'YN_4',  width: 80,xtype: 'numbercolumn',align:'right', format:'0,000' }, 
        {  header: '<center>ë²•ì¸ì„¸ë“±</center>', dataIndex: 'YN_5',  width: 90,xtype: 'numbercolumn',align:'right', format:'0,000'    },
        {
          header: '<center>ê²°ì¬</center>', dataIndex: 'YN_6', width: 40,align:'center',
          xtype:  (isSuperuser) ? 'checkcolumn' : 'gridcolumn',
          renderer: (isSuperuser) ? checkboxRender : function (value) {
              return value ? "âœï¸" : '';  // âœ… ê°’ì´ trueì´ë©´ âœï¸, falseì´ë©´ ë¹ˆ ë¬¸ìì—´
          },
          listeners: (isSuperuser) ? {
              checkchange: function (column, recordIndex, checked) {
                  window.check(store.getAt(recordIndex).get('seq_no'), 'YN_6', work_YY, checked);
              }
          } : {}
        }, 
        {  header: '<center>ë©”ì¼<br>ë“±ê¸‰</center>', dataIndex: 'MailGrade',  width: 40, align:'center'  ,
            renderer: function(value) {
                let feelingGrade = 1; // ê¸°ë³¸ê°’ (ë¶ˆì¾Œ)
                if (value.includes("ì„¸ë¬´ì¡°ì •ë£Œ ì•ˆë‚´")) {
                    feelingGrade = 4;
                } else if (value.includes("ì ‘ìˆ˜ê²°ê³¼ ì•ˆë‚´")) {
                    feelingGrade = 3;
                } else if (value.includes("ì‹ ê³  ì•ˆë‚´")) {
                    feelingGrade = 2;
                }
                const emojis = {
                    1: "ğŸ˜¡",  // ë¶ˆì¾Œ
                    2: "ğŸ˜",  // ì‹œë¬´ë£©
                    3: "ğŸ™‚",  // ê¸°ì¨
                    4: "ğŸ˜"   // ë§¤ìš° ì¢‹ìŒ
                };
                return value.trim() ?  emojis[feelingGrade] : "";  // ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
            }
        },{  
          header: '<center>ìˆ˜ìˆ˜ë£Œ</center>', dataIndex: 'YN_8',  width: 90,xtype: 'numbercolumn', align:'right',format:'0,000', editor: { allowBlank: true }        
          , summaryType: 'sum', summaryRenderer: function(value) {  return Ext.util.Format.number(value, '0,000');}
        }, 
        {
          header: '<center>ìˆ˜ê¸ˆ</center>', dataIndex: 'YN_7',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender,align:'center',
          listeners: {
              checkchange: function(checkColumn, rowIndex, checked) {
                  var grid = this.up('grid'),
                      store = grid.getStore(),
                      rec = store.getAt(rowIndex);
                  
                  // ê¸°ì¡´ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (seq_no ê°’ì„ ì‚¬ìš©)
                  window.check(rec.get('seq_no'), 'YN_7', work_YY, checked);
                  
                  if (checked) {
                      // ì²´í¬ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
                      var today = Ext.Date.format(new Date(), 'Y-m-d');
                      rec.set('YN_10', today);
                  } else {
                      // ì²´í¬ í•´ì œ ì‹œ ê²°ì¬ì¼ ì´ˆê¸°í™”
                      rec.set('YN_10', '');
                  }
              }
          }
        },
        {  header: '<center>ìˆ˜ê¸ˆì¼</center>', dataIndex: 'YN_10',  width: 90 ,renderer: formatDate, editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	},
        {
          text: 'ì„¸ê¸ˆê³„ì‚°ì„œ',
          columns: [
          {   header: '<center>ë°œí–‰</center>', dataIndex: 'YN_11',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, align:'center',
              listeners: {
                  checkchange: function(checkColumn, rowIndex, checked) {
                      var grid = this.up('grid'),
                          store = grid.getStore(),
                          rec = store.getAt(rowIndex);
                      
                      window.check(rec.get('seq_no'), 'YN_11', work_YY, checked);
                      
                      if (checked) {
                          // ì²´í¬ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
                          var today = Ext.Date.format(new Date(), 'Y-m-d');
                          rec.set('YN_12', today);
                      } else {
                          // ì²´í¬ í•´ì œ ì‹œ ê²°ì¬ì¼ ì´ˆê¸°í™”
                          rec.set('YN_12', '');
                      }
                  }
              }          
          },
          {  header: '<center>ë°œí–‰ì¼</center>', dataIndex: 'YN_12',  width: 90,renderer: formatDate, editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	}
        ]},
        {
          text: 'ì œë³¸/ë°œì†¡',
          columns: [        
          {   header: '<center>ì¶œë ¥</center>', dataIndex: 'YN_13',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, align:'center',
              listeners: {checkchange: function (column, recordIndex, checked) {	window.check(store.getAt(recordIndex).get('seq_no'),'YN_13',work_YY,checked);	}}
          },
          {   header: '<center>ì „ë‹¬</center>', dataIndex: 'YN_14',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, align:'center',
              listeners: {checkchange: function (column, recordIndex, checked) {	window.check(store.getAt(recordIndex).get('seq_no'),'YN_14',work_YY,checked);	}}
          },
          {   header: '<center>ë°œì†¡</center>', dataIndex: 'YN_15',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, align:'center',
              listeners: {checkchange: function (column, recordIndex, checked) {	window.check(store.getAt(recordIndex).get('seq_no'),'YN_15',work_YY,checked);	}}
          }
        ]},
        {  header: '<center>ë¹„ê³ </center>', dataIndex: 'YN_9',  flex:1, editor: { allowBlank: true }          }, 
        {  header: '<center>ì „ì<br>ì‹ ê³ </center>', dataIndex: 'isIssue',  width: 40,align:'center',renderer: value => value ? "ğŸ’™" : ""     
        }, 
        {  header: '<center>ì ‘ìˆ˜<br>ID</center>', dataIndex: 'JupsuID',  width: 40,
            renderer: function(value) {
              // ê°’ì´ ì¡´ì¬í•˜ë©´ ëì—ì„œ ë‘ ìë¦¬ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.
              if (value && value.length >= 2) {
                  return value.slice(-2);
              }
              return value;
            }
        }
      ],      
      viewConfig: {
        emptyText: '<div style="text-align:center;padding:50px;font-size:16px; font-weight:bold;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
      },                  
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          items: [
            ...dockedItemsConfig,
            {
                xtype: 'buttongroup', columns: 5, frame: false,
                defaults: { enableToggle: true, toggleGroup: 'yearGroup', margin: '0 5 0 0', style: { border: '1px solid #ccc', padding: '5px 6px', borderRadius: '5px' } },
                items: Array.from({ length: 5 }, (_, i) => ({
                    text: `${currentYear - i}ë…„`,
                    pressed: currentYear - i === parseInt(work_YY, 10),
                    handler: function () {
                        var grid = this.up('grid');
                        work_YY = parseInt(this.text.replace('ë…„', ''));
                        grid.getStore().getProxy().extraParams.work_YY = work_YY;
                        grid.getStore().reload();
                    }
                }))
            },
            '->',
            { xtype: 'displayfield', fieldLabel: 'ë§¤ì¶œ', itemId: 'totalRevenueDisplay', margin: '0 10 0 0', value: '0' },
            { xtype: 'displayfield', fieldLabel: 'ì „ì²´', itemId: 'totalCommissionDisplay', value: '0' },
            { xtype: 'displayfield', fieldLabel: 'ìˆ˜ê¸ˆ', itemId: 'collectedCommissionDisplay', margin: '0 10 0 10', value: '0' }
          ]
        }
      ],
      listeners: {
        afterrender: function(grid) {
          Ext.EventManager.onWindowResize(function() {
                if(grid && !grid.isDestroyed) {
                    grid.setHeight(getGridHeight());
                    grid.doLayout();
                }
          });
          grid.getStore().on('datachanged', function() {
            var totalCommission = 0,
                collectedCommission = 0,
                totalRevenue = 0;
            store.each(function(record) {
                var commission = record.get('YN_8') || 0;
                totalCommission += commission;
                if (record.get('YN_7')) {
                    collectedCommission += commission;
                }
                var revenue = record.get('revenue') || 0;
                totalRevenue += revenue;
            });
            grid.down('#totalCommissionDisplay').setValue(
                Ext.util.Format.number(totalCommission, '0,000')
            );
            grid.down('#collectedCommissionDisplay').setValue(
                Ext.util.Format.number(collectedCommission, '0,000')
            );
            grid.down('#totalRevenueDisplay').setValue(
                Ext.util.Format.number(totalRevenue, '0,000')
            );
          });
        }  
      }
    });
    if (mainGrid) {
        attachGridToolTip(mainGrid, tooltipUrl); 
        if(typeof attachGridToolTip_Helper === 'function') attachGridToolTip_Helper(mainGrid, work_YY);
        if(typeof attachGridToolTip_JupsuSummit === 'function') attachGridToolTip_JupsuSummit(mainGrid, work_YY);
    }

    // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ ì •ì˜
    const debounce = (func, delay) => {
      let timeoutId;
      return function (...args) {
        const context = this;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(context, args), delay);
      };
    };

    //############# 0.ì‹ ê³ ì„œ ë³´ê¸°
    const treeLoad = async (seq_no,biz_name,work_YY) => {
      try {
        const accordionLeft = document.getElementById('accordionLeft');
        accordionLeft.innerHTML = ""; // ê¸°ì¡´ ìš”ì†Œ ë¹„ìš°ê¸°
        const response = await fetch("{% url 'path_to_corp_admin' %}", {
            method: "POST",
            dataType:"Json",
            body: JSON.stringify({
              seq_no:seq_no,
              path: `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ`
            })
        });

        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        
        const data = await response.json();
        //console.log(data)
        const { titles, nodes: gridFile } = data;

        const fragment = document.createDocumentFragment();

        titles.forEach((title, s) => {
            const divCard = document.createElement("div");
            divCard.classList.add("card", "overflow-hidden", "mb-2", "border-0");
            divCard.id = `collapseHead${s}`;

            const anchor1 = document.createElement('a');
            anchor1.classList.add("accordion-toggle", "panel-heading1", "collapsed");
            anchor1.dataset.bsToggle = "collapse";
            anchor1.ariaExpanded = "false";
            anchor1.href = `#collapse${s}`;
            anchor1.textContent = title.displayName;
            divCard.appendChild(anchor1);

            const divTabpanel = document.createElement("div");
            divTabpanel.classList.add("panel-collapse", "collapse");
            if (s === 0) {
                divTabpanel.classList.add("show");
                selectedSheetID = gridFile[0]?.id || null;
                selectedPeriod = title.displayName;
            }
            divTabpanel.id = `collapse${s}`;
            divTabpanel.role = "tabpanel";
            divTabpanel.ariaExpanded = "false";
            divTabpanel.dataset.bsParent = "#accordionAcnt";
            divCard.appendChild(divTabpanel);

            const ul = document.createElement('ul');
            ul.classList.add("nav1", "nav-column", "flex-column", "br-7");
            ul.id = `singoList${s}`;
            divTabpanel.appendChild(ul);

            singoListDetail(ul, title.displayName, gridFile, title.displayName, selectedSheetID);

            fragment.appendChild(divCard);
        });

        accordionLeft.appendChild(fragment);
      } catch (error) {
        console.error("Error loading tree:", error);
      }
    };
    const singoListDetail = async (ul, selGroup, gridFile, singoPeriod, selSheetID) => {
      return new Promise((resolve, reject) => {
        ul.innerHTML = "";  // ul ë¹„ìš°ê³  ì‹œì‘ (ê¶Œì¥)

        for (let i = 0; i < gridFile.length; i++) {
          if (gridFile[i].group === selGroup) {
            const li = document.createElement("li");
            li.setAttribute('id', "li" + gridFile[i].id);
            li.setAttribute('class', "nav-item1 mt-0");

            const anchor2 = document.createElement('a');
            anchor2.setAttribute('class', `nav-link thumb ${gridFile[i].id == selSheetID ? 'active' : ''}`);
            anchor2.setAttribute('id', gridFile[i].id);

            anchor2.href = `javascript:changeSheet('${gridFile[i].id}','${encodeURIComponent(singoPeriod)}','${encodeURIComponent(gridFile[i].íŒŒì¼ëª…)}','${encodeURIComponent(gridFile[i].totalPath)}')`;

            if (gridFile[i].íŒŒì¼ëª….includes("ë‚©ë¶€ì„œ")) {
              anchor2.innerHTML = `<span class='badge badge-sm bg-danger badge-hide me-4'>ë‚©ê¸°:${gridFile[i].dueDate}</span>${gridFile[i].íŒŒì¼ëª…}`;
            } else if (gridFile[i].íŒŒì¼ëª….includes("ì‹ ê³ ì„œ")) {
              anchor2.innerHTML = `<i class='ion ion-grid text-info'></i> ${gridFile[i].íŒŒì¼ëª…} <i class='ion ion-grid text-info ms-2'></i>`;
            } else {
              anchor2.innerHTML = `<i class='typcn typcn-minus-outline text-info'></i> ${gridFile[i].íŒŒì¼ëª…}`;
            }

            li.appendChild(anchor2);
            ul.appendChild(li);

            if (gridFile[i].id == selSheetID) {
              changeSheet(selSheetID, singoPeriod, gridFile[i].íŒŒì¼ëª…, gridFile[i].totalPath);
            }
          }
        }
      });
    };

    //############# 3. ê³ ìš©ì¦ëŒ€ / í‘œì§€
    //############# 4. ìˆ˜ìˆ˜ë£Œ / í• ì¸ìœ¨
    function setDiscount(record, seq_no, work_YY){
      $.ajax({
          url: "{% url 'get_discount_data'%}",  // Django API ì—”ë“œí¬ì¸íŠ¸
          type: "POST",
          contentType: "application/json",  // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
          data: JSON.stringify({ seq_no: seq_no }),  // JSON ë°ì´í„°ë¡œ ë³€í™˜
          dataType: "json",
          success: function (data) {
              if (data.error) {
                  console.error(data.error);
                  return;
              }

              // ğŸ“Œ í…Œì´ë¸”ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•œ í›„ ë°ì´í„° ì ìš©
              let tmpTable = `
                <div class="table-responsive">
                  <table class="table text-nowrap text-md-nowrap table-bordered">
                    <tbody>
                      <tr>
                        <td class="wp-30">ê¸°ì¤€ê¸ˆì•¡ ê°€ì‚°ì•¡ í• ì¸</td>
                        <td class="wp-70">
                          <label class="ckbox" for="AdditionDC_YJ"><input type="checkbox" id="AdditionDC_YJ"><span>ì—…ì¢…ë³„ ê°€ì‚°ê¸ˆì•¡ ë©´ì œ</span></label>
                          <label class="ckbox" for="AdditionDC_Ddct"><input type="checkbox" id="AdditionDC_Ddct"><span>ì„¸ì•¡ ê°ë©´ê³µì œ ê°€ì‚°ê¸ˆì•¡ ë©´ì œ</span></label>
                        </td>
                      </tr>
                      <tr>
                        <td class="wp-30">ê¸°ì¤€ê¸ˆì•¡ í• ì¸</td>
                        <td class="wp-70">
                          ${[0, 10, 15, 20, 25, 30, 35, 40].map(value => `
                            <label class="rdiobox" for="discount_${value}">
                              <input name="discountRate" type="radio" id="discount_${value}" value="${value}" ${data.AdditionDC_Stnd == value ? "checked" : ""}>
                              <span>Discount ${value}%</span>
                            </label>
                          `).join('')}
                        </td>
                      </tr>
                      <tr>
                        <td class="wp-30">ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ ì œë³¸ë¶€ìˆ˜</td>
                        <td class="wp-70">
                          <select class="form-control select2 form-select" data-placeholder="ê¶Œ" id="AdditionDC_JBCnt" style="width:100px">
                            ${[0,1,2,3,5,6,7,8,9,10].map(value => `
                              <option value="${value}" ${data.AdditionDC_JBCnt == value ? "selected" : ""}>${value}</option>
                            `).join('')}
                          </select> ê¶Œ
                        </td>
                      </tr>
                      <tr>
                        <td class="wp-30">íŠ¹ë³„ë³´ìˆ˜ ì²­êµ¬<br>ex)ì„¸ë¬´ì¡°ì‚¬ ëŒ€ì‘ ì„œë©´ì¡°ì‚¬ ëŒ€ì‘<br>ex)íŠ¹ìˆ˜ê³ ìš©ì§ ê³ ìš©ë³´í—˜ ì—…ë¬´<br>ex)ì‚¬ë¬´ì‹¤ ì£¼ì†Œ ì‚¬ìš©ë£Œ</td>
                        <td class="wp-70">
                          <div class="d-flex align-items-center">
                            <label for="SAddition_Rsn" class="form-label me-2" style="width: 50px; white-space: nowrap;">ğŸ”º</label>
                            <input class="form-control me-2" id="SAddition_Rsn"  type="text" style="max-width: 250px;" value="${data.SAddition_Rsn}">
                            <input class="form-control" id="SAddition_Amt" placeholder="ì²­êµ¬ê¸ˆì•¡" type="text" oninput="formatNumberInput(this)" style="max-width: 150px;align:right;" value="${data.SAddition_Amt}">
                          </div>
                          <div class="d-flex align-items-center">
                            <label for="OAddition_Rsn" class="form-label me-2" style="width: 50px; white-space: nowrap;">ğŸ”º</label>
                            <input class="form-control me-2" id="OAddition_Rsn" type="text" style="max-width: 250px;" value="${data.OAddition_Rsn}">
                            <input class="form-control" id="OAddition_Amt" placeholder="ì²­êµ¬ê¸ˆì•¡" type="text" oninput="formatNumberInput(this)" style="max-width: 150px;align:right;" value="${data.OAddition_Amt}">
                          </div>
                          <div class="d-flex align-items-center">
                            <label for="FAddition_Rsn" class="form-label me-2" style="width: 50px; white-space: nowrap;">ğŸ”º</label>
                            <input class="form-control me-2" id="FAddition_Rsn" type="text" style="max-width: 250px;" value="${data.FAddition_Rsn}">
                            <input class="form-control" id="FAddition_Amt" placeholder="ì²­êµ¬ê¸ˆì•¡" type="text" oninput="formatNumberInput(this)" style="max-width: 150px;align:right;" value="${data.FAddition_Amt}">
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td colspan="2" class="text-center">
                          <button class="btn btn-primary" id="updateCorpFeeGrid">ì„¸ë¬´ì¡°ì •ë£Œ ì €ì¥</button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              `;

              // ğŸ“Œ í…Œì´ë¸”ì„ ì‚½ì…í•œ í›„ í¼ ìš”ì†Œì— ê°’ ì ìš©
              $('[id="feeDiagnosys"]').html(tmpTable);

              // ğŸ“Œ ì²´í¬ë°•ìŠ¤ ê°’ ì ìš© (ì—…ì¢…ë³„ ê°€ì‚°ê¸ˆì•¡ ë©´ì œ, ì„¸ì•¡ ê°ë©´ê³µì œ)
              $("#AdditionDC_YJ").prop("checked", data.AdditionDC_YJ == 1);
              $("#AdditionDC_Ddct").prop("checked", data.AdditionDC_Ddct == 1);
              $("#updateCorpFeeGrid").click(function () {
                  let recordKey = `record_${seq_no}`;
                  let currentRecord = window[recordKey]; // windowì—ì„œ ìµœì‹  record ê°€ì ¸ì˜¤ê¸°

                  if (!currentRecord) {
                      console.error("ğŸš¨ ì˜¤ë¥˜: recordê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                      Swal.fire("ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                      return;
                  }            
                  let finalFee = document.getElementById("finalFee").innerText.replaceAll(",","");
                  console.log(finalFee)

                  $.ajax({
                    url: "{% url 'mng_corp_update' %}",
                    type: "POST",
                    data: {
                      seq_no: seq_no,
                      target : "YN_8",
                      work_YY: work_YY,
                      val : finalFee,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                      if (jqXHR.status === 200 && data.status === "success") {
                        currentRecord.set("YN_8", finalFee);
                        Swal.fire("ì €ì¥ì™„ë£Œ", "ì„¸ë¬´ì¡°ì •ë£Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ", "success");
                      } else {
                        Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : ì„¸ë¬´ì¡°ì •ë£Œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤." , "error");
                      }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                      console.error("AJAX ì‹¤íŒ¨:", textStatus, errorThrown);
                      Swal.fire("ì „ì†¡ ì‹¤íŒ¨", "ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + jqXHR.responseJSON.message, "error");
                    }
                  });
            });
          },
          error: function (xhr, status, error) {
              console.error("AJAX ì˜¤ë¥˜:", error);
          }
      });
    }


    // ğŸ“Œ ì…ë ¥ í•„ë“œ ê°ì§€ (ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ë‹¤ì‹œ ë“±ë¡)
    const registerInputEventListeners = (seq_no, work_YY, work_MM) => {
        const inputFields = ["#SAddition_Rsn", "#SAddition_Amt", "#OAddition_Rsn", "#OAddition_Amt", "#FAddition_Rsn", "#FAddition_Amt"];

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        inputFields.forEach(field => {
            $(document).off("input", field);
        });

        // ìƒˆë¡­ê²Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        inputFields.forEach(field => {
            $(document).on("input", field, debounce(function () {
                let value = $(this).val().replaceAll(",", "").trim();
                value = value === "" ? "0" : value;

                if (previousValues[field] !== value) {
                    previousValues[field] = value;
                    console.log(`ğŸ”„ [ì…ë ¥ ë³€ê²½] ${field}: ${value} (seq_no: ${seq_no})`);
                    updateDiscountData(field.replace("#", ""), value, seq_no, work_YY, work_MM);
                }
            }, 300));
        });
    };

    //############# ì•ˆë‚´ ì¹´í†¡ë‚´ìš© ìƒì„±
    // ì ‘ìˆ˜ê²°ê³¼ ê¸°ë³¸ì€ false, ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œì‹œ true
    let resultAndFee = false;
    const setMailContent = async (seq_no, work_YY, work_MM, flag) => {
      $.ajax({
        url: "{% url 'getMailContent' %}",
        type: "POST",
        data: {
          seq_no: seq_no,
          work_YY: work_YY,
          work_MM: work_MM,
          flag:flag,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        dataType: "json",
        success: function (data) {
          var bodyContent = data.email_content
          $('[id="' + flag + '"]').html(bodyContent);
        },
        error: function (request, status, error) {
          console.log('fail: ' + error);
        }
      });
    };
    const setIntroPDF = async (seq_no, work_YY, biz_name) => {
      let pdf98 = `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ/98.pdf`;
      let iframe = document.getElementById("introPDFIframe");
      try {
          // HEAD ìš”ì²­ì€ íŒŒì¼ì˜ ë‚´ìš©ì„ ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³ , íŒŒì¼ì˜ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸í•¨.
          let response = await fetch(pdf98, { method: 'HEAD' });    
          if (response.ok) {
              // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° iframe ì—…ë°ì´íŠ¸
              
              if (iframe) {
                  iframe.src = pdf98;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
              } else {
                iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(98.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
              }
          } else {
            iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(98.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          }
      } catch (error) {
        iframe.innerHTML = "PDF íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:"+ error;
      }
    };

    // í•˜ë‹¨ ì¹´í†¡&ë©”ì¼ ë³´ë‚´ê¸°
    function checkYN8(seq_no, work_YY) {
        return $.ajax({
            url: "{% url 'check_yn8' %}",
            type: "POST",
            data: { seq_no: seq_no, work_YY: work_YY },
            dataType: "json"
        }).then(function (data) {
            return data.exists; // YN_8 ê°’ì´ ì¡´ì¬í•˜ë©´ true, ì—†ìœ¼ë©´ false
        }).catch(function (error) {
            console.error("ğŸš¨ API í˜¸ì¶œ ì˜¤ë¥˜:", error);
            return false;
        });
    }
    // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
    const fileExists = async (filePath) => {
      try {
        let response = await fetch(filePath, { method: 'HEAD' });
        return response.ok; // íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ true, ì—†ìœ¼ë©´ false
      } catch (error) {
        console.error("íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        return false;
      }
    };

    //ì ‘ìˆ˜ì¦ ë§ˆìš°ìŠ¤ í´ë¦­ì‹œ íˆ´íŒë°œìƒ
    function attachGridToolTip_JupsuSummit(grid,work_YY){
      Ext.create('Ext.tip.ToolTip', {
          target: grid.getEl(),
          delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
          trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
          dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
          autoHide: true, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
          maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
          minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
          anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
          mouseOffset: [-350, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
          renderTo: Ext.getBody(),
          listeners: {
            beforeshow: function (tip) {
              const cell = Ext.get(tip.triggerElement);
              const record = grid.getView().getRecord(cell.parent());
              const columnIndex = cell.dom.cellIndex;
              const column = grid.headerCt.getHeaderAtIndex(columnIndex);
            
              if (column.dataIndex === 'isIssue') {
                const seqNo = record.get('seq_no');
                Ext.Ajax.request({
                    url: '{% url "mng_corp_jupsuSummit" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                    method: 'POST',
                    params: {
                      seq_no:seqNo,
                      work_YY:work_YY,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                    }, 
                    success: function (response) {
                        const data = Ext.decode(response.responseText);
                        tip.update(`
                    <div class="notifications-menu ps3 overflow-hidden">
                        <div class="drop-heading border-bottom position-relative">
                            <div class="d-flex">
                                <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mt-1 mb-0 fs-15 text-dark">ë²•ì¸ì„¸ ì „ìì‹ ê³  ì ‘ìˆ˜ì¦</h6>
                                    <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                                </div>
                            </div>
                            <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">${data.ì‹ ê³ ì„œì¢…ë¥˜}</span>
                                </div>
                            </div>                                                                                    
                        </div>                                                                                    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">íšŒê³„ê¸°ê°„ ì¢…ë£Œì›” ${data.ê³¼ì„¸ë…„ì›”}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>      
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ìœ í˜• : ${data.ì‹ ê³ ìœ í˜•}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                                                                                              
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ë²ˆí˜¸</span>
                                  <span class="notification-label ">${data.ì‹ ê³ ë²ˆí˜¸}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ì‹œê° ${data.ì‹ ê³ ì‹œê°}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                          
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì ‘ìˆ˜ID ${data.ì‚¬ìš©ìID}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                              
                    </div>
                        `);
                          // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                          Ext.defer(() => {
                              const closeButton = document.getElementById("tooltipCloseBtn");
                              if (closeButton) {
                                  closeButton.addEventListener("click", function () {
                                      tip.hide();
                                  });
                              }
                          }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                    },
                    failure: function () {
                        tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                    }
                });
              } else {
                  return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
              }
            }
          }
      });  
    }

    // ìƒí˜¸ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ íˆ´íŒ ë°œìƒ
    function attachGridToolTip_Helper(grid,work_YY) {
      Ext.create('Ext.tip.ToolTip', {
          target: grid.getEl(),
          delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
          trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
          dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
          autoHide: false, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
          maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
          minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
          anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
          mouseOffset: [0, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
          renderTo: Ext.getBody(),
          listeners: {
            beforeshow: function (tip) {
              const cell = Ext.get(tip.triggerElement);
              const record = grid.getView().getRecord(cell.parent());
              const columnIndex = cell.dom.cellIndex;
              const column = grid.headerCt.getHeaderAtIndex(columnIndex);
            
              if (column.dataIndex === 'biz_name') {
                const seqNo = record.get('seq_no');

                // AJAXë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ íˆ´íŒ ì—…ë°ì´íŠ¸
                Ext.Ajax.request({
                    url: '{% url "mng_corp_deduct_tooltip" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                    method: 'POST',
                    params: {
                      seq_no:seqNo,
                      work_YY:work_YY,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                    }, 
                    success: function (response) {
                        const data = Ext.decode(response.responseText);
                        tip.update(`
                    <div class="notifications-menu ps3 overflow-hidden">
                        <div class="drop-heading border-bottom position-relative">
                            <div class="d-flex">
                                <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mt-1 mb-0 fs-15 text-dark">ì„¸ì•¡ê°ë©´ ê³µì œ íŒë‹¨ì‚¬í•­</h6>
                                    <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                                </div>
                            </div>
                            <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-yellow brround">
                                    <i class="icon icon-magic-wand"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ ${data.SpecialDeduct === 'Y' ? 'â­•' : 'âŒ'}, ê°ë©´ìœ¨ : ${data.SpecialDeductRate} %</span>
                                  <span class="notification-subtext text-muted">ìˆ˜ë„ê¶Œì™¸ ${data.isRural === 'Y' ? 'â­•' : 'âŒ'}, ì†Œê¸°ì—…ìš”ê±´ ${data.isSmall === 'Y' ? 'â­•' : 'âŒ'}, ì—…ì¢…:${Ext.String.htmlEncode(data.upjong)}${data.isSpecialUpjong === 'Y' ? 'â­•' : 'âŒ'} </span>
                                </div>
                                                          
                            </div>                                                                                    
                        </div>                                                                                    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-red brround">
                                    <i class="icon icon-fire"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì°½ì—…ì¤‘ì†Œê¸°ì—…ê°ë©´ ${data.ChangUpDeduct === 'Y' ? 'â­•' : 'âŒ'}, ê°ë©´ìœ¨ :${data.ChangUpDeductRate } %</span>
                                  <span class="notification-subtext text-muted">ê³¼ë°€ì§€ì—­ì™¸ ${data.isKWAMIL === '' ? 'â­•' : 'âŒ'}, ëŒ€í‘œìë‚˜ì´ : ${data.age}ì„¸, ê°œì—…ìš”ê±´ : ${data.kisu <=5 ? 'â­•' : 'âŒ'}(${data.kisu}ê¸°), ì†Œê·œëª¨ì°½ì—… ${data.isLittle === 'Y' ? 'â­•' : 'âŒ'}, ì—…ì¢…:${Ext.String.htmlEncode(data.upjong)}${data.isSpecialUpjong === 'Y' ? 'â­•' : 'âŒ'}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>      
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì²­ë…„ì—¬ë¶€ ${data.isYoung === 'Y' ? 'â­•' : 'âŒ'}</span>
                                  <span class="notification-label ">ë¬¼ë¥˜ì‚°ì—… ${data.isMyulyu === 'Y' ? 'â­•' : 'âŒ'}, ì‹ ì„±ì¥ì‚°ì—… ${data.isNewGroth === 'Y' ? 'â­•' : 'âŒ'}, ì§€ì‹ê¸°ë°˜ì‚°ì—… ${data.isKnowledge === 'Y' ? 'â­•' : 'âŒ'}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                                                                                              
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-green brround">
                                    <i class="icon icon-graduation"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ë³´ìœ ì—¬ë¶€ ${data.isRND === 'Y' ? 'â­•' : 'âŒ'}</span>
                                  <span class="notification-label ">ë²¤ì²˜ê¸°ì—… ì¸ì¦ì—¬ë¶€ ${data.isVenture === 'Y' ? 'â­•' : 'âŒ'}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-yellow brround">
                                    <i class="icon icon-people"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œì—¬ë¶€ ${data.cntGoyoungIncrease > 0 ? 'â­•' : 'âŒ'}</span>
                                  <span class="notification-label ">ê³ ìš©ì¦ê°€ì¸ì› : ${data.cntGoyoungIncrease} ëª…</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                          
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì£¼ì†Œ :  ${data.addr}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                                                                                                                                
                    </div>
                        `);
                          // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                          Ext.defer(() => {
                              const closeButton = document.getElementById("tooltipCloseBtn");
                              if (closeButton) {
                                  closeButton.addEventListener("click", function () {
                                      tip.hide();
                                  });
                              }
                          }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                    },
                    failure: function () {
                        tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                    }
                });
              } else {
                  return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
              }
            }
          }
      });
    }

})();
</script>
