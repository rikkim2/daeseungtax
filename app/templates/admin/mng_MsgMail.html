{% load static %}
<div class="mngmsg-mail-wrap" id="mngMsgMailMount"></div>
<script>
(function(){
  // ✅ 탭 임베디드 중복 렌더 방지
  if (window.__MNGMSG_MAIL_INITED__) return;
  window.__MNGMSG_MAIL_INITED__ = true;

  // ✅ 렌더 타겟 찾기
  var renderTarget = document.getElementById('mngMsgMailMount');
  if (!renderTarget) {
    renderTarget = document.querySelector('div.tab-pane.active .mngmsg-mail-wrap'); // 클래스명 변경
  }
  if (!renderTarget) return;
  // ★ [핵심 수정] 높이 계산 함수
  // 전체창 높이 - (헤더 + 탭높이 + 패딩 등 여유분 약 160px)
  function getGridHeight() {
      return window.innerHeight - 160; 
  }
  // ─────────────────────────────────────────────
  // 1. Config & Templates (주제별 내용 정의)
  // ─────────────────────────────────────────────
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();        
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
  var DATA_URL   = "{% url 'mngMsg_mail_data' %}";
  var SEND_URL   = "{% url 'mngMsg_mail_send' %}";
  var UPLOAD_URL = "{% url 'mngMsg_mail_upload' %}";

  // 주제별 템플릿 정의 (ASP 코드의 로직을 JS 데이터로 변환)
var mailTemplates = {
    'pay': {
        title: '급여신고 안내',
        subject: '[공지] 급여신고 관련 안내 말씀드립니다.',
        body: '안녕하세요 {회사명}입니다.<br><br>이번 달 급여 변동 사항이나 일용직 근로자가 있으시면 내역을 보내주시기 바랍니다.<br>감사합니다.'
    },
    'vat': {
        title: '부가세 신고 안내',
        subject: '[안내] 부가가치세 신고 납부 기간입니다.',
        body: '안녕하세요 {회사명}입니다.<br><br>이번 달 25일까지 부가세 신고 납부 기간입니다.<br>매출/매입 자료가 준비되시면 신속히 전달 부탁드립니다.<br><br>감사합니다.'
    },
    'yearend': {
        title: '연말정산 안내',
        subject: '[중요] 연말정산 자료 제출 안내',
        body: '안녕하세요 {회사명}입니다.<br><br>연말정산 기간이 도래하였습니다.<br>요청드린 자료를 기한 내에 회신 주시면 감사하겠습니다.'
    },
    'holiday': {
        title: '명절 인사',
        subject: '풍성한 한가위 되세요.',
        body: '안녕하세요 {회사명}입니다.<br><br>가족과 함께 따뜻하고 풍성한 명절 보내시길 바랍니다.<br>항상 건강하세요.'
    },
    'custom': {
        title: '직접 입력',
        subject: '',
        body: ''
    }
  };

  // 템플릿 적용 함수
  function applyTemplateToForm(key) {
      var tpl = mailTemplates[key];
      if (!tpl) return;
      var subjCmp = Ext.getCmp('mngMsgMail_subject');
      var bodyCmp = Ext.getCmp('mngMsgMail_body');
      if (subjCmp) subjCmp.setValue(tpl.subject || '');
      if (bodyCmp) bodyCmp.setValue(tpl.body || '');
  }

  // 템플릿 선택용 스크롤 메뉴
  var templateMenu = Ext.create('Ext.menu.Menu', {
      height: 400,
      scrollable: { x: false, y: true },
      items: Object.keys(mailTemplates).map(function(k) {
          return {
              text: mailTemplates[k].title || k,
              handler: function(){ applyTemplateToForm(k); }
          };
      })
  });

  // 콤보박스용 데이터 스토어 변환
  var templateStoreData = [];
  for (var key in mailTemplates) {
      templateStoreData.push([key, mailTemplates[key].title]);
  }

  // 업로드 상태 변수
  var uploadFileName = "";
  var fileCount = 0;

  // ─────────────────────────────────────────────
  // 2. Data Store
  // ─────────────────────────────────────────────
  var store = Ext.create('Ext.data.Store', {
    fields: ['groupManager','seq_no', 'biz_name', 'email', 'mail_date'],
    proxy: {
      type: 'ajax',
      url: DATA_URL,
      reader: { type: 'json', root: 'rows', totalProperty: 'total' },
      extraParams: { flag: 'mail', ADID: ADID }
    },
    autoLoad: true,
    ... (ADID === "전체" ? { groupField: 'groupManager' } : {}) // ✅ ADID가 "전체"일 때만 groupField 추가
  });
  var comboDataStore = Ext.create('Ext.data.Store', {
      fields: ['id', 'name'],
      data: [] // 초기 데이터는 비워둠
  });
  var sm = Ext.create('Ext.selection.CheckboxModel', {
      checkOnly: false, // 행 클릭시에도 체크되도록 변경 (UX 향상)
      mode: 'SIMPLE',   // Ctrl 키 없이도 다중 선택 가능
      listeners: {
          selectionchange: function(model, selected) {
              // 선택된 인원 수 업데이트
              var count = selected.length;
              var display = Ext.getCmp('selected-count-display');
              if(display) display.setValue(count > 0 ? '<b style="color:blue">' + count + '명</b> 선택됨' : '선택 없음');
          }
      }
  });

function onItemClickHandler(item) {
      ADID = item;
      updateScrollMenuText(item);
      // 선택한 ADID로 스토어 재조회
      if (store && store.getProxy()) {
          store.getProxy().setExtraParam('ADID', ADID);
          store.load();
      }
  }    
  if (isSuperuser){
      Ext.Ajax.request({
          url: '{% url "kijang_admin_combolist" %}', // 동적으로 데이터를 가져올 API URL
          method: 'GET',
          success: function (response) {
              const data = Ext.decode(response.responseText); // 응답 데이터를 파싱
              comboDataStore.loadData(data); // store에 데이터 로드
          },
          failure: function () {
              Ext.Msg.alert('오류', '데이터를 불러오는 데 실패했습니다.');
          }
      });
  }
  // Docked Items Config 생성
  const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);    

  // [좌측] 수신자 리스트 그리드
  var mainGrid = Ext.create('Ext.grid.Panel', {
    region: 'west', // Border Layout: 왼쪽
    width: '50%',
    split: true,    // 크기 조절 가능바 생성
    collapsible: false,
    title: '발송 대상자 목록',
    store: store,
    selModel: sm,
    columnLines: true,
    ... (ADID === "전체" ? { 
          features: [{
              id: 'groupManager',
              ftype: 'groupingsummary',
              startCollapsed: false,
              groupHeaderTpl: '{name}',
              hideGroupedHeader: false,
              enableGroupingMenu: true
          }]
      } : {}),      
    columns: [
      { xtype: 'rownumberer', width: 40 },
      { dataIndex: 'groupManager',header: '<center>관리자</center>',  width: 0},  
      { text: '회사명', dataIndex: 'biz_name', width: 140, style: 'text-align:center' },
      { text: '이메일', dataIndex: 'email', flex: 1, style: 'text-align:center' },
      { 
        text: '상태', 
        dataIndex: 'mail_date', 
        width: 60, 
        align: 'center',
        renderer: function(v) {
            if(v === '성공') return '<span style="color:green; font-weight:bold;">V</span>';
            if(v === '실패') return '<span style="color:red;">X</span>';
            return '-';
        }
      }
    ],
    dockedItems: [
      {
        dock: 'top',
        xtype: 'toolbar',
        style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
        items: dockedItemsConfig.concat([
          '->',
          {
            text: '메일보내기',
            iconCls: 'fa fa-paper-plane',
            handler: sendMailAction
          }
        ])
      }
    ]
  });

  // [우측] 메일 작성 폼
  var formPanel = Ext.create('Ext.form.Panel', {
    region: 'center', // Border Layout: 가운데(나머지 전체)
    title: '메일 작성 및 전송',
    bodyPadding: 15,
    autoScroll: true,
    defaults: { anchor: '100%', labelAlign: 'top' },
    layout: 'anchor',
    items: [
      {
        xtype: 'fieldset',
        title: '1. 내용 작성',
        layout: 'anchor',
        defaults: { anchor: '100%' },
        items: [
            {
                xtype: 'textfield',
                fieldLabel: '제목',
                id: 'mngMsgMail_subject',
                allowBlank: false,
                emptyText: '메일 제목을 입력하세요'
            },
            {
                xtype: 'fieldcontainer',
                fieldLabel: '첨부파일',
                layout: 'hbox',
                items: [
                  {
                    xtype: 'filefield',
                    buttonText: '파일 선택',
                    flex: 1,
                    listeners: {
                      change: function(obj){
                        var fileDom = obj.fileInputEl.dom;
                        if (!fileDom.files[0]) return;
                        
                        var fd = new FormData();
                        fd.append('file', fileDom.files[0]);
                        
                        // 파일명 표시용 임시 업데이트
                        Ext.getCmp('mngMsgMail_fileName').setValue('업로드 중...');

                        fetch(UPLOAD_URL, {
                          method: 'POST',
                          headers: { 'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1] },
                          body: fd
                        })
                        .then(r => r.json())
                        .then(json => {
                          if (!json.ok) throw new Error(json.msg);
                          uploadFileName = json.uploaded_name;
                          fileCount = 1;
                          Ext.getCmp('mngMsgMail_fileName').setValue(uploadFileName);
                          Ext.Msg.alert('성공', '파일이 업로드 되었습니다.');
                        })
                        .catch(err => {
                          Ext.getCmp('mngMsgMail_fileName').setValue('');
                          Ext.Msg.alert('실패', '업로드 실패: ' + err.message);
                        });
                      }
                    }
                  },
                  { xtype: 'displayfield', width: 10 },
                  {
                    xtype: 'textfield',
                    id: 'mngMsgMail_fileName',
                    readOnly: true,
                    flex: 1,
                    emptyText: '선택된 파일 없음'
                  }
                ]
            },
            {
                xtype: 'htmleditor',
                fieldLabel: '내용',
                id: 'mngMsgMail_body',
                height: 350,
                enableColors: true,
                enableAlignments: true
            }
        ]
      }
    ],
    dockedItems: [
      {
        dock: 'top',
        xtype: 'toolbar',
        style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
        items: [
          {
            text: '템플릿 선택',
            itemId: 'tb_template',
            iconCls: 'x-fa fa-bars',
            menu: templateMenu
          }
        ]
      }
    ]
  });

  // ─────────────────────────────────────────────
  // 4. Main Layout & Logic
  // ─────────────────────────────────────────────

  // 메일 전송 로직 분리
  function sendMailAction() {
      var records = sm.getSelection();
      if (!records.length) {
          Ext.Msg.alert('알림', '좌측 리스트에서 발송 대상을 선택해주세요.');
          return;
      }

      var subject = Ext.getCmp('mngMsgMail_subject').getValue();
      var body = Ext.getCmp('mngMsgMail_body').getValue();

      if (!subject) {
          Ext.Msg.alert('알림', '제목을 입력해주세요.');
          return;
      }

      Ext.MessageBox.confirm('발송 확인', 
          '총 <b>' + records.length + '명</b>에게 메일을 발송하시겠습니까?', 
          function(btn){
              if(btn === 'yes') {
                  doSend(records, subject, body);
              }
          }
      );
  }

  function doSend(records, subject, body) {
      Ext.getBody().mask('메일 전송 중입니다... (0/' + records.length + ')');
      
      var total = records.length;
      var completed = 0;

      // Promise.all로 병렬 처리
      var promises = records.map(function(rec) {
          var personalizedBody = body.replace(/\{회사명\}/g, rec.get('biz_name'));
          
          return fetch(SEND_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1]
              },
              body: JSON.stringify({
                  seq_no: rec.get('seq_no'),
                  email: rec.get('email'),
                  biz_name: rec.get('biz_name'),
                  title: subject,
                  content: personalizedBody,
                  uploaded_name: uploadFileName,
                  fileCount: fileCount
              })
          })
          .then(r => r.json())
          .then(json => {
              completed++;
              Ext.getBody().mask('메일 전송 중입니다... (' + completed + '/' + total + ')');
              return { rec: rec, success: json.ok };
          });
      });

      Promise.all(promises).then(function(results) {
          results.forEach(function(res) {
              res.rec.set('mail_date', res.success ? '성공' : '실패');
              if (res.success) {
                  res.rec.set('mail_date', Ext.Date.format(new Date(), 'Y-m-d H:i'));
              }
              res.rec.commit(); // 변경사항 확정 (Red mark 제거)
          });
          
          // 전송 후 초기화
          uploadFileName = ""; 
          fileCount = 0;
          Ext.getCmp('mngMsgMail_fileName').setValue('');
          
          Ext.getBody().unmask();
          Ext.Msg.alert('완료', '전송 작업이 완료되었습니다.');
      });
  }

  // 전체 레이아웃 렌더링 (Border Layout)
  var mainPanel = Ext.create('Ext.panel.Panel', {
    renderTo: renderTarget,
    layout: 'border',
    width: '100%',
    height: getGridHeight(),      
    items: [mainGrid, formPanel]
  });
  // 2) 리사이즈 이벤트 수정
  // jQuery의 $(window).resize 대신 ExtJS 내장 리사이즈를 사용하는 것이 성능상 더 좋습니다 (자동 디바운싱 지원).
  Ext.EventManager.onWindowResize(function() {
      if (mainPanel && !mainPanel.isDestroyed) {
          // 부모 패널의 높이만 조절하면 내부의 grid와 formPanel은 border 레이아웃에 의해 자동 조절됨
          mainPanel.setHeight(getGridHeight());
          // mainPanel.doLayout(); // ExtJS 4.x 이상에서는 setHeight시 자동 레이아웃 되므로 생략 가능 (필요시 주석 해제)
      }
  });

})();
</script>
