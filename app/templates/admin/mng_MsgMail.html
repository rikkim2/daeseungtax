{% load static %}
<div class="mngmsg-mail-wrap" id="mngMsgMailMount"></div>
<script>
(function(){
  // âœ… íƒ­ ì„ë² ë””ë“œ ì¤‘ë³µ ë Œë” ë°©ì§€
  if (window.__MNGMSG_MAIL_INITED__) return;
  window.__MNGMSG_MAIL_INITED__ = true;

  // âœ… ìš”ì²­ ìˆœì„œ ë³´ì¥ìš©
  window.__adminInfoReqSeq = window.__adminInfoReqSeq || 0;
  window.__MNGMSG_MAIL_SELECTED_ADID__ = window.__MNGMSG_MAIL_SELECTED_ADID__ || '';
  window.__MNGMSG_MAIL_ALL_MODE__ = window.__MNGMSG_MAIL_ALL_MODE__ || false;

  // âœ… ë Œë” íƒ€ê²Ÿ ì°¾ê¸°
  var renderTarget = document.getElementById('mngMsgMailMount');
  if (!renderTarget) {
    renderTarget = document.querySelector('div.tab-pane.active .mngmsg-mail-wrap');
  }
  if (!renderTarget) return;

  function getGridHeight() { return window.innerHeight - 160; }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1. Config
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
  const ALL_ADID_VALUE = (arrADID && arrADID[0]) || 'ì „ì²´';
  const isAllADID = (val) => (val === 'ì „ì²´' || val === ALL_ADID_VALUE);

  var DATA_URL   = "{% url 'mngMsg_mail_data' %}";
  var SEND_URL   = "{% url 'mngMsg_mail_send' %}";
  var UPLOAD_URL = "{% url 'mngMsg_mail_upload' %}";

  // âœ… ìš´ì˜ ê¸°ë³¸ê°’(ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ì „ì²´ í…œí”Œë¦¿ì— ë°˜ì˜)
  // âš ï¸ "ì „ì²´" ëª¨ë“œì—ì„œëŠ” í”„ë¦¬ë·°ì— ë‹´ë‹¹ì/ì—°ë½ì²˜ë¥¼ ì ˆëŒ€ ë„£ì§€ ì•ŠëŠ”ë‹¤(ë©”ì¼ì— ë°•íˆëŠ” ë¬¸ì œ ë°©ì§€)
  var GLOBAL_DEFAULTS = {
    ë‹´ë‹¹ì: '{{ admin_name|default_if_none:"" }}',
    ì—°ë½ì²˜: '{{ admin_tel_no|default_if_none:"" }}',
    ì œì¶œë°©ë²•: 'â‘  íšŒì‹ ë©”ì¼ ì²¨ë¶€ ë˜ëŠ” â‘¡ ìë£Œì—…ë¡œë“œ ë²„íŠ¼ ì´ìš©',
    CTA_URL: 'https://daeseungtax.co.kr',
    CTA_TEXT: 'ìë£Œ ì œì¶œí•˜ê¸°'
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2. helpers / buildMailShell
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildCTAButton(text, url) {
    // NOTE: ì—¬ê¸°ì„œëŠ” placeholder í˜•íƒœë¡œ ìœ ì§€ â†’ ìµœì¢… replaceAllPlaceholdersì—ì„œ ì¹˜í™˜ë¨
    if (!text || !url) return '';
    return [
      '<table role="presentation" cellspacing="0" cellpadding="0" border="0" style="margin:16px 0 4px;">',
      '  <tr>',
      '    <td align="left">',
      '      <a href="{CTA_URL}" style="display:inline-block;background:#255398;color:#fff;text-decoration:none;',
      '         padding:12px 16px;border-radius:10px;font-weight:800;font-size:14px;">',
      '        {CTA_TEXT}',
      '      </a>',
      '    </td>',
      '  </tr>',
      '</table>'
    ].join('\n');
  }

  function buildMailShell(opts, vars) {
    opts = opts || {};
    vars = vars || {};

    const title = opts.title || '';
    const bodyContent = opts.bodyContent || '';

    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function replacePlaceholders(html, map) {
      let out = String(html ?? '');
      Object.keys(map || {}).forEach((k) => {
        const v = map[k] == null ? '' : String(map[k]);
        const re = new RegExp('\\{' + k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}', 'g');
        out = out.replace(re, v);
      });
      return out;
    }

    const corpName = vars['íšŒì‚¬ëª…'] ?? vars['{íšŒì‚¬ëª…}'] ?? '';

    // âœ… í”„ë¦¬ë·°ì—ì„œ ì‚¬ìš©í•  mergedMap (HTML escape ì ìš©)
    const mergedMap = {
      'íšŒì‚¬ëª…': escapeHtml(corpName),
      'ì œì¶œê¸°í•œ': escapeHtml(vars['ì œì¶œê¸°í•œ'] ?? ''),
      'ì œì¶œë°©ë²•': escapeHtml(vars['ì œì¶œë°©ë²•'] ?? ''),
      'ë‹´ë‹¹ì': escapeHtml(vars['ë‹´ë‹¹ì'] ?? ''),
      'ì—°ë½ì²˜': escapeHtml(vars['ì—°ë½ì²˜'] ?? ''),
      'CTA_TEXT': escapeHtml(vars['CTA_TEXT'] ?? ''),
      'CTA_URL': (vars['CTA_URL'] ?? '').toString(),
    };

    // âœ… bodyContent ë‚´ë¶€ placeholder ì¹˜í™˜
    const mergedBody = replacePlaceholders(bodyContent, {
      ...mergedMap,
      'CTA_URL': (vars['CTA_URL'] ?? '').toString(),
      'CTA_TEXT': (vars['CTA_TEXT'] ?? '').toString(),
    });

    const headerLeft = corpName ? `${escapeHtml(corpName)}` : `ì„¸ë¬´ë²•ì¸ëŒ€ìŠ¹`;

    // âœ… "ì „ì²´ ëª¨ë“œ" í”„ë¦¬ë·°ì—ì„œëŠ” ë‹´ë‹¹ì/ì—°ë½ì²˜ ë°•ìŠ¤/í‘¸í„°ë¥¼ ìˆ¨ê¹€
    // (ë‹´ë‹¹ì/ì—°ë½ì²˜ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì•ˆ ë‚˜ì˜´)
    const hasContact = !!(mergedMap['ë‹´ë‹¹ì'] || mergedMap['ì—°ë½ì²˜']);

    let footerContactInfo = '';
    if (hasContact) {
      const parts = [];
      if (mergedMap['ë‹´ë‹¹ì']) parts.push(`ë‹´ë‹¹ì: <span style="color:#475569; font-weight:500;">${mergedMap['ë‹´ë‹¹ì']}</span>`);
      if (mergedMap['ì—°ë½ì²˜']) parts.push(`ì—°ë½ì²˜: <span style="color:#475569; font-weight:500;">${mergedMap['ì—°ë½ì²˜']}</span>`);
      footerContactInfo = `
        <div style="font-size:12px; color:#64748b; margin-bottom:4px;">
          ${parts.join(' &nbsp;Â·&nbsp; ')}
        </div>`;
    }

    return [
      '<!DOCTYPE html>',
      '<html lang="ko">',
      '<head>',
      '  <meta charset="UTF-8" />',
      '  <meta name="viewport" content="width=device-width, initial-scale=1.0" />',
      '  <meta http-equiv="x-ua-compatible" content="ie=edge" />',
      `  <title>${escapeHtml(title || ' ì•ˆë‚´')}</title>`,
      '  <style>',
      '    @media only screen and (max-width: 600px) {',
      '      .main-table { width: 100% !important; max-width: 680px !important; }',
      '      .header-title { font-size: 16px !important; }',
      '    }',
      '  </style>',
      '</head>',
      '<body style="margin:0; padding:0; background:#f5f7fb;">',

      '  <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="background:#f5f7fb;">',
      '    <tr>',
      '      <td align="center" style="padding:24px 12px;">',

      '        <table class="main-table" role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width:680px; width:100%; border-collapse:separate; border-spacing:0; margin:0 auto;">',

      '          <tr>',
      '            <td style="padding:0;">',
      '              <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:separate; border-spacing:0;">',
      '                <tr>',
      '                  <td style="border-radius:14px 14px 0 0; overflow:hidden;">',
      '                    <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"',
      '                           style="background:#1f6f5a; background:linear-gradient(90deg,#1f6f5a 0%, #1f6f5a 55%, #0f5c80 100%);">',
      '                      <tr>',
      '                        <td style="padding:18px 22px;">',

      '                          <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">',
      '                            <tr>',
      '                              <td align="left" valign="middle" style="padding:0;">',
      '                                <div class="header-title" style="font-family:Pretendard, Apple SD Gothic Neo, Noto Sans KR, Malgun Gothic, Arial, sans-serif;',
      '                                                  font-size:16px; line-height:1.2; font-weight:800; color:#ffffff; letter-spacing:-0.3px;">',
      `                                  ${headerLeft}`,
      '                                </div>',
      '                              </td>',

      '                              <td align="right" valign="middle" style="padding:0; white-space:nowrap;">',
      '                                <div style="font-family:Roboto, Apple SD Gothic Neo, Noto Sans KR, Malgun Gothic, Arial, sans-serif;',
      '                                                  font-size:14px; line-height:1.2; font-weight:700; color:rgba(255,255,255,0.92); letter-spacing:-0.2px;">',
      '                                  ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹',
      '                                </div>',
      '                              </td>',
      '                            </tr>',
      '                          </table>',

      '                        </td>',
      '                      </tr>',
      '                    </table>',
      '                  </td>',
      '                </tr>',
      '              </table>',
      '            </td>',
      '          </tr>',

      '          <tr>',
      '            <td style="background:#ffffff; border-radius:0 0 14px 14px; padding:22px 22px 18px 22px;',
      '                        box-shadow:0 10px 30px rgba(15, 23, 42, 0.08);">',

      (title
        ? `              <div style="font-family:Pretendard, Apple SD Gothic Neo, Noto Sans KR, Malgun Gothic, Arial, sans-serif;
                          font-size:20px; font-weight:900; color:#0f172a; letter-spacing:-0.4px; margin-bottom:10px;">
                    ${escapeHtml(title)}
                  </div>`
        : ''),

      `              ${mergedBody}`,


      '            </td>',
      '          </tr>',

      '          <tr>',
      '            <td style="padding:20px 22px 18px 22px;">',
      '              <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="border-top:1px solid #e5e7eb;">',
      '                <tr>',
      '                  <td style="padding-top:16px;">',
      '                    <div style="font-family:Apple SD Gothic Neo, Noto Sans KR, Malgun Gothic, Arial, sans-serif;',
      '                                 text-align:center; line-height:1.8;">',
      '                      <div style="font-size:15px; font-weight:700; color:#1f6f5a; margin-bottom:6px;">',
      '                        ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹',
      '                      </div>',
      // âœ… í‘¸í„° ì—°ë½ì²˜ë„ ì‹¤ì œ ê°’ ìˆì„ ë•Œë§Œ ì¶œë ¥
      (hasContact ? footerContactInfo : ''),
      '                      <div style="font-size:11px; color:#94a3b8; margin-top:6px;">',
      '                        ì—…ë¬´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë‹´ë‹¹ìëŠ” ê·€ì‚¬ì˜ ì˜¬ë°”ë¥¸ ê²½ì˜ì˜ì‚¬ê²°ì •ì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
      '                      </div>',
      '                    </div>',
      '                  </td>',
      '                </tr>',
      '              </table>',
      '            </td>',
      '          </tr>',

      '        </table>',
      '      </td>',
      '    </tr>',
      '  </table>',

      '</body>',
      '</html>',
    ].join('\n');
  }

  // âœ… ë°œì†¡ ì§ì „ ì¹˜í™˜ (placeholder í™•ì¥)
  function replaceAllPlaceholders(html, map) {
    let out = String(html || '');
    Object.keys(map || {}).forEach((k) => {
      const v = map[k] == null ? '' : String(map[k]);
      const re = new RegExp('\\{' + k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}', 'g');
      out = out.replace(re, v);
    });
    return out;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3. í…œí”Œë¦¿ ì •ì˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const today = new Date();
  const year = today.getFullYear();

  const CONTACT_PLACEHOLDERS = { ë‹´ë‹¹ì: '{ë‹´ë‹¹ì}', ì—°ë½ì²˜: '{ì—°ë½ì²˜}' };

  function currentContactVarsForPreview() {
    // âœ… ì „ì²´ ëª¨ë“œì—ì„œëŠ” í”„ë¦¬ë·°ì— ì—°ë½ì²˜ë¥¼ ì•ˆ ë³´ì—¬ì¤˜ì•¼ í•¨
    if (window.__MNGMSG_MAIL_ALL_MODE__) return { ...CONTACT_PLACEHOLDERS };
    return { ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì, ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜ };
  }

  var mailTemplates = {
    custom: {
      title: 'ì§ì ‘ ì…ë ¥',
      subject: '',
      defaults: {},
      body: function(){
        return buildMailShell({
          title: 'ì•ˆë‚´',
          bodyContent: `<div style="font-size:14px;line-height:1.75;">(ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”)</div>`
        }, currentContactVarsForPreview());
      }
    },
    yearend: {
      title: 'ì¢…ë¬´ì‹ ì•ˆë‚´',
      subject: '[ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹] '+year+'ë…„ 12ì›” 31ì¼ ì¢…ë¬´ ë° ì‹ ë…„ ì¸ì‚¬',
      defaults: { 
        ì œì¶œê¸°í•œ: '', 
        ì œì¶œë°©ë²•: '',
        CTA_TEXT: '', 
        CTA_URL: '' 
      },
      body: function(){
        // âœ… í•¨ìˆ˜ ì‹¤í–‰ ì‹œì ì˜ ìµœì‹  GLOBAL_DEFAULTS ì°¸ì¡°
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: '',
          bodyContent: `
            <!-- ìƒˆí•´ ì¸ì‚¬ í—¤ë” -->
            <div style="text-align:center; margin-top:20px; margin-bottom:32px;">
              <div style="font-size:32px; font-weight:900; color:#d32f2f; margin-bottom:12px; letter-spacing:-1px;">
                ğŸŠ ${year+1}ë…„ ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš” ğŸŠ
              </div>
              <div style="font-size:16px; font-weight:700; color:#1f6f5a; margin-top:8px;">
                ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ ì˜¬ë¦¼
              </div>
            </div>

            <!-- ì¸ì‚¬ë§ -->
            <div style="font-size:15px; color:#111; line-height:1.9; text-align:center;">
              <div style="margin-bottom:18px; font-size:16px; font-weight:700;">
                ì•ˆë…•í•˜ì„¸ìš”, <b style="color:#1f6f5a;">{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.
              </div>

              <div style="margin-bottom:16px; color:#333;">
                ìˆ¨ ê°€ì˜ê²Œ ë‹¬ë ¤ì˜¨ <b style="color:#d32f2f;">${year}ë…„ í•œ í•´</b>, ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ì˜¬í•´ íšŒê³  -->
            <div style="margin:24px 0; padding:20px; background:linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%); border-radius:12px; border-left:4px solid #d32f2f;">
              <div style="font-size:14px; color:#333; line-height:1.8; text-align:center;">
                ì˜¬í•´ëŠ” ê¸€ë¡œë²Œ ê´€ì„¸ ì´ìŠˆì™€ ë‚´ìˆ˜ ë¶€ì§„ ë“± ëŒ€ë‚´ì™¸ì ìœ¼ë¡œ ë§ì€ ë„ì „ì´ ìˆì—ˆë˜ í•´ì˜€ìŠµë‹ˆë‹¤.<br/>
                í•˜ì§€ë§Œ ìœ„ê¸° ì†ì—ì„œë„ ìƒˆë¡œìš´ ëŒíŒŒêµ¬ë¥¼ ì°¾ìœ¼ë ¤ëŠ” <b style="color:#d32f2f;">ê·€ì‚¬ì˜ ì—´ì •</b>ì´ ìˆì—ˆê¸°ì—,<br/>
                ìš°ë¦¬ëŠ” í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°ˆ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ìƒˆí•´ ì „ë§ -->
            <div style="text-align:center; margin:28px 0;">
              <div style="font-size:17px; font-weight:800; color:#c62828; margin-bottom:16px;">
                ğŸ´ ì´ì œ ë¶‰ì€ ë§ì˜ í•´, ì—­ë™ì ì¸ <span style="font-size:20px;">${year+1}ë…„</span>ì´ ìš°ë¦¬ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ì¶•ë³µ ë©”ì‹œì§€ ë°•ìŠ¤ -->
            <div style="margin:28px auto; max-width:520px; padding:24px; background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius:16px; box-shadow:0 4px 12px rgba(27,94,32,0.15);">
              <div style="font-weight:800; color:#1b5e20; font-size:16px; margin-bottom:14px; text-align:center;">
                âœ¨ ë‹¤ê°€ì˜¤ëŠ” ${year+1}ë…„ì—ëŠ” âœ¨
              </div>
              <div style="font-size:14px; color:#2e7d32; line-height:2; text-align:center;">
                ğŸ’¼ ë” ë§ì€ ê³ ê°ë“¤ì´ ë¬¸ì„ ë‘ë“œë¦¬ê³ <br/>
                ğŸ“ˆ ë§¤ì¶œì€ ë”ìš± ì‹ ì¥ë˜ë©°<br/>
                ğŸ† ì§€ê¸ˆë³´ë‹¤ í›¨ì”¬ ë” ì•ˆì •ëœ ë‚´ì¼ì„ ë§ì´í•˜ì‹œê¸¸<br/>
                <b style="font-size:15px; color:#1b5e20;">ì§„ì‹¬ìœ¼ë¡œ ë°”ëë‹ˆë‹¤.</b>
              </div>
            </div>

            <!-- ê°ì‚¬ ì¸ì‚¬ -->
            <div style="margin:28px 0; padding:20px; background:#f8f9fa; border-radius:12px; text-align:center;">
              <div style="font-size:15px; color:#444; line-height:1.9;">
                ë³€í™”ë¬´ìŒí•œ ì‹œê¸°ì—ë„ í•­ìƒ ê³ì— ìˆì–´ ì£¼ì…”ì„œ ê³ ë§™ìŠµë‹ˆë‹¤.<br/>
                ì €í¬ <b style="color:#1f6f5a;">ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹</b>ë„ ì—¬ëŸ¬ë¶„ì˜ ë“ ë“ í•œ íŒŒíŠ¸ë„ˆë¡œì„œ<br/>
                ìƒˆí•´ë¥¼ í•¨ê»˜ ì—´ê² ìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ìƒˆí•´ ì¸ì‚¬ -->
            <div style="margin:32px 0; text-align:center;">
              <div style="display:inline-block; padding:20px 40px; background:linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%); border-radius:50px; box-shadow:0 4px 16px rgba(255,193,7,0.4);">
                <div style="font-size:22px; font-weight:900; color:#f57c00; letter-spacing:2px;">
                  ğŸ‰ ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì‹­ì‹œì˜¤ ğŸ‰
                </div>
              </div>
            </div>

            <!-- êµ¬ë¶„ì„  -->
            <div style="margin:36px 0; border-top:2px dashed #e0e0e0;"></div>

            <!-- ì—…ë¬´ ë‹¨ì¶• ì•ˆë‚´ -->
            <div style="margin-top:28px; padding:18px; background:#fff8e1; border:2px solid #ffd54f; border-radius:12px;">
              <div style="font-size:14px; color:#e65100; font-weight:800; margin-bottom:10px; text-align:center;">
                ğŸ“¢ 12ì›” 31ì¼ ì—…ë¬´ ë‹¨ì¶• ì•ˆë‚´
              </div>
              <div style="font-size:13px; color:#555; line-height:1.8; text-align:center;">
                ì €í¬ ì‚¬ë¬´ì‹¤ì€ <b style="color:#d32f2f;">${year}ë…„ 12ì›” 31ì¼</b>ì—ëŠ” ì¢…ë¬´ì‹ ê´€ê³„ë¡œ<br/>
                <b>ì˜¤í›„ì—ëŠ” ì „í™” ë° ì˜¨ë¼ì¸ ì—…ë¬´ê°€ ì¤‘ë‹¨</b>ë˜ì˜¤ë‹ˆ,<br/>
                ì—°ë§ ëª»í•œ ë‚´ìš©ì€ <b style="color:#1976d2;">ì´ë©”ì¼ì´ë‚˜ ë¬¸ì</b> ë‚¨ê²¨ì£¼ì‹œë©´<br/>
                ë¹ ì§ì—†ì´ ì²˜ë¦¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
              </div>
            </div>

            <!-- ë§ˆë¬´ë¦¬ ì¸ì‚¬ -->
            <div style="margin-top:32px; text-align:center;">
              <div style="font-size:14px; color:#666; line-height:1.6;">
                í•­ìƒ ê°ì‚¬ë“œë¦¬ë©°,<br/>
                ${year+1}ë…„ì—ë„ ë³€í•¨ì—†ëŠ” ì„±ì› ë¶€íƒë“œë¦½ë‹ˆë‹¤.
              </div>
              <div style="margin-top:16px; font-size:15px; font-weight:700; color:#1f6f5a;">
                ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ ì„ì§ì› ì¼ë™
              </div>
            </div>
          `
        }, currentDefaults);
      }
    },        
    pay: {
      title: 'ì¸ê±´ë¹„ ì•ˆë‚´',
      subject: '[ê¸‰ì—¬/ì¸ê±´ë¹„] ìë£Œ ì œì¶œ ìš”ì²­ë“œë¦½ë‹ˆë‹¤',
      defaults: { ì œì¶œê¸°í•œ: 'ë§¤ì›” 7ì¼(ì˜ì—…ì¼ ê¸°ì¤€)ê¹Œì§€', CTA_TEXT: 'ê¸‰ì—¬ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/pay' },
      body: function(){
        return buildMailShell({
          title: 'ì¸ê±´ë¹„/ê¸‰ì—¬ ìë£Œ ì œì¶œ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ê¸‰ì—¬ì‹ ê³ ë¥¼ ìœ„í•´ ì•„ë˜ ìë£Œ ì œì¶œì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">ì œì¶œ í•­ëª©</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ì •ê·œì§ ê¸‰ì—¬ ë³€ë™(ì…/í‡´ì‚¬, ê¸‰ì—¬ ë³€ê²½, ìˆ˜ë‹¹/ê³µì œ)</li>
                <li>ì‚¬ì—…/ê¸°íƒ€ì†Œë“ ì§€ê¸‰ë‚´ì—­(í•´ë‹¹ ì‹œ)</li>
                <li>ì¼ìš©ì§ ì§€ê¸‰ë‚´ì—­(í•´ë‹¹ ì‹œ)</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton(true, true)}
          `
        }, currentContactVarsForPreview());
      }
    },
    younmal: {
      title: 'ì—°ë§ì •ì‚° ì•ˆë‚´',
      subject: '[ì—°ë§ì •ì‚°] ìë£Œ ì œì¶œ ë° ì¼ì • ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤',
      defaults: { ì œì¶œê¸°í•œ: '1ì›” 15ì¼(ì˜ì—…ì¼ ê¸°ì¤€)ê¹Œì§€', CTA_TEXT: 'ì—°ë§ì •ì‚° ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/younmal' },
      body: function(){
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: '2025ë…„ ê·€ì† ì—°ë§ì •ì‚° ìë£Œ ì œì¶œ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.8;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.
            </div>

            <div style="margin-top:16px;padding:16px;border-left:4px solid #1f6f5a;background:#f0f9f6;border-radius:8px;">
              <div style="font-size:14px;color:#111;line-height:1.8;">
                ì˜¤ëŠ” <b style="color:#1f6f5a;">2026ë…„ 2ì›”</b>ì€ ëª¨ë“  ê·¼ë¡œìì˜ <b>2025ë…„ ê·¼ë¡œì†Œë“ì„¸</b>ë¥¼ ì—°ë§ì •ì‚°í•˜ëŠ” ë‹¬ì…ë‹ˆë‹¤.<br/>
                ê·€ì‚¬ì— ê·¼ë¬´ì¤‘ì¸ ê·¼ë¡œìì˜ 2025ë…„ë¶„ ê·¼ë¡œì†Œë“ì„¸ë¥¼ ì •í™•íˆ ì •ì‚°í•œ í›„ ì†Œì •ê¸°í•œ ë‚´ì— ì‹ ê³  ë° ë‚©ë¶€ë¥¼ í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
              </div>
            </div>

            <div style="margin-top:16px;padding:14px;background:#fff8e1;border:1px solid #ffd54f;border-radius:8px;">
              <div style="font-size:13px;color:#e65100;font-weight:700;margin-bottom:6px;">âš ï¸ ì œì¶œ ê¸°í•œ</div>
              <div style="font-size:15px;color:#111;font-weight:800;">
                <span style="color:#d32f2f;">2025ë…„ 2ì›” 10ì¼</span>ê¹Œì§€ ë„ì°© í•„ìˆ˜
              </div>
              <div style="font-size:12px;color:#666;margin-top:4px;">
                ê¸°í•œ ë‚´ ì„œë¥˜ ë¯¸ë„ì°© ì‹œ ë¶ˆì´ìµì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆ ì ê·¹ í˜‘ì¡° ë¶€íƒë“œë¦½ë‹ˆë‹¤.
              </div>
            </div>

            <div style="margin-top:16px;padding:14px;background:#e3f2fd;border:1px solid #90caf9;border-radius:8px;">
              <div style="font-size:13px;color:#1565c0;font-weight:700;margin-bottom:6px;">ğŸ’¡ êµ­ì„¸ì²­ ê°„ì†Œí™” ìë£Œ ì¼ê´„ì œê³µ ì„œë¹„ìŠ¤</div>
              <div style="font-size:13px;color:#111;line-height:1.7;">
                êµ­ì„¸ì²­ì€ ê·¼ë¡œìì˜ ê°„ì†Œí™”ìë£Œ ì œê³µ ë™ì˜ë§Œìœ¼ë¡œ íšŒì‚¬ì— ì§ì ‘ ì¼ê´„ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì‹œí–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/>
                ìë£Œì œê³µì´ ì–´ë ¤ìš´ ê·¼ë¡œìê°€ ìˆëŠ” ê²½ìš° ë‹¹ì‚¬ë¡œ ë¬¸ì˜ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
              </div>
            </div>

            <div style="margin-top:20px;border-top:2px solid #e0e0e0;padding-top:16px;">
              <div style="font-size:16px;font-weight:900;color:#1f6f5a;margin-bottom:12px;text-align:center;">
                â€” ì œì¶œ ì„œë¥˜ ì•ˆë‚´ â€”
              </div>

              <div style="margin-top:16px;">
                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">1ï¸âƒ£ ì—°ë§ì •ì‚° ê°„ì†Œí™” PDFíŒŒì¼</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ êµ­ì„¸ì²­ í™ˆíƒìŠ¤(<a href="https://www.hometax.go.kr" style="color:#1565c0;">https://www.hometax.go.kr</a>)<br/>
                    â€¢ [ì¥ë ¤ê¸ˆâ€¢ì—°ë§ì •ì‚°â€¢ê¸°ë¶€ê¸ˆ] â†’ [ì—°ë§ì •ì‚°ê°„ì†Œí™”] â†’ [ì†Œë“ì„¸ì•¡ê³µì œ ìë£Œ ì¡°íšŒ]<br/>
                    â€¢ [í•œë²ˆì— ì¡°íšŒ : ë‚´ë ¤ë°›ê¸°] â†’ [PDFë¡œ ë‚´ë ¤ë°›ê¸°]<br/>
                    â€¢ <span style="color:#d32f2f;font-weight:600;">â€» ê·¼ë¡œì†Œë“ì´ ì—†ëŠ” ê¸°ê°„ì˜ ê³µì œìë£ŒëŠ” ì œì™¸</span>
                  </div>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">2ï¸âƒ£ ì „ê·¼ë¬´ì§€ ê·¼ë¡œì†Œë“ì›ì²œì§•ìˆ˜ ì˜ìˆ˜ì¦</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ 2025ë…„ë„ì— ë‹¹í•´ íšŒì‚¬ ì™¸ íƒ€ íšŒì‚¬ì˜ ê·¼ë¡œì†Œë“ì´ ìˆëŠ” ê²½ìš° ì œì¶œ
                  </div>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">3ï¸âƒ£ ë¶€ì–‘ê°€ì¡± ê´€ë ¨ ì„œë¥˜</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ ì£¼ë¯¼ë“±ë¡ë“±ë³¸ ë° ë¶€ì–‘ê°€ì¡±ëª…ì„¸ì„œ<br/>
                    â€¢ <span style="color:#d32f2f;font-weight:600;">ê³µì œëŒ€ìƒìì˜ ì—°ê°„ ì†Œë“ê¸ˆì•¡ í•©ê³„ 100ë§Œì› ì´í•˜ìë§Œ ê³µì œ ê°€ëŠ¥</span>
                  </div>
                  <table style="width:100%;margin-top:8px;margin-left:20px;border-collapse:collapse;font-size:12px;max-width:500px;">
                    <thead>
                      <tr style="background:#e0e0e0;">
                        <th style="border:1px solid #bbb;padding:6px;text-align:center;font-weight:700;">ì´ë¦„</th>
                        <th style="border:1px solid #bbb;padding:6px;text-align:center;font-weight:700;">ì£¼ë¯¼ë²ˆí˜¸</th>
                        <th style="border:1px solid #bbb;padding:6px;text-align:center;font-weight:700;">ì—°ê°„ ì†Œë“ê¸ˆì•¡</th>
                        <th style="border:1px solid #bbb;padding:6px;text-align:center;font-weight:700;">ê´€ê³„</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="border:1px solid #ddd;padding:8px;background:#fff;">&nbsp;</td>
                        <td style="border:1px solid #ddd;padding:8px;background:#fff;">&nbsp;</td>
                        <td style="border:1px solid #ddd;padding:8px;background:#fff;">&nbsp;</td>
                        <td style="border:1px solid #ddd;padding:8px;background:#fff;">&nbsp;</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">4ï¸âƒ£ ì˜ë£Œë¹„ ì˜ìˆ˜ì¦ (êµ­ì„¸ì²­ ì¡°íšŒë¶„ ì™¸)</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ ì•ˆê²½ ë˜ëŠ” ì½˜íƒíŠ¸ë Œì¦ˆ êµ¬ì…ì˜ìˆ˜ì¦<br/>
                    â€¢ ë³´ì²­ê¸° ë˜ëŠ” ì¥ì• ì¸ë³´ì¥êµ¬ êµ¬ì…ì˜ìˆ˜ì¦<br/>
                    â€¢ ì²˜ë°©ì „ê³¼ ì˜ë£Œê¸°ê¸°ëª…ì´ ê¸°ì¬ëœ ì˜ë£Œë¹„ ì˜ìˆ˜ì¦
                  </div>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">5ï¸âƒ£ êµìœ¡ë¹„ ë‚©ì…ì¦ëª…ì„œ (êµ­ì„¸ì²­ ì¡°íšŒë¶„ ì™¸)</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ êµ­ì™¸ êµìœ¡ë¹„: êµìœ¡ë¹„ ì˜ìˆ˜ì¦, ì¬í•™ì¦ëª…ì„œ, ì…í•™í—ˆê°€ì„œ<br/>
                    â€¢ ìë…€ êµ­ì™¸êµìœ¡ë¹„ ê³µì œì‹œ íŠ¹ë¡€ì ìš© ëŒ€ìƒì ì…ì¦ì„œë¥˜<br/>
                    â€¢ í•™ì›ìˆ˜ê°•ë£Œ ë° ê¸‰ì‹ë¹„ ë‚©ì…ì¦ëª…ì„œ (ì´ˆë“±í•™êµ ì·¨í•™ ì „ ì•„ë™)<br/>
                    â€¢ ë°©ê³¼í›„ í•™êµ ìˆ˜ì—…ìš© ë„ì„œ êµ¬ì… ì¦ëª…ì„œ (ì´ˆì¤‘ê³ )
                  </div>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">6ï¸âƒ£ ê¸°ë¶€ê¸ˆ ì˜ìˆ˜ì¦</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ ë³¸ì¸ ë° ê¸°ë³¸ê³µì œ ë¶€ì–‘ê°€ì¡±(ë‚˜ì´ì œí•œ ì—†ìŒ) ëª…ì˜<br/>
                    â€¢ ì¢…êµë‹¨ì²´ê¸°ë¶€, ë¶ˆìš°ì´ì›ƒë•ê¸°ì„±ê¸ˆ, ì—°êµ¬ë¹„ê¸°ë¶€ ë“±
                  </div>
                </div>

                <div style="background:#fafbfc;padding:12px;border-radius:8px;border-left:3px solid #1f6f5a;">
                  <div style="font-weight:800;color:#1f6f5a;margin-bottom:6px;">7ï¸âƒ£ ì›”ì„¸ì•¡ ì„¸ì•¡ê³µì œ</div>
                  <div style="font-size:13px;color:#555;line-height:1.7;margin-left:20px;">
                    â€¢ ë¬´ì£¼íƒ(85ã¡ ì´í•˜) ì„¸ëŒ€ì£¼ì¸ ê²½ìš°<br/>
                    â€¢ ì„ëŒ€ì°¨ê³„ì•½ì¦ì„œ ë° ì£¼ë¯¼ë“±ë¡ë“±ë³¸<br/>
                    â€¢ ê³„ì¢Œì´ì²´ ì˜ìˆ˜ì¦, ë¬´í†µì¥ì…ê¸ˆì¦, í˜„ê¸ˆì˜ìˆ˜ì¦ ë“±<br/>
                    &nbsp;&nbsp;(ì›”ì„¸ì•¡ ì§€ê¸‰ ì¦ëª… ì„œë¥˜)
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:20px;padding:14px;background:#f5f5f5;border-radius:8px;text-align:center;">
              <div style="font-size:13px;color:#666;line-height:1.6;">
                ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.<br/>
                ê°ì‚¬í•©ë‹ˆë‹¤.
              </div>
            </div>
          `
        }, currentDefaults);
      }
    },
    ilyoung: {
      title: 'ì¼ìš©ì§ ì•ˆë‚´',
      subject: '[ì¼ìš©ì§] ì§€ê¸‰ë‚´ì—­ ì œì¶œ ìš”ì²­ë“œë¦½ë‹ˆë‹¤',
      defaults: { ì œì¶œê¸°í•œ: 'ë§¤ì›” 5ì¼(ì˜ì—…ì¼ ê¸°ì¤€)ê¹Œì§€', CTA_TEXT: 'ì¼ìš©ì§ ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/ilyoung' },
      body: function(){
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: 'ì¼ìš©ì§ ì§€ê¸‰ë‚´ì—­ ì œì¶œ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ì¼ìš©ì§ ì‹ ê³ ë¥¼ ìœ„í•´ ì§€ê¸‰ë‚´ì—­ì„ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">ì œì¶œ í•­ëª©</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ì„±ëª…/ì£¼ë¯¼ë²ˆí˜¸(ë˜ëŠ” ìƒë…„ì›”ì¼)/ê·¼ë¬´ì¼ìˆ˜</li>
                <li>ì§€ê¸‰ì•¡/ê³µì œì•¡/ì‹¤ì§€ê¸‰ì•¡</li>
                <li>ê³„ì¢Œì´ì²´ ë‚´ì—­(í•´ë‹¹ ì‹œ)</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton()}
          `
        }, currentDefaults);
      }
    },
    vat: {
      title: 'ë¶€ê°€ì„¸(ê³¼ì„¸) ì•ˆë‚´',
      subject: '[ë¶€ê°€ì„¸] ì‹ ê³ /ë‚©ë¶€ ê¸°ê°„ ì•ˆë‚´ ë° ìë£Œ ìš”ì²­',
      defaults: { ì œì¶œê¸°í•œ: 'ì‹ ê³ ê¸°í•œ 7ì¼ ì „ê¹Œì§€', CTA_TEXT: 'ë¶€ê°€ì„¸ ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/vat' },
      body: function(){
        return buildMailShell({
          title: 'ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³  ì•ˆë‚´(ê³¼ì„¸)',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ë¶€ê°€ì„¸ ì‹ ê³  ê¸°ê°„ì…ë‹ˆë‹¤. ì•„ë˜ ìë£Œë¥¼ ê¸°í•œ ë‚´ ì „ë‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">í•„ìˆ˜ ìë£Œ</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ì„¸ê¸ˆê³„ì‚°ì„œ(ë§¤ì¶œ/ë§¤ì…) ëˆ„ë½ë¶„</li>
                <li>ì¹´ë“œ/í˜„ê¸ˆì˜ìˆ˜ì¦ ëˆ„ë½ë¶„</li>
                <li>ê¸°íƒ€ ì¦ë¹™(ì˜ì„¸ìœ¨/ê³ ì •ìì‚° ì·¨ë“ ë“±)</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton(true, true)}
          `
        }, currentContactVarsForPreview());
      }
    },
    nonvat: {
      title: 'ë©´ì„¸ ì•ˆë‚´',
      subject: '[ë©´ì„¸] ìë£Œ ì œì¶œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤',
      defaults: { ì œì¶œê¸°í•œ: 'ë§¤ì›” 10ì¼(ì˜ì—…ì¼ ê¸°ì¤€)ê¹Œì§€', CTA_TEXT: 'ë©´ì„¸ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/nonvat' },
      body: function(){
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: 'ë©´ì„¸ì‚¬ì—…ì ìë£Œ ì œì¶œ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ë©´ì„¸ ë§¤ì¶œ/ë¹„ìš© ì •ë¦¬ë¥¼ ìœ„í•´ ì•„ë˜ ìë£Œ ì œì¶œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">ì£¼ìš” ìë£Œ</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ë©´ì„¸ ë§¤ì¶œ ì •ì‚°ìë£Œ(í”Œë«í¼/ì •ì‚°ì„œ/ì…ê¸ˆë‚´ì—­)</li>
                <li>ë¹„ìš© ì¦ë¹™(ì¹´ë“œ/ê³„ì¢Œì´ì²´/í˜„ê¸ˆì˜ìˆ˜ì¦)</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton()}
          `
        }, currentDefaults);
      }
    },
    corptax: {
      title: 'ë²•ì¸ ì•ˆë‚´',
      subject: '[ë²•ì¸ì„¸] ê²°ì‚°/ì‹ ê³  ì¤€ë¹„ ìë£Œ ìš”ì²­',
      defaults: { ì œì¶œê¸°í•œ: 'ê²°ì‚°ì›” ìµì›” 10ì¼ê¹Œì§€', CTA_TEXT: 'ë²•ì¸ì„¸ ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/corptax' },
      body: function(){
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: 'ë²•ì¸ì„¸ ì‹ ê³  ì¤€ë¹„ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ë²•ì¸ì„¸ ì‹ ê³  ì¤€ë¹„ë¥¼ ìœ„í•´ ê²°ì‚° ê´€ë ¨ ìë£Œ ì œì¶œì„ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">í•„ìˆ˜ ì²´í¬</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ë§¤ì¶œ/ë§¤ì… ëˆ„ë½ ì ê²€</li>
                <li>ê°€ì§€ê¸‰ê¸ˆ/ê°€ìˆ˜ê¸ˆ ë“± ê³„ì • ì •ë¦¬</li>
                <li>ìì‚° ì·¨ë“/ì²˜ë¶„ ë° ê°ê°€ìƒê° ë‚´ì—­</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton()}
          `
        }, currentDefaults);
      }
    },
    incometax: {
      title: 'ê°œì¸ ì•ˆë‚´',
      subject: '[ì¢…í•©ì†Œë“ì„¸] ì‹ ê³  ì¤€ë¹„ ìë£Œ ìš”ì²­ë“œë¦½ë‹ˆë‹¤',
      defaults: { ì œì¶œê¸°í•œ: '5ì›” 10ì¼ê¹Œì§€(ê¶Œì¥)', CTA_TEXT: 'ì¢…ì†Œì„¸ ìë£Œ ì—…ë¡œë“œ', CTA_URL: GLOBAL_DEFAULTS.CTA_URL + '/incometax' },
      body: function(){
        var currentDefaults = {
          ë‹´ë‹¹ì: GLOBAL_DEFAULTS.ë‹´ë‹¹ì,
          ì—°ë½ì²˜: GLOBAL_DEFAULTS.ì—°ë½ì²˜
        };
        return buildMailShell({
          title: 'ì¢…í•©ì†Œë“ì„¸ ì‹ ê³  ì¤€ë¹„ ì•ˆë‚´',
          bodyContent: `
            <div style="font-size:14px;color:#111;line-height:1.75;">
              ì•ˆë…•í•˜ì„¸ìš” <b>{íšŒì‚¬ëª…}</b> ë‹´ë‹¹ ì„¸ë¬´ë²•ì¸ ëŒ€ìŠ¹ì…ë‹ˆë‹¤.<br/>
              ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ë¥¼ ìœ„í•´ ì•„ë˜ ìë£Œ ì œì¶œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            </div>

            <div style="margin-top:14px;padding:14px;border:1px solid #eef1f5;border-radius:12px;background:#fafbfc;">
              <div style="font-weight:900;color:#111;margin-bottom:6px;">í•„ìˆ˜ ìë£Œ</div>
              <ul style="margin:0;padding-left:18px;color:#111;line-height:1.7;">
                <li>ë§¤ì¶œìë£Œ(í”Œë«í¼/ì •ì‚°ì„œ/í˜„ê¸ˆë§¤ì¶œ í¬í•¨)</li>
                <li>ë¹„ìš©ì¦ë¹™(ì¹´ë“œ/ê³„ì¢Œì´ì²´/í˜„ê¸ˆì˜ìˆ˜ì¦)</li>
                <li>ì¸ê±´ë¹„/ì„ì°¨ë£Œ/ì´ìë¹„ìš© ë“± ëˆ„ë½ë¶„</li>
              </ul>
            </div>

            <div style="margin-top:14px;font-size:14px;color:#111;line-height:1.75;">
              <b>ì œì¶œê¸°í•œ</b>: {ì œì¶œê¸°í•œ}<br/>
              <b>ì œì¶œë°©ë²•</b>: {ì œì¶œë°©ë²•}
            </div>

            ${buildCTAButton()}
          `
        }, currentDefaults);
      }
    }
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4. í…œí”Œë¦¿ ì ìš© / ë©”ë‰´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var currentTemplateKey = 'custom';

  function updateAllModeHintVisibility() {
    if (typeof formPanel === 'undefined' || !formPanel) return;
    var hint = formPanel.down('#allModeHint');
    if (!hint) return;

    if (typeof hint.setHidden === 'function') {
      hint.setHidden(!window.__MNGMSG_MAIL_ALL_MODE__);
      return;
    }
    if (typeof hint.setVisible === 'function') {
      hint.setVisible(window.__MNGMSG_MAIL_ALL_MODE__);
      return;
    }
    if (typeof hint.show === 'function' && typeof hint.hide === 'function') {
      window.__MNGMSG_MAIL_ALL_MODE__ ? hint.show() : hint.hide();
    }
  }

  function applyTemplateToForm(key) {
    currentTemplateKey = key;
    var tpl = mailTemplates[key];
    if (!tpl) return;

    Ext.getCmp('mngMsgMail_subject')?.setValue(tpl.subject || '');

    var previewHtml = tpl.body();
    Ext.getCmp('mngMsgMail_body')?.setValue(previewHtml);

    if (typeof formPanel !== 'undefined' && formPanel) {
      var btn = formPanel.down('#tb_template');
      if (btn) btn.setText(tpl.title || key);

      // âœ… ì „ì²´ ëª¨ë“œ ì•ˆë‚´ ë¬¸êµ¬(ë©”ì¼ ë³¸ë¬¸ì— ë°•ì§€ ë§ê³  UIì—ë§Œ)
      updateAllModeHintVisibility();
    }

    if (store && store.getProxy()) {
      store.getProxy().setExtraParam('mailFlag', currentTemplateKey);
      store.load();
    }
  }

  var templateMenu = Ext.create('Ext.menu.Menu', {
    height: 400,
    scrollable: { x: false, y: true },
    items: Object.keys(mailTemplates).map(function(k) {
      return {
        text: mailTemplates[k].title || k,
        handler: function(){
          applyTemplateToForm(k);
        }
      };
    })
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 5. ì—…ë¡œë“œ ìƒíƒœ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var uploadFileName = "";
  var fileCount = 0;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 6. Data Store (ì¢Œì¸¡)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var store = Ext.create('Ext.data.Store', {
    fields: [
      'groupManager',
      'admin_name',
      'admin_tel_no',
      'seq_no',
      'biz_name',
      'email',
      'mail_date',
      'mail_send_result'
    ],
    proxy: {
      type: 'ajax',
      url: DATA_URL,
      reader: { type: 'json', root: 'rows', totalProperty: 'total' },
      extraParams: { flag: 'mail', ADID: ADID }
    },
    autoLoad: true
  });

  if (isAllADID(ADID) && store.group) {
    store.group('groupManager');
  }

  var sm = Ext.create('Ext.selection.CheckboxModel', {
    checkOnly: false,
    mode: 'SIMPLE'
  });

  function refreshEditorPreviewOnly(){
    if (!currentTemplateKey) return;
    var tpl = mailTemplates[currentTemplateKey] || mailTemplates.custom;
    var previewHtml = tpl.body();

    var editor = Ext.getCmp('mngMsgMail_body');
    if (editor) editor.setValue(previewHtml);

    updateAllModeHintVisibility();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 7. ê´€ë¦¬ì ì •ë³´ ê°±ì‹ : "ì „ì²´"ëŠ” í”„ë¦¬ë·°ì— ë„£ì§€ ì•ŠìŒ(í•µì‹¬)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateAdminInfo(adid) {
    const reqSeq = ++window.__adminInfoReqSeq;
    const selectedAtRequest = adid;

    // âœ… ì „ì²´ ì„ íƒ: í”„ë¦¬ë·°ì—ëŠ” ë‹´ë‹¹ì/ì—°ë½ì²˜ í‘œì‹œ ê¸ˆì§€
    if (!adid || isAllADID(adid)) {
      window.__MNGMSG_MAIL_ALL_MODE__ = true;
      GLOBAL_DEFAULTS.ë‹´ë‹¹ì = CONTACT_PLACEHOLDERS.ë‹´ë‹¹ì;
      GLOBAL_DEFAULTS.ì—°ë½ì²˜ = CONTACT_PLACEHOLDERS.ì—°ë½ì²˜;
      refreshEditorPreviewOnly();
      return;
    }

    window.__MNGMSG_MAIL_ALL_MODE__ = false;

    Ext.Ajax.request({
      url: DATA_URL,
      method: 'GET',
      params: { adminflag: 'get_admin_info', admin_id: adid },
      success: function(response) {
        if (reqSeq !== window.__adminInfoReqSeq) return;
        if (window.__MNGMSG_MAIL_SELECTED_ADID__ !== selectedAtRequest) return;

        var res = Ext.decode(response.responseText);
        GLOBAL_DEFAULTS.ë‹´ë‹¹ì = (res && res.admin_name) ? res.admin_name : "";
        GLOBAL_DEFAULTS.ì—°ë½ì²˜ = (res && res.admin_tel_no) ? res.admin_tel_no : "";

        refreshEditorPreviewOnly();
      },
      failure: function() {
        if (reqSeq !== window.__adminInfoReqSeq) return;
        if (window.__MNGMSG_MAIL_SELECTED_ADID__ !== selectedAtRequest) return;

        GLOBAL_DEFAULTS.ë‹´ë‹¹ì = "";
        GLOBAL_DEFAULTS.ì—°ë½ì²˜ = "";
        refreshEditorPreviewOnly();
      }
    });
  }

  function onItemClickHandler(item) {
    ADID = item;
    window.__MNGMSG_MAIL_SELECTED_ADID__ = ADID;

    // (ì„ íƒ) ì™¸ë¶€ í•¨ìˆ˜ ì‚¬ìš© ì¤‘ì´ë©´ ìœ ì§€
    if (typeof updateScrollMenuText === 'function') updateScrollMenuText(item);

    // âœ… store ë¨¼ì € ë¡œë“œ â†’ ê·¸ ë‹¤ìŒ adminInfo ê°±ì‹ 
    if (store && store.getProxy()) {
      store.getProxy().setExtraParam('ADID', ADID);

      if (isAllADID(ADID) && store.group) {
        store.group('groupManager');
      } else if (store.clearGrouping) {
        store.clearGrouping();
      }

      store.load({
        callback: function() {
          updateAdminInfo(item);
        }
      });
    } else {
      updateAdminInfo(item);
    }
  }

  // ì™¸ë¶€ ê³µí†µ í—¬í¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 8. ì¢Œì¸¡ ê·¸ë¦¬ë“œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sendMailAction(){ /* ì•„ë˜ì—ì„œ ì •ì˜ */ }

  var mainGrid = Ext.create('Ext.grid.Panel', {
    region: 'west',
    width: '50%',
    split: true,
    collapsible: false,
    title: 'ë°œì†¡ ëŒ€ìƒì ëª©ë¡',
    store: store,
    selModel: sm,
    columnLines: true,
    features: [{
      id: 'groupManager',
      ftype: 'groupingsummary',
      startCollapsed: false,
      groupHeaderTpl: '{name}',
      hideGroupedHeader: false,
      enableGroupingMenu: true
    }],
    columns: [
      { xtype: 'rownumberer', width: 40 },
      { dataIndex: 'groupManager', header: '<center>ê´€ë¦¬ì</center>', width: 0 },
      { text: 'íšŒì‚¬ëª…', dataIndex: 'biz_name', width: 140, style: 'text-align:center' },
      { text: 'ì´ë©”ì¼', dataIndex: 'email', flex: 1, style: 'text-align:center' },
      {
        text: 'ìƒíƒœ',
        dataIndex: 'mail_send_result',
        width: 60,
        align: 'center',
        renderer: function(v) {
          if(v === 'ì„±ê³µ') return '<span style="color:green; font-weight:bold;">V</span>';
          if(v === 'ì‹¤íŒ¨') return '<span style="color:red;">X</span>';
          return '-';
        }
      },
      { text: 'ë°œì†¡ì¼', dataIndex: 'mail_date', width: 120, align: 'center' }
    ],
    dockedItems: [{
      dock: 'top',
      xtype: 'toolbar',
      style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
      items: dockedItemsConfig.concat([
        '->',
        { text: 'ë©”ì¼ë³´ë‚´ê¸°', iconCls: 'fa fa-paper-plane', handler: function(){ sendMailAction(); } }
      ])
    }]
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 9. ìš°ì¸¡ í¼
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var formPanel = Ext.create('Ext.form.Panel', {
    region: 'center',
    title: 'ë©”ì¼ ì‘ì„± ë° ì „ì†¡',
    bodyPadding: '15px',
    layout: { type: 'vbox', align: 'stretch' },
    items: [
      {
        xtype: 'textfield',
        fieldLabel: 'ì œëª©',
        labelAlign: 'top',
        id: 'mngMsgMail_subject',
        allowBlank: false,
        emptyText: 'ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”',
        margin: '0 0 10 0'
      },
      {
        xtype: 'fieldcontainer',
        fieldLabel: 'ì²¨ë¶€íŒŒì¼',
        labelAlign: 'top',
        layout: 'hbox',
        margin: '0 0 10 0',
        items: [
          {
            xtype: 'filefield',
            buttonText: 'íŒŒì¼ ì°¾ê¸°',
            buttonOnly: true,
            listeners: {
              change: function(obj){
                var fileDom = obj.fileInputEl.dom;
                if (!fileDom.files[0]) return;

                var fd = new FormData();
                fd.append('file', fileDom.files[0]);

                Ext.getCmp('mngMsgMail_fileName').setValue('ì—…ë¡œë“œ ì¤‘...');

                fetch(UPLOAD_URL, {
                  method: 'POST',
                  headers: { 'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1] },
                  body: fd
                })
                .then(r => r.json())
                .then(json => {
                  if (!json.ok) throw new Error(json.msg);
                  uploadFileName = json.uploaded_name;
                  fileCount = 1;
                  Ext.getCmp('mngMsgMail_fileName').setValue(uploadFileName);
                  Ext.Msg.alert('ì„±ê³µ', 'íŒŒì¼ì´ ì—…ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch(err => {
                  Ext.getCmp('mngMsgMail_fileName').setValue('');
                  Ext.Msg.alert('ì‹¤íŒ¨', 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
                });
              }
            }
          },
          { xtype: 'displayfield', width: 10 },
          {
            xtype: 'textfield',
            id: 'mngMsgMail_fileName',
            readOnly: true,
            flex: 1,
            emptyText: 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ'
          }
        ]
      },
      {
        xtype: 'htmleditor',
        fieldLabel: 'ë‚´ìš©',
        labelAlign: 'top',
        id: 'mngMsgMail_body',
        flex: 1,
        minHeight: 250,
        enableColors: true,
        enableAlignments: true
      }
    ],
    dockedItems: [{
      dock: 'top',
      xtype: 'toolbar',
      style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
      items: [
        {
          text: 'í…œí”Œë¦¿ ì„ íƒ',
          itemId: 'tb_template',
          iconCls: 'fa fa-bars',
          menu: templateMenu,
          scale: 'medium',
          margin: '0 8 0 0'
        },
        {
          xtype: 'displayfield',
          itemId: 'allModeHint',
          hidden: true,
          value: '<span style="color:#64748b;">â€» ì „ì²´ ì„ íƒ ì‹œ ë°œì†¡ ì‹œì ì— <b>ì—…ì²´ë³„ ë‹´ë‹¹ì/ì—°ë½ì²˜</b>ê°€ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. (í”„ë¦¬ë·°ì—” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</span>'
        }
      ]
    }]
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 10. ë°œì†¡: ì „ì²´(ADID=ì „ì²´)ì¸ ê²½ìš° ì—…ì²´ë³„ ë‹´ë‹¹ì/ì—°ë½ì²˜ ë™ì  ë§¤í•‘
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var adminInfoCache = {};

  function getAdminInfoForManager(admin_id) {
    return new Promise(function(resolve) {
      if (!admin_id) return resolve({ ë‹´ë‹¹ì: '', ì—°ë½ì²˜: '' });

      if (adminInfoCache[admin_id]) {
        resolve(adminInfoCache[admin_id]);
        return;
      }

      Ext.Ajax.request({
        url: DATA_URL,
        method: 'GET',
        params: { adminflag: 'get_admin_info', admin_id: admin_id },
        success: function(response) {
          var res = Ext.decode(response.responseText);
          var info = {
            ë‹´ë‹¹ì: (res && res.admin_name) ? res.admin_name : "",
            ì—°ë½ì²˜: (res && res.admin_tel_no) ? res.admin_tel_no : ""
          };
          adminInfoCache[admin_id] = info;
          resolve(info);
        },
        failure: function() {
          var info = { ë‹´ë‹¹ì: "", ì—°ë½ì²˜: "" };
          adminInfoCache[admin_id] = info;
          resolve(info);
        }
      });
    });
  }

  function getVarsForSend(tpl, rec) {
    const defaults = (tpl && tpl.defaults) ? tpl.defaults : {};
    const recAdminName = rec.get('admin_name') || '';
    const recAdminTel = rec.get('admin_tel_no') || '';
    const base = {
      ...GLOBAL_DEFAULTS,
      ...defaults,
      íšŒì‚¬ëª…: rec.get('biz_name') || ''
    };
    const mergedWithRecContact = {
      ...base,
      ë‹´ë‹¹ì: recAdminName || base.ë‹´ë‹¹ì,
      ì—°ë½ì²˜: recAdminTel || base.ì—°ë½ì²˜,
    };

    // âœ… ì „ì²´ ëª¨ë“œë©´ ë ˆì½”ë“œë³„ ê´€ë¦¬ì(admin_id)ë¡œ override
    if (isAllADID(ADID)) {
      // ì„œë²„ì—ì„œ ë‹´ë‹¹ì ì •ë³´ë¥¼ ë°”ë¡œ ë‚´ë ¤ì£¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (recAdminName || recAdminTel) {
        return Promise.resolve(mergedWithRecContact);
      }

      var managerAdminId = rec.get('groupManager') || ''; // ì„œë²„ì—ì„œ admin_idë¡œ ë‚´ë ¤ì¤˜ì•¼ í•¨
      return getAdminInfoForManager(managerAdminId).then(function(info) {
        const contactName = info.ë‹´ë‹¹ì || mergedWithRecContact.ë‹´ë‹¹ì;
        const contactTel = info.ì—°ë½ì²˜ || mergedWithRecContact.ì—°ë½ì²˜;
        return {
          ...mergedWithRecContact,
          ë‹´ë‹¹ì: contactName,
          ì—°ë½ì²˜: contactTel
        };
      });
    }

    // ê°œë³„ ì§€ì • ê´€ë¦¬ì ì„ íƒì´ë©´ GLOBAL_DEFAULTS/ë ˆì½”ë“œ ì •ë³´ ê·¸ëŒ€ë¡œ í™œìš©
    return Promise.resolve(mergedWithRecContact);
  }
  sendMailAction = function() {
    var records = sm.getSelection();
    if (!records.length) {
      Ext.Msg.alert('ì•Œë¦¼', 'ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°œì†¡ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    var subject = Ext.getCmp('mngMsgMail_subject').getValue();
    var body = Ext.getCmp('mngMsgMail_body').getValue();
    if (!subject) { Ext.Msg.alert('ì•Œë¦¼', 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    Ext.MessageBox.confirm(
      'ë°œì†¡ í™•ì¸',
      'ì´ <b>' + records.length + 'ëª…</b>ì—ê²Œ ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      function(btn){ if(btn === 'yes') doSend(records, subject, body); }
    );
  };

  function doSend(records, subject, bodyHtmlFromEditor) {
    Ext.getBody().mask('ë©”ì¼ ë°œì†¡ì¤‘... (0/' + records.length + ')');

    var total = records.length;
    var completed = 0;
    var tpl = mailTemplates[currentTemplateKey] || mailTemplates.custom;

    var promises = records.map(function(rec) {
      if (!rec.get('email')) {
        completed++;
        Ext.getBody().mask('ë©”ì¼ ë°œì†¡ì¤‘... (' + completed + '/' + total + ')');
        return Promise.resolve({
          rec: rec,
          success: false,
          error: 'ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨'
        });
      }

      return getVarsForSend(tpl, rec).then(function(vars) {
        var finalSubject = replaceAllPlaceholders(subject, vars);
        var finalBody = replaceAllPlaceholders(bodyHtmlFromEditor, vars);

        return fetch(SEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1]
          },
          body: JSON.stringify({
            seq_no: rec.get('seq_no'),
            email: rec.get('email'),
            biz_name: rec.get('biz_name'),
            title: finalSubject,
            content: finalBody,
            uploaded_name: uploadFileName,
            fileCount: fileCount,
            mailFlag: currentTemplateKey
          })
        })
        .then(function(r) {
          return r
            .json()
            .catch(function() { return { ok: false, msg: 'ë©”ì¼ ë°œì†¡ ì„±ê³µ' }; })
            .then(function(json) { return { status: r.status, ok: json.ok, msg: json.msg }; });
        })
        .then(function(result) {
          completed++;
          Ext.getBody().mask('ë©”ì¼ ë°œì†¡ì¤‘... (' + completed + '/' + total + ')');
          var ok = result.ok === true && result.status >= 200 && result.status < 300;
          return { rec: rec, success: ok, error: result.msg };
        })
        .catch(function(err) {
          completed++;
          Ext.getBody().mask('ë©”ì¼ ë°œì†¡ì¤‘... (' + completed + '/' + total + ')');
          return { rec: rec, success: false, error: (err && err.message) ? err.message : String(err) };
        });
      });
    });

    Promise.all(promises).then(function(results) {
      var successCnt = 0;
      var failItems = [];

      results.forEach(function(res) {
        if (res.success) {
          successCnt++;
          res.rec.set('mail_send_result', '??');
          res.rec.set('mail_date', Ext.Date.format(new Date(), 'Y-m-d H:i'));
        } else {
          failItems.push(res);
          res.rec.set('mail_send_result', '??');
          res.rec.set('mail_date', '');
        }
        res.rec.commit();
      });

      uploadFileName = "";
      fileCount = 0;
      Ext.getCmp('mngMsgMail_fileName').setValue('');

      Ext.getBody().unmask();
      if (failItems.length) {
        var firstErr = failItems[0].error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        Ext.Msg.alert('ì‹¤íŒ¨', 'ì„±ê³µ ' + successCnt + 'ê±´, ì‹¤íŒ¨ ' + failItems.length + 'ê±´\\nì²« ì‹¤íŒ¨ ì‚¬ìœ : ' + firstErr);
      } else {
        Ext.Msg.alert('ì•Œë¦¼', 'ëª¨ë“  ë©”ì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
      }
    }).catch(function(err) {
      Ext.getBody().unmask();
      Ext.Msg.alert('ì•Œë¦¼', 'ë©”ì¼ë°œì†¡ ì‹¤íŒ¨: ' + ((err && err.message) ? err.message : String(err)));
    });
  }

  // 11. Main Layout
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var mainPanel = Ext.create('Ext.panel.Panel', {
    renderTo: renderTarget,
    layout: 'border',
    width: '100%',
    height: getGridHeight(),
    items: [mainGrid, formPanel]
  });

  Ext.EventManager.onWindowResize(function() {
    if (mainPanel && !mainPanel.isDestroyed) mainPanel.setHeight(getGridHeight());
  });

  // âœ… ì´ˆê¸° ìƒíƒœ
  window.__MNGMSG_MAIL_ALL_MODE__ = isAllADID(ADID);
  applyTemplateToForm('custom');
  updateAdminInfo(ADID);

})();
</script>
