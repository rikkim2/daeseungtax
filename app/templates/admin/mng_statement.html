{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }    
    #chartdiv { width: 100%; height: 500px; }

    /* [핵심] Bootstrap과 ExtJS 충돌 방지 */
    .ext-grid-wrapper .x-table {
        width: auto !important; 
        margin: 0 !important;
    }
    
    /* 그리드 래퍼 */
    .ext-grid-wrapper {
        width: 100%;
        /* 높이는 JS에서 설정 */
    }

    /* 버튼 스타일 */
    .sl-btn{
      border: 0; background: transparent; padding: 0; cursor: pointer; line-height: 1;
    }
    .icon-blue { color: #0d6efd; }
    .icon-green {  color: #198754;  }
    .icon-yellow {  color: #ffc107;  }
    .icon-skyblue {  color: #0dcaf0;  }
    .icon-red { color: #dc3545; }
    .icon-red:hover { color: #bb2d3b; }
    .bold-on-hover i{
      font-size: 16px;
      vertical-align: middle;
      transition: text-shadow .12s ease, transform .12s ease, color .12s ease;
    }
    .bold-on-hover:hover i{
      text-shadow: 0 0 0 currentColor, 0.02em 0 0 currentColor;
      transform: translateY(-1px) scale(1.06);
    }

    /* PDF 미리보기 영역 */
    .preview-root { position: relative; width: 210mm; margin: 16px auto; }
    .host { display: none; }
    .host.visible { display: block; }
    #reportA4Frame, #pdfFrame {
      width: 100%; min-height: 297mm; border: 0; display: block;
    }
</style>  

<div class="ext-grid-wrapper"></div>

<div class="modal fade unique-summit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div class="summitModalTitle" id="summitModalTitle"></div> <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <div class="card text-left ps-5 pt-3 pb-3">
          <div class="row">
            <div id="modal_top_desc"></div>
          </div>
        </div>
        <div class="tabs-menu4 modal-tabs-menu" id="tabsMenu"></div>
        <div class="tab-content modal-tab-content" id="tabContent"></div>
      </div>
    </div>
  </div>
</div>	

<script>
(function() {
    // 1. 그리드 변수
    var mainGrid;

    // ───────────── [1] DOM 요소 확보 ─────────────
    var renderTarget = $('.ext-grid-wrapper').filter(function() {
        return $(this).children().length === 0;
    }).last()[0];

    // 만약 못 찾으면 활성 탭 내부에서 재시도
    if (!renderTarget) {
        renderTarget = $('div.tab-pane.active .ext-grid-wrapper')
            .filter(function () { return $(this).children().length === 0; })
            .last()[0];
    }

    if (!renderTarget) {
        console.warn('렌더 타겟이 없어서 그리드를 만들지 않습니다.');
        return;
    }

    // 모달 ID 생성 및 할당
    var $wrapper = $(renderTarget).parent(); 
    var modalUniqueId = 'summitModal_' + Math.floor(Math.random() * 100000);
    var $modal = $wrapper.find('.unique-summit-modal');
    $modal.attr('id', modalUniqueId);

    // 모달 내부 요소 찾기 (jQuery)
    function findInModal(selector) { return $modal.find(selector); }

    // ───────────── [2] 높이 계산 함수 ─────────────
    function getGridHeight() {
        var height = window.innerHeight - 180;
        return height > 300 ? height : 300;
    }

    // ───────────── [3] 변수 설정 ─────────────
    var adminBizLevel = '{{ admin_biz_level }}'.trim();
    const isSuperuser = '{{ admin_grade }}' === 'SA';
    var ADID = '{{ ADID }}'.trim();        
    var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
    var flag = '{{ flag }}';
    var work_YY = '{{ request.session.workyearStat }}';
    var work_QT = '{{ request.session.work_QT }}';
    var work_MM = new Date().getMonth() + 1;

    if(!work_YY && typeof getWorkYearAndMonth === 'function'){
      work_YY = getWorkYearAndMonth('mng_stat').work_YY;
    }
    const currentYear = work_YY;
    var vatYear, selectedPeriod, selectedSheetID, selectedSheetName="";

    // ───────────── [4] 전역 함수 정의 (onclick 등에서 호출) ─────────────

    // 1. renderTopic
    window.renderTopic = function(value, p, record) {
        const data = record.data; 
        let recordKey = `record_${data.seq_no}`;
        window[recordKey] = data;  

        const headerText = p.column?.text || '';
        // 주의: window.summitModal 호출
        return Ext.String.format(
            `<div style="cursor:pointer; color:blue;" 
                onclick="window.summitModal(window['${recordKey}'], ${data.seq_no}, ${data.biz_type}, '${Ext.String.htmlEncode(data.ceo_name)}', '${Ext.String.htmlEncode(data.biz_name)}', ${work_YY}, ${work_QT}, 'Vat', '${headerText}')">
                ${Ext.String.htmlEncode(value)}
            </div>`
        );
    };
    // ───────────────────────── summitModal 본체 ─────────────────────────
    // ⛳ 섹션ID → 파일명 매핑 (파일명이 섹션코드인 규칙: 0,1,2,3,4,5,61,62,63,64,7,8,300)
    const SECTION_FILEMAP = {
      "0":   "0",
      "1":   "1",
      "2":   "2",
      "3":   "3",
      "4":   "4",
      "5":   "5",
      "61":  "6-1",
      "62":  "6-2",
      "63":  "6-3",
      "64":  "6-4",
      "7":   "7",
      "8":   "8",
      "300": "300"
    };
    window.summitModal = async function(record, seq_no, biz_type, ceo_name, biz_name, work_YY, work_QT, flag, headerText = '',initialTabId = null)  {
      try {
        //showLoading("loading...");
        //setupSummitModalLifecycle();   // 재오픈 안정화
        // 모달 닫힐 때 내용 초기화 (중복 ID 방지)
        $modal.off('hidden.bs.modal').on('hidden.bs.modal', () => {
            findInModal('.modal-tabs-menu').empty();
            findInModal('.modal-tab-content').empty();
            findInModal('.summitModalTitle').empty();
        });
        // 최신 레코드 보관
        const recordKey = `record_${seq_no}`;
        delete window[recordKey];
        window[recordKey] = record;

        // 기업진단 탭 노출 조건
        const hasDiag = Number(record?.sum_MH_Amt) > 0;
        // 헤더
        const tmpHead = `
          <nav aria-label='breadcrumb'>
            <ol class='breadcrumb breadcrumb-style'>
              <li class='breadcrumb-item'>${biz_name || ''}</li>
              <li class='breadcrumb-item'>${work_YY}년 ${work_QT}분기</li>
              <li class='breadcrumb-item active'>기장보고서</li>
            </ol>
          </nav>`;
        findInModal('.summitModalTitle').html(tmpHead);

        // 탭 메뉴
        const tmpTab = `
          <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-0">분개장</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-1">재무제표</a>
            ${ hasDiag ? `<a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-2">기업진단</a>` : ``}
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-3">기장보고서</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-4">가결산</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-5">보낸 메일</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-6">보낸 카톡</a>
          </nav>`;
        findInModal('.modal-tabs-menu').html(tmpTab);
        // ───────── 탭 컨텐츠 (task-2는 있어도 되고, 숨기기만 해도 OK) ─────────
        const tmpTab_Content = `
          <!-- #0. 분개장 -->
          <div class="tab-pane fade show active task-files-tab" id="task-0" role="tabpanel">
            <div class="d-flex">
              <!-- 좌측: 연도/업로드/목록 -->
              <div class="flex-grow-1 pe-3 mt-2 ps-5" style="flex-basis: 40%; min-width:420px;">
                <!-- 작업연도 드롭다운 -->
                <div class="btn-group mb-2">
                  <button id="btn_selectedYear" type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                    ${work_YY} 년 <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" style="max-height: 320px; overflow-y: auto;">
                    <li class="dropdown-plus-title">작업연도 <b class="fa fa-angle-up" aria-hidden="true"></b></li>
                    <div id="yearList" class="list-group"></div>
                  </ul>
                </div>

                <!-- 업로드 -->
                <form id="slipUploadForm" class="p-3 mb-3">
                  <input type="hidden" name="seq_no"   value="${seq_no}">
                  <input type="hidden" name="work_yy"  value="${work_YY}">
                  <input type="hidden" name="biz_name" value="${biz_name}">
                  <div class="mb-2">
                    <label for="ud_file" class="form-label">엑셀 파일 선택 (.xlsx, .xls)</label>
                    <input id="ud_file" name="uploadFile" type="file" accept=".xlsx,.xlsm,.xls" class="form-control" required>
                    <div class="form-text">※ 파일의 연도와 작업연도가 다르면 업로드가 거절됩니다.</div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <button type="submit" id="ud_uploadBtn" class="btn btn-primary btn-sm">업로드</button>
                    <progress id="ud_progress" value="0" max="100" hidden style="height:10px;"></progress>
                    <span id="ud_status" class="small text-muted"></span>
                  </div>
                </form>

                <!-- 좌측 패널(기존) -->
                <div id="accordionLeft" class="panel-group1" role="tablist" aria-expanded="false" style="max-height: 600px; overflow-y: auto;"></div>
              </div>

              <!-- 우측: 미리보기 -->
              <div class="flex-grow-0" style="flex-basis: 60%;">
                <div class="card-body">
                  <iframe id="singoseoPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>
          </div>

          <!-- #1. 재무제표 (디자인 개선) -->
          <div class="tab-pane fade task-files-tab" id="task-1" role="tabpanel">
            <div class="d-flex gap-3">
              <!-- 좌측 콘솔 -->
              <aside class="card shadow-sm ms-4 mt-4" style="flex:0 0 280px; width:280px; min-width:280px; max-width:280px;">
                <div class="card-header bg-transparent pb-0">
                  <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">재무제표 도구</h6>
                  </div>
                </div>
                <div class="card-body">
                  <!-- 작업연도 -->
                  <div class="mb-3">
                    <label class="form-label">작업연도</label>
                    <div class="btn-group w-100">
                      <button id="btn_stmtYear" type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">${work_YY} 년</button>
                      <ul class="dropdown-menu w-100" id="stmtYearList" style="max-height: 280px; overflow-y:auto"></ul>
                    </div>
                  </div>
                  <!-- 종류 선택 -->
                  <div class="mb-3">
                    <label class="form-label">재무제표 종류</label>
                    <div class="d-grid gap-2" id="stmtKindBtns">
                      <button class="btn btn-light border text-start" data-kind="BS"><i class="fa fa-balance-scale me-2"></i>대차대조표(BS)</button>
                      <button class="btn btn-light border text-start" data-kind="PL"><i class="fa fa-chart-line me-2"></i>손익계산서(PL)</button>
                      <button class="btn btn-light border text-start" data-kind="CS"><i class="fa fa-list-ol me-2"></i>제조원가명세서(CS)</button>
                    </div>
                  </div>
                  <!-- 액션 -->
                  <div class="d-grid gap-2">
                    <button id="btn_stmtLoad" class="btn btn-primary">불러오기</button>
                    <button id="btn_stmtRefresh" class="btn btn-outline-secondary">새로고침</button>
                  </div>
                  <hr>
                  <div class="small text-muted">※ 불러오기 후 우측 미리보기와 표가 동기화됩니다.</div>
                </div>
              </aside>

              <!-- 우측 결과 -->
              <section class="me-4 mt-4" style="flex:1 1 auto; min-width:0;">
                <div class="card">
                  <div class="card-header d-flex align-items-center">
                    <h6 id="stmtTitle" class="mb-0">재무제표(준비중...)</h6>
                    <div class="ms-auto small text-muted" id="stmtPeriod"></div>
                  </div>
                  <div class="card-body p-0">
                    <div id="StatPreview" class="p-3" style="min-height:820px;">
                      <div class="text-muted">재무제표 데이터를 준비중...</div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            <div class="modal-footer justify-content-center" id="btnKakaoSend1"></div>
          </div>

          <!-- #2. 기업진단 (패널은 유지, 필요시 숨김) -->
          <div class="tab-pane fade task-files-tab" id="task-2" role="tabpanel"
              data-seq-no="{{ seq_no }}" data-work-yy="{{ work_yy }}" data-work-qt="{{ work_qt }}">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 60%;">
                <div class="card">
                  <div class="card-header d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">기업진단</h6>
                    <button type="button" id="btn-diag-refresh" class="btn btn-sm btn-outline-primary">새로고침</button>
                  </div>
                  <div class="card-body">
                    <!-- 기업진단 마운트 -->
                    <div id="diagMount"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- #3. 기장보고서 -->
          <div class="tab-pane fade task-files-tab" id="task-3" role="tabpanel">
            <div class="d-flex" style="height:100%;">
              <div class="d-flex flex-column ps-5 mt-3" style="flex:1 0 20%; max-width:20%; min-width:440px;">
                <div id="Report_Left" class="card w-100 h-100 overflow-auto"></div>
              </div>
              <div class="flex-grow-1" style="min-width:0;">
                <div class="card-body p-3">
                  <div id="Report_Right" class="preview-root">
                    <div id="sectionHost" class="host visible">
                      <iframe id="reportA4Frame" title="A4 Section" frameborder="0"></iframe>
                    </div>
                    <div id="pdfHost" class="host">
                      <iframe id="pdfFrame" title="PDF Preview" frameborder="0"></iframe>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- #4. 가결산 -->
          <div class="tab-pane fade task-files-tab" id="task-4" role="tabpanel">
            <div class="d-flex">
              <div class="flex-grow-1 ps-5 mt-5 d-flex flex-column" style="flex-basis: 20%; height: 100%;">
                <div id="tongVat_LeftTop" class="card-body bg-primary-transparent p-3" style="max-height: 700px; overflow-y: auto;"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 80%;">
                <div class="card-body">
                  <div class="container" id="TongVat_Right"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- #5. 보낸 메일 -->
          <div class="tab-pane fade task-files-tab" id="task-5" role="tabpanel">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="sentMailTable"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <iframe id="mailIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>
          </div>

          <!-- #6. 보낸 카톡 -->
          <div class="tab-pane fade task-files-tab" id="task-6" role="tabpanel">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="sentKakaoTable"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <iframe id="kakaoIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>
          </div>
        `;
        findInModal('.modal-tab-content').html(tmpTab_Content.includes('task-0') ? tmpTab_Content : '<div id="task-0" class="tab-pane active">내용 로딩 중... (HTML 복사 필요)</div>');
        // 기본 탭 활성화 (기업진단이 기본으로 잡히지 않도록 강제)
        const headerToTabId = {
          '업체명'   : 'task-0',
          '검증결과' : 'task-3',
          '통합조회' : 'task-6',
          '메일통보' : 'task-5'
        };
        let tabId = initialTabId || headerToTabId[headerText] || 'task-0';
        if (!hasDiag && tabId === 'task-2') tabId = 'task-0';

        setTimeout(() => {
            const $link = $modal.find(`a[data-bs-toggle="tab"][href="#${tabId}"]`);
            if ($link.length) {
                var tab = new bootstrap.Tab($link[0]);
                tab.show();
            }
        }, 100);

        if (typeof setReport === 'function') setReport(record, seq_no, biz_type, work_YY, work_QT);
        if (typeof sentMailList === 'function') await sentMailList(seq_no, flag, "{% url 'getSentMails' %}");
        
        // 모달 표시
        $modal.modal('show');

        // ───────── 분개장: 작업연도/업로드 핸들링 ─────────
        let selectedWorkYY = Number(work_YY);
        const $btnYear  = document.getElementById('btn_selectedYear');
        const $yearList = document.getElementById('yearList');
        const setYearLabel = (yy) => { if ($btnYear) $btnYear.innerHTML = `${yy} 년 <span class="caret"></span>`; };
        setYearLabel(selectedWorkYY);

        if ($yearList) {
          const years = Array.from({ length: 10 }, (_, i) => selectedWorkYY - i);
          $yearList.innerHTML = years.map(yy => `
            <li class="list-group-item list-group-item-action">
              <a href="#" class="year-pick" data-yy="${yy}">${yy}년</a>
            </li>
          `).join('');
          $yearList.addEventListener('click', (ev) => {
            const a = ev.target.closest('a.year-pick');
            if (!a) return;
            ev.preventDefault();
            const yy = Number(a.dataset.yy);
            if (!Number.isNaN(yy)) {
              selectedWorkYY = yy;
              setYearLabel(selectedWorkYY);
              const hidden = document.querySelector('#slipUploadForm input[name="work_yy"]');
              if (hidden) hidden.value = String(selectedWorkYY);
            }
          });
        }

        // 업로드 핸들러(모달 내 동일 화면)
        const $form = document.getElementById('slipUploadForm');
        const $file = document.getElementById('ud_file');
        const $prog = document.getElementById('ud_progress');
        const $stat = document.getElementById('ud_status');
        const $btn  = document.getElementById('ud_uploadBtn');

        function getCookie(name) {
          try {
            const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return m ? decodeURIComponent(m[2]) : null;
          } catch(e){ return null; }
        }

        function uuidv4(){
          if (window.crypto?.randomUUID) return crypto.randomUUID();
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
            const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
          });
        }

        // 진행률 폴링
        let _pollTimer = null;
        async function pollProgress(jobId){
          clearInterval(_pollTimer);
          _pollTimer = setInterval(async ()=>{
            try{
              const res = await fetch("{% url 'get_upload_progress' %}?job_id="+encodeURIComponent(jobId), {
                headers: {'X-Requested-With':'XMLHttpRequest'}
              });
              const j = await res.json();
              const pct = Number(j.pct ?? 0);
              const msg = j.msg ?? '';
              if (!$prog.hasAttribute('max')) $prog.max = 100;
              $prog.hidden = false;
              $prog.value = Math.max(0, pct);
              $stat.textContent = `${msg} ${pct >= 0 ? `(${pct}%)` : ''}`;

              if (pct >= 100) {
                clearInterval(_pollTimer);
                $stat.textContent = '완료 (100%)';
                setTimeout(()=>{ $prog.hidden = true; }, 500);
                // 완료 후 그리드/우측 미리보기 갱신 필요시 콜백
                // ex) renderStatement(...) 또는 좌측 리스트 재조회 등
              }
              if (pct < 0) {
                clearInterval(_pollTimer);
                $stat.textContent = `실패: ${msg}`;
                $prog.classList.add('bg-danger');
              }
            }catch(e){
              // 네트워크 단절 등은 잠깐 무시하고 재시도
              console.error('progress poll error', e);
            }
          }, 500);
        }

        if ($form) {
          $form.addEventListener('submit', function(ev){
            ev.preventDefault();
            if (!$file.files || !$file.files[0]){ $stat.textContent = '파일을 선택하세요.'; return; }
            const f = $file.files[0];
            if (!/\.(xlsx|xls|xlsm)$/i.test(f.name)){ $stat.textContent = '엑셀(.xlsx/.xls/.xlsm)만 허용됩니다.'; return; }

            const jobId = uuidv4();
            const fd = new FormData($form);
            fd.set('work_yy', String(selectedWorkYY || work_YY));
            fd.set('job_id', jobId);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', "{% url 'upload_slip_ledger_excel' %}", true);
            xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');
            const csrftoken = getCookie('csrftoken') || getCookie('CSRF-TOKEN');
            if (csrftoken) xhr.setRequestHeader('X-CSRFToken', csrftoken);

            // (선택) 네트워크 업로드 진행률은 약하게만 반영 (0~8%)
            xhr.upload.onprogress = function(e){
              if (e.lengthComputable){
                const pct = Math.floor((e.loaded/e.total)*8); // 0~8%
                $prog.hidden = false; $prog.value = pct;
                $stat.textContent = `파일 업로드 중... (${pct}%)`;
              }
            };

            xhr.onload = function(){
              let resp = {};
              try { resp = JSON.parse(xhr.responseText || '{}'); } catch(e){}
              if (xhr.status >= 200 && xhr.status < 300 && resp.ok){
                // 서버가 백그라운드 작업 시작했음 → 폴링 시작
                $stat.textContent = '처리 시작...';
                pollProgress(resp.job_id || jobId);
              }else{
                $prog.hidden = true;
                $stat.textContent = '업로드 실패: ' + (resp.msg || (`HTTP ${xhr.status}`));
              }
            };

            xhr.onerror = function(){
              $prog.hidden = true;
              $stat.textContent = '네트워크 오류';
            };

            // UI 초기화
            $prog.hidden = false; $prog.value = 0;
            $stat.textContent = '업로드 시작...';
            xhr.send(fd);
          });
        }
        // ───────── 기업진단 탭 바인딩 ─────────
        (function () {
          // 탭/마운트 요소
          const pane    = document.getElementById('task-2');
          const mountId = 'diagMount';

          // 파라미터: 전역값 우선, 없으면 data-*에서 가져오기
          const seq = seq_no;
          const yy  = (typeof window.work_YY  !== 'undefined' ? window.work_YY  : Number(pane.dataset.workYy)) || new Date().getFullYear();
          const qt  = (typeof window.work_QT  !== 'undefined' ? window.work_QT  : Number(pane.dataset.workQt)) || 4;

          function doRender(force=false){
            if (!force && pane.__diagRendered) return;      // 중복 방지
            const mount = document.getElementById(mountId);
            if (!mount) return;
            mount.innerHTML = "";                            // 새로 렌더
            try {
              renderDiagnosis({ doc: document, mountID: mountId, seq_no: seq, work_yy: yy, work_qt: qt });
              pane.__diagRendered = true;
            } catch (err) {
              console.error('[Diagnosis] render failed:', err);
              mount.innerHTML = '<div class="text-danger">기업진단을 표시하는 중 오류가 발생했습니다.</div>';
            }
          }

          // 탭을 처음 보여줄 때 1회 렌더링
          const trigger = document.querySelector('[data-bs-toggle="tab"][href="#task-2"], a[href="#task-2"]');
          if (trigger) {
            trigger.addEventListener('shown.bs.tab', () => doRender(), { once: true });
          }
          // 페이지 로드시 이미 활성 탭이면 즉시 렌더
          if (pane.classList.contains('active') || pane.classList.contains('show')) {
            doRender();
          }

          // 새로고침 버튼
          const btnRefresh = document.getElementById('btn-diag-refresh');
          if (btnRefresh) {
            btnRefresh.addEventListener('click', () => {
              pane.__diagRendered = false;
              doRender(true);
            });
          }
        })();
        // ───────── 재무제표 탭 바인딩 ─────────
        (function bindStatementTab(){
          const $btn = document.getElementById('btn_stmtLoad');
          const $btnRef = document.getElementById('btn_stmtRefresh');
          const $kindWrap = document.getElementById('stmtKindBtns');
          const $title = document.getElementById('stmtTitle');
          const $period = document.getElementById('stmtPeriod');
          const $StatPreview = document.getElementById('StatPreview');
          const $yyBtn = document.getElementById('btn_stmtYear');
          const $yyList = document.getElementById('stmtYearList');

          if (!$btn || !$kindWrap || !$title || !$StatPreview) return;

          // 작업연도 목록
          let stmtYear = Number(work_YY);
          if ($yyList) {
            const years = Array.from({length: 10}, (_,i)=>stmtYear - i);
            $yyList.innerHTML = years.map(yy => `<li><a class="dropdown-item stmt-year-pick" href="#" data-yy="${yy}">${yy}년</a></li>`).join('');
            $yyList.addEventListener('click', (e)=>{
              const a = e.target.closest('.stmt-year-pick');
              if (!a) return;
              e.preventDefault();
              stmtYear = Number(a.dataset.yy);
              if ($yyBtn) $yyBtn.textContent = `${stmtYear} 년`;
            });
          }

          // 선택 상태
          let stmtKind = 'BS'; // 기본 BS
          $kindWrap.addEventListener('click', (e)=>{
            const btn = e.target.closest('button[data-kind]');
            if (!btn) return;
            stmtKind = btn.dataset.kind || 'BS';
            // 버튼 active 표현
            Array.from($kindWrap.querySelectorAll('button[data-kind]')).forEach(b=>{
              b.classList.toggle('btn-primary', b === btn);
              b.classList.toggle('btn-light', b !== btn);
            });
          });

          async function loadStatement(){
            try {
              $title.textContent = `재무제표(${stmtKind}) 불러오는 중...`;
              $StatPreview.innerHTML = `<div class="p-3 text-muted">재무제표 데이터를 준비중...</div>`;
              $period.textContent = '';

              renderStatement({
                doc: document,
                mountId: 'StatPreview',
                seq_no: seq_no,
                work_yy: stmtYear,
                ki: work_QT,
                flag2: stmtKind
              });

              $title.textContent = `재무제표 - ${stmtKind}`;
            } catch(err){
              console.error(err);
              $title.textContent = `재무제표 - ${stmtKind}`;
              $StatPreview.innerHTML = `<div class="p-3 text-danger">불러오기 실패: ${err.message}</div>`;
            }
          }

          $btn.addEventListener('click', loadStatement);
          $btnRef?.addEventListener('click', loadStatement);

          // 탭 진입 시 자동 최초 로드
          document.addEventListener('shown.bs.tab', (e) => {
            const href = e.target.getAttribute('href');
            if (href === '#task-1') {
              if (!$StatPreview.__loadedOnce) {
                $StatPreview.__loadedOnce = true;
                loadStatement();
              }
            }
          });
        })();

      } catch (err) {
        console.error('summitModal error:', err);
      } finally {
        hideLoading();
      }
    };
    // 하단 카톡&메일 보내기
    window.sendMailAndKakao = async function(ADID, seq_no, ceo_name, biz_name, work_YY, work_QT, mail_class)  {
      let kskk = "";
      switch (work_QT) {
        case 1:
        kskk = "1기예정";
          break;
        case 2:
        kskk = "1기확정";
          break;
        case 3:
        kskk = "2기예정";
          break;
        case 4:
        kskk = "2기확정";
          break;
        default:
        kskk = "기수미정";
          break;
      }  
      const objectUrl = "{% url 'sendMail' %}";
      const objectUrl_kakao = "{% url 'send_kakao_notification' %}";
      srcpath = biz_name
      if (ADID=="화물") {
        srcpath = `화물연대/${ceo_name}`
      }  
      const user_path = `static/cert_DS/${srcpath}/${work_YY}/부가세/${kskk}`;
      var user_file_names = []
      var targetUrl = '';
      // 기본은 발송; 파일 존재시 여부 체크해서 없으면 false
      let allIsGood = true;

      if(mail_class=="VatIntro"){
        targetUrl = 'admin/mail/vat_intro.html';
        checkfileName = "300.pdf";
        let filePath = `${user_path}/${checkfileName}`;
        let exists = await fileExists(filePath);
        if (!exists) {
          allIsGood = false;
          alert(`파일이 존재하지 않습니다: ${filePath}`);
        } else {
          user_file_names.push(checkfileName)
        }   
      } else if(mail_class=="VatResult"){
        targetUrl = 'admin/mail/vat_result.html';   
        const response = await fetch("{% url 'isVatNapbu' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ seq_no: seq_no, work_YY: work_YY, work_QT: work_QT })
        });
        const result = await response.json();
        if (result.result) {
          
          checkfileName = "200.pdf";
          let filePath = `${user_path}/${checkfileName}`;
          let exists = await fileExists(filePath);
          if (!exists) {
            allIsGood = false;
            alert(`파일이 존재하지 않습니다: ${filePath}`);
          } else {
            user_file_names.push(checkfileName)
          } 
        } else {
          //첨부파일 넣을 필요가 없다
          allIsGood = true;
        }
        
      }
      // 기본은 발송; 파일 존재시 여부 체크해서 없으면 false
      // 부가세 수수료는 일단 카톡만 보내기로 한다
      if (allIsGood) {
        if(mail_class!="VatFee"){
          sendMail(seq_no, work_YY, work_QT*3, mail_class, objectUrl, targetUrl,user_file_names, user_path);
        }
        sendKakao(seq_no, work_YY, work_QT*3, mail_class, objectUrl_kakao);
      } else {
        alert("메일과 카카오톡 전송이 중단되었습니다. 발송요건을 충족하지 못했습니다.");
      }
    };

    var store = Ext.create('Ext.data.Store', {
        storeId: 'statStore_' + Math.random(),
        autoLoad: true, // Store가 생성되면 자동으로 데이터를 로드
        proxy: {
            type: 'ajax', // Ajax를 통해 서버와 통신
            url: '{% url "mng_statement" %}', // 데이터를 가져올 API URL
            extraParams: {
                ADID:ADID,
                work_YY:work_YY,
                work_QT:work_QT,
                flag:flag
            },        
            reader: {
                type: 'json', // 서버에서 JSON 형식으로 데이터를 반환
                rootProperty: 'data', // 응답 JSON에서 데이터 배열의 속성 이름
                totalProperty: 'total', // 응답 JSON에서 전체 데이터 수를 나타내는 속성 이름
            },
        },   
        fields: [ // 필드 정의 (데이터의 각 열)
            {name: 'groupManager',type: 'string'},
            {name: 'biz_type'},
            {name: 'seq_no'},
            {name: 'biz_name', type: 'string'}, 
            {name: 'jaroeCount', type: 'string'}, 
            {name: 'isMail', type: 'string'}, 
            {name: 'isKakaoSend', type: 'string'}, 
            {name: 'MH_Name', type: 'string'},
            {name: 'sum_MH_Amt', type: 'number'},
            {name:'file_exists', type: 'boolean'},
            {name: 'file_date', type: 'string'}, 
            {name: 'execs_cnt', type: 'int'},          // ← 이름/타입 수정
            {name: 'stockholders_cnt', type: 'int'},   // ← 이름/타입 수정
        ],
        ... (ADID === "전체" ? { groupField: 'groupManager' } : {}) // ✅ ADID가 "전체"일 때만 groupField 추가
    });
    var comboDataStore = Ext.create('Ext.data.Store', {
        fields: ['id', 'name'],
        data: [] // 초기 데이터는 비워둠
    });
    var checkboxRender =function(value) { 
      return "<input type='checkbox'" + (value ? "checked='checked'" : "") + ">"; 
    };
    function formatDate(value){
      return value ? Ext.Date.dateFormat(value, 'y-m-d') : '';
    }
    if (isSuperuser){
            Ext.Ajax.request({
                url: '{% url "kijang_admin_combolist" %}', method: 'GET',
                success: function (response) { comboDataStore.loadData(Ext.decode(response.responseText)); }
            });
    }
    const onItemClickHandlerWithFilter = function(newADID) {
        ADID = newADID;
        var targetComponent = mainGrid ? mainGrid.body : Ext.getBody();
        var loadMask = new Ext.LoadMask({ msg: '조회중...', target: targetComponent });
        loadMask.show();
        
        Ext.Ajax.request({
            url: '{% url "mng_statement" %}',
            method: 'GET',
            params: { ADID: newADID, work_YY, work_QT },
            success: function (response) {
              try {
                const json = Ext.decode(response.responseText);
                store.loadData(json);
                // applyBizTypeFilter(store, selectedBiz);
              } catch (e) {} finally { loadMask.hide() }
            },
            failure: function () { loadMask.hide() }
        });
        updateScrollMenuText(newADID);        
    };
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandlerWithFilter);    
    Ext.tip.QuickTipManager.init();
    document.addEventListener('click', function(e){
      const btn = e.target.closest('button.sl-btn.icon-green.bold-on-hover');
      if (!btn) return;
      if (btn.title === '기업진단 데이터 등록'){
        const seq = btn.getAttribute('data-seq')
                || btn.closest('tr')?.querySelector('[data-seq]')?.getAttribute('data-seq');
        if (!seq) { alert('seq_no를 찾을 수 없습니다.'); return; }
        if (window.DiagModal && typeof DiagModal.open === 'function') {
          DiagModal.open(seq);   // ✅ 여기!
        } else {
          console.error('DiagModal이 로드되지 않았습니다.');
        }
      }
    });
    mainGrid = Ext.create('Ext.grid.Panel', {
      renderTo: renderTarget,
      title: '{{ gridTitle }}',
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      tools: [  //최상단 오른쪽 툴바       
          {
              xtype: 'textfield',
              emptyText: '검색어 입력',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // 그리드의 스토어 가져오기
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // 필터 제거
                      } else {
                          store.clearFilter(true); // 기존 필터 제거
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              return (
                                bizName.includes(searchValue) 
                              );
                          });
                      }
                  }
              }
              
          },
          {
              xtype: 'button',
              iconCls: 'icon icon-refresh',
              handler: function (btn) {
                  store.reload();
              },
              style: 'margin-right: 10px;' // 오른쪽 간격 추가
          },
      ],            
      width:'100%',
      height: getGridHeight(), // 초기 높이 설정
      scrollable: 'y', // 세로 스크롤 활성화
      store: store,
      columnLines: true,
      ... (ADID === "전체" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}), 
      columns: [
        {   xtype: 'rownumberer',width: 0,	sortable: false}, 
        {   dataIndex: 'groupManager',header: '<center>관리자</center>', hidden:true       }, 
        {   dataIndex: 'biz_type',header: '<center>유형</center>', hidden:true       }, 
        {   header: 'SEQ', dataIndex: 'seq_no',width: 50        }, 
        {   id: 'biz_name',header: '<center>업체명</center>', dataIndex: 'biz_name',flex:1,minWidth: 130,renderer: renderTopic 

        }, {   
          header: '<center>분개장 관리</center>',
			    columns: [
          {
            text: '업로드<br>(최종거래일)',
            width: 120,
            dataIndex: 'jaroeCount',
            align: 'center',
            sortable: false,
            renderer: function (v, meta, rec) {
                var btnColor = "btn-blue"; // 기본값
                
                if (v === '1900-01-01' || !v) {
                    v = "없음";
                    btnColor = "btn-danger"; // 데이터가 없을 때 (빨간색)
                } else {
                    // 날짜 문자열을 Date 객체로 변환
                    var date = new Date(v);
                    
                    // 유효한 날짜인지 확인
                    if (!isNaN(date)) {
                        // 월(month)은 0부터 시작하므로 1을 더함 (1월: 0, 12월: 11)
                        var month = date.getMonth() + 1;
                        
                        // 분기별 색상 설정
                        if (month >= 1 && month <= 3) {
                            btnColor = "btn-warning"; // 1분기 (노랑) - 'btn-warning' 사용
                        } else if (month >= 4 && month <= 6) {
                            btnColor = "btn-lime"; // 2분기 (연두) - 'btn-lime' (커스텀 클래스 필요) 또는 적절한 대체 색상
                        } else if (month >= 7 && month <= 9) {
                            btnColor = "btn-info"; // 3분기 (하늘) - 'btn-info' 사용
                        } else { // month >= 10 && month <= 12
                            btnColor = "btn-blue"; // 4분기 (btn-blue)
                        }
                    } else {
                        // 날짜 형식이 유효하지 않은 경우 대비
                        btnColor = "btn-secondary"; 
                    }
                }
                
                meta.tdStyle = 'padding:2px 0;';
                
                return '<button class="btn '+btnColor+' btn-sm" data-action="upload-slip">'+ Ext.String.htmlEncode(v) +'</button>';
            }
          },
          {  header: '<center>수정</center>',   width: 40,  
            align: 'center',
            sortable: false,
            menuDisabled: true,
            renderer: function(v, meta, rec, rowIdx){
              meta.tdStyle = 'padding:0;text-align:center;';
              return '' +
                '<button type="button" class="sl-btn icon-blue bold-on-hover edit-btn" title="사용자지정 계정과목이 있는 경우">' +
                  '<i class="fa fa-edit" aria-hidden="true"></i>' +        // FA 사용 시
                '</button>';
            } 
          },
          {  
            header: '<center>삭제</center>',
            width: 40,
            align: 'center',
            sortable: false,
            menuDisabled: true,
            renderer: function(v, meta, rec, rowIdx){
              meta.tdStyle = 'padding:0;text-align:center;';
              return ''
                + '<button type="button" class="sl-btn icon-red bold-on-hover delete-btn" title="분개장 삭제시 해당 연도는 모두 삭제됩니다.">'
                +   '<i class="fa fa-trash-o" aria-hidden="true"></i>'
                + '</button>';
            }    
          }]          
        }, {
          header: '<center>재무제표</center>',width: 140,align: 'center',
          sortable: false,
          menuDisabled: true,
          renderer: function (v, meta, rec, rowIndex) {
            meta.tdStyle = 'padding:2px 0;';
            return '<button class="btn btn-success  btn-sm" >재무제표 확인</button>';
          }     
        }, {
          header: '<center>기업진단</center>',
			    columns: [
          {  header: '<center>면허종류</center>', dataIndex:'MH_Name', align:'center', width: 140  },
          {  header: '<center>기준자본금</center>', dataIndex:'sum_MH_Amt', align:'center', width: 100 , xtype: 'numbercolumn', align:'right',format:'0,000' },
          {  header: '<center>평정<br>등록</center>',   width: 40  ,
            align: 'center',
            sortable: false,
            menuDisabled: true,
            renderer: function(v, meta, rec){
              meta.tdStyle = 'padding:0;text-align:center;';
              const seq = rec.get('seq_no');
              return `
                <button type="button"
                        class="sl-btn icon-green bold-on-hover"
                        title="기업진단 데이터 등록"
                        data-seq="${Ext.String.htmlEncode(String(seq))}">
                  <i class="fa fa-plus-square-o" aria-hidden="true"></i>
                </button>`;
            }          
          }]  
        },{
          header: '<center>기장보고서</center>',
			    columns: [
          {  header: '<center>작성<br>여부</center>',   width: 40, dataIndex:'file_exists',
            renderer: function(v, meta, rec, rowIdx){
              meta.tdStyle = 'padding:0;text-align:center;';
              if (v){
                return ''
                + '<button type="button" class="sl-btn icon-green bold-on-hover" title="기장보고서 완료">'
                +   '<i class="fa fa-thumbs-up" aria-hidden="true"></i>'
                + '</button>';
              } else {
                return ''
                + '<button type="button" class="sl-btn icon-red bold-on-hover" title="기장보고서 미완료">'
                +   '<i class="fa fa-thumbs-o-down" aria-hidden="true"></i>'
                + '</button>';                
              }

            }            
          },
          {  header: '<center>작성일</center>',   width: 100,align: 'center', dataIndex:'file_date'},
          {  header: '<center>제작</center>',  width: 80,  
            align: 'center',
            sortable: false,
            menuDisabled: true,
            renderer: function (value, metaData, record) {
                let seq_no = record.get('seq_no');
                return `<button class="btn btn-blue  btn-sm" >제작하기</button>`;
              }          
          },
          {  header: '<center>메일<br>전송</center>',  width: 40 , dataIndex: 'isMail',
            renderer: function(v, meta, rec, rowIdx){
              meta.tdStyle = 'padding:0;text-align:center;';
              if (v!=''){
                return ''
                  + '<button type="button" class="sl-btn icon-skyblue bold-on-hover" title="메일전송완료">'
                  +   '<i class="fa fa-envelope" aria-hidden="true"></i>'
                  + '</button>';
              } else {
                return ''
              }                      
            }   
          },
          {  header: '<center>카톡<br>전송</center>',  width: 40 , dataIndex: 'isKakaoSend' ,
            renderer: function(v, meta, rec, rowIdx){
              meta.tdStyle = 'padding:0;text-align:center;';
              if (v !=''){
                return ''
                  + '<button type="button" class="sl-btn icon-yellow bold-on-hover" title="카톡전송완료">'
                  +   '<i class="fa fa-comment" aria-hidden="true"></i>'
                  + '</button>';
              } else {
                return ''
              }
            }           
          },
          {  header: '<center>임원수</center>',  width: 40 , dataIndex: 'execs_cnt'} ,
          {  header: '<center>주주수</center>',  width: 40 , dataIndex: 'stockholders_cnt'} 
          ]  
        }
      ],   
      listeners: {
        cellclick: function (view, td, cellIndex, record, tr, rowIndex, e) {
          const seq_no   = record.get('seq_no');
          const biz_type = record.get('biz_type');
          const ceo_name = record.get('ceo_name');
          const biz_name = record.get('biz_name');


          // 1) 업로드 버튼(분개장 탭)
          if (e.getTarget('button[data-action="upload-slip"]')) {
            summitModal(
              record,
              seq_no,
              biz_type,
              ceo_name,
              biz_name,
              work_YY,
              work_QT,
              'UPLOAD',
              '분개장',
              'task-0'    // ✅ 분개장 탭
            );
            return;
          }

          // 현재 셀이 어느 컬럼인지
          const col = view.getHeaderCt().getHeaderAtIndex(cellIndex);

          // 2) 재무제표 확인 버튼 → 재무제표 탭
          if (e.getTarget('button.btn.btn-success')) {
            summitModal(
              record,
              seq_no,
              biz_type,
              ceo_name,
              biz_name,
              work_YY,
              work_QT,
              'STATEMENT',
              '재무제표',
              'task-1'    // ✅ 재무제표 탭
            );
            return;
          }

          // 3) 면허종류 셀 클릭 → 기업진단 탭
          if (col && col.dataIndex === 'MH_Name') {
            summitModal(
              record,
              seq_no,
              biz_type,
              ceo_name,
              biz_name,
              work_YY,
              work_QT,
              'DIAGNOSIS',
              '기업진단',
              'task-2'    // ✅ 기업진단 탭
            );
            return;
          }

          // 4) 기장보고서 "제작하기" 버튼 → 기장보고서 탭
          //    (업로드 버튼도 파란색인 경우 있으므로, data-action 이 없는 파란 버튼만 잡도록)
          if (
            e.getTarget('button.btn.btn-blue') &&
            !e.getTarget('button[data-action="upload-slip"]')
          ) {
            summitModal(
              record,
              seq_no,
              biz_type,
              ceo_name,
              biz_name,
              work_YY,
              work_QT,
              'REPORT',
              '기장보고서',
              'task-3'    // ✅ 기장보고서 탭
            );
            return;
          }

          // 5) 메일 아이콘 클릭 → 보낸 메일 탭
          if (e.getTarget('.fa-envelope')) {
            summitModal(
              record,
              seq_no,
              biz_type,
              ceo_name,
              biz_name,
              work_YY,
              work_QT,
              'MAIL',
              '보낸 메일',
              'task-5'    // ✅ 보낸 메일 탭
            );
            return;
          }

          // (추가로 필요하면 카톡 아이콘 → task-6 도 여기서 처리 가능)
          // if (e.getTarget('.fa-comment')) { ... 'task-6' ... }
        }
      },
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          items: 
          [...dockedItemsConfig,
            {
              xtype: 'buttongroup',              
              columns: 5,
              frame:false,
              defaults: {
                enableToggle: true,
                toggleGroup: 'yearGroup',
                margin: '0 5 0 0', // 버튼 간격 (오른쪽으로 5px 간격)
                style: {
                    border: '1px solid #ccc',
                    padding: '5px 6px',
                    borderRadius: '5px',
                    transition: 'all 0.2s ease' // 부드러운 전환 효과
                }
              },
              items: Array.from({ length: 5 }, (_, i) => ({
                text: `${currentYear - i}년`,
                pressed: currentYear - i === parseInt(work_YY, 10),
                handler: function () {
                  // 1. 그리드 및 스토어 확보
                  var grid = this.up('grid');
                  if (!grid) return;
                  var store = grid.getStore();
                  
                  // 2. 현재 선택된 필터 상태 저장 (법인/개인/전체)
                  var selectedBiz = getSelectedBizType(grid); 

                  // 3. 연도 업데이트
                  var selectedYear = parseInt(this.text.replace('년', ''), 10);
                  work_YY = selectedYear; // 전역 변수 업데이트

                  // 4. 스토어 파라미터 갱신 및 리로드 (Ajax 대체)
                  var proxy = store.getProxy();
                  proxy.extraParams.work_YY = work_YY;
                  proxy.extraParams.ADID = ADID; // 필요시 확인
                  proxy.extraParams.work_QT = work_QT; // 필요시 확인
                  
                  store.load({
                      callback: function(records, operation, success) {
                          if (success) {
                              applyBizTypeFilter(store, selectedBiz);// 5. 로드 완료 후 필터 재적용
                          } else {
                              console.error('데이터 로드 실패');
                          }
                      }
                  });
                }
              })),
            }   
          ]//dockeditems
        },
        {
          xtype: 'toolbar',
          items:[{
            xtype: 'radiogroup',
            itemId: 'bizTypeGroup',           // ★ 식별자
            layout: 'hbox',
            defaults: {
                name: 'bizTypeGroup',
                margin: '0 10 0 0'
            },
            value: { bizTypeGroup: 'all' }, // ✅ 기본값 '전체' 설정
            items: [
                { boxLabel: '전체', inputValue: 'all' },
                { boxLabel: '법인', inputValue: 'corp' },
                { boxLabel: '개인', inputValue: 'person' }
            ],
            style: {
                background: '#fff', // 그룹 배경색 지정
                border: '0px #fff',
            },
            listeners: {
              change: function (group, newValue, oldValue) {
                  const selected = newValue.bizTypeGroup;
                  const grid = group.up('grid');
                  if (!grid) return;                  
                  const store = grid.getStore();

                  if (selected === 'corp') {
                      store.clearFilter();
                      store.filterBy(record => {
                          const type = parseInt(record.get('biz_type'), 10);
                          return type >= 1 && type <= 3;
                      });
                  } else if (selected === 'person') {
                      store.clearFilter();
                      store.filterBy(record => {
                          const type = parseInt(record.get('biz_type'), 10);
                          return type >= 4 && type <= 6;
                      });
                  } else {
                      store.clearFilter(); // 전체
                  }
              }
            }
          },{
            xtype: 'buttongroup',
            title: null, // 제목 제거
            columns: 4, // 한 줄에 버튼 4개 (분기 기준)
            frame:false,
            border:0,
            defaults: {
                enableToggle: true,
                toggleGroup: 'quarterGroup',
                margin: '0 5 0 0', // 버튼 간격 (오른쪽 5px)
                style: {
                    border: '1px solid #ccc', // 버튼 테두리 색상
                    padding: '5px 6px', // 버튼 내부 여백
                    borderRadius: '5px' // 버튼 둥글게 처리
                }
            },
            // Array.from을 사용해 4개의 버튼 생성 ("1분기" ~ "4분기")
            items: Array.from({ length: 4 }, (_, i) => ({
                text: `${i + 1}분기`,
                // 분기 선택 변수 work_QT와 비교 (숫자로 변환)
                pressed: (i + 1) === parseInt(work_QT, 10),
                handler: function () {
                    // 1. 그리드 참조 (안전하게 this.up 사용)
                    var grid = this.up('grid');
                    if (!grid) return;

                    // 2. 선택된 분기 값 가져오기
                    var selectedQuarter = parseInt(this.text.replace('분기', ''), 10);
                    
                    // 3. 전역 변수(또는 상위 스코프 변수) 업데이트 (필요시)
                    work_QT = selectedQuarter;

                    // 4. 스토어 파라미터 갱신 및 리로드 (Ext.Ajax.request 대신 사용)
                    var store = grid.getStore();
                    var proxy = store.getProxy();
                    proxy.extraParams.work_QT = selectedQuarter;
                    
                    // (필요하다면 다른 파라미터도 함께 갱신)
                    proxy.extraParams.work_YY = work_YY;
                    proxy.extraParams.ADID = ADID;

                    store.load({
                        callback: function(records, operation, success) {
                            if (success) {
                                // 로드 성공 후 추가 로직 (예: 필터 재적용)
                                const selectedBiz = getSelectedBizType(grid); 
                                applyBizTypeFilter(store, selectedBiz);
                            } else {
                                console.error('데이터 로드 실패');
                            }
                        }
                    });
                }
            })),
            style: {
                background: '#fff', // 그룹 배경색 지정
                //border: '1px solid #ccc',
                //padding: '6px'
            }
          }]
        }      
      ],
      listeners: {
        afterrender: function(grid) {
          Ext.EventManager.onWindowResize(function() {
                if(grid && !grid.isDestroyed) {
                    grid.setHeight(getGridHeight());
                    grid.doLayout();
                }
          });
        }  
      }          
    });

    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }
    // CSRF 쿠키 헬퍼
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return null;
    }

    // ── bizTypeGroup 현재 선택값 읽기
    function getSelectedBizType(grid) {
      const rg = grid && grid.down && grid.down('#bizTypeGroup');
      return (rg && rg.getValue && rg.getValue().bizTypeGroup) || 'all';
    }

    // ── 선택값에 따른 필터 적용
    function applyBizTypeFilter(store, selected) {
      // Ext 4/5/6 호환 초기화
      if (store.getFilters && store.getFilters().removeAll) {
        store.getFilters().removeAll();
      } else if (store.clearFilter) {
        store.clearFilter();
      }

      if (selected === 'corp') {
        store.filterBy(r => {
          const t = parseInt(r.get('biz_type'), 10);
          return t >= 1 && t <= 3;
        });
      } else if (selected === 'person') {
        store.filterBy(r => {
          const t = parseInt(r.get('biz_type'), 10);
          return t >= 4 && t <= 6;
        });
      }
    }

    // 디바운스 함수 정의
    const debounce = (func, delay) => {
      let timeoutId;
      return function (...args) {
        const context = this;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(context, args), delay);
      };
    };

    /* =========================================================================
      기업진단 등록 모달 (독립형)
    ========================================================================= */
    window.addEventListener('diag:changed', function(ev){
      var d = ev.detail || {};
      var seq = d.seq_no;
      if (!seq) return;

      var grid = Ext.getCmp('mngGrid');   // ★ 실제 그리드 id로 변경
      if (!grid) return;                  // 그리드가 아직 없으면 조용히 종료

      var store = grid.getStore && grid.getStore();
      if (!store) return;

      var rec = store.findRecord('seq_no', String(seq), 0, false, true, true)
            || store.findRecord('seq_no', Number(seq), 0, false, true, true);
      if (!rec) return;

      rec.set('MH_Name', d.MH_Name || '');
      rec.set('sum_MH_Amt', Number(d.sum_MH_Amt) || 0);
      rec.commit();
    });
    (function (W, D) {
      // ===== 엔드포인트 =====
      const ENDPOINTS = {
        list   : "{% url 'diag_capital_list' %}",     // GET  ?seq_no=...
        upsert : "{% url 'diag_capital_upsert' %}",   // POST JSON {Seq_No, MH_Name, MH_Amt, MH_DcRate}
        delete : "{% url 'diag_capital_delete' %}",   // POST JSON {Seq_No, MH_Name}
        summary: "{% url 'diag_capital_summary' %}",  // GET  ?seq_no=...
      };

      // ===== 상수/유틸 =====
      const nf = new Intl.NumberFormat('ko-KR');

      const LICENSE_OPTIONS = [
        '토목공사업','건축공사업','토목건축공사업','산업환경설비공사업','조경공사업',
        '실내건축공사업','토공사업','석공사업','도장ㆍ습식ㆍ방수공사업','비계구조물해체공사업','금속구조물창호공사업',
        '지붕판금건축물조립공사업','철근콘크리트공사업','기계설비공사업','상하수도설비공사업',
        '보링그라우팅공사업','수중공사업','조경식재공사업','조경시설물설치공사업','강구조물공사업',
        '철강재설치공사업','삭도설치공사업','준설공사업','승강기설치공사업','가스시설시공업(1종)',
        '시설물유지관리업','일반소방시설공사업','철도궤도공사업','전문소방시설공사업','전기공사업',
        '정보통신공사업','포장공사업','보수단청업','조경업','식물보호업','목공사업','번와공사업',
        '숲가꾸기및병해충방제','숲길조성관리','1종나무병원','산림경영계획및산림조사'
      ];

      function computeStdCapital(license){
        switch(license){
          case '건축공사업': return 350000000;
          case '토목공사업': case '조경공사업': return 500000000;
          case '철강재설치공사업': case '준설공사업': return 700000000;
          case '토목건축공사업': case '산업환경설비공사업': return 850000000;
          case '숲길조성관리': return 300000000;
          case '철도궤도공사업': case '보수단청업': case '포장공사업':
          case '강구조물공사업': case '삭도설치공사업': case '시설물유지관리업': return 200000000;
          case '전문소방시설공사업': case '전기공사업': case '산림경영계획및산림조사':
          case '숲가꾸기및병해충방제': case '1종나무병원': case '일반소방시설공사업': return 100000000;
          case '조경업': case '식물보호업': case '목공사업': case '번와공사업': case '석공사업': return 50000000;
          default: return 150000000;
        }
      }
      const dcRateToText = v => (Number(v) === 1 ? '일반' : '50%감면');
      const dcTextToRate = t => (t === '50%감면' ? 0.5 : 1);
      const parseAmount  = v => { const n = Number(String(v??'').replace(/[^\d.-]/g,'')); return Number.isFinite(n)? n:0; };

      function getCsrfToken(){
        try {
          const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : '';
        } catch { return ''; }
      }
      async function fetchJSON(url, opts={}){
        const res = await fetch(url, opts);
        const txt = await res.text();
        let json = {};
        try { json = JSON.parse(txt||'{}'); } catch {}
        if (!res.ok) throw new Error(json.msg || `HTTP ${res.status}`);
        return json;
      }

      // ===== DOM 구성 =====
      function ensureModal(){
        if (D.getElementById('diagModal')) return;
        const html = `
        <div class="modal fade" id="diagModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h6 class="modal-title">기업진단 데이터 등록</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <button id="diagAddRowBtn" class="btn btn-primary btn-sm">
                    <i class="fa fa-plus-square-o me-1"></i>면허 종목 추가
                  </button>
                  <small class="text-muted">면허 선택 시 기준자본금 자동 세팅 · 감면 변경 시 즉시 반영</small>
                </div>
                <div class="table-responsive">
                  <table class="table align-middle table-sm" id="diagTable">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 34%;">면허종류</th>
                        <th style="width: 22%;" class="text-end">기준자본금</th>
                        <th style="width: 16%;">감면여부</th>
                        <th style="width: 12%;" class="text-center">저장</th>
                        <th style="width: 10%;" class="text-center">삭제</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                      <tr class="table-light">
                        <th class="text-end">합계</th>
                        <th class="text-end" id="diagSum">0</th>
                        <th colspan="3"></th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <span id="diagStatus" class="me-auto small text-muted"></span>
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">닫기</button>
              </div>
            </div>
          </div>
        </div>`;
        D.body.insertAdjacentHTML('beforeend', html);
      }

      // ===== 상태/렌더 =====
      const STATE = { seq_no:null, rows:[] };

      function setStatus(msg){ const s=D.getElementById('diagStatus'); if(s) s.textContent=msg||''; }
      function recomputeSum(){
        const sum = STATE.rows.reduce((t,r)=> t + (Number(r.MH_Amt)||0), 0);
        const el = D.getElementById('diagSum');
        if (el) el.textContent = nf.format(sum);
      }

      function rowTpl(r, i){
        const opts = LICENSE_OPTIONS.map(o=>`<option value="${o}" ${o===r.MH_Name?'selected':''}>${o}</option>`).join('');
        return `
          <tr data-index="${i}">
            <td>
              <select class="form-select form-select-sm diag-name">
                <option value="" ${r.MH_Name?'':'selected'} disabled>면허종류를 선택하세요</option>
                ${opts}
              </select>
            </td>
            <td class="text-end">
              <input type="text" inputmode="numeric" class="form-control form-control-sm text-end diag-amt"
                    value="${r.MH_Amt? nf.format(r.MH_Amt): ''}" placeholder="0">
            </td>
            <td>
              <select class="form-select form-select-sm diag-dc">
                <option value="일반" ${r.MH_DcRate===1?'selected':''}>일반</option>
                <option value="50%감면" ${r.MH_DcRate!==1?'selected':''}>50%감면</option>
              </select>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-outline-primary btn-sm diag-save"><i class="fa fa-save"></i></button>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-outline-danger btn-sm diag-del"><i class="fa fa-trash-o"></i></button>
            </td>
          </tr>`;
      }
      function renderTable(){
        const tb = D.querySelector('#diagTable tbody');
        if (!tb) return;
        tb.innerHTML = STATE.rows.map((r,i)=>rowTpl(r,i)).join('');
        recomputeSum();
      }

      // ===== 서버 I/O =====
      async function loadRows(seq_no){
        setStatus('불러오는 중…');
        const data = await fetchJSON(`${ENDPOINTS.list}?seq_no=${encodeURIComponent(seq_no)}`);
        // 서버는 Diag_capital 컬럼 그대로 응답한다고 가정: Seq_No, MH_Name, MH_Amt, MH_DcRate
        const rows = (data.rows || data || []);
        STATE.rows = rows.map(r=>({
          MH_Name : r.MH_Name || '',
          MH_Amt  : Number(r.MH_Amt) || 0,
          MH_DcRate: (Number(r.MH_DcRate)===1 ? 1 : 0.5)  // 1 또는 0.5
        }));
        renderTable();
        setStatus(`총 ${STATE.rows.length}건`);
      }

      async function notifyMainGridChanged(seq_no){
        try {
          const s = await fetchJSON(`${ENDPOINTS.summary}?seq_no=${encodeURIComponent(seq_no)}`);
          const detail = {
            seq_no: s.Seq_No || seq_no,
            MH_Name: s.MH_Name || '',
            sum_MH_Amt: Number(s.sum_MH_Amt)||0
          };
          // 메인 그리드(ExtJS)에게 브로드캐스트
          W.dispatchEvent(new CustomEvent('diag:changed', { detail }));
          // non-Ext 페이지일 경우를 대비해 훅 제공
          if (typeof W.onDiagSummaryUpdate === 'function') {
            W.onDiagSummaryUpdate(detail);
          }
        } catch(e){
          console.warn('[diag] summary fetch failed:', e);
        }
      }

      async function upsertRow(row){
        // 유효성
        if (!row.MH_Name){ alert('면허종류를 선택하세요.'); return; }
        const payload = {
          Seq_No   : STATE.seq_no,
          MH_Name  : row.MH_Name,
          MH_Amt   : Number(row.MH_Amt)||0,
          MH_DcRate: (row.MH_DcRate===0.5 ? 0.5 : 1)
        };
        setStatus('저장 중…');
        await fetchJSON(ENDPOINTS.upsert, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCsrfToken()},
          body: JSON.stringify(payload)
        });
        setStatus('저장 완료');

        await loadRows(STATE.seq_no);         // 테이블 재로드
        notifyMainGridChanged(STATE.seq_no);  // 메인그리드 갱신 통지
      }

      async function deleteRow(row, idx){
        const isTemp = (!row.MH_Name) && (!row.MH_Amt);
        if (isTemp){
          // 임시행은 서버 반영 없음
          STATE.rows.splice(idx,1); renderTable(); setStatus('삭제 완료(임시 행)');
          return;
        }
        if (!confirm('정말 삭제하시겠습니까?')) return;

        setStatus('삭제 중…');
        const payload = { Seq_No: STATE.seq_no, MH_Name: row.MH_Name };
        await fetchJSON(ENDPOINTS.delete, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCsrfToken()},
          body: JSON.stringify(payload)
        });
        STATE.rows.splice(idx,1);
        renderTable();
        setStatus('삭제 완료');

        notifyMainGridChanged(STATE.seq_no);  // 메인그리드 갱신 통지
      }

      // ===== 이벤트 바인딩 =====
      function bindEvents(){
        // “행 추가”
        const addBtn = D.getElementById('diagAddRowBtn');
        addBtn?.addEventListener('click', ()=>{
          STATE.rows.unshift({ MH_Name:'', MH_Amt:0, MH_DcRate:1 });
          renderTable();
          setStatus('새 행이 추가되었습니다. 면허를 선택하세요.');
        });

        // 테이블 델리게이션
        const tbody = D.querySelector('#diagTable tbody');
        if (!tbody) return;

        // select/감면 변경
        tbody.addEventListener('change', (ev)=>{
          const tr = ev.target.closest('tr[data-index]'); if (!tr) return;
          const idx = +tr.dataset.index; const row = STATE.rows[idx]; if (!row) return;

          if (ev.target.classList.contains('diag-name')){
            row.MH_Name = ev.target.value || '';
            const base = computeStdCapital(row.MH_Name);
            const rate = row.MH_DcRate===0.5 ? 0.5 : 1;
            row.MH_Amt = Math.round(base * rate);
            renderTable();
          }
          if (ev.target.classList.contains('diag-dc')){
            row.MH_DcRate = (ev.target.value === '50%감면') ? 0.5 : 1;
            const base = computeStdCapital(row.MH_Name||'');
            if (base>0){ row.MH_Amt = Math.round(base * row.MH_DcRate); renderTable(); }
          }
        });

        // 금액 직접 입력
        tbody.addEventListener('input', (ev)=>{
          if (!ev.target.classList.contains('diag-amt')) return;
          const tr = ev.target.closest('tr[data-index]'); if (!tr) return;
          const idx = +tr.dataset.index; const row = STATE.rows[idx]; if (!row) return;
          row.MH_Amt = parseAmount(ev.target.value);
          recomputeSum();
        });

        // 저장/삭제
        tbody.addEventListener('click', (ev)=>{
          const tr = ev.target.closest('tr[data-index]'); if (!tr) return;
          const idx = +tr.dataset.index; const row = STATE.rows[idx]; if (!row) return;
          if (ev.target.closest('.diag-save')) upsertRow(row);
          if (ev.target.closest('.diag-del'))  deleteRow(row, idx);
        });

        // 어디서든 data-open-diag="SEQ" 눌러 열기
        D.addEventListener('click', (ev)=>{
          const btn = ev.target.closest('[data-open-diag]');
          if (!btn) return;
          const seq = btn.getAttribute('data-open-diag');
          if (seq) DiagModal.open(seq);
        });
      }

      // ===== 공개 API =====
      const DiagModal = {
        async open(seq_no){
          ensureModal();
          STATE.seq_no = seq_no;
          await loadRows(seq_no);
          const el = D.getElementById('diagModal');
          const modal = bootstrap.Modal.getOrCreateInstance(el, { backdrop:true, keyboard:true });
          modal.show();
        },
        refresh(){ if (STATE.seq_no) loadRows(STATE.seq_no); }
      };

      // 1회 초기화
      ensureModal();
      bindEvents();
      W.DiagModal = DiagModal;

    })(window, document);

    // ───────────────────────── 공용 도우미 (중복 바인딩 방지) ─────────────────────────
    (function bindOnceTabDelegation(){
      if (window.__summitTabsBound) return;
      window.__summitTabsBound = true;

      // 클릭 델리게이션: a[data-bs-toggle="tab"] 클릭 시 항상 .show() 보장
      document.addEventListener('click', (e) => {
        const a = e.target.closest('[data-bs-toggle="tab"][href^="#"]');
        if (!a) return;
        e.preventDefault();
        bootstrap.Tab.getOrCreateInstance(a).show();
      });
    })();

    function ensureTabContainer(){
      const tc = document.getElementById('tabContent');
      if (tc && !tc.classList.contains('tab-content')) {
        tc.classList.add('tab-content');   // ← 중요!
      }
    }

    function showTabByHref(hrefSelector){
      const triggerEl = document.querySelector(`[data-bs-toggle="tab"][href="${hrefSelector}"]`);
      if (triggerEl) {
        bootstrap.Tab.getOrCreateInstance(triggerEl).show();
      }
    }

    // 모달을 닫을 때(재오픈 대비) 탭 컨테이너/iframe 등을 초기화
    function setupSummitModalLifecycle(){
      const modalEl = document.getElementById('summitModal');
      if (!modalEl || modalEl.__summitLifecycleBound) return;
      modalEl.__summitLifecycleBound = true;

      modalEl.addEventListener('hidden.bs.modal', () => {
        // 재오픈시 "준비중..." 고착 방지: 컨테이너 초기화
        const idsToClear = ['tabsMenu','tabContent','summitModalTitle'];
        idsToClear.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = '';
        });
      });
    }


    //############# 3. 기장보고서
    function setReport(record, seq_no, biz_type, work_YY, work_QT) {
      const hasDiag = Number(record?.sum_MH_Amt) > 0;
      const rec = ensureRecord(seq_no, record, work_YY, work_QT);
      const {
        work_YY: wy, endDate_text, titleColor,
        startYear, startMM, startDD, reg_date
      } = computeCoverData({ record: rec, work_YY });

      const biz_name     = rec?.biz_name || '회사명';
      const ceo_name     = rec?.ceo_name || '';
      const admin_name   = rec?.admin_name || '';
      const biz_no       = rec?.biz_no   || '';
      const rec_biz_type = Number(biz_type);          // ← 레코드 기준으로 판별
      const isCorp       = !Number.isNaN(rec_biz_type) && rec_biz_type < 4;  // 법인: 1~3
      const TXT_DutyCTA  = rec?.TXT_DutyCTA || '김기현';


      const sec7Html = isCorp ? `
        <div class="card overflow-hidden mb-2 border-1">
          <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
            <h6 class="section-title text-primary">Section 7. 주식가치평가</h6>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec7-pdf">PDF보기</button>
              <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec7-make">제작</button>
            </div>
          </div>
        </div>` : ``;

      // 기업진단 탭 노출 조건
      
      console.log(hasDiag)
      const sec8Html = (isCorp && hasDiag) ? `
        <div class="card overflow-hidden mb-2 border-1">
          <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
            <h6 class="section-title text-primary">Section 8. 기업진단</h6>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec8-pdf">PDF보기</button>
              <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec8-make">제작</button>
            </div>
          </div>
        </div>` : ``;

      const tmpReportLeft = `
      <style>
        .section-static{ padding:0.875rem 1rem; min-height:48px; }
        .section-static .section-title{ font-weight:600; color:inherit; }
        .section-static .btn.btn-sm{ line-height:1.1; padding:.25rem .6rem; }
      </style>
      <div class="card-body">
        <p class="text-muted">기장보고서는 아래와 같이 구성되었습니다.</p>
        <div class="panel-group1" id="accordion11" role="tablist">
          <div class="card overflow-hidden mb-2 border-0">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <span class="section-title text-primary">Section 0. 표지</span>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec0-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec0-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 1. 회사개요</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec1-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec1-make">제작</button>
              </div>
            </div>
            <div class="card-body p-3">
              <p>- 회사의 가본사항에 대한 정보가 맞는지 확인</p>
              <p>- 법인 주주 및 임원정보가 맞는지 확인</p>
              <p>- 연임일 경과시 업체에 등기부등본 요청하기</p>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 2. 매출</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec2-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec2-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 3. 비용 및 예상세금</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec3-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec3-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 4. 재무능력 분석</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec4-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec4-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 5. 재무비율</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec5-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec5-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 6-1. 재무상태표</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec61-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec61-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 6-2. 손익계산서</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec62-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec62-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 6-3. 제조원가명세서</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec63-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec63-make">제작</button>
              </div>
            </div>
          </div>
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">Section 6-4. 거래처원장</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec64-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec64-make">제작</button>
              </div>
            </div>
          </div>
          ${sec7Html}  <!-- 법인일 때만 노출 -->
          ${sec8Html}  <!-- 법인일 때만 노출 -->
          <div class="card overflow-hidden mb-2 border-1">
            <div class="panel-heading1 d-flex align-items-center justify-content-between section-static">
              <h6 class="section-title text-primary">300. PDF합치기</h6>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-sec300-pdf">PDF보기</button>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-sec300-make">제작</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;

      $('#Report_Left').html(tmpReportLeft);
      const leftRoot = document.getElementById('Report_Left');
      setTimeout(() => initSectionPdfButtons(leftRoot, seq_no, work_YY, work_QT), 0);

      // 제작 버튼 바인딩 (요소 존재할 때만)
      document.getElementById('btn-sec0-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "0" });
      });
      document.getElementById('btn-sec1-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "1" });
      });
      document.getElementById('btn-sec2-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "2" });
      });
      document.getElementById('btn-sec3-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "3" });
      });
      document.getElementById('btn-sec4-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "4" });
      });
      document.getElementById('btn-sec5-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "5" });
      });
      document.getElementById('btn-sec61-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "6-1" });
      });
      document.getElementById('btn-sec62-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "6-2" });
      });
      document.getElementById('btn-sec63-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "6-3" });
      });
      document.getElementById('btn-sec64-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "6-4" });
      });
      // 7, 8은 법인일 때만 요소가 있으니 안전 바인딩
      document.getElementById('btn-sec7-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "7" });
      });
      document.getElementById('btn-sec8-make')?.addEventListener('click', function(){
        renderSection({ seq_no, work_YY, work_QT, record, template: "8" });
      });

      document.getElementById('btn-sec300-make')?.addEventListener('click', async function () {
        const makeBtn = this;
        const viewBtn = document.getElementById('btn-sec300-pdf');

        // 진행표시
        const initialText = makeBtn.textContent;
        makeBtn.disabled = true;
        makeBtn.textContent = '제작 중...';
        if (viewBtn) { viewBtn.disabled = true; viewBtn.classList.add('disabled'); viewBtn.title = '제작 중…'; }

        let completed = false;

        try {
          // 1) 병합 실행 (성공 알림 억제)
          await pdfMerge(seq_no, work_YY, work_QT, '300', { silent:true });

          // 2) 파일 준비 폴링
          const url = await waitForMergeReady({ code:'300', seq_no, work_YY, work_QT, timeoutMs: 30000, intervalMs: 700 });

          // 3) 버튼 상태 갱신
          await refreshSectionPdfButton({ code:'300', seq_no, work_YY, work_QT });

          completed = true;

          // (선택) 자동 열기
          // if (url) openPdfInRenderSection(url);

        } catch (e) {
          console.error(e);
          alert('PDF 합치기 도중 오류가 발생했습니다:\n' + e.message);
        } finally {
          // ✅ 여기서 버튼 텍스트를 무조건 바꿔줌
          makeBtn.disabled = false;
          makeBtn.textContent = completed ? '제작 완료' : (initialText || '제작');

          if (viewBtn) {
            const hasUrl = !!viewBtn.dataset.pdfUrl;
            viewBtn.disabled = !hasUrl;
            viewBtn.classList.toggle('disabled', !hasUrl);
            viewBtn.title = hasUrl ? 'PDF 열기' : 'PDF 미생성';
          }
        }
      });


      // “PDF보기” 버튼 핸들러
      document.getElementById('btn-sec300-pdf').addEventListener('click', function () {
        $.ajax({
          url: "{% url 'getFinancialData_Report' %}",
          cache: false,
          dataType: "json",
          data: {
            flag: 'MERGE_STATUS',
            filename: '300',          // 선택
            seq_no: seq_no,
            work_yy: work_YY,
            work_qt: work_QT
          }
        }).done(function(json){
          if (json?.ok && json.url) {
            openPdfInRenderSection(json.url);
          } else {
            alert(json?.msg || '표시할 PDF가 없습니다.');
          }
        }).fail(function(xhr){
          alert('요청 실패: ' + (xhr?.responseText || xhr.statusText));
        });
      });
      // 오른쪽 미리보기
      const tmpReportRight = `
        <style>
          #PreviewRight { width:210mm; margin:16px auto; }
          #PreviewRight .host { display:none; }
          #PreviewRight .host.visible { display:block; }
          #sectionHost iframe, #pdfHost iframe{
            width:100%; height:297mm; display:block; border:0;
          }
          /* PDF 로딩 스피너 */
          #pdfLoading{ display:none; font-size:13px; color:#64748b; padding:8px 0; }
          #pdfHost.loading #pdfLoading{ display:block; }
        </style>
        <div id="PreviewRight">
          <!-- 섹션(생성된 A4) -->
          <div id="sectionHost" class="host visible">
            <iframe id="reportA4Frame" title="클릭하여 인쇄"></iframe>
          </div>
          <!-- PDF 뷰어 -->
          <div id="pdfHost" class="host">
            <div id="pdfLoading">PDF 불러오는 중…</div>
            <iframe id="pdfFrame" title="PDF 미리보기(클릭으로 확대/인쇄 가능)"></iframe>
          </div>
        </div>
      `;

      const $root = $('#Report_Right');
      $root.html(tmpReportRight);
      $('#PreviewRight').css({ width: '210mm', margin: '16px auto' });
      bootA4Frame();

      // 전역 토글 대상 참조(필수)
      window.__SECTION_HOST__ = document.getElementById('sectionHost');
      window.__PDF_HOST__     = document.getElementById('pdfHost');
    }

    // 숫자 3자리 콤마
    const nf = new Intl.NumberFormat('ko-KR');

    function onFrameReady(frame, cb, {timeoutMs=7000, intervalMs=40} = {}){
      const t0 = Date.now();
      (function poll(){
        const d = frame.contentDocument || frame.contentWindow?.document;
        if (d && d.readyState !== 'loading' && d.getElementById('sheetInner')) return cb(d);
        if (Date.now() - t0 > timeoutMs) { console.error('onFrameReady: timeout'); return; }
        setTimeout(poll, intervalMs);
      })();
    }

    function setA4Content(html, template, hf) {
      const frame = document.getElementById('reportA4Frame');
      return new Promise((resolve) => {
        onFrameReady(frame, (doc) => {
          ensureCommonCssInFrame(doc, template);
          doc.getElementById('sheetInner').innerHTML = html;
          doc.getElementById('reportA4')?.setAttribute('data-template', String(template));

          const isCover = String(template) === '0';
          const pageTop = isCover ? 0 : (hf?.pageTop ?? 0);
          const pageBottom = isCover ? 0 : (hf?.pageBottom ?? 12);
          const rootStyle = doc.documentElement.style;
          rootStyle.setProperty('--header-h', pageTop + 'mm');
          rootStyle.setProperty('--footer-h', pageBottom + 'mm');
          rootStyle.setProperty('--footer-safe', '2mm');
          rootStyle.setProperty('--sheet-w', isCover ? '210mm' : '204mm');
          rootStyle.setProperty('--sheet-h', isCover ? '291mm' : '297mm');
          rootStyle.setProperty('--side-pad', isCover ? '0mm' : '8mm');

          const footerEl = ensureFooter(doc);
          if (!isCover && hf?.footer) {
            footerEl.querySelector('.pf-left').innerHTML = hf.footer.left || '';
            footerEl.querySelector('.pf-center').innerHTML = hf.footer.center || '';
            footerEl.querySelector('.pf-right').innerHTML = hf.footer.right || '';
            footerEl.hidden = false;
            footerEl.style.display = 'grid';
            footerEl.style.position = 'fixed';
            footerEl.style.bottom = '0';
            footerEl.style.left = '0';
            footerEl.style.right = '0';
            footerEl.style.zIndex = '2147483647';
          } else {
            footerEl.hidden = true;
            footerEl.style.display = 'none';
            footerEl.querySelector('.pf-left').innerHTML = '';
            footerEl.querySelector('.pf-center').innerHTML = '';
            footerEl.querySelector('.pf-right').innerHTML = '';
          }

          doc.body.classList.toggle('is-cover', isCover);

          // ✅ 실제 렌더가 끝났으니 섹션 뷰로 전환 보장
          showSectionHost();      
          resolve(doc); // 꼬리말 설정 후 resolve
        });
      });
    }

    function ensureCommonCssInFrame(doc, template){
      if (doc.getElementById('a4-common-css')) return;

      const style = doc.createElement('style');
      style.id = 'a4-common-css';
      style.textContent = `
      :root{
        
        --brand:#0ea5e9; --brand-dark:#1a5a37;
        --header-h: 0mm;               /* JS에서 setProperty로 덮어씀 */
        --footer-h: 12mm;              /* JS에서 setProperty로 덮어씀 */
        --footer-safe: 0mm;
        --side-pad: 8mm;
      }

      /* A4 캔버스 */
      #reportA4.print-sheet{
        width: var(--sheet-w,210mm);
        min-height: var(--sheet-h,297mm);
        margin: 0 auto;
        background:#fff;
        box-sizing:border-box;
        padding:
          calc(var(--header-h) + var(--side-pad))
          var(--side-pad)
          calc(var(--footer-h) + var(--side-pad) + var(--footer-safe))
          var(--side-pad);
      }

      .common-page{ position:relative; width:100%; box-sizing:border-box; }

      .common-header{
        position:relative; z-index:2; height:80px; padding:0;
        display:flex; justify-content:space-between; align-items:center;
        color:#fff; background:linear-gradient(90deg,var(--brand) 0%, var(--brand-dark) 100%);
        background:linear-gradient(90deg,var(--brand) 0%, var(--brand-dark) 100%);
      }
      .common-header::after{
        content:""; position:absolute; inset:0;
        background:repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 8px, transparent 8px 16px);
        mix-blend-mode:overlay; pointer-events:none;
      }
      .common-title{ margin:0; font-size:30px; font-weight:800; padding:0 8px; }
      .common-subtitle{ margin:0; font-size:25px; font-weight:600; padding:0 8px; }

      .subsec-title{display:flex;align-items:center;gap:8px;margin:6mm 0 2mm;font-weight:800;font-size:18px;color:#1e4535}
      .subsec-title .dot{width:18px;height:18px;border-radius:50%;background:#fff;box-shadow: inset 0 0 0 5px var(--brand);}

      .chart-card{background:#fff;border:1px solid #e6ece8;border-radius:10px; box-shadow:0 2mm 6mm rgba(0,0,0,.06); padding:8px 10px}
      .chart-wrap-260{height:260px}
      .chart-wrap-250{height:250px}
      .chart-wrap-230{height:230px}
      .chart-wrap-220{height:220px}
      .chart-wrap-210{height:210px}
      .chart-wrap-200{height:200px}

      .grid-below{display:grid;grid-template-columns: 1fr 1fr;gap:8mm;margin-top:6mm}
      .metrics-card,.opinion-card{background:#fff;border:1px solid #e6ece8;border-radius:10px; box-shadow:0 2mm 6mm rgba(0,0,0,.06); overflow:hidden}
      .chart-row{
        display:grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap:12px;               /* 카드 사이 여백 */
        align-items:stretch;    /* 높이 맞춤 */
      }
      .chart-title{
        display:flex; align-items:center; gap:6px;
        padding:8px 10px 4px;
        font-weight:800; font-size:14px; color:#1e4535;
      }
      .metrics-head{display:flex;justify-content:space-between;align-items:center; padding:10px 12px;background:linear-gradient(180deg,#f7faf8,#eef4f0);border-bottom:1px solid #e6ece8;font-weight:700}
      .metrics-head .unit{font-weight:600;color:#54635a;opacity:.85;font-size:12px;text-align:right}
      .tbl-metrics{width:100%;border-collapse:collapse;font-size:13.5px}
      .tbl-metrics th,.tbl-metrics td{padding:9px 10px;border-top:1px solid #e9efea;text-align:right}
      .tbl-metrics thead th:first-child,.tbl-metrics tbody td:first-child{text-align:left;font-weight:700;color:#2d3a32}
      .tbl-metrics thead th{background:#f4f8f5}
      .tbl-metrics tbody tr:last-child td{border-bottom:1px solid #e9efea}
      .notes{padding:8px 10px 12px;color:#6a756e;font-size:12px}
      .notes-10{padding:8px 10px 12px;color:#6a756e;font-size:10px}

      .opinion-card .op-head{padding:10px 12px;font-weight:800}
      .opinion-card .op-head::before{content:"■ ";margin-right:2px}
      .opinion-card .op-body{padding:8px 12px 14px;line-height:1.65}

      .tbl-arlist { width:100%; border-collapse:collapse; }
      .tbl-arlist th, .tbl-arlist td {
        border-bottom:1px solid #e5e7eb; padding:6px 10px; font-size:12px; line-height:18px;
        text-align:center; vertical-align:middle;
      }
      .tbl-arlist thead th { background:#e9e9e9; font-weight:700; }
      .tbl-arlist .t-left { text-align:left; }
      .tbl-arlist .t-right { text-align:right; }
      .tbl-arlist .t-bold { font-weight:700; }
      .tbl-arlist .grade { color:#cc6633; }

      /* ===== 고정 헤더/푸터 ===== */
      .print-header, .print-footer{
        position:fixed; left:0; right:0;
        box-sizing:border-box;
        padding:0 var(--side-pad);
        font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
        font-size:12px; color:#333; z-index:5;
        display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
        break-before: avoid; break-after: avoid;
        page-break-before: avoid; page-break-after: avoid;
      }
      .print-header{ top:0; height:var(--header-h); border-bottom:0.2mm solid #e5e5e5; line-height:var(--header-h); }
      .print-footer{
        position: fixed; left: 0; right: 0; bottom: 0;   /* ← 고정 */
        height: var(--footer-h);
        display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
        padding: 0.4mm var(--side-pad) 0;
        font: 12px/1.2 "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color:#333;
        border-top: 0.1mm solid #e5e5e5;
        z-index: 2147483647; /* 최상단 */
      }

      .pf-right{ display:flex; align-items:center; justify-content:flex-end; }
      .pf-right .pf-logo{ height: 5.2mm; width: auto; max-width: 45mm; object-fit: contain; margin-top: -0.3mm; }
      :root{ --section-gap-top: 12mm; } /* ← 원하는 값으로  조절 */

      @media print{
        .print-break-before{ break-before: page; page-break-before: always; }
        /* 새 페이지 첫 헤더 위에 충분한 공간 확보 */
        .print-break-before + .common-header{ margin-top: var(--section-gap-top) !important; }
        .common-header{ break-inside: avoid; break-after: avoid; }
        .print-keep, .chart-card{ break-inside: avoid; page-break-inside: avoid; }
        .subsec-title{ break-after: avoid; page-break-after: avoid; }

        .print-footer {
          visibility: visible !important;
          display: grid !important;
          position: fixed !important;
          bottom: 0 !important;
          left: 0 !important;
          right: 0 !important;
        }
      }

        /* 화면 미리보기에서도 비슷하게 보이도록(조금 작게) */
      @media screen{
        .print-break-before + .common-header{ margin-top: calc(var(--section-gap-top) - 2mm); }
      }
      `;
      doc.head.appendChild(style);
    }

    //타이틀 생성 템플릿
    function buildTitleBoxHeader({ leftTitle, rightSubtitle }) {
      return `
        <div class="common-header">
          <div class="common-title">${leftTitle}</div>
          <div class="common-subtitle">${rightSubtitle}</div>
        </div>
      `;
    }
    //꼬리말
    function ensureFooter(doc) {
      let footerEl = doc.getElementById('printFooter') || doc.querySelector('.print-footer');
      if (!footerEl) {
        footerEl = doc.createElement('div');
        footerEl.id = 'printFooter';
        footerEl.className = 'print-footer';
        footerEl.hidden = true;
        footerEl.innerHTML = `
          <div class="pf-left"></div>
          <div class="pf-center"></div>
          <div class="pf-right"></div>`;
        doc.body.appendChild(footerEl);
      } else {
        // 자식 보장
        ['pf-left','pf-center','pf-right'].forEach(cls => {
          if (!footerEl.querySelector('.' + cls)) {
            const d = doc.createElement('div');
            d.className = cls;
            footerEl.appendChild(d);
          }
        });
      }
      return footerEl;
    }

    //iframe 내부
    function bootA4Frame(){
      var frame = document.getElementById('reportA4Frame');
      if (!frame) return null;

      // 1) 스크립트 태그 없이 기본 마크업만 주입
      var html = [
        '<!doctype html><html lang="ko"><head><meta charset="utf-8">',
        '<style>',
        '@page{ size:A4; margin:0 }',
        'html,body{ height:100%; margin:0; -webkit-print-color-adjust:exact; print-color-adjust:exact }',
        'body{ display:flex; justify-content:center; align-items:flex-start; background:#f5f5f7 }',
        ':root{ --header-h:0mm; --footer-h:12mm; --footer-safe:2mm; --side-pad:12mm; --sheet-w:210mm; --sheet-h:297mm }',
        '#reportA4.print-sheet{ width:var(--sheet-w); min-height:var(--sheet-h); background:#fff; box-sizing:border-box;',
        '  margin:0; padding: calc(var(--header-h) + var(--side-pad)) var(--side-pad)',
        '          calc(var(--footer-h) + var(--side-pad) + var(--footer-safe)) var(--side-pad);',
        '  box-shadow:0 0 0.8rem rgba(0,0,0,.15) }',
        '.is-cover .print-footer{ display:none !important }',
        /* ✅ 표지는 절대 패딩 없이 A4 원본 크기 */
        '#reportA4[data-template="0"].print-sheet{',
        '  width:210mm; min-height:297mm;',
        '  padding:0 !important;',
        '}',
        '@media print{',
        '  :root{ --sheet-w:210mm; --sheet-h:297mm }', /* ← 인쇄 시엔 항상 A4 원본 크기 */
        '  body{ background:#fff } #reportA4.print-sheet{ box-shadow:none; margin:0 }',    
        '  #reportA4.print-sheet{ box-shadow:none; margin:0 }',
        ' .print-footer{ display:grid !important; visibility:visible !important; }',
        '}',
        '.print-footer{',
        '  position:fixed; left:0; right:0; bottom:calc(var(--footer-safe) + 0.4mm);',
        '  height:var(--footer-h);',
        '  display:grid; grid-template-columns:1fr auto 1fr; align-items:center;',
        '  padding:0 10mm;',                 /* 좌우 패딩을 조금 더 주어 답답함 제거 */
        '  border-top:0.15mm solid #e7e7ea;',/* 얇고 밝은 선 */
        '  font:11px/1.2 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;',
        '  color:#3b3f45;',
        '}',
        '.pf-left   { justify-self:start; opacity:.9 }',
        '.pf-center { justify-self:center; font-weight:600; letter-spacing:.02em }',
        '.pf-right  { justify-self:end }',
        /* 로고+상호 띄어쓰기/정렬 */
        '.brand { display:inline-flex; align-items:center; gap:6px }',
        '.brand .pf-logo { height:5.0mm; width:auto; object-fit:contain }',
        '.brand .text { font-weight:700; letter-spacing:.02em; }',
        '@media print{',
        '  body{ counter-reset:page }',
        '}',
        '@media screen{',
        ' .print-footer{ z-index: 2; }', /* 푸터가 언더레이 위에 오도록 */
        '  .print-footer::before{',
        '    content:"";',
        '    position: fixed;',
        '    left: 50%;',
        '    transform: translateX(-50%);',
        '    bottom: 0;',
        '    width: var(--sheet-w);',  /* 210mm 또는 198mm */
        '    height: calc(var(--footer-h) + var(--footer-safe) + 6mm);', /* 필요시 4~8mm 조절 */
        '    background: #fff;',
        '    box-shadow: 0 0 0.8rem rgba(0,0,0,.12);', /* 시트 그림자 연속감 */
        '    pointer-events: none;',
        '    z-index: -1;', /* 푸터 뒤(아래) */
        '  }',
        '}',    
        '</style>',
        '</head><body>',
        '<div id="reportA4" class="print-sheet" title="클릭하여 인쇄"><div id="sheetInner" class="sheet-inner"></div></div>',
        '<div id="printFooter" class="print-footer" hidden>',
        '  <div class="pf-left"></div><div class="pf-center"></div><div class="pf-right"></div>',
        '</div>',
        '</body></html>'
      ].join('');

      try { frame.srcdoc = html; }
      catch (e) {
        var d = frame.contentDocument || frame.contentWindow.document;
        d.open(); d.write(html); d.close();
      }

      function bind(){
        var d = frame.contentDocument || frame.contentWindow.document;
        var el = d.getElementById('reportA4');
        if (el) {
          el.addEventListener('click', function() {
            // 인쇄 전에 꼬리말 상태 강제 설정
            const footer = d.getElementById('printFooter');
            if (footer) {
              footer.hidden = false;
              footer.style.display = 'grid';
              footer.style.position = 'fixed';
              footer.style.bottom = '0';
              footer.style.left = '0';
              footer.style.right = '0';
              footer.style.zIndex = '2147483647';
            }
            frame.contentWindow.print();
          }, { passive: true });
        }

        var urls = (window.AM5_URLS) || {
          index: 'https://cdn.amcharts.com/lib/5/index.js',
          xy:    'https://cdn.amcharts.com/lib/5/xy.js',
          anim:  'https://cdn.amcharts.com/lib/5/themes/Animated.js'
        };

        // ✅ am5 준비 프로미스 보장
        if (!frame.__am5Ready) {
          frame.__am5Ready = new Promise((resolve) => {
            // 이미 로드돼 있으면 즉시 resolve
            const w = frame.contentWindow;
            if (w && w.am5 && w.am5xy && w.am5themes_Animated) {
              resolve(w);
            } else {
              loadScriptsSequentially(d, [urls.index, urls.xy, urls.anim], function(){
                resolve(frame.contentWindow);
              });
            }
          });
        } else {
          // 이미 존재하는 경우엔 굳이 다시 로드할 필요 없음
        }
      }
      frame.addEventListener('load', bind, { once:true });
      return frame;
    }

    // Section  렌더러
    async function renderSection({ seq_no, work_YY, work_QT, record, template }) {
        // ⬇️ PDF 보기 후 제작 시 화면이 안 바뀌는 현상 방지
      if (window.__PDF_HOST__?.classList.contains('visible')) showSectionHost();
      // 1) 레코드 보강
      const rec = await ensureRecord(seq_no, record, work_YY, work_QT);
      const {
            work_YY: wy, endDate_text, titleColor,
            startYear, startMM, startDD,reg_date
          } = computeCoverData({ record: rec, work_YY });

      const biz_name    = rec?.biz_name    || '회사명';
      const ceo_name    = rec?.ceo_name    || '';
      const admin_name  = rec?.admin_name  || '';
      const biz_no      = rec?.biz_no      || '';
      const biz_type      = rec?.biz_type;
      const TXT_DutyCTA = rec?.TXT_DutyCTA || '김기현';
      // 2) 템플릿 분기
      switch (String(template)) {
        /* ======================= 0. 표지 ======================= */
        case '0': {
          var brand       = (titleColor && String(titleColor).trim()) || '0ea5e9';
          brand = '0ea5e9'
          const html2 = `
          <style>
            :root{ --brand:#${brand}; --brand-dark:#1a5a37; --ink:#1e1e1e; --paper:#f9fbf7; }
            .sheet-inner{font-family:"Noto Sans KR","Malgun Gothic",Arial,Helvetica,sans-serif; color:var(--ink);}
            .cover-page{ position:relative; width:210mm; height:297mm; box-sizing:border-box; padding-top:50mm; overflow:hidden;
              background:
                radial-gradient(1200px 900px at 90% -10%, rgba(33,118,72,.14) 0%, rgba(33,118,72,0) 60%),
                radial-gradient(900px 900px at -10% 110%, rgba(26,90,55,.12) 0%, rgba(26,90,55,0) 60%),
                linear-gradient(180deg, #f2f7f2 0%, #eef5f0 100%);
              -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            .cover-header{ position:relative; z-index:2; height:34mm; padding:0 25mm; display:flex; flex-direction:column; justify-content:center;
              color:#fff; background:linear-gradient(90deg,var(--brand) 0%, var(--brand-dark) 100%); }
            .cover-header::after{ content:""; position:absolute; inset:0;
              background:repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 8px, transparent 8px 16px);
              mix-blend-mode: overlay; pointer-events:none; }
            .cover-title{margin:0; font-size:30px; font-weight:800; letter-spacing:.2px;}
            .cover-subtitle{margin:5px 0 0; font-size:28px; opacity:.95;}

            .ornament-dot{ position:absolute; top:58mm; right:22mm; width:14mm; height:14mm; border-radius:50%;
              background: radial-gradient(circle at 30% 30%, #fff8 0 30%, #fff0 60%), #2d8a57; box-shadow:0 2mm 6mm rgba(0,0,0,.15); }

            .bg-svg{ position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }

            .period{ position:absolute; top:120mm; left:50%; width:100%; transform:translateX(-50%); text-align:center; z-index:10; }
            .period .kicker{ font-size:20px; font-weight:800; letter-spacing:.10em; }
            .period .range{  font-size:20px; font-weight:800; margin-top:6px; }

            .info-wrap{ width:380px; position:absolute; left:72%; transform:translateX(-50%); top:220mm; }
            .glass{ background:linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.72));
              border:1px solid rgba(0,0,0,.06); box-shadow:0 2mm 8mm rgba(0,0,0,.12); backdrop-filter:saturate(120%) blur(2px);
              border-radius:8px; overflow:hidden; }
            .info-accent{ height:3px; background:var(--brand); }
            table.info{ width:100%; border-collapse:collapse; }
            table.info td{ padding:10px 14px; font-size:16px; vertical-align:middle; }
            table.info tr + tr td{ border-top:1px solid #e7ece8; }
            td.label{ width:140px; color:#3b4b42; font-weight:700; letter-spacing:.08em; }
            td.value{ color:#1e2b24; }
            td.label::before{ content:""; display:inline-block; width:3px; height:12px; margin-right:10px; background:var(--brand); border-radius:2px; vertical-align:middle; }

            /* 프린트 여백/헤어라인 보호 
            @page{ size:A4; margin:12mm 12mm 0 12mm; }
            */
            @page{ size:A4; margin:0; }
            @media print{ html,body{margin:0;} }
          </style>

          <div class="cover-page">
            <div class="cover-header">
              <h1 class="cover-title">Financial Report For Your Company</h1>
              <div class="cover-subtitle"><b>${biz_name}</b> 기장 현황 보고서</div>
            </div>

            <div class="ornament-dot"></div>

            <svg class="bg-svg" viewBox="0 0 210 297" width="210mm" height="297mm" aria-hidden="true">
              <g transform="translate(0,50)">
                <path d="M0,0 H210 V200 C160,120 110,120 0,140 Z" fill="#d9dcdf"/>
                <path d="M210,0 V140 C190,120 170,110 150,100   C160,80 175,55 210,35 Z"  fill="#ead9ce" fill-opacity=".75"/>
                <ellipse cx="182" cy="70" rx="36" ry="32" fill="#e8a6a3" fill-opacity=".95"/>
                <path d="M160,45 a34,36 0 0 1 22,60  a34,36 0 0 1 -22,-60 Z" fill="#f2c3a3" fill-opacity=".9"/>
                <path d="M0,115 C40,125 85,132 120,130 C155,128 180,122 210,116 V297 H0 Z" fill="#ffffff"/>
                <path d="M0,0 H210 V80 C200,87 185,93 160,100  C120,110 65,113 0,105 Z"  fill="#cfd3d6" fill-opacity=".35"/>
                <path d="M0,130 C70,138 120,138 210,125  V140 C130,152 70,148 0,138 Z"  fill="#f1f3f5" fill-opacity=".7"/>
              </g>
            </svg>

            <div class="period">
              <div class="kicker">보 고 기 간<br>
              ${startYear}년 ${startMM}월 ${startDD}일 ~ ${wy}년 ${endDate_text}</div>
            </div>

            <div class="info-wrap">
              <div class="glass">
                <div class="info-accent"></div>
                <table class="info">
                  <tr><td class="label">회 사 명</td><td class="value">${biz_name}</td></tr>
                  <tr><td class="label">사업자번호</td><td class="value">${biz_no}</td></tr>
                  <tr><td class="label">대 표 자</td><td class="value">${ceo_name}</td></tr>
                  <tr><td class="label">책임세무사</td><td class="value">${TXT_DutyCTA}</td></tr>
                  <tr><td class="label">담 당 자</td><td class="value">${admin_name}</td></tr>
                  <tr><td class="label">작 성 일</td><td class="value">${new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'})}</td></tr>
                </table>
              </div>
            </div>
          </div>
          `;
          setA4Content(html2, '0');            // ✅ 표지: 템플릿=0, 헤더/푸터 없음
          return;
        }
        /* ======================= 1. 회사정보 ======================= */
        case '1': {
          const showCorp = !Number.isNaN(biz_type) && biz_type < 4;

          // ── (추가) 법인일 때 주주 수 선조회
          let stockCnt = 0;
          if (showCorp) {
            try {
              const api = "{% url 'getCompanyInfo' %}";
              const resp = await fetch(`${api}?seq_no=${encodeURIComponent(seq_no)}&flag=STOCKHOLDERS`);
              const data = await resp.json();
              stockCnt = Array.isArray(data?.stockHolders) ? data.stockHolders.length : 0;
            } catch (e) {
              console.warn('STOCKHOLDERS prefetch failed:', e);
              stockCnt = 0; // 실패 시 기본값
            }
          }

          const html = `
            <!-- workersWrap 전용 스타일 (화면/인쇄 모두 2열) -->
            <style id="workers-grid-style">
              #workersWrap{
                display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start;
              }
              #workerChartLeft, #workerChartRight{
                page-break-inside: avoid; break-inside: avoid;
                width:100%; height: 260px !important;
              }
              .apexcharts-canvas, .apexcharts-svg{ width:100% !important; height:100% !important; }
              @media print{
                #workersWrap{ grid-template-columns: 1fr 1fr; gap:12px; }
                #workerChartLeft, #workerChartRight{ page-break-inside: avoid; break-inside: avoid; width:100%; height:260px !important; }
                .apexcharts-canvas, .apexcharts-svg{ width:100% !important; height:100% !important; }
              }
            </style>

            <div class="common-page">
              ${buildTitleBoxHeader({leftTitle: 'Ⅰ. 회사개요', rightSubtitle: rec?.biz_name || ''})}
              <div class="subsec-title"><span class="dot"></span>회사현황</div>
              <div id="companySummaryWrap" class="mb-3"></div>

              ${showCorp ? `
                <div class="subsec-title"><span class="dot"></span>주주현황</div>
                <div id="stockWrap"><span class="spinner"></span> 주주 데이터를 불러오는 중…</div>
              ` : `
                <div class="subsec-title"><span class="dot"></span>사업용 신용카드 등록현황 및 사용금액</div>
                <div id="cardsWrap"></div>          

              `}

              ${showCorp ? `
                <div class="print-break-before"></div>
                ${buildTitleBoxHeader({ leftTitle: 'Ⅰ. 회사개요(2)', rightSubtitle: rec?.biz_name || '' })}
                <div class="subsec-title"><span class="dot"></span>임원 등기현황</div>
                <div id="execWrap"><span class="spinner"></span> 임원 데이터를 불러오는 중…</div>
                <div class="subsec-title"><span class="dot"></span>직원현황</div>
                <div id="workersWrap">
                  <div id="workerChartLeft"></div>
                  <div id="workerChartRight"></div>
                </div>
              ` : `
                <div class="print-break-before"></div>
                ${buildTitleBoxHeader({ leftTitle: 'Ⅰ. 회사개요(2)', rightSubtitle: rec?.biz_name || '' })}

                <div class="subsec-title"><span class="dot"></span>사업용계좌 개설현황</div>
                <div id="bizAccntWrap"><span class="spinner"></span> 사업용계좌 개설 데이터를 불러오는 중…</div>

                <div class="subsec-title"><span class="dot"></span>현금영수증 현황</div>
                <div id="cashWrap"><span class="spinner"></span> 현금영수증 데이터를 불러오는 중…</div>

                <div class="subsec-title"><span class="dot"></span>직원현황</div>
                <div id="workersWrap">
                  <div id="workerChartLeft"></div>
                  <div id="workerChartRight"></div>
                </div>
              `}
            </div>
          `;

          const hf = {
            footer: { left: `${work_YY}년도 ${work_QT}분기 보고`,
                      right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" alt="Daeseung Tax" class="pf-logo">` },
            pageTop: 0, pageBottom: 14
          };

          setA4Content(html, '1', hf).then(function(doc){
            // 회사 요약
            renderCompanySummaryHTML5({
              doc, mountId: 'companySummaryWrap',
              url: "{% url 'getCompanyInfo' %}",
              params: { seq_no, flag:'SUMMARY' }
            });

            if (showCorp) {
              // ── 주주 13명 초과면: 규제부담 표 제외 + 전용 함수 사용
              const useOnly6 = stockCnt > 13;
              if (useOnly6) {
                renderStockSectionHTML5_only6({
                  doc, mountId: 'stockWrap',
                  url: "{% url 'getCompanyInfo' %}",
                  params: { seq_no, flag:'STOCKHOLDERS' }
                });
              } else {
                renderStockSectionHTML5({
                  doc, mountId: 'stockWrap',
                  url: "{% url 'getCompanyInfo' %}",
                  params: { seq_no, flag:'STOCKHOLDERS' }
                });
              }

              renderExecSectionHTML5({
                doc, mountId:'execWrap',
                url: "{% url 'getCompanyInfo' %}",
                params: { seq_no, flag:'EXECS', work_yy: work_YY, fiscalMM: rec?.FiscalMM }
              });

            } else {
              // 개인: 사업용계좌/현금영수증/카드
              renderBizAccntSectionHTML5({
                doc, mountId: 'bizAccntWrap',
                url: "{% url 'getCompanyInfo' %}",
                params: { seq_no, flag:'BIZ_ACCOUNTS' }
              });
              renderCashSectionHTML5({
                doc, mountId: 'cashWrap',
                url: "{% url 'getCompanyInfo' %}",
                params: { seq_no, work_yy: Number(work_YY) }
              });
              renderCardsSectionHTML5({
                doc, mountId: 'cardsWrap',
                url: "{% url 'getCompanyInfo' %}",
                params: { seq_no, work_yy: Number(work_YY) }
              });
            }

            // 공통: 직원 그래프
            renderWorkersChartsHTML5({
              doc, mountId: 'workersWrap',
              url: '{% url "getCompanyInfo" %}',
              params: { seq_no, flag:'WORKERS', work_yy: Number(work_YY) }
            });

            // 리사이즈 트리거
            setTimeout(()=>doc.defaultView?.dispatchEvent(new Event('resize')), 0);
          });

          return;
        }
        /* ======================= 2. 매출 ======================= */
        case '2': {
          const y0 = Number(work_YY) - 2;
          const y1 = Number(work_YY) - 1;
          const y2 = Number(work_YY);

          const htmlForSection2 = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅱ. 매출현황(1)', rightSubtitle: rec?.biz_name || '' })}

              <div class="subsec-title"><span class="dot"></span>연도별 매출추이</div>

              <!-- 연도별 매출 그래프 -->
              <div class="chart-card">
                <div id="graphModalBody1" class="chart-wrap-260"></div>
              </div>

              <!-- 하단 평가의견 -->
              <div class="grid-below">
                <aside class="metrics-card">
                  <div class="metrics-head">
                    <span> </span><span class="unit">(단위: 만원)</span>
                  </div>
                  <table class="tbl-metrics">
                    <thead>
                      <tr>
                        <th>구 분</th>
                        <th id="th-y0">${y0}</th>
                        <th id="th-y1">${y1}</th>
                        <th id="th-y2">${y2}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>매출액</td>          <td id="sales-y0">-</td><td id="sales-y1">-</td><td id="sales-y2">-</td></tr>
                      <tr><td>성장률</td>          <td id="grow-y0">-</td><td id="grow-y1">-</td><td id="grow-y2">-</td></tr>
                      <tr><td>채권회전율</td>  <td id="turn-y0">-</td><td id="turn-y1">-</td><td id="turn-y2">-</td></tr>
                    </tbody>
                  </table>
                  <div class="notes">
                    ※ 성장률 = (당기매출액 − 전기매출액) / 전기매출액<br>
                    ※ 매출채권 회전율 = 매출액 / ((기초채권 + 기말채권) / 2)
                  </div>
                </aside>

                <section class="opinion-card">
                  <div class="op-head">평가의견</div>
                  <div id="opinion-text" class="op-body"></div>
                </section>
              </div>

              <div class="subsec-title"><span class="dot"></span>매출채권 연령분석(상세)</div>
              <div class="card-soft">
                <div id="arTopListWrap"></div>
              </div>


              <!-- ⬇️ 여기서부터 새 페이지 시작 -->
              <div class="print-break-before"></div>

              ${buildTitleBoxHeader({ leftTitle: 'Ⅱ. 매출현황(2)', rightSubtitle: rec?.biz_name || '' })}

              <div class="print-keep" id="blockMonthly">
                <div class="subsec-title"><span class="dot"></span>월별 매출액(전년 동월 대비)</div>
                <div class="chart-card">
                  <div id="graphMonthlyYoY" class="chart-wrap-230"></div>
                </div>
              </div>

              <div class="print-keep" id="blockQuarterly">
                <div class="subsec-title"><span class="dot"></span>분기별 매출액(전년 동분기 대비)</div>
                <div class="chart-card">
                  <div id="graphQuarterlyYoY" class="chart-wrap-230"></div>
                </div>
              </div>         

              <div  id="majorSale">
                <div class="subsec-title"><span class="dot"></span>주요 매출처 현황</div>
                <div class="chart-card">
                  <div id="donutTopSales" class="chart-wrap-230"></div>
                </div>
              </div>     

            </div>
          `;

          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };

          setA4Content(htmlForSection2, '2', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            // 연도별 매출액
            yearlySaleBar(seq_no, work_YY, work_QT, doc.getElementById('graphModalBody1'), rec?.FiscalMM, w);
            // 좌측 표/평가 텍스트 채우기 - 기존 함수
            fillSalesSide(doc, seq_no, Number(work_YY), rec?.FiscalMM);
            // 하단 월별 YoY 그래프
            monthlyYoYChart({
              seq_no,
              mountEl: doc.getElementById('graphMonthlyYoY'),
              year: Number(work_YY),
              fiscalMM: rec?.FiscalMM,
              ctx: w
            });
            // 분기별 YoY 그래프
            quarterlyYoYChart({
              seq_no,
              mountEl: doc.getElementById('graphQuarterlyYoY'),
              year: Number(work_YY),
              fiscalMM: rec?.FiscalMM,
              ctx: w
            });    
            // 매출채권 연령분석
            renderArTopTable({
              seq_no,
              mountEl: doc.getElementById('arTopListWrap'),
              year: Number(work_YY),
              fiscalMM: rec?.FiscalMM,
              ctx: w
            });
            //당기 매출처 상위
            salesTopDonut({
              seq_no,
              mountEl: doc.getElementById('donutTopSales'),
              year: Number(work_YY),
              fiscalMM: rec?.FiscalMM,
              topN: 7,                    // 필요 시 10 등으로 변경 가능
              ctx: w
            });        
          });
          return;
        }
        /* ======================= 3. 비용 ======================= */
        case '3': {
          const y0 = Number(work_YY) - 2;
          const y1 = Number(work_YY) - 1;
          const y2 = Number(work_YY);

          const htmlForSection2 = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅲ. 매입현황 및 세금(1)', rightSubtitle: rec?.biz_name || '' })}

              <div class="subsec-title"><span class="dot"></span>연도별 순이익 및 세금</div>
              <div class="chart-card">
                <div id="graphModalBody3" class="chart-wrap-260"></div>
              </div>
              <div class="chart-row">
                <div class="chart-card">
                  <div class="chart-title">매출 vs 비용</div>
                  <div id="graphModalBodyX" class="chart-wrap-260"></div>
                </div>

                <div class="chart-card">
                  <div class="chart-title">순이익증감율</div>
                  <div id="chartCurrentR" class="chart-wrap-260"></div>
                </div>
              </div>
              <div class="chart-row">
                <div class="chart-card">
                  <div id="costDonutTitle" class="chart-title">비용구조</div>
                  <div id="costDonutWrap" class="chart-wrap-260"></div>
                </div>

                <div class="chart-card">
                  <div id="profitTaxWrap" class="chart-wrap-260"></div>
                </div>
              </div>
              <!-- ⬇️ 여기서부터 새 페이지 시작 -->
              <div class="print-break-before"></div>

              ${buildTitleBoxHeader({ leftTitle: 'Ⅲ. 매입현황 및 세금(2)', rightSubtitle: rec?.biz_name || '' })}

              <div class="print-keep" id="blockMonthly">
                <div class="subsec-title"><span class="dot"></span>주요 매입처 현황</div>
                <div class="chart-card">
                  <div id="purchaseTopDonut" class="chart-wrap-230"></div>
                </div>
              </div>

              <div class="print-keep" id="blockQuarterly">
                <div class="subsec-title"><span class="dot"></span>매입내역 분석</div>
                <div class="chart-card">
                  <div id="purchaseEvidence" class="chart-wrap-230"></div>
                </div>
              </div>         

              <div class="print-keep" id="PredictTax">
                <div class="subsec-title"><span class="dot"></span>예상세금 및 평가의견</div>
                <div class="chart-card">
                  <div id="taxEstimate" class="chart-wrap-230"></div>
                </div>
              </div>     
            </div>
          `;

          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };

          setA4Content(htmlForSection2, '3', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            await whenAm5Ready(frame);

            const fy = Number(rec?.FiscalMM || fiscalMM || 12);
            const workQtNum = Number(work_QT || 4);

            const baseParams = {
              seq_no,
              work_yy: Number(work_YY),
              fiscalMM: fy
            };

            // 한 번에 필요한 데이터 요청
            const [plData, topPurchaseData, purchaseEvidenceData, taxData] = await Promise.all([
              fetchPLData({ ...baseParams, flag: "PL" }),
              fetchPLData({ ...baseParams, flag: "TOP_PURCHASE" }),
              fetchPLData({ ...baseParams, flag: "PURCHASE_EVID" }),
              fetchPLData({ ...baseParams, flag: "TAX_ESTIMATE", work_qt: workQtNum })
            ]);

            // 병렬 렌더링
            await Promise.all([
              renderCostBenefit({
                doc,
                mountId: 'graphModalBody3',
                data: plData,
                ...baseParams,
                work_qt: workQtNum
              }),
              renderSalesCostLines({
                doc,
                mountId: 'graphModalBodyX',
                data: plData,
                ...baseParams
              }),
              renderProfitGrowth({
                doc,
                mountId: "chartCurrentR",
                data: plData,
                ...baseParams
              }),
              renderProfitTaxTable({
                doc,
                mountId: "profitTaxWrap",
                data: plData,
                ...baseParams,
                biz_type
              }),
              renderCostStructureDonut({
                doc,
                mountId: "costDonutWrap",
                data: plData,
                ...baseParams,
                includeTax: true
              }),
              renderTopPurchaseDonut({
                doc,
                mountEl: 'purchaseTopDonut',
                data: topPurchaseData,
                ...baseParams,
                biz_type
              }),
              renderPurchaseEvidenceA4({
                doc,
                mountEl: 'purchaseEvidence',
                data: purchaseEvidenceData,
                ...baseParams
              }),
              renderTaxEstimateA4({
                doc,
                mountEl: 'taxEstimate',
                data: taxData,
                ...baseParams,
                work_qt: workQtNum
              })
            ]);
          });
          return;
        }
        case '4': {
          const htmlForSection4 = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅳ. 재무능력분석', rightSubtitle: rec?.biz_name || '' })}
              <div id="issueMessage" ></div>
            </div>
          `;

          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };

          setA4Content(htmlForSection4, '4', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderFinanceIssueTable({
              doc,
              mountId: 'issueMessage',
              seq_no,
              work_yy: Number(work_YY)
            });
            
          });
          return;
        }
        case '5': {
          const htmlForSection5 = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅴ. 재무비율', rightSubtitle: rec?.biz_name || '' })}
              <div id="ratioMount"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(htmlForSection5, '5', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderFinanceRatios({
              doc,
              mountId: 'ratioMount',
              seq_no,
              work_yy: Number(work_YY),
              work_qt: Number(work_QT || 4)
            });
          });
          return;
        }
        case '6-1': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅵ. 재무제표(재무상태표)', rightSubtitle: rec?.biz_name || '' })}
              <div id="statementBS"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(html, '6-1', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderStatement({
              doc,
              mountId: 'statementBS',
              seq_no,
              work_yy: Number(work_YY),
              ki:new Date().getYear() - reg_date.getYear()+1,
              flag2:'BS'
            });
            function syncHFFooterToTFoot(doc){
              const pf = doc.getElementById('printFooter');               // setA4Content가 만든 고정 푸터
              const tf = doc.querySelector('.print-tfoot');               // 우리가 추가한 tfoot
              if (!pf || !tf) return;

              const srcL = pf.querySelector('.pf-left')?.innerHTML ?? '';
              const srcC = pf.querySelector('.pf-center')?.innerHTML ?? '';
              const srcR = pf.querySelector('.pf-right')?.innerHTML ?? '';

              const dstL = tf.querySelector('.tf-left');
              const dstC = tf.querySelector('.tf-center');
              const dstR = tf.querySelector('.tf-right');

              if (dstL) dstL.innerHTML = srcL;
              if (dstC) dstC.innerHTML = srcC;
              // dstR은 Page 카운터가 있으니 오른쪽은 보통 유지. 필요하면 아래처럼 합성:
              // if (dstR) dstR.innerHTML = srcR + ' · Page <span class="pageNumber"></span>';
            }
          });
          return;
        }
        case '6-2': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅵ. 재무제표(손익계산서)', rightSubtitle: rec?.biz_name || '' })}
              <div id="statementPL"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(html, '6-2', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderStatement({
              doc,
              mountId: 'statementPL',
              seq_no,
              work_yy: Number(work_YY),
              ki:new Date().getYear() - reg_date.getYear()+1,
              flag2:'PL'
            });
            function syncHFFooterToTFoot(doc){
              const pf = doc.getElementById('printFooter');               // setA4Content가 만든 고정 푸터
              const tf = doc.querySelector('.print-tfoot');               // 우리가 추가한 tfoot
              if (!pf || !tf) return;

              const srcL = pf.querySelector('.pf-left')?.innerHTML ?? '';
              const srcC = pf.querySelector('.pf-center')?.innerHTML ?? '';
              const srcR = pf.querySelector('.pf-right')?.innerHTML ?? '';

              const dstL = tf.querySelector('.tf-left');
              const dstC = tf.querySelector('.tf-center');
              const dstR = tf.querySelector('.tf-right');

              if (dstL) dstL.innerHTML = srcL;
              if (dstC) dstC.innerHTML = srcC;
              // dstR은 Page 카운터가 있으니 오른쪽은 보통 유지. 필요하면 아래처럼 합성:
              // if (dstR) dstR.innerHTML = srcR + ' · Page <span class="pageNumber"></span>';
            }
          });
          return;
        }
        case '6-3': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅵ. 재무제표(제조원가명세서)', rightSubtitle: rec?.biz_name || '' })}
              <div id="statementCS"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(html, '6-3', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderStatement({
              doc,
              mountId: 'statementCS',
              seq_no,
              work_yy: Number(work_YY),
              ki:new Date().getYear() - reg_date.getYear() + 1,
              flag2:'CS'
            });
            function syncHFFooterToTFoot(doc){
              const pf = doc.getElementById('printFooter');               // setA4Content가 만든 고정 푸터
              const tf = doc.querySelector('.print-tfoot');               // 우리가 추가한 tfoot
              if (!pf || !tf) return;

              const srcL = pf.querySelector('.pf-left')?.innerHTML ?? '';
              const srcC = pf.querySelector('.pf-center')?.innerHTML ?? '';
              const srcR = pf.querySelector('.pf-right')?.innerHTML ?? '';

              const dstL = tf.querySelector('.tf-left');
              const dstC = tf.querySelector('.tf-center');
              const dstR = tf.querySelector('.tf-right');

              if (dstL) dstL.innerHTML = srcL;
              if (dstC) dstC.innerHTML = srcC;
              // dstR은 Page 카운터가 있으니 오른쪽은 보통 유지. 필요하면 아래처럼 합성:
              // if (dstR) dstR.innerHTML = srcR + ' · Page <span class="pageNumber"></span>';
            }
          });
          return;
        }
        case '6-4': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅵ. 재무제표(부속명세서)', rightSubtitle: rec?.biz_name || '' })}
              <div id="statementTR"></div>
            </div>
          `;
          const hf = {
            // footer: {
            //   left:  `${work_YY}년도 ${work_QT}분기 보고`,
            //   right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            // },
            // pageTop: 0,
            // pageBottom: 14
          };
          setA4Content(html, '6-4', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderSettlementSubsidiaryA4({
              doc,
              mountID: 'statementTR',
              seq_no,
              work_yy: Number(work_YY)
            });
          });
          return;
        }
        case '7': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅶ. 주식가치평가', rightSubtitle: rec?.biz_name || '' })}
              <div id="EquityValuation"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(html, '7', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderEquityValuation({
              doc,
              mountID: 'EquityValuation',
              seq_no,
              work_yy: Number(work_YY)
            });
          });
          return;
        }
        case '8': {
          const html = `
            <div class="common-page">
              ${buildTitleBoxHeader({ leftTitle: 'Ⅷ. 재무관리 상태진단', rightSubtitle: rec?.biz_name || '' })}
              <div id="Diagnosis"></div>
            </div>
          `;
          const hf = {
            footer: {
              left:  `${work_YY}년도 ${work_QT}분기 보고`,
              right: `<img src="{% static 'assets/images/brand/DS_LOGO_H22.gif' %}" class="pf-logo" alt="">`
            },
            pageTop: 0,
            pageBottom: 14
          };
          setA4Content(html, '8', hf).then(async (doc) => {
            const frame = document.getElementById('reportA4Frame');
            const w = await whenAm5Ready(frame);
            renderDiagnosis({
              doc,
              mountID: 'Diagnosis',
              seq_no,
              work_yy: Number(work_YY),
              work_qt: Number(work_QT || 4)
            });
          });
          return;
        }           
        default:
          console.warn('알 수 없는 template:', template);
          return;
      }
    }

    //토글방식
    function showSectionHost(){
      const s = window.__SECTION_HOST__, p = window.__PDF_HOST__;
      if (!s || !p) return;
      p.classList.remove('loading'); // 혹시 남아있을 수 있는 로딩 상태 제거
      s.classList.add('visible');
      p.classList.remove('visible');
    }

    function showPdfHost(){
      const s = window.__SECTION_HOST__, p = window.__PDF_HOST__;
      if (!s || !p) return;
      p.classList.add('visible');
      s.classList.remove('visible');
    }
    function bindMake(btnId, tpl){
      const el = document.getElementById(btnId);
      if (!el) return;
      el.addEventListener('click', function(){
        // PDF 보기 상태였더라도 섹션 뷰로 먼저 전환
        showSectionHost();
        renderSection({ seq_no, work_YY, work_QT, record, template: tpl });
      });
    }

    // 기존 addEventListener들을 이걸로 교체
    bindMake('btn-sec0-make', '0');
    bindMake('btn-sec1-make', '1');
    bindMake('btn-sec2-make', '2');
    bindMake('btn-sec3-make', '3');
    bindMake('btn-sec4-make', '4');
    bindMake('btn-sec5-make', '5');
    bindMake('btn-sec61-make','6-1');
    bindMake('btn-sec62-make','6-2');
    bindMake('btn-sec63-make','6-3');
    bindMake('btn-sec64-make','6-4');
    bindMake('btn-sec7-make', '7');
    bindMake('btn-sec8-make', '8');


    // ▶ PDF 열기 (질문에서 주신 함수 그대로 사용)
    function openPdfInRenderSection(pdfUrl, opts = {}) {
      if (!pdfUrl) return alert("PDF URL이 없습니다.");

      // 캐시 버스터 & 기본 파라미터
      const cacheBust = `_=${Date.now()}`;
      const url = pdfUrl + (pdfUrl.includes('?') ? '&' : '?') + cacheBust;
      const withViewerHash = (opts.hash === false) ? '' : '#toolbar=1&navpanes=0&view=FitH';

      // 호스트/프레임 참조
      const pdfHost  = window.__PDF_HOST__;
      const pdfFrame = document.getElementById('pdfFrame');

      if (!pdfHost || !pdfFrame) {
        // 프레임이 없으면 새로 만들기(아주 예외적)
        const wrap = document.getElementById('PreviewRight') || document.getElementById('Report_Right');
        if (!wrap) { window.open(url + withViewerHash, '_blank'); return; }
        const host = document.createElement('div');
        host.id = 'pdfHost';
        host.className = 'host visible';
        host.innerHTML = `
          <div id="pdfLoading">PDF 불러오는 중…</div>
          <iframe id="pdfFrame" title="PDF 미리보기"></iframe>
        `;
        wrap.appendChild(host);
        window.__PDF_HOST__ = host;
      }

      // 로딩 표시 & 토글
      showPdfHost();
      window.__PDF_HOST__?.classList.add('loading');

      // src 설정 + embed 가능성 체크 후 폴백
      const frame = document.getElementById('pdfFrame');
      try {
        frame.onload = function(){
          // 일부 서버는 onload가 와도 화면이 비는 경우가 있어 간단 체크
          window.__PDF_HOST__?.classList.remove('loading');
        };
        frame.onerror = function(){
          window.__PDF_HOST__?.classList.remove('loading');
          // iframe 로드 실패 → 새 탭 폴백
          window.open(url + withViewerHash, '_blank');
        };
        frame.src = url + withViewerHash;

        // 1.5초 내 렌더 무응답 시(보안 헤더 등) 폴백
        setTimeout(() => {
          const rendered = frame.contentDocument && frame.contentDocument.body && frame.contentDocument.body.childElementCount > 0;
          if (!rendered) {
            window.__PDF_HOST__?.classList.remove('loading');
            window.open(url + withViewerHash, '_blank');
          }
        }, 1500);

      } catch (e) {
        window.__PDF_HOST__?.classList.remove('loading');
        window.open(url + withViewerHash, '_blank');
      }
    }

    // ▶ 버튼 상태 갱신 & 클릭 핸들러 연결 유틸
    function wirePdfButton(btnEl, pdfUrl){
      btnEl.disabled = !pdfUrl;
      btnEl.classList.toggle('disabled', !pdfUrl); // 부트스트랩 보조
      if (pdfUrl) {
        btnEl.dataset.pdfUrl = pdfUrl;
        if (!btnEl.__binded) {
          btnEl.addEventListener('click', () => openPdfInRenderSection(btnEl.dataset.pdfUrl));
          btnEl.__binded = true;
        }
        btnEl.title = "PDF 열기";
      } else {
        btnEl.removeAttribute('data-pdf-url');
        btnEl.title = "PDF 미생성 (먼저 '제작'하세요)";
      }
    }

    // ▶ 특정 섹션의 PDF 유무를 서버에 확인
    function fetchSectionPdfUrl(sectionCode, filename,seq_no,work_YY,work_QT){
      return $.ajax({
        url:  "{% url 'getFinancialData_Report' %}" ,
        cache: false,
        dataType: "json",
        data: {
          flag: 'MERGE_STATUS',
          filename: filename, // 해당 섹션 전용 파일 존재 유무만 체크
          seq_no:  seq_no,
          work_yy: work_YY,
          work_qt: work_QT
        }
      }).then(json => (json?.ok && json.url) ? json.url : null)
        .catch(() => null);
    }

    // ▶ DOM에 렌더된 버튼들을 스캔해서 활성/비활성 처리
    async function initSectionPdfButtons(root=document,seq_no,work_YY,work_QT){
      // id 패턴: btn-sec{code}-pdf
      const selector = [
        '#btn-sec0-pdf', '#btn-sec1-pdf', '#btn-sec2-pdf', '#btn-sec3-pdf',
        '#btn-sec4-pdf', '#btn-sec5-pdf',
        '#btn-sec61-pdf', '#btn-sec62-pdf', '#btn-sec63-pdf', '#btn-sec64-pdf',
        '#btn-sec7-pdf', '#btn-sec8-pdf',
        '#btn-sec300-pdf'
      ].join(',');

      const btns = Array.from(root.querySelectorAll(selector));
      for (const btn of btns) {
        // 섹션 코드 추출 (예: btn-sec61-pdf → 61)
        const m = btn.id.match(/^btn-sec(\d+)-pdf$/);
        if (!m) continue;
        const code = m[1];
        const filename = SECTION_FILEMAP[code] || code;

        // 우선 임시 비활성 (로딩 중)
        btn.disabled = true;
        btn.classList.add('disabled');
        btn.title = "확인 중…";

        // 서버 조회
        const url = await fetchSectionPdfUrl(code, filename,seq_no,work_YY,work_QT);

        // 결과 반영
        wirePdfButton(btn, url);
      }
    }

    /* ======================= 0. 표지 start======================= */
    function pad2(n){ return String(n).padStart(2,'0'); }
    function computeCoverData({ record, work_YY }) {
      const now = new Date();
      const curY  = now.getFullYear();
      const curM  = now.getMonth() + 1;
      const curD  = now.getDate();
      const curDate = `${curY}${pad2(curM)}${pad2(curD)}`;
      const work_month = curM;

      const biz_type = Number(record?.biz_type ?? 0);
      const fiscalMM = Number(record?.FiscalMM ?? record?.fiscalMM ?? 12);

      // Reg_date 파싱
      let reg_date;
      if (record?.Reg_date instanceof Date) reg_date = record.Reg_date;
      else if (typeof record?.Reg_date === 'string' && record.Reg_date.length >= 10) {
        reg_date = new Date(record.Reg_date.slice(0,10));
      } else reg_date = now;

      if (!work_YY) work_YY = curY;
      if (work_month < 4 && biz_type < 4)  work_YY = curY - 1;
      if (work_month < 4 && biz_type >= 4) work_YY = curY - 1;

      let work_QT = 4, work_mm = 12;
      let _endDate =  "";
      if (`${work_YY}0211` <= curDate && curDate <= `${work_YY}0415`) {
        work_QT = 4; work_mm = 12; if (!_endDate) _endDate = "12-31";
      } else if (`${work_YY}0416` <= curDate && curDate <= `${work_YY}0710`) {
        work_QT = 1; work_mm = 3;  if (!_endDate) _endDate = "03-31";
      } else if (`${work_YY}0711` <= curDate && curDate <= `${work_YY}1015`) {
        work_QT = 2; work_mm = 6;  if (!_endDate) _endDate = "06-30";
      } else if (`${work_YY}1016` <= curDate && curDate < `${work_YY+1}0101`) {
        work_QT = 3; work_mm = 9;  if (!_endDate) _endDate = "09-30";
      } else if (curDate >= `${work_YY+1}0101`) {
        work_QT = 4; work_mm = 12; if (!_endDate) _endDate = "12-31";
      } else {
        work_QT = 4; work_mm = 12; if (!_endDate) _endDate = "12-31";
      }

      const mod = work_YY % 4;
      const titleColor = (mod === 1) ? "217648"
                        : (mod === 2) ? "255398"
                        : (mod === 3) ? "6D3169"
                                      : "B8151A";

      let startYear = work_YY, startMM = 1, startDD = 1;
      if ((curY - reg_date.getFullYear()) === 0) {
        startMM = reg_date.getMonth() + 1;
        startDD = reg_date.getDate();
      } else if ((curY - reg_date.getFullYear()) === 1) {
        if (work_month < 4) {
          startMM = reg_date.getMonth() + 1;
          startDD = reg_date.getDate();
        } else {
          startMM = 1; startDD = 1;
        }
      } else {
        if (fiscalMM < 12) {
          startMM = fiscalMM + 1;
          const end_mm = Number((_endDate.split("-")[0] || "12"));
          if (end_mm <= fiscalMM) startYear = work_YY - 1;
        } else {
          startMM = 1;
        }
      }

      return {
        work_YY, work_QT, work_mm,
        endDate: _endDate,
        endDate_text: _endDate.replace("-", "월 ") + "일",
        titleColor,
        startYear, startMM, startDD,
        reg_date
      };
    }
    // 레코드가 부족하면 서버에서 보충
    async function ensureRecord(seq_no, record, work_YY, work_QT) {
      const need =
        !record ||
        !record.biz_name || !record.biz_no ||
        record.admin_name === undefined ||
        record.biz_type === undefined ||
        record.FiscalMM === undefined ||
        record.Reg_date === undefined;

      if (!need) return record;

      // ✅ Promise 반환 (await 가능)
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "{% url 'section0_data' %}",
          type: "GET",
          data: { seq_no, work_yy: work_YY },
          cache: false,
          success: function (res) { resolve(res); },
          error: function (xhr, status, err) {
            console.error("section0_data error:", err);
            setA4Content('<p style="color:#dc3545">표지 생성에 실패했습니다.</p>');
            reject(err);
          }
        });
      });
    }
    /* ======================= 1. 회사정보 start======================= */
    function renderCompanySummaryHTML5({ doc, mountId='companySummaryWrap', data, url, params }) {
      const wrap = doc.getElementById(mountId);
      if (!wrap) return;

      // ── 1) 스코프드 스타일 (한번만)
      if (!doc.getElementById('summary-modern-style')) {
        const css = `
        #${mountId}{display:block}
        #${mountId} .cs-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
        #${mountId} .cs-card{background:#fff;border:1px solid #e6e8ee;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.05)}
        /* ----- 회사 카드(좌) ----- */
        #${mountId} .cys{display:grid;grid-template-columns:92px 1fr;gap:18px;padding:18px}
        #${mountId} .cys .avatar{width:92px;height:92px;border-radius:12px;overflow:hidden;background:#f3f4f6;display:grid;place-items:center;border:1px solid #eceff4}
        #${mountId} .cys .avatar img{width:100%;height:100%;object-fit:cover}
        #${mountId} .cys .name{font-size:20px;font-weight:800;color:#1f2937}
        #${mountId} .cys .role{color:#6b7280;font-weight:700;margin-right:6px}
        #${mountId} .cys .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
        #${mountId} .cys .tag{font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;background:#f8fafc;border:1px solid #e5e7eb;color:#111827}
        #${mountId} .cys .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
        #${mountId} .cys .cell{border-top:1px dashed #edf1f6;padding-top:10px;display:grid;gap:10px}
        #${mountId} .cys .row{display:flex;gap:10px;align-items:center;font-size:14px}
        #${mountId} .cys .ico{width:28px;height:28px;border-radius:8px;background:#f1f5f9;display:grid;place-items:center}
        #${mountId} .cys .label{color:#6b7280;width:84px;flex:0 0 84px}
        #${mountId} .cys .value{color:#1f2937;font-weight:700}
        #${mountId} .cys a.value{color:#0ea5e9;text-decoration:none}
        #${mountId} .cys .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
        #${mountId} .cys .chip{font-size:12px;padding:6px 10px;background:#f9fafb;border:1px solid #edf1f6;border-radius:8px;color:#334155}
        #${mountId} .cys .chip.ok{
          background: linear-gradient(180deg, rgba(16,185,129,.14), rgba(16,185,129,.10));
          border-color: rgba(16,185,129,.45);
          color:#0b5e3f;
          font-weight: 800;
          box-shadow: 0 0 0 1px rgba(16,185,129,.25) inset;
        }

        /* 비강조(NO): 붉은기 뺀 중립톤, 옅은 테두리/글자색 */
        #${mountId} .cys .chip.no{
          background: #f6f7f8;
          border-color: #e6e7eb;
          color:#8b9098;
          font-weight: 600;
        }
      

        /* ▶ 배지(이 컴포넌트 전용) */
        #${mountId} .badge{
          display:inline-block; padding:6px 10px; border-radius:8px;
          font-size:12px; font-weight:700; line-height:1; color:#fff;
          -webkit-print-color-adjust:exact; print-color-adjust:exact;
          margin-right:6px;
        }
        #${mountId} .bg-primary-gradient{ background:linear-gradient(135deg,#22c55e,#16a34a); }  /* 연녹 → 진녹 */
        #${mountId} .bg-success-gradient{ background:linear-gradient(135deg,#06b6d4,#0ea5e9); }  /* 청록 → 하늘 */
        #${mountId} .my-1{ margin:2px; }

        #companySummaryWrap .cys .addr{margin-top:4px;color:#475569;font-weight:600}
        #companySummaryWrap .cys .avatar{
          width:92px;height:92px;border-radius:12px;overflow:hidden;
          border:1px solid #eceff4;background:#f3f4f6;
          display:grid;place-items:center;
        }
        #companySummaryWrap .cys .avatar.is-photo{
          background-size:cover;
          background-position:center;
          background-repeat:no-repeat;
        }
        #companySummaryWrap .cys .avatar.no-photo{ font-size:18px; color:#9aa3ad; }
        #companySummaryWrap .name-row{
          display:flex; align-items:center; justify-content:space-between;
          gap:12px; margin-bottom:6px;
        }
        #companySummaryWrap .name{
          font-size:14px; font-weight:800; color:#1f2937; letter-spacing:.2px;
          min-width:0; /* ellipsis를 위해 */
        }
        #companySummaryWrap .name .role{ color:#6b7280; font-weight:700;font-size:14px; margin-right:6px }
        #companySummaryWrap .badges{ display:flex; gap:8px; flex-wrap:wrap }
        #companySummaryWrap .badges .badge{ padding:6px 10px; border-radius:999px; font-weight:700 }
        #companySummaryWrap .addr{ margin-top:2px; color:#475569; font-weight:600;font-size:12px }

        @media (max-width:1024px), print{
          #${mountId} .cs-grid{grid-template-columns:1fr}
          #${mountId} .cys{grid-template-columns:76px 1fr}
          #${mountId} .cys .avatar{width:76px;height:76px}
          #companySummaryWrap .cys .avatar{ width:76px;height:76px; }
          #companySummaryWrap .name-row{ flex-wrap:wrap; gap:8px }
        }
        `;
        const st = doc.createElement('style');
        st.id = 'summary-modern-style';
        st.textContent = css;
        doc.head.appendChild(st);
      }

      // ── 2) 렌더 함수
      const paint = (payload)=>{
        const company = payload?.company || {};
        const tax     = Array.isArray(payload?.tax) ? payload.tax : [];

        const safe = (v)=> v==null ? '' : String(v);

        //const absUrl = company.userImg ? encodeURI(company.userImg) : '';
        const absUrl = (company.userImg || '').replace(/'/g, "%27");
        
        const avatarHTML = absUrl
          ? `<div class="avatar is-photo" style="background-image:url('${absUrl}')" aria-label="대표 사진"></div>`
          : `<div class="avatar no-photo" aria-label="대표 사진">📷</div>`;

        const leftHTML = `
            <div class="cs-card cys">
              <div class="avatar-wrap">
                ${avatarHTML}
              </div>
              <div>
                <div class="name-row">
                  <div class="name"><span class="role">대표자</span>${safe(company.ceo_name || company.biz_name)}</div>
                  <div class="badges">
                    ${company.uptae   ? `<span class="badge bg-primary-gradient">${safe(company.uptae)}</span>` : ''}
                    ${company.jongmok ? `<span class="badge bg-success-gradient">${safe(company.jongmok)}</span>` : ''}
                  </div>
                </div>
                <div class="addr">${company.addr || company.address || ''}</div>

                <!-- 이하 동일 -->
                <div class="grid">
                  <div class="cell">
                    <div class="row"><div class="ico">💡</div><div class="label">아이디</div><a class="value">${safe(company.userID)}</a></div>
                    <div class="row"><div class="ico">🔒</div><div class="label">비밀번호</div><a class="value" >${safe(company.userPW)}</a></div>
                  </div>
                  <div class="cell">
                    <div class="row"><div class="ico">✨</div><div class="label">사업개시일</div><div class="value">${safe(company.regDate)}</div></div>
                    <div class="row"><div class="ico">🗂️</div><div class="label">기장업무일</div><div class="value">${safe(company.createdDate)}</div></div>
                  </div>
                </div>

                <div class="chips">
                  ${company.isrnd     ? `<span class="chip ok">✅ 기업부설연구소</span>` : `<span class="chip no">❌ 기업부설연구소</span>`}
                  ${company.isventure ? `<span class="chip ok">✅ 벤처기업 승인</span>` : `<span class="chip no">❌ 벤처기업 승인</span>`}
                </div>
              </div>
            </div>`;
        wrap.innerHTML = `<div class="cs-grid">${leftHTML}</div>`;
      };

      // ── 3) 데이터 소스: data 우선, 없으면 ajax
      if (data) {
        paint(data);
        return;
      }

      // ajax 사용 시: 요약 + 세액감면을 한 번에 넘겨주면 그대로 사용
      if (url) {
        wrap.innerHTML = `<div class="cs-card" style="padding:14px">회사 정보를 불러오는 중…</div>`;
        $.ajax({
          url, data: { ...(params||{}), flag: 'SUMMARY' }, dataType:'json'
        }).done((res)=>{
          // 서버가 최소한의 요약만 준다면 아래와 같이 매핑/기본값 처리
          const payload = {
            company: {
              biz_name : res?.summary?.biz_name || '',
              ceo_name : (res?.summary?.ceo_name)||'',
              regDate: res?.summary?.regDate || '',
              createdDate: res?.summary?.createdDate || '',
              tel      : res?.summary?.tel || '',
              email    : res?.summary?.email || '',
              uptae   : res?.summary?.uptae || '',
              jongmok  : res?.summary?.jongmok || '', 
              userID:res?.summary?.userID || '', 
              userPW:res?.summary?.userPW || '', 
              isrnd:String(res?.summary?.isrnd || '').trim().toUpperCase() === 'Y',
              isventure: String(res?.summary?.isventure || '').trim().toUpperCase() === 'Y',
              userImg     : res?.summary?.userImg || '',
              addr : res?.summary?.addr || '',
            },
            // 서버에서 세액감면 배열을 못 줄 경우, 빈배열 => 우측카드 비어있지 않게 예시 한두개 넣어도 됨
            tax: Array.isArray(res?.tax) ? res.tax : []
          };
          paint(payload);
        }).fail(()=>{
          wrap.innerHTML = `<div class="cs-card" style="padding:14px;color:#dc2626">회사 정보를 불러오지 못했습니다.</div>`;
        });
        return;
      }
    }
    //직원현황
    function ensureApex(doc){
      return new Promise((resolve)=>{
        if (doc.defaultView && doc.defaultView.ApexCharts) return resolve(doc.defaultView.ApexCharts);
        const s = doc.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/apexcharts";
        s.onload = ()=> resolve(doc.defaultView.ApexCharts);
        doc.head.appendChild(s);
      });
    }
    //직원현황
    function renderWorkersChartsHTML5({ doc, mountId='workersWrap', url, params }){
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      // 스켈레톤
      const leftEl  = doc.getElementById('workerChartLeft')  || (()=>{ const d = doc.createElement('div'); d.id='workerChartLeft';  mount.appendChild(d); return d; })();
      const rightEl = doc.getElementById('workerChartRight') || (()=>{ const d = doc.createElement('div'); d.id='workerChartRight'; mount.appendChild(d); return d; })();
      leftEl.innerHTML  = '<div style="padding:8px" class="text-muted">인원 데이터 로딩중…</div>';
      rightEl.innerHTML = '<div style="padding:8px" class="text-muted">급여 데이터 로딩중…</div>';

      // 공통 유틸
      const months = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
      const lastNonZero = (arr) => { for (let i=arr.length-1;i>=0;i--){ const v=Number(arr[i]??0); if(!Number.isNaN(v)&&v!==0) return {idx:i,val:v}; } return {idx:-1,val:0}; };
      const avgInfo = (arr) => {
        const { idx } = lastNonZero(arr);
        const monthsCount = idx >= 0 ? idx + 1 : 0;
        const total = arr.slice(0, monthsCount).reduce((s,v)=> s + (Number(v)||0), 0);
        return { monthsCount, avg: monthsCount ? (total / monthsCount) : 0, lastIdx: idx };
      };


      // 서버에서 데이터 2종 가져와 각각 렌더
      // 1) WORKERS (인원)
      $.ajax({ url, data: { ...params, flag: 'WORKERS' }, dataType: 'json' })
        .done(async (res)=>{
          const ApexCharts = await ensureApex(doc);
          const rows = Array.isArray(res?.workers) ? res.workers : [];
          if (!rows.length){ leftEl.innerHTML = '<div class="text-muted" style="padding:8px">인원 데이터가 없습니다.</div>'; return; }

          // TITLE 기준으로 배열 만들기
          const pick = (title)=> rows.find(r=> r.TITLE === title) || {};
          const to12 = (r)=> [r.JAN,r.FEB,r.MAR,r.APR,r.MAY,r.JUN,r.JUL,r.AUG,r.SEP,r.OCT,r.NOV,r.DEC].map(v=>Number(v||0));

          const series = [
            { name:'정규직',     data: to12(pick('정규직')) },
            { name:'사업소득자', data: to12(pick('사업소득')) },
            { name:'일용직',     data: to12(pick('일용직')) },
            { name:'기타소득',   data: to12(pick('기타소득')) },
          ];
          const avgInfoList = series.map(s => avgInfo(s.data));

          const optsLeft = {
            series,
            chart: { type:'bar', height:355, toolbar:{ show:false } }, // ← 툴바 제거
            plotOptions: { bar:{ horizontal:false, columnWidth:'55%', endingShape:'rounded' } },
            dataLabels: { enabled:false },
            stroke:{ show:true, width:2, colors:['transparent'] },
            xaxis:{ categories: months },
            //tooltip:{ y:{ formatter:(v)=> `${Number(v||0)} 명` } },
            tooltip: { enabled:false },   // ← 마우스 오버 툴팁 제거
            states: { hover: { filter: { type: 'none' } } },  //마우스오버 시 시리즈 밝기 변화까지 없애
            fill:{ opacity:1 },
            legend:{
              position:'top',
              horizontalAlign:'left',
              formatter: (val, opts) => {
                const i = opts.seriesIndex;
                const { monthsCount, avg } = avgInfoList[i];
                const label =  `평균`;
                return `${val} · ${label} ${avg.toFixed(1)}명`;
              }
            }
          };
          leftEl.innerHTML = '';
          new ApexCharts(leftEl, optsLeft).render();
        })
        .fail(()=>{ leftEl.innerHTML = '<div class="text-danger" style="padding:8px">인원 데이터를 불러오지 못했습니다.</div>'; });

      // 2) SALARYS (금액)
      $.ajax({ url, data: { ...params, flag: 'SALARYS' }, dataType: 'json' })
        .done(async (res)=>{
          const ApexCharts = await ensureApex(doc);
          const rows = Array.isArray(res?.salarys) ? res.salarys : [];
          if (!rows.length){ rightEl.innerHTML = '<div class="text-muted" style="padding:8px">급여 데이터가 없습니다.</div>'; return; }

          const pick = (title)=> rows.find(r=> r.TITLE === title) || {};
          const to12 = (r)=> [r.JAN,r.FEB,r.MAR,r.APR,r.MAY,r.JUN,r.JUL,r.AUG,r.SEP,r.OCT,r.NOV,r.DEC].map(v=>Number(v||0));

          const series = [
            { name:'정규직',     data: to12(pick('정규직급여')) },
            { name:'사업소득자', data: to12(pick('사업소득급여')) },
            { name:'일용직',     data: to12(pick('일용직급여')) },
            { name:'기타소득',   data: to12(pick('기타소득급여')) },
          ];
          const avgInfoList = series.map(s => avgInfo(s.data));

          const optsRight = {
            series,
            chart: { type:'bar', height:350, stacked:true, toolbar:{ show:false } },
            plotOptions: {
              bar: {
                horizontal:true,
                dataLabels:{ total:{ enabled:true, offsetX:0, style:{ fontSize:'10px', fontWeight:900 } } }
              }
            },
            stroke:{ width:1, colors:['#fff'] },

            // ✅ 여기! categories는 xaxis에 둡니다 (가로형에서도)
            xaxis:{
              categories: months,                  // ← 월 라벨(y축에 표시됨)
              labels:{                             // ← 값 축(x축 숫자 포맷)
                formatter:(v)=>{
                  const num = Number(v);
                  return Number.isFinite(num) ? `${num.toLocaleString()}만원` : '';
                }
              }
            },

            // yaxis에는 별도 categories 주지 않습니다
            yaxis:{ labels:{ show:true } },
            tooltip: { enabled:false },   // ← 마우스 오버 툴팁 제거
            states: { hover: { filter: { type: 'none' } } },  //마우스오버 시 시리즈 밝기 변화까지 없애
            fill:{ opacity:1 },
            legend:{
              position:'top',
              horizontalAlign:'left',
              formatter:(val, opts)=>{
                const i = opts.seriesIndex;
                const { monthsCount, avg } = avgInfoList[i];
                const trunc = Math.floor(avg);   // ★ 평균도 절사
                return `${val} · ${Math.round(avg).toLocaleString()}만원`;
              }
            }
          };
          rightEl.innerHTML = '';
          new ApexCharts(rightEl, optsRight).render();
        })
        .fail(()=>{ rightEl.innerHTML = '<div class="text-danger" style="padding:8px">급여 데이터를 불러오지 못했습니다.</div>'; });
    }
    //주주현황
    function renderStockSectionHTML5({ doc, mountId='stockWrap', url, params }) {
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      // 레거시 숨김(옵션)
      const legacy = doc.querySelector('#stockHolders, #legacyStockTable');
      if (legacy) legacy.style.display = 'none';

      // 스타일 1회 주입
      if (!doc.getElementById('stock-style')) {
        doc.head.insertAdjacentHTML('beforeend', `
          <style id="stock-style">
            /* ========== 스코프: #stockWrap ========== */
            #stockWrap .stock-grid{
              display:grid; grid-template-columns: 1fr 300px; gap:12px; align-items:start; max-width:100%;
              box-sizing:border-box;
            }
            @media print{ #stockWrap .stock-grid{ grid-template-columns: 1fr 300px; } }

            #stockWrap .stock-card{
              border:1px solid #e9ecef; border-radius:12px; background:#fff; max-width:100%;
              break-inside: avoid; page-break-inside: avoid;
            }
            #stockWrap .stock-card .card-body{ padding:8px 12px }
            #stockWrap .stock-title{ margin:0 0 8px; font-weight:700; color:#2f3f4a }

            #stockWrap .stock-table{ width:100%; table-layout:fixed; border-collapse:separate; border-spacing:0 4px; break-inside: avoid; page-break-inside: avoid; }
            #stockWrap .stock-table thead th{ font-size:13px; color:#5b6b7b; font-weight:600; padding:2px 8px; border-bottom:1px solid #eef1f4 }
            #stockWrap .stock-table tbody tr{ background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04); border-radius:10px; break-inside: avoid; page-break-inside: avoid; }
            #stockWrap .stock-table tbody td{ padding: 4px 8px; font-size:12.5px; line-height:1.1; vertical-align:middle }
            #stockWrap .stock-table tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
            #stockWrap .stock-table tbody tr td:last-child { border-top-right-radius:10px; border-bottom-right-radius:10px }
            #stockWrap .stock-table .name-cell{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
            #stockWrap .stock-table col:nth-child(1){ width:48px }
            #stockWrap .stock-table col:nth-child(2){ width:100px }
            #stockWrap .stock-table col:nth-child(3){ width:80px }
            #stockWrap .stock-table col:nth-child(4){ width:100px }

            #stockWrap .text-end{ text-align:right } 
            #stockWrap .text-center{ text-align:center }
            #stockWrap .tx-14{ font-size:13px } 
            #stockWrap .tx-13{ font-size:12px } 
            #stockWrap .text-muted{ color:#6b7a8c }

            #stockWrap .avatar{ display:inline-grid; place-items:center; color:#fff; font-weight:800; border-radius:999px; width:30px; height:30px; font-size:12px; -webkit-print-color-adjust:exact; print-color-adjust:exact }
            #stockWrap .rel-major{  background:linear-gradient(135deg,#2dbd6e,#0aa352) }
            #stockWrap .rel-family{ background:linear-gradient(135deg,#6cc3ff,#3aa0e6) }
            #stockWrap .rel-corp{   background:linear-gradient(135deg,#a78bfa,#7c3aed) }
            #stockWrap .rel-etc{    background:linear-gradient(135deg,#e8c05a,#c7961e) }

            #stockWrap .chip{ padding:3px 8px; border-radius:6px; font-size:11px; font-weight:600; background:#edf1f5; color:#6b7a8c }

            #stockWrap .apexcharts-legend{ display:grid; grid-template-columns: repeat(2, auto); justify-content:start; column-gap:16px; row-gap:6px; }

            /* ====== 세법 안내 패널 ====== */
            #stockWrap .law-card{
              margin-top:10px; border:1px solid #f8d04a; border-radius:12px; background:linear-gradient(180deg,#fffbe6,#fffdf5);
              box-shadow:0 1px 0 rgba(0,0,0,.02), inset 0 0 0 1px rgba(255,255,255,.6);
              position:relative; overflow:hidden; break-inside:avoid; page-break-inside:avoid;
            }
            #stockWrap .law-card::before{
              content:""; position:absolute; left:0; top:0; bottom:0; width:8px;
              background:linear-gradient(180deg,#f59e0b,#facc15);
            }
            #stockWrap .law-body{ padding:14px 16px 14px 22px; color:#5b3a00 }
            #stockWrap .law-title{ display:flex; align-items:center; gap:8px; font-weight:800; color:#8a2c0d; margin:0 0 8px; }
            #stockWrap .law-title .ic{ width:22px; height:22px; border-radius:50%; background:#f59e0b; color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:900; box-shadow:0 2px 6px rgba(245,158,11,.35); }
            #stockWrap .law-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
            #stockWrap .law-sec{ background:#fff; border:1px solid #f1e5b9; border-radius:10px; padding:10px 12px; }
            #stockWrap .law-sec h4{ margin:0 0 6px; font-size:13px; color:#7a4a00 }
            #stockWrap .law-sec p{ margin:0; font-size:12.5px; line-height:1.6 }
            #stockWrap .law-badge{ display:inline-block; padding:0 8px; line-height:22px; border-radius:999px; border:1px solid #f59e0b; background:#fff; color:#8a2c0d; font-weight:800; margin:0 3px; }

            /* ── Compact 모드: 높이 최소화 ── */
            #stockWrap .law-card.compact{ margin-top:6px; border-radius:10px }
            #stockWrap .law-card.compact::before{ width:4px }
            #stockWrap .law-card.compact .law-body{ padding:8px 10px 8px 14px }
            #stockWrap .law-card.compact .law-title{ margin:0 0 6px; font-size:12px }
            #stockWrap .law-card.compact .law-title .ic{
              width:18px; height:18px; font-size:12px; box-shadow:none;
            }
            #stockWrap .law-card.compact .law-grid{
              grid-template-columns: repeat(2, minmax(0,1fr));
              gap:6px;
            }
            #stockWrap .law-card.compact .law-sec{ padding:6px 8px; border-radius:8px }
            #stockWrap .law-card.compact .law-sec h4{ margin:0 0 3px; font-size:12px }
            #stockWrap .law-card.compact .law-sec p{ margin:0; font-size:11.5px; line-height:1.4 }
            #stockWrap .law-card.compact .law-badge{
              line-height:18px; padding:0 6px; font-size:11px; margin:0 2px;
            }
      
            #stockWrap .table-box{ position:relative; --vr-width:24px; --vr-gap:8px; padding-left:calc(var(--vr-width) + 10px); }
            #stockWrap .table-box.v-compact{ --vr-width:22px; --vr-gap:4px; padding-left:calc(var(--vr-width) + 8px); }
            #stockWrap .v-ribbon{ position:absolute; left:0; top:var(--vr-gap); bottom:var(--vr-gap); width:var(--vr-width);
              background:linear-gradient(180deg,#f59e0b,#facc15); border-radius:8px; display:flex; align-items:center; justify-content:center;
              -webkit-print-color-adjust:exact; print-color-adjust:exact; box-shadow:0 1px 4px rgba(0,0,0,.05); }
            #stockWrap .v-ribbon span{ writing-mode:vertical-rl; text-orientation:upright; color:#fff; font-weight:900; font-size:11px; letter-spacing:.5px; }

            /* 세법 안내 카드(컴팩트) */

            #stockWrap .law-card .law-title{ margin:0 0 6px; font-size:12px; font-weight:800; color:#8a2c0d; display:flex; align-items:center; gap:6px; }
            #stockWrap .law-card .law-title .ic{ width:18px; height:18px; border-radius:50%; background:#f59e0b; color:#fff; display:flex; align-items:center; justify-content:center; font-size:12px; }

            /* 2×2 그리드 */
            #stockWrap .law-grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
            #stockWrap .law-sec{ background:#fff; border:1px solid #f1e5b9; border-radius:10px; padding:8px 10px; }
            #stockWrap .law-sec h4{ margin:0 0 4px; font-size:12px; color:#7a4a00; }
            #stockWrap .law-sec p{ margin:0; font-size:11.5px; line-height:1.45; }
            #stockWrap .law-badge{ display:inline-block; padding:0 6px; line-height:18px; border-radius:999px; border:1px solid #f59e0b; background:#fff; color:#8a2c0d; font-weight:800; }

            /* 와이드 리본: 배지 영역까지 포함되게 더 넓힘 */
            #stockWrap .table-box.v-wide{
              --vr-width: 88px;   /* ★ 기본 22~24px → 88px로 확장 */
              --vr-gap:   6px;    /* 상하 여백은 적당히 */
              padding-left: calc(var(--vr-width) + 12px);
            }
            /* 와이드일 때 세로 텍스트도 가독성 보정 */
            #stockWrap .table-box.v-wide .v-ribbon span{
              font-size: 12px;       /* 살짝 키움 */
              letter-spacing: .6px;
              line-height: 1.2;
            }
            /* 카드 공통(종전과 동일 가능) */

            #stockWrap .law-card.compact .law-body{ padding:8px 10px 8px 14px; color:#5b3a00 }


            /* 왼쪽 ‘굵은’ 테두리 추가 (카드 외곽) */
            #stockWrap .law-card.ribbon{
              border-left-width:6px;                 /* ← 굵기 조절: 5~8px 권장 */
              border-left-color:#e6b21a;             /* 약간 더 진한 톤 */
            }

            /* 리본은 카드 안쪽 패딩 박스에서 시작 → 굵은 테두리와 겹치지 않음 */
            #stockWrap .law-card.ribbon{
              --ribbon-w: 20px;
              --ribbon-gap: 6px;
            }
            #stockWrap .law-card.ribbon .law-body{
              padding-left: calc(var(--ribbon-w) + 16px);
            }
            #stockWrap .law-card.ribbon::before{
              content:"";
              position:absolute; left:0;             /* 패딩박스 기준이므로 외곽 border 바깥에 안겹침 */
              top:var(--ribbon-gap); bottom:var(--ribbon-gap);
              width:var(--ribbon-w);
              background:linear-gradient(180deg,#f59e0b,#facc15);
              border-radius:10px;
              box-shadow:0 1px 4px rgba(0,0,0,.06);
              z-index:0;
            }
            #stockWrap .law-card.ribbon::after{
              content: attr(data-vlabel);
              position:absolute; left:0;
              top:var(--ribbon-gap); bottom:var(--ribbon-gap);
              width:var(--ribbon-w);
              display:flex; align-items:center; justify-content:center;
              writing-mode:vertical-rl; text-orientation:upright;
              color:#fff; font-weight:900; font-size:12px; letter-spacing:.6px;
              pointer-events:none; z-index:1;
            }
            /* 카드 본체 */
            #stockWrap .law-card{
              position: relative;
              border: 1px solid #f8d04a;
              border-radius: 12px;
              background: linear-gradient(180deg,#fffbe6,#fffdf5);
              overflow: visible;                 /* ← 중요: 잘림 방지 */
            }

            /* 굵은 왼쪽 테두리 */
            #stockWrap .law-card.ribbon-border{
              --blw: 30px;   /* 굵은 보더 두께 */
              --v-gap: 6px;  /* 위/아래 여백 */
              border-left-width: var(--blw);
              border-left-color: #e6b21a;
            }

            /* 테두리 중앙의 세로 라벨 (배경 투명 + 대비 보정 + 최상단 레이어) */
            #stockWrap .law-card.ribbon-border::after{
              content: attr(data-vlabel);
              position: absolute;
              top: var(--v-gap);
              bottom: var(--v-gap);
              left: calc(-1 * var(--blw));
              width: var(--blw);

              display: flex; align-items: center; justify-content: center;
              writing-mode: vertical-rl; text-orientation: upright;

              background: transparent;           /* ← 투명 배경 */
              color: #ffffff;
              z-index: 3;                        /* ← 항상 위로 */
              pointer-events: none;
              font-weight:900; font-size:12px; letter-spacing:.6px;

            }
            /* 미세 위치 보정(필요 시): 중앙으로 1px 더 이동(음수는 왼쪽, 양수는 오른족)  */
            #stockWrap .law-card.ribbon-border::after{ transform: translateX(2px); }        
            /* 1px만 더 왼쪽으로 
            #stockWrap .law-card.ribbon-border::after { transform: translateX(-1px); }

            /* 2px 오른쪽으로 (음수는 왼쪽) 
            #stockWrap .law-card.ribbon-border::after { transform: translateX(2px); }
            */

            /* 본문은 기존대로 padding 유지(필요시 살짝 여유) */
            #stockWrap .law-card .law-body { padding: 8px 12px; color:#5b3a00; }

            /* 반응형 & 인쇄 */
            @media (max-width: 720px){ #stockWrap .law-grid-2{ grid-template-columns:1fr; } }
        
            @media print{
              #stockWrap .law-card,
              #stockWrap .law-card::before,
              #stockWrap .law-card::after{
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }

              /* 카드 배경 단색 + 그림자 제거 */
              #stockWrap .law-card{
                background-color:#fff;
                background-image:none;
                border-color:#e6b21a;
                box-shadow:none;
              }

              /* 리본-보더 방식만 사용 (값 하나로 통일) */
              #stockWrap .law-card.ribbon-border{ --blw:14px; --v-gap:6px; }

              #stockWrap .law-card.ribbon-border::after{
                left: calc(-1 * var(--blw));
                width: var(--blw);
                top: var(--v-gap);
                bottom: var(--v-gap);
                background:#e6b21a;
                color:#fff;
                text-shadow:none;
                -webkit-text-stroke:0;
                box-shadow:none;
                transform: translateX(1px); /* ← 여기만 건드리면 됨 */
                z-index:3;
              }
              /* 그리드 강제 2열 (다른 규칙보다 우선하도록 !important) */
      #stockWrap .law-grid-2{
        display:grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        column-gap: 8px !important;
        row-gap: 8px !important;
      }

      /* 각 카드가 페이지 중간에 쪼개지지 않도록 */
      #stockWrap .law-sec{
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      /* 제목/본문 줄바꿈 안정화(옵션) */
      #stockWrap .law-sec h4,
      #stockWrap .law-sec p{
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }
      /* 리본-보더 방식 통일 */
      #stockWrap .law-card.ribbon-border{ --blw:14px; --v-gap:6px; border-left-color:#e6b21a; }

      #stockWrap .law-card.ribbon-border::after{
        left: calc(-1 * var(--blw));
        width: var(--blw);
        /* 위/아래를 살짝 확장해 미세한 단차 제거 */
        top: calc(var(--v-gap) - 1px);
        bottom: calc(var(--v-gap) - 1px);

        background:#e6b21a;       /* 보더색과 동일 */
        color:#fff;
        text-shadow:none; -webkit-text-stroke:0; box-shadow:none;

        /* 카드 모서리와 형태 일치 (둥글림 수치는 카드와 동일/혹은 -1px) */
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;

        /* 프린트 렌더러에서 줄 번짐 방지 */
        transform:none; 
        z-index:3;
      }
      /* 혹시 다른 프린트 규칙에서 1열로 덮어쓰는 걸 막기 위해 */
      #stockWrap .law-grid{ grid-template-columns: repeat(2, 1fr) !important; }
              /* 내부 박스도 단색/얇은 라인 */
              #stockWrap .law-sec{
                background:#fff;
                border-color:#f1e5b9;
                box-shadow:none;
              }
            }
          </style>
        `);
      }

      // 스켈레톤
      mount.innerHTML = `
        <div class="stock-card">
          <div class="card-body">
            <div class="stock-grid">
              <div>
                <div id="stockTableWrap" class="table-responsive">
                  <div style="padding:12px"><span class="spinner"></span> 로딩중…</div>
                </div>
              </div>
              <div id="stockSideCard" class="stock-card">
                <div class="card-body">
                  <div class="text-muted tx-13" style="margin-bottom:8px">총자본금</div>
                  <h3 id="stockTotalText" class="tx-14" style="font-size:18px;margin:0 0 10px"></h3>
                  <div id="chartC"></div>
                </div>
              </div>
            </div>
          </div>
        </div>`;

      const tableWrap = doc.getElementById('stockTableWrap');
      const totalEl   = doc.getElementById('stockTotalText');
      const nf = new Intl.NumberFormat('ko-KR');

      const relClass = (rel='')=>{
        if (rel.includes('지배')) return 'rel-major';
        if (rel.includes('법인')) return 'rel-corp';
        if (['배우자','자녀','부모','형제','손자','조부모','친족'].some(k=>rel.includes(k))) return 'rel-family';
        return 'rel-etc';
      };

      function ensureApex(doc){
        return new Promise((resolve)=>{
          if (doc.defaultView.ApexCharts) return resolve(doc.defaultView.ApexCharts);
          const s = doc.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/apexcharts";
          s.onload = ()=>resolve(doc.defaultView.ApexCharts);
          doc.head.appendChild(s);
        });
      }

      // 세법 안내 패널 HTML
      function appendLawPanel() {
        if (doc.getElementById('law-card-mounted')) return; // 중복 방지
        const lawHTML = `
        <div class="law-card ribbon-border" data-vlabel="세법상 주요 규제·부담">
      
          <div class="law-body">
            <div class="law-grid-2">
              <div class="law-sec">
                <h4>지배주주</h4>
                <p>출자총액의 1% 이상 보유 + 특수관계인 합계가 최다인 주주. <span class="law-badge">시행령 제43조</span> 상여금 지급 제한 적용.</p>
              </div>
              <div class="law-sec">
                <h4>과점주주</h4>
                <p>1인+특수관계인 보유지분이 50% 초과 & 권리 실질행사. <span class="law-badge">제2차 납세의무</span>·<span class="law-badge">간주취득세</span> 가능.</p>
              </div>
              <div class="law-sec">
                <h4>과점주주의 제2차납세의무</h4>
                <p>법인 재산으로 국세 충당 부족 시, 납세의무 성립일 현재 출자자가 부족액의 출자지분율에 해당하는 금액을 부담.</p>
              </div>
              <div class="law-sec">
                <h4>간주취득세</h4>
                <p>주식·지분 취득으로 과점주주가 되면 과세대상자산을 취득한 것으로 간주, <span class="law-badge">증가 지분율 × 2%</span> 납부.</p>
              </div>
            </div>
          </div>
        </div>`;    
        const lawHTML2 = `
          <div id="law-card-mounted" class="law-card">
            <div class="table-box v-compact">
              <div class="v-ribbon"><span>주주의 세법상 규제 유의사항</span></div>
              <div class="stock-table">
                <div class="law-sec">
                  <h4>지배주주</h4>
                  <p>1% 이상의 주식 등을 소유한 주주 등으로서, 특수관계자와의 소유 주식 등의 합계가 가장 많은 경우.
                  <span class="law-badge">§ 시행령 제43조 상여금 지급 제한 적용</span>
                </div>
                <div class="law-sec">
                  <h4>과점주주</h4>
                  <p>주주와 그 특수관계인의 주식합계가 발행주식총수의 50%를 초과하고 그 권리를 실질적으로 행사하는 자.
                  <span class="law-badge">제2차 납세의무</span> <span class="law-badge">간주취득세</span></p>
                </div>
                <div class="law-sec">
                  <h4>출자자의 제2차납세의무</h4>
                  <p>법인의 재산으로 법인에 부과된 국세 등을 충당하여도 부족한 경우,
                  그 국세의 납세의무 성립일 현재 출자자 등은 그 부족액에 대해 제2차 납세의무를 부담.</p>
                </div>
                <div class="law-sec">
                  <h4>간주취득세</h4>
                  <p>주식취득으로 과점주주(설립시 과점주주 제외)가 된 때, 부동산·기계장비·골프/콘도 회원권 등을 취득한 것으로 간주.
                  <span class="law-badge">증가한 지분율 × 2%</span> 납부</p>
                </div>
              </div>
            </div>
          </div>`;
        mount.insertAdjacentHTML('beforeend', lawHTML);
      }

      // AJAX
      $.ajax({ url, data: params, dataType:'json' })
        .done(async (res)=>{
          const raw = Array.isArray(res?.stockHolders) ? res.stockHolders : [];
          const total = Number(res?.stockTotal) || 0;
          if (totalEl) totalEl.textContent = nf.format(total);

          if (!raw.length){
            tableWrap.innerHTML = `<div class="text-muted">표시할 주주 정보가 없습니다.</div>`;
            appendLawPanel();
            return;
          }

          // 정렬
          const rowsAll = [...raw].sort((a,b) => (Number(b.sthRate)||0) - (Number(a.sthRate)||0));
          const rowsTop6 = rowsAll.slice(0, 6);

          // 표 렌더
          const trs = rowsAll.map(r=>{
            const rel = String(r.sthRelation || '기타');
            const cls = relClass(rel);
            const letter = rel.slice(0,1) || '기';
            const cnt = nf.format(Number(r.sthCnt)||0);
            const amt = nf.format(Number(r.sthTotalValue)||0);
            return `
              <tr>
                <td class="text-center" style="width:48px"><div class="avatar ${cls}">${letter}</div></td>
                <td><p class="tx-14 font-weight-semibold text-dark name-cell" style="margin:0">${r.sthName||''}</p></td>
                <td class="text-end"><span class="chip">${cnt} 주</span></td>
                <td class="text-end"><span class="text-muted tx-13">${amt}</span></td>
              </tr>`;
          }).join('');

          tableWrap.innerHTML = `
            <table class="stock-table">
              <colgroup><col><col><col><col></colgroup>
              <thead>
                <tr><th></th><th>이름</th><th class="text-end">주식수</th><th class="text-end">주식금액</th></tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>`;

          // 차트
          const labels = rowsTop6.map(r => r.sthName || '');
          const series = rowsTop6.map(r => Math.max(0, Number(r.sthRate)||0));
          const ApexCharts = await ensureApex(doc);
          const chartEl = doc.getElementById('chartC');
          if (chartEl && ApexCharts){
            const chart = new ApexCharts(chartEl, {
              chart: { type:'donut', height: 220 },
              series, labels,
              dataLabels:{ enabled:false },
              legend: {
                position: 'bottom', horizontalAlign: 'left',
                formatter: (val, opts) => `<span class="legend-label">${val}</span> <span class="legend-val">${opts.w.globals.series[opts.seriesIndex]}%</span>`
              },
              plotOptions:{ pie:{ donut:{ size:'62%' }, startAngle:-90, endAngle:270 } },
              fill:{ type:'gradient' },
              tooltip: { enabled:false },
              states: { hover: { filter: { type: 'none' } } },
              responsive:[{ breakpoint: 9999, options:{ chart:{ width:'100%', height:240 }}}]
            });
            chart.render();
          }

          // 세법 안내 패널 붙이기
          appendLawPanel();
        })
        .fail(()=>{
          tableWrap.innerHTML = `<div class="text-danger">주주 데이터를 불러오지 못했습니다.</div>`;
          appendLawPanel();
        });
    }
    // 주주 12명 이상이면 상위 12명 + '기타'로 묶어서 표/도넛 표시
    function renderStockSectionHTML5_only6({ doc, mountId='stockWrap', url, params }) {
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      const legacy = doc.querySelector('#stockHolders, #legacyStockTable');
      if (legacy) legacy.style.display = 'none';

      if (!doc.getElementById('stock-style')) {
        doc.head.insertAdjacentHTML('beforeend', `
        <style id="stock-style">
          .stock-grid{ display:grid; grid-template-columns: 1fr 300px; gap:12px; align-items:start; max-width:100%; box-sizing:border-box; }
          @media print{ .stock-grid{ grid-template-columns: 1fr 280px; } }
          .stock-card{ border:1px solid #e9ecef; border-radius:12px; background:#fff; max-width:100% }
          .stock-card .card-body{ padding:8px 12px }
          .stock-title{ margin:0 0 8px; font-weight:700; color:#2f3f4a }
          .stock-table{ width:100%; table-layout:fixed; border-collapse:separate; border-spacing:0 4px }
          .stock-table thead th{ font-size:13px; color:#5b6b7b; font-weight:600; padding:2px 8px; border-bottom:1px solid #eef1f4 }
          .stock-table tbody tr{ background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04); border-radius:10px }
          .stock-table tbody td{ padding: 4px 8px; font-size:12.5px; line-height:1.1; vertical-align:middle }
          .stock-table tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
          .stock-table tbody tr td:last-child { border-top-right-radius:10px; border-bottom-right-radius:10px }
          .stock-table .name-cell{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
          .stock-table col:nth-child(1){ width:48px }
          .stock-table col:nth-child(2){ width:100px }
          .stock-table col:nth-child(3){ width:80px }
          .stock-table col:nth-child(4){ width:100px }
          .text-end{ text-align:right } .text-center{ text-align:center }
          .tx-14{ font-size:13px } .tx-13{ font-size:12px } .text-muted{ color:#6b7a8c }
          .avatar{ display:inline-grid; place-items:center; color:#fff; font-weight:800; border-radius:999px;
                  width:30px; height:30px; font-size:12px; -webkit-print-color-adjust:exact; print-color-adjust:exact }
          .rel-major{  background:linear-gradient(135deg,#2dbd6e,#0aa352) }
          .rel-family{ background:linear-gradient(135deg,#6cc3ff,#3aa0e6) }
          .rel-corp{   background:linear-gradient(135deg,#a78bfa,#7c3aed) }
          .rel-etc{    background:linear-gradient(135deg,#e8c05a,#c7961e) }
          .badge{ padding:3px 8px; border-radius:6px; font-size:11px; font-weight:600 }
          .badge.bg-light{ background:#edf1f5; color:#6b7a8c }
          .apexcharts-legend{
            display:grid !important; grid-template-columns: repeat(2, auto);
            justify-content:start; column-gap:16px; row-gap:6px;
          }
        </style>`);
      }

      mount.innerHTML = `
        <div class="stock-card">
          <div class="card-body">
            <div class="stock-grid">
              <div>
                <div id="stockTableWrap" class="table-responsive">
                  <div style="padding:12px"><span class="spinner"></span> 로딩중…</div>
                </div>
              </div>
              <div id="stockSideCard" class="stock-card">
                <div class="card-body">
                  <div class="text-muted tx-13" style="margin-bottom:8px">총자본금</div>
                  <h3 id="stockTotalText" class="tx-14" style="font-size:18px;margin:0 0 10px"></h3>
                  <div id="chartC"></div>
                </div>
              </div>
            </div>
          </div>
        </div>`;

      const tableWrap = doc.getElementById('stockTableWrap');
      const totalEl   = doc.getElementById('stockTotalText');
      const nf = new Intl.NumberFormat('ko-KR');

      const relClass = (rel='')=>{
        if (rel.includes('지배')) return 'rel-major';
        if (rel.includes('법인')) return 'rel-corp';
        if (['배우자','자녀','부모','형제','손자','조부모','친족'].some(k=>rel.includes(k))) return 'rel-family';
        return 'rel-etc';
      };

      function ensureApex(doc){
        return new Promise((resolve)=>{
          if (doc.defaultView.ApexCharts) return resolve(doc.defaultView.ApexCharts);
          const s = doc.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/apexcharts";
          s.onload = ()=>resolve(doc.defaultView.ApexCharts);
          doc.head.appendChild(s);
        });
      }

      $.ajax({ url, data: params, dataType:'json' })
        .done(async (res)=>{
          const rows = Array.isArray(res?.stockHolders) ? res.stockHolders : [];
          const total = Number(res?.stockTotal) || 0;
          if (totalEl) totalEl.textContent = nf.format(total);

          if (!rows.length){
            tableWrap.innerHTML = `<div class="text-muted">표시할 주주 정보가 없습니다.</div>`;
            return;
          }

          const sorted = [...rows].sort((a,b) => (Number(b.sthRate)||0) - (Number(a.sthRate)||0));

          // === 변경된 규칙 ===
          const ETC_THRESHOLD = 12; // 전체 주주 12명 이상이면 '기타' 생성
          const TOP_N = 12;         // 상위 12명 + 기타

          let rowsUse;
          if (sorted.length >= ETC_THRESHOLD) {
            rowsUse = sorted.slice(0, TOP_N);
            const rest = sorted.slice(TOP_N);
            const etc = {
              sthName: '기타',
              sthRelation: '기타',
              sthCnt: rest.reduce((s,r)=> s + (Number(r.sthCnt)||0), 0),
              sthTotalValue: rest.reduce((s,r)=> s + (Number(r.sthTotalValue)||0), 0),
              sthRate: rest.reduce((s,r)=> s + (Number(r.sthRate)||0), 0),
              isEtc: true,
            };
            rowsUse.push(etc);
          } else {
            // 12명 미만이면 전원 개별 표시(기타 없음)
            rowsUse = sorted;
          }
          // === /변경된 규칙 ===

          const trs = rowsUse.map(r=>{
            const rel = String(r.sthRelation || '기타');
            const cls = r.isEtc ? 'rel-etc' : relClass(rel);
            const letter = r.isEtc ? '기' : rel.slice(0,1);
            const cnt = nf.format(Number(r.sthCnt)||0);
            const amt = nf.format(Number(r.sthTotalValue)||0);
            return `
              <tr>
                <td class="text-center" style="width:48px">
                  <div class="avatar ${cls}">${letter}</div>
                </td>
                <td><p class="tx-14 font-weight-semibold text-dark name-cell" style="margin:0">${r.sthName||''}</p></td>
                <td class="text-end"><span class="badge bg-light">${cnt} 주</span></td>
                <td class="text-end"><span class="text-muted tx-13">${amt}</span></td>
              </tr>`;
          }).join('');

          tableWrap.innerHTML = `
            <table class="stock-table">
              <colgroup><col><col><col><col></colgroup>
              <thead>
                <tr>
                  <th></th>
                  <th>이름</th>
                  <th class="text-end">주식수</th>
                  <th class="text-end">주식금액</th>
                </tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>`;

          const labels = rowsUse.map(r => r.sthName || '');
          const series = rowsUse.map(r => Math.max(0, Number(r.sthRate)||0));
          const ApexCharts = await ensureApex(doc);
          const chartEl = doc.getElementById('chartC');
          if (chartEl && ApexCharts){
            const chart = new ApexCharts(chartEl, {
              chart: { type:'donut', height: 220 },
              series, labels,
              dataLabels:{ enabled:false },
              legend: {
                position: 'bottom',
                horizontalAlign: 'left',
                formatter: (val, opts) =>
                  `<span class="legend-label">${val}</span>
                  <span class="legend-val">${opts.w.globals.series[opts.seriesIndex]}%</span>`
              },
              plotOptions:{ pie:{ donut:{ size:'62%' }, startAngle:-90, endAngle:270 } },
              fill:{ type:'gradient' },
              tooltip: { enabled:false },
              states: { hover: { filter: { type: 'none' } } },
              responsive:[{ breakpoint: 9999, options:{ chart:{ width:'100%', height:240 }}}]
            });
            chart.render();
          }
        })
        .fail(()=>{
          tableWrap.innerHTML = `<div class="text-danger">주주 데이터를 불러오지 못했습니다.</div>`;
        });
    }

    function renderExecSectionHTML5({ doc, mountId='execWrap', url, params }) {
      const el = doc.getElementById(mountId);
      if (!el) return;

      // 스타일 1회 주입 (필수 것만)
      const STYLE_ID = 'exec-style';
      if (!doc.getElementById(STYLE_ID)) {
        const css = `
          <style id="${STYLE_ID}">
            #${mountId} .exec-wrap{ font-size:12.5px }
            #${mountId} .notes{ margin-top:10px; padding:8px 10px 12px; color:#6a756e; background:#f6f9f7; border:1px solid #e6eee9; border-radius:8px }

            #${mountId} .tbl{ width:100%; border-collapse:separate; border-spacing:0 6px }
            #${mountId} .tbl thead th{ font-size:13px; color:#5b6b7b; font-weight:600; padding:6px 8px; border-bottom:1px solid #eef1f4; text-align:center }
            #${mountId} .tbl tbody tr{ background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04); border-radius:10px }
            #${mountId} .tbl tbody td{ padding:8px; line-height:1.35; text-align:center }
            #${mountId} .tbl tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
            #${mountId} .tbl tbody tr td:last-child { border-top-right-radius:10px; border-bottom-right-radius:10px }

            #${mountId} .avatar{ display:inline-grid; place-items:center; width:30px; height:30px; color:#fff; font-weight:800; font-size:12px; border-radius:999px }
            #${mountId} .role-ceo{ background:#0aa352 }
            #${mountId} .role-director{ background:#3aa0e6 }
            #${mountId} .role-auditor{ background:#c7961e }
            #${mountId} .role-default{ background:#7a8791 }

            #${mountId} .badge{ padding:3px 8px; border-radius:6px; font-size:11px; font-weight:600; display:inline-block }
            #${mountId} .badge.light{ background:#edf1f5; color:#6b7a8c }
            #${mountId} .badge.danger{ background:#ffe3e3; color:#b42318 }

            #${mountId} .remain{ width:150px; display:flex; flex-direction:column; align-items:flex-end; gap:4px }
            #${mountId} .remain .num{ font-weight:700; color:#545f6d }
            #${mountId} .progress{ width:130px; height:6px; background:#e9eef3; border-radius:999px; overflow:hidden }
            #${mountId} .progress > i{ display:block; height:100%; background:#bcd6ff }
          </style>
        `;
        (doc.head || doc.documentElement).insertAdjacentHTML('beforeend', css);
      }

      // 스켈레톤
      el.innerHTML = `
        <div class="exec-wrap">
          <div class="table-holder">로딩중…</div>
          <div id="execNotes" class="notes">
            ※ 등기 연임서류: 주주명부, 인감증명서, 주민등록초본, 정관사본<br>
            ※ 연임 지연 시 상법 제635조에 따라 과태료 500만원 이하 부과 가능
          </div>
        </div>
      `;
      const tableHolder = el.querySelector('.table-holder');

      // 유틸
      const fmtDate = s => s ? `${s.slice(0,4)}년 ${s.slice(5,7)}월 ${s.slice(8,10)}일` : '';
      const clamp = (n,min=0,max=100)=> Math.max(min, Math.min(max, n|0));

      $.ajax({ url, data: params, dataType: 'json' })
        .done(res => {
          const rows = Array.isArray(res?.execs) ? res.execs : [];

          // 3명 이상이면 노트 숨김
          const notesEl = el.querySelector('#execNotes');
          if (notesEl) notesEl.style.display = rows.length > 2 ? 'none' : '';

          if (!rows.length) {
            tableHolder.innerHTML = `<div style="color:#6b7a8c">표시할 임원 데이터가 없습니다.</div>`;
            return;
          }

          const trs = rows.map(e => {
            const role = String(e.execflag || '');
            const roleClass =
              role.includes('대표') ? 'role-ceo' :
              role.includes('감사') ? 'role-auditor' :
              role.includes('사내') ? 'role-director' : 'role-default';

            const badge = (e.badgeColorPass === 'danger') ? 'danger' : 'light';
            const remainDD = Number(e.remainDD || 0);
            const rate = clamp(Number(e.passedRate || 0));

            return `
              <tr>
                <td><div class="avatar ${roleClass}">${role.slice(0,1)}</div></td>
                <td>${role}</td>
                <td>${e.execName || ''}</td>
                <td><span class="badge ${badge}">${e.txtPass || ''}</span></td>
                <td>${fmtDate(e.exec_regDate)}</td>
                <td>
                  <div class="remain">
                    <span class="num">${remainDD}일</span>
                    <div class="progress"><i style="width:${rate}%"></i></div>
                  </div>
                </td>
                <td>${fmtDate(e.duedate)}</td>
              </tr>
            `;
          }).join('');

          tableHolder.innerHTML = `
            <table class="tbl">
              <thead>
                <tr>
                  <th></th>
                  <th>직책</th>
                  <th>이름</th>
                  <th>경과여부</th>
                  <th>취임일</th>
                  <th>잔여임기일</th>
                  <th>등기만료일</th>
                </tr>
              </thead>
              <tbody>${trs}</tbody>
            </table>
          `;
        })
        .fail(() => {
          const notesEl = el.querySelector('#execNotes');
          if (notesEl) notesEl.style.display = '';
          tableHolder.innerHTML = `<div style="color:#b42318">임원 데이터를 불러오지 못했습니다.</div>`;
        });
    }
    // 사업용계좌 개설현황 (클라이언트 렌더)
    function renderBizAccntSectionHTML5({ doc, mountId = 'bizAccntWrap', url, params = {} }) {
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      // 1) 스코프드 스타일(한 번만)
      const STYLE_ID = `${mountId}-style`;
      if (!doc.getElementById(STYLE_ID)) {
        const st = doc.createElement('style');
        st.id = STYLE_ID;
        st.textContent = `
        #${mountId} .biz-accnt-section{ background:#fff;border:1px solid #e6ece8;border-radius:10px;box-shadow:0 2mm 6mm rgba(0,0,0,.06); overflow:hidden }
        #${mountId} .ba-head{ display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#f7faf8,#eef4f0);border-bottom:1px solid #e6ece8;font-weight:800 }
        #${mountId} .ba-head .count{ font-weight:700;color:#374151;font-size:12px }
        #${mountId} table.ba{ width:100%; border-collapse:collapse; font-size:12.5px }
        #${mountId} table.ba th, #${mountId} table.ba td { border-top:1px solid #eef1f4; padding:8px 10px; text-align:center; }
        #${mountId} table.ba thead th { background:#f4f8f5; font-weight:700 }
        #${mountId} table.ba td.t-left { text-align:left }
        #${mountId} .muted{ color:#6b7280 }
        #${mountId} .empty{ padding:12px; color:#6b7280 }
        /* 인쇄 시 테이블 헤더 반복 & 잘림 방지 */
        #${mountId} .biz-accnt-section{ break-inside:avoid; page-break-inside:avoid }
        #${mountId} thead{ display:table-header-group }
        #${mountId} tfoot{ display:table-footer-group }
        `;
        doc.head.appendChild(st);
      }

      // 2) 로딩
      mount.innerHTML = `
        <div class="biz-accnt-section">
          <div class="ba-head">
            <div>사업용계좌 개설현황</div>
            <div class="count muted">불러오는 중…</div>
          </div>
          <div class="empty">데이터를 불러오는 중입니다.</div>
        </div>
      `;

      const $ = window.jQuery || window.$; // 페이지 전역 jQuery 사용

      // 3) 데이터 가져오기
      $.ajax({
        url,
        data: { ...params, flag: 'BIZ_ACCOUNTS' }, // 서버에서 이 flag로 JSON 응답 주도록
        dataType: 'json'
      }).done((res) => {
        // 서버가 HTML을 바로 주는 경우도 지원
        if (res && res.html) {
          mount.innerHTML = res.html;
          return;
        }

        if (!res || res.ok === false) {
          mount.innerHTML = `
            <div class="biz-accnt-section">
              <div class="empty">데이터를 불러오지 못했습니다.</div>
            </div>`;
          return;
        }

        const total = Number(res.total_cnt || 0);
        const rows = Array.isArray(res.rows) ? res.rows.slice(0, 3) : [];

        // 3줄 패딩
        while (rows.length < 3) {
          rows.push({ reg_no:'', acc_type:'', bank:'', acct:'', reg_dt:'' });
        }

        const trHTML = rows.map(r => `
          <tr>
            <td>${r.reg_no || ''}</td>
            <td>${r.acc_type || ''}</td>
            <td>${r.bank || ''}</td>
            <td class="t-left">${r.acct || ''}</td>
            <td>${r.reg_dt || ''}</td>
          </tr>
        `).join('');

        mount.innerHTML = `
          <div class="biz-accnt-section">
            <table class="ba">
              <thead>
                <tr>
                  <th style="width:150px">등록번호</th>
                  <th style="width:120px">납세계좌구분</th>
                  <th style="width:90px">은행명</th>
                  <th>계좌번호</th>
                  <th style="width:120px">등록일자</th>
                </tr>
              </thead>
              <tbody>
                ${trHTML}
              </tbody>
            </table>
          </div>
        `;
      }).fail(() => {
        mount.innerHTML = `
          <div class="biz-accnt-section">
            <div class="ba-head">
              <div>사업용계좌 개설현황</div>
              <div class="count muted">0건</div>
            </div>
            <div class="empty">데이터를 불러오지 못했습니다.</div>
          </div>
        `;
      });
    }
    function renderCashSectionHTML5({ doc, mountId='cashWrap', url, params }) {
        const wrap = doc.getElementById(mountId);
        if (!wrap) return;

        // 1. CSS 스타일 정의 (가로 배치 Flexbox 중심)
        if (!doc.getElementById('cash-style-v2')) {
            const st = doc.createElement('style');
            st.id = 'cash-style-v2';
            st.textContent = `
                #${mountId} .cash-card-container {
                    display: flex;
                    background: #fff;
                    border: 1px solid #e6ece8;
                    border-radius: 8px;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
                    overflow: hidden;
                    font-size: 13px;
                    color: #374151;
                }
                /* 3등분 레이아웃 */
                #${mountId} .cc-col {
                    flex: 1;
                    padding: 16px;
                    border-right: 1px solid #f0f4f2;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }
                #${mountId} .cc-col:last-child { border-right: none; }
                
                /* 헤더 타이틀 */
                #${mountId} .cc-label {
                    font-size: 11px;
                    color: #6b7280;
                    font-weight: 600;
                    margin-bottom: 6px;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                /* 메인 값 */
                #${mountId} .cc-value {
                    font-size: 15px;
                    font-weight: 700;
                    color: #111827;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                /* 보조 텍스트 (날짜 등) */
                #${mountId} .cc-sub {
                    font-size: 11px;
                    color: #9ca3af;
                    margin-top: 4px;
                }
                
                /* 상태 뱃지 */
                #${mountId} .badge {
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: 600;
                }
                #${mountId} .badge.blue { background: #eff6ff; color: #2563eb; }
                #${mountId} .badge.red { background: #fef2f2; color: #dc2626; }
                #${mountId} .badge.gray { background: #f3f4f6; color: #4b5563; }
                
                /* 가산세 금액 강조 */
                #${mountId} .danger-text { color: #dc2626; }
                #${mountId} .safe-text { color: #059669; }
            `;
            doc.head.appendChild(st);
        }

        const nf = new Intl.NumberFormat('ko-KR');

        // 2. 로딩 표시
        wrap.innerHTML = `
            <div class="cash-card-container" style="padding:20px; justify-content:center; color:#999;">
                데이터 로딩 중...
            </div>`;

        // 3. AJAX 요청
        $.ajax({ url, data: { ...(params||{}), flag:'CASH' }, dataType:'json' })
        .done(res => {
            if (!res.ok || !res.data) {
                wrap.innerHTML = `<div class="cash-card-container" style="padding:15px;">데이터 없음</div>`;
                return;
            }

            const d = res.data;
            
            // 데이터 가공
            const isTarget = d.is_target; // true/false
            const badgeClass = isTarget ? 'blue' : 'gray';
            const joinDate = d.join_date || '미가입';
            
            // 가산세 렌더링 헬퍼
            const renderPenalty = (title, info) => {
                if (!info) {
                    return `
                        <div class="cc-value safe-text">정상</div>
                        <div class="cc-sub">적발 내역 없음</div>
                    `;
                }
                return `
                    <div class="cc-value danger-text">
                        ${nf.format(info.amt)}원
                        <span class="badge red">적발</span>
                    </div>
                    <div class="cc-sub">거래일: ${info.date}</div>
                `;
            };

            // 4. HTML 조립 (가로형 카드)
            const html = `
                <div class="cash-card-container">
                    <div class="cc-col">
                        <div class="cc-label">📂 현금영수증 가맹현황 (${d.year || '-'})</div>
                        <div class="cc-value">
                            ${d.target_txt}
                            <span class="badge ${badgeClass}">${isTarget ? '의무' : '비대상'}</span>
                        </div>
                        <div class="cc-sub">가맹일자: ${joinDate}</div>
                    </div>

                    <div class="cc-col">
                        <div class="cc-label">🚫 발급거부 가산세</div>
                        ${renderPenalty('발급거부', d.refuse)}
                    </div>

                    <div class="cc-col">
                        <div class="cc-label">⚠️ 미발급 가산세</div>
                        ${renderPenalty('미발급', d.unissued)}
                    </div>
                </div>
            `;
            
            wrap.innerHTML = html;
        })
        .fail(() => {
            wrap.innerHTML = `<div class="cash-card-container" style="padding:15px; color:red;">통신 오류 발생</div>`;
        });
    }
    function renderCardsSectionHTML5({ doc, mountId='cardsWrap', url, params }) {
      const wrap = doc.getElementById(mountId);
      if (!wrap) return;

      // jQuery 확보
      const $ = (doc.defaultView && (doc.defaultView.jQuery || doc.defaultView.$)) || window.jQuery || window.$;
      if (!$) { wrap.innerHTML = `<div style="color:#b23;padding:10px">jQuery가 필요합니다.</div>`; return; }

      // 1) 통일 스타일(한 번만)
      if (!doc.getElementById('cards-style')) {
        const st = doc.createElement('style');
        st.id = 'cards-style';
        st.textContent = `
          #${mountId} .biz-accnt-section{ background:#fff;border:1px solid #e6ece8;border-radius:10px;box-shadow:0 2mm 6mm rgba(0,0,0,.06); overflow:hidden }
          #${mountId} .ba-head{ display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#f7faf8,#eef4f0);border-bottom:1px solid #e6ece8;font-weight:800 }
          #${mountId} .ba-head .count{ font-weight:700;color:#374151;font-size:12px }
          #${mountId} table.ba{ width:100%; border-collapse:collapse; font-size:12.5px }
          #${mountId} table.ba th, #${mountId} table.ba td { border-top:1px solid #eef1f4; padding:8px 10px; text-align:center; }
          #${mountId} table.ba thead th { background:#f4f8f5; font-weight:700 }
          #${mountId} table.ba td.t-left { text-align:left }
          #${mountId} .muted{ color:#6b7280 }
          #${mountId} .empty{ padding:12px; color:#6b7280 }
          /* 인쇄 시 테이블 헤더/푸터 반복 & 잘림 방지 */
          #${mountId} .biz-accnt-section{ break-inside:avoid; page-break-inside:avoid }
          #${mountId} thead{ display:table-header-group }
          #${mountId} tfoot{ display:table-footer-group }
          #${mountId} tfoot td { background:#fbfcfd; border-top:1px solid #e6ece8; padding:0 }
          #${mountId} .ba-notice{
            position:relative; display:flex; gap:12px; align-items:flex-start;
            margin:12px; padding:14px 16px 14px 18px;
            background:linear-gradient(180deg,#fffbe6,#fffdf5);
            border:1px solid #f8d04a; border-radius:12px;
            box-shadow:0 1px 0 rgba(0,0,0,.02), inset 0 0 0 1px rgba(255,255,255,.6);
          }
          #${mountId} .ba-notice::before{
            content:""; position:absolute; left:0; top:0; bottom:0; width:6px;
            background:linear-gradient(180deg,#f59e0b,#facc15);
            border-top-left-radius:12px; border-bottom-left-radius:12px;
          }
          #${mountId} .ba-notice .ic{
            flex:0 0 auto; width:26px; height:26px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            background:#f59e0b; color:#fff; font-weight:900; font-size:16px;
            box-shadow:0 2px 6px rgba(245,158,11,.35);
          }
          #${mountId} .ba-notice .txt{ font-size:12.5px; line-height:1.65; color:#5b3a00; }
          #${mountId} .ba-notice .badge{
            display:inline-block; padding:0 8px; line-height:22px;
            border-radius:999px; border:1px solid #f59e0b;
            background:#fff; color:#8a2c0d; font-weight:800; margin:0 3px;
          }
          @media print { #${mountId} .ba-notice{ box-shadow:none } }
        `;
        doc.head.appendChild(st);
      }

      const nf = new Intl.NumberFormat('ko-KR');

      const noticeHTML = `
        <tfoot>
          <tr>
            <!-- 4열 테이블이므로 colspan=4 -->
            <td colspan="4">
              <div class="ba-notice" role="note" aria-label="중요 안내">
                <div class="ic" aria-hidden="true">!</div>
                <div class="txt">
                  2026년부터는 홈택스에 등록되지 않은 카드는 부가가치세 신용카드 공제되지 않습니다.
                  업무와 관련하여 신용(체크)카드를 사용하는 경우 반드시
                  <span class="badge">사업용 신용카드</span>로 등록 신청하여 주시기 바랍니다.
                </div>
              </div>
            </td>
          </tr>
        </tfoot>`;

      const makeTable = (data) => {
        const rows = Array.isArray(data?.rows) ? data.rows : [];
        const hasRows = rows.length > 0;

        const body = hasRows
          ? rows.map(r => `
              <tr>
                <td>${r.card_co ?? ''}</td>
                <td class="t-left">${r.card_no ?? ''}</td>
                <td>${(r.use_cnt ?? r.use_cnt === 0) ? nf.format(r.use_cnt) + ' 건' : ''}</td>
                <td>${(r.use_amt ?? r.use_amt === 0) ? nf.format(r.use_amt) + ' 원' : ''}</td>
              </tr>`).join('')
          : `<tr><td colspan="4" class="muted">없음</td></tr>`;

        return `
          <div class="biz-accnt-section">
            <div class="ba-head"><div>신용(체크)카드 </div><div class="count">${hasRows ? `${rows.length}건` : '0건'}</div></div>
            <table class="ba">
              <thead>
                <tr>
                  <th style="width:120px">카드사</th>
                  <th>카드번호</th>
                  <th style="width:110px">사용건수</th>
                  <th style="width:140px">사용금액</th>
                </tr>
              </thead>
              <tbody>${body}</tbody>
              ${noticeHTML}
            </table>
          </div>`;
      };

      // 로딩 UI
      wrap.innerHTML = `
        <div class="biz-accnt-section">
          <div class="ba-head"><div>신용(체크)카드</div></div>
          <div class="empty">신용카드 데이터를 불러오는 중…</div>
        </div>`;

      // AJAX
      $.ajax({ url, data: { ...(params||{}), flag:'CARDS' }, dataType:'json' })
        .done(res => {
          if (!res?.ok || !res?.cards) {
            // 빈 데이터도 표 골격 + notice 포함
            wrap.innerHTML = makeTable({ rows: [] });
            return;
          }
          wrap.innerHTML = makeTable(res.cards);
        })
        .fail(() => {
          // 실패 시에도 표 골격 + notice 포함
          wrap.innerHTML = makeTable({ rows: [] });
        });
    }

    /* ======================= 2. 매출관련그래프 start======================= */
    // 연도별 매출관련 그래프
    function yearlySaleBar(seq_no, work_YY, work_QT, mountEl, fiscalMM, ctx = window) {
      const { document: doc, am5, am5xy, am5themes_Animated } = ctx;
      am5.addLicense("AM5C372573951");
      if (!am5 || !am5xy || !am5themes_Animated) return console.error('amCharts not ready');

      // mount
      let el = (typeof mountEl === 'string') ? doc.getElementById(mountEl) : mountEl;
      if (!el) throw new Error('Chart mount element not found');
      if (!(el instanceof ctx.HTMLElement) && el?.id) el = doc.getElementById(el.id);

      // 요청
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: 'PL',    work_yy: work_YY,  work_qt: work_QT, fiscalMM:fiscalMM},
        dataType: "json",
        success: function (data) {
          // cleanup
          if (el.__am5root) { try { el.__am5root.dispose(); } catch(_){} el.__am5root = null; }

          const toNum = v => {
            if (typeof v === 'number') return v;
            if (v == null) return 0;
            const n = Number(String(v).replace(/,/g,'').trim());
            return isNaN(n) ? 0 : n;
          };

          // 원시행 → 객체, 연도 추출
          let rows = Array.isArray(data?.totalData)
            ? data.totalData.map(r => Array.isArray(r) ? r[0] : r)
            : [];
          const getYearNum = o => toNum(o?.year ?? o?.y ?? o?.work_yy);

          if (!rows.length) return;

          // 회계/분기 기준 계산 (work_QT=1~4만 허용)
          const fEnd   = Number(fiscalMM || 12) || 12; // 결산월(예: 12)
          const fStart = (fEnd % 12) + 1;              // 회계연도 시작월(결산월+1)

          // 분기말 월(1~12). 예) fEnd=12면 Q1=3, Q2=6, Q3=9, Q4=12
          const q = Math.min(4, Math.max(1, Number(work_QT || 4))); // 값 없으면 4분기로 처리
          const endMonth = ((fStart + (q * 3) - 2) % 12) + 1;

          // 분기말이 속한 '달력연도' 계산
          //  - 결산월이 12면 달력연도=work_YY
          //  - 결산월이 12가 아니면, 시작월(fStart) 이상은 전년도, 그 외는 당년도
          const endYear =
            (fStart === 1) ? Number(work_YY)
                          : (endMonth >= fStart ? Number(work_YY) - 1 : Number(work_YY));

          // 해당 달의 마지막 날짜(예: 6월 → 6월 30일/말일)
          const asOf = new Date(endYear, endMonth, 0); // day=0 → 다음달의 0일 = 해당월 말일

          // YTD 개월수: 분기×3 (1→3, 2→6, 3→9, 4→12)
          const monthsDone = q * 3;

          // 라벨 등에서 쓸 값들
          const labelMonth = endMonth;                  // "현재(6월)" 등에 사용
          const labelAsOf  = asOf.toISOString().slice(0,10); // "YYYY-MM-DD"

          // 최신연도
          const latestYear = rows.reduce((mx, r) => Math.max(mx, getYearNum(r)||0), 0);

          // 차트 데이터 구성
          let realYTD = 0, predict = 0;

          const ds = rows.map(o => {
            const y = getYearNum(o);
            const E10 = toNum(o?.E10);   // 매출(YTD 또는 연간)
            const N10 = toNum(o?.N10);   // 법인세차감전이익
            const isLatest = (y === latestYear);

            // 기본: 실적
            let income = E10;
            let expenses = Math.max(0, E10 - N10);
            let info = "";

            // 최신연도는 YTD → 연말예상으로 환산
            if (isLatest) {
              realYTD = E10;
              predict = Math.round(E10 * 12 / Math.max(1, monthsDone));
              income   = predict;
              expenses = Math.max(0, Math.round(predict - (N10 * 12 / Math.max(1, monthsDone))));
              info = "(예상)";
            }

            return {
              year: String(y),
              income,
              expenses,
              info,
              columnSettings: isLatest ? { strokeWidth: 1, strokeDasharray: [5], fillOpacity: 0.25 } : undefined,
              strokeSettings: undefined // (라인 스타일 필요 시 여기에)
            };
          })
          // 연도 오름차순(왼→오)
          .sort((a,b) => Number(a.year) - Number(b.year));

          // am5
          const root = am5.Root.new(el);
          el.__am5root = root;
          root.setThemes([ am5themes_Animated.new(root) ]);

          const chart = root.container.children.push(am5xy.XYChart.new(root, {
            panX: false, panY: false, wheelX: "none", wheelY: "none", layout: root.verticalLayout
          }));
          chart.set("scrollbarX", null);
          chart.set("scrollbarY", null);
          chart.set("cursor", am5xy.XYCursor.new(root, { behavior: "none" }));

          // X/Y 축
          const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
            categoryField: "year",
            renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30, cellStartLocation: .05, cellEndLocation: .95 }),
            //tooltip: am5.Tooltip.new(root, {})
            tooltip: am5.Tooltip.new(root, { forceHidden:true })
          }));
          xAxis.data.setAll(ds);

          const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            min: 0,
            renderer: am5xy.AxisRendererY.new(root, {})
          }));
          // ▼ x축 y축 라벨 14px
          xAxis.get("renderer").labels.template.setAll({ fontSize: 14 });
          yAxis.get("renderer").labels.template.setAll({ fontSize: 14 });

          // 현재(YTD) & 예측 레이블 (겹침 방지: dy로 위/아래 배치)
          if (predict > 0) {
            const rNow = yAxis.makeDataItem({ value: realYTD, endValue: realYTD });
            yAxis.createAxisRange(rNow);
            rNow.get("grid").setAll({ stroke: am5.color(0xff0000), strokeOpacity: 1 });
            rNow.get("label").setAll({
              text: `현재(${monthsDone}월) 매출액 : ${(realYTD / 1e8).toFixed(2)} 억`,
              fill: am5.color(0xffffff),
              background: am5.RoundedRectangle.new(root, { fill: am5.color(0xff0000) }),
              dy: 14
            });

            // monthsDone === 12면 현재=예상 → 겹치므로 예상 라벨은 생략
            if (monthsDone < 12) {
              const rEst = yAxis.makeDataItem({ value: predict, endValue: predict });
              yAxis.createAxisRange(rEst);
              rEst.get("grid").setAll({ stroke: am5.color(0xff0000), strokeOpacity: 1 });
              rEst.get("label").setAll({
                text: `연도말 예상 매출액 : ${(predict / 1e8).toFixed(2)} 억`,
                fill: am5.color(0xffffff),
                background: am5.RoundedRectangle.new(root, { fill: am5.color(0xff0000) }),
                dy: -16
              });
            }
            // === YTD~예상 사이 밴드 ===
            if (predict > 0 && monthsDone < 12) {
              const lo = Math.min(realYTD, predict);
              const hi = Math.max(realYTD, predict);

              const band = yAxis.makeDataItem({ value: lo, endValue: hi });
              yAxis.createAxisRange(band);

              // 밴드 스타일
              band.get("axisFill").setAll({
                visible: true,
                fill: am5.color(0xFF621F),   // 원하는 색
                fillOpacity: 0.18,
              });
              // 보조선/라벨은 숨김
              band.get("grid").setAll({ visible: false });
              band.get("label").setAll({ visible: false });

              // (선택) 밴드를 뒤로 보내기
              const fill = band.get("axisFill");
              fill.set("zIndex", 0);
            }        
          }

          // 매출(컬럼)
          const sSales = chart.series.push(am5xy.ColumnSeries.new(root, {
            name: "매출액",
            xAxis, yAxis,
            categoryXField: "year",
            valueYField: "income",
            //tooltip: am5.Tooltip.new(root, { pointerOrientation: "horizontal", labelText: "{categoryX}년 {name} : {valueY} {info}" }),
            tooltip: am5.Tooltip.new(root, { forceHidden:true }),
            clustered: true
          }));
          sSales.columns.template.setAll({ width: am5.percent(70), tooltipY: am5.percent(10), templateField: "columnSettings" });
          sSales.data.setAll(ds);

          // 비용합계(선)  ← 원래대로 LineSeries
          const sCost = chart.series.push(am5xy.LineSeries.new(root, {
            name: "비용합계",
            xAxis, yAxis,
            categoryXField: "year",
            valueYField: "expenses",
            //tooltip: am5.Tooltip.new(root, { pointerOrientation: "horizontal", labelText: "{categoryX}년 {name} : {valueY}" })
            tooltip: am5.Tooltip.new(root, { forceHidden:true }),
          }));
          sCost.strokes.template.setAll({ strokeWidth: 3 });
          sCost.bullets.push(() => am5.Bullet.new(root, {
            sprite: am5.Circle.new(root, {
              radius: 5,
              strokeWidth: 3,
              stroke: sCost.get("stroke"),
              fill: root.interfaceColors.get("background")
            })
          }));
          sCost.data.setAll(ds);

          // 범례/애니메이션
          const legend = chart.children.push(am5.Legend.new(root, { centerX: am5.p50, x: am5.p50 }));
          // ▼ 하단 범례 글자 14px
          legend.labels.template.setAll({ fontSize: 14 });
          legend.valueLabels.template.setAll({ fontSize: 14 });
          legend.data.setAll(chart.series.values);

          chart.appear(800, 80);
          sSales.appear();
          sCost.appear();
        }
      });
    }
    // 연도별 매출 표/성장률/회전율 + 평가의견(연환산/예상 반영까지)
    function fillSalesSide(doc, seq_no, work_YY, work_QT = 4, fiscalMM = 12){
      const y0 = Number(work_YY) - 2, y1 = Number(work_YY) - 1, y2 = Number(work_YY);

      // ---- 유틸 ----
      const sel = id => doc.getElementById(id);
      const put = (id, v) => {
        const el = sel(id);
        if (!el) { console.warn('[fillSalesSide] missing id:', id); return; }
        el.textContent = v;
      };
      const nf  = new Intl.NumberFormat();

      const toNum = v => {
        if (typeof v === 'number') return v;
        if (v == null) return 0;
        const n = Number(String(v).replace(/,/g,'').trim());
        return isNaN(n) ? 0 : n;
      };
      const toMan = v => Math.round(toNum(v)/10000); // 원 → 만원
      const signPct = v =>
        (v==null || !isFinite(v)) ? '−' :
        (v>=0 ? `+${v.toFixed(2)}%` : `${v.toFixed(2)}%`);

      // 회계연도 파생값
      const fEnd   = Number(fiscalMM || 12) || 12;     // 결산월(예: 12)
      const fStart = (fEnd % 12) + 1;                  // 시작월(결산월 + 1) - 필요 시 사용
      const q      = Math.min(4, Math.max(1, Number(work_QT || 4)));
      const monthsDone = q * 3;                        // YTD 개월수(1Q=3, 2Q=6, 3Q=9, 4Q=12)

      // ---- 데이터 로드 ----
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: "PL" },
        dataType: "json"
      }).done(function(res){
        // rows 정규화
        const rows = Array.isArray(res?.totalData) ? res.totalData.map(r => Array.isArray(r)? r[0] : r) : [];
        const byY = {};
        rows.forEach(o => {
          const y = toNum(o?.year ?? o?.y ?? o?.work_yy);
          if (!y) return;
          byY[y] = {
            sales: toNum(o?.E10),   // 매출액 (과거연도=연간, 당해연도=YTD로 들어온다고 가정)
            arEnd: toNum(o?.Z108)   // 연말 매출채권(108계정)
          };
        });

        // ---- 표: 매출액(만원) ----
        [y0,y1,y2].forEach((y,i) => {
          put(['sales-y0','sales-y1','sales-y2'][i], nf.format(toMan(byY[y]?.sales || 0)));
        });

        // ---- 성장률 계산 (비Q4는 당해연도 연환산 기준) ----
        const s_yy = (y) => byY[y]?.sales || 0;
        const s0 = s_yy(y0);      // 2년전
        const s1 = s_yy(y1);      // 전년
        const s2raw = s_yy(y2);   // 당해(YTD일 수 있음)

        const isQ4  = monthsDone >= 12;
        const s2ann = isQ4 ? s2raw : (s2raw * 12 / Math.max(1, monthsDone)); // 당해 연환산/예상

        // 각 연도 칸의 성장률 정의
        //  - y0 칸: y0 vs y0-1 (없으면 '−')
        //  - y1 칸: y1 vs y0
        //  - y2 칸: (당해 연환산/예상) y2ann vs y1
        const g_y0 = (byY[y0-1]?.sales>0) ? ((s0 - byY[y0-1].sales)/byY[y0-1].sales*100) : null;
        const g_y1 = (s0>0) ? ((s1 - s0)/s0*100) : null;
        const g_y2 = (s1>0) ? ((s2ann - s1)/s1*100) : null;

        put('grow-y0', signPct(g_y0));
        put('grow-y1', signPct(g_y1));
        put('grow-y2', signPct(g_y2));

        // ---- 매출채권 회전율 (Sales / Avg(AR)) ----
        // 평균 매출채권: 기본 (AR[y-1]+AR[y])/2, 없으면 (AR[y]+AR[y+1])/2
        function avgAR(y){
          const prev = byY[y-1]?.arEnd || 0;
          const curr = byY[y]?.arEnd   || 0;
          const next = byY[y+1]?.arEnd || 0;
          if (prev>0 && curr>0) return (prev + curr)/2;
          if (curr>0 && next>0) return (curr + next)/2;
          return 0;
        }
        function turnover(sales, y){
          const a = avgAR(y);
          return (sales>0 && a>0) ? (sales / a) : null;
        }
        const t0 = turnover(s0, y0);
        const t1 = turnover(s1, y1);
        const t2 = turnover(s2ann, y2); // 당해연도는 연환산/예상 매출로 산출
        const fTurn = v => (v==null? '−' : v.toFixed(2));

        put('turn-y0', fTurn(t0));
        put('turn-y1', fTurn(t1));
        put('turn-y2', fTurn(t2));

        // ---- 평가의견 생성 ----
        // 추세(연환산 반영)
        const trend =
          (s1>0 && s2ann>s1 && s1>s0) ? '매출이 3개년 연속 증가 추세입니다.' :
          (s1>0 && s2ann<s1 && s1<s0) ? '매출이 3개년 연속 감소 추세입니다.' :
          '매출 변동성이 존재합니다.';

        // 회수일수(일) = 365 / 회전율
        const daysFromTurn = t => (t && t>0) ? Math.round(365/t) : null;
        function turnTextWithDays(turn){
          const days = daysFromTurn(turn);
          if (turn == null || !(turn > 0) || days == null) {
            return '매출채권 자료가 부족하여 회전율·회수일수 산출이 제한됩니다.';
          }
          let level;
          if (turn >= 6 || days <= 60)        level = '회수기간이 매우 양호한 편입니다.';
          else if (turn >= 4 || days <= 90)   level = '회수기간이 양호한 편입니다.';
          else if (turn >= 2 || days <= 180)  level = '회수기간은 정상적인 편입니다.';
          else                                level = '회수기간이 긴편입니다.';
          return `매출채권 회전율은 ${turn.toFixed(2)}회(≈${days}일)로 ${level}`;
        }

        // 헤더 문장: 비Q4면 YTD/연환산 안내 포함
        const hdrNow = isQ4
          ? `최근 3개년 매출은 ${nf.format(toMan(s0))} → ${nf.format(toMan(s1))} → ${nf.format(toMan(s2raw))}로 집계되었습니다.`
          : `최근 3개년 매출은 ${nf.format(toMan(s0))} → ${nf.format(toMan(s1))} → ${nf.format(toMan(s2raw))}(YTD)이며, 연환산 기준 당해연도 예상 매출은 ${nf.format(toMan(s2ann))}입니다.`;

        const yoyTxt = (g_y2==null)
          ? '전년 대비 성장률 산출이 제한됩니다.'
          : `전년 대비 연환산 성장률은 ${signPct(g_y2)}입니다.`;

        const turnMsg = turnTextWithDays(t2);

        const opinion = `${hdrNow} ${trend} ${yoyTxt} ${turnMsg}`
          .replace(/\s+/g,' ')
          .trim();

        const opEl = sel('opinion-text');
        if (opEl) opEl.textContent = opinion;
      }).fail(function(xhr){
        console.error('fillSalesSide ajax error', xhr?.status, xhr?.responseText);
      });
    }
    // 연간 월별 매출을 전년동월과 비교 (컬러 효과 제거 버전)
    function monthlyYoYChart({ seq_no, mountEl, year = new Date().getFullYear(), fiscalMM = 12, ctx = window, rows: rowsOverride }){
      const { document: doc, am5, am5xy, am5themes_Animated } = ctx;
      if (!am5 || !am5xy || !am5themes_Animated) return console.error('amCharts not ready');

      let el = (typeof mountEl === 'string') ? doc.getElementById(mountEl) : mountEl;
      if (!el) throw new Error('Chart mount element not found');
      if (!(el instanceof ctx.HTMLElement) && el?.id) el = doc.getElementById(el.id);

      const toNum = v => (typeof v === 'number') ? v : (v == null ? 0 : (Number(String(v).replace(/,/g,'').trim()) || 0));

      function normalizeRows(rows){
        return (rows||[]).map(r => Array.isArray(r) ? r[0] : r).map(r => ({
          y: toNum(r?.year ?? r?.y ?? r?.work_yy),
          m: toNum(r?.month ?? r?.m ?? r?.mm ?? r?.work_mm),
          s: toNum(r?.sales ?? r?.E10 ?? r?.amount ?? r?.value)
        })).filter(r => r.y && r.m);
      }

      function buildAndDraw(rows){
        const prevY = year - 1, curY = year;
        const map = { [prevY]: Array(13).fill(0), [curY]: Array(13).fill(0) };
        rows.forEach(r => { if (r.y === prevY || r.y === curY) map[r.y][r.m] += r.s; });

        const endM = Number(fiscalMM||12) || 12;
        const startM = (endM % 12) + 1;
        const months = Array.from({length:12}, (_,i)=> ((startM + i - 1) % 12) + 1);

        const data = months.map((m) => {
          const cur  = map[curY]?.[m]  || 0;
          const prev = map[prevY]?.[m] || 0;
          const yoy  = prev > 0 ? ((cur - prev) / prev) * 100 : null;
          return { label: `${m}월`, cur, prev, yoy };
        });

        if (el.__am5root) { try{ el.__am5root.dispose(); }catch(_){} el.__am5root = null; }
        const root = am5.Root.new(el); el.__am5root = root;
        root.setThemes([ am5themes_Animated.new(root) ]);

        const chart = root.container.children.push(am5xy.XYChart.new(root, {
          panX:false, panY:false, wheelX:"none", wheelY:"none", layout: root.verticalLayout
        }));
        chart.set("scrollbarX", null);
        chart.set("scrollbarY", null);
        chart.set("cursor", am5xy.XYCursor.new(root, { behavior: "none" }));

        const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
          categoryField: "label",
          renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30, cellStartLocation:.05, cellEndLocation:.95 })
        }));
        xAxis.data.setAll(data);
        // ▼ 하단 x축 라벨 14px
        xAxis.get("renderer").labels.template.setAll({ fontSize: 14 });
        const yLeft  = chart.yAxes.push(am5xy.ValueAxis.new(root, { min:0,   renderer: am5xy.AxisRendererY.new(root, {}) }));
        const yRight = chart.yAxes.push(am5xy.ValueAxis.new(root, { min:-100, renderer: am5xy.AxisRendererY.new(root, { opposite:true }) }));
        // ▼ 좌/우 y축 라벨 14px
        yLeft.get("renderer").labels.template.setAll({ fontSize: 14 });
        yRight.get("renderer").labels.template.setAll({ fontSize: 14 });
        const sPrev = chart.series.push(am5xy.ColumnSeries.new(root, {
          name: `${prevY} 매출`, xAxis, yAxis: yLeft, categoryXField: "label", valueYField: "prev",
          clustered:true,
          //tooltip: am5.Tooltip.new(root, { labelText: "{name} {categoryX} : {valueY.formatNumber('#,###')}" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        sPrev.columns.template.setAll({ width: am5.percent(80), fillOpacity: 0.85 });

        const sCur = chart.series.push(am5xy.ColumnSeries.new(root, {
          name: `${curY} 매출`, xAxis, yAxis: yLeft, categoryXField: "label", valueYField: "cur",
          clustered:true,
          //tooltip: am5.Tooltip.new(root, { labelText: "{name} {categoryX} : {valueY.formatNumber('#,###')}" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        sCur.columns.template.setAll({ width: am5.percent(80) });

        const sYoY = chart.series.push(am5xy.LineSeries.new(root, {
          name: "YoY%", xAxis, yAxis: yRight, categoryXField: "label", valueYField: "yoy",
          //tooltip: am5.Tooltip.new(root, { labelText: "{name} {categoryX} : {valueY.formatNumber('#,##0.##')}%" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        // 색 지정 제거(기본 테마 사용)
        sYoY.bullets.push(() => am5.Bullet.new(root, {
          sprite: am5.Circle.new(root, { radius: 4, strokeWidth: 2, stroke: sYoY.get("stroke"), fill: root.interfaceColors.get("background") })
        }));

        sPrev.data.setAll(data); sCur.data.setAll(data); sYoY.data.setAll(data);
        const legend = chart.children.push(am5.Legend.new(root, { centerX: am5.p50, x: am5.p50 }));
          // ▼ 하단 범례 글자 14px
          legend.labels.template.setAll({ fontSize: 14 });
          legend.valueLabels.template.setAll({ fontSize: 14 });    
        legend.data.setAll(chart.series.values);

        chart.appear(800,80); sPrev.appear(); sCur.appear(); sYoY.appear();
      }

      if (rowsOverride && rowsOverride.length){
        buildAndDraw(normalizeRows(rowsOverride));
      } else {
        $.ajax({
          url: "{% url 'getFinancialData_Report' %}",
          data: { seq_no, flag: 'PL_MONTHLY', from_y: year - 1, to_y: year },
          dataType: "json",
          success: function(res){
            const rows = normalizeRows(res?.monthlyData || res?.rows || res?.totalData || []);
            buildAndDraw(rows);
          },
          error: function(){ console.error('monthlyYoYChart: failed to fetch data'); }
        });
      }
    }
    // 분기별 매출(올해 vs 전년도 동분기) + YoY% (컬러 효과 제거 버전)
    function quarterlyYoYChart({ seq_no, mountEl, year, fiscalMM = 12, ctx = window }) {
      const { document: doc, am5, am5xy, am5themes_Animated } = ctx;
      if (!am5 || !am5xy || !am5themes_Animated) { console.error('amCharts not ready in given context'); return; }

      let el = (typeof mountEl === 'string') ? doc.getElementById(mountEl) : mountEl;
      if (!el) { console.warn('Chart mount element not found'); return; }
      if (!(el instanceof ctx.HTMLElement) && el?.id) { const re = doc.getElementById(el.id); if (re) el = re; }

      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: 'PL_QUARTERLY', work_yy: year, fiscalMM },
        dataType: "json"
      })
      .done(function(res){
        const rows = res?.quarterlyData || [];
        const prevY = Number(year) - 1, curY = Number(year);

        const acc = { [prevY]: {1:0,2:0,3:0,4:0}, [curY]: {1:0,2:0,3:0,4:0} };
        rows.forEach(r => { const y=+r.year, q=+r.quarter, s=+r.sales||0; if (acc[y] && q>=1 && q<=4) acc[y][q]+=s; });

        const labels = ["1분기","2분기","3분기","4분기"];
        const data = [1,2,3,4].map((q, i) => {
          const prev = acc[prevY][q]||0, curr = acc[curY][q]||0;
          const yoy = prev>0 ? ((curr-prev)/prev)*100 : null;
          return { label: labels[i], prev, curr, yoy };
        });

        if (el.__am5root) { try { el.__am5root.dispose(); } catch(_){} el.__am5root = null; }
        const root = am5.Root.new(el); el.__am5root = root;
        root.setThemes([ am5themes_Animated.new(root) ]);

        const chart = root.container.children.push(am5xy.XYChart.new(root, {
          panX:false, panY:false, wheelX:"none", wheelY:"none", layout: root.verticalLayout
        }));
        chart.set("scrollbarX", null);
        chart.set("cursor", am5xy.XYCursor.new(root, { behavior: "none" }));

        const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
          categoryField: "label",
          renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30, cellStartLocation:.05, cellEndLocation:.95 })
        }));
        xAxis.data.setAll(data);
        const yL = chart.yAxes.push(am5xy.ValueAxis.new(root, { min:0, renderer: am5xy.AxisRendererY.new(root,{}) }));
        const yR = chart.yAxes.push(am5xy.ValueAxis.new(root, { min:-100, renderer: am5xy.AxisRendererY.new(root,{ opposite:true }) }));
        // ▼ 하단 x축 라벨 폰트 14px
        xAxis.get("renderer").labels.template.setAll({ fontSize: 14 });
        // ▼▼ y축 라벨 폰트 크기 14px로 통일 ▼▼
        yL.get("renderer").labels.template.setAll({ fontSize: 14 });
        yR.get("renderer").labels.template.setAll({ fontSize: 14 });

        const sPrev = chart.series.push(am5xy.ColumnSeries.new(root, {
          name: `${prevY} 매출`, xAxis, yAxis: yL, categoryXField:"label", valueYField:"prev",
          //tooltip: am5.Tooltip.new(root,{ labelText:"{name} {categoryX} : {valueY.formatNumber('#,###')}" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        sPrev.columns.template.setAll({ width: am5.percent(80), fillOpacity: 0.85 });

        const sCurr = chart.series.push(am5xy.ColumnSeries.new(root, {
          name: `${curY} 매출`, xAxis, yAxis: yL, categoryXField:"label", valueYField:"curr",
          //tooltip: am5.Tooltip.new(root,{ labelText:"{name} {categoryX} : {valueY.formatNumber('#,###')}" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        sCurr.columns.template.setAll({ width: am5.percent(80) });

        const sYoY = chart.series.push(am5xy.LineSeries.new(root, {
          name: "YoY%", xAxis, yAxis: yR, categoryXField:"label", valueYField:"yoy",
          //tooltip: am5.Tooltip.new(root,{ labelText:"{name} {categoryX} : {valueY.formatNumber('#,##0.##')}%" })
          tooltip: am5.Tooltip.new(root, { forceHidden:true }),
        }));
        // 색 지정 제거(기본 테마 사용)
        sYoY.bullets.push(() => am5.Bullet.new(root, {
          sprite: am5.Circle.new(root, { radius:4, strokeWidth:2, stroke:sYoY.get("stroke"), fill: root.interfaceColors.get("background") })
        }));

        sPrev.data.setAll(data); sCurr.data.setAll(data); sYoY.data.setAll(data);
        const legend = chart.children.push(am5.Legend.new(root, { centerX: am5.p50, x: am5.p50 }));
        // ▼ 하단 범례 글자 14px
        legend.labels.template.setAll({ fontSize: 14 });
        legend.valueLabels.template.setAll({ fontSize: 14 });
        legend.data.setAll(chart.series.values);

        chart.appear(800,80); sPrev.appear(); sCurr.appear(); sYoY.appear();
      })
      .fail(function(xhr){
        console.error('PL_QUARTERLY ajax error', xhr?.status, xhr?.responseText);
        try { el.innerHTML = '<div style="padding:8px;color:#b23;">분기 데이터 로딩 실패</div>'; } catch(_){}
      });
    }
    // 매출채권 연령분석 (상세 리스트, 최대 6행)
    function renderArTopTable({ seq_no, mountEl, year, fiscalMM = 12, as_of = "", ctx = window }) {
      const doc = ctx.document;
      const el = (typeof mountEl === "string") ? doc.getElementById(mountEl) : mountEl;
      if (!el) return;

      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: "AR_LIST", work_yy: year, fiscalMM, as_of },
        dataType: "json"
      }).done(function (res) {
        const all = Array.isArray(res?.rows) ? res.rows : [];
        const MAX_ROWS = 6;
        const rows = all.slice(0, MAX_ROWS);          // ← 6개만 사용
        const blanks = Math.max(0, MAX_ROWS - rows.length);
        const nf = new Intl.NumberFormat();

        const bodyHtml =
          rows.map(r => `
            <tr>
              <td class="t-left">${(r.trader_name || "").substring(0, 18)}</td>
              <td>${r.bizno || ""}</td>
              <td class="t-right">${nf.format(r.end_amount || 0)}</td>
              <td>${r.occur_ym || ""}</td>
              <td class="t-right">${(r.months ?? 0)}개월</td>
              <td class="t-bold ${r.grade ? "grade" : ""}">${r.grade || ""}</td>
            </tr>
          `).join("") +
          Array.from({ length: blanks }).map(() => `
            <tr><td colspan="6">&nbsp;</td></tr>
          `).join("");

        el.innerHTML = `
          <table class="tbl-arlist">
            <thead>
              <tr>
                <th>거래처명</th>
                <th>사업자번호</th>
                <th>미수금액</th>
                <th>발생년월</th>
                <th>미수기간</th>
                <th>부실여부</th>
              </tr>
            </thead>
            <tbody>${bodyHtml}</tbody>
          </table>
          <div class="notes">
            ※ 2년이상 미회수 채권은 부실채권으로 분류되어 실질자본금을 감소시킵니다.<br>
            ※ 일반 상사채권은 상법 제64조에 의하여 5년의 소멸시효가 적용됩니다. 다만, 공사채권은 민법 제163조에 의거 3년의 단기시효가 적용됩니다.
          </div>
        `;
      }).fail(function (xhr) {
        console.error("AR_LIST ajax error", xhr?.status, xhr?.responseText);
        if (el) el.innerHTML = `<div style="padding:8px;color:#b23">매출채권 리스트 로딩 실패</div>`;
      });
    }
    // 당기 주요 매출처 도넛 (슬라이스=퍼센트, 범례=상호+금액)
    function salesTopDonut({ seq_no, mountEl, year, fiscalMM = 12, topN = 7, ctx = window }) {
      const { document: doc, am5, am5percent, am5themes_Animated } = ctx;
      if (!am5 || !am5percent || !am5themes_Animated) { console.error('amCharts not ready'); return; }

      let el = (typeof mountEl === 'string') ? doc.getElementById(mountEl) : mountEl;
      if (!el) return;
      if (!(el instanceof ctx.HTMLElement) && el?.id) el = doc.getElementById(el.id);

      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: "SALES_TOP", work_yy: year, fiscalMM },
        dataType: "json"
      }).done(res => {
        const raw = (res?.topCustomers || []).map(r => ({
          name: r.거래처명 || r.name || "",
          value: Number(r.차변 ?? r.amount ?? 0) || 0,
          ratio: Number(r.비율 || 0) || 0
        })).filter(r => r.value > 0);

        raw.sort((a,b) => b.value - a.value);
        const head = raw.slice(0, topN);
        const etcSum = raw.slice(topN).reduce((s, r) => s + r.value, 0);
        if (etcSum > 0) head.push({ name: "기타", value: etcSum });

        if (el.__am5root) { try{ el.__am5root.dispose(); }catch(_){} el.__am5root = null; }
        const root = am5.Root.new(el);
        el.__am5root = root;
        root.setThemes([ am5themes_Animated.new(root) ]);

        const colors = am5.ColorSet.new(root, {
          colors: [0x74b9ff,0xa29bfe,0x81ecec,0xffd180,0x98e6a7,0xff8a80,0xb39ddb].map(am5.color),
          reuse: true, step: 1
        });

        // ✔ 꽉 찬 파이 (innerRadius 0)
        const chart = root.container.children.push(am5percent.PieChart.new(root, {
          layout: root.horizontalLayout,
          innerRadius: 0
        }));


        const series = chart.series.push(am5percent.PieSeries.new(root, {
          valueField: "value",
          categoryField: "name",
          alignLabels: true
        }));
        series.set("colors", colors);

        // ▶ 슬라이스 라벨: 퍼센트만, 검은색, 3% 미만은 숨김
        series.labels.template.setAll({
          text: "{valuePercentTotal.formatNumber('#.##')}%",
          inside: true,
          fontSize: 12,
          fontWeight: "600",
          fill: am5.color(0x000000)   // 검은색
        });
        series.ticks.template.setAll({ forceHidden: false });
        series.labels.template.adapters.add("visible", (visible, target) => {
          const di = target.dataItem;
          return di ? di.get("valuePercentTotal") >= 3 : false;
        });

        series.data.setAll(head);

        //▶ 왼쪽 범례: 상호 + 금액(원)
        const legend = chart.children.unshift(am5.Legend.new(root, {
          width: am5.percent(100),// ← 이 값으로 더/덜 오른쪽 조정==> 파이가 오른족으로 밀려난다
          centerY: am5.p50, y: am5.p50,
          layout: root.verticalLayout
        }));
        // 각 항목 컨테이너를 가로 레이아웃 + 전체폭으로
        legend.itemContainers.template.setAll({
          width: am5.percent(100),
          layout: root.horizontalLayout,
          paddingTop: 2,
          paddingBottom: 2
        });
        legend.markers.template.setAll({ width: 12, height: 12 });

        // 시리즈가 레전드에 넘길 텍스트
        series.setAll({
          legendLabelText: "{category}",
          legendValueText: "{value.formatNumber('#,###')}원"
        });

        // 라벨(상호) 칸: 고정폭 + 말줄임
        const LABEL_W = 220;   // ← 상호가 길면 320~340로 늘려주세요
        legend.labels.template.setAll({
          text: "{category}",
          fontSize: 14,                       // 글씨 더 작게
          minWidth: LABEL_W, width: LABEL_W, maxWidth: LABEL_W,
          oversizedBehavior: "truncate",
          ellipsis: "…"
        });

        // 금액 칸: 고정폭 + 오른쪽 정렬 + 빨강
        const VALUE_W = 100;   // 필요 시 120~160 조정
        legend.valueLabels.template.setAll({
          text: "{value.formatNumber('#,###')}원",
          fontSize: 14,                       // ← 금액 글씨 더 작게
          minWidth: VALUE_W, width: VALUE_W, maxWidth: VALUE_W,
          textAlign: "right",
          fill: am5.color(0x8E7CD1),
          fontWeight: "bold"
        });

        legend.data.setAll(series.dataItems);
        //애니메이션 효과
        chart.appear(0, 0);
        series.appear(0, 0);
      }).fail(xhr => console.error("SALES_TOP ajax error", xhr?.status, xhr?.responseText));
    }
    /* ======================= 3. 비용관련그래프 start======================= */
    // 공용 데이터 캐시
    const DataCache = new Map();
    // 숫자 변환
    function toNum(v) {
      return (typeof v === "number" ? v : Number(String(v ?? 0).replace(/,/g, "")) || 0);
    }
    //** * PL 응답 정규화 *  year, sales(E10), pretax(N10), profit(Q10), tax(O10),cogs(F10), salary(H10), sga(J10), nonOp(L10)
    function normalizePLData(res) {
      const rows = Array.isArray(res?.totalData)
        ? res.totalData.map(r => Array.isArray(r) ? r[0] : r)
        : [];

      return rows
        .map(r => ({
          year: toNum(r.year),
          raw: r,
          sales: toNum(r.E10),
          pretax: toNum(r.N10),
          profit: toNum(r.Q10),
          tax: toNum(r.tax),
          cogs: toNum(r.F10),
          salary: toNum(r.H10),
          sga: toNum(r.J10),
          nonOp: toNum(r.L10),
          // 총비용 = 매출 – 법인세차감전이익
          cost: Math.max(0, toNum(r.E10) - toNum(r.N10))
        }))
        .sort((a, b) => a.year - b.year);
    }
    //** * TOP_PURCHASE 응답 정규화
    function normalizeTopPurchaseData(res) {
      const rows =
        (Array.isArray(res?.purchaseData) ? res.purchaseData :
        (Array.isArray(res?.topVendors)   ? res.topVendors   :
        (Array.isArray(res?.rows)         ? res.rows         :
        (Array.isArray(res?.topCustomers) ? res.topCustomers : []))));

      const safe = Array.isArray(rows) ? rows : [];
      const top10 = safe.slice(0, 10);

      return top10
        .map(r => ({
          name:  (r?.거래처명 || "").trim() || "(무명)",
          bizno: (r?.사업자번호 || "").trim(),
          value: Number(r?.차변) || 0,   // 원
          ratio: Number(r?.비율) || 0
        }))
        .filter(r => r.value > 0);
    }
    //** * PURCHASE_EVID 응답 정규화
    function normalizePurchaseEvidenceData(res) {
      // 1) 응답 구조 정규화: 배열이면 그대로, 아니면 receiptAnalysis/rows에서 꺼냄
      const source = Array.isArray(res)
        ? res
        : Array.isArray(res?.receiptAnalysis)
          ? res.receiptAnalysis
          : Array.isArray(res?.rows)
            ? res.rows
            : [];

      const rows = source.map(r => {
        const y   = toNum(r.year ?? r.work_yy ?? r.연도 ?? 0);

        const tgt = toNum(r.검증대상금액 ?? r.target ?? 0);
        const vat = toNum(r.세금계산서   ?? r.vatInvoice ?? r.taxInvoice ?? 0);
        const inv = toNum(r.계산서       ?? r.freeInvoice ?? 0);
        const crd = toNum(r.신용카드등   ?? r.card ?? 0);
        const wit = toNum(r.원천징수     ?? r.withhold ?? 0);

        // 증빙불비가 내려오면 그대로 사용, 없으면 재계산
        const lackRaw = (r.증빙불비 != null) ? r.증빙불비 : null;
        const lac = (lackRaw != null)
          ? toNum(lackRaw)
          : Math.max(tgt - (vat + inv + crd + wit), 0);

        return {
          year: y,
          target: tgt,     // 검증대상금액
          taxInv: vat,     // 세금계산서
          inv,             // 계산서
          card: crd,       // 신용카드 등
          withhold: wit,   // 원천징수
          lack: lac        // 증빙불비
        };
      }).filter(r => r.year > 0);

      // 최신 연도가 앞으로 오는 순으로 정렬
      return rows.sort((a, b) => b.year - a.year);
    }

    //** * 공용 데이터 fetch + 정규화
    async function fetchPLData({ seq_no, work_yy, fiscalMM, flag = "PL", work_qt }) {
      // ★ PL은 구조가 바뀌었으므로 v2 태그 추가해서 기존 캐시와 분리
      const version = flag === "PL" ? "v2" : "v1";
      const key = `${seq_no}-${work_yy}-${fiscalMM}-${flag}-${work_qt || ""}-${version}`;

      if (DataCache.has(key)) return DataCache.get(key);

      const data = { seq_no, work_yy, fiscalMM, flag };
      if (flag === "TAX_ESTIMATE" && work_qt != null) {
        data.work_qt = work_qt;
      }

      // 백엔드 전체 응답 그대로
      const res = await $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data,
        dataType: "json"
      });

      let normalized;

      switch (flag) {
        case "PL": {
          // 1) 연도별 PL 데이터 정규화
          normalized = normalizePLData(res);

          // 2) baseAgg가 있으면, 현재 작업연도 row에 기초 집계값 덮어쓰기
          if (res.baseAgg && Array.isArray(normalized)) {
            const targetYear = Number(work_yy);
            const idx = normalized.findIndex(r => Number(r.year) === targetYear);

            if (idx >= 0) {
              const row = { ...normalized[idx] };

              // 도넛/요약에서 쓰는 필드 기준으로 덮어쓰기
              row.salary = res.baseAgg.salary    ?? row.salary;
              row.sga    = res.baseAgg.sga       ?? row.sga;
              row.nonOp  = res.baseAgg.nonOpExp  ?? row.nonOp;
              row.tax    = res.baseAgg.tax       ?? row.tax;

              // 필요하면 매출/매출원가도 동기화 (옵션)
              // row.sales = res.baseAgg.sales ?? row.sales;
              // row.cogs  = res.baseAgg.cogs  ?? row.cogs;

              normalized = [...normalized];
              normalized[idx] = row;
            }
          }
          break;
        }

        case "TOP_PURCHASE":
          normalized = normalizeTopPurchaseData(res);
          break;

        case "PURCHASE_EVID":
          normalized = normalizePurchaseEvidenceData(res);
          break;

        case "TAX_ESTIMATE":
          normalized = res; // 그대로 사용
          break;

        default:
          normalized = res;
      }

      DataCache.set(key, normalized);
      return normalized;
    }

    //** * 회계연도 기준 경과 개월 수 계산 *  - work_qt가 있으면 해당 분기말 기준 (1→3, 2→6, 3→9, 4→12개월) *  - 없으면 오늘 기준
    function monthsDoneFromFiscal(workYY, fiscalMM, work_qt) {
      const fEnd = Number(fiscalMM || 12) || 12;   // 결산월
      const fStart = (fEnd % 12) + 1;              // 회계연도 시작월
      const startYear = (fStart === 1) ? Number(workYY) : Number(workYY) - 1;
      const start = new Date(startYear, fStart - 1, 1);            // 회계연도 시작일
      const fiscalEnd = new Date(Number(workYY), fEnd, 0);         // 회계연도 종료일

      let clamp;
      if (work_qt && work_qt >= 1 && work_qt <= 4) {
        // work_qt 분기 말일
        const quarterEnd = new Date(startYear, (fStart - 1) + work_qt * 3, 0);
        clamp = quarterEnd > fiscalEnd ? fiscalEnd : quarterEnd;
      } else {
        const today = new Date();
        clamp = today > fiscalEnd ? fiscalEnd : today;
      }

      if (clamp < start) return 12;

      const months =
        (clamp.getFullYear() - start.getFullYear()) * 12 +
        (clamp.getMonth() - start.getMonth()) + 1;

      return Math.min(12, months);
    }
    // 1) 연도별 순이익 & 세금 + 연말 예상 순이익
    async function renderCostBenefit({ doc, mountId, seq_no, work_yy, work_qt, fiscalMM, data }) {
      const ctx = doc?.defaultView || window;
      const { am5, am5xy, am5themes_Animated } = ctx;
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      mount.innerHTML = `<div style="color:#64748b;padding:12px">그래프를 불러오는 중…</div>`;
      if (!am5 || !am5xy || !am5themes_Animated) { console.error("amCharts (am5) not ready"); return; }

      const nf = new Intl.NumberFormat("ko-KR");
      const fmtAmt = n => n >= 1e8 ? `${(n / 1e8).toFixed(2)} 억` : `${nf.format(Math.round(n))} 원`;

      // 데이터 확보 (인자로 들어온 data 우선)
      const rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag: "PL" });

      if (!rows.length) {
        mount.innerHTML = `<div style="color:#64748b;padding:12px">데이터가 없습니다.</div>`;
        return;
      }

      const latestYear = rows[rows.length - 1].year;
      const monthsDone = monthsDoneFromFiscal(work_yy, fiscalMM, work_qt);

      let realYTDProfit = 0;
      let predictedProfit = 0;

      const chartData = rows.map(r => {
        const y = r.year;
        const Q10 = r.profit; // 순이익
        const O10 = r.tax;    // 세금

        let income = Q10;
        let expenses = O10;
        let info = "";

        if (y === latestYear) {
          realYTDProfit   = Q10;
          predictedProfit = Math.round(Q10 * 12 / Math.max(1, monthsDone));
          income = predictedProfit;  // 최신년도 막대 = 예상 순이익
          info = "(예상)";
        }

        return {
          year: String(y),
          income,
          expenses,
          info,
          columnSettings: (y === latestYear)
            ? { strokeWidth: 1, strokeDasharray: [5], fillOpacity: .25 }
            : { fillOpacity: 1 }
        };
      });

      if (chartData.length >= 2) {
        chartData[chartData.length - 2].strokeSettings = { strokeDasharray: [6, 6] };
      }

      // 기존 차트 정리
      if (mount.__am5root) { try { mount.__am5root.dispose(); } catch (_) {} }
      mount.innerHTML = "";

      const root = am5.Root.new(mount);
      mount.__am5root = root;
      // ▼ amCharts 워터마크 제거
      root._logo && root._logo.dispose();  
      root.setThemes([ am5themes_Animated.new(root) ]);

      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX:false,
        panY:false,
        wheelX:"none",
        wheelY:"none",
        layout: root.verticalLayout
      }));

      chart.setAll({
        paddingTop: 10,
        paddingRight: 16,
        paddingBottom: 12,
        paddingLeft: 0
      });

      chart.set("scrollbarX", null);
      chart.set("scrollbarY", null);
      //chart.set("cursor", am5xy.XYCursor.new(root, { behavior: "none" }));

      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "year",
        renderer: am5xy.AxisRendererX.new(root, {
          minGridDistance: 30,
          cellStartLocation:.05,
          cellEndLocation:.95
        }),
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      xAxis.data.setAll(chartData);
      xAxis.get("renderer").labels.template.setAll({ fontSize: 14 });

      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        min: 0,
        extraMax: 0.02,
        renderer: am5xy.AxisRendererY.new(root, {}),
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      yAxis.get("renderer").labels.template.setAll({ fontSize: 14 });

      // 현재~예상 사이 밴드
      if (realYTDProfit > 0 && predictedProfit > 0 && realYTDProfit !== predictedProfit) {
        const v1 = Math.min(realYTDProfit, predictedProfit);
        const v2 = Math.max(realYTDProfit, predictedProfit);
        const band = yAxis.makeDataItem({ value: v1, endValue: v2 });
        yAxis.createAxisRange(band);
        band.get("grid").setAll({ stroke: am5.color(0xff0000), strokeOpacity: 1 });
        band.get("axisFill").setAll({ fill: am5.color(0xFF621F), fillOpacity: .18, visible: true });
      }

      // 현재 월 기준 순이익 라인
      if (realYTDProfit > 0) {
        const rNow = yAxis.makeDataItem({ value: realYTDProfit, endValue: realYTDProfit });
        yAxis.createAxisRange(rNow);
        rNow.get("grid").setAll({ stroke: am5.color(0xff0000), strokeOpacity: 1 });
        rNow.get("label").setAll({
          text: `현재(${String(monthsDone).padStart(2,"0")}월) 순이익 : ${fmtAmt(realYTDProfit)}`,
          fill: am5.color(0xffffff),
          background: am5.RoundedRectangle.new(root, { fill: am5.color(0xff0000) }),
          dy: 14
        });
      }

      // 연말 예상 순이익 라인
      if (monthsDone < 12 && predictedProfit > 0) {
        const rEst = yAxis.makeDataItem({ value: predictedProfit, endValue: predictedProfit });
        yAxis.createAxisRange(rEst);
        rEst.get("grid").setAll({ stroke: am5.color(0xff0000), strokeOpacity: 1 });
        rEst.get("label").setAll({
          text: `연도말 예상 순이익 : ${fmtAmt(predictedProfit)}`,
          fill: am5.color(0xffffff),
          background: am5.RoundedRectangle.new(root, { fill: am5.color(0xff0000) }),
          dy: -16
        });
      }

      const sProfit = chart.series.push(am5xy.ColumnSeries.new(root, {
        name: "순이익",
        xAxis, yAxis,
        categoryXField: "year",
        valueYField: "income",
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      sProfit.columns.template.setAll({
        width: am5.percent(70),
        tooltipY: am5.percent(10),
        templateField: "columnSettings"
      });
      sProfit.data.setAll(chartData);

      const sTax = chart.series.push(am5xy.LineSeries.new(root, {
        name: "세금",
        xAxis, yAxis,
        categoryXField: "year",
        valueYField: "expenses",
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      sTax.strokes.template.setAll({ strokeWidth: 3, templateField: "strokeSettings" });
      sTax.bullets.push(() =>
        am5.Bullet.new(root, {
          sprite: am5.Circle.new(root, {
            radius: 5, strokeWidth: 3, stroke: sTax.get("stroke"),
            fill: root.interfaceColors.get("background")
          })
        })
      );
      sTax.data.setAll(chartData);

      const legend = chart.children.push(am5.Legend.new(root, { centerX: am5.p50, x: am5.p50 }));
      legend.labels.template.setAll({ fontSize: 14 });
      legend.valueLabels.template.setAll({ fontSize: 14 });
      legend.data.setAll(chart.series.values);

      chart.appear(800, 80);
      sProfit.appear();
      sTax.appear();
    }
    // 2) 매출 vs 비용 선그래프
    async function renderSalesCostLines({ doc, mountId, seq_no, work_yy, fiscalMM, data, titleText = "매출 vs 비용" }) {
      const ctx = doc?.defaultView || window;
      const { am5, am5xy, am5themes_Animated } = ctx;
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      mount.innerHTML = `<div style="color:#64748b;padding:12px">그래프를 불러오는 중…</div>`;
      if (!am5 || !am5xy || !am5themes_Animated) { console.error("amCharts (am5) not ready"); return; }

      const rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"PL" });

      if (!rows.length) {
        mount.innerHTML = `<div style="color:#64748b;padding:12px">데이터가 없습니다.</div>`;
        return;
      }

      const ds = rows
        .map(r => ({
          year: String(r.year),
          sales: r.sales,
          costTotal: r.cost
        }))
        .sort((a,b)=> Number(a.year) - Number(b.year));

      if (mount.__am5root) { try{ mount.__am5root.dispose(); }catch{} }
      mount.innerHTML = "";

      const root = am5.Root.new(mount);
      mount.__am5root = root;
      // ▼ amCharts 워터마크 제거
      root._logo && root._logo.dispose();
      root.numberFormatter.setAll({
        numberFormat: "#a",
        bigNumberPrefixes: [
          { number: 1e4, suffix: "만" },
          { number: 1e6, suffix: "백만" },
          { number: 1e8, suffix: "억" }
        ],
        smallNumberPrefixes: []
      });

      root.setThemes([ am5themes_Animated.new(root) ]);

      const chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX:false, panY:false, wheelX:"none", wheelY:"none", layout: root.verticalLayout
      }));
      //chart.set("cursor", am5xy.XYCursor.new(root, { behavior: "none" }));

      const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
        categoryField: "year",
        renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30, cellStartLocation:.05, cellEndLocation:.95 }),
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      xAxis.data.setAll(ds);

      const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        min:0,
        renderer: am5xy.AxisRendererY.new(root, {}),
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      yAxis.get("renderer").labels.template.setAll({
        text: "{value.formatNumber('#a')}"
      });

      xAxis.get("renderer").labels.template.setAll({ fontSize: 14 });
      yAxis.get("renderer").labels.template.setAll({ fontSize: 14 });

      const sSales = chart.series.push(am5xy.LineSeries.new(root, {
        name: "매출",
        xAxis, yAxis,
        categoryXField: "year",
        valueYField: "sales",
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      sSales.strokes.template.setAll({ strokeWidth: 3 });
      sSales.bullets.push(() => am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 4, strokeWidth: 2,
          stroke: sSales.get("stroke"),
          fill: root.interfaceColors.get("background")
        })
      }));
      sSales.data.setAll(ds);

      const sCost = chart.series.push(am5xy.LineSeries.new(root, {
        name: "총비용",
        xAxis, yAxis,
        categoryXField: "year",
        valueYField: "costTotal",
        tooltip: am5.Tooltip.new(root, { forceHidden:true })
      }));
      sCost.strokes.template.setAll({ strokeWidth: 3, strokeDasharray: [6,6] });
      sCost.bullets.push(() => am5.Bullet.new(root, {
        sprite: am5.Circle.new(root, {
          radius: 4, strokeWidth: 2,
          stroke: sCost.get("stroke"),
          fill: root.interfaceColors.get("background")
        })
      }));
      sCost.data.setAll(ds);

      const legend = chart.children.push(am5.Legend.new(root, { centerX: am5.p50, x: am5.p50 }));
      legend.labels.template.setAll({ fontSize: 14 });
      legend.valueLabels.template.setAll({ fontSize: 14 });
      legend.data.setAll(chart.series.values);

      chart.appear(600, 60);
      sSales.appear();
      sCost.appear();
    }
    // 3) 순이익 증가율(전년대비)
    async function renderProfitGrowth({ doc, mountId, seq_no, work_yy, fiscalMM, data }) {
      const ctx = doc?.defaultView || window;
      const { am5, am5xy, am5themes_Animated } = ctx;
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      mount.innerHTML = `<div style="color:#64748b;padding:12px">그래프를 불러오는 중…</div>`;
      if (!am5 || !am5xy || !am5themes_Animated) { console.error("amCharts (am5) not ready"); return; }

      const rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"PL" });

      if (!rows.length) {
        mount.innerHTML = `<div style="color:#64748b;padding:12px">데이터가 없습니다.</div>`;
        return;
      }

      const dataVI = rows
        .map(r => ({ year: String(r.year), value: r.pretax })) // 법인세차감전이익 기준
        .sort((a,b) => Number(a.year) - Number(b.year));

      for (let i = 0; i < dataVI.length - 1; i++) {
        dataVI[i].valueNext = dataVI[i + 1].value;
      }

      if (mount.__am5root) { try { mount.__am5root.dispose(); } catch(e){} }
      mount.innerHTML = "";

      const rootVI = am5.Root.new(mount);
      mount.__am5root = rootVI;
      // ▼ amCharts 워터마크 제거
      rootVI._logo && rootVI._logo.dispose();
      rootVI.numberFormatter.setAll({
        numberFormat: "#a",
        bigNumberPrefixes: [
          { number: 1e4, suffix: "만" },
          { number: 1e6, suffix: "백만" },
          { number: 1e8, suffix: "억" }
        ],
        smallNumberPrefixes: []
      });
      rootVI.setThemes([ am5themes_Animated.new(rootVI) ]);

      const chartVI = rootVI.container.children.push(am5xy.XYChart.new(rootVI, {
        panX:false, panY:false, wheelX:"none", wheelY:"none", layout: rootVI.verticalLayout
      }));

      // 기존: 점선 크로스헤어 보임
      // chartVI.set("cursor", am5xy.XYCursor.new(rootVI, { behavior:"none" }));

      // 변경: 커서는 두되, 점선(X/Y 라인) 숨김
      const cursor = am5xy.XYCursor.new(rootVI, { behavior: "none" });
      cursor.lineX.set("visible", false);
      cursor.lineY.set("visible", false);
      chartVI.set("cursor", cursor);

      const xAxisVI = chartVI.xAxes.push(am5xy.CategoryAxis.new(rootVI, {
        categoryField: "year",
        renderer: am5xy.AxisRendererX.new(rootVI, {
          cellStartLocation: 0.1,
          cellEndLocation: 0.9,
          minGridDistance: 30
        }),
        tooltip: am5.Tooltip.new(rootVI, { forceHidden:true })
      }));
      xAxisVI.data.setAll(dataVI);

      const yAxisVI = chartVI.yAxes.push(am5xy.ValueAxis.new(rootVI, {
        renderer: am5xy.AxisRendererY.new(rootVI, {}),
        tooltip: am5.Tooltip.new(rootVI, { forceHidden:true })
      }));
      xAxisVI.get("renderer").labels.template.setAll({ fontSize: 14 });
      yAxisVI.get("renderer").labels.template.setAll({ fontSize: 14 });

      const seriesVI = chartVI.series.push(am5xy.ColumnSeries.new(rootVI, {
        xAxis: xAxisVI,
        yAxis: yAxisVI,
        valueYField: "value",
        categoryXField: "year",
        tooltip: am5.Tooltip.new(rootVI, { forceHidden:true })
      }));
      seriesVI.columns.template.setAll({
        width: am5.percent(90),
        tooltipY: 0,
        tooltipText: "{categoryX}년: {valueY}"
      });
      seriesVI.data.setAll(dataVI);

      const series2VI = chartVI.series.push(am5xy.ColumnSeries.new(rootVI, {
        xAxis: xAxisVI,
        yAxis: yAxisVI,
        valueYField: "valueNext",
        openValueYField: "value",
        categoryXField: "year",
        fill: am5.color(0x555555),
        stroke: am5.color(0x555555),
        tooltip: am5.Tooltip.new(rootVI, { forceHidden:true })
      }));
      series2VI.columns.template.setAll({ width: 1 });
      series2VI.data.setAll(dataVI);

      // 증감 퍼센트 라벨
      series2VI.bullets.push(function () {
        const label = am5.Label.new(rootVI, {
          text: "{valueY}",
          fontWeight: "500",
          fill: am5.color(0x00cc00),
          centerY: am5.p100,
          centerX: am5.p50,
          populateText: true
        });
        label.adapters.add("text", (_text, target) => {
          const p = getVariancePercent(target.dataItem);
          return isFinite(p) ? `${p}%` : "";
        });
        label.adapters.add("centerY", (center, target) =>
          getVariancePercent(target.dataItem) < 0 ? 0 : center
        );
        label.adapters.add("fill", (_fill, target) =>
          getVariancePercent(target.dataItem) < 0 ? am5.color(0xcc0000) : am5.color(0x00cc00)
        );
        return am5.Bullet.new(rootVI, { locationY: 1, sprite: label });
      });

      // 방향 화살표
      series2VI.bullets.push(function () {
        const arrow = am5.Graphics.new(rootVI, {
          rotation: -90,
          centerX: am5.p50,
          centerY: am5.p50,
          dy: 3,
          fill: am5.color(0x555555),
          stroke: am5.color(0x555555),
          draw: (display) => {
            display.moveTo(0, -3);
            display.lineTo(8, 0);
            display.lineTo(0, 3);
            display.lineTo(0, -3);
          }
        });
        arrow.adapters.add("rotation", (_r, target) =>
          getVariancePercent(target.dataItem) < 0 ? 90 : -90
        );
        arrow.adapters.add("dy", (dy, target) =>
          getVariancePercent(target.dataItem) < 0 ? -3 : dy
        );
        return am5.Bullet.new(rootVI, { locationY: 1, sprite: arrow });
      });

      seriesVI.appear();
      chartVI.appear(800, 80);

      function getVariancePercent(dataItem) {
        if (!dataItem) return NaN;
        const v = dataItem.get("valueY");
        const o = dataItem.get("openValueY");
        if (!o || !isFinite(v) || !isFinite(o)) return NaN;
        const change = v - o;
        return Math.round((change / o) * 100);
      }
    }
    // 4) 비용구조 도넛
    async function renderCostStructureDonut({
      doc,
      mountId = "costDonutWrap",
      titleId = "costDonutTitle",
      seq_no,
      work_yy,
      fiscalMM = 12,
      includeTax = true,
      data
    }) {
      const ctx = doc?.defaultView || window;
      const { am5, am5percent, am5themes_Animated } = ctx;
      const nf = new Intl.NumberFormat("ko-KR");
      const mount = doc.getElementById(mountId);
      const titleEl = doc.getElementById(titleId);
      if (!mount) return;

      if (!am5 || !am5percent || !am5themes_Animated) { console.error("amCharts not ready"); return; }

      if (mount.__am5root) { try { mount.__am5root.dispose(); } catch (_) {} mount.__am5root = null; }
      mount.style.overflow = "visible";
      mount.innerHTML = `<div style="color:#64748b;padding:12px">비용구조를 불러오는 중…</div>`;

      const rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"PL" });

      if (!rows.length) {
        mount.innerHTML = `<div style="color:#64748b;padding:12px">데이터가 없습니다.</div>`;
        if (titleEl) titleEl.textContent = "비용구조";
        return;
      }

      const latest = rows[rows.length - 1];

      const pieces = [
        { category:"매출원가",  value: latest.cogs },
        { category:"급여",      value: latest.salary },
        { category:"기타판관비", value: latest.sga },
        { category:"영업외비용", value: latest.nonOp },
        ...(includeTax ? [{ category:"세금", value: latest.tax }] : [])
      ].filter(x => x.value > 0);

      const totalCost = pieces.reduce((s, x) => s + x.value, 0);
      if (titleEl) titleEl.textContent = `비용구조 (합계: ${nf.format(totalCost)} 원)`;

      mount.innerHTML = "";
      const root = am5.Root.new(mount);
      mount.__am5root = root;
      // ▼ amCharts 워터마크 제거
      root._logo && root._logo.dispose();
      root.numberFormatter.setAll({
        numberFormat:"#a",
        bigNumberPrefixes:[
          { number:1e4, suffix:"만" },
          { number:1e6, suffix:"백만" },
          { number:1e8, suffix:"억" }
        ],
        smallNumberPrefixes:[]
      });
      root.setThemes([ am5themes_Animated.new(root) ]);

      const chart = root.container.children.push(
        am5percent.PieChart.new(root, {
          layout: root.verticalLayout,
          innerRadius: am5.percent(60),
          paddingTop: 6, paddingRight: 6, paddingBottom: 6, paddingLeft: 6
        })
      );

      const series = chart.series.push(
        am5percent.PieSeries.new(root, {
          name: "비용구조",
          categoryField: "category",
          valueField: "value",
          legendLabelText: "{category}",
          legendValueText: "{value.formatNumber('#,###')}",
          tooltip: am5.Tooltip.new(root, { forceHidden:true })
          /*tooltip: am5.Tooltip.new(root, {
            labelText: "{category}: {value.formatNumber('#,###')}"
          })*/
        })
      );

      series.labels.template.setAll({ forceHidden: true });
      series.ticks.template.setAll({ forceHidden: true });

      const COLORS = {
        "매출원가":   am5.color(0x60a5fa),
        "급여":       am5.color(0x34d399),
        "기타판관비": am5.color(0xfbbf24),
        "영업외비용": am5.color(0xa78bfa),
        "세금":       am5.color(0xf87171)
      };

      series.slices.template.adapters.add("fill", (fill, target) => {
        const cat = target.dataItem?.dataContext?.category;
        return COLORS[cat] || fill;
      });
      series.slices.template.adapters.add("stroke", () => am5.color(0xffffff));

      series.slices.template.setAll({
        strokeOpacity: 1,
        stroke: am5.color(0xffffff),
        strokeWidth: 2,
        fillOpacity: 1,
        interactive: false   // ★ 마우스 오버/클릭 효과 비활성화
      });

      series.data.setAll(pieces);

      const legend = chart.children.push(
        am5.Legend.new(root, { centerX: am5.p50, x: am5.p50, layout: root.verticalLayout, paddingTop: 8 })
      );
      legend.labels.template.setAll({
        width: 120, maxWidth: 120, oversizedBehavior: "truncate",
        textAlign: "left", fontSize: 12, fontWeight: "600"
      });
      legend.valueLabels.template.setAll({
        width: 110, maxWidth: 110, oversizedBehavior: "truncate",
        textAlign: "right", fontSize: 12, numberFormat: "#,###"
      });
      legend.itemContainers.template.setAll({ paddingTop: 2, paddingBottom: 2 });

      legend.markers.template.adapters.add("fill", (fill, target) => {
        const cat = target.dataItem?.dataContext?.category;
        return COLORS[cat] || fill;
      });
      legend.markers.template.adapters.add("stroke", () => am5.color(0xffffff));
      legend.data.setAll(series.dataItems);

      series.appear(800, 60);
      chart.appear(800, 60);
    }
    // 5) 3개년 납부세금 표
    async function renderProfitTaxTable({
      doc,
      mountId = "profitTaxWrap",
      seq_no,
      work_yy,
      fiscalMM,
      data,
      biz_type
    }) {
      const mount = doc.getElementById(mountId);
      if (!mount) return;

      mount.innerHTML = `<div style="padding:12px;color:#64748b">표를 불러오는 중…</div>`;

      const nf = new Intl.NumberFormat("ko-KR");
      const toMan = (v) => Math.round(toNum(v) / 1000); // 천원 단위
      const fmtMan = (v) => `${nf.format(toMan(v))} `;
      const pct = (a, b) => (toNum(b) ? (toNum(a) / toNum(b)) * 100 : 0);
      // ▶ biz_type 기준으로 kind 추론 후 taxName 결정
      const kind = Number(biz_type) > 3 ? "PERSON" : "CORP"; // 1~3: 법인, 그 외: 개인으로 가정
      const meta = { kind, tax_name: null }; // 나중에 필요하면 tax_name 채울 수 있음
      const taxName =
        meta.tax_name || (meta.kind === "CORP" ? "법인세" : "종합소득세");
      const rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"PL" });

      if (!rows.length) {
        mount.innerHTML = `<div style="padding:12px;color:#64748b">표시할 데이터가 없습니다.</div>`;
        return;
      }

      const sorted = [...rows].sort((a,b) => a.year - b.year);
      const last3 = sorted.slice(-3);

      const yLabels = last3.map(r => `${r.year}년`);
      const profits = last3.map(r => r.profit);
      const taxes   = last3.map(r => r.tax);
      const burdens = last3.map((_, i) => pct(taxes[i], profits[i]));

      const style = `
        <style>
          #${mountId} .pt-card{background:#fff;border:1px solid #e6ece8;border-radius:10px;box-shadow:0 2mm 6mm rgba(0,0,0,.06);overflow:hidden}
          #${mountId} .pt-head{display:flex;justify-content:space-between;align-items:flex-end;padding:10px 12px;background:linear-gradient(180deg,#f7faf8,#eef4f0);border-bottom:1px solid #e6ece8}
          #${mountId} .pt-head .title{font-weight:800;font-size:18px;color:#0f5132}
          #${mountId} .pt-head .meta{font-size:12px;color:#6b7280}
          #${mountId} table.ba{width:100%;border-collapse:collapse;font-size:13px}
          #${mountId} table.ba th,#${mountId} table.ba td{border-top:1px solid #eef1f4;padding:10px;text-align:center;vertical-align:middle}
          #${mountId} table.ba thead th{background:#f4f8f5;font-weight:700}
          #${mountId} table.ba td.label{width:110px;text-align:left;font-weight:700;color:#374151}
          #${mountId} .muted{color:#6b7280}
          #${mountId} .unit{font-size:12px;color:#94a3b8;white-space:nowrap}
          @media print{
            #${mountId} .pt-card{break-inside:avoid;page-break-inside:avoid}
            #${mountId} thead{display:table-header-group}
            #${mountId} tfoot{display:table-footer-group}
          }
        </style>
      `;
      const html = `
        ${style}
        <div class="pt-card">
          <div class="pt-head">
            <div class="title">순이익 · ${taxName} 요약</div>
            <div class="meta">단위: 천원</div>
          </div>
          <table class="ba">
            <thead>
              <tr>
                <th style="width:120px">구분</th>
                ${yLabels.map((y) => `<th>${y}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="label">당기순이익</td>
                ${profits
                  .map((v) => `<td><div>${fmtMan(v)}</div></td>`)
                  .join("")}
              </tr>
              <tr>
                <td class="label">${taxName}비용</td>
                ${taxes.map((v) => `<td><div>${fmtMan(v)}</div></td>`).join("")}
              </tr>
              <tr>
                <td class="label">${taxName}부담율</td>
                ${burdens
                  .map(
                    (p) =>
                      `<td><div>${isFinite(p) ? p.toFixed(2) : "0.00"}%</div></td>`
                  )
                  .join("")}
              </tr>
            </tbody>
          </table>
        </div>
      `;

      mount.innerHTML = html;
    }
    // 6) 주요 매입처 도넛
    async function renderTopPurchaseDonut({
      doc = document,
      mountEl = 'purchaseTopDonut',
      seq_no,
      work_yy,
      fiscalMM,
      biz_type,
      data
    } = {}) {
      const mount = (typeof mountEl === 'string') ? doc.getElementById(mountEl) : mountEl;
      if (!mount) { console.error('주요매입처 도넛 mount 요소를 찾을 수 없습니다:', mountEl); return; }

      mount.innerHTML = `<div style="padding:12px;color:#64748b">데이터를 불러오는 중…</div>`;

      if (mount.__am5_root) { try { mount.__am5_root.dispose(); } catch(e){} mount.__am5_root = null; }

      if (typeof $ === 'undefined') { mount.innerHTML = `<div style="padding:12px;color:#dc2626">jQuery가 필요합니다.</div>`; return; }
      if (!seq_no || !work_yy) { mount.innerHTML = `<div style="padding:12px;color:#dc2626">필수 파라미터(seq_no, work_yy)가 없습니다.</div>`; return; }

      const ctx = doc?.defaultView || window;
      const { am5, am5percent, am5themes_Animated: Animated } = ctx;
      if (!am5 || !am5percent || !Animated) {
        mount.innerHTML = `<div style="padding:12px;color:#dc2626">amCharts 라이브러리가 로드되지 않았습니다.</div>`;
        return;
      }

      const chartData = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"TOP_PURCHASE" });

      mount.innerHTML = "";
      const root = am5.Root.new(mount);
      mount.__am5_root = root;
      // ▼ amCharts 워터마크 제거
      root._logo && root._logo.dispose();  
      root.setThemes([ Animated.new(root) ]);

      const chart = root.container.children.push(
        am5percent.PieChart.new(root, {
          layout: root.horizontalLayout,
          innerRadius: am5.percent(60)
        })
      );

      const series = chart.series.push(
        am5percent.PieSeries.new(root, {
          valueField: "value",
          categoryField: "name",
          alignLabels: true
        })
      );

      // 툴팁 제거
      series.slices.template.setAll({ tooltipText: "" });
      const hiddenTip = am5.Tooltip.new(root, { forceHidden: true });
      series.set("tooltip", hiddenTip);

      series.labels.template.setAll({
        text: "{valuePercentTotal.formatNumber('#.##')}%",
        inside: true, fontSize: 12, fontWeight: "600", fill: am5.color(0x000000)
      });
      series.labels.template.adapters.add("visible", (visible, target) => {
        const di = target.dataItem;
        return di ? di.get("valuePercentTotal") >= 3 : false;
      });
      series.ticks.template.setAll({ forceHidden: false });

      series.data.setAll(chartData);

      const LABEL_W = 190;
      const VALUE_W = 140;

      const legend = chart.children.unshift(
        am5.Legend.new(root, {
          width: am5.percent(100),
          centerY: am5.p50, y: am5.p50,
          layout: root.verticalLayout
        })
      );
      legend.itemContainers.template.setAll({
        width: am5.percent(100),
        layout: root.horizontalLayout,
        paddingTop: 2, paddingBottom: 2
      });
      legend.markers.template.setAll({ width: 12, height: 12 });

      series.setAll({
        legendLabelText: "{category}",
        legendValueText: "{value.formatNumber('#,###')}원"
      });
      legend.labels.template.setAll({
        text: "{category}",
        fontSize: 14,
        minWidth: LABEL_W, width: LABEL_W, maxWidth: LABEL_W,
        oversizedBehavior: "truncate", ellipsis: "…"
      });
      legend.valueLabels.template.setAll({
        text: "{value.formatNumber('#,###')}원",
        fontSize: 14,
        minWidth: VALUE_W, width: VALUE_W, maxWidth: VALUE_W,
        textAlign: "right",
        fill: am5.color(0x8E7CD1),
        fontWeight: "bold"
      });
      legend.data.setAll(series.dataItems);

      chart.appear(0, 0);
      series.appear(0, 0);
    }
    // 7) 매입내역 증빙분석
    async function renderPurchaseEvidenceA4({
      doc = document,
      mountEl = 'purchaseEvidence',
      seq_no,
      work_yy,
      fiscalMM = 12,
      showSumRow = true,
      data
    } = {}) {
      const el = (typeof mountEl === "string") ? doc.getElementById(mountEl) : mountEl;
      if (!el) return;

      el.innerHTML = `<div style="padding:8px;color:#64748b;">데이터를 불러오는 중…</div>`;

      if (typeof $ === "undefined") {
        el.innerHTML = `<div style="padding:8px;color:#b23">jQuery가 필요합니다.</div>`;
        return;
      }
      if (!seq_no || !work_yy) {
        el.innerHTML = `<div style="padding:8px;color:#b23">필수 파라미터(seq_no, work_yy)가 없습니다.</div>`;
        return;
      }

      let rows = (data && data.length)
        ? data
        : await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"PURCHASE_EVID" });

      const MAX_ROWS = 5;
      const nf = new Intl.NumberFormat();

      rows = [...rows].sort((a,b)=>b.year - a.year).slice(0, MAX_ROWS);

      const bodyHtml =
        rows.map(r => `
          <tr>
            <td class="t-center">${r.year} 년</td>
            <td class="t-right">${nf.format(r.target)}</td>
            <td class="t-right">${nf.format(r.taxInv)}</td>
            <td class="t-right">${nf.format(r.inv)}</td>
            <td class="t-right">${nf.format(r.card)}</td>
            <td class="t-right">${nf.format(r.withhold)}</td>
            <td class="t-right t-bold"><span style="color:#f00">${nf.format(r.lack)}</span></td>
          </tr>
        `).join("")
        + Array.from({length: Math.max(0, MAX_ROWS - rows.length)}).map(() => `
          <tr><td colspan="7">&nbsp;</td></tr>
        `).join("");

      let sumRow = "";
      if (showSumRow && rows.length) {
        const s = rows.reduce((a,c)=>({
          target:a.target+c.target, taxInv:a.taxInv+c.taxInv, inv:a.inv+c.inv,
          card:a.card+c.card, withhold:a.withhold+c.withhold, lack:a.lack+c.lack
        }), {target:0, taxInv:0, inv:0, card:0, withhold:0, lack:0});
        sumRow = `
          <tr class="t-bold">
            <td class="t-center" style="background:#fafafa;">합 계</td>
            <td class="t-right"  style="background:#fafafa;">${nf.format(s.target)}</td>
            <td class="t-right"  style="background:#fafafa;">${nf.format(s.taxInv)}</td>
            <td class="t-right"  style="background:#fafafa;">${nf.format(s.inv)}</td>
            <td class="t-right"  style="background:#fafafa;">${nf.format(s.card)}</td>
            <td class="t-right"  style="background:#fafafa;">${nf.format(s.withhold)}</td>
            <td class="t-right"  style="background:#fafafa;"><span style="color:#f00">${nf.format(s.lack)}</span></td>
          </tr>
        `;
      }

      el.innerHTML = `
        <table class="tbl-arlist">
          <thead>
            <tr>
              <th>귀속연도</th>
              <th>검증대상금액</th>
              <th>세금계산서</th>
              <th>계산서</th>
              <th>신용카드 등</th>
              <th>원천징수</th>
              <th>증빙불비</th>
            </tr>
          </thead>
          <tbody>
            ${bodyHtml}
          </tbody>
        </table>
        <div class="notes-10">
          ※ 검증대상금액 = 유형자산 증가액 + 당기매입원가(상품/제조-기초원재료) + 급상여 + 기타판관비 − 감가상각비 − 퇴직연금운용자산
        </div>
      `;
    }
    // 8) 예상세금 및 평가의견
    async function renderTaxEstimateA4({
      doc = document,
      mountEl = 'taxEstimate',
      seq_no,
      work_yy,
      work_qt = 4,
      fiscalMM = 12,
      ctx = window,
      data
    } = {}) {
      const el = (typeof mountEl === "string") ? doc.getElementById(mountEl) : mountEl;
      if (!el) return;

      el.innerHTML = `<div style="padding:10px 0;color:#64748b;">데이터를 불러오는 중…</div>`;
      if (typeof $ === "undefined") { el.innerHTML = `<div style="padding:10px 0;color:#b23">jQuery가 필요합니다.</div>`; return; }
      if (!seq_no || !work_yy) { el.innerHTML = `<div style="padding:10px 0;color:#b23">필수 파라미터(seq_no, work_yy)가 없습니다.</div>`; return; }

      const res = data || await fetchPLData({ seq_no, work_yy, fiscalMM, flag:"TAX_ESTIMATE", work_qt });

      if (!res?.ok) { el.innerHTML = `<div style="padding:10px 0;color:#b23">예상세액 조회 실패</div>`; return; }

      const v = res.values || {};
      const taxName = res.tax_name || (res.kind === "CORP" ? "법인세" : "종합소득세");
      const endDate = res.endDate || "-";
      const nf = new Intl.NumberFormat();
      const n = (x)=> (typeof x === "number" ? x : Number(x||0)) || 0;

      const labelDefict = (res.kind === "CORP" ? "이월결손금" : "소득공제");

      const totalRelief = n(v.valGongje);
      const taxCredit   = n(v.tax_gongje ?? v.taxGongje ?? 0);
      const taxRelief   = Math.max(0, totalRelief - taxCredit);

      const uid = `tx-kpi-${Date.now()}-${Math.floor(Math.random()*1e5)}`;
      const lines = [];

      if (n(v.valKackRev) < 0) {
        lines.push(`※ 현재 손익계산서상 결손이며 해당 결손금은 향후 10년내 발생될 이익에서 공제됩니다.`);
        if (res.kind !== "CORP") {
          lines.push(`※ 타사업소득(부동산임대소득 제외)이 있는 경우 결손금은 통산됩니다.`);
        }
      } else {
        if (Number(work_qt) !== 4 && v.PREvalKackRev != null && v.PREvalTotalTax != null) {
          lines.push(`※ 현 추세대로의 연말 예상 세차감전이익은 <b>${nf.format(n(v.PREvalKackRev))}원</b>이며, 예상 ${taxName}(지방세포함)는 <b>${nf.format(n(v.PREvalTotalTax))}원</b> 입니다.`);
        }
      }

      if (res.kind !== "CORP") {
        if (n(v.valDefict) === 1_500_000) {
          lines.push(`※ 소득공제는 기본공제만을 적용했으니 부양가족 정보를 담당자에게 전달바랍니다.`);
        } else {
          lines.push(`※ 소득공제와 세액공제는 전년도에 적용한 부양가족공제 및 세액감면 비율을 적용하였으며 당기의 상황에 따라 변동될 수 있습니다.`);
        }
      } else {
        lines.push(`※ 세액공제는 전년도에 적용한 세액감면공제 비율을 적용하였으며 당기의 상황에 따라 변동될 수 있습니다.`);
      }

      const foot = lines.length ? `<div class="tx-foot">${lines.join("<br>")}</div>` : "";

      el.innerHTML = `
        <div id="${uid}" class="tx-kpi-root">
          <style>
            #${uid}{
              --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --bg:#fff;
              font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
              color:var(--ink);
            }
            #${uid} .kpi-grid{
              display: flex;
              flex-wrap: nowrap;
              gap: 12px;
              width: 100%;
              align-items: stretch;
            }
            #${uid} .kpi{
              flex: 1 1 0;
              border:1px solid var(--line); border-radius:12px; background:var(--bg);
              padding:14px 16px; box-shadow:0 1px 2px rgba(15,23,42,.04);
              display:flex; flex-direction:column; justify-content:center;
              min-height:102px; box-sizing:border-box;
            }
            #${uid} .kcap{ font-size:12px; color:var(--muted); margin-bottom:6px; }
            #${uid} .kval{ font-size:20px; font-weight:800; letter-spacing:.2px; }
            #${uid} .krows{ margin-top:6px; display:flex; flex-direction:column; gap:2px; }
            #${uid} .krow{ display:flex; align-items:center; justify-content:space-between; font-size:11px; color:var(--muted); }
            #${uid} .krow b{ color:#111827; font-weight:700; }
            #${uid} .chips{ display:flex; gap:8px; flex-wrap:nowrap; margin-top:12px; }
            #${uid} .chip{ background:#f1f5f9; border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
            #${uid} .tx-foot{ margin-top:10px; padding:6px 0; font-size:12px; }
            @media print{ #${uid} .kpi{ box-shadow:none; } }
          </style>

          <div class="kpi-grid">
            <div class="kpi">
              <div class="kcap">과세표준</div>
              <div class="kval">${nf.format(n(v.valKwase))}원</div>
              <div class="krows">
                <div class="krow"><span>세무조정</span><b>${nf.format(n(v.val_SEMUJJ))}원</b></div>
                <div class="krow"><span>${labelDefict}</span><b>${nf.format(n(v.valDefict))}원</b></div>
              </div>
            </div>

            <div class="kpi">
              <div class="kcap">산출세액</div>
              <div class="kval">${nf.format(n(v.valSanse))}원</div>
              <div class="krows">
                <div class="krow"><span>세율</span><b>${v.valTaxRate}%</b></div>
              </div>
            </div>

            <div class="kpi">
              <div class="kcap">총부담액</div>
              <div class="kval">${nf.format(n(v.valTotalTax))}원</div>
              <div class="krows">
                <div class="krow"><span>세액감면·공제</span><b>${nf.format(n(totalRelief))}원</b></div>
                <div class="krow"><span>지방세(10%)</span><b>${nf.format(n(v.valRegalTax))}원</b></div>
              </div>
            </div>
          </div>

          <div class="chips">
            <span class="chip">마감 기준: ${endDate}</span>
            <span class="chip">분기: ${Number(work_qt)||4}Q</span>
            <span class="chip">${res.kind==="CORP" ? "법인 기준" : "개인 기준"}</span>
          </div>

          ${foot}
        </div>
      `;
    }

    /* ======================= 4. 재무능력분석 start======================= */
    function renderFinanceIssueTable({ doc, mountId, seq_no, work_yy }) {
      const root = (typeof mountId === 'string') ? doc.getElementById(mountId) : mountId;
      if (!root) { console.error('mount element not found:', mountId); return; }
      const idp = `fi5_${mountId || 'mount'}`;
      const gid = (s) => `${idp}_${s}`;

      const LOG_TAG = `[FI][${seq_no}|${work_yy}]`;
      const log = (...args) => console.log(LOG_TAG, ...args);

      const toNum = (v) => {
        if (typeof v === 'number') return v;
        const s = String(v ?? '')
          .replace(/[,\s]/g, '')
          .replace(/[()]/g, '')
          .replace(/[–—−]/g, '-');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      };
      const fmt0 = (n)=> (n===null||n===undefined)? '' : toNum(n).toLocaleString('ko-KR');
      const fmt1 = (n)=> (n===null||n===undefined||!isFinite(n))? '' : (Math.round(n*10)/10).toLocaleString('ko-KR', {minimumFractionDigits:1, maximumFractionDigits:1});
      function normalizeByYears(years, seriesDict) {
        // years/series를 묶어서 연도 오름차순(과거→현재)으로 강제 정렬
        const len = (Array.isArray(years) ? years.length : 0);
        if (!len) return { years: [], ...Object.fromEntries(Object.keys(seriesDict||{}).map(k=>[k,[]])) };

        // 인덱스 테이블 만들고 오름차순 정렬
        const idxs = Array.from({length: len}, (_, i) => i)
          .sort((a, b) => (years[a] ?? 0) - (years[b] ?? 0));

        const sortedYears = idxs.map(i => years[i]);
        const out = { years: sortedYears };
        for (const [k, arr] of Object.entries(seriesDict || {})) {
          if (Array.isArray(arr)) out[k] = idxs.map(i => arr[i]);
          else out[k] = [];
        }
        return out;
      }

      function debugZipTable(title, years, dict) {
        // years와 각 시리즈를 인덱스별로 붙여서 console.table
        const rows = (years || []).map((yr, i) => {
          const r = { idx: i, year: yr };
          for (const [k, arr] of Object.entries(dict || {})) {
            r[k] = Array.isArray(arr) ? arr[i] : undefined;
          }
          return r;
        });
        console.group(title);
        console.table(rows);
        console.groupEnd();
      }
      /* ===== STYLE (요약표 + 차입상환능력) ===== */
      if (!doc.getElementById('fi5-style-notitle')) {
        const css = `
          :root{ --ink1:#0f172a; --ink2:#334155; --ink3:#64748b; --line:#e2e8f0; --card:#fff; --accent:#1a5a37;
                --ok:#065f46; --okbg:#ecfdf5; --okbd:#a7f3d0; --good:#14532d; --goodbg:#e7f5ec; --goodbd:#b7e4c7;
                --mid:#92400e; --midbg:#fff7ed; --midbd:#fed7aa; --bad:#991b1b; --badbg:#fef2f2; --badbd:#fecaca; }

          /* 재무이슈 체크리스트 (확정본) */
          .fi5-wrap{ background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 8px 22px rgba(2,6,23,.06); overflow:visible; }
          .fi5-body{ padding:12px 18px; }
          .fi5-table{ width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--line); border-radius:12px; overflow:hidden; color:var(--ink2); }
          .fi5-table thead th{
            position:sticky; top:0; z-index:1; background:linear-gradient(180deg,#fff,#f9fafb);
            padding:8px 10px; border-bottom:1px solid var(--line); font-weight:800; color:var(--ink1); font-size:13px; white-space:nowrap;
          }
          .fi5-table tbody td{ padding:8px 10px; border-bottom:1px solid var(--line); background:#fff; font-size:13px; line-height:1.25; }
          .fi5-table tbody tr:nth-child(odd) td{ background:#fcfeff; }
          .fi5-table tbody tr:hover td{ background:#f6fffb; }
          .fi5-table th:last-child,
          .fi5-table td:last-child { width:180px; }   /* 필요시 170~190px로 조절 */
          .fi5-table td:last-child { padding-right:12px; } /* 살짝 여백 */

          .fi5-rule{ display:flex; align-items:center; gap:10px; }
          .fi5-tag{ min-width:38px; text-align:center; font-size:11px; color:#fff; background:var(--accent); border-radius:999px; padding:4px 8px; }
          .fi5-name{ font-weight:800; color:var(--ink1); }
          .fi5-desc{ font-size:12px; color:var(--ink3); margin-top:2px; }
          .fi5-chip{ display:inline-flex; align-items:center; justify-content:center; min-width:34px; height:26px; padding:0 8px; border-radius:999px;
                    font-weight:800; border:1px dashed #e2e8f0; }
          .fi5-chip.on{ border-style:solid; color:#1f6d55; background:linear-gradient(180deg,#f0fff7,#ecfdf5); border-color:rgba(26,90,55,.32); }
          .fi5-chip.off{ background:#f1f5f9; color:#94a3b8; }
          .fi5-score{ display:flex; align-items:center; gap:6px; }
          .fi5-bar{ position:relative; height:8px; background:#eef2f7; border-radius:999px; flex:1; }
          .fi5-bar > i{ position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,#eab308,#ef4444); border-radius:999px; }
          .fi5-badge{ display:none !important; }  /* 숫자 제거 */

          /* 차입상환 능력 */
          .loan-card{ border:1px solid var(--line); border-radius:12px; overflow:hidden; }
          .loan-head{ padding:10px 12px; background:linear-gradient(180deg,#fff,#f6f8fa); border-bottom:1px solid var(--line); font-weight:800; color:var(--ink1); font-size:13px; }
          .loan-body{ padding:10px 12px 12px; }
          .loan-table{ width:100%; border-collapse:separate; border-spacing:0; }
          .loan-table thead th{ background:linear-gradient(180deg,#fff,#f2f5f7); border:1px solid var(--line); border-bottom:0; padding:8px 10px; font-weight:800; color:var(--ink1); font-size:12px; text-align:center; white-space:nowrap; }
          .loan-table thead th:first-child{ border-top-left-radius:10px; }
          .loan-table thead th:last-child{ border-top-right-radius:10px; }
          .loan-table tbody td{ border-left:1px solid var(--line); border-bottom:1px solid var(--line); padding:8px 10px; font-size:12px; line-height:18px; color:var(--ink2); background:#fff; vertical-align:middle; }
          .loan-table tbody tr td:last-child{ border-right:1px solid var(--line); }
          .loan-table th, .loan-table td{ white-space:nowrap; word-break:keep-all; }
          .nowrap{ white-space:nowrap !important; }      
          .t-left{ text-align:left; } .t-center{ text-align:center; } .t-right{ text-align:right; }
          .muted{ color:var(--ink3); }
          .lv{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; border:1px solid var(--line); }
          .lv-exc{ color:var(--ok); background:var(--okbg); border-color:var(--okbd); }
          .lv-good{ color:var(--good); background:var(--goodbg); border-color:var(--goodbd); }
          .lv-mid{ color:var(--mid); background:var(--midbg); border-color:var(--midbd); }
          .lv-bad{ color:var(--bad); background:var(--badbg); border-color:var(--badbd); }
          .legend{ border-top:1px dashed var(--line); margin-top:8px; padding-top:8px; font-size:12px; color:var(--ink3); }
          @media print{ .fi5-wrap, .fi5-body{ box-shadow:none; } }
        `;
        const st = doc.createElement('style'); st.id = 'fi5-style-notitle'; st.textContent = css;
        doc.head.appendChild(st);
      }

      /* ===== SKELETON ===== */
      root.innerHTML = `
        <div class="subsec-title"><span class="dot"></span>핵심 지표</div>
        <div class="table-responsive" id="${gid('wrap')}">
          <table class="fi5-table">
            <thead>
              <tr>
                <th style="min-width:260px;">이슈(규칙)</th>
                <th id="${gid('y2h')}">Y-2</th>
                <th id="${gid('y1h')}">Y-1</th>
                <th id="${gid('y0h')}">Y</th>
                <th style="min-width:180px;">심각도</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="5">데이터를 불러오는 중…</td></tr></tbody>
          </table>
        </div>

        <div class="subsec-title"><span class="dot"></span>차입금 상환능력</div>

        <!-- ★ 여기 추가: loanCard 래퍼 생성 -->
        <div id="${gid('loanCard')}" class="loan-card">
          <div class="loan-body">
            <table class="loan-table">
              <thead>
                <tr>
                  <th width="100">구 분</th>
                  <th width="120">이자비용</th>
                  <th width="120">영업이익</th>
                  <th width="120">차입금합계</th>
                  <th width="120">이자보상배율(배)</th>
                  <th width="120">차입상환기간(연)</th>
                  <th width="120">차입상환능력</th>
                </tr>
              </thead>
              <tbody id="${gid('loanTbody')}">
                <tr><td colspan="7" class="t-center muted">데이터를 불러오는 중…</td></tr>
              </tbody>
            </table>
            <div class="legend">
              ※ 이자보상배율(배) : 영업이익 / 금융비용(매출채권처분손실 포함)<br/>
              ※ 차입상환기간(연) : 영업이익으로 차입금을 전액 상환하는데 소요될 것으로 예상되는 기간
            </div>
          </div>
        </div>
      `;


      /* ===== RULES META (이슈표) ===== */
      const RULES = [
        { idx:0,  tag:'성장',     name:'매출액 감소(전년 -30%)',                    desc:'전년 대비 큰 폭의 매출 감소' },
        { idx:1,  tag:'수익성',   name:'영업이익 감소(전년 -30%)',                  desc:'영업이익 급감' },
        { idx:3,  tag:'회수',     name:'매출채권/매출액 > 50%',                     desc:'회수기간 장기화·연체 위험' },
        { idx:5,  tag:'손익',     name:'영업손실(영업이익<0)',                       desc:'핵심 영업 적자' },
        { idx:7,  tag:'차입',     name:'차입금 증가 30%↑',                          desc:'부채 급증' },
        { idx:8,  tag:'레버리지', name:'차입금/총자산 > 50%',                       desc:'부채 의존도 과다' },
        { idx:9,  tag:'유동성',   name:'단기차입/총차입 > 90% (전제: 총차입/총자산>50%)', desc:'만기구조 불리' },
        { idx:10, tag:'건전성',   name:'부채비율 300%↑',                            desc:'자본 대비 부채 과다' },
        { idx:11, tag:'자본',     name:'일부 자본잠식',                              desc:'자본금 일부 잠식' },
        { idx:12, tag:'자본',     name:'완전 자본잠식',                              desc:'자본총액 음수' },
      ];

      // refs
      const wrap = doc.getElementById(gid('wrap'));
      const issueTbody = wrap.querySelector('tbody');
      const y2h = doc.getElementById(gid('y2h'));
      const y1h = doc.getElementById(gid('y1h'));
      const y0h = doc.getElementById(gid('y0h'));
      const loanCard = doc.getElementById(gid('loanCard'));
      const loanTbody = doc.getElementById(gid('loanTbody'));

      /* ===== LOAD (1차: ISSUE_TABLE) ===== */
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, work_yy, flag: "ISSUE_TABLE" },
        dataType: "json"
      }).done(function(res){
        log('ISSUE_TABLE res:', res);

        if (!res?.ok) {
          issueTbody.innerHTML = `<tr><td colspan="5">데이터 로드 실패</td></tr>`;
          return;
        }

        y2h.textContent = String(res.years?.[0] ?? 'Y-2');
        y1h.textContent = String(res.years?.[1] ?? 'Y-1');
        y0h.textContent = String(res.years?.[2] ?? 'Y');

        renderIssues(res);

        if (hasLoanArrays(res)) {
          renderLoan(res);
        } else {
          $.ajax({
            url: "{% url 'getFinancialData_Report' %}",
            data: { seq_no, work_yy, flag: "LOAN_TABLE" },
            dataType: "json"
          }).done(function(lo){
            log('LOAN_TABLE res:', lo);
            if (lo?.ok) renderLoan(lo);
            else if (loanCard) loanCard.style.display = 'none';
          }).fail(function(err){
            log('LOAN_TABLE fail:', err?.status, err);
            if (loanCard) loanCard.style.display = 'none';
          });
        }
      }).fail(function(xhr){
        log('ISSUE_TABLE fail:', xhr?.status, xhr);
        issueTbody.innerHTML = `<tr><td colspan="5">요청 실패(${xhr.status})</td></tr>`;
      });

      /* ===== 이슈표 렌더 ===== */
      function renderIssues(data){
        const { financeIssue } = data;
        const chip = (on) => `<span class="fi5-chip ${on ? 'on' : 'off'}">${on ? '√' : '–'}</span>`;
        const sevPct = (s) => Math.round((s/6)*100); // 3+2+1

        const rows = RULES.map(r => {
          const y2 = financeIssue?.[0]?.[r.idx] === '√';
          const y1 = financeIssue?.[1]?.[r.idx] === '√';
          const y0 = financeIssue?.[2]?.[r.idx] === '√';
          const sev = (y0?3:0) + (y1?2:0) + (y2?1:0);
          return { r, y2, y1, y0, sev };
        });

        issueTbody.innerHTML = rows.map(x => `
          <tr>
            <td>
              <div class="fi5-rule">
                <span class="fi5-tag">${x.r.tag}</span>
                <div>
                  <div class="fi5-name">${x.r.name}</div>
                  <div class="fi5-desc">${x.r.desc}</div>
                </div>
              </div>
            </td>
            <td class="text-center">${chip(x.y2)}</td>
            <td class="text-center">${chip(x.y1)}</td>
            <td class="text-center">${chip(x.y0)}</td>
            <td>
              <div class="fi5-score">
                <div class="fi5-bar"><i style="width:${sevPct(x.sev)}%"></i></div>
                <div class="fi5-badge">${x.sev}</div>
              </div>
            </td>
          </tr>
        `).join('');
      }

      /* ===== 차입상환능력 렌더 ===== */
      function renderLoan(data){
        const years = Array.isArray(data?.years) ? data.years.slice() : [];

        // keyValues 혹은 루트에서 배열 얻기
        const getArr = (key) => {
          if (Array.isArray(data?.keyValues?.[key])) return data.keyValues[key].slice();
          if (Array.isArray(data?.[key]))           return data[key].slice();
          return [];
        };

        const J10  = getArr('J10');    // 영업이익
        const Z951 = getArr('Z951');   // 이자비용
        const Z260 = getArr('Z260');   // 단기차입
        const Z293 = getArr('Z293');   // 장기차입

        // 길이/존재 디버그
        log('RAW arrays len:', {
          years: years.length, J10: J10.length, Z951: Z951.length, Z260: Z260.length, Z293: Z293.length
        });

        if (!(J10.length && Z951.length && (Z260.length || Z293.length))) {
          log('Hide loanCard: required arrays missing');
          if (loanCard) loanCard.style.display = 'none';
          return;
        }

        // 총차입 = 단기+장기(없으면 0)
        const debtArr = years.map((_, i) => toNum(Z260[i]) + toNum(Z293[i]));
        // 공통 길이(최소 길이)에 맞춰 자르기 (years도 포함)
        const lens = [years.length, J10.length, Z951.length, debtArr.length].filter(Boolean);
        const minLen = Math.min.apply(null, lens.length ? lens : [0]);
        if (minLen === 0) {
          log('Hide loanCard: minLen=0');
          if (loanCard) loanCard.style.display = 'none';
          return;
        }

        const Y   = years.slice(-minLen);
        const OP  = J10.slice(-minLen);
        const INT = Z951.slice(-minLen);
        const DEBT= debtArr.slice(-minLen);

        // 최신연도부터 최대 3개
        const end = minLen - 1;
        const start = Math.max(0, end - 2);
        const idxs = [];
        for (let i=end; i>=start; i--) idxs.push(i);

        // 인덱스 매핑 로그
        log('Aligned lengths:', { minLen, pickIdxsDesc: idxs });
        log('Aligned tail samples:', {
          years: Y.slice(start, end+1),
          J10:   OP.slice(start, end+1),
          Z951:  INT.slice(start, end+1),
          DEBT:  DEBT.slice(start, end+1)
        });

        // 행 계산 + 결과 로그용 수집
        const debugRows = [];

        const rows = idxs.map(i => {
          const yr = Y[i] ?? '';
          const interest = toNum(INT[i]);
          const op = toNum(OP[i]);
          const debt = toNum(DEBT[i]);

          let icr = null; // 영업이익/이자
          if (op > 0 && interest > 0) icr = op / interest;

          let payback = null; // 차입/영업이익
          if (op > 0) {
            payback = debt / op;
          } else if (debt === 0) {
            payback = 0;
          }

          let lvlTxt = '', lvlCls = 'lv lv-mid';
          if (icr !== null && payback !== null) {
            if (icr > 3 && payback < 3)      { lvlTxt='우수';  lvlCls='lv lv-exc'; }
            else if (icr > 3 && payback > 3) { lvlTxt='양호';  lvlCls='lv lv-good'; }
            else if (icr < 3 && payback < 3) { lvlTxt='보통';  lvlCls='lv lv-mid'; }
            else                             { lvlTxt='미흡';  lvlCls='lv lv-bad'; }
          } else if (debt === 0) {
            lvlTxt = '무차입'; lvlCls = 'lv lv-exc';
          }

          debugRows.push({
            idx:i, year:yr, interest_raw: INT[i], op_raw: OP[i], debt_raw: DEBT[i],
            interest, op, debt, icr, payback, level:lvlTxt
          });

          return `
            <tr>
              <td class="t-center nowrap">${yr} 년</td>
              <td class="t-right nowrap">${fmt0(interest)}</td>
              <td class="t-right nowrap">${fmt0(op)}</td>
              <td class="t-right nowrap">${fmt0(debt)}</td>
              <td class="t-center nowrap">${fmt1(icr)}</td>
              <td class="t-center nowrap">${fmt1(payback)}</td>
              <td class="t-center nowrap">${lvlTxt ? `<span class="${lvlCls}">${lvlTxt}</span>` : ''}</td>
            </tr>`;
        }).join('');

        // 결과 테이블 로그
        console.table(debugRows);

        if (!loanTbody) {
          log('loanTbody not found – hiding loanCard');
          if (loanCard) loanCard.style.display = 'none';
          return;
        }
        loanTbody.innerHTML = rows || `<tr><td colspan="7" class="t-center muted">표시할 데이터가 없습니다.</td></tr>`;
      }

      function hasLoanArrays(d){
        const kv = d?.keyValues || d || {};
        const ok = (Array.isArray(kv.J10) || Array.isArray(d?.J10))
                && (Array.isArray(kv.Z951) || Array.isArray(d?.Z951))
                && ((Array.isArray(kv.Z260) || Array.isArray(d?.Z260)) || (Array.isArray(kv.Z293) || Array.isArray(d?.Z293)));
        log('hasLoanArrays:', ok, {
          kvJ10: Array.isArray(kv.J10), kvZ951: Array.isArray(kv.Z951), kvZ260: Array.isArray(kv.Z260), kvZ293: Array.isArray(kv.Z293),
          rootJ10: Array.isArray(d?.J10), rootZ951: Array.isArray(d?.Z951), rootZ260: Array.isArray(d?.Z260), rootZ293: Array.isArray(d?.Z293)
        });
        return ok;
      }
    }
    /* ======================= 5. 재무비율 start======================= */
    function renderFinanceRatios(doc, mountId, seq_no, work_yy, work_qt){
      // 인자 정규화
      var entityType, work_qt;
      if (arguments.length === 1 && typeof doc === 'object' && doc !== null) {
        var p = doc;
        work_yy  = p.work_yy;
        seq_no   = p.seq_no;
        mountId  = p.mountId;
        work_qt  = p.work_qt;                 // ← 분기 전달 받기(선택)
        doc      = p.doc || document;
        entityType = p.entityType || p.bizType || (p.isCorporate===false?'individual':'corporate');
      } else { doc = doc || document; }
      var D = doc;

      function resolveMount(D, mount){
        if (mount && typeof mount==='object' && mount.jquery) return mount[0];
        if (mount && typeof mount==='object' && mount.nodeType===1) return mount;
        if (typeof mount==='string'){ var el=D.getElementById(mount); if (el) return el; }
        var id=(typeof mount==='string'&&mount.trim())?mount:'ratioMount';
        var el2=D.getElementById(id);
        if(!el2){ el2=D.createElement('div'); el2.id=id; (D.body||D.documentElement).appendChild(el2); }
        return el2;
      }

      function ensureStyle(){
        if (D.getElementById('ratio-ux-style')) return;
        var css=`
        :root{
          --ink:#0b1220; --ink-2:#3b4250; --ink-3:#7a8394;
          --line:#e7ebf0; --bg:#fff; --accent:#0ea5e9;
          --muted:#9aa3af;
          --tone-blue:#2563eb; --tone-blue-2:#1d4ed8;
          --tone-green:#22c55e; --tone-green-2:#16a34a;
          --tone-red:#ef4444; --tone-red-2:#dc2626;
        }
        *{ box-sizing:border-box }
        .ratio-wrap{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; color:var(--ink) }
        .ratio-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:10px }
        @media print{ .ratio-grid{ gap:6px } }

        .card{ background:var(--bg); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(13,20,33,.04) }
        .kpi{ grid-column:span 6; display:grid; grid-template-columns:1fr; row-gap:8px; min-height:120px }
        .kpi .head{ display:flex; align-items:center; justify-content:space-between; gap:8px }
        .kpi .title{ font-weight:800; font-size:13px; color:var(--ink-2) }
        .kpi .pill{ font-size:10px; font-weight:800; padding:2px 6px; border-radius:999px; border:1px solid var(--line); background:#f1f5f9; color:#7a8394 }
        .kpi .value-row{ display:flex; align-items:baseline; gap:8px; flex-wrap:wrap }
        .kpi .value{ font-size:26px; font-weight:800; letter-spacing:-.3px }
        .kpi .unit{ font-size:11px; color:var(--muted) }
        .kpi .desc{ font-size:11px; color:var(--ink-3); line-height:1.4 }

        .kpi .years{ margin-top:6px; display:grid; grid-template-columns:1fr; row-gap:6px }
        .kpi .badge{
          display:flex; align-items:center; justify-content:space-between; gap:10px;
          font-size:12px; border:1px dashed var(--line); border-radius:10px; padding:6px 8px; background:#fafbfc
        }
        .kpi .badge .yy{ color:var(--ink-3); font-weight:700 }
        .kpi .badge .val{ color:var(--ink-2); font-weight:800 }

        .kpi--important{ position:relative }
        .kpi--important::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:14px; border-bottom-left-radius:14px }
        .tone-blue{ border-color:rgba(37,99,235,.25); background:linear-gradient(180deg, rgba(37,99,235,.05), rgba(37,99,235,0)) }
        .tone-blue::before{ background:linear-gradient(180deg, var(--tone-blue), var(--tone-blue-2)) }
        .tone-blue .title{ color:#1e3a8a } .tone-blue .pill{ background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe }
        .tone-blue .badge{ border-color:#dbeafe; background:#eff6ff }

        .tone-green{ border-color:rgba(34,197,94,.28); background:linear-gradient(180deg, rgba(34,197,94,.06), rgba(34,197,94,0)) }
        .tone-green::before{ background:linear-gradient(180deg, var(--tone-green), var(--tone-green-2)) }
        .tone-green .title{ color:#065f46 } .tone-green .pill{ background:#ecfdf5; color:#059669; border-color:#a7f3d0 }
        .tone-green .badge{ border-color:#bbf7d0; background:#ecfdf5 }

        .tone-red{ border-color:rgba(239,68,68,.25); background:linear-gradient(180deg, rgba(239,68,68,.05), rgba(239,68,68,0)) }
        .tone-red::before{ background:linear-gradient(180deg, var(--tone-red), var(--tone-red-2)) }
        .tone-red .title{ color:#7f1d1d } .tone-red .pill{ background:#fff1f2; color:#be123c; border-color:#fecdd3 }
        .tone-red .badge{ border-color:#ffd5dc; background:#fff7f8 }

        /* 핵심/기타 동일: 연도 아래 값 3열 */
        .kpi--yearUnder .years{ grid-template-columns:repeat(3,1fr); column-gap:8px; row-gap:0 }
        .kpi--yearUnder .badge{ flex-direction:column; align-items:center; justify-content:center; gap:4px; text-align:center; padding:8px 6px; }
        .kpi--yearUnder .badge .yy{ font-size:11px; color:#6b7280; }
        .kpi--yearUnder .badge .val{ font-size:14px; }
        `;
        var st=D.createElement('style'); st.id='ratio-ux-style'; st.innerHTML=css;
        (D.head||D.documentElement).appendChild(st);
      }

      function pct(n,dp){ dp=dp==null?1:dp; if(!isFinite(n)) return '-'; return (n*100).toFixed(dp)+'%'; }
      function toNum(v){ if(typeof v==='number') return v; if(v==null) return 0; var n=Number(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; }

      // usePreTax가 true면 N10(법인세차감전이익) 기반으로 ROS/ROI/ROE/순이익증가율 계산
      function buildMetrics(d, usePreTax){
        function pick(k){ return Array.isArray(d[k]) ? d[k] : [0,0,0]; }
        var E10=pick('E10'), J10=pick('J10'), Q10=pick('Q10');
        var N10=pick('N10'); // 법인세차감전이익
        var A00=pick('A00'), A10=pick('A10'), B00=pick('B00'), B10=pick('B10');
        var C00=Array.isArray(d.C00)? d.C00 : A00.map(function(_,i){ return toNum(A00[i]) - toNum(B00[i]); });

        var NI = usePreTax ? N10 : Q10;  // ← 핵심 포인트

        var r={};
        // 공통 수익성
        r.opMargin  = E10.map(function(_,i){ return toNum(E10[i]) ? toNum(J10[i])/toNum(E10[i]) : 0; }); // 영업이익률
        r.ros       = E10.map(function(_,i){ return toNum(E10[i]) ? toNum(NI[i])/toNum(E10[i]) : 0; });  // ROS: 분기중엔 N10 사용
        // ROI/ROE
        r.roi       = [0,1,2].map(function(i){ return toNum(A00[i]) ? toNum(NI[i])/toNum(A00[i]) : 0; }); // 분기중엔 N10 사용
        r.roe       = [0,1,2].map(function(i){
          var avgEquity = (i>0) ? (toNum(C00[i-1])+toNum(C00[i]))/2 : toNum(C00[i]);
          return avgEquity ? toNum(NI[i]) / avgEquity : 0; // 분기중엔 N10 사용
        });

        // 안정성
        r.currentRatio = [0,1,2].map(function(i){ return toNum(B10[i]) ? toNum(A10[i])/toNum(B10[i]) : 0; });
        r.debtRatio    = [0,1,2].map(function(i){ return toNum(C00[i]) ? toNum(B00[i])/toNum(C00[i]) : 0; });

        // 법인/개인용 지표
        r.equityRatio       = [0,1,2].map(function(i){ return toNum(A00[i]) ? toNum(C00[i])/toNum(A00[i]) : 0; });
        r.equityGrowth      = [0,1,2].map(function(i){ return i ? (toNum(C00[i])-toNum(C00[i-1]))/Math.abs(toNum(C00[i-1])||1) : 0; });

        r.currentAssetRatio = [0,1,2].map(function(i){ return toNum(A00[i]) ? toNum(A10[i])/toNum(A00[i]) : 0; });
        r.totalAssetGrowth  = [0,1,2].map(function(i){ return i ? (toNum(A00[i])-toNum(A00[i-1]))/Math.abs(toNum(A00[i-1])||1) : 0; });

        // 순이익증가율도 분기중에는 N10 기반
        r.opProfitGrowth    = [0,1,2].map(function(i){ return i ? (toNum(J10[i])-toNum(J10[i-1]))/Math.abs(toNum(J10[i-1])||1) : 0; });
        r.netProfitGrowth   = [0,1,2].map(function(i){ return i ? (toNum(NI[i])-toNum(NI[i-1]))/Math.abs(toNum(NI[i-1])||1) : 0; });
        return r;
      }

      function judgeCurrentRatio(val){ var p=(val||0)*100; if (p>=150) return {tone:'tone-blue', label:'좋음'}; if (p>=100) return {tone:'tone-green', label:'보통'}; return {tone:'tone-red', label:'주의'}; }
      function judgeDebtRatio(val){   var p=(val||0)*100; if (p<=100) return {tone:'tone-blue', label:'좋음'}; if (p<=200) return {tone:'tone-green', label:'보통'}; return {tone:'tone-red', label:'주의'}; }

      var mount = resolveMount(D, mountId);
      ensureStyle();
      mount.innerHTML = '<div style="padding:16px;color:#7a8394">지표를 불러오는 중...</div>';

      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no: seq_no, work_yy: work_yy, flag: "RATIOS" },
        dataType: "json"
      }).done(function(res){
        var body = res && (res.data || res) || {};

        // entityType & work_qt 추론
        var inferredType = (function(b){
          var t = (entityType || b.biz_type || b.entity_type);
          if (!t && typeof b.is_corporate === 'boolean') t = b.is_corporate ? 'corporate' : 'individual';
          t = (t||'').toString().toLowerCase();
          if (t==='corp' || t==='corporation' || t==='법인') t='corporate';
          if (t==='개인사업자' || t==='개인' || t==='sole' || t==='soleprop' || t==='individual') t='individual';
          return t || 'corporate';
        })(body);
        entityType = inferredType;

        var qt = Number(work_qt != null ? work_qt : (body.work_qt != null ? body.work_qt : 4));
        var usePreTax = qt < 4; // ← 분기중이면 세전이익(N10) 사용

        var years = body.years || [work_yy-2, work_yy-1, work_yy];
        var m = buildMetrics(body, usePreTax);

        var EXPL = {
          currentRatio   : '단기부채를 단기자산으로 갚을 수 있는 능력입니다. (기준 100%)',
          debtRatio      : '타인자본 대비 자기자본 비율입니다. 낮을수록 안정적. (기준 100%)',
          opMargin       : '매출액 대비 영업이익 비율(본업 수익성).',
          ros            : usePreTax ? '매출 대비 세전이익 비율입니다. (분기중 임시)' : '매출 대비 최종 순이익 비율입니다.',
          roi            : usePreTax ? '총자산 대비 세전이익률입니다. (분기중 임시)' : '총자산을 이익으로 전환하는 효율입니다.',
          roe            : usePreTax ? '평균자본 대비 세전이익률입니다. (분기중 임시)' : '자기자본이 순이익을 얼마나 효율적으로 창출했는지.',
          equityRatio    : '총자산 중 자기자본이 차지하는 비중입니다.',
          equityGrowth   : '전기 대비 자기자본의 증감률입니다.',
          currentAssetRatio: '총자산 중 유동자산 비중(현금화 용이성).',
          totalAssetGrowth : '전기 대비 총자산 증가율입니다.',
          opProfitGrowth   : '전기 대비 영업이익 증가율입니다.'
        };

        var fmt = { pct:v=>pct(v,1) };

        var cards_core = [
          { key:'currentRatio',  title:'유동비율', unit:'%', values:m.currentRatio.map(fmt.pct), now:m.currentRatio[2], important:true, judge:judgeCurrentRatio },
          { key:'debtRatio',     title:'부채비율', unit:'%', values:m.debtRatio.map(fmt.pct),    now:m.debtRatio[2],    important:true, judge:judgeDebtRatio },
        ];

        var cards_common = [
          { key:'opMargin', title:'영업이익률',     unit:'%', values:m.opMargin.map(fmt.pct), now:m.opMargin[2] },
          { key:'ros',      title: usePreTax ? '세전이익률(ROS 대체)' : '순이익률(ROS)', unit:'%', values:m.ros.map(fmt.pct), now:m.ros[2] },
        ];

        var cards_others = (entityType==='individual')
          ? [
              { key:'currentAssetRatio',title:'유동자산비율',   unit:'%', values:m.currentAssetRatio.map(fmt.pct), now:m.currentAssetRatio[2] },
              { key:'totalAssetGrowth', title:'총자산증가율',   unit:'%', values:m.totalAssetGrowth.map(fmt.pct),  now:m.totalAssetGrowth[2] },
              { key:'opProfitGrowth',   title:'영업이익증가율', unit:'%', values:m.opProfitGrowth.map(fmt.pct),    now:m.opProfitGrowth[2] },
            ]
          : [
              { key:'roi',              title: usePreTax ? '세전 총자본이익률(ROI)' : '총자본이익률(ROI)', unit:'%', values:m.roi.map(fmt.pct), now:m.roi[2] },
              { key:'roe',              title: usePreTax ? '세전 자기자본이익률(ROE)' : '자기자본이익률(ROE)', unit:'%', values:m.roe.map(fmt.pct), now:m.roe[2] },
              { key:'equityRatio',      title:'자기자본비율',   unit:'%', values:m.equityRatio.map(fmt.pct),    now:m.equityRatio[2] },
              { key:'equityGrowth',     title:'자기자본증가율', unit:'%', values:m.equityGrowth.map(fmt.pct),   now:m.equityGrowth[2] },
            ];

        // 타이틀/레이아웃 (요청사항: 변경 금지)
        var wrap = D.createElement('div');
        wrap.className='ratio-wrap';
        wrap.innerHTML = `
          <div class="subsec-title"><span class="dot"></span>핵심 지표</div>
          <div class="ratio-grid" id="gridImportant"></div>

          <div class="subsec-title"><span class="dot"></span>기타 주요 지표</div>
          <div class="ratio-grid" id="gridOthers"></div>
        `;
        mount.innerHTML=''; mount.appendChild(wrap);

        var gridImportant = wrap.querySelector('#gridImportant');
        var gridOthers    = wrap.querySelector('#gridOthers');

        function renderCard(c, container, isCore){
          var card = D.createElement('div');
          var cls  = 'card kpi';

          // 핵심도, 기타도 동일하게 연도 아래 값 3열 + 핵심은 상태톤 유지
          if (isCore && c.judge) {
            var st = c.judge(c.now);
            cls += ' kpi--important ' + st.tone + ' kpi--yearUnder';
          } else {
            cls += ' kpi--yearUnder';
          }
          card.className = cls;

          var nowTxt  = pct(c.now,1);
          var pillTxt = isCore && c.judge ? c.judge(c.now).label : '참고';
          var pill    = `<span class="pill">${pillTxt}</span>`;
          var badges  = years.map(function(yy, idx){
            return `<div class="badge"><span class="yy">${yy}</span><span class="val">${c.values[idx]}</span></div>`;
          }).join('');

          card.innerHTML = `
            <div class="head">
              <div class="title">${c.title}</div>
              ${pill}
            </div>
            <div class="value-row">
              <div class="value">${nowTxt}</div>
              <div class="unit">현재</div>
            </div>
            <div class="desc">${EXPL[c.key] || ''}</div>
            <div class="years">${badges}</div>
          `;
          container.appendChild(card);
        }

        cards_core.forEach(function(c){ renderCard(c, gridImportant, true); });
        cards_common.forEach(function(c){ renderCard(c, gridOthers, false); });
        cards_others.forEach(function(c){ renderCard(c, gridOthers, false); });

      }).fail(function(xhr, status, err){
        console.error(err || status);
        mount.innerHTML = '<div style="padding:16px;color:#dc2626">지표 조회 중 오류가 발생했습니다.</div>';
      });
    }
    /* ======================= 6 재무제표 start======================= */
    function numberWithCommas(x){ if(x===null||x===""||typeof x==="undefined") return ""; const n=Number(x); return isNaN(n)?String(x):n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","); }
    function isNumber(v){ return /^\d+$/.test(String(v)); }
    function StatementDetail(props, opt = {}) {
      const doc = opt.doc || document;
      const tbodyId = opt.tbodyId || 'statmentBody';
      const pair = opt.pair || (opt.pair = { tmp: 0, tmpPre: 0 }); // ★ 공유 상태

      // 과목명(공백 보존)
      const acnt_nm_raw = String(props.acnt_nm || "");
      const acnt_nm = acnt_nm_raw.replaceAll(" ", "&nbsp;");

      // 값
      let rightAmt = Number(props.amt_now);
      let rightAmt_pre = Number(props.amt_bef);
      const acnt_cd = props.acnt_cd;
      let leftAmt = 0;
      let leftAmt_pre = 0;
      let isModAcc = 0;

      // 숫자 코드가 아니면(집계행 등) 누적 리셋 후 그대로 행 생성
      const isCodeNum = isNumber(props.acnt_cd);
      if (!isCodeNum) {
        // 누적 리셋(섹션/소계 등 경계에서 안전)
        pair.tmp = 0; pair.tmpPre = 0;
      }

      // 원래 로직: 특정 코드대역에서 짝/홀에 따라 누적/차감후 계산
      if (isCodeNum) {
        const inBlock =
          (acnt_cd >= 195 && acnt_cd <= 200) || (acnt_cd >= 202 && acnt_cd <= 217) ||
          (acnt_cd >= 471 && acnt_cd <= 500) || (acnt_cd >= 401 && acnt_cd <= 430) ||
          (acnt_cd >= 459 && acnt_cd <= 470) || (acnt_cd >= 901 && acnt_cd <= 997) ||
          (acnt_cd >= 801 && acnt_cd <= 900);

        if (inBlock) {
          leftAmt = Number(props.amt_now);
          leftAmt_pre = Number(props.amt_bef);
          rightAmt = 0;
          rightAmt_pre = 0;
          isModAcc = acnt_cd % 2;

          // 유형자산 대역(195~200,215~216,471~500): 홀수=누계, 짝수=자산(=자산+누계→순액)
          if ((acnt_cd >= 195 && acnt_cd <= 200) ) {
            if (isModAcc === 1) { // 홀수 = 총액(자산) → 총액을 저장
              pair.tmp   = leftAmt;
              pair.tmpPre= leftAmt_pre;
            } else {              // 짝수 = 누계(차감) → 순액을 계산해 '오른쪽 칸'에 표기
              rightAmt     = pair.tmp   + leftAmt;
              rightAmt_pre = pair.tmpPre+ leftAmt_pre;
            }
          } else if((acnt_cd >= 215 && acnt_cd <= 216) || (acnt_cd >= 471 && acnt_cd <= 500)) {
            if (isModAcc === 1) {
              pair.tmp = leftAmt;
              pair.tmpPre = leftAmt_pre;
            } else {
              if (!(acnt_cd >= 401 && acnt_cd <= 430) && !(acnt_cd >= 459 && acnt_cd <= 470) &&
                  !(acnt_cd >= 901 && acnt_cd <= 997) && !(acnt_cd >= 801 && acnt_cd <= 900)) {
                rightAmt = leftAmt + pair.tmp;
                rightAmt_pre = leftAmt_pre + pair.tmpPre;
              }
            }        
          } else {
            // 그 외 대역: 짝수=누계(저장), 홀수=자산(=자산+누계→순액)  ← 원본 로직 그대로
            if (isModAcc === 0) {
              pair.tmp = leftAmt;
              pair.tmpPre = leftAmt_pre;
            } else {
              if (!(acnt_cd >= 401 && acnt_cd <= 430) && !(acnt_cd >= 459 && acnt_cd <= 470) &&
                  !(acnt_cd >= 901 && acnt_cd <= 997) && !(acnt_cd >= 801 && acnt_cd <= 900)) {
                rightAmt = leftAmt + pair.tmp;
                rightAmt_pre = leftAmt_pre + pair.tmpPre;
              }
            }
          }
        }
      }

      // 완전 빈 행 방지
      const hasName = acnt_nm_raw.replace(/\s+/g, "").length > 0;
      const hasValue = (leftAmt !== 0 || rightAmt !== 0 || leftAmt_pre !== 0 || rightAmt_pre !== 0);
      if (!hasValue) return;

      // 행/셀
      const tr = doc.createElement("tr");
      tr.id = props.acnt_cd;

      const td1 = doc.createElement("td");
      const td2 = doc.createElement("td");
      const td3 = doc.createElement("td");
      const td4 = doc.createElement("td");
      const td5 = doc.createElement("td");

      // 과목명
      td1.innerHTML = acnt_nm || String(props.acnt_cd || "");

      // 집계행 스타일
      const plainName = String(acnt_nm).replace(/&nbsp;/g,' ').trim();
      if (!isCodeNum) {
        if (/^\(/.test(plainName)) {
          td1.className = "editable-pre-wrapped ps-5 name-cell";
          tr.classList.add('agg-row','agg-row-sub');
        } else {
          td1.className = "editable-pre-wrapped name-cell";
          tr.classList.add('agg-row','agg-row-main');
        }
      } else {
        td1.className = "editable-pre-wrapped ps-7 name-cell";
      }

      // 차감/순액 판별(색)
      // const inAssetBlock = isCodeNum && (
      //   (acnt_cd >= 195 && acnt_cd <= 200) || (acnt_cd >= 215 && acnt_cd <= 216) || (acnt_cd >= 471 && acnt_cd <= 500)
      // );
      // const isContraLine = inAssetBlock && (acnt_cd % 2 === 1);
      // const isNetLine = inAssetBlock && (acnt_cd % 2 === 0) && (rightAmt !== 0 || rightAmt_pre !== 0);
      const in195_200 = isCodeNum && (acnt_cd >= 195 && acnt_cd <= 200);
      const in215_216 = isCodeNum && (acnt_cd >= 215 && acnt_cd <= 216);
      const in471_500 = isCodeNum && (acnt_cd >= 471 && acnt_cd <= 500);
      const inAssetBlocks = in195_200 || in215_216 || in471_500;

      // 차감(누계) 라인: 195~200=짝수, 215~216/471~500=홀수
      const isContraLine =
        (in195_200 && isModAcc === 0) ||
        ((in215_216 || in471_500) && isModAcc === 1);

      // 순액 라인: 195~200=짝수(오른쪽에 순액 나옴), 215~216/471~500=짝수
      const hasNet = (rightAmt !== 0 || rightAmt_pre !== 0);
      const isNetLine =
        (in195_200 && isModAcc === 0 && hasNet) ||
        ((in215_216 || in471_500) && isModAcc === 0 && hasNet);

      // 포맷
      const fmt = (v) => (v === 0 ? "" : (v < 0 ? "(" + numberWithCommas(-v) + ")" : numberWithCommas(v)));

      // ── 현재년(좌) td2 ───────────────────────────────────────────
      td2.style.textAlign = "right";
      if (leftAmt < 0 || (isCodeNum && isContraLine)) td2.style.color = "#dc2626";
      td2.innerText = fmt(leftAmt);

      // ── 현재년(우) td3 ───────────────────────────────────────────
      td3.style.textAlign = "right";
      // 음수는 무조건 빨강, 차감계정인데 순액줄이 아니라면 빨강 유지
      if (rightAmt < 0 || (isCodeNum && isContraLine && !isNetLine)) td3.style.color = "#dc2626";
      td3.innerText = fmt(rightAmt);

      // ── 전기(좌) td4 ────────────────────────────────────────────
      td4.style.textAlign = "right";
      if (leftAmt_pre < 0 || (isCodeNum && isContraLine)) td4.style.color = "#dc2626";
      td4.innerText = fmt(leftAmt_pre);

      // ── 전기(우) td5 ────────────────────────────────────────────
      td5.style.textAlign = "right";
      if (rightAmt_pre < 0 || (isCodeNum && isContraLine && !isNetLine)) td5.style.color = "#dc2626";
      td5.innerText = fmt(rightAmt_pre);

      // (선택) 누계행에서 우측하단을 "좌상단 - 좌하단"으로 보여주고 싶다면 아래 주석 해제
      // if (isContraLine) {
      //   const diff = leftAmt - leftAmt_pre;
      //   td5.style.color = diff < 0 ? "#dc2626" : "";
      //   td5.innerText = diff === 0 ? "" : (diff < 0 ? "(" + numberWithCommas(-diff) + ")" : numberWithCommas(diff));
      // }

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
      const tbody = doc.getElementById(tbodyId);
      if (tbody) tbody.appendChild(tr);
    }
    function renderStatement({ doc, mountId, seq_no, work_yy, ki,flag2 }) {
      const mount = doc.getElementById(mountId);
      if (!mount) { console.error('[renderStatement] mount not found:', mountId); return; }
      if (!doc.getElementById('bs-modern-style')) {
        const css = `
          <style id="bs-modern-style">
            /* 래퍼 & 테이블 기본 */
            .bs-wrap { font-size:12.5px; line-height:1.45; }
            .bs-tablewrap { border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; }
            .bs-wrap .bs-table { width:100%; border-collapse:separate; border-spacing:0; }
            .bs-wrap .bs-table thead th {
              background:#f8fafc; color:#0f172a; font-weight:600;
              border-bottom:1px solid #e5e7eb; padding:8px 10px; font-size:12.5px;
            }
            .bs-wrap .bs-table tbody td { padding:6px 10px; border-bottom:1px solid #f1f5f9; }
            /* ✅ hover 완전 제거 */
            .bs-wrap .no-hover *:hover { background: transparent !important; }
            .bs-wrap .no-hover tbody tr:hover, 
            .bs-wrap .no-hover tbody tr:hover > * { background: transparent !important; }
            /* 숫자/정렬/색상 */
            .text-end { text-align:right; }
            .muted { color:#94a3b8; }
            .neg { color:#dc2626; }

            /* 이름 셀 및 들여쓰기 */
            .editable-pre-wrapped { white-space:pre-wrap; }
            .name-cell { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
            .ps-5 { padding-left:1.25rem !important; }
            .ps-7 { padding-left:1.75rem !important; }

            /* 상단 캡션/헤드 */
            .bs-head { display:flex; align-items:center; gap:10px; padding:6px 8px 4px; }
            .bs-head .unit { margin-left:auto; color:#6b7280; font-size:11.5px; }
            .bs-caption { font-size:11.5px; color:#6b7280; padding:0 8px 8px; }
            .bs-card { position:relative; }
            .dimmer.active{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.6); z-index:9 }

            /* ✅ hover 완전 제거 (부트스트랩/기타 프레임워크까지 덮어씀) */
            .bs-wrap .no-hover tbody tr:hover > * { background: transparent !important; }
            .bs-wrap .no-hover tbody tr:hover { background: transparent !important; }

      
            /* 집계행 배경 */
            tr.agg-row-main td { background:#fafafa !important; }
            tr.agg-row-sub  td { background:#fbfbfb !important; }

            /* 집계행: 첫 칸(과목)만 진하게 */
            tr.agg-row-main td:first-child { color:#0f172a !important; font-weight:700 !important; }
            tr.agg-row-sub  td:first-child { color:#334155 !important; font-weight:700 !important; }

            /* 집계행 숫자 칸(과목 칸 제외)도 진하게 */
            tr.agg-row-main td:not(:first-child),
            tr.agg-row-sub  td:not(:first-child) { font-weight:700 !important; }
            /* 집계행 숫자 칸 톤다운 제거 (muted가 붙어도 색 유지) */
            tr.agg-row-main td.muted,
            tr.agg-row-sub  td.muted { color: inherit !important; }

            /* (선택) 집계행 전체 배경 */
            tr.agg-row-main td { background:#fafafa !important; }
            tr.agg-row-sub  td { background:#fbfbfb !important; }

            /* 1) 과목 열 오른쪽(헤더/바디 모두) */
            .bs-wrap .bs-table thead tr th:first-child,
            .bs-wrap .bs-table tbody tr td:first-child {
              border-right: 1px solid #e5e7eb;
            }

            /* 2) 당기와 전기 사이
              - 헤더 1행: '2025 년'(당기 그룹) th 오른쪽
              - 헤더 2행: 'thisDuration'(당기 기간) th 오른쪽
              - 바디: 3번째 셀(당기 우측 금액) 오른쪽  */
            .bs-wrap .bs-table thead tr:first-child th:nth-child(2),
            .bs-wrap .bs-table thead tr:last-child  th:first-child,
            .bs-wrap .bs-table tbody tr td:nth-child(3) {
              border-right: 1px solid #e5e7eb;
            }        
            /* ========== PRINT (A4) ========== */
            @page { size: A4; margin: 0; }

            @media print {
              /* 고정 푸터는 그대로 출력 */
              .print-footer{
                display: grid !important;
                position: fixed; left:0; right:0; bottom:0;
                background:#fff;
              }

              /* ✅ 보이지 않는 반복 푸터 스페이서 */
              .print-tfoot-space { display: table-footer-group; }
              .print-tfoot-space td { padding:0 !important; border:0 !important; }
              .print-footer-spacer{
                height: calc(var(--footer-h) + var(--footer-safe)); /* 예: 12mm + 2mm */
              }

              /* 행 잘림 최소화 
              .bs-wrap .bs-table tr, .bs-wrap .bs-table td, .bs-wrap .bs-table th{
                page-break-inside: avoid;
              }
              */

              /* 윗여백만 주고 좌/우/아랫여백은 그대로 0 유지 */
              @page { size: A4; margin: 2mm 0 0 0; }
              @page :first { margin-top: 0; }      /* 1페이지는 기존처럼 상단여백 없음 */
              /* 헤더 반복 */
              .bs-wrap .bs-table thead { display: table-header-group; }
              
              /* 헤더 위 라인 이음매 방지 */
              
              .bs-wrap .bs-table thead tr:first-child th { border-top: 1px solid transparent !important; }
              /* 각 페이지의 첫 헤더 행 좌/우 모서리 둥글게 */
              .bs-table thead tr:first-child th:first-child{
                border-top-left-radius: 12px;
                background-clip: padding-box; /* Safari */
              }
              .bs-table thead tr:first-child th:last-child{
                border-top-right-radius: 12px;
                background-clip: padding-box;
              }

              /* 선택: 헤더 배경/보더 정리 */
              .bs-table thead th{
                background: #f8fafc;
                border-bottom: 1px solid #e5e7eb;
                padding: 8px 10px;
              }
              /* 1) 클리핑 유발 소지 제거 */
      .bs-tablewrap{
        overflow: visible !important;       /* ← hidden 해제 */
        border-radius: 0 !important;        /* 라운드는 thead 쪽 radius로만 처리 */
        box-shadow: none !important;
      }
      /* separate가 문제면 collapse로 강제 (ALPDF 안정화용) */
      .bs-wrap .bs-table{
        border-collapse: collapse !important;
        border-spacing: 0 !important;
      }

      /* 2) 숫자 글리프 안정화: 너무 강한 bold 지양, 시스템 폰트 우선 */
      .bs-wrap .bs-table td,
      .bs-wrap .bs-table th{
        font-family: "Malgun Gothic", Arial, sans-serif !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      /* 집계행 숫자 굵기 완화(700→600) */
      tr.agg-row-main td:not(:first-child),
      tr.agg-row-sub  td:not(:first-child){
        font-weight: 600 !important;
      }

      /* 3) 페이지 넘어가며 가려질 수 있는 요소 방지 */
      .print-footer{ z-index: 0 !important; }
      .dimmer, #div_ajax_load_image{ display: none !important; } /* 혹시 남아있으면 숨김 */

      /* 4) 행 보호는 최소화(필요한 헤더만) */
      .bs-wrap .bs-table thead tr, 
      .bs-wrap .bs-table thead th{ page-break-inside: avoid; }
      /* 본문 tr 전체에 avoid 주지 않기 */

              /* 행 잘림 최소화 
              .bs-wrap .bs-table tr, .bs-wrap .bs-table td, .bs-wrap .bs-table th {
                page-break-inside: avoid;
              }
              */
              /* (푸터를 고정으로 쓰는 경우) 본문-푸터 겹침 방지: 시트 하단 패딩 유지 */
              #reportA4.print-sheet {
                padding-bottom: calc(var(--footer-h) + var(--side-pad) + var(--footer-safe)) !important;
              }        
            }
          </style>`;
        (doc.head || doc.documentElement).insertAdjacentHTML('beforeend', css);
      }
      mount.innerHTML = `
        <div class="bs-card bs-wrap">

          <div class="card-body h-100" id="totalBody" style="padding:6px 6px 0px;">
            <div class="bs-tablewrap">   <!-- ✅ 테이블 마감 래퍼 -->
              
              <table class="bs-table table table-sm mb-0">
                <colgroup>
                  <col style="width:32%">
                  <col style="width:17%">
                  <col style="width:17%">
                  <col style="width:17%">
                  <col style="width:17%">
                </colgroup>
                <thead>
                  <tr>
                    <th class="text-center" style="vertical-align: middle;" rowSpan="2">과&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;목</th>
                    <th class="text-center" colSpan="2" id="thisYear"></th>
                    <th class="text-center" colSpan="2" id="lastYear"></th>
                  </tr>
                  <tr>
                    <th class="text-center" colSpan="2" id="thisDuration"></th>
                    <th class="text-center" colSpan="2" id="lastDuration"></th>
                  </tr>
                </thead>
                <tbody id="statmentBody"></tbody>
                <tfoot class="print-tfoot-space">
                  <tr>
                    <td colspan="5">
                      <div class="print-footer-spacer"></div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      `;

      // 로더
      const showDimmer = () => {
        const host = doc.getElementById('totalBody') || mount;
        if (doc.getElementById('div_ajax_load_image')) {
          doc.getElementById('div_ajax_load_image').style.display = 'flex';
          return;
        }
        const div = doc.createElement('div');
        div.id = 'div_ajax_load_image';
        div.className = 'dimmer active';
        div.innerHTML = `<div class="lds-heart"><div></div></div>`;
        (host.parentElement || host).appendChild(div);
      };
      const hideDimmer = () => { const el = doc.getElementById('div_ajax_load_image'); if (el) el.style.display = 'none'; };

      // 레이블 헬퍼
      const safeKi = (k) => {
        const n = Number(k);
        return Number.isFinite(n) ? n : null;
      };
      const kiNow = safeKi(ki);
      const kiPrev = Number.isFinite(kiNow) ? kiNow - 1 : null;
      const yearLabel = (yy, k) => Number.isFinite(k) ? `${yy} 년 (제 ${k} 기)` : `${yy} 년`;

      // AJAX
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        cache: false,
        data: { seq_no, work_yy, flag: 'Statement',flag2:flag2},
        dataType: "json",
        beforeSend: showDimmer,
        success: function(data){
          const thisYearText = yearLabel(work_yy, kiNow);
          const lastYearText = yearLabel(Number(work_yy) - 1, kiPrev);

          (doc.getElementById('bs-thisYearLabel')||{}).textContent = thisYearText;
          (doc.getElementById('bs-lastYearLabel')||{}).textContent = lastYearText;

          (doc.getElementById('thisYear')||{}).textContent = thisYearText;
          (doc.getElementById('lastYear')||{}).textContent = lastYearText;

          const start = data?.rowDuration?.start_dt || '';
          const thisEnd = data?.rowDuration?.thisEndDate || '';
          const lastEnd = data?.rowDuration?.lastEndDate || '';
          const dash = '—';
          const thisDur = (start || thisEnd) ? `${start} ~ ${thisEnd}` : dash;
          const lastDur = (start || lastEnd) ? `${start} ~ ${lastEnd}` : dash;

          (doc.getElementById('thisDuration')||{}).textContent = thisDur;
          (doc.getElementById('lastDuration')||{}).textContent = lastDur;
          (doc.getElementById('bs-periodLabel')||{}).textContent =
            (thisDur !== dash || lastDur !== dash) ? `기간: ${thisDur} / 전기: ${lastDur}` : '';

          // 본문 렌더
          const tbody = doc.getElementById('statmentBody');
          if (tbody) tbody.innerHTML = '';
          const rows = Array.isArray(data?.rows) ? data.rows : [];

          // ★ 누적 상태(행 간 공유)
          const pair = { tmp: 0, tmpPre: 0 };

          for (let i = 0; i < rows.length; i++) {
            StatementDetail(rows[i], { doc, tbodyId: 'statmentBody', pair });
          }
        },
        complete: hideDimmer,
        error: function(xhr, status, err){
          hideDimmer();
          console.error('[renderStatement] error:', status, err);
          const tbody = doc.getElementById('statmentBody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="padding:10px;color:#b23">재무상태표 데이터를 불러오지 못했습니다.</td></tr>`;
        }
      });
    }
    /* ======================= 6-4 부속명세서 start======================= */
    function renderSettlementSubsidiaryA4({doc,mountID, seq_no,  work_yy} = {}) {
      // 0) 이 페이지(섹션)만 꼬리말 제거 플래그 추가
      const a4 = doc.getElementById('reportA4');
      if (a4) a4.classList.add('statement-noftr');  // ← 이 페이지에만 붙는 플래그 클래스  
      if (!doc.getElementById('statementTR-modern-style')) {
        const s = doc.createElement('style');
        s.id = 'statementTR-modern-style';
        s.textContent = `
          :root{
            --card-bg:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
            --head:#f8fafc; --total-bg:#f3f6fa; --total-ink:#243041; --radius:14px;
          }

          /* 카드 & 표 기본 */
          .tr-wrap{ width:100%; display:block; }
          .tr-card{
            background:var(--card-bg);
            border:1px solid var(--line);
            border-radius:var(--radius);
            box-shadow:0 6px 24px rgba(15,23,42,.08);
            margin:12px 0;
            position:relative; z-index:0;
            overflow:visible;            /* 카드 자체는 보이도록 */
          }
          .tr-tablewrap{
            padding:0;
            border-radius:calc(var(--radius) - 2px);
            overflow:hidden;             /* 표 내용(합계 포함) 카드 안으로 클립 */
            background:#fff;
            border-top:1px solid var(--line);
          }
          table.tr-table{ width:100%; border-collapse:separate; border-spacing:0; }

          /* 헤더/셀 */
          .tr-th{
            background:var(--head);
            padding:8px 6px;
            border-bottom:1px solid var(--line);
            font-size:12px;
            position:static !important; z-index:auto !important; /* sticky 비활성 */
          }
          .tr-td{
            background:#fff; font-size:12.5px; line-height:18px; padding:10px 8px;
            border-bottom:1px dashed #edf1f5; color:var(--ink); vertical-align:middle;
            font-variant-numeric:tabular-nums;
          }
          .tr-row:nth-child(even) .tr-td{ background:#fcfdfe; }
          .tr-name{ text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
          .tr-name .n1{ font-weight:700; color:#0b2230; }
          .tr-name .n2{ margin-left:6px; color:#64748b; font-weight:600; font-size:11.5px; }
          .tr-num{ text-align:right; }
          .tr-num.negative{ color:#c0392b; }
          .tr-total .tr-td{
            background:var(--total-bg) !important;
            color:var(--total-ink) !important;
            border-bottom:none; font-weight:700; font-size:12px;
          }
          .w-name{ width:42%; } .w-amt{ width:19.333%; }
          .tr-note{
            margin:6px 12px 14px 12px; color:#475569; font-size:12px;
            background:#f1f5f9; border:1px dashed #dbe4ee; border-radius:10px; padding:8px 10px;
          }

          /* StatementTR 전용: 고정 꼬리말 제거 + 하단 패딩 보정 */
          #reportA4.statement-noftr{
            --footer-h:0mm; --footer-safe:0mm;
            padding-bottom:var(--side-pad) !important;
          }
          .statement-noftr .print-footer,
          #printFooter.hidden-by-statement{ display:none !important; visibility:hidden !important; }

          /* 마지막 카드 여유 */
          .tr-wrap > .tr-card:last-of-type{ margin-bottom:3mm !important; }

          /* 고정 푸터 보더 제거(화면) */
          #printFooter, .print-footer{
            border-top:0 !important; border-top-width:0 !important; border-top-style:none !important;
          }

          /* 인쇄 규칙 */
          @media print{
            /* 카드 외곽선만, 그림자 제거 */
            .tr-card{ box-shadow:none !important; border:1px solid var(--line); }

            /* 푸터 보더/레이어 정리 */
            #printFooter, .print-footer{
              border:0 !important; border-top:0 !important; border-top-width:0 !important; border-top-style:none !important;
              z-index:1 !important;   /* 콘텐츠와 겹침 방지 */
            }
            /* StatementTR 페이지만 추가 보장 */
            #reportA4.statement-noftr ~ .print-footer,
            .statement-noftr .print-footer,
            #printFooter.hidden-by-statement{ border:0 !important; }

            /* 페이지 나뉠 때: 헤더만 반복, tfoot 반복 금지 */
            table.tr-table thead{ display:table-header-group !important; }
            table.tr-table tfoot{ display:table-row-group !important; }
            table.tr-table tfoot tr.tr-total,
            .tr-note{ break-inside:avoid !important; page-break-inside:avoid !important; }

            /* ALPDF/헤드리스 안전 세트 */
            .tr-td, .tr-th{
              color:#111 !important; background:#fff !important;
              -webkit-print-color-adjust:exact; print-color-adjust:exact;
            }
            .tr-total .tr-td{
              background:var(--total-bg, #f3f6fa) !important;
              color:var(--total-ink, #243041) !important;
            }
            /* 일부 엔진의 클리핑 이슈 회피: 표 래퍼는 보수적으로 */
            .tr-tablewrap{ overflow:visible !important; border-radius:0 !important; }
          }
          `;
        (doc.head || doc.body).appendChild(s);
      }

      // 2) mount
      let el = (typeof mountID === 'string') ? doc.getElementById(mountID) : mountID;
      if (!el) return;
      el.innerHTML = `<div class="tr-wrap"><div style="padding:10px 14px;color:#64748b;">데이터를 불러오는 중…</div></div>`;

      // 3) 데이터 로드
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        cache: false,
        data: { seq_no, work_yy, flag: 'statementTR', flag2: mountID },
        dataType: "json"
      }).done(function(res){
        const data = res || {};
        const accounts = data.accounts || data.data?.accounts || [];
        const wrap = doc.createElement('div');
        wrap.className = 'tr-wrap';
        wrap.innerHTML = accounts.map(sectionHTML).join('');
        el.innerHTML = '';
        el.appendChild(wrap);
      }).fail(function(xhr){
        el.innerHTML = `<div class="tr-wrap"><div style="padding:10px 14px;color:#b23">오류: ${xhr?.status || ''} ${xhr?.statusText || '요청 실패'}</div></div>`;
      });

      // ===== helpers =====
      function nf(n){ try{ return (new Intl.NumberFormat()).format(Math.round(n||0)); }catch(e){ return n??0; } }
      function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function formatName(raw){
        if (!raw) return '';
        const m = String(raw).match(/^(.+?)[(（]([^()（）]+)[)）]\s*$/);
        if (m) return `<span class="n1">${esc(m[1])}</span><span class="n2">(${esc(m[2])})</span>`;
        return `<span class="n1">${esc(raw)}</span>`;
      }

      // 섹션 작성 (★ subsec-title 사용)
      function sectionHTML(acc){
        const periodText = acc.period_text ? ` ${esc(acc.period_text)}` : '';
        const title = `
          <div class="subsec-title"><span class="dot"></span> ${esc(acc.acnt_nm || '')}${periodText}</div>
        `; // ← 요청하신 타이틀 그대로 사용

        const cols = Array.isArray(acc.columns)&&acc.columns.length===5
          ? acc.columns
          : ["거래처명","기초잔액","당기증가(+)","당기감소(-)","기말잔액"];

        return `
          
          ${title}
          <div class="tr-card">
            <div class="tr-tablewrap">
              <table class="tr-table">
                <thead>
                  <tr>
                    <th class="tr-th w-name">${esc(cols[0])}</th>
                    <th class="tr-th w-amt">${esc(cols[1])}</th>
                    <th class="tr-th w-amt">${esc(cols[2])}</th>
                    <th class="tr-th w-amt">${esc(cols[3])}</th>
                    <th class="tr-th w-amt">${esc(cols[4])}</th>
                  </tr>
                </thead>
                <tbody>${rowsHTML(acc)}</tbody>
                <tfoot>${totalHTML(acc)}</tfoot>
              </table>
              ${acc.footnote ? `<div class="tr-note">${esc(acc.footnote)}</div>` : ``}
            </div>
          </div>
        `;
      }

      function rowsHTML(acc){
        const rows = acc.rows || [];
        return rows.map(r=>{
          const begin = r.begin ?? r.begin_bal ?? 0;
          const inc   = r.inc   ?? r.dr        ?? 0;
          const dec   = r.dec   ?? r.cr        ?? 0;
          const end   = r.end   ?? r.end_bal   ?? 0;
          const neg = v => (Number(v)<0 ? ' negative' : '');
          return `
            <tr class="tr-row">
              <td class="tr-td tr-name w-name">${formatName(r.trader_name || r.거래처명 || '')}</td>
              <td class="tr-td tr-num w-amt${neg(begin)}">${nf(begin)}</td>
              <td class="tr-td tr-num w-amt${neg(inc)}">${nf(inc)}</td>
              <td class="tr-td tr-num w-amt${neg(dec)}">${nf(dec)}</td>
              <td class="tr-td tr-num w-amt${neg(end)}">${nf(end)}</td>
            </tr>
          `;
        }).join('');
      }
      function totalHTML(acc){
        const t = acc.totals || {};
        return `
          <tr class="tr-total">
            <td class="tr-td tr-name w-name">합 계</td>
            <td class="tr-td tr-num w-amt">${nf(t.begin ?? 0)}</td>
            <td class="tr-td tr-num w-amt">${nf(t.inc ?? t.dr ?? 0)}</td>
            <td class="tr-td tr-num w-amt">${nf(t.dec ?? t.cr ?? 0)}</td>
            <td class="tr-td tr-num w-amt">${nf(t.end ?? 0)}</td>
          </tr>
        `;
      }
    }
    /* ======================= 7 주식가치평가 start======================= */
    function renderEquityValuation({doc, mountID, seq_no, work_yy} = {}) {
      if (!doc || !mountID) return;
      const mount = (typeof mountID === "string") ? doc.getElementById(mountID) : mountID;
      if (!mount) return;

      // ---------- 0) Style (once) ----------
      if (!doc.getElementById('eqv-style-v2')) {
        const css = `
        <style id="eqv-style-v2">
          :root { --eqv-bg:#f7f8fb; --eqv-ink:#0f172a; --eqv-muted:#6b7280; --eqv-accent:#1f7ae0; --eqv-accent-2:#10b981; }
          .eqv { color:var(--eqv-ink); }
          .eqv .section-title { display:flex; align-items:center; gap:10px; font-size:18px; font-weight:800; letter-spacing:-0.2px; margin:14px 0 12px; }
          .eqv .section-title .dot { width:10px; height:10px; border-radius:999px; background:linear-gradient(135deg,var(--eqv-accent),#60a5fa);}
          .eqv .grid { display:grid; grid-template-columns: 0.5fr 0.5fr; gap:14px; }
          .eqv .card { position:relative; background:rgba(255,255,255,0.75); backdrop-filter: blur(8px);
                      border:1px solid rgba(15,23,42,.06); border-radius:16px; padding:14px;
                      box-shadow: 0 8px 20px rgba(15,23,42,.06); }
          .eqv .hint { font-size:11px; color:var(--eqv-muted); margin-top:2px; }
          .eqv .table-wrap { overflow:hidden; border-radius:12px; border:1px solid rgba(15,23,42,.06); }
          .eqv table.kv { width:100%; border-collapse:separate; border-spacing:0; background:#fff; }
          .eqv table.kv thead th { background:linear-gradient(180deg,#f9fafb,#f3f4f6); color:#111827; font-weight:700; font-size:12px; padding:10px 12px; text-align:center; border-bottom:1px solid #e5e7eb; }
          .eqv table.kv th, .eqv table.kv td { font-size:12px; padding:8px 12px; border-bottom:1px solid #f1f5f9; }
          .eqv table.kv tbody tr:nth-child(odd) { background:#fbfdff; }
          /* zebra */
          .eqv table.kv tbody tr:nth-child(odd) { background:#fbfdff; }
          .eqv table.kv th { text-align:left; color:#111827; font-weight:700; white-space:nowrap; }
          .eqv table.kv td.num { text-align:right; font-variant-numeric: tabular-nums; }
          .eqv table.kv td.center { text-align:center; }
          /* highlight row: 1주당 평가액 */
          .eqv .kv .blue-accent { color:#2563eb !important; font-weight:800; }
          .eqv table.kv tbody tr.hl { background:#fff8d8; }               /* 은은한 노랑 */
          .eqv table.kv tbody tr.hl th,
          .eqv table.kv tbody tr.hl td { font-weight:700; }
          .eqv .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; }
          .eqv .chip.ok { background:#ecfdf5; color:#059669; border:1px solid #a7f3d0; }
          .eqv .chip.no { background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; }
          /* mini legend labels inside th */
          .eqv .kv .dim { color:var(--eqv-muted); font-weight:600; }
          /* responsive */
          @media (max-width: 900px){
            .eqv .grid { grid-template-columns: 1fr; }
          }
        </style>`;
        doc.head.insertAdjacentHTML('beforeend', css);
      }

      // ---------- 1) Skeleton ----------
      mount.innerHTML = `
        <section class="eqv">
          <div class="subsec-title"><span class="dot"></span>연도별 주식가치 평가</div>
          <div class="grid">
            <div class="card">
              <div id="eqvLineChart" style="width:100%;height:230px"></div>
            </div>
            
              <div class="table-wrap"><table class="kv" id="eqvTable"></table></div>
              <div class="hint">※ 1주당 평가액 = (1주당 순손익가치 × 3 + 1주당 순자산가치 × 2) / 5 <br>
              ※ 증권거래세 = 1주당 평가액 × 거래주식수 × 0.35%</div>
            
          </div>

          <div class="subsec-title"><span class="dot"></span>예외적 주식가치 평가방법</div>
          
            <div class="table-wrap"><table class="kv" id="eqvRuleTable"></table></div>
            <div class="hint">※ 자기주식은 발행주식총수에서 차감하여 1주당 순자산/순손익가치를 평가합니다.<br>
            ※ 최대주주는 평가일 현재 주식이 가장 많은 사람이며 할증률의 50%P를 추가하여 평가. 다만, 중소기업은 할증 감면 규정 적용.</div>
          
        </section>
      `;

      // ---------- 2) helpers ----------
      const qs = (sel)=>doc.querySelector(sel);
      const nf = (n)=> (n==null||isNaN(n))? "-" : new Intl.NumberFormat().format(n);
      const toMan = (n)=> Math.round((+n||0)/10000);

      // ---------- 3) data ----------
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        cache: false,
        data: { seq_no, work_yy, flag: 'EV' },
        dataType: "json"
      }).done(function(json){
        if (!json?.ok) {
          const el = qs('#eqvTable'); if (el) el.innerHTML = `<tr><td>로드 실패: ${json?.error||'unknown'}</td></tr>`;
          return;
        }
        const { years, flags } = json;
        const Y = years || [];
        const Yasc = Y.slice().reverse();   // 오름차순(왼→오)

        // ---------- 표 ----------
        const hdrYears = Yasc.map(r => `${r.year}년`);
        const rows = [
          ["<span class='dim'>구 분</span>", ...hdrYears],
          ["발행주식총수",   ...Yasc.map(r => `${nf(r.shares)} 주`)],
          ["액면가액",       ...Yasc.map(r => `${nf(r.par)} 원`)],
          ["주당순자산가치", ...Yasc.map(r => `${nf(r.asset_per_share)} 원`)],
          ["주당순손익가치", ...Yasc.map(r => `${nf(r.income_per_share)} 원`)],
          ["<span class='blue-accent'>1주당 평가액</span>", ...Yasc.map(r => `<b>${nf(r.valuation_per_share)}</b> 원`)],
          ["최대주주할증",   ...Yasc.map(r => `${nf(r.major_holder_premium)} 원`)]
        ];
        const tbl = qs('#eqvTable');
        if (tbl) {
          tbl.innerHTML = [
            `<thead><tr>${rows[0].map((c,i)=>`<th class="${i?'num':''}">${c}</th>`).join('')}</tr></thead>`,
            `<tbody>`,
              rows.slice(1).map(r=>{
                const isEvalRow = String(r[0]).includes("1주당 평가액");
                return `<tr class="${isEvalRow ? 'hl' : ''}">` +
                      r.map((c,i)=> i ? `<td class="num">${c}</td>` : `<th>${c}</th>`).join('') +
                      `</tr>`;
              }).join(''),
            `</tbody>`
          ].join('');
        }

        // 예외 표 (칩 라벨)
        const chip = (v)=> v ? `<span class="chip ok">해당</span>` : `<span class="chip no">-</span>`;
        const rtbl = qs('#eqvRuleTable');
        if (rtbl) {
          rtbl.innerHTML = [
            `<thead><tr><th>대상법인</th><th style="text-align:center">평가방법</th><th style="text-align:center">해당여부</th></tr></thead>`,
            `<tbody>`,
              `<tr><td>사업개시 후 3년 미만의 법인</td><td class="center">순자산가액으로 평가</td><td class="center">${chip(flags?.is3YearLow)}</td></tr>`,
              `<tr><td>3년 연속 결손인 법인</td><td class="center">순자산가액으로 평가</td><td class="center">${chip(flags?.is3YearMinus)}</td></tr>`,
              `<tr><td>자산총액 중 부동산가액 80% 이상</td><td class="center">순자산가액으로 평가</td><td class="center">${chip(flags?.overAsset80)}</td></tr>`,
              `<tr><td>자산총액 중 부동산가액 50% 이상</td><td class="center">(순손익×2 + 순자산×3) / 5</td><td class="center">${chip(flags?.overAsset50)}</td></tr>`,
            `</tbody>`
          ].join('');
        }
        // ---------- 5) chart (amCharts v5 - Waterfall with conditional unit & font 12) ----------
        const ctx = doc.defaultView || window;
        const { am5, am5xy, am5themes_Animated } = ctx;
        const el = doc.getElementById("eqvLineChart");
        if (!am5 || !am5xy || !am5themes_Animated || !el) return;

        // 1) 연도별 '평가액'만 사용 (원 단위 유지), 오래된 연도 → 최신 연도
        const chronological = (Y.slice().reverse()).map(r => ({
          year: String(r.year),
          valWon: Math.round(+r.valuation_per_share || 0) // 원 단위
        }));

        // 2) 워터폴 데이터로 변환 (원 단위 누적)
        const data = [];
        let cum = 0;

        // 표시 단위 함수: 1,000,000원(=백만원) 이상이면 만원, 이하면 원
        const formatWon = (v) => {
          if (Math.abs(v) >= 1_000_000) {
            return `${(v / 10_000).toLocaleString()} 만원`;
          }
          return `${Math.round(v).toLocaleString()} 원`;
        };

        am5.ready(function () {
          const root = am5.Root.new(el);
          root.setThemes([am5themes_Animated.new(root)]);
          root.numberFormatter.setAll({ numberFormat: "#,###" });

          const chart = root.container.children.push(
            am5xy.XYChart.new(root, { panX: false, panY: false, paddingLeft: 0 })
          );

          // X축
          const xRenderer = am5xy.AxisRendererX.new(root, {
            minGridDistance: 30,
            minorGridEnabled: true
          });
          xRenderer.grid.template.setAll({ location: 1 });
          // 축 라벨 글자크기 12
          xRenderer.labels.template.setAll({ fontSize: 12 });

          const xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: xRenderer,
            tooltip: am5.Tooltip.new(root, { })
          }));
          xAxis.get("tooltip").label.setAll({ fontSize: 12 });

          // Y축
          const yRenderer = am5xy.AxisRendererY.new(root, { strokeOpacity: 0.1 });
          yRenderer.labels.template.setAll({ fontSize: 12 }); // 축 라벨 글자크기 12

          const yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            maxDeviation: 0,
            min: 0,
            renderer: yRenderer,
            tooltip: am5.Tooltip.new(root, {})
          }));
          yAxis.get("tooltip").label.setAll({ fontSize: 12 });

          // Y축 라벨에 단위(원/만원) 동적 적용
          yRenderer.labels.template.adapters.add("text", (text, target) => {
            const di = target.dataItem;
            if (!di) return text;
            const v = di.get("value");
            if (v == null) return text;
            return formatWon(v);
          });

          // 색상 헬퍼
          const colorUp   = (root) => root.interfaceColors.get("positive");
          const colorDown = (root) => root.interfaceColors.get("negative");
          const colorBase = (root) => root.interfaceColors.get("primaryButton");

          // 워터폴 데이터 빌드 (원 단위)
          if (chronological.length) {
            // 시작 막대: 첫 해 전체 값
            const first = chronological[0];
            cum = first.valWon;
            data.push({
              category: `${first.year}`,
              value: cum,
              open: 0,
              stepValue: cum,
              displayLabel: formatWon(cum),
              columnConfig: { fill: colorBase(root) }
            });

            // 중간: 연도 간 증감(Δ)
            for (let i = 1; i < chronological.length; i++) {
              const cur = chronological[i];
              const prev = chronological[i - 1];
              const delta = cur.valWon - prev.valWon;
              const open = cum;
              cum = open + delta;

              data.push({
                category: `Δ ${prev.year}→${cur.year}`,
                value: cum,
                open,
                stepValue: cum,
                // Δ 표시는 절대값으로 보기 좋게
                displayLabel: formatWon(Math.abs(delta)),
                columnConfig: { fill: delta >= 0 ? colorUp(root) : colorDown(root) }
              });
            }

            // 마지막: 최신 해 전체 값
            const last = chronological[chronological.length - 1];
            data.push({
              category: `${last.year} (현재)`,
              value: last.valWon,
              open: 0,
              stepValue: last.valWon,
              displayLabel: formatWon(last.valWon),
              columnConfig: { fill: colorBase(root) }
            });
          }

          // X축 데이터
          xAxis.data.setAll(data);

          // 컬럼 시리즈 (워터폴 본체)
          const series = chart.series.push(am5xy.ColumnSeries.new(root, {
            xAxis, yAxis,
            valueYField: "value",
            openValueYField: "open",
            categoryXField: "category",
            tooltip: am5.Tooltip.new(root, { labelText: "{valueY.formatNumber('#,###')}" })
          }));
          series.columns.template.setAll({ templateField: "columnConfig", strokeOpacity: 0 });
          // 툴팁 라벨 글자크기 12
          series.get("tooltip").label.setAll({ fontSize: 12 });

          // 막대 라벨 (조건부 단위/글자크기 12)
          series.bullets.push(() =>
            am5.Bullet.new(root, {
              sprite: am5.Label.new(root, {
                text: "{displayLabel}",
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true,
                fontSize: 12
              })
            })
          );

          // 점선 스텝라인(누적 기준선)
          const stepSeries = chart.series.push(am5xy.StepLineSeries.new(root, {
            xAxis, yAxis,
            valueYField: "stepValue",
            categoryXField: "category",
            noRisers: true,
            locationX: 0.65,
            stroke: root.interfaceColors.get("alternativeBackground"),
            tooltip: am5.Tooltip.new(root, { labelText: "{valueY.formatNumber('#,###')}" })
          }));
          stepSeries.strokes.template.setAll({ strokeDasharray: [3, 3] });
          stepSeries.get("tooltip").label.setAll({ fontSize: 12 });

          // 데이터 주입
          series.data.setAll(data);
          stepSeries.data.setAll(data);

          // 애니메이션
          series.appear(1000);
          chart.appear(1000, 100);

          root._logo && root._logo.dispose();
        });
      }).fail(function(xhr){
        const el = qs('#eqvTable'); const msg = (xhr?.responseJSON?.error) || xhr?.statusText || 'network error';
        if (el) el.innerHTML = `<tr><td>로드 실패: ${msg}</td></tr>`;
      });
    }
    /* ======================= 8 기업진단 start======================= */
    function renderDiagnosis({ doc, mountID, seq_no, work_yy, work_qt } = {}) {
      if (!doc || !mountID) return;
      const mount = typeof mountID === "string" ? doc.getElementById(mountID) : mountID;
      if (!mount) return;

      // ─────────────────────────────
      // 스타일 (화면/인쇄 동일한 Grid 60:40)
      // ─────────────────────────────
      if (!doc.getElementById('diag-hero-side-style')) {
        doc.head.insertAdjacentHTML('beforeend', `
        <style id="diag-hero-side-style">
          .diag-scope{font:13.5px/1.5 "Noto Sans KR",system-ui;color:#0f172a}

          /* === 히어로: 좌우 60:40 고정(Grid) === */
          .hero-wrap{display:grid;grid-template-columns:3fr 2fr;gap:16px;align-items:stretch}
          .hero-left,.hero-right{min-width:0}

          .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 22px rgba(15,23,42,.06)}
          .cap-card{border-radius:16px}
          .cap-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:16px;overflow:hidden}
          .cap-table thead th{background:#f8fafc;border-bottom:1px solid #e5e7eb;padding:8px 2px;font-weight:800;text-align:center}
          .cap-table tbody td{border-bottom:1px solid #eef2f7;padding:8px}
          .cap-table tbody tr:last-child td{border-bottom:none}
          .cap-table td.r{text-align:right}.cap-table td.c{text-align:center}
          .chip{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid #e6eaf0;font-size:12px}
          .chip.y{background:#fffbe6;border-color:#fde68a}

          /* 히어로 배지(상태) */
          .hero-badge{
            position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;
            width:100%;height:180px;border-radius:18px;overflow:hidden;
            border:1px solid #e6ece9;box-shadow:0 10px 28px rgba(16,24,40,.08), inset 0 0 0 1px rgba(255,255,255,.25);
            background:
              radial-gradient(120% 120% at 50% 10%, rgba(255,255,255,.14), transparent 42%),
              linear-gradient(135deg,var(--hero1),var(--hero2));
          }
          .hero-badge.ok{ --hero1:#1f9d62; --hero2:#217648; }   /* 적격: green */
          .hero-badge.no{ --hero1:#ef4444; --hero2:#b91c1c; }   /* 부적격: red  */

          .badge-title{color:#fff;font-weight:900;font-size:44px;letter-spacing:-.6px;text-shadow:0 10px 24px rgba(0,0,0,.22)}
          .badge-chips{display:flex;gap:10px;margin-top:12px;flex-wrap:nowrap;justify-content:center}
          .stat-chip{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            min-width:100px;height:46px;padding:6px 6px;border-radius:12px;
            background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.35);
            color:#fff;backdrop-filter:blur(6px);box-shadow:inset 0 0 0 1px rgba(255,255,255,.16)
          }
          .stat-chip .k{font-size:10.5px;font-weight:800;opacity:.95;line-height:1}
          .stat-chip .v{font-size:13.5px;font-weight:900;line-height:1.15;margin-top:3px;white-space:nowrap}

          /* === 세부 내역: 타일/그리드 === */
          .diag-deets .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
          .diag-deets .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
          .tile{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px rgba(15,23,42,.06);overflow:hidden}
          .tile-hd{padding:10px 12px;background:#f8fafc;border-bottom:1px solid #e5e7eb;font-weight:800;display:flex;align-items:center;gap:8px}
          .tile-bd{padding:12px 14px}
          .kv{display:grid;grid-template-columns:1fr auto;row-gap:6px;column-gap:8px}
          .kv .k{color:#64748b} .kv .v{text-align:right;font-weight:700} .num-strong{font-weight:900}

          /* 타이틀 오른쪽 합계 배지 */
          .pill-danger{display:inline-block;padding:4px 10px;border:1px solid #fecaca;border-radius:999px;background:#fee2e2;color:#b91c1c;font-weight:900;line-height:1;margin-left:auto}

          /* 부실자산 리스트 */
          .bad-grid{display:grid;row-gap:8px;margin-top:6px}
          .bad-row{display:grid;grid-template-columns:1fr auto;column-gap:8px;align-items:center;padding:10px 12px;border:1px solid #eef2f7;border-radius:10px;background:#fbfcfe}
          .bad-name{font-weight:600;color:#0f172a;letter-spacing:.02em}
          .bad-amt{font-weight:900}

          /* === 실질자본 수식 카드 === */
          /* === 배지형 실질자본 수식 (2행 안전 배치) === */
          .formula-wrap{
            margin-top:12px; padding:10px;
            border:1px solid #e8e8ef; border-radius:14px; background:#fff;
            box-shadow:0 6px 18px rgba(15,23,42,.06);
          }

          /* 좌측(실질자본) | = | 우측(요인들 그리드) */
          .formula-row{
            display:grid; grid-template-columns: auto 32px 1fr; gap:12px; align-items:start;
          }

          /* =, − 기호 셀 */
          .fop{
            display:flex; align-items:center; justify-content:center;
            font-weight:900; color:#9ca3af; user-select:none;
          }

          /* 배지 스타일 */
          .eq-wrap{
            margin-top:12px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px rgba(15,23,42,.06);
            padding:8px;display:grid;grid-template-columns:auto 24px 1fr;align-items:center;gap:10px
          }
          .eq-badge{
            min-width:100px;border:1px solid #e6eaf3;border-radius:12px;padding:8px 14px;background:linear-gradient(#f8fbff,#ffffff);
            display:flex;flex-direction:column;gap:6px
          }
          .eq-badge.result{border-color:#d7efe1;background:linear-gradient(#f3fcf7,#ffffff)}
          .eq-k{color:#64748b;font-weight:800}
          .eq-v{font-weight:900}
          .eq-v.result{color:#207a53}
          .eq-ops{display:grid;row-gap:10px}
          .eq-row{display:flex;align-items:center;flex-wrap:wrap;gap:10px}
          .eq-op{font-weight:900;opacity:.7;min-width:14px;text-align:center}

          /* 모바일 좁은 화면에서만 1열(인쇄는 항상 2/3열 유지) */
          @media (max-width:720px){
            .hero-wrap{grid-template-columns:1fr}
            .diag-deets .grid-3{grid-template-columns:1fr}
            .diag-deets .grid-2{grid-template-columns:1fr}
            /* === 실질자본 수식 카드 === */

          }

          /* 인쇄: 화면과 동일한 그리드/색 유지 */
          @media print{
            .diag-scope{-webkit-print-color-adjust:exact; print-color-adjust:exact}
            .hero-wrap{grid-template-columns:3fr 2fr !important; gap:16px !important}
            .diag-deets .grid-3{grid-template-columns:1fr 1fr 1fr !important}
            .diag-deets .grid-2{grid-template-columns:1fr 1fr !important}
            .hero-badge,.card,.tile{box-shadow:none !important}
            .hero-badge,.cap-card,.cap-table,.tile,.bad-row,.rc-wrap{break-inside:avoid !important; page-break-inside:avoid !important}
            /* === 실질자본 수식 카드 === */
            .eq-wrap{grid-template-columns:auto 24px 1fr !important}
          }
        </style>`);
      }

      // 유틸
      const N = (v) => {
        const n = Number(String(v ?? '').toString().replace(/,/g,'').trim());
        return Number.isFinite(n) ? n : 0;
      };
      const fmt0 = (v) => new Intl.NumberFormat('ko-KR').format(Math.floor(N(v)));
      const pick = (...cands) => {
        for (const c of cands) {
          const v = (typeof c === 'function') ? c() : c;
          if (v != null && v !== '' && !Number.isNaN(v)) return v;
        }
        return 0;
      };

      const endMap = {1:'03-31',2:'06-30',3:'09-30',4:'12-31'};
      const endDate = endMap[Number(work_qt)] || '12-31';
      const endDateLabel = `${work_yy}년 ${endDate.slice(0,2)}월 ${endDate.slice(3,5)}일`;

      const holderId = 'diag-' + Date.now();
      mount.insertAdjacentHTML('beforeend', `<div id="${holderId}" class="diag-scope"><div style="color:#64748b">진단 데이터를 불러오는 중…</div></div>`);
      const el = doc.getElementById(holderId);

      // 데이터 호출
      $.ajax({
        url: "{% url 'getFinancialData_Report' %}",
        data: { seq_no, flag: "DIAGNOSIS", work_yy, work_qt },
        dataType: "json"
      }).done(function(res){
        if (!res || res.ok === false) {
          el.innerHTML = `<div style="color:#b91c1c">진단 데이터를 불러오지 못했습니다.</div>`;
          return;
        }

        // === 히어로 상단 ===
        const stndCapital = N(res.stndCapital);
        const realCapital = N(res.realCapital);
        const isOk        = realCapital >= stndCapital;
        const capitalRows = Array.isArray(res.capitalRows) ? res.capitalRows : [];

        const badgeHtml = `
          <div class="hero-badge ${isOk ? 'ok' : 'no'}">
            <div class="badge-title">${isOk ? '적격' : '부적격'}</div>
            <div class="badge-chips">
              <div class="stat-chip"><div class="k">진단기준일</div><div class="v">${endDateLabel}</div></div>
              <div class="stat-chip"><div class="k">실질자본</div><div class="v">${fmt0(realCapital)} 원</div></div>
              <div class="stat-chip"><div class="k">기준자본금</div><div class="v">${fmt0(stndCapital)} 원</div></div>
            </div>
          </div>`;

        const rowsHtml = capitalRows.length
          ? capitalRows.map(r=>{
              const nm  = r?.MH_Name || '';
              const amt = fmt0(r?.MH_Amt);
              const dc  = String(r?.MH_DcRate)==='1' ? '일반' : '50%감면';
              return `<tr>
                <td class="c">${nm}</td>
                <td class="r">${amt}</td>
                <td class="c">${dc==='일반' ? '<span class="chip">일반</span>' : '<span class="chip y">50%감면</span>'}</td>
              </tr>`;
            }).join('')
          : `<tr><td colspan="3" class="c" style="color:#94a3b8">등록업종 정보가 없습니다.</td></tr>`;

        const capTableHtml = `
          <div class="card cap-card">
            <table class="cap-table">
              <thead><tr><th>등록업종</th><th style="width:30%">기준자본금</th><th style="width:22%">감면여부</th></tr></thead>
              <tbody>${rowsHtml}</tbody>
            </table>
          </div>`;

        const heroHtml = `
          <div class="subsec-title"><span class="dot"></span>진단결과</div>
          <div class="hero-wrap">
            <div class="hero-left">${badgeHtml}</div>
            <div class="hero-right">${capTableHtml}</div>
          </div>`;

        // === 세부 내역 계산 ===
        const x     = res?.diagExtra || {};
        const lines = Array.isArray(res?.lines) ? res.lines : [];

        // A00/B00
        const A00Item = lines.find(r => String(r.acnt_cd).trim() === 'A00');
        const B00Item = lines.find(r => String(r.acnt_cd).trim() === 'B00');

        let assetTotal = pick(
          () => N(A00Item?.afterDiag),
          () => N(res?.diagTotals?.A00),
          () => N(res?.BSInquiry?.values?.A00),
          () => N(res?.A00)
        );
        let debtTotal = pick(
          () => N(B00Item?.afterDiag),
          () => N(res?.diagTotals?.B00),
          () => N(res?.BSInquiry?.values?.B00),
          () => N(res?.B00)
        );
        if (debtTotal < 0) debtTotal = 0;
        const realCapCalc = assetTotal - debtTotal; // 순자산

        // 현금·전도금(1%)
        const c00       = pick(() => N(x.c00),        () => assetTotal - debtTotal);
        const cashLimit = pick(() => N(x.cashLimit),  () => N(res?.CASH?.totalLimit));
        const cash101   = pick(() => N(x.cash101),    () => N(res?.CASH?.split?.['101']), () => N(res?.CASH?.Split?.Limit_101));
        const adv138    = pick(() => N(x.adv138),     () => N(res?.CASH?.split?.['138']), () => N(res?.CASH?.Split?.Limit_138));
        const over101   = pick(() => N(x.over101),    () => N(res?.CASH?.over?.['101']),  () => N(res?.CASH?.Split?.over_101));
        const over138   = pick(() => N(x.over138),    () => N(res?.CASH?.over?.['138']),  () => N(res?.CASH?.Split?.over_138));
        const cashOver  = pick(() => N(x.cashOver),   () => Math.max(0, over101 + over138));

        // 보통예금(103)
        const depAvg30  = pick(() => N(x.depAvg30), () => N(res?.DEPOSIT?.AVG30), () => N(res?.deposit?.avg30));
        const depLast   = pick(() => N(x.depLast),  () => N(res?.DEPOSIT?.BS),    () => N(res?.deposit?.last));
        const depOver   = pick(() => N(x.depOver),  () => Math.max(0, depLast - depAvg30));

        // 외상매출/대손충당
        const book108    = pick(() => N(x.book108),    () => N(res?.BOND?.target));
        const book109    = pick(() => N(x.book109),    () => N(res?.BOND?.allow));
        const bondBad    = pick(() => N(x.bondBad),    () => N(res?.BOND?.bad));
        const bondTarget = pick(() => N(x.bondTarget), () => N(res?.BOND?.target));
        const bondAllow  = pick(() => N(x.bondAllow),  () => N(res?.BOND?.allow));
        const bondAfter  = pick(() => N(x.bondAfter),  () => N(res?.BOND?.after));
        const bondOver   = pick(() => N(x.bondOver),   () => N(res?.BOND?.over));

        // 부실자산 리스트(백엔드 우선 → 자동분류)
        const BAD_ASSET_CODES = new Set([
          '107','114','116','120','123','124','125','131','133','134','137','139','140','146',
          '150','153','156','159','162','166','167','168','169','170','171','172','179','181','182',
          '218','219','220','221','222','223','224','225','226','227','228','229','230','231',
          '235','236','237','238','239','240','241','242','243','244','245','246','247','248','249','250'
        ]);
        const BAD_NAME_REGEX = /(단기대여금|가지급금|미수금|미수수익|선급금|선납세금|재고|투자|지분법|무형|영업권|개발비|창업비|출자금|회수의문|부실)/;

        const backendList = Array.isArray(x.badAssetsList) ? x.badAssetsList : null;
        const backendSum  = (x.badAssets != null) ? N(x.badAssets) : null;

        const autoBadList = lines
          .filter(r => {
            const cd = String(r.acnt_cd || '').trim();
            const nm = String(r.prt_nm  || '').trim();
            if (cd === 'A00' || cd === 'B00' || cd === '109') return false;
            return BAD_ASSET_CODES.has(cd) || BAD_NAME_REGEX.test(nm);
          })
          .map(r => ({ code:String(r.acnt_cd||'').trim(), name:String(r.prt_nm||'').trim(), amt:N(r.afterDiag) }))
          .filter(it => it.amt !== 0);

        const merged = (() => {
          const m = new Map();
          for (const it of autoBadList) {
            const key = it.code + '|' + it.name;
            m.set(key, (m.get(key) || 0) + it.amt);
          }
          return Array.from(m.entries()).map(([key, amt]) => {
            const [code, name] = key.split('|');
            return { code, name, amt };
          });
        })();

        const badList = backendList
          ? backendList.map(it => ({ code:String(it.code||'').trim(), name:String(it.name||'').trim(), amt:N(it.amt) }))
                      .filter(it => it.amt !== 0)
          : merged;

        const badTotal = (backendSum != null)
          ? Math.floor(backendSum)
          : Math.floor(badList.reduce((a,b) => a + N(b.amt), 0));

        // 타일들 (표시는 모두 절사)
        const totalsCard = `
          <div class="tile">
            <div class="tile-hd">자산/부채 총액</div>
            <div class="tile-bd">
              <div class="kv">
                <div class="k">자산총액</div><div class="v">${fmt0(assetTotal)}</div>
                <div class="k">부채총액</div><div class="v">${fmt0(debtTotal)}</div>
                <div class="k">순 자 산</div><div class="v num-strong">${fmt0(realCapCalc)}</div>
              </div>
            </div>
          </div>`;

        const cashCard = `
          <div class="tile">
            <div class="tile-hd"><span>현금·전도금</span><span class="pill-danger">${fmt0(cashOver)}</span></div>
            <div class="tile-bd">
              <div class="kv">
                <div class="k">순자산</div><div class="v">${fmt0(c00)}</div>
                <div class="k">한도 (1%)</div><div class="v">${fmt0(cashLimit)}</div>
                <div class="k">현금·전도금</div><div class="v">${fmt0(cash101 + adv138)}</div>
                <!--<div class="k">현금 초과</div><div class="v">${fmt0(over101)}</div>-->
                <!--<div class="k">전도금 초과</div><div class="v">${fmt0(over138)}</div>-->
                <div class="k">초과 합계</div><div class="v num-strong">${fmt0(cashOver)}</div>
              </div>
            </div>
          </div>`;

        const depCard = `
          <div class="tile">
            <div class="tile-hd"><span>보통예금</span><span class="pill-danger">${fmt0(depOver)}</span></div>
            <div class="tile-bd">
              <div class="kv">
                <div class="k">30일 평균</div><div class="v">${fmt0(depAvg30)}</div>
                <div class="k">보통예금 잔액</div><div class="v">${fmt0(depLast)}</div>
                <div class="k">평잔 미달</div><div class="v num-strong">${fmt0(depOver)}</div>
              </div>
            </div>
          </div>`;

        const bondCard = `
          <div class="tile">
            <div class="tile-hd"><span>외상매출금 / 대손충당금</span><span class="pill-danger">${fmt0(bondOver)}</span></div>
            <div class="tile-bd">
              <div class="kv">
                <div class="k">장부상 채권</div><div class="v">${fmt0(book108)}</div>
                <div class="k">부실채권 (24개월 경과)</div><div class="v">${fmt0(bondBad)}</div>
                <div class="k">평정대상 (채권 - 부실)</div><div class="v">${fmt0(bondTarget)}</div>
                <div class="k">장부상 충당금</div><div class="v">${fmt0(book109)}</div>
                <div class="k">평정충당금 (1%)</div><div class="v">${fmt0(bondAllow)}</div>
                <div class="k">평정후 (평정대상 - 충당금)</div><div class="v num-strong">${fmt0(bondAfter)}</div>
                <div class="k">평정금액 (장부가액 - 평정후)</div><div class="v num-strong">${fmt0(bondOver)}</div>
              </div>
            </div>
          </div>`;

        const badCard = `
          <div class="tile">
            <div class="tile-hd"><span>부실자산 평정내역</span><span class="pill-danger">${fmt0(badTotal)}</span></div>
            <div class="tile-bd">
              ${
                badList.length
                  ? `<div class="bad-grid">` + badList
                      .sort((a,b)=> b.amt - a.amt)
                      .map(x => `
                        <div class="kv">
                          <div class="k">${(x.name || `계정 ${x.code}`).replace(/ /g,'&nbsp;')}</div>
                          <div class="v">${fmt0(x.amt)}</div>
                        </div>
                      `).join('') + `</div>`
                  : `<div style="color:#94a3b8">표시할 부실자산 항목이 없습니다.</div>`
              }
            </div>
          </div>`;

        // 섹션 합치기
        const detailsHtml = `
          <div class="subsec-title"><span class="dot"></span>진단세부내역</div>
          <div class="diag-deets">
            <div class="grid-3">${totalsCard}${cashCard}${depCard}</div>
            <div class="grid-2" style="margin-top:12px">${bondCard}${badCard}</div>
          </div>`;

        /* ─────────────────────────────
        * 실질자본 계산식 바(하단)
        * 실질자본 = 순자산 - 현금평정 - 보통예금평정 - 외상매출금평정 - 부실자산평정
        * ───────────────────────────── */
        const P = (v)=> fmt0(v);
        const chip = (label, val, isTotal=false)=>`
          <div class="fchip ${isTotal?'total':''}">
            <div class="k">${label}</div>
            <div class="v">${P(val)}</div>
          </div>`;

        // 실질자본 = 순자산 − (필요한 평정들…)
        const parts = [
          { k:'순자산', v: realCapCalc },
          { k:'현금평정', v: cashOver },
          { k:'보통예금평정', v: depOver },
          { k:'외상매출금평정', v: bondOver },
          { k:'부실자산평정', v: badTotal },
        ];
        const top = parts.slice(0,3);
        const bot = parts.slice(3);

        const mkBadge = (label,val,isResult=false)=>`
          <div class="eq-badge ${isResult?'result':''}">
            <div class="eq-k">${label}</div>
            <div class="eq-v ${isResult?'result':''}">${fmt0(val)}</div>
          </div>`;

        const joinRow = (arr) => arr.map((p,i)=> (i?`<span class="eq-op">−</span>`:'') + mkBadge(p.k,p.v)).join('');

        const equationHtml = `
          <div class="eq-wrap">
            ${mkBadge('실질자본', realCapital, true)}
            <div class="eq-op">=</div>
            <div class="eq-ops">
              <div class="eq-row">${joinRow(top)}<span class="eq-op">−</span></div>
              ${bot.length?`<div class="eq-row">${joinRow(bot)}</div>`:''}
            </div>
          </div>`;

        // 최종 출력
        el.innerHTML = heroHtml + detailsHtml + equationHtml;

      }).fail(function(){
        el.innerHTML = `<div style="color:#b91c1c">진단 데이터를 호출하는 중 오류가 발생했습니다.</div>`;
      });
    }
    /* ======================= 300 합치기 start======================= */
    function pdfMerge(seq_no, work_yy, work_qt, filename, { silent=false } = {}) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "{% url 'getFinancialData_Report' %}",
          cache: false,
          data: { seq_no, work_yy, work_qt, filename, flag: 'MERGE' },
          dataType: "json"
        })
        .done((json) => {
          if (json && json.ok) {
            window.__pdfMerged__ = json; // {ok, msg, path, url}
            // if (!silent) alert("PDF 병합 성공!\n" + (json.msg || ""));
            resolve(json);
          } else {
            reject(new Error(json?.msg || "PDF 병합 실패"));
          }
        })
        .fail((xhr, status, err) => {
          const msg = (xhr?.responseJSON?.msg) || err || status || "요청 실패";
          reject(new Error(msg));
        });
      });
    }
    // 완료된 PDF가 있는지 폴링해서 URL 확보
    async function waitForMergeReady({ code='300', seq_no, work_YY, work_QT, timeoutMs=30000, intervalMs=700 }) {
      const filename = SECTION_FILEMAP[code] || code;
      const t0 = Date.now();
      while (Date.now() - t0 < timeoutMs) {
        const url = await fetchSectionPdfUrl(code, filename, seq_no, work_YY, work_QT);
        if (url) return url;
        await new Promise(r => setTimeout(r, intervalMs));
      }
      return null; // 타임아웃이어도 에러는 던지지 않음
    }

    async function refreshSectionPdfButton({ code='300', seq_no, work_YY, work_QT }) {
      const filename = SECTION_FILEMAP[code] || code;
      const btn = document.getElementById(`btn-sec${code}-pdf`);
      if (!btn) return;
      btn.disabled = true; btn.classList.add('disabled'); btn.title = '확인 중…';
      const url = await fetchSectionPdfUrl(code, filename, seq_no, work_YY, work_QT);
      wirePdfButton(btn, url);
    }

    /* ======================= 공통 헬퍼 start======================= */
    // 공통 헬퍼: 데이터 항목에 prev/curr용 템플릿 색상 넣기
    function attachTemplateColors(am5lib, data, hexPalette) {
      return data.map((d, i) => {
        const base = am5lib.color(hexPalette[i % hexPalette.length]);
        d.prevSettings = {
          fill:   am5lib.Color.brighten(base, +0.35),
          stroke: am5lib.Color.brighten(base, +0.20)
        };
        d.currSettings = {
          fill:   am5lib.Color.brighten(base, -0.10),
          stroke: am5lib.Color.brighten(base, -0.25)
        };
        d.colSettings = {
          fill:   base,
          stroke: am5lib.Color.brighten(base, -0.25)
        };
        return d;
      });
    }
    // amCharts 스크립트 보장 로더
    async function whenAm5Ready(frame) {
      const w   = frame?.contentWindow || window;
      const doc = w.document;

      const need = [];
      if (!w.am5)                 need.push("https://cdn.amcharts.com/lib/5/index.js");
      if (!w.am5xy)               need.push("https://cdn.amcharts.com/lib/5/xy.js");
      if (!w.am5percent)          need.push("https://cdn.amcharts.com/lib/5/percent.js"); // ⬅️ 추가
      if (!w.am5themes_Animated)  need.push("https://cdn.amcharts.com/lib/5/themes/Animated.js");

      for (const src of need) {
        await new Promise((resolve, reject) => {
          const s = doc.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          doc.head.appendChild(s);
        });
      }
      return w;
    }
    // 프레임 문서에 스크립트를 순차적으로 붙이는 유틸
    function loadScriptsSequentially(doc, urls, done){
      function next(i){
        if (i >= urls.length) { if (done) done(); return; }
        var s = doc.createElement('script');
        s.src = urls[i];
        s.onload  = function(){ next(i+1); };
        s.onerror = function(e){
          console.error('amCharts load failed:', urls[i], e);
          next(i+1); // 실패해도 다음으로 진행(원하면 중단해도 됨)
        };
        doc.head.appendChild(s);
      }
      next(0);
    }
    //캔버스 스냅샷 
    function serializeForPrint(targetNode) {
      // sheet-inner가 있으면 그 노드 기준으로
      const src = targetNode.querySelector('.sheet-inner') || targetNode;
      const clone = src.cloneNode(true);

      const srcCanvases = src.querySelectorAll('canvas');
      const dstCanvases = clone.querySelectorAll('canvas');

      srcCanvases.forEach((cv, i) => {
        try {
          const dataURL = cv.toDataURL('image/png'); // ← 픽셀 스냅샷
          const rect = cv.getBoundingClientRect();
          const img = document.createElement('img');
          img.src = dataURL;
          // CSS 크기 유지
          img.style.width  = rect.width  ? rect.width  + 'px' : (cv.getAttribute('width')  || '') + 'px';
          img.style.height = rect.height ? rect.height + 'px' : (cv.getAttribute('height') || '') + 'px';
          // 교체
          dstCanvases[i].replaceWith(img);
        } catch (e) {
          // CORS 등으로 스냅샷 실패 시: 그냥 캔버스 유지 (빈 출력일 수 있음)
          // console.warn('canvas snapshot failed', e);
        }
      });

      // (선택) SVG도 이미지로 고정하고 싶다면 여기서 svg -> dataURL 변환 가능
      return clone.innerHTML;
    }

    //############# 안내 카톡내용 생성
    const setMailContent = async (seq_no, work_YY, work_QT, flag) => {
      $.ajax({
        url: "{% url 'getMailContent' %}",
        type: "POST",
        data: {
          seq_no: seq_no,
          work_YY: work_YY,
          work_QT: work_QT,
          flag:flag,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        dataType: "json",
        success: function (data) {
          var bodyContent = data.email_content
          $('[id="' + flag + '"]').html(bodyContent);
        },
        error: function (request, status, error) {
          console.log('fail: ' + error);
        }
      });
    };
    const setPDFIframe = async (ADID, seq_no,ceo_name,biz_name,work_YY,work_QT,flag) => {
      let kskk = "";  
      switch (work_QT) {
        case 1:
        kskk = "1기예정";
          break;
        case 2:
        kskk = "1기확정";
          break;
        case 3:
        kskk = "2기예정";
          break;
        case 4:
        kskk = "2기확정";
          break;
        default:
        kskk = "기수미정";
          break;
      }
    
      srcpath = biz_name
      if (ADID=="화물") {
        srcpath = `화물연대/${ceo_name}`
      }
      let pdfFile = `static/cert_DS/${srcpath}/${work_YY}/부가세/${kskk}/300.pdf`;  
      if (flag=="VatResult") {
        pdfFile = `static/cert_DS/${srcpath}/${work_YY}/부가세/${kskk}/200.pdf`;  
      }
      
      let iframe = document.getElementById(`${flag}PDFIframe`);
      try {
          // HEAD 요청은 파일의 내용을 다운로드하지 않고, 파일의 존재 여부만 확인함.
          let response = await fetch(pdfFile, { method: 'HEAD' });    
          if (response.ok) {
              // 파일이 존재하는 경우 iframe 업데이트
              
              if (iframe) {
                  iframe.src = pdfFile;  // ✅ 파일이 존재하면 iframe에 표시
              } else {
                iframe.innerHTML = "부가가치세 신고도움 안내문(300.pdf)을 저장하지 않았습니다.";
                if (flag=="VatResult") {
                  iframe.innerHTML = "부가가치세 납부서(200.pdf)을 저장하지 않았습니다.";
                }
              }
          } else {
            iframe.innerHTML = "부가가치세 신고도움 안내문(300.pdf)을 저장하지 않았습니다.";
            if (flag=="VatResult") {
              iframe.innerHTML = "부가가치세 납부서(200.pdf)을 저장하지 않았습니다.";
            }        
          }
      } catch (error) {
        iframe.innerHTML = "PDF 파일 확인 중 오류 발생:"+ error;
      }
    };

    // 파일 존재 여부 확인 함수
    const fileExists = async (filePath) => {
      try {
        let response = await fetch(filePath, { method: 'HEAD' });
        return response.ok; // 파일이 존재하면 true, 없으면 false
      } catch (error) {
        console.error("파일 확인 중 오류 발생:", error);
        return false;
      }
    };

})();
</script>
