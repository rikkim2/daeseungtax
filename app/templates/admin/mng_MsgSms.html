{% load static %}

<style>
    /* 1. 전체 컨테이너: 스크롤바의 핵심 */
    .sms-container {
        padding: 15px;
        background-color: #f8f9fa;
        
        /* 부모(탭 콘텐츠 영역) 높이를 꽉 채우되 */
        height: 100%;     
        /* 내용이 더 길면 세로 스크롤바 생성 (중요!) */
        overflow-y: auto; 
    }

    .grid-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
        overflow: hidden; 
        /* 카드 자체는 높이를 내용물에 맞김 */
    }

    .control-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
        margin-bottom: 15px;
    }

    .control-header {
        background-color: #fff;
        border-bottom: 2px solid #f0f0f0;
        padding: 12px 15px;
        font-weight: 600;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .control-body {
        padding: 15px;
    }

    /* 2. ExtJS Grid 래퍼: 최소 높이 보장 */
    .ext-grid-wrapper {
        width: 100%;
        /* 높이를 100%로 하면 부모 스크롤과 충돌할 수 있으므로 
           고정된 최소 높이를 줍니다. 
           이렇게 하면 브라우저가 이 높이보다 작아질 때 스크롤이 생깁니다.
        */
        height: 750px; 
    }
    
    /* 탭 스타일 커스텀 */
    .nav-tabs .nav-link { color: #666; border: none; border-bottom: 2px solid transparent; }
    .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 2px solid #0d6efd; background: transparent; font-weight: 600; }
</style>

<div class="sms-container">
    <div class="row g-3">
        <div class="col-lg-8 col-md-12">
            <div class="grid-card">
                <div class="ext-grid-wrapper"
                     id="grid-target-{{ flag }}"
                     data-role="sms-grid"
                     data-flag="{{ flag }}"></div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12">
            <div class="control-card">
                <div class="control-header">
                    <i class="bi bi-chat-text-fill me-2 text-primary"></i> 문자 내용 작성
                </div>
                <div class="control-body">
                    <textarea id="sms-content-{{ flag }}" class="form-control bg-light" rows="8" placeholder="전송할 내용을 입력하세요..."></textarea>
                    <div class="mt-3">
                        <button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" id="btn-sms-send-{{ flag }}" type="button">
                            <i class="bi bi-send me-1"></i> 전송하기
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="control-header">
                    <span><i class="bi bi-clock me-2 text-warning"></i> 예약 전송 설정</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="chk-rsv-{{ flag }}">
                    </div>
                </div>
                <div class="control-body bg-light bg-opacity-25">
                    <div class="mb-2">
                        <label class="form-label text-muted small">예약날짜</label>
                        <input type="date" class="form-control" id="sms-date-{{ flag }}">
                    </div>
                    <div class="row g-2">
                        <div class="col">
                            <label class="form-label text-muted small">시(Hour)</label>
                            <input type="number" min="8" max="20" class="form-control" id="sms-hour-{{ flag }}" placeholder="09">
                        </div>
                        <div class="col">
                            <label class="form-label text-muted small">분(Min)</label>
                            <input type="number" min="0" max="60" step="10" class="form-control" id="sms-min-{{ flag }}" placeholder="00">
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="card-header border-bottom-0 bg-white pt-3 pb-0 px-3">
                    <ul class="nav nav-tabs" id="smsTplTabs-{{ flag }}" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#smsTpl1-{{ flag }}" type="button">템플릿 1</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#smsTpl2-{{ flag }}" type="button">템플릿 2</button>
                        </li>
                    </ul>
                </div>
                <div class="control-body pt-0">
                    <div class="tab-content border-0 p-3 bg-white">
                        <div class="tab-pane fade show active" id="smsTpl1-{{ flag }}">
                            <div class="d-flex flex-column gap-2">
                                <textarea class="form-control bg-light" rows="5" id="sms-tpl-1-{{ flag }}" readonly>안녕하세요 세무법인대승입니다.&#13;&#10;신고 기간 안내 드립니다.</textarea>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-role="apply-tpl" data-target="sms-tpl-1-{{ flag }}">
                                    <i class="bi bi-arrow-up-circle"></i> 본문 적용
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="smsTpl2-{{ flag }}">
                            <div class="d-flex flex-column gap-2">
                                <textarea class="form-control bg-light" rows="5" id="sms-tpl-2-{{ flag }}" readonly>(안내) 부가세 신고 자료 요청드립니다.</textarea>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-role="apply-tpl" data-target="sms-tpl-2-{{ flag }}">
                                    <i class="bi bi-arrow-up-circle"></i> 본문 적용
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
(function(){
    const flag = "{{ flag }}";
    // 고유한 타겟 ID를 사용하여 정확한 위치를 찾습니다.
    const targetId = `grid-target-${flag}`;

    function initGridOnce(){
        const targetEl = document.getElementById(targetId);
        
        // 1. 타겟이 없거나, 이미 초기화되었다면(ExtJS 클래스가 붙음) 중단
        if (!targetEl || targetEl.dataset.inited === "1") return;

        // 2. 초기화 플래그 설정
        targetEl.dataset.inited = "1";

        Ext.onReady(function(){
            Ext.QuickTips.init();

            // Store 정의
            const store = Ext.create('Ext.data.Store', {
                fields: [
                    'row_num','seq_no','biz_name','ceo_name','hp_no',
                    'sms_send_dt_rsv','sms_send_dt','sms_send_result','sms_contents'
                ],
                proxy: {
                    type: 'ajax',
                    url: "{% url 'sms_data' %}", // Django URL 태그 확인 필요
                    extraParams: { flag: flag },
                    reader: { type: 'json', root: 'rows' }
                },
                autoLoad: true
            });

            const sm = Ext.create('Ext.selection.CheckboxModel', { checkOnly: true });

            // Grid Panel 생성
            Ext.create('Ext.grid.Panel', {
                renderTo: targetEl, // 명확한 ID 지정
                store: store,
                selModel: sm,
                columnLines: true,
                width: '100%',
                height: '100%', // CSS height를 따르도록 설정
                border: false,  // CSS border 사용
                title: '수신자 목록 (' + flag + ')',
                tools: [{
                    type: 'refresh',
                    tooltip: '새로고침',
                    handler: function(){ store.reload(); }
                }],
                columns: [
                    { xtype:'rownumberer', width: 40 },
                    { text:'회사명', dataIndex:'biz_name', flex: 1, minWidth: 120 }, // flex 사용
                    { text:'이름', dataIndex:'ceo_name', width: 80, align: 'center' },
                    { text:'휴대폰', dataIndex:'hp_no', width: 120, align: 'center' },
                    { text:'예약일시', dataIndex:'sms_send_dt_rsv', width: 130, align: 'center' },
                    { text:'발송일시', dataIndex:'sms_send_dt', width: 130, align: 'center' },
                    { text:'결과', dataIndex:'sms_send_result', width: 60, align: 'center' },
                    {
                        text:'상세', width: 70, sortable:false, align: 'center',
                        renderer: function(v, meta, rec){
                             // 버튼 ID 충돌 방지
                            const id = Ext.id();
                            Ext.defer(function(){
                                if(!Ext.get(id)) return; // 존재 체크
                                Ext.widget('button', {
                                    renderTo: id,
                                    text: '보기',
                                    scale: 'small',
                                    handler: function(){
                                        alert("상세 정보: " + rec.get('biz_name'));
                                    }
                                });
                            }, 50);
                            return Ext.String.format('<div id="{0}"></div>', id);
                        }
                    }
                ]
            });

            // 이벤트 바인딩 (ExtJS 로직 외부 DOM)
            bindDomEvents(sm, store);
        });
    }

    function bindDomEvents(sm, store) {
        // 전송 버튼
        const sendBtn = document.getElementById(`btn-sms-send-${flag}`);
        if(sendBtn) {
            sendBtn.addEventListener('click', async function(){
                const msg = (document.getElementById(`sms-content-${flag}`).value || "").trim();
                if (!msg) return alert("문자 내용을 입력하세요.");

                const recs = sm.getSelection();
                if (!recs || recs.length === 0) return alert("받는 사람을 선택하세요.");

                // 예약 체크 확인
                const isRsv = document.getElementById(`chk-rsv-${flag}`)?.checked;
                let toSendDate = "", toSendHours = "", toSendMinute = "";
                
                if(isRsv) {
                    toSendDate = document.getElementById(`sms-date-${flag}`).value;
                    toSendHours = document.getElementById(`sms-hour-${flag}`).value;
                    toSendMinute = document.getElementById(`sms-min-${flag}`).value;
                    if(!toSendDate) return alert("예약 날짜를 입력하세요.");
                }

                // FormData 구성
                const form = new FormData();
                form.append("flag", flag);
                form.append("msg", msg);
                form.append("toSendDate", toSendDate);
                form.append("toSendHours", toSendHours);
                form.append("toSendMinute", toSendMinute);

                recs.forEach(r => {
                    form.append("seq_no[]", r.get("seq_no"));
                    form.append("hp_no[]", (r.get("hp_no") || "").replaceAll("-", ""));
                });

                // AJAX 전송
                try {
                    // 예시 URL, 실제 urls.py 설정 필요
                    const res = await fetch("{% url 'sms_data' %}", {
                        method: "POST",
                        headers: { "X-CSRFToken": "{{ csrf_token }}" },
                        body: form
                    });
                    const json = await res.json();
                    if (json.success) {
                        alert("정상적으로 전송되었습니다.");
                        store.reload();
                        sm.deselectAll();
                    } else {
                        alert("전송 실패: " + (json.message || "오류 발생"));
                    }
                } catch(e) {
                    console.error(e);
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });
        }

        // 템플릿 적용 버튼들
        document.querySelectorAll(`[data-role="apply-tpl"]`).forEach(btn => {
            btn.addEventListener("click", () => {
                const srcId = btn.getAttribute("data-target");
                const src = document.getElementById(srcId);
                const dst = document.getElementById(`sms-content-${flag}`);
                if (src && dst) dst.value = src.value;
            });
        });
    }

    // ★ 핵심 수정: 스크립트가 로드되자마자 실행하되, DOM 렌더링 틱을 맞추기 위해 setTimeout 사용
    // HTML이 AJAX로 삽입된 직후에 이 스크립트가 실행됩니다.
    setTimeout(function() {
        initGridOnce();
    }, 100);

})();
</script>