{% load static %}
<div class="mngmsg-sms-wrap" id="mngMsgSmsMount"></div>
<script>
(function(){
  // ✅ 탭 임베디드 중복 렌더 방지
  if (window.__MNGMSG_SMS_INITED__) return;
  window.__MNGMSG_SMS_INITED__ = true;

  // ✅ 요청 순서 보장용
  window.__adminInfoReqSeq = window.__adminInfoReqSeq || 0;
  window.__MNGMSG_SMS_SELECTED_ADID__ = window.__MNGMSG_SMS_SELECTED_ADID__ || '';
  window.__MNGMSG_SMS_ALL_MODE__ = window.__MNGMSG_SMS_ALL_MODE__ || false;

  // ✅ 렌더 타겟 찾기
  var renderTarget = document.getElementById('mngMsgSmsMount');
  if (!renderTarget) {
    renderTarget = document.querySelector('div.tab-pane.active .mngmsg-sms-wrap');
  }
  if (!renderTarget) return;

  function getGridHeight() { return window.innerHeight - 160; }

  // ─────────────────────────────────────────────
  // 1. Config
  // ─────────────────────────────────────────────
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
  const ALL_ADID_VALUE = (arrADID && arrADID[0]) || '전체';
  const isAllADID = (val) => (val === '전체' || val === ALL_ADID_VALUE);

  var DATA_URL = "{% url 'sms_data' %}";
  var SEND_URL = "{% url 'sms_data' %}";

  // ✅ 운영 기본값
  var GLOBAL_DEFAULTS = {
    담당자: '{{ admin_name|default_if_none:"" }}',
    연락처: '{{ admin_tel_no|default_if_none:"" }}'
  };

  // ─────────────────────────────────────────────
  // 2. 템플릿 정의
  // ─────────────────────────────────────────────
  const CONTACT_PLACEHOLDERS = { 담당자: '{담당자}', 연락처: '{연락처}' };

  function currentContactVarsForPreview() {
    if (window.__MNGMSG_SMS_ALL_MODE__) return { ...CONTACT_PLACEHOLDERS };
    return { 담당자: GLOBAL_DEFAULTS.담당자, 연락처: GLOBAL_DEFAULTS.연락처 };
  }

  var smsTemplates = {
    custom: {
      title: '직접 입력',
      content: ''
    },
    pay: {
      title: '급여자료 요청',
      content: '[세무법인 대승] 안녕하세요. 급여 신고를 위한 자료 제출 부탁드립니다.\n- 제출기한: 매월 7일까지\n- 담당자: {담당자}\n- 연락처: {연락처}'
    },
    vat: {
      title: '부가세 신고',
      content: '[세무법인 대승] 부가세 신고 기간입니다. 세금계산서 및 카드매출 누락분 확인 부탁드립니다.\n- 담당자: {담당자}\n- 연락처: {연락처}'
    },
    younmal: {
      title: '연말정산',
      content: '[세무법인 대승] 연말정산 진행을 위해 간소화자료 제출 부탁드립니다.\n- 제출기한: 1월 15일까지\n- 담당자: {담당자}\n- 연락처: {연락처}'
    },
    notice: {
      title: '일반 안내',
      content: '[세무법인 대승] 안녕하세요. {회사명} 담당 세무사입니다.\n문의사항이 있으시면 연락 주세요.\n- 담당자: {담당자}\n- 연락처: {연락처}'
    }
  };

  // ─────────────────────────────────────────────
  // 3. Data Store (좌측)
  // ─────────────────────────────────────────────
  var store = Ext.create('Ext.data.Store', {
    fields: [
      'groupManager',
      'admin_name',
      'admin_tel_no',
      'seq_no',
      'biz_name',
      'ceo_name',
      'hp_no',
      'sms_send_dt_rsv',
      'sms_send_dt',
      'sms_send_result',
      'sms_contents'
    ],
    proxy: {
      type: 'ajax',
      url: DATA_URL,
      reader: { type: 'json', root: 'rows', totalProperty: 'total' },
      extraParams: { flag: flag, ADID: ADID }
    },
    autoLoad: true
  });

  if (isAllADID(ADID) && store.group) {
    store.group('groupManager');
  }

  var sm = Ext.create('Ext.selection.CheckboxModel', {
    checkOnly: false,
    mode: 'SIMPLE'
  });

  // ─────────────────────────────────────────────
  // 4. 관리자 정보 갱신
  // ─────────────────────────────────────────────
  function refreshPreview(){
    var tpl = smsTemplates[currentTemplateKey] || smsTemplates.custom;
    var previewContent = tpl.content || '';

    var textarea = Ext.getCmp('mngMsgSms_content');
    if (textarea) textarea.setValue(previewContent);

    updateAllModeHintVisibility();
  }

  function updateAllModeHintVisibility() {
    if (typeof formPanel === 'undefined' || !formPanel) return;
    var hint = formPanel.down('#allModeHint');
    if (!hint) return;

    if (typeof hint.setHidden === 'function') {
      hint.setHidden(!window.__MNGMSG_SMS_ALL_MODE__);
      return;
    }
    if (typeof hint.setVisible === 'function') {
      hint.setVisible(window.__MNGMSG_SMS_ALL_MODE__);
      return;
    }
    if (typeof hint.show === 'function' && typeof hint.hide === 'function') {
      window.__MNGMSG_SMS_ALL_MODE__ ? hint.show() : hint.hide();
    }
  }

  function updateAdminInfo(adid) {
    const reqSeq = ++window.__adminInfoReqSeq;
    const selectedAtRequest = adid;

    if (!adid || isAllADID(adid)) {
      window.__MNGMSG_SMS_ALL_MODE__ = true;
      GLOBAL_DEFAULTS.담당자 = CONTACT_PLACEHOLDERS.담당자;
      GLOBAL_DEFAULTS.연락처 = CONTACT_PLACEHOLDERS.연락처;
      refreshPreview();
      return;
    }

    window.__MNGMSG_SMS_ALL_MODE__ = false;

    Ext.Ajax.request({
      url: DATA_URL,
      method: 'GET',
      params: { adminflag: 'get_admin_info', admin_id: adid },
      success: function(response) {
        if (reqSeq !== window.__adminInfoReqSeq) return;
        if (window.__MNGMSG_SMS_SELECTED_ADID__ !== selectedAtRequest) return;

        var res = Ext.decode(response.responseText);
        GLOBAL_DEFAULTS.담당자 = (res && res.admin_name) ? res.admin_name : "";
        GLOBAL_DEFAULTS.연락처 = (res && res.admin_tel_no) ? res.admin_tel_no : "";

        refreshPreview();
      },
      failure: function() {
        if (reqSeq !== window.__adminInfoReqSeq) return;
        if (window.__MNGMSG_SMS_SELECTED_ADID__ !== selectedAtRequest) return;

        GLOBAL_DEFAULTS.담당자 = "";
        GLOBAL_DEFAULTS.연락처 = "";
        refreshPreview();
      }
    });
  }

  function onItemClickHandler(item) {
    ADID = item;
    window.__MNGMSG_SMS_SELECTED_ADID__ = ADID;

    if (typeof updateScrollMenuText === 'function') updateScrollMenuText(item);

    if (store && store.getProxy()) {
      store.getProxy().setExtraParam('ADID', ADID);

      if (isAllADID(ADID) && store.group) {
        store.group('groupManager');
      } else if (store.clearGrouping) {
        store.clearGrouping();
      }

      store.load({
        callback: function() {
          updateAdminInfo(item);
        }
      });
    } else {
      updateAdminInfo(item);
    }
  }

  const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);

  // ─────────────────────────────────────────────
  // 5. 템플릿 적용 / 메뉴
  // ─────────────────────────────────────────────
  var currentTemplateKey = 'custom';

  function applyTemplateToForm(key) {
    currentTemplateKey = key;
    var tpl = smsTemplates[key];
    if (!tpl) return;

    var previewContent = tpl.content || '';
    Ext.getCmp('mngMsgSms_content')?.setValue(previewContent);

    if (typeof formPanel !== 'undefined' && formPanel) {
      var btn = formPanel.down('#tb_template');
      if (btn) btn.setText(tpl.title || key);

      updateAllModeHintVisibility();
    }

    if (store && store.getProxy()) {
      store.getProxy().setExtraParam('smsFlag', currentTemplateKey);
      store.load();
    }
  }

  var templateMenu = Ext.create('Ext.menu.Menu', {
    height: 300,
    scrollable: { x: false, y: true },
    items: Object.keys(smsTemplates).map(function(k) {
      return {
        text: smsTemplates[k].title || k,
        handler: function(){
          applyTemplateToForm(k);
        }
      };
    })
  });

  // ─────────────────────────────────────────────
  // 6. 좌측 그리드 (60%)
  // ─────────────────────────────────────────────
  function sendSmsAction(){ /* 아래에서 정의 */ }

  var mainGrid = Ext.create('Ext.grid.Panel', {
    region: 'west',
    width: '60%',
    split: true,
    collapsible: false,
    title: '발송 대상자 목록',
    store: store,
    selModel: sm,
    columnLines: true,
    features: [{
      id: 'groupManager',
      ftype: 'groupingsummary',
      startCollapsed: false,
      groupHeaderTpl: '{name}',
      hideGroupedHeader: false,
      enableGroupingMenu: true
    }],
    columns: [
      { xtype: 'rownumberer', width: 40 },
      { dataIndex: 'groupManager', header: '<center>관리자</center>', width: 0 },
      { text: '회사명', dataIndex: 'biz_name', width: 140, style: 'text-align:center' },
      { text: '이름', dataIndex: 'ceo_name', width: 80, align: 'center' },
      { text: '휴대폰', dataIndex: 'hp_no', width: 120, align: 'center' },
      {
        text: '상태',
        dataIndex: 'sms_send_result',
        width: 60,
        align: 'center',
        renderer: function(v) {
          if(v === '성공') return '<span style="color:green; font-weight:bold;">✓</span>';
          if(v === '실패') return '<span style="color:red;">✗</span>';
          return '-';
        }
      },
      { text: '예약일시', dataIndex: 'sms_send_dt_rsv', width: 130, align: 'center' },
      { text: '발송일시', dataIndex: 'sms_send_dt', width: 130, align: 'center' }
    ],
    dockedItems: [{
      dock: 'top',
      xtype: 'toolbar',
      style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
      items: dockedItemsConfig.concat([
        '->',
        { text: '문자보내기', iconCls: 'fa fa-paper-plane', handler: function(){ sendSmsAction(); } }
      ])
    }]
  });

  // ─────────────────────────────────────────────
  // 7. 우측 폼 패널 (40%)
  // ─────────────────────────────────────────────
  var formPanel = Ext.create('Ext.form.Panel', {
    region: 'center',
    title: '문자 작성 및 전송',
    bodyPadding: '15px',
    layout: { type: 'vbox', align: 'stretch' },
    autoScroll: true,
    items: [
      {
        xtype: 'textarea',
        fieldLabel: '문자 내용',
        labelAlign: 'top',
        id: 'mngMsgSms_content',
        allowBlank: false,
        emptyText: '전송할 내용을 입력하세요',
        height: 200,
        margin: '0 0 15 0',
        enableKeyEvents: true,
        listeners: {
          keyup: function(field) {
            var len = (field.getValue() || '').length;
            var label = Ext.getCmp('smsLengthLabel');
            if (label) {
              var smsType = len > 90 ? 'LMS' : 'SMS';
              label.setValue('<span style="color:#666;">문자길이: <b>' + len + '자</b> (' + smsType + ')</span>');
            }
          }
        }
      },
      {
        xtype: 'displayfield',
        id: 'smsLengthLabel',
        value: '<span style="color:#666;">문자길이: <b>0자</b> (SMS)</span>',
        margin: '0 0 15 0'
      },
      {
        xtype: 'fieldset',
        title: '예약 전송 설정',
        collapsible: true,
        collapsed: true,
        margin: '0 0 15 0',
        items: [
          {
            xtype: 'checkbox',
            boxLabel: '예약 전송 사용',
            id: 'chk_rsv_sms',
            margin: '0 0 10 0',
            listeners: {
              change: function(cb, checked) {
                var dateField = Ext.getCmp('sms_rsv_date');
                var hourField = Ext.getCmp('sms_rsv_hour');
                var minField = Ext.getCmp('sms_rsv_min');

                if (dateField) dateField.setDisabled(!checked);
                if (hourField) hourField.setDisabled(!checked);
                if (minField) minField.setDisabled(!checked);
              }
            }
          },
          {
            xtype: 'datefield',
            fieldLabel: '예약날짜',
            id: 'sms_rsv_date',
            format: 'Y-m-d',
            disabled: true,
            margin: '0 0 10 0'
          },
          {
            xtype: 'fieldcontainer',
            fieldLabel: '예약시간',
            layout: 'hbox',
            items: [
              {
                xtype: 'numberfield',
                id: 'sms_rsv_hour',
                emptyText: '시(Hour)',
                minValue: 8,
                maxValue: 20,
                width: 100,
                disabled: true,
                margin: '0 5 0 0'
              },
              {
                xtype: 'displayfield',
                value: ':',
                width: 20,
                margin: '0 5 0 0'
              },
              {
                xtype: 'numberfield',
                id: 'sms_rsv_min',
                emptyText: '분(Min)',
                minValue: 0,
                maxValue: 59,
                width: 100,
                disabled: true
              }
            ]
          }
        ]
      },
      {
        xtype: 'fieldset',
        title: '템플릿',
        collapsible: true,
        collapsed: false,
        items: [
          {
            xtype: 'container',
            html: '<div style="color:#666; margin-bottom:10px;">자주 사용하는 템플릿을 선택하여 빠르게 작성하세요.</div>'
          },
          {
            xtype: 'dataview',
            store: Ext.create('Ext.data.Store', {
              fields: ['key', 'title', 'content'],
              data: Object.keys(smsTemplates).map(function(k) {
                return {
                  key: k,
                  title: smsTemplates[k].title,
                  content: smsTemplates[k].content
                };
              })
            }),
            tpl: new Ext.XTemplate(
              '<tpl for=".">',
              '  <div class="sms-template-item" style="padding:10px; margin:5px 0; border:1px solid #e0e0e0; border-radius:6px; cursor:pointer; background:#fafbfc;">',
              '    <div style="font-weight:600; color:#333; margin-bottom:5px;">{title}</div>',
              '    <div style="font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{content:ellipsis(50)}</div>',
              '  </div>',
              '</tpl>'
            ),
            itemSelector: 'div.sms-template-item',
            listeners: {
              itemclick: function(view, record) {
                applyTemplateToForm(record.get('key'));
              }
            }
          }
        ]
      }
    ],
    dockedItems: [{
      dock: 'top',
      xtype: 'toolbar',
      style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
      items: [
        {
          text: '템플릿 선택',
          itemId: 'tb_template',
          iconCls: 'fa fa-bars',
          menu: templateMenu,
          scale: 'medium',
          margin: '0 8 0 0'
        },
        {
          xtype: 'displayfield',
          itemId: 'allModeHint',
          hidden: true,
          value: '<span style="color:#64748b;">※ 전체 선택 시 발송 시점에 <b>업체별 담당자/연락처</b>가 자동 반영됩니다.</span>'
        }
      ]
    }]
  });

  // ─────────────────────────────────────────────
  // 8. placeholder 치환
  // ─────────────────────────────────────────────
  function replaceAllPlaceholders(text, map) {
    let out = String(text || '');
    Object.keys(map || {}).forEach((k) => {
      const v = map[k] == null ? '' : String(map[k]);
      const re = new RegExp('\\{' + k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}', 'g');
      out = out.replace(re, v);
    });
    return out;
  }

  // ─────────────────────────────────────────────
  // 9. 발송 로직
  // ─────────────────────────────────────────────
  var adminInfoCache = {};

  function getAdminInfoForManager(admin_id) {
    return new Promise(function(resolve) {
      if (!admin_id) return resolve({ 담당자: '', 연락처: '' });

      if (adminInfoCache[admin_id]) {
        resolve(adminInfoCache[admin_id]);
        return;
      }

      Ext.Ajax.request({
        url: DATA_URL,
        method: 'GET',
        params: { adminflag: 'get_admin_info', admin_id: admin_id },
        success: function(response) {
          var res = Ext.decode(response.responseText);
          var info = {
            담당자: (res && res.admin_name) ? res.admin_name : "",
            연락처: (res && res.admin_tel_no) ? res.admin_tel_no : ""
          };
          adminInfoCache[admin_id] = info;
          resolve(info);
        },
        failure: function() {
          var info = { 담당자: "", 연락처: "" };
          adminInfoCache[admin_id] = info;
          resolve(info);
        }
      });
    });
  }

  function getVarsForSend(rec) {
    const recAdminName = rec.get('admin_name') || '';
    const recAdminTel = rec.get('admin_tel_no') || '';
    const base = {
      ...GLOBAL_DEFAULTS,
      회사명: rec.get('biz_name') || '',
      이름: rec.get('ceo_name') || ''
    };
    const mergedWithRecContact = {
      ...base,
      담당자: recAdminName || base.담당자,
      연락처: recAdminTel || base.연락처,
    };

    if (isAllADID(ADID)) {
      if (recAdminName || recAdminTel) {
        return Promise.resolve(mergedWithRecContact);
      }

      var managerAdminId = rec.get('groupManager') || '';
      return getAdminInfoForManager(managerAdminId).then(function(info) {
        const contactName = info.담당자 || mergedWithRecContact.담당자;
        const contactTel = info.연락처 || mergedWithRecContact.연락처;
        return {
          ...mergedWithRecContact,
          담당자: contactName,
          연락처: contactTel
        };
      });
    }

    return Promise.resolve(mergedWithRecContact);
  }

  sendSmsAction = function() {
    var records = sm.getSelection();
    if (!records.length) {
      Ext.Msg.alert('알림', '좌측 리스트에서 발송 대상을 선택해주세요.');
      return;
    }

    var msg = Ext.getCmp('mngMsgSms_content').getValue();
    if (!msg) {
      Ext.Msg.alert('알림', '문자 내용을 입력해주세요.');
      return;
    }

    var isRsv = Ext.getCmp('chk_rsv_sms').getValue();
    var toSendDate = '', toSendHours = '', toSendMinute = '';

    if (isRsv) {
      var dateField = Ext.getCmp('sms_rsv_date');
      var hourField = Ext.getCmp('sms_rsv_hour');
      var minField = Ext.getCmp('sms_rsv_min');

      if (dateField && dateField.getValue()) {
        toSendDate = Ext.Date.format(dateField.getValue(), 'Y-m-d');
      }
      toSendHours = hourField ? hourField.getValue() : '';
      toSendMinute = minField ? minField.getValue() : '';

      if (!toSendDate) {
        Ext.Msg.alert('알림', '예약 날짜를 입력해주세요.');
        return;
      }
    }

    Ext.MessageBox.confirm(
      '발송 확인',
      '총 <b>' + records.length + '명</b>에게 문자를 발송하시겠습니까?',
      function(btn){ if(btn === 'yes') doSend(records, msg, toSendDate, toSendHours, toSendMinute); }
    );
  };

  function doSend(records, msgContent, toSendDate, toSendHours, toSendMinute) {
    Ext.getBody().mask('문자 발송중... (0/' + records.length + ')');

    var total = records.length;
    var completed = 0;

    var promises = records.map(function(rec) {
      if (!rec.get('hp_no')) {
        completed++;
        Ext.getBody().mask('문자 발송중... (' + completed + '/' + total + ')');
        return Promise.resolve({
          rec: rec,
          success: false,
          error: '휴대폰 번호 없음'
        });
      }

      return getVarsForSend(rec).then(function(vars) {
        var finalMsg = replaceAllPlaceholders(msgContent, vars);
        var cleanHpNo = (rec.get('hp_no') || '').replace(/-/g, '');

        var formData = new FormData();
        formData.append('flag', flag);
        formData.append('msg', finalMsg);
        formData.append('seq_no[]', rec.get('seq_no'));
        formData.append('hp_no[]', cleanHpNo);
        formData.append('toSendDate', toSendDate || '');
        formData.append('toSendHours', toSendHours || '');
        formData.append('toSendMinute', toSendMinute || '');

        return fetch(SEND_URL, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.cookie.match(/csrftoken=([^;]+)/)?.[1]
          },
          body: formData
        })
        .then(function(r) {
          return r.json()
            .catch(function() { return { success: false, message: '응답 파싱 실패' }; })
            .then(function(json) { return { status: r.status, success: json.success, message: json.message }; });
        })
        .then(function(result) {
          completed++;
          Ext.getBody().mask('문자 발송중... (' + completed + '/' + total + ')');
          var ok = result.success === true && result.status >= 200 && result.status < 300;
          return { rec: rec, success: ok, error: result.message };
        })
        .catch(function(err) {
          completed++;
          Ext.getBody().mask('문자 발송중... (' + completed + '/' + total + ')');
          return { rec: rec, success: false, error: (err && err.message) ? err.message : String(err) };
        });
      });
    });

    Promise.all(promises).then(function(results) {
      var successCnt = 0;
      var failItems = [];

      results.forEach(function(res) {
        if (res.success) {
          successCnt++;
          res.rec.set('sms_send_result', '성공');
          res.rec.set('sms_send_dt', Ext.Date.format(new Date(), 'Y-m-d H:i'));
        } else {
          failItems.push(res);
          res.rec.set('sms_send_result', '실패');
          res.rec.set('sms_send_dt', '');
        }
        res.rec.commit();
      });

      Ext.getBody().unmask();
      if (failItems.length) {
        var firstErr = failItems[0].error || '알 수 없는 오류';
        Ext.Msg.alert('실패', '성공 ' + successCnt + '건, 실패 ' + failItems.length + '건\n첫 실패 사유: ' + firstErr);
      } else {
        Ext.Msg.alert('알림', '모든 문자를 성공적으로 전송했습니다.');
      }

      // 폼 초기화
      if (Ext.getCmp('chk_rsv_sms')) Ext.getCmp('chk_rsv_sms').setValue(false);

      store.load();
    }).catch(function(err) {
      Ext.getBody().unmask();
      Ext.Msg.alert('알림', '문자 발송 실패: ' + ((err && err.message) ? err.message : String(err)));
    });
  }

  // ─────────────────────────────────────────────
  // 10. Main Layout
  // ─────────────────────────────────────────────
  var mainPanel = Ext.create('Ext.panel.Panel', {
    renderTo: renderTarget,
    layout: 'border',
    width: '100%',
    height: getGridHeight(),
    items: [mainGrid, formPanel]
  });

  Ext.EventManager.onWindowResize(function() {
    if (mainPanel && !mainPanel.isDestroyed) mainPanel.setHeight(getGridHeight());
  });

  // ✅ 초기 상태
  window.__MNGMSG_SMS_ALL_MODE__ = isAllADID(ADID);
  applyTemplateToForm('custom');
  updateAdminInfo(ADID);

})();
</script>
