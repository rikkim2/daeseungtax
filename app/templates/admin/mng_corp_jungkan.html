{% extends 'components/admin-base.html' %}
{% load static %}
{% block styles %}
<style>
.icon-refresh {
    color: white; /* ê¸€ì ìƒ‰ìƒì„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
}
.modal-xxl {
  min-width: 1200px;
  max-width: 1400px; /* max-width: 85%;í™”ë©´ì˜ 95%ê¹Œì§€ í™•ì¥ */
}    
</style>  
{% endblock %}

{% block content %}

<div id="ext-grid-container"></div>
            

<div class="modal fade" id="summitModal">
  <div class="modal-dialog modal-xxl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div id="summitModalTitle"></div>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <!-- Tabs í‘œì‹œ-->
        <div class="tabs-menu4" id="tabsMenu">
        </div>
        <div class="tab-content" id="tabContent">        
        </div>
      </div>
    </div>
  </div>
</div>	
{% endblock %}
{% block scripts %}
   
<script>
document.title = "ë²•ì¸ì„¸ : ì¤‘ê°„ì˜ˆë‚©";
var adminBizLevel = '{{ admin_biz_level }}';
const isSuperuser = '{{ admin_grade }}' === 'SA';
var ADID = '{{ ADID }}';        
var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
var flag = '{{ flag }}';
var work_YY = '{{ request.session.workyearCorp }}';
var work_MM = new Date().getMonth() + 1;
if(!work_YY){//ExtCommon.jsì—ì„œ ê°€ì ¸ì˜¨ë‹¤
  work_YY = getWorkYearAndMonth('mng_corp').work_YY;
}
const currentYear = getWorkYearAndMonth('mng_corp').work_YY;
var corpYear,selectedPeriod,selectedSheetID,selectedSheetName="";

var store = Ext.create('Ext.data.Store', {
    storeId: 'corpStore', // ê³ ìœ  Store ID (ì˜µì…˜)
    autoLoad: true, // Storeê°€ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¡œë“œ
    proxy: {
        type: 'ajax', // Ajaxë¥¼ í†µí•´ ì„œë²„ì™€ í†µì‹ 
        url: '{% url "mng_corp_jungkan" %}', // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
        extraParams: {
            ADID:ADID,
            work_YY:work_YY
        },        
        reader: {
            type: 'json', // ì„œë²„ì—ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
            rootProperty: 'data', // ì‘ë‹µ JSONì—ì„œ ë°ì´í„° ë°°ì—´ì˜ ì†ì„± ì´ë¦„
            totalProperty: 'total', // ì‘ë‹µ JSONì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì†ì„± ì´ë¦„
        },
    },   
    fields: [ // í•„ë“œ ì •ì˜ (ë°ì´í„°ì˜ ê° ì—´)
      {name: 'groupManager',type: 'string'},
      {name: 'seq_no'},
      {name: 'biz_name', type: 'string'},
      {name: 'revenue',type: 'number'},
      {name: 'expense',type: 'number'},
      {name: 'income',type: 'number'},
      {name: 'suggestWay',type: 'string'},
      {name: 'preTax',type: 'number'},
      {name: 'submitWay', type: 'string'},
      {name: 'midTax', type: 'number'},
      {name: 'inspectIssue', type: 'string'},
      {name: 'mail_Guide',type: 'string'},
      {name: 'mail_Issue', type: 'string'},
      {name: 'isIssue', type: 'string'},
      {name: 'revenue_pre',type: 'number'},
      {name: 'income_pre',type: 'number'},
      {name: 'preYearCorpTax',type: 'number'}
    ],
    ... (ADID === "ì „ì²´" ? { groupField: 'groupManager' } : {}) // âœ… ADIDê°€ "ì „ì²´"ì¼ ë•Œë§Œ groupField ì¶”ê°€
});
var comboDataStore = Ext.create('Ext.data.Store', {
    fields: ['id', 'name'],
    data: [] // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì›Œë‘ 
});
var checkboxRender =function(value) { 
	return "<input type='checkbox'" + (value ? "checked='checked'" : "") + ">"; 
};
function formatDate(value){
  return value ? Ext.Date.dateFormat(value, 'y-m-d') : '';
}
Ext.tip.QuickTipManager.init();
Ext.onReady(function() {
    //ìƒë‹¨ ë‹´ë‹¹ì ì„ íƒ ë„ì»¤ ì‹œì‘*******************
    // onItemClick í•¸ë“¤ëŸ¬
    function onItemClickHandler(item) {
        ADID = item;
        const data = {
            flag: flag ,
            ADID: item,
            work_YY : work_YY,
            work_MM : work_MM
        };
        // ë¡œë”© ë§ˆìŠ¤í¬ ìƒì„± (ëŒ€ìƒ: ê·¸ë¦¬ë“œë‚˜ íŒ¨ë„)
        var targetComponent = Ext.getCmp('mainGrid') || Ext.getBody(); // ëŒ€ìƒ ì„¤ì • (ê·¸ë¦¬ë“œ IDë‚˜ body)
        var loadMask = new Ext.LoadMask({
            msg: 'ë‹´ë‹¹ìë¥¼ ë³€ê²½ì¤‘ì…ë‹ˆë‹¤...', 
            target: targetComponent
        });
        Ext.Ajax.request({
            url: '{% url "mng_corp_jungkan" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
            method: 'GET',
            params: data, // ë°ì´í„°ë¥¼ GET íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
            success: function (response) {
                try {
                    const jsonResponse = Ext.decode(response.responseText); // JSON íŒŒì‹±
                    store.loadData(jsonResponse); // ë°ì´í„° ë¡œë“œ
                    if (item=="ì „ì²´"){
                        location.reload();
                    }                    
                } catch (e) {
                    console.error('Failed to parse response:', e, response.responseText);
                } finally{
                  loadMask.hide()
                }
            },
            failure: function (response) {
                console.error('Request failed:', response);
                loadMask.hide()
            }
        });
        // ì„ íƒëœ ë©”ë‰´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        updateScrollMenuText(item);        
    }

    if (isSuperuser){
        Ext.Ajax.request({
            url: '{% url "kijang_admin_combolist" %}', // ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
            method: 'GET',
            success: function (response) {
                const data = Ext.decode(response.responseText); // ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±
                comboDataStore.loadData(data); // storeì— ë°ì´í„° ë¡œë“œ
            },
            failure: function () {
                Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
    
    // Docked Items Config ìƒì„±
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);
    //ìƒë‹¨ ë‹´ë‹¹ì ì„ íƒ ë„ì»¤ ë*******************

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
          edit: function (editor, e) {
              var record = e.record;
              var field = e.field; 
              var value = e.value; 

              // âœ… ë¹„ê³  ê°’ì´ ë¹ˆ ë¬¸ìì—´("")ì´ë©´ ê·¸ëŒ€ë¡œ ì „ì†¡
              if (field === "YN_9" && value === null) {
                  value = "";
              }
              
              var seq_no = record.get('seq_no');
              var target = field ;
              Ext.Ajax.request({
                  url: "{% url 'mng_corp_update' %}",
                  method: "POST",
                  params: {
                      seq_no: seq_no,
                      target: target,
                      work_YY: work_YY,
                      val: value,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                  },
                  success: function (response) {
                    // Swal.fire({
                    //   title: 'ì‘ì—… ì„±ê³µ',
                    //   text: 'ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                    //   icon: 'success',
                    //   timer: 500,  // Set the timer to 3 seconds (3000 ms)
                    //   showConfirmButton: false,  // Hide the confirm button
                    //   willClose: () => {
                    //     // Optional: Perform any other action after the alert closes
                    //   }
                    // });
                  },
                  failure: function (response) {
                    Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : " + response.message, "error");
                  }
              });
          }
      }
    });
    var mainGrid = Ext.create('Ext.grid.Panel', {
      id: 'mainGrid',
      renderTo: 'ext-grid-container',
      title: '{{ gridTitle }}',
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      tools: [  //ìµœìƒë‹¨ ì˜¤ë¥¸ìª½ íˆ´ë°”
          {
            xtype: 'button',
            text: 'ì ‘ìˆ˜ë²ˆí˜¸ì €ì¥',
            iconCls: 'fa fa-floppy-o',
            handler: function (btn) {
              Ext.create('Ext.window.Window', {
                title: 'ë°ì´í„° ë¶™ì—¬ë„£ê¸°',
                modal: true,
                frame:false,
                width: 800,
                height: 200,
                layout: 'fit',
                items: [{
                    xtype: 'textarea',
                    name: 'clipboardData',
                    emptyText: 'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'
                }],
                buttons: [
                  {
                    text: 'ì €ì¥',
                    handler: function(btn) {
                        var win = btn.up('window');
                        var clipboardData = win.down('textarea').getValue();
                        Ext.Ajax.request({
                          url: "{% url 'save_clipboard_Corp' %}",
                          method: 'POST',
                          params: {
                              clipboardData: clipboardData,
                              csrfmiddlewaretoken: "{{ csrf_token }}"
                          },
                          success: function(response) {
                            win.close();
                            Swal.fire({
                              title: 'ì‘ì—… ì„±ê³µ',
                              text: 'ì „ìì‹ ê³ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                              icon: 'success',
                              //timer: 500,  // Set the timer to 3 seconds (3000 ms)
                              showConfirmButton: true,  // Hide the confirm button
                              willClose: () => {
                                let store = Ext.getCmp('mainGrid').getStore();
                                Ext.each(response.sqnos, function (item) {
                                    let record = store.findRecord('seq_no', item.seq_no);
                                    if (record) {
                                        record.set('isIssue', "ğŸ’™"); // userIDì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                    }
                                });
                                store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                              }
                            });                              
                          },
                          failure: function(response) {
                            Swal.fire("ì˜¤ë¥˜", "ì €ì¥ì˜¤ë¥˜ : " + response.message, "error");
                          }
                        });
                        win.close();
                    }
                  },
                  {
                    text: 'ì·¨ì†Œ',
                    handler: function(btn) {
                        btn.up('window').close();
                    }
                  }]
              }).show();
            },
            style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },      
          {
            xtype: 'button',
            text: 'ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œ',
            iconCls: 'fa fa-cloud-upload',
            handler: function () {
              let uploadWindow = Ext.create('Ext.window.Window', {
                    title: 'íŒŒì¼ ì—…ë¡œë“œ',
                    modal: true,
                    layout: 'fit',
                    items: [{
                        xtype: 'form',
                        bodyPadding: 10,
                        fileUpload: true,
                        items: [{
                            xtype: 'filefield',
                            name: 'uploadFile',
                            fieldLabel: 'íŒŒì¼ ì„ íƒ',
                            labelWidth: 70,
                            msgTarget: 'side',
                            allowBlank: false,
                            anchor: '100%',
                            buttonText: 'íŒŒì¼ ì°¾ê¸°...'
                        }],
                        buttons: [{
                            text: 'ì—…ë¡œë“œ',
                            handler: function (btn) {
                                var form = btn.up('form').getForm();
                                if (form.isValid()) {
                                  form.submit({
                                    url: "{% url 'save_elecfile_Corp' %}", // Django ì—…ë¡œë“œ URL
                                    params: {
                                        csrfmiddlewaretoken: "{{ csrf_token }}"
                                    },
                                    waitMsg: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...',
                                    success: function (form, action) {
                                        Ext.Msg.alert('ì„±ê³µ', 'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                        let response = action.result;
                                        uploadWindow.close();
                                        let store = Ext.getCmp('mainGrid').getStore();
                                        let record = store.findRecord('seq_no', response.seq_no);
                                        record.set('JupsuID', response.userID.slice(-2));  
                                        store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                                    },
                                    failure: function (form, action) {
                                        Ext.Msg.alert('ì‹¤íŒ¨', 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                    }
                                  });
                                }
                            }
                        }]
                    }]
                }).show();
            },
            style: 'margin-right: 10px;'
          },              
          {
              xtype: 'textfield',
              emptyText: 'ê²€ìƒ‰ì–´ ì…ë ¥',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // ê·¸ë¦¬ë“œì˜ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // í•„í„° ì œê±°
                      } else {
                          store.clearFilter(true); // ê¸°ì¡´ í•„í„° ì œê±°
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              const ceoName = record.get('ceo_name')?.toLowerCase() || '';
                              return (
                                  bizName.includes(searchValue) || ceoName.includes(searchValue)
                              );
                          });
                      }
                  }
              }
              
          },
          {
              xtype: 'button',
              iconCls: 'icon icon-refresh',
              handler: function (btn) {
                  location.reload();
              },
              style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },
      ],            
      width:'100%',
      height: window.innerHeight - 120, // ì´ˆê¸° ë†’ì´ ì„¤ì •
      scrollable: 'y', // ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
      store: store,
      columnLines: true,
      ... (ADID === "ì „ì²´" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}),        
      plugins: [cellEditing],
      columns: [
        {   xtype: 'rownumberer',width: 30,	sortable: false}, 
        {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0        }, 
        {   header: 'SEQ', dataIndex: 'seq_no',width: 0        }, 
        {   id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',flex:1,minWidth: 130,renderer: renderTopic },
        {
          text: `${work_YY} ë…„`,
          columns: [{			
            header: '<center>ìˆ˜ì…ê¸ˆì•¡</center>', dataIndex: 'revenue',  width: 95, xtype: 'numbercolumn', align:'right',format:'0,000'
          }, {
            header: '<center>íŒê´€ë¹„ ë“±</center>', dataIndex: 'expense',  width: 80,xtype: 'numbercolumn',align:'right', format:'0,000'
          }, {
            header: '<center>ë‹¹ê¸°ìˆœì†ìµ</center>', dataIndex: 'income',  width: 80,xtype: 'numbercolumn',align:'right', format:'0,000'
          }]		
        }, {
          text: 'ì¤‘ê°„ì˜ˆë‚© ì‹ ê³ ë°©ë²•',
          columns: [{	
            header: '<center>ê¶Œì¥ë°©ë²•</center>', dataIndex: 'suggestWay',  width: 120, align:'center'
          }, {
            header: '<center>ì˜ˆìƒì„¸ê¸ˆ</center>', dataIndex: 'preTax',  width: 100,xtype: 'numbercolumn',align:'right', format:'0,000', editor: { allowBlank: false }
          }, {
            header: '<center>í™ˆíƒìŠ¤<br>ì‹ ê³ ë°©ë²•</center>', dataIndex: 'submitWay',  width: 90, align:'center'
          }, {
            header: '<center>ì¤‘ê°„ì˜ˆë‚©<br>ì„¸ì•¡</center>', dataIndex: 'midTax',  width: 100,xtype: 'numbercolumn',align:'right', format:'0,000', editor: { allowBlank: false }
          }, {
            header: '<center>ì‹ ê³ <br>ê²€ì¦</center>', dataIndex: 'inspectIssue',  width: 40, align:'center',
            renderer: function(value) {
                const emojis = {
                    1: "ğŸ˜¡",  // ë¶ˆì¾Œ
                };
                return value.trim() ?  emojis[value] : "";  // ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
            }             
          }]		
        }, {
          header: '<center>ì•ˆë‚´<br>ë©”ì¼<br>ì „ì†¡</center>', dataIndex: 'mail_Guide', width: 40, align:'center',
          renderer: function(value, metaData, record) {
            const emojis = {
              1: "ğŸ˜¡",  // ë¶ˆì¾Œ
              2: "âœ…",  // ì‹œë¬´ë£©
            };
            const emoji = emojis[value] || "";
            return Ext.String.format(      
              `<div style="cursor:pointer;" onclick="summitModal(window['record_{0}'], {0}, '{1}', '{2}','Corp', 'ì•ˆë‚´ë©”ì¼ì „ì†¡')">
                {3}
              </div>`,
              record.data.seq_no,
              Ext.String.htmlEncode(record.data.biz_name),
              work_YY,
              emoji
            );            
          }          
        }, {
          header: '<center>ë‚©ë¶€<br>ë©”ì¼<br>ì „ì†¡</center>', dataIndex: 'mail_Issue', width: 40, align:'center',
          renderer: function(value, metaData, record) {
            const emojis = {
              1: "ğŸ˜¡",  // ë¶ˆì¾Œ
              2: "âœ…",  // ì‹œë¬´ë£©
            };
            const emoji = emojis[value] || "";
            return Ext.String.format(      
              `<div style="cursor:pointer;" onclick="summitModal(window['record_{0}'], {0}, '{1}', '{2}','Corp', 'ë‚©ë¶€ë©”ì¼ì „ì†¡')">
                {3}
              </div>`,
              record.data.seq_no,
              Ext.String.htmlEncode(record.data.biz_name),
              work_YY,
              emoji
            );            
          }           
        }, {
          header: '<center>ì „ì<br>ì‹ ê³ </center>', dataIndex: 'isIssue',  width: 40,renderer: value => value ? "ğŸ’™" : "" 
        }, {
          text: `${work_YY-1} ë…„`,
          columns: [{	
            header: '<center>ì´ìˆ˜ì…ê¸ˆì•¡</center>', dataIndex: 'revenue_pre',  width: 100,xtype: 'numbercolumn',align:'right', format:'0,000'
          }, {
            header: '<center>ë‹¹ê¸°ìˆœì†ìµ</center>', dataIndex: 'income_pre',  width: 100,xtype: 'numbercolumn',align:'right', format:'0,000'
          }, {
            header: '<center>ë²•ì¸ì„¸ë“±</center>', dataIndex: 'preYearCorpTax',  width: 100,xtype: 'numbercolumn',align:'right', format:'0,000'
          }]	
      }],   
      viewConfig: {
        emptyText: '<div style="text-align:center;padding:50px;font-size:16px; font-weight:bold;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
      },                  
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          items: 
          [...dockedItemsConfig,
          {
            xtype: 'buttongroup',              
            columns: 5,
            frame:false,
            defaults: {
              enableToggle: true,
              toggleGroup: 'yearGroup',
              margin: '0 5 0 0', // ë²„íŠ¼ ê°„ê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ 5px ê°„ê²©)
              style: {
                  border: '1px solid #ccc',
                  padding: '5px 6px',
                  borderRadius: '5px',
                  transition: 'all 0.2s ease' // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
              }
            },
            items: Array.from({ length: 5 }, (_, i) => ({
              text: `${currentYear - i}ë…„`,
              pressed: currentYear - i === parseInt(work_YY, 10),
              handler: function () {
                var selectedYear = parseInt(this.text.replace('ë…„', ''))
                work_YY = selectedYear
                const data = {
                    ADID: ADID,
                    work_YY : work_YY
                };
                // ë¡œë”© ë§ˆìŠ¤í¬ ìƒì„± (ëŒ€ìƒ: ê·¸ë¦¬ë“œë‚˜ íŒ¨ë„)
                var targetComponent = Ext.getCmp('mainGrid') || Ext.getBody(); // ëŒ€ìƒ ì„¤ì • (ê·¸ë¦¬ë“œ IDë‚˜ body)
                var loadMask = new Ext.LoadMask({
                    msg: 'ì—°ë„ë¥¼ ë³€ê²½ì¤‘ì…ë‹ˆë‹¤...', 
                    target: targetComponent
                });
                loadMask.show(); // ë¡œë”© í‘œì‹œ ì‹œì‘
                Ext.Ajax.request({
                    url: '{% url "mng_corp_jungkan" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                    method: 'GET',
                    params: data, // ë°ì´í„°ë¥¼ GET íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
                    success: function (response) {
                        try {
                            const jsonResponse = Ext.decode(response.responseText); // JSON íŒŒì‹±
                            store.loadData(jsonResponse); // ë°ì´í„° ë¡œë“œ
                        } catch (e) {
                            console.error('Failed to parse response:', e, response.responseText);
                        } finally {
                            loadMask.hide(); // ë¡œë”© ì¢…ë£Œ
                        }
                    },
                    failure: function (response) {
                        alert('Request failed:', response);
                        loadMask.hide(); // ë¡œë”© ì¢…ë£Œ
                    }
                });
              }//handler
            }))//items
          },
          '->',  // ìš°ì¸¡ ì •ë ¬ì„ ìœ„í•œ tbfill
          {
            xtype: 'displayfield',
            fieldLabel: 'ë§¤ì¶œ',
            itemId: 'totalRevenueDisplay',
            margin: '0 10 0 0',
            value: '0'
          },{
            xtype: 'displayfield',
            fieldLabel: 'ì „ì²´',
            itemId: 'totalCommissionDisplay',
            value: '0'
          },{
            xtype: 'displayfield',
            fieldLabel: 'ìˆ˜ê¸ˆ',
            itemId: 'collectedCommissionDisplay',
            margin: '0 10 0 10',
            value: '0',
            
          }             
        ]//dockeditems
        }
      ],
      listeners: {
        afterrender: function(grid) {
          var store = grid.getStore();
          // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•©ê³„ ì—…ë°ì´íŠ¸
          store.on('datachanged', function() {
              var totalCommission = 0,
                  collectedCommission = 0,
                  totalRevenue = 0;
              store.each(function(record) {
                  var commission = record.get('YN_8') || 0;
                  totalCommission += commission;
                  if (record.get('YN_7')) {
                      collectedCommission += commission;
                  }
                  var revenue = record.get('revenue') || 0;
                  totalRevenue += revenue;
              });
              grid.down('#totalCommissionDisplay').setValue(
                  Ext.util.Format.number(totalCommission, '0,000')
              );
              grid.down('#collectedCommissionDisplay').setValue(
                  Ext.util.Format.number(collectedCommission, '0,000')
              );
              grid.down('#totalRevenueDisplay').setValue(
                  Ext.util.Format.number(totalRevenue, '0,000')
              );
          });
        }  
      }
    });
    //íšŒì›ì •ë³´ íŒì—…ìƒì„± assets/js/ExtToooltip.js
    const grid = Ext.ComponentQuery.query('gridpanel')[0]; // ì²« ë²ˆì§¸ ê·¸ë¦¬ë“œ ê°€ì ¸ì˜¤ê¸°
    const tooltipUrl = '{% url "kijang_member_popup" %}?seq_no={seq_no}';
    if (grid) {
      //attachGridToolTip(grid, tooltipUrl);
      attachGridToolTip_Helper(grid, work_YY);
      attachGridToolTip_JupsuSummit(grid,work_YY);
    }
});
// ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ ì •ì˜
const debounce = (func, delay) => {
  let timeoutId;
  return function (...args) {
    const context = this;
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(context, args), delay);
  };
};

function renderTopic(value, p, record) {
    // ì „ì—­ ê°ì²´ë¥¼ í™œìš©í•˜ì—¬ record ì €ì¥
    let recordKey = `record_${record.data.seq_no}`;
    window[recordKey] = record;  // `window`ì— ì €ì¥

    return Ext.String.format(
        `<div style="cursor:pointer; color:blue;" 
            onclick="summitModal(window['${recordKey}'], ${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, 'Corp','ì—…ì²´ëª…');">
            ${Ext.String.htmlEncode(value)}
        </div>`
    );
}
function renderMail(value, p, record) {
}
// ğŸŒŸ ê¸°ì¡´ ë°©ë¬¸ ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ê°ì²´ (ì „ì—­ ë³€ìˆ˜)
let previousValues = {};
const summitModal = async (record,seq_no, biz_name, work_YY, flag, headerText = '') => {
  showLoading("loading...");

  // âœ… í˜„ì¬ `seq_no`ì— í•´ë‹¹í•˜ëŠ” recordë§Œ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì €ì¥
  let recordKey = `record_${seq_no}`;
  delete window[recordKey];  
  window[recordKey] = record;  // `window`ì— ì €ì¥

  let tmpHead = `
    <nav aria-label='breadcrumb'>
      <ol class='breadcrumb breadcrumb-style'>
        <li class='breadcrumb-item'>${biz_name}</li>
        <li class='breadcrumb-item'>${work_YY}ë…„</li>
        <li class='breadcrumb-item active'>ë²•ì¸ì„¸ ì¤‘ê°„ì˜ˆë‚©</li>
      </ol>
    </nav>
  `;  
  $('[id="summitModalTitle"]').html(tmpHead);
  let tmpTab = `
    <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
      <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-0">
        ë²•ì¸ì„¸ì‹ ê³ ì„œ
      </a>      
      <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-1">
        ì•ˆë‚´ë©”ì¼ ì „ì†¡
      </a>
      <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-2">
        ë‚©ë¶€ë©”ì¼ ì „ì†¡
      </a>      
      <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 " data-bs-toggle="tab" href="#task-3">
        ì‹ ê³ ê²°ê³¼/ë¶„ì„
      </a>                       
      <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-4">
        ë³´ë‚¸ ë©”ì¼
      </a>
    </nav>  
  `;
  let tmpTab_Content = `
    <!--  #0 . ë²•ì¸ì„¸ ì‹ ê³ ì„œ  -->
    <div class="tab-pane active task-files-tab" id="task-0">
      <div class="d-flex">
        <div class="flex-grow-1 pe-3 mt-2 ps-5" style="flex-basis: 35%;">
          <div class="btn-group">
            <button id="btn_selectedYear"  type="button" class="btn btn-info dropdown-toggle mb-2" data-bs-toggle="dropdown">
              ${work_YY} ë…„<span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li class="dropdown-plus-title">
                ì‘ì—…ì—°ë„
                <b class="fa fa-angle-up" aria-hidden="true"></b>
              </li>
              <div class="list-group">
                {% for node in corpYears %}
                  <li class="list-group-item list-group-item-action">
                    <a href="javascript:handleButtonClose(${seq_no}, '${biz_name}',{{ node }})">{{ node }}ë…„</a>
                  </li>
                {% endfor %}
              </div>
            </ul>
          </div>          
          <div class="panel-group1" id="accordionLeft" role="tablist" aria-expanded="false" style="max-height: 860px; overflow-y: auto;"></div>
        </div>
        <div class="flex-grow-0" style="flex-basis: 65%;">
          <div class="card-body" >
            <iframe id="singoseoPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
          </div>
        </div>
      </div>              
    </div>
    <!--  #1 . ì•ˆë‚´ë©”ì¼ ì „ì†¡  -->
    <div class="tab-pane task-files-tab" id="task-1">
      <div class="d-flex">
        <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
          <div class="container" id = "CorpJungkanIntro"></div>
        </div>
        <div class="flex-grow-0" style="flex-basis: 50%;">
          <div class="card-body" >
            <iframe id="introPDFIframe" width="100%" height="800px" frameborder="0"></iframe>
          </div>
        </div>
      </div>              
      <div class="modal-footer justify-content-center" id="btnKakaoSend1"></div>
    </div>
    <!-- #2. ë‚©ë¶€ë©”ì¼ ì „ì†¡  -->
    <div class="tab-pane task-files-tab" id="task-2">
      <div class="d-flex">
        <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
          <div class="container" id = "CorpJungkanResult"></div>
        </div>
        <div class="flex-grow-0" style="flex-basis: 50%;">
          <div class="card-body" >
            <div class="container" id = "resultDiagnosys"></div>
          </div>
        </div>
      </div>              
      <div class="modal-footer justify-content-center" id="btnKakaoSend2"></div>
    </div>
    <!-- #4. ë³´ë‚¸ë©”ì¼  -->
    <div class="tab-pane  task-files-tab" id="task-4">
      <div class="d-flex">
        <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
          <div class="container" id = "sentMailTable"></div>
        </div>
        <div class="flex-grow-0" style="flex-basis: 50%;">
          <div class="card-body" >
            <iframe id="mailIframe" width="100%" height="850px" frameborder="0"></iframe>
          </div>
        </div>
      </div>    
    </div>  
  `;

  $('[id="tabsMenu"]').html(tmpTab);  //íƒ­ë©”ë‰´ ë¶™ì´ê¸°
  $('[id="tabContent"]').html(tmpTab_Content);  //íƒ­ë‚´ìš© ë¶™ì´ê¸°
  // â± í—¤ë” í…ìŠ¤íŠ¸ì— ë”°ë¥¸ íƒ­ ID ë§¤í•‘
  const headerToTabId = {
    'ì—…ì²´ëª…': 'task-0',
    'ì•ˆë‚´ë©”ì¼ì „ì†¡': 'task-1',
    'ë‚©ë¶€ë©”ì¼ì „ì†¡': 'task-2'
  };

  const tabId = headerToTabId[headerText] || 'task-0';

  setTimeout(() => {
    const $targetTab = $(`[data-bs-toggle="tab"][href="#${tabId}"]`);
    if ($targetTab.length) {
      $targetTab.tab('show');
    }
  }, 100);  
  await treeLoad(seq_no,biz_name,work_YY);   //#0 ì‹ ê³ ì„œë³´ê¸°
  await setMailContent(seq_no,work_YY,work_MM,'CorpJungkanIntro');   //#1. ì•ˆë‚´ë©”ì¼ ë‚´ìš©ìƒì„±
  
  await setIntroPDF(seq_no,work_YY,biz_name);  //#1. ì‹ ê³ ë„ì›€ ì„œë¹„ìŠ¤ íŒŒì¼ ë¡œë”©

  // #1 ì‹ ê³ ë„ì›€ í•˜ë‹¨ ë³´ë‚´ê¸°ë²„íŠ¼
  let tmpBtn1 = `<button class="btn btn-info" onclick="sendMailAndKakao(${seq_no},'${biz_name}', ${work_YY}, ${work_MM}, 'CorpJungkanIntro')">
    <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
    </button> 
    <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
  $('[id="btnKakaoSend1"]').html(tmpBtn1);  

  //#2. ê²°ê³¼ë©”ì¼ ì‘ì„±
  await setMailContent(seq_no, work_YY, work_MM, 'CorpJungkanResult');  
  let tmpBtn2 = `<button class="btn btn-info" onclick="sendMailAndKakao(${seq_no},'${biz_name}', ${work_YY}, ${work_MM}, 'CorpJungkanResult')">
    <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
    </button> 
    <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
  $('[id="btnKakaoSend2"]').html(tmpBtn2);      

  //#5. ë³´ë‚¸ë©”ì¼ í™•ì¸í•˜ê¸°
  await sentMailList(seq_no, flag,"{% url 'getSentMails' %}");  
  $("#summitModal").modal('show');

  hideLoading(); // ë¡œë”© ë§ˆìŠ¤í¬ ìˆ¨ê¹€
};

//############# 0.ì‹ ê³ ì„œ ë³´ê¸°
const treeLoad = async (seq_no,biz_name,work_YY) => {
  try {
    const accordionLeft = document.getElementById('accordionLeft');
    accordionLeft.innerHTML = ""; // ê¸°ì¡´ ìš”ì†Œ ë¹„ìš°ê¸°
    const response = await fetch("{% url 'path_to_corp_admin' %}", {
        method: "POST",
        dataType:"Json",
        body: JSON.stringify({
          seq_no:seq_no,
          path: `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ`
        })
    });

    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
    
    const data = await response.json();
    //console.log(data)
    const { titles, nodes: gridFile } = data;

    const fragment = document.createDocumentFragment();

    titles.forEach((title, s) => {
        const divCard = document.createElement("div");
        divCard.classList.add("card", "overflow-hidden", "mb-2", "border-0");
        divCard.id = `collapseHead${s}`;

        const anchor1 = document.createElement('a');
        anchor1.classList.add("accordion-toggle", "panel-heading1", "collapsed");
        anchor1.dataset.bsToggle = "collapse";
        anchor1.ariaExpanded = "false";
        anchor1.href = `#collapse${s}`;
        anchor1.textContent = title.displayName;
        divCard.appendChild(anchor1);

        const divTabpanel = document.createElement("div");
        divTabpanel.classList.add("panel-collapse", "collapse");
        if (s === 0) {
            divTabpanel.classList.add("show");
            selectedSheetID = gridFile[0]?.id || null;
            selectedPeriod = title.displayName;
        }
        divTabpanel.id = `collapse${s}`;
        divTabpanel.role = "tabpanel";
        divTabpanel.ariaExpanded = "false";
        divTabpanel.dataset.bsParent = "#accordionAcnt";
        divCard.appendChild(divTabpanel);

        const ul = document.createElement('ul');
        ul.classList.add("nav1", "nav-column", "flex-column", "br-7");
        ul.id = `singoList${s}`;
        divTabpanel.appendChild(ul);

        singoListDetail(ul, title.displayName, gridFile, title.displayName, selectedSheetID);

        fragment.appendChild(divCard);
    });

    accordionLeft.appendChild(fragment);
  } catch (error) {
    console.error("Error loading tree:", error);
  }
};
const singoListDetail = async (ul, selGroup, gridFile, singoPeriod, selSheetID) => {
  return new Promise((resolve, reject) => {
    ul.innerHTML = "";  // ul ë¹„ìš°ê³  ì‹œì‘ (ê¶Œì¥)

    for (let i = 0; i < gridFile.length; i++) {
      if (gridFile[i].group === selGroup) {
        const li = document.createElement("li");
        li.setAttribute('id', "li" + gridFile[i].id);
        li.setAttribute('class', "nav-item1 mt-0");

        const anchor2 = document.createElement('a');
        anchor2.setAttribute('class', `nav-link thumb ${gridFile[i].id == selSheetID ? 'active' : ''}`);
        anchor2.setAttribute('id', gridFile[i].id);

        anchor2.href = `javascript:changeSheet('${gridFile[i].id}','${encodeURIComponent(singoPeriod)}','${encodeURIComponent(gridFile[i].íŒŒì¼ëª…)}','${encodeURIComponent(gridFile[i].totalPath)}')`;

        if (gridFile[i].íŒŒì¼ëª….includes("ë‚©ë¶€ì„œ")) {
          anchor2.innerHTML = `<span class='badge badge-sm bg-danger badge-hide me-4'>ë‚©ê¸°:${gridFile[i].dueDate}</span>${gridFile[i].íŒŒì¼ëª…}`;
        } else if (gridFile[i].íŒŒì¼ëª….includes("ì‹ ê³ ì„œ")) {
          anchor2.innerHTML = `<i class='ion ion-grid text-info'></i> ${gridFile[i].íŒŒì¼ëª…} <i class='ion ion-grid text-info ms-2'></i>`;
        } else {
          anchor2.innerHTML = `<i class='typcn typcn-minus-outline text-info'></i> ${gridFile[i].íŒŒì¼ëª…}`;
        }

        li.appendChild(anchor2);
        ul.appendChild(li);

        if (gridFile[i].id == selSheetID) {
          changeSheet(selSheetID, singoPeriod, gridFile[i].íŒŒì¼ëª…, gridFile[i].totalPath);
        }
      }
    }
  });
};
function changeSheet(selSheetID,selPeriod,selSheetName,file_path){
  selPeriod = decodeURIComponent(selPeriod);
  selSheetName = decodeURIComponent(selSheetName);
  file_path = decodeURIComponent(file_path);

  //ì¢Œì¸¡ ì»¨íŠ¸ë¡¤
  if(document.getElementById(selectedSheetID)){
    document.getElementById(selectedSheetID).setAttribute('class',"nav-link thumb")
  }
  if(document.getElementById(selSheetID)){
    document.getElementById(selSheetID).setAttribute('class',"nav-link thumb active")
  }

  let iframe = document.getElementById("singoseoPDFIframe");
  if (iframe) {
      iframe.src = file_path;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
  } else {
    iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ì„œê°€ ë°”ë¥´ê²Œ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
  }    
  selectedSheetID = selSheetID;
  selectedPeriod = selPeriod;
  selectedSheetName = selSheetName;
}
const handleButtonClose = (seq_no, biz_name,ev) => {
  const btnElement  = document.getElementById('btn_selectedYear');
  btnElement.innerHTML = ev+" ë…„";
  treeLoad(seq_no, biz_name, ev);
};  


//############# ì•ˆë‚´ ì¹´í†¡ë‚´ìš© ìƒì„±
// ì ‘ìˆ˜ê²°ê³¼ ê¸°ë³¸ì€ false, ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œì‹œ true
let resultAndFee = false;
const setMailContent = async (seq_no, work_YY, work_MM, flag) => {
  $.ajax({
    url: "{% url 'getMailContent' %}",
    type: "POST",
    data: {
      seq_no: seq_no,
      work_YY: work_YY,
      work_MM: work_MM,
      flag:flag,
      csrfmiddlewaretoken: "{{ csrf_token }}"
    },
    dataType: "json",
    success: function (data) {
      var bodyContent = data.email_content
      $('[id="' + flag + '"]').html(bodyContent);
    },
    error: function (request, status, error) {
      console.log('fail: ' + error);
    }
  });
};
const setIntroPDF = async (seq_no, work_YY, biz_name) => {
  let pdf98 = `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ/98.pdf`;
  let iframe = document.getElementById("introPDFIframe");
  try {
      // HEAD ìš”ì²­ì€ íŒŒì¼ì˜ ë‚´ìš©ì„ ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³ , íŒŒì¼ì˜ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸í•¨.
      let response = await fetch(pdf98, { method: 'HEAD' });    
      if (response.ok) {
          // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° iframe ì—…ë°ì´íŠ¸
          
          if (iframe) {
              iframe.src = pdf98;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
          } else {
            iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(98.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          }
      } else {
        iframe.innerHTML = "ë²•ì¸ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(98.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
  } catch (error) {
    iframe.innerHTML = "PDF íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:"+ error;
  }
};

// í•˜ë‹¨ ì¹´í†¡&ë©”ì¼ ë³´ë‚´ê¸°
const sendMailAndKakao = async (seq_no, biz_name, work_YY, work_MM, mail_class) => {
  const objectUrl = "{% url 'sendMail' %}";
  const objectUrl_kakao = "{% url 'send_kakao_notification' %}";
  const user_path = `static/cert_DS/${biz_name}/${work_YY}/ì„¸ë¬´ì¡°ì •ê³„ì‚°ì„œ`;
  var user_file_names = []
  var targetUrl = '';
  // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
  let allIsGood = true;

  if(mail_class=="CorpJungkanIntro"){
    targetUrl = 'admin/mail/corp_Jungkan_intro.html';  
  } 
  else if(mail_class=="CorpJungkanResult"){
    targetUrl = 'admin/mail/corp_Jungkan_result.html';   
    checkfileNames = ["204.pdf"];
    for (let fileName of checkfileNames) {
      let filePath = `${user_path}/${fileName}`;
      let exists = await fileExists(filePath);
      if (!exists) {
        if (fileName=="204.pdf"){
          allIsGood = false;
          alert(`ì¤‘ê°„ì˜ˆë‚© ë‚©ë¶€ì„œ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
          break;
        }
      }else{
        user_file_names.push(fileName)        
      }
    }
  } 
  
  // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
  if (allIsGood) {
    sendMail(seq_no, work_YY, work_MM, mail_class, objectUrl, targetUrl,user_file_names, user_path);
    sendKakao(seq_no, work_YY, work_MM, mail_class, objectUrl_kakao);
  } else {
    alert("ë©”ì¼ê³¼ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì†¡ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
};

// íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
const fileExists = async (filePath) => {
  try {
    let response = await fetch(filePath, { method: 'HEAD' });
    return response.ok; // íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ true, ì—†ìœ¼ë©´ false
  } catch (error) {
    console.error("íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    return false;
  }
};

//ì ‘ìˆ˜ì¦ ë§ˆìš°ìŠ¤ í´ë¦­ì‹œ íˆ´íŒë°œìƒ
function attachGridToolTip_JupsuSummit(grid,work_YY){
  Ext.create('Ext.tip.ToolTip', {
      target: grid.getEl(),
      delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
      trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
      dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
      autoHide: true, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
      maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
      minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
      anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
      mouseOffset: [-350, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
      renderTo: Ext.getBody(),
      listeners: {
        beforeshow: function (tip) {
          const cell = Ext.get(tip.triggerElement);
          const record = grid.getView().getRecord(cell.parent());
          const columnIndex = cell.dom.cellIndex;
          const column = grid.headerCt.getHeaderAtIndex(columnIndex);
        
          if (column.dataIndex === 'isIssue') {
            const seqNo = record.get('seq_no');
            Ext.Ajax.request({
                url: '{% url "mng_corp_jupsuSummit" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                method: 'POST',
                params: {
                  seq_no:seqNo,
                  work_YY:work_YY,
                  csrfmiddlewaretoken: "{{ csrf_token }}"
                }, 
                success: function (response) {
                    const data = Ext.decode(response.responseText);
                    tip.update(`
                <div class="notifications-menu ps3 overflow-hidden">
                    <div class="drop-heading border-bottom position-relative">
                        <div class="d-flex">
                            <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                              <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                            </div>
                            <div class="ms-3">
                                <h6 class="mt-1 mb-0 fs-15 text-dark">ë²•ì¸ì„¸ ì¤‘ê°„ì˜ˆë‚© ì „ìì‹ ê³  ì ‘ìˆ˜ì¦</h6>
                                <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                    </div>    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">${data.ì‹ ê³ ì„œì¢…ë¥˜}</span>
                            </div>
                        </div>                                                                                    
                    </div>                                                                                    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">íšŒê³„ê¸°ê°„ ì¢…ë£Œì›” ${data.ê³¼ì„¸ë…„ì›”}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>      
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì‹ ê³ ìœ í˜• : ${data.ì‹ ê³ ìœ í˜•}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                                                                                                              
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì‹ ê³ ë²ˆí˜¸</span>
                              <span class="notification-label ">${data.ì‹ ê³ ë²ˆí˜¸}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì‹ ê³ ì‹œê° ${data.ì‹ ê³ ì‹œê°}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                          
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì ‘ìˆ˜ID ${data.ì‚¬ìš©ìID}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                                              
                </div>
                    `);
                      // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                      Ext.defer(() => {
                          const closeButton = document.getElementById("tooltipCloseBtn");
                          if (closeButton) {
                              closeButton.addEventListener("click", function () {
                                  tip.hide();
                              });
                          }
                      }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                },
                failure: function () {
                    tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                }
            });
          } else {
              return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
          }
        }
      }
  });  
}

// ìƒí˜¸ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ íˆ´íŒ ë°œìƒ
function attachGridToolTip_Helper(grid,work_YY) {
  Ext.create('Ext.tip.ToolTip', {
      target: grid.getEl(),
      delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
      trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
      dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
      autoHide: false, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
      maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
      minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
      anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
      mouseOffset: [0, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
      renderTo: Ext.getBody(),
      listeners: {
        beforeshow: function (tip) {
          const cell = Ext.get(tip.triggerElement);
          const record = grid.getView().getRecord(cell.parent());
          const columnIndex = cell.dom.cellIndex;
          const column = grid.headerCt.getHeaderAtIndex(columnIndex);
        
          if (column.dataIndex === 'biz_name') {
            const seqNo = record.get('seq_no');

            // AJAXë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ íˆ´íŒ ì—…ë°ì´íŠ¸
            Ext.Ajax.request({
                url: '{% url "mng_corp_deduct_tooltip" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                method: 'POST',
                params: {
                  seq_no:seqNo,
                  work_YY:work_YY,
                  csrfmiddlewaretoken: "{{ csrf_token }}"
                }, 
                success: function (response) {
                    const data = Ext.decode(response.responseText);
                    tip.update(`
                <div class="notifications-menu ps3 overflow-hidden">
                    <div class="drop-heading border-bottom position-relative">
                        <div class="d-flex">
                            <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                              <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                            </div>
                            <div class="ms-3">
                                <h6 class="mt-1 mb-0 fs-15 text-dark">ì„¸ì•¡ê°ë©´ ê³µì œ íŒë‹¨ì‚¬í•­</h6>
                                <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                    </div>    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-yellow brround">
                                <i class="icon icon-magic-wand"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì¤‘ì†Œê¸°ì—… íŠ¹ë³„ì„¸ì•¡ê°ë©´ ${data.SpecialDeduct === 'Y' ? 'â­•' : 'âŒ'}, ê°ë©´ìœ¨ : ${data.SpecialDeductRate} %</span>
                              <span class="notification-subtext text-muted">ìˆ˜ë„ê¶Œì™¸ ${data.isRural === 'Y' ? 'â­•' : 'âŒ'}, ì†Œê¸°ì—…ìš”ê±´ ${data.isSmall === 'Y' ? 'â­•' : 'âŒ'}, ì—…ì¢…:${Ext.String.htmlEncode(data.upjong)}${data.isSpecialUpjong === 'Y' ? 'â­•' : 'âŒ'} </span>
                            </div>
                                                      
                        </div>                                                                                    
                    </div>                                                                                    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-red brround">
                                <i class="icon icon-fire"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì°½ì—…ì¤‘ì†Œê¸°ì—…ê°ë©´ ${data.ChangUpDeduct === 'Y' ? 'â­•' : 'âŒ'}, ê°ë©´ìœ¨ :${data.ChangUpDeductRate } %</span>
                              <span class="notification-subtext text-muted">ê³¼ë°€ì§€ì—­ì™¸ ${data.isKWAMIL === '' ? 'â­•' : 'âŒ'}, ëŒ€í‘œìë‚˜ì´ : ${data.age}ì„¸, ê°œì—…ìš”ê±´ : ${data.kisu <=5 ? 'â­•' : 'âŒ'}(${data.kisu}ê¸°), ì†Œê·œëª¨ì°½ì—… ${data.isLittle === 'Y' ? 'â­•' : 'âŒ'}, ì—…ì¢…:${Ext.String.htmlEncode(data.upjong)}${data.isSpecialUpjong === 'Y' ? 'â­•' : 'âŒ'}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>      
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì²­ë…„ì—¬ë¶€ ${data.isYoung === 'Y' ? 'â­•' : 'âŒ'}</span>
                              <span class="notification-label ">ë¬¼ë¥˜ì‚°ì—… ${data.isMyulyu === 'Y' ? 'â­•' : 'âŒ'}, ì‹ ì„±ì¥ì‚°ì—… ${data.isNewGroth === 'Y' ? 'â­•' : 'âŒ'}, ì§€ì‹ê¸°ë°˜ì‚°ì—… ${data.isKnowledge === 'Y' ? 'â­•' : 'âŒ'}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                                                                                                              
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-green brround">
                                <i class="icon icon-graduation"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ê¸°ì—…ë¶€ì„¤ì—°êµ¬ì†Œ ë³´ìœ ì—¬ë¶€ ${data.isRND === 'Y' ? 'â­•' : 'âŒ'}</span>
                              <span class="notification-label ">ë²¤ì²˜ê¸°ì—… ì¸ì¦ì—¬ë¶€ ${data.isVenture === 'Y' ? 'â­•' : 'âŒ'}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>    
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-yellow brround">
                                <i class="icon icon-people"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ê³ ìš©ì¦ëŒ€ ì„¸ì•¡ê³µì œì—¬ë¶€ ${data.cntGoyoungIncrease > 0 ? 'â­•' : 'âŒ'}</span>
                              <span class="notification-label ">ê³ ìš©ì¦ê°€ì¸ì› : ${data.cntGoyoungIncrease} ëª…</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                          
                    <div class="dropdown-divider m-0"></div>        
                    <div class="dropdown-item">
                        <div class="notification-each d-flex">
                            <div class="me-3 notifyimg  bg-info brround">
                                <i class="icon icon-organization"></i>
                            </div>
                            <div>
                              <span class="notification-label mb-1">ì£¼ì†Œ :  ${data.addr}</span>
                            </div>                  
                        </div>                                                                                    
                    </div>                                                                                                                                                
                </div>
                    `);
                      // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                      Ext.defer(() => {
                          const closeButton = document.getElementById("tooltipCloseBtn");
                          if (closeButton) {
                              closeButton.addEventListener("click", function () {
                                  tip.hide();
                              });
                          }
                      }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                },
                failure: function () {
                    tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                }
            });
          } else {
              return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
          }
        }
      }
  });
}

//check(store.getAt(recordIndex).get('seq_no'),'8',work_YY,'13',checked)
const check =(seq_no,target, work_YY, val)=>{
  $.ajax({
    url: "{% url 'mng_corp_update' %}",
    type: "POST",
    data: {
      seq_no: seq_no,
      target : target,
      work_YY: work_YY,
      val : val,
      csrfmiddlewaretoken: "{{ csrf_token }}"
    },
    dataType: "json",
    success: function (data, textStatus, jqXHR) {
      if (jqXHR.status === 200 && data.status === "success") {
        // Swal.fire({
        //   title: 'ì‘ì—… ì„±ê³µ',
        //   text: 'ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        //   icon: 'success',
        //   timer: 500,  // Set the timer to 3 seconds (3000 ms)
        //   showConfirmButton: false,  // Hide the confirm button
        //   willClose: () => {
        //     // Optional: Perform any other action after the alert closes
        //   }
        // });
      } else {
        Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : " + jqXHR.responseJSON.message, "error");
      }
    },
    error: function (jqXHR, textStatus, errorThrown) {
      console.error("AJAX ì‹¤íŒ¨:", textStatus, errorThrown);
      Swal.fire("ì „ì†¡ ì‹¤íŒ¨", "ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + jqXHR.responseJSON.message, "error");
    }
  });
}


</script>

    {% endblock %}