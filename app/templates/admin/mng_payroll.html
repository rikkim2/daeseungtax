{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }    

    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table {
        width: auto !important; 
        margin: 0 !important;
    }
    
    /* ê·¸ë¦¬ë“œ ë˜í¼ */
    .ext-grid-wrapper {
        width: 100%;
        /* ë†’ì´ëŠ” JSì—ì„œ ì„¤ì • */
    }
</style>  

<div class="ext-grid-wrapper"></div>

<div class="modal fade unique-summit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div class="summitModalTitle"></div>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <div class="tabs-menu4 modal-tabs-menu"></div>
        <div class="tab-content modal-tab-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
    // 1. ê·¸ë¦¬ë“œ ë³€ìˆ˜ ë¯¸ë¦¬ ì„ ì–¸
    var mainGrid;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [1] DOM ìš”ì†Œ í™•ë³´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var renderTarget = $('.ext-grid-wrapper').filter(function() {
        return $(this).children().length === 0;
    }).last()[0];

    // 2. ëª» ì°¾ì•˜ë‹¤ë©´, í™œì„± íƒ­ ë‚´ë¶€ì—ì„œ ë¹„ì–´ìˆëŠ” ë˜í¼ë¥¼ ë‹¤ì‹œ ì°¾ìŒ (ChatGPT í•´ê²°ì±…)
    if (!renderTarget) {
        renderTarget = $('div.tab-pane.active .ext-grid-wrapper')
            .filter(function () { return $(this).children().length === 0; })
            .last()[0];
    }
    
    // 3. ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    if (!renderTarget) {
        // console.warn('ë Œë” íƒ€ê²Ÿì´ ì—†ì–´ì„œ ê·¸ë¦¬ë“œë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    // ëª¨ë‹¬ ID ìƒì„± ë° í• ë‹¹
    var $wrapper = $(renderTarget).parent(); 
    var modalUniqueId = 'summitModal_' + Math.floor(Math.random() * 100000);
    var $modal = $wrapper.find('.unique-summit-modal');
    $modal.attr('id', modalUniqueId);

    function findInModal(selector) { return $modal.find(selector); }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getGridHeight() {
        return window.innerHeight - 160; 
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [3] ë³€ìˆ˜ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var adminBizLevel = '{{ admin_biz_level }}'.trim();
    const isSuperuser = '{{ admin_grade }}' === 'SA';
    var ADID = '{{ ADID }}'.trim();        
    var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
    var flag = '{{ flag }}';
    var work_YY = '{{ request.session.workyearPay }}';
    var work_MM = '{{ request.session.workmonthPay }}';
    
    // ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì„¤ì •
    if(!work_YY) work_YY = new Date().getFullYear();
    if(!work_MM) work_MM = new Date().getMonth() + 1;

    const currentYear = new Date().getFullYear();
    var payrollYear, selectedPeriod, selectedSheetID, selectedSheetName="";
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [4] ì „ì—­ í•¨ìˆ˜ ì •ì˜ (onclick ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // 1. renderTopic
    window.renderTopic = function(value, p, record) {
        return Ext.String.format(
            `<div style="cursor:pointer; color:blue;" 
                onclick="window.summitModal(${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, ${work_MM}, 'pay');">
                ${Ext.String.htmlEncode(value)}
            </div>`    
        );
    };

    // 2. check í•¨ìˆ˜
    window.check = function(seq_no, target, work_YY, work_MM, val) {
        $.ajax({
            url: "{% url 'tbl_mng_jaroe_update' %}",
            type: "POST",
            data: {
                seq_no: seq_no, target: target, work_YY: work_YY, work_MM: work_MM, val: val,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            dataType: "json",
            success: function (data, textStatus, jqXHR) {
                if (jqXHR.status !== 200 || data.status !== "success") {
                     Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : " + jqXHR.responseJSON.message, "error");
                }
            },
            error: function (jqXHR) {
                Swal.fire("ì „ì†¡ ì‹¤íŒ¨", "ì„œë²„ ì˜¤ë¥˜", "error");
            }
        });
    };    

    window.summitModal = async function(seq_no, biz_name, wYY, wMM, flag) {

      let tmpHead = `
          <nav aria-label='breadcrumb'>
            <ol class='breadcrumb breadcrumb-style'>
              <li class='breadcrumb-item'>${biz_name}</li>
              <li class='breadcrumb-item'>${wYY}ë…„</li>
              <li class='breadcrumb-item'>${wMM}ì›”</li>
              <li class='breadcrumb-item active'>ê¸‰ì—¬ëŒ€ì¥ ë° ë‚©ë¶€ì„œ</li>
            </ol>
          </nav>`;
      findInModal('.summitModalTitle').html(tmpHead);

      let tmpTab = `
          <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-0">ê¸‰ì—¬ëŒ€ì¥ë“±</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-1">ì›ì²œì„¸ ì•ˆë‚´ë°œì†¡</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-2">ì‹ ê³ ê²°ê³¼/ë¶„ì„</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-3">ê³ ìš©ì¦ëŒ€</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-4">ì§€ê¸‰ëª…ì„¸ì„œ</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-5">ë³´ë‚¸ ë©”ì¼</a>
          </nav>`;
      
      let tmpTab_Content = `
          <div class="tab-pane active task-files-tab" id="task-0">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3 mt-2 ps-5" style="flex-basis: 35%;">
                <div class="btn-group">
                  <button id="btn_selectedYear" type="button" class="btn btn-info dropdown-toggle mb-2" data-bs-toggle="dropdown">
                    ${wYY} ë…„<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    <li class="dropdown-plus-title">ì‘ì—…ì—°ë„<b class="fa fa-angle-up"></b></li>
                    <div class="list-group">
                      {% for node in corpYears %}
                        <li class="list-group-item list-group-item-action">
                          <a href="javascript:window.handleButtonClose(${seq_no}, '${biz_name}', {{ node }})">{{ node }}ë…„</a>
                        </li>
                      {% endfor %}
                    </div>
                  </ul>
                </div>          
                <div class="panel-group1" id="accordionLeft" role="tablist" aria-expanded="false" style="max-height: 860px; overflow-y: auto;"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 65%;">
                <div class="card-body">
                  <iframe id="singoseoPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>              
          </div>
          <div class="tab-pane task-files-tab" id="task-1">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="introMailContent"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <iframe id="introPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend1"></div>
          </div>
          <div class="tab-pane task-files-tab" id="task-2">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="resultMailContent"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <div class="container" id="resultDiagnosys"></div>
                </div>
              </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend2"></div>
          </div>
          <div class="tab-pane task-files-tab" id="task-4">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="4Content"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <div class="container" id="4Diagnosys"></div>
                </div>
              </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend4"></div>
          </div>
          <div class="tab-pane task-files-tab" id="task-5">
            <div class="d-flex">
              <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
                <div class="container" id="sentMailTable"></div>
              </div>
              <div class="flex-grow-0" style="flex-basis: 50%;">
                <div class="card-body">
                  <iframe id="mailIframe" width="100%" height="850px" frameborder="0"></iframe>
                </div>
              </div>
            </div>    
          </div>
      `;
      findInModal('.modal-tabs-menu').html(tmpTab);  
      findInModal('.modal-tab-content').html(tmpTab_Content);  

      // ë°ì´í„° ë¡œë“œ
      await treeLoad(seq_no, biz_name, wYY); 
      await setMailContent(seq_no, wYY, wMM, flag);
      
      // í•˜ë‹¨ ë²„íŠ¼ ìƒì„±
      let tmpBtn1 = `<button class="btn btn-info" onclick="window.sendMailAndKakao(${seq_no},'${biz_name}', ${wYY}, ${wMM}, '${flag}')">
          <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
          </button> 
          <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
      $modal.find('#btnKakaoSend1').html(tmpBtn1);   

      await sentMailList(seq_no, flag, "{% url 'getSentMails' %}");
      
      $modal.modal('show');
    };

    // 4. ê¸°íƒ€ í—¬í¼ í•¨ìˆ˜ (window ë…¸ì¶œ)
    window.handleButtonClose = function(seq_no, biz_name, ev) {
        const btnElement = document.getElementById('btn_selectedYear');
        // ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œì´ë¯€ë¡œ findInModal ì‚¬ìš© ê¶Œì¥í•˜ì§€ë§Œ, IDê°€ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ 
        if(btnElement) btnElement.innerHTML = ev + " ë…„";
        treeLoad(seq_no, biz_name, ev);
    };

    window.changeSheet = function(selSheetID,selPeriod,selSheetName,file_path){
      //ì¢Œì¸¡ ì»¨íŠ¸ë¡¤
      if(document.getElementById(selectedSheetID)){
        document.getElementById(selectedSheetID).setAttribute('class',"nav-link thumb")
      }
      if(document.getElementById(selSheetID)){
        document.getElementById(selSheetID).setAttribute('class',"nav-link thumb active")
      }
      file_path = decodeURIComponent(file_path);
      let iframe = document.getElementById("singoseoPDFIframe");
      if (iframe) {
          iframe.src = file_path;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
      } else {
        iframe.innerHTML = "ì›ì²œì„¸ ì‹ ê³ ì„œê°€ ë°”ë¥´ê²Œ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }    
      //selectedSheetID = selSheetID;
      selectedPeriod = selPeriod;
      selectedSheetName = selSheetName;
    }

    // í•˜ë‹¨ ì¹´í†¡&ë©”ì¼ ë³´ë‚´ê¸°
    window.sendMailAndKakao = async function(seq_no, biz_name, work_YY, work_MM, mail_class)  {
      const objectUrl = "{% url 'sendMail' %}";
      const objectUrl_kakao = "{% url 'send_kakao_notification' %}";
      const user_path = `static/cert_DS/${biz_name}/${work_YY}/ì¸ê±´ë¹„`;
      
      var targetUrl = '';
      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      let allIsGood = true;

      targetUrl = 'admin/mail/payroll.html';

      let strMM = `${work_MM}ì›”`;
      var user_file_names = await getFiles( biz_name, work_YY, work_MM);
      console.log("ğŸ“‚ íŒŒì¼ ëª©ë¡2:",user_file_names)
      if (!user_file_names) {
        allIsGood = false;
        alert(`íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${user_file_names}`);
      }   

      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      if (allIsGood) {
        sendMail(seq_no, work_YY, work_MM, mail_class, objectUrl, targetUrl,user_file_names, user_path);
        sendKakao(seq_no, work_YY, work_MM, mail_class, objectUrl_kakao);
      } else {
        console.warn("ë©”ì¼ê³¼ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì†¡ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    };

    var store = Ext.create('Ext.data.Store', {
        storeId: 'memberStore_' + Math.random(),
        autoLoad: true, // Storeê°€ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¡œë“œ
        proxy: {
            type: 'ajax', // Ajaxë¥¼ í†µí•´ ì„œë²„ì™€ í†µì‹ 
            url: '{% url "mng_payroll" %}', // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
            extraParams: {
                flag: flag, // ì „ë‹¬í•  íŒŒë¼ë¯¸í„°
                ADID:ADID,
                work_YY:work_YY,
                work_MM:work_MM
            },        
            reader: {
                type: 'json', // ì„œë²„ì—ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
                rootProperty: 'data', // ì‘ë‹µ JSONì—ì„œ ë°ì´í„° ë°°ì—´ì˜ ì†ì„± ì´ë¦„
                totalProperty: 'total', // ì‘ë‹µ JSONì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì†ì„± ì´ë¦„
            },
        },   
        sorters: {property: 'biz_name', direction: 'ASC'},
        fields: [ // í•„ë“œ ì •ì˜ (ë°ì´í„°ì˜ ê° ì—´)
          {name: 'groupManager',type: 'string'},
          {name: 'seq_no', type: 'int' },
          {name: 'biz_name', type: 'string'},
          {name: 'seq_no'},
          {name: 'goyoung_jungkyu',type: 'string'},
          {name: 'goyoung_ilyoung', type: 'string'},
          {name: 'goyoung_sayoup', type: 'string'},
          {name: 'goyoung_banki',type: 'string'},
          {name: 'YN_11', type: 'bool'},
          {name: 'YN_12',type: 'bool'},
          {name: 'YN_13',type: 'bool'},
          {name: 'YN_14',type: 'bool'},
          {name: 'ediid',type: 'number'},
          {name: 'edipw',type: 'string'},
          {name: 'fileExist',type: 'string'},
          {name: 'mail_date',type: 'string'},
          {name: 'isIssue',type: 'string'},
          {name: 'ElecFile',type: 'string'},
          {name: 'issuedID',type: 'string'}
        ],
        ... (ADID === "ì „ì²´" ? { groupField: 'groupManager' } : {}) // âœ… ADIDê°€ "ì „ì²´"ì¼ ë•Œë§Œ groupField ì¶”ê°€
    });
    var comboDataStore = Ext.create('Ext.data.Store', {
        fields: ['id', 'name'],
        data: [] // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì›Œë‘ 
    });

    var checkboxRender =function(value) { 
      return "<input type='checkbox'" + (value ? "checked='checked'" : "") + ">"; 
    };

    function onItemClickHandler(item) {
        ADID = item;
        const data = { flag: flag, ADID: item, work_YY: work_YY, work_MM: work_MM };
        
        var targetComponent = mainGrid ? mainGrid.body : Ext.getBody();
        var loadMask = new Ext.LoadMask({ msg: 'ì¡°íšŒì¤‘...', target: targetComponent });
        loadMask.show();

        Ext.Ajax.request({
            url: '{% url "mng_payroll" %}',
            method: 'GET',
            params: data,
            success: function(response) {
                try {
                    store.loadData(Ext.decode(response.responseText));
                    if (item == "ì „ì²´") store.reload();
                } catch(e) {} finally { loadMask.hide(); }
            },
            failure: function() { loadMask.hide(); }
        });
        updateScrollMenuText(item);        
    }    
    if (isSuperuser){
        Ext.Ajax.request({
            url: '{% url "kijang_admin_combolist" %}', // ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
            method: 'GET',
            success: function (response) {
                const data = Ext.decode(response.responseText); // ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±
                comboDataStore.loadData(data); // storeì— ë°ì´í„° ë¡œë“œ
            },
            failure: function () {
                Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
    // Docked Items Config ìƒì„±
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);    

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: { edit: function(editor, e){
				var record = e.record;
				Ext.Ajax.request({
          url: "{% url 'mem_deal_update' %}",
          method: "POST",
					params: {
						seq_no		: record.get('seq_no'),
						field		: e.field,
						val				: e.value,
            csrfmiddlewaretoken: "{{ csrf_token }}"
					},
					success: function(response){
          },
          failure: function (response) {
            Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : " + response.message, "error");
          }
				});
			}}
    });

    mainGrid = Ext.create('Ext.grid.Panel', {
      id: 'mainGrid',
      renderTo: renderTarget,
      title: '{{ gridTitle }}',
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      tools: [  //ìµœìƒë‹¨ ì˜¤ë¥¸ìª½ íˆ´ë°”
          {
            xtype: 'button',
            text: 'ì ‘ìˆ˜ë²ˆí˜¸ì €ì¥',
            iconCls: 'fa fa-floppy-o',
            handler: function (btn) {
              Ext.create('Ext.window.Window', {
                title: 'ë°ì´í„° ë¶™ì—¬ë„£ê¸°',
                modal: true,
                frame:false,
                width: 800,
                height: 200,
                layout: 'fit',
                items: [{
                    xtype: 'textarea',
                    name: 'clipboardData',
                    emptyText: 'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'
                }],
                buttons: [
                  {
                    text: 'ì €ì¥',
                    handler: function(btn) {
                        var win = btn.up('window');
                        var clipboardData = win.down('textarea').getValue();
                        Ext.Ajax.request({
                          url: "{% url 'save_clipboard_Pay' %}",
                          method: 'POST',
                          params: {
                              clipboardData: clipboardData,
                              csrfmiddlewaretoken: "{{ csrf_token }}"
                          },
                          success: function(response) {
                            win.close();
                            Swal.fire({
                              title: 'ì‘ì—… ì„±ê³µ',
                              text: 'ì „ìì‹ ê³ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                              icon: 'success',
                              //timer: 500,  // Set the timer to 3 seconds (3000 ms)
                              showConfirmButton: true,  // Hide the confirm button
                              willClose: () => {
                                let store = Ext.getCmp('mainGrid').getStore();
                                Ext.each(response.sqnos, function (item) {
                                    let record = store.findRecord('seq_no', item.seq_no);
                                    if (record) {
                                        record.set('isIssue', "ğŸ’™"); // userIDì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                    }
                                });
                                store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                              }
                            });                              
                          },
                          failure: function(response) {
                            Swal.fire("ì˜¤ë¥˜", "ì €ì¥ì˜¤ë¥˜ : " + response.message, "error");
                          }
                        });
                        win.close();
                    }
                  },
                  {
                    text: 'ì·¨ì†Œ',
                    handler: function(btn) {
                        btn.up('window').close();
                    }
                  }]
              }).show();
            },
            style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },      
          {
            xtype: 'button',
            text: 'ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œ',
            iconCls: 'fa fa-cloud-upload',
            handler: function () {
              let uploadWindow = Ext.create('Ext.window.Window', {
                    title: 'íŒŒì¼ ì—…ë¡œë“œ',
                    modal: true,
                    layout: 'fit',
                    items: [{
                        xtype: 'form',
                        bodyPadding: 10,
                        fileUpload: true,
                        items: [{
                            xtype: 'filefield',
                            name: 'uploadFile',
                            fieldLabel: 'íŒŒì¼ ì„ íƒ',
                            labelWidth: 70,
                            msgTarget: 'side',
                            allowBlank: false,
                            anchor: '100%',
                            buttonText: 'íŒŒì¼ ì°¾ê¸°...'
                        }],
                        buttons: [{
                            text: 'ì—…ë¡œë“œ',
                            handler: function (btn) {
                                var form = btn.up('form').getForm();
                                if (form.isValid()) {
                                    form.submit({
                                        url: "{% url 'save_elecfile_Pay' %}", // Django ì—…ë¡œë“œ URL
                                        params: {
                                            csrfmiddlewaretoken: "{{ csrf_token }}"
                                        },
                                        waitMsg: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...',
                                        success: function (form, action) {
                                            Ext.Msg.alert('ì„±ê³µ', 'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                            let store = Ext.getCmp('mainGrid').getStore();
                                            let response = action.result;
                                            Ext.each(response.sqnos, function (item) {
                                                let record = store.findRecord('seq_no', item.seq_no);
                                                if (record) {
                                                    record.set('issuedID', item.userID.slice(-2)); // userIDì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                                }
                                            });
                                            store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                                            uploadWindow.close();
                                        },
                                        failure: function (form, action) {
                                            Ext.Msg.alert('ì‹¤íŒ¨', 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                        }
                                    });
                                }
                            }
                        }]
                    }]
                }).show();
            },
            style: 'margin-right: 10px;'
          },{                
              xtype: 'textfield',
              emptyText: 'ê²€ìƒ‰ì–´ ì…ë ¥',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // ê·¸ë¦¬ë“œì˜ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // í•„í„° ì œê±°
                      } else {
                          store.clearFilter(true); // ê¸°ì¡´ í•„í„° ì œê±°
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              return (
                                  bizName.includes(searchValue) 
                              );
                          });
                      }
                  }
              }
          },
          {
              xtype: 'button',
              iconCls: 'icon icon-refresh',
              handler: function (btn) {
                  location.reload();
              },
              style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },
      ],            
      width:'100%',
      height: getGridHeight(), 
      scrollable: 'y', // ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
      store: store,
      columnLines: true,
      ... (ADID === "ì „ì²´" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}),        
      plugins: [cellEditing],
      columns: [
          {   xtype: 'rownumberer',width: 30,	sortable: false}, 
          {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0},  
          {   header: 'SEQ', dataIndex: 'seq_no',width: 50            }, 
          {   id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',  width: 200,renderer: renderTopic}, 
          {  header: '<center>ì •ê·œ</center>', dataIndex: 'goyoung_jungkyu',  width: 40,align:'center'  ,
              renderer: function (value) {
                  if (value === 'Y') {
                      return '<i class="fa fa-circle" style="color: green;"></i>';
                  } else {
                      return '<i class="icon icon-close" style="color: red;"></i>';
                  }
              }  
          }, 
          {  header: '<center>ì¼ìš©<br>ë³€ê²½</center>', dataIndex: 'goyoung_ilyoung',  width: 40,align:'center' ,
              renderer: function (value) {
                  if (value === 'Y') {
                      return '<i class="fa fa-circle" style="color: green;"></i>';
                  } else {
                      return '<i class="icon icon-close" style="color: red;"></i>';
                  }
              }  
          }, 
          {  header: '<center>ì‚¬ì—…<br>ë³€ê²½</center>', dataIndex: 'goyoung_sayoup',  width: 40,align:'center',
              renderer: function (value) {
                  if (value === 'Y') {
                      return '<i class="fa fa-circle" style="color: green;"></i>';
                  } else {
                      return '<i class="icon icon-close" style="color: red;"></i>';
                  }
              }            
          }, 
          {  header: '<center>ë°˜ê¸°</center>', dataIndex: 'goyoung_banki',  width: 40,align:'center',
              renderer: function (value) {
                  if (value === 'Y') {
                      return '<i class="fa fa-circle" style="color: green;"></i>';
                  } else {
                      return '<i class="icon icon-close" style="color: red;"></i>';
                  }
              }            
          }, 
          { header: '<center>ê¸‰ì—¬<br>ë³€ê²½</center>', dataIndex: 'YN_11',   xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
            listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'10',work_YY,work_MM,checked);	}}
          }, {
            header: '<center>ì‚¬ì—…<br>ë³€ê²½</center>', dataIndex: 'YN_12',  xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
            listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'11',work_YY,work_MM,checked);	}}
          }, {
            header: '<center>ì¼ìš©<br>ë³€ê²½</center>', dataIndex: 'YN_13',  xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
            listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'12',work_YY,work_MM,checked);	}}
          }, {
            header: '<center>í™•ì •<br>ì™„ë£Œ</center>', dataIndex: 'YN_14',  xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
            listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'13',work_YY,work_MM,checked);	}}
          }, 
          {  header: '<center>ê¸‰ì—¬ì¼</center>', dataIndex: 'ediid',  width: 60, align:'center',editor: { allowBlank: true } }, 
          {  header: '<center>ì£¼ì˜ì‚¬í•­</center>', dataIndex: 'edipw', flex:1, align:'center',editor: { allowBlank: true }  }, 
          {  header: '<center>ì‹ ê³ <br>íŒŒì¼</center>', dataIndex: 'fileExist', width: 40, align:'center',renderer: value => value === "1" ? "ğŸ“©" : "" }, 
          {  header: '<center>ì „ì†¡ì‹œê°„</center>', dataIndex: 'mail_date',  width: 160, align:'center'  }, 
          {  header: '<center>ì „ì<br>ì‹ ê³ </center>', dataIndex: 'isIssue',  width: 40, align:'center',renderer: value => value ? "ğŸ’™" : ""    }, 
          {  header: '<center>ì ‘ìˆ˜<br>ID</center>', dataIndex: 'issuedID',  width: 40, align:'center' ,
              renderer: function(value) {
                // ê°’ì´ ì¡´ì¬í•˜ë©´ ëì—ì„œ ë‘ ìë¦¬ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.
                if (value && value.length >= 2) {
                    return value.slice(-2);
                }
                return value;
              }
          }
      ],                       
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
          items: [
            ...dockedItemsConfig,
            {
                xtype: 'buttongroup', columns: 5, frame: false,
                defaults: { enableToggle: true, toggleGroup: 'yearGroup', margin: '0 5 0 0', style: { border: '1px solid #ccc', padding: '5px 6px', borderRadius: '5px' } },
                items: Array.from({ length: 5 }, (_, i) => ({
                  text: `${currentYear - i}ë…„`,
                  pressed: currentYear - i === parseInt(work_YY, 10),
                  handler: function () {
                    var grid = this.up('grid');
                    work_YY = parseInt(this.text.replace('ë…„', ''));
                    grid.getStore().getProxy().extraParams.work_YY = work_YY;
                    grid.getStore().reload();
                  }
                }))
            }
          ]
        },
        {
          xtype: 'buttongroup', columns: 12,
          defaults: { 
            enableToggle: true, toggleGroup: 'monthGroup', margin: '0 5 0 0', 
            style: { border: '1px solid #ccc', padding: '5px 6px', borderRadius: '5px' } 
          },
          items: Array.from({ length: 12 }, (_, i) => ({
              text: `${i + 1}ì›”`,
              pressed: i + 1 === parseInt(work_MM, 10),
              handler: function () {
                var grid = this.up('grid'); // gridpanel ì°¾ê¸°
                work_MM = parseInt(this.text.replace('ì›”', ''));
                // ê·¸ë¦¬ë“œ ìŠ¤í† ì–´ ë¦¬ë¡œë“œ
                var store = grid.getStore();
                store.getProxy().extraParams.work_MM = work_MM;
                store.reload();
              }
          })),
          style: { background: '#fff', border: '1px solid #ccc', padding: '6px' }
        }
      ],
   
    });
    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }
    // â˜… [ì¶”ê°€] ë¸Œë¼ìš°ì € í¬ê¸°ë¥¼ ì¡°ì ˆí•  ë•Œ ê·¸ë¦¬ë“œ ë†’ì´ë„ ê°™ì´ ì¡°ì ˆ
    $(window).on('resize', function() {
      if (mainGrid && !mainGrid.isDestroyed) {
        mainGrid.setHeight(getGridHeight());
        mainGrid.doLayout(); // ë ˆì´ì•„ì›ƒ ê°•ì œ ê°±ì‹ 
      }
    }); 

    const setSelectedFolder = async(strFolder) => {
      var innerHtml=""
      var tmpArr = strFolder.split(">>")
      for(var i=0;i<tmpArr.length;i++){
        if(i<(tmpArr.length-1)){
          innerHtml += "<li class='breadcrumb-item'>"+tmpArr[i]+"</li>"
        }else{
          innerHtml += "<li class='breadcrumb-item'><a href='javascript:void(0);'>"+tmpArr[i]+"</a></li>"
        }
      }
      $('[id="payrollYear"]').html(innerHtml);
    }
    const treeLoad = async (seq_no, biz_name, work_YY) => {
      $('#accordionLeft').empty();
      $.ajax({
        url:"{% url 'path_to_pay' %}",
        data:{
          path:`static/cert_DS/${biz_name}/${work_YY}/ì¸ê±´ë¹„`
        },
        dataType:"Json",
        method: "POST",
        success:async function(data){
          var Titles=data.titles;
          var gridFile=data.nodes;

          for(var s=0;s<Titles.length;s++){
            const divcard = document.createElement("div")
            divcard.setAttribute("class","card overflow-hidden mb-2 border-0")
            divcard.setAttribute("id","collapseHead"+s)
            const anchor1 = document.createElement('a');
            anchor1.setAttribute("class","accordion-toggle panel-heading1 collapsed ")
            anchor1.setAttribute("data-bs-toggle","collapse")
            // anchor1.setAttribute("data-bs-parent","#accordionAcnt")
            anchor1.setAttribute("aria-expanded","false")
            anchor1.href="#collapse"+s     
            anchor1.innerText = Titles[s].displayName
            divcard.appendChild(anchor1)
            const divTabpanel = document.createElement("div")
            if(s==(Titles.length-1)){
              divTabpanel.setAttribute("class","panel-collapse collapse show")
              selectedSheetID = gridFile[gridFile.length-1].id
              selectedPeriod = Titles[s].displayName
            } else {
              divTabpanel.setAttribute("class","panel-collapse collapse")
            }
            divTabpanel.setAttribute("id","collapse"+s)
            divTabpanel.setAttribute("role","tabpanel")
            divTabpanel.setAttribute("aria-expanded","false")
            divTabpanel.setAttribute("data-bs-parent","#accordionAcnt")
            divcard.appendChild(divTabpanel) 

            const ul = document.createElement('ul');                  
            ul.setAttribute("class","nav1 nav-column flex-column br-7")
            ul.setAttribute("id","singoList"+s)
            divTabpanel.appendChild(ul)
            singoListDetail(ul,Titles[s].displayName,gridFile,Titles[s].displayName,selectedSheetID)
              
            document.getElementById('accordionLeft').appendChild(divcard);
            setSelectedFolder("{{payrollYear}}ë…„  >> "+selectedPeriod);
          }
        },
        error:function(request,status,error){
          console.log('fail:'+error);
        }
      })
    };

    const singoListDetail = async(ul,selGroup,gridFile,singoPeriod,selSheetID)=>{
      return new Promise((resolve,reject)=>{
        var tmpHTML="";

        for(var i=0;i<gridFile.length;i++){
          var activate="";
          if(gridFile[i].id==selSheetID){
            selectedSheetName = gridFile[i].íŒŒì¼ëª…
            activate = "active"
          }
          if(gridFile[i].group==selGroup){
            const li = document.createElement("li");
            li.setAttribute('id',"li"+gridFile[i].id);
            li.setAttribute('class',"nav-item1 mt-0")

            const anchor2 = document.createElement('a');
            anchor2.href = "javascript:changeSheet('"+gridFile[i].id+"','"+singoPeriod+"','"+gridFile[i].íŒŒì¼ëª…+"','"+gridFile[i].totalPath+"')";
            anchor2.setAttribute('class',"nav-link thumb " +activate)
            anchor2.setAttribute('id',gridFile[i].id);

            const designI = document.createElement('i');
            designI.setAttribute('class',"fa fa-window-restore")
            if(gridFile[i].íŒŒì¼ëª….indexOf("ë‚©ë¶€")!=-1||gridFile[i].íŒŒì¼ëª….indexOf("ì†Œë“ì„¸")!=-1||gridFile[i].íŒŒì¼ëª….indexOf("ì§€ë°©ì„¸")!=-1||gridFile[i].íŒŒì¼ëª….indexOf("ì£¼ë¯¼ì„¸")!=-1){
              anchor2.innerHTML = "<span class='badge badge-sm bg-danger badge-hide me-4'>ë‚©ê¸°:"+gridFile[i].dueDate+"</span>" + gridFile[i].íŒŒì¼ëª…
            }else if(gridFile[i].íŒŒì¼ëª….indexOf("ëŒ€ì¥")!=-1 || gridFile[i].íŒŒì¼ëª….indexOf("ëª…ì„¸")!=-1){
              anchor2.innerHTML = "<i class='fa fa-address-book text-success me-2'></i>" + gridFile[i].íŒŒì¼ëª…
            }else if(gridFile[i].íŒŒì¼ëª….indexOf("ì‹ ê³ ì„œ")!=-1){
              anchor2.innerHTML = "<i class='ion ion-grid text-info '></i>" + gridFile[i].íŒŒì¼ëª… + "<i class='ion ion-grid text-info ms-2'></i>"
            }else{
              anchor2.innerHTML = gridFile[i].íŒŒì¼ëª…
            }
            li.appendChild(anchor2);  
            ul.appendChild(li);
            if(gridFile[i].id==selectedSheetID){
              changeSheet(selSheetID,singoPeriod,selectedSheetName,gridFile[i].totalPath)
            }
          }
        }
      })
    }

    //############# ì•ˆë‚´ ì¹´í†¡ë‚´ìš© ìƒì„±
    // ì ‘ìˆ˜ê²°ê³¼ ê¸°ë³¸ì€ false, ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œì‹œ true
    let resultAndFee = false;

    const setMailContent = async (seq_no, work_YY, work_MM, flag) => {
      $.ajax({
        url: "{% url 'getMailContent' %}",
        type: "POST",
        data: {
          seq_no: seq_no,
          work_YY: work_YY,
          work_MM: work_MM,
          flag:flag,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        dataType: "json",
        success: function (data) {

          var contentId = "introMailContent";
          var headSubject = "ê¸‰ì—¬ëŒ€ì¥ ë° ì›ì²œì„¸ ì‹ ê³ ë‚©ë¶€ ì•ˆë‚´"
          var bodyContent = `<div class="email-body mt-5">${data.email_content}</div>`
          let staticUrl = "https://daeseungtax.co.kr/static/assets/images/faces/";
          let tmpHTML = `
            <div class="card">
              <div class="card-header border-bottom">
                <h4 class="card-title fw-bold" id = "Subject">[${data.recordset_adminInfo.TXT_CorpName}] ${work_YY}ë…„ ${work_MM}ì›” ê·€ì† ${headSubject} - ${data.recordset_member.biz_name}</h4>
              </div>
              <div class="card-body">
                <div class="email-media">
                  <div class="mt-0 d-sm-flex">
                    <img class="me-2 rounded-circle avatar-xl" src="${staticUrl}${ data.recordset_adminInfo.admin_name }.png" alt="avatar">
                    <div class="media-body">
                      <div class="media-title fw-bold mt-0">ì—…ë¬´ë‹´ë‹¹ì ${data.recordset_adminInfo.admin_name} <span class="tx-13 fw-semibold">(<i class="fe fe-phone-call"></i> ${data.recordset_adminInfo.admin_tel_no} )</span></div>
                      <p class="mb-0"> <span class="text-muted">ì±…ì„ì„¸ë¬´ì‚¬ ${data.recordset_adminInfo.TXT_DutyCTA} (<i class="fe fe-smartphone"></i> ${data.recordset_adminInfo.TXT_DutyCTAHP} )</span> </p>
                      <p class="mb-0"> <span class="text-muted">${data.recordset_adminInfo.TXT_OfficeAddress} </span> </p>
                    </div>
                  </div>
                </div>
                <!-- ì´ë©”ì¼ ë³¸ë¬¸ -->
                ${bodyContent}
              </div>
            </div>
          `;
          
          $('[id="' + contentId + '"]').html(tmpHTML);
        },
        error: function (request, status, error) {
          console.log('fail: ' + error);
        }
      });
    };

    function getFiles(biz_name, work_YY, work_MM) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '{% url "get_folder_files" %}',
                type: "GET",
                data: {
                    biz_name: biz_name,
                    work_YY: work_YY,
                    work_MM: work_MM
                },
                dataType: "json",
                success: function(response) {
                    resolve(response.files);  // âœ… AJAXê°€ ì™„ë£Œë˜ë©´ `resolve()` í˜¸ì¶œ
                },
                error: function(xhr, status, error) {
                    console.error("âŒ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", xhr.responseText);
                    reject(error);  // âœ… ì˜¤ë¥˜ ë°œìƒ ì‹œ `reject()` í˜¸ì¶œ
                }
            });
        });
    }

    //ì ‘ìˆ˜ì¦ ë§ˆìš°ìŠ¤ í´ë¦­ì‹œ íˆ´íŒë°œìƒ
    function attachGridToolTip_JupsuSummit(grid,work_YY){
      Ext.create('Ext.tip.ToolTip', {
          target: grid.getEl(),
          delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
          trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
          dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
          autoHide: true, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
          maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
          minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
          anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
          mouseOffset: [-350, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
          renderTo: Ext.getBody(),
          listeners: {
            beforeshow: function (tip) {
              const cell = Ext.get(tip.triggerElement);
              const record = grid.getView().getRecord(cell.parent());
              const columnIndex = cell.dom.cellIndex;
              const column = grid.headerCt.getHeaderAtIndex(columnIndex);
            
              if (column.dataIndex === 'isIssue') {
                const seqNo = record.get('seq_no');
                Ext.Ajax.request({
                    url: '{% url "mng_corp_jupsuSummit" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                    method: 'POST',
                    params: {
                      seq_no:seqNo,
                      work_YY:work_YY,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                    }, 
                    success: function (response) {
                        const data = Ext.decode(response.responseText);
                        tip.update(`
                    <div class="notifications-menu ps3 overflow-hidden">
                        <div class="drop-heading border-bottom position-relative">
                            <div class="d-flex">
                                <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mt-1 mb-0 fs-15 text-dark">ë²•ì¸ì„¸ ì „ìì‹ ê³  ì ‘ìˆ˜ì¦</h6>
                                    <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                                </div>
                            </div>
                            <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">${data.ì‹ ê³ ì„œì¢…ë¥˜}</span>
                                </div>
                            </div>                                                                                    
                        </div>                                                                                    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">íšŒê³„ê¸°ê°„ ì¢…ë£Œì›” ${data.ê³¼ì„¸ë…„ì›”}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>      
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ìœ í˜• : ${data.ì‹ ê³ ìœ í˜•}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                                                                                              
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ë²ˆí˜¸</span>
                                  <span class="notification-label ">${data.ì‹ ê³ ë²ˆí˜¸}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ì‹œê° ${data.ì‹ ê³ ì‹œê°}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                          
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì ‘ìˆ˜ID ${data.ì‚¬ìš©ìID}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                              
                    </div>
                        `);
                          // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                          Ext.defer(() => {
                              const closeButton = document.getElementById("tooltipCloseBtn");
                              if (closeButton) {
                                  closeButton.addEventListener("click", function () {
                                      tip.hide();
                                  });
                              }
                          }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                    },
                    failure: function () {
                        tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                    }
                });
              } else {
                  return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
              }
            }
          }
      });  
    }
    //ë¬¸ìë°œì†¡ ëª¨ë‹¬ì—´ê¸° - ê° í˜ì´ì§€ì— êµ¬í˜„í•´ì•¼í•´...
    function smsModal (seq_no, hp_no)  {
      $("#smsModal").modal('show');
    };
})();
  </script>
