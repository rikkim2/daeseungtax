{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }

    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table {
        width: auto !important;
        margin: 0 !important;
    }

    /* ê·¸ë¦¬ë“œ ë˜í¼ */
    .ext-grid-wrapper {
        width: 100%;
        /* ë†’ì´ëŠ” JSì—ì„œ ì„¤ì • */
    }

/* [ë””ìì¸ ìˆ˜ì •] í† ê¸€ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ì„ íƒ ì•ˆë¨) */
    .custom-toggle-btn {
        border-color: #d1d5db !important;
        background-image: none !important;
        background-color: #ffffff !important;
        color: #4b5563 !important;
        border-radius: 4px !important;
        box-shadow: none !important;
    }

    /* [ë””ìì¸ ìˆ˜ì •] í† ê¸€ ë²„íŠ¼ ì„ íƒë¨ (Pressed) */
    .custom-toggle-btn.x-btn-pressed {
        background-color: #667eea !important; /* í…Œë§ˆ ìƒ‰ìƒ (ë³´ë¼/ë¸”ë£¨) */
        border-color: #667eea !important;
        color: #ffffff !important;
        font-weight: bold !important;
    }

    /* [ë””ìì¸ ìˆ˜ì •] ë§ˆìš°ìŠ¤ í˜¸ë²„ íš¨ê³¼ */
    .custom-toggle-btn:hover:not(.x-btn-pressed) {
        background-color: #f3f4f6 !important;
        border-color: #9ca3af !important;
        color: #111827 !important;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ì¡°ì • */
    .custom-btn-group .x-btn-group-body {
        padding: 2px !important;
    }

/* [ì¶”ê°€] í•´ê³¨(ì˜¤ë¥˜) ë°œìƒ ì‹œ ë…¸ë€ìƒ‰ ë°°ê²½ */
    .row-yellow-warning .x-grid-cell {
        background-color: #ffffcc !important; /* ì—°í•œ ë…¸ë€ìƒ‰ */
    }
</style>

<div class="ext-grid-wrapper"></div>
<script>
(function () {
  var mainGrid, mainStore;
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');

  // ê·¼ë¡œì†Œë“ì€ ë°˜ê¸° ê¸°ì¤€ì´ë¯€ë¡œ work_YYì™€ work_banki ì‚¬ìš©
  var work_YY = '{{ request.session.workyearPay }}';
  var work_banki = '';  // Jan(ìƒë°˜ê¸°) / Jul(í•˜ë°˜ê¸°)

  // ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì„¤ì •
  if(!work_YY) work_YY = new Date().getFullYear();

  // í˜„ì¬ ì›” ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ ë°˜ê¸° ì„¤ì •
  var currentMonth = new Date().getMonth() + 1;
  if (currentMonth > 1 && currentMonth < 8) {
    work_banki = 'Jan';  // ìƒë°˜ê¸°
  } else {
    work_banki = 'Jul';  // í•˜ë°˜ê¸°
  }

  const currentYear = new Date().getFullYear();

  // 1. renderTopic
  window.renderTopic = function(value, p, record) {
      return Ext.String.format(
          `<div style="cursor:pointer; color:blue;"
              onclick="window.summitModal(${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, '${work_banki}', 'kaniKunro');">
              ${Ext.String.htmlEncode(value)}
          </div>`
      );
  };

  window.summitModal = async function(seq_no, biz_name, wYY, wBanki, flag) {
    // íŒì—… ë¡œì§ (í•„ìš”ì‹œ êµ¬í˜„)
  };

  function findRenderTarget() {
    // 1) ì „ì²´ì—ì„œ "Ext ì»´í¬ë„ŒíŠ¸ê°€ ì—†ëŠ” ë˜í¼" ì°¾ê¸°
    var el = $('.ext-grid-wrapper').filter(function () {
      return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
    }).last()[0];

    // 2) ì—†ìœ¼ë©´ í™œì„± íƒ­ì—ì„œ ë‹¤ì‹œ ì°¾ê¸°
    if (!el) {
      el = $('div.tab-pane.active .ext-grid-wrapper').filter(function () {
        return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
      }).last()[0];
    }
    return el || null;
  }

  function syncParamsAndReload() {
    var store = mainGrid.getStore();
    var proxy = store.getProxy();

    proxy.extraParams = proxy.extraParams || {};
    proxy.extraParams.input_workyear = work_YY;
    proxy.extraParams.work_banki = work_banki;
    proxy.extraParams.ADID = ADID;
    proxy.extraParams.flag = flag;

    console.log('ğŸ”„ Reloading store with params:', proxy.extraParams);

    store.reload({
      callback: function () {
        if (ADID === "ì „ì²´") {
            store.group({ property: 'groupManager', direction: 'ASC' });
            store.sort([
                { property: 'groupManager', direction: 'ASC' },
                { property: 'biz_name', direction: 'ASC' }
            ]);
        } else {
            store.clearGrouping();
        }
      }
    });
  }

  function buildGrid() {
    if (mainGrid) return;

    var renderTarget = findRenderTarget();
    if (!renderTarget) return;

    // ë†’ì´ê°€ 0ì´ë©´ ìµœì†Œ ë†’ì´ ë¶€ì—¬
    if (renderTarget.clientHeight < 50) {
      renderTarget.style.minHeight = '600px';
    }

    Ext.define('Plant', {
      extend: 'Ext.data.Model',
      fields: [
        {name: 'groupManager',type: 'string', convert: function(v){ return (v || '').trim(); }},
        {name: 'seq_no'},
        {name: 'biz_name', type: 'string'},
        {name: 'biz_type', type: 'string'},
        {name: 'wh_Kunro',type: 'float', convert: function(v){ return parseFloat(v) || 0; }},
        { name: 'isKun', type: 'string' },
        { name: 'isKunAmt', type: 'float', convert: function(v){ return parseFloat(v) || 0; } },
        { name: 'YN_9', type: 'string' },
        { name: 'isSkele', type: 'string' },
        { name: 'issuedID', type: 'string' }
      ]
    });

    mainStore = Ext.create('Ext.data.Store', {
      model: 'Plant',
      groupField: (ADID === "ì „ì²´" ? 'groupManager' : null),
      grouper: { property: 'groupManager', direction: 'ASC' },
      sorters: [
        {property: 'groupManager', direction: 'ASC'},
        {property: 'biz_name', direction: 'ASC'}
      ],
      proxy: {
        type: 'ajax',
        url: "{% url 'api_kani_kunro_list' %}",
        reader: {
          type: 'json',
          root: 'rows',
          successProperty: 'ok'
        }
      },
      autoLoad: false,
      listeners: {
        load: function(store, records, successful, operation) {
          var response = operation && operation.response ? operation.response : null;
          if (!successful) {
            console.error('Load failed. Response:', response ? response.responseText : 'No response');
            Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          } else {
            console.log('Load successful! Records:', records.length);
          }
        }
      }
    });

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
        edit: function (editor, e) {
          Ext.Ajax.request({
            url: "{% url 'api_kani_kunro_update' %}",
            method: "POST",
            params: {
              seq_no: e.record.get('seq_no'),
              work_yy: work_YY,
              work_banki: work_banki,
              txt_bigo: e.record.get('YN_9')
            },
            failure: function () {
              e.record.set('YN_9', e.originalValue);
              Ext.Msg.alert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨");
            }
          });
        }
      }
    });

    // Docked Items Config ìƒì„±
    function onItemClickHandler(item) {
      ADID = item;
      syncParamsAndReload();
      updateScrollMenuText(item);
    }
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);

    function renderFlagEmoji(v, meta, rec) {
      var colIndex = meta.column.dataIndex;
      if (colIndex === 'isKun') {
        var whAmt = rec.get('wh_Kunro') || 0;
        var payAmt = rec.get('isKunAmt') || 0;
        if (whAmt === 0 && payAmt === 0) return "";
        return (whAmt === payAmt) ? "âœ…" : "";
      }
      return "";
    }

    function renderSkeletonEmoji(v, meta, rec){
      var wh = rec.get('wh_Kunro') || 0;
      var kunAmt = rec.get('isKunAmt') || 0;
      if (wh === 0 && kunAmt === 0) return "";
      return wh !== kunAmt ? "ğŸ’€" : "";
    }

    mainGrid = Ext.create('Ext.grid.Panel', {
      id: 'mainGrid',
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      store: mainStore,
      renderTo: renderTarget,
      title: 'ê°„ì´ì§€ê¸‰ëª…ì„¸ì„œ - ê·¼ë¡œì†Œë“',
      width: '100%',
      height: getGridHeight(),
      columnLines: true,
      tools: [  // ìµœìƒë‹¨ ì˜¤ë¥¸ìª½ íˆ´ë°”
          {
            xtype: 'button',
            text: 'ì ‘ìˆ˜ë²ˆí˜¸ì €ì¥',
            iconCls: 'fa fa-floppy-o',
            handler: function (btn) {
              Ext.create('Ext.window.Window', {
                title: 'ë°ì´í„° ë¶™ì—¬ë„£ê¸°',
                modal: true,
                frame: false,
                width: 800,
                height: 200,
                layout: 'fit',
                items: [{
                    xtype: 'textarea',
                    name: 'clipboardData',
                    emptyText: 'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'
                }],
                buttons: [
                  {
                    text: 'ì €ì¥',
                    handler: function(btn) {
                        var win = btn.up('window');
                        var clipboardData = win.down('textarea').getValue();
                        Ext.Ajax.request({
                          url: "{% url 'save_clipboard_Pay' %}",
                          method: 'POST',
                          params: {
                              clipboardData: clipboardData,
                              csrfmiddlewaretoken: "{{ csrf_token }}"
                          },
                          success: function(response) {
                            win.close();
                            Swal.fire({
                              title: 'ì‘ì—… ì„±ê³µ',
                              text: 'ì ‘ìˆ˜ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                              icon: 'success',
                              showConfirmButton: true,
                              willClose: () => {
                                // ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
                                mainStore.reload();
                              }
                            });
                          },
                          failure: function(response) {
                            Swal.fire("ì˜¤ë¥˜", "ì €ì¥ì˜¤ë¥˜ : " + response.message, "error");
                          }
                        });
                    }
                  },
                  {
                    text: 'ì·¨ì†Œ',
                    handler: function(btn) {
                        btn.up('window').close();
                    }
                  }]
              }).show();
            },
            style: 'margin-right: 10px;'
          }
      ],
      viewConfig: {
          getRowClass: function(record, rowIndex, rowParams, store) {
              var isSkele = record.get('isSkele');
              if (isSkele === true || String(isSkele) === 'true') {
                  return 'row-yellow-warning';
              }
              return '';
          }
      },
      features: (ADID === "ì „ì²´"
        ? [{
            id: 'groupManager',
            ftype: 'groupingsummary',
            startCollapsed: false,
            groupHeaderTpl: '{name}',
            hideGroupedHeader: false,
            enableGroupingMenu: true
          }]
        : []),
      plugins: [cellEditing],
      selModel: { selType: 'cellmodel' },
      columns: [
        {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0},
        {  header: 'SEQ', dataIndex: 'seq_no',width: 50        },
        {  id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',width: 200, renderer: renderTopic	},
        { header: '<center>ì›ì²œì§•ìˆ˜<br>ê·¼ë¡œì†Œë“</center>', dataIndex: 'wh_Kunro',  width: 100, xtype: 'numbercolumn', align:'right',format:'0,000' },
        {
          text: 'ì „ìì‹ ê³  ì ‘ìˆ˜ì—¬ë¶€',
          columns: [
            { header:'ê·¼ë¡œ', dataIndex:'isKun', width:50, renderer: renderFlagEmoji},
            { header: '<center>ê·¼ë¡œ<br>ì§€ê¸‰ê¸ˆì•¡</center>',dataIndex: 'isKunAmt',  width: 100,xtype: 'numbercolumn', align:'right',format:'0,000' }
          ]
        },
        { header: '<center>ì°¨ì´ì›ì¸ì„ ê¸°ë¡í•˜ì„¸ìš”</center>', dataIndex: 'YN_9',   flex: 1, editor: { allowBlank: true }	},
        { header:'ì˜¤ë¥˜', dataIndex:'isSkele', width:50, renderer: renderSkeletonEmoji },
        { header:'<center>ì œì¶œ<br>ID</center>', dataIndex:'issuedID', width:50 }
      ],
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          padding: '10 0 5 10',
          style: { background: '#fff', border: 'none' },
          items: [
            ...dockedItemsConfig,
            { xtype: 'tbspacer', width: 20 },
            {
                xtype: 'buttongroup',
                columns: 5,
                frame: false,
                cls: 'custom-btn-group',
                bodyStyle: 'background: transparent;',
                border: false,
                defaults: {
                    enableToggle: true,
                    toggleGroup: 'yearGroup',
                    margin: '0 4 0 0',
                    cls: 'custom-toggle-btn',
                    height: 32,
                    width: 60
                },
                items: Array.from({ length: 5 }, (_, i) => ({
                  text: `${currentYear - i}ë…„`,
                  pressed: currentYear - i === parseInt(work_YY, 10),
                  handler: function (btn) {
                    work_YY = parseInt(this.text.replace('ë…„', ''), 10);
                    // ëª…ì‹œì ìœ¼ë¡œ pressed ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.toggle(true);
                    syncParamsAndReload();
                  }
                }))
            }
          ]
        },
        {
          xtype: 'toolbar',
          dock: 'top',
          padding: '5 0 5 10',
          style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
          items: [
            {
              xtype: 'buttongroup',
              columns: 2,
              frame: false,
              bodyStyle: 'background: transparent;',
              border: false,
              defaults: {
                  enableToggle: true,
                  toggleGroup: 'bankiGroup',
                  margin: '0 4 0 0',
                  cls: 'custom-toggle-btn',
                  height: 32,
                  width: 80
              },
              items: [
                {
                  text: 'ìƒë°˜ê¸°',
                  pressed: work_banki === 'Jan',
                  handler: function () {
                    work_banki = 'Jan';
                    // ëª…ì‹œì ìœ¼ë¡œ pressed ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.toggle(true);
                    syncParamsAndReload();
                  }
                },
                {
                  text: 'í•˜ë°˜ê¸°',
                  pressed: work_banki === 'Jul',
                  handler: function () {
                    work_banki = 'Jul';
                    // ëª…ì‹œì ìœ¼ë¡œ pressed ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.toggle(true);
                    syncParamsAndReload();
                  }
                }
              ]
            }
          ]
        }
      ],
      listeners: {
        afterrender: function(grid) {
             Ext.EventManager.onWindowResize(function() {
                 if(grid && !grid.isDestroyed) {
                     grid.setHeight(getGridHeight());
                     grid.doLayout();
                 }
             });
             setTimeout(function(){ grid.updateLayout(); }, 200);
        }
      }
    });

    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }

    // proxy.extraParams ì´ˆê¸°ê°’ ì„¸íŒ… í›„ ì¡°íšŒ
    var initialParams = {
      input_workyear: work_YY,
      work_banki: work_banki,
      ADID: ADID,
      flag: flag
    };
    mainStore.getProxy().extraParams = initialParams;
    console.log('ğŸ“¡ Initial load with params:', initialParams);

    mainStore.load({
      callback: function (records, operation, success) {
        console.log('Store load callback:', { records: records, success: success, recordCount: records ? records.length : 0 });
        if (success) {
          console.log('Data loaded successfully. Record count:', mainStore.getCount());
          if (ADID === "ì „ì²´") {
              mainStore.group({ property: 'groupManager', direction: 'ASC' });
          }
        } else {
          console.error('Store load failed!', operation);
        }
      }
    });

    // ìƒì„± ì§í›„ ë ˆì´ì•„ì›ƒ 1íšŒ ë³´ì •
    setTimeout(resizeGrid, 0);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getGridHeight() {
      var height = window.innerHeight - 180;
      return height > 300 ? height : 300;
  }

  function resizeGrid() {
    if (!mainGrid) return;
    var wrap = mainGrid.el && mainGrid.el.dom ? mainGrid.el.dom.parentElement : null;
    if (!wrap) return;
    var h = wrap.clientHeight;
    if (h > 50) mainGrid.setHeight(h);
    mainGrid.doLayout();
  }

  Ext.onReady(function () {
    // ìµœì´ˆ active íƒ­ì´ë©´ ë°”ë¡œ ìƒì„±
    buildGrid();

    // íƒ­ ì „í™˜ ì‹œ ìƒì„± + ë¦¬ì‚¬ì´ì¦ˆ
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function (el) {
      el.addEventListener('shown.bs.tab', function () {
        buildGrid();
        resizeGrid();
      });
    });

    window.addEventListener('resize', resizeGrid);
  });
})();

</script>
