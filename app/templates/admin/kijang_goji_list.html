{% load static %}

<style>
    .icon-refresh { color: white; }
    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table { width: auto !important; margin: 0 !important; }
    .ext-grid-wrapper { width: 100%; }
    
    /* ëª¨ë‹¬ í¬ê¸° */
    .modal-xl { max-width: 1140px; }
</style>  

<div class="ext-grid-wrapper"></div>

<div class="modal fade unique-summit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div class="summitModalTitle"></div>
        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <div class="card text-left ps-5 pt-3 pb-3">
          <div class="row">
            <div class="modal_top_desc"></div>
          </div>
        </div>
        <div class="tabs-menu4 modal-tabs-menu"></div>
        <div class="tab-content modal-tab-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
    // 1. ê·¸ë¦¬ë“œ ë³€ìˆ˜ ë¯¸ë¦¬ ì„ ì–¸
    var mainGrid;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [1] DOM ìš”ì†Œ í™•ë³´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var renderTarget = $('.ext-grid-wrapper').filter(function() {
        return $(this).children().length === 0;
    }).last()[0];

    // ë§Œì•½ ëª» ì°¾ìœ¼ë©´ í™œì„± íƒ­ ë‚´ë¶€ì—ì„œ ì¬ì‹œë„
    if (!renderTarget) {
        renderTarget = $('div.tab-pane.active .ext-grid-wrapper')
            .filter(function () { return $(this).children().length === 0; })
            .last()[0];
    }

    if (!renderTarget) {
        console.warn('ë Œë” íƒ€ê²Ÿì´ ì—†ì–´ì„œ ê·¸ë¦¬ë“œë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    // ëª¨ë‹¬ ID ìƒì„± ë° í• ë‹¹
    var $wrapper = $(renderTarget).parent(); 
    var modalUniqueId = 'summitModal_' + Math.floor(Math.random() * 100000);
    var $modal = $wrapper.find('.unique-summit-modal');
    $modal.attr('id', modalUniqueId);

    function findInModal(selector) { return $modal.find(selector); }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getGridHeight() {
        var height = window.innerHeight - 180;
        return height > 300 ? height : 300;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [3] ë³€ìˆ˜ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var adminBizLevel = '{{ admin_biz_level }}'.trim();
    const isSuperuser = '{{ admin_grade }}' === 'SA';
    var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    var work_YY = parseInt('{{ request.session.input_workyear }}', 10);
    var work_MM = parseInt('{{ request.session.work_MM  }}', 10);
    var flag = '{{ request.session.flag  }}';
    
    if(typeof getWorkYearAndMonth === 'function'){
      const workInfo = getWorkYearAndMonth('kijang_goji_list');
      if(!work_YY && workInfo && workInfo.work_YY) work_YY = parseInt(workInfo.work_YY, 10);
      if(!work_MM && workInfo && workInfo.work_MM) work_MM = parseInt(workInfo.work_MM, 10);
    }
    if(!flag) flag = 'goji';

    // ê¸°ë³¸ê°’ì„ í˜„ì¬ë…„/ì›”ë¡œ ë§ì¶° ì—°ë„ ë²„íŠ¼ í‘œì‹œì™€ ì‹¤ì œ ì¡°íšŒê°’ì„ ì¼ì¹˜ì‹œí‚¨ë‹¤.
    if(!work_YY || work_YY < currentYear) work_YY = currentYear;
    if(!work_MM || work_MM < 1 || work_MM > 12) work_MM = currentMonth;
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [4] ì „ì—­ í•¨ìˆ˜ ì •ì˜ (onclick ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. summitModal (ë©”ì¸ ëª¨ë‹¬)
    window.summitModal = async function(seq_no, biz_name, wYY, wMM, flg) {
        let tmpHead = `
            <nav aria-label='breadcrumb'>
            <ol class='breadcrumb breadcrumb-style'>
                <li class='breadcrumb-item'>${biz_name}</li>
                <li class='breadcrumb-item'>${wYY}ë…„</li>
                <li class='breadcrumb-item'>${wMM}ì›”</li>
                <li class='breadcrumb-item active'>ê³ ì§€ì„¸ì•¡ ì•ˆë‚´</li>
            </ol>
            </nav>`;
        findInModal('.summitModalTitle').html(tmpHead);

        let tmpTab = `
            <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-1">ë©”ì¼ë³´ë‚´ê¸°</a>
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-2">ë³´ë‚¸ ë©”ì¼</a>
            </nav>`;
        
        let tmpTab_Content = `
            <div class="tab-pane active task-files-tab" id="task-1">
            <div class="d-flex">
                <div class="flex-grow-1 pe-3" style="flex-basis: 60%;">
                <div class="container" id="mailContent"></div>
                </div>
                <div class="flex-grow-0" style="flex-basis: 40%;">
                <div class="card-body" >
                    <iframe id="kakaoIframe" width="100%" height="600px" frameborder="0"></iframe>
                </div>
                </div>
            </div>              
            <div class="modal-footer justify-content-center" id="btnKakaoSend"></div>
            </div>
            <div class="tab-pane  task-files-tab" id="task-2">
            <div class="table-responsive" style="max-height: 400px; width:100%; overflow-y: auto;">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                        <th>ì œëª©</th>
                        <th>ë°›ëŠ” ì‚¬ëŒ</th>
                        <th>ì°¸ì¡°</th>
                        <th>ë³´ë‚¸ ì‹œê°„</th>
                        <th>ì²¨ë¶€</th>
                        <th>ë‹´ë‹¹ì</th>
                        </tr>
                    </thead>
                    <tbody id="sentMailTable"></tbody>
                </table>
            </div>
            </div>  
        `;

        findInModal('.modal-tabs-menu').html(tmpTab);
        findInModal('.modal-tab-content').html(tmpTab_Content);

        // í•˜ë‹¨ ë²„íŠ¼ ìƒì„±
        let tmpBtn = `<button class="btn btn-info" onclick="window.sendMailAndKakao(${seq_no}, ${wYY}, ${wMM}, '${flg}')">
            <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
            </button> 
            <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
        findInModal('#btnKakaoSend').html(tmpBtn);   

        await setMailContent(seq_no, wYY, wMM, flg);
        await setKKOResult(seq_no, wYY, wMM, flg);  

        $modal.modal('show');
    };

    // AJAX/JQXHR/Promiseë¥¼ ëª¨ë‘ Promiseë¡œ í¡ìˆ˜í•˜ëŠ” í—¬í¼
    function toPromise(ret) {
        if (ret && typeof ret.then === 'function') return ret;
        if (ret && typeof ret.always === 'function') {
            return new Promise((resolve, reject) => ret.done(resolve).fail(reject));
        }
        return Promise.resolve(ret);
    }
    // ë§ˆìŠ¤í¬ê°€ ì‚¬ë¼ì§€ëŠ” ì‹œì ì— ì½œë°±ì„ ì‹¤í–‰(ì—†ìœ¼ë©´ ì¦‰ì‹œ)
    function runAfterUnmask(callback) {
        if (typeof callback !== 'function') return;
        const body = Ext.getBody ? Ext.getBody() : null;
        if (body && typeof body.isMasked === 'function' && body.isMasked()) {
            body.on('unmask', callback, null, { single: true });
        } else {
            callback();
        }
    }

    // 2. sendMailAndKakao
    window.sendMailAndKakao = function(seq_no, wYY, wMM, flg){
        var user_file_names = "";
        var user_path = "";
        const tasks = [];
        // sendMail, sendKakaoëŠ” ExtCommon.js ë“±ì— ì •ì˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
        if(typeof sendMail === 'function') {
            tasks.push(toPromise(sendMail(seq_no, wYY, wMM, flg, "{% url 'sendMail' %}", 'admin/mail/notice_goji.html', user_file_names, user_path)));
        }
        if(typeof sendKakao === 'function') {
            tasks.push(toPromise(sendKakao(seq_no, wYY, wMM, flg, "{% url 'send_kakao_notification' %}")));
        }
        Promise.all(tasks).then(() => {
            if (mainGrid) {
                const store = mainGrid.getStore();
                const targetSeq = String(seq_no);
                const nowText = Ext.Date.format(new Date(), 'Y-m-d H:i');

                // ëŒ€ìƒ ì—…ì²´ëª… í™•ì¸
                let baseRec = store.findRecord('seq_no', targetSeq, 0, false, false, true);
                if (!baseRec) {
                    const idx = store.findBy(r => String(r.get('seq_no')) === targetSeq);
                    baseRec = idx !== -1 ? store.getAt(idx) : null;
                }
                const targetBizName = baseRec ? baseRec.get('biz_name') : null;

                // í˜„ì¬ ìŠ¤í† ì–´ì—ì„œ ë™ì¼ ì—…ì²´ ëª¨ë‘ ë‚™ê´€ì  ì—…ë°ì´íŠ¸
                store.each(function(r) {
                    const sameSeq = String(r.get('seq_no')) === targetSeq;
                    const sameBiz = targetBizName && r.get('biz_name') === targetBizName;
                    if (sameSeq || sameBiz) {
                        r.set('mailDate', nowText);
                        r.commit();
                    }
                });

                // ë§ˆìŠ¤í¬ í•´ì œ ì‹œì ì— ë™ì¼ ì—…ì²´ ëª¨ë‘ í•œ ë²ˆ ë” ë³´ì •(ì „ì²´ ë¦¬ë¡œë“œ ì—†ì´)
                runAfterUnmask(() => {
                    store.each(function(r) {
                        const sameSeq = String(r.get('seq_no')) === targetSeq;
                        const sameBiz = targetBizName && r.get('biz_name') === targetBizName;
                        if (sameSeq || sameBiz) {
                            r.set('mailDate', nowText);
                            r.commit();
                        }
                    });
                });
            }
            if ($modal) $modal.modal('hide');
        }).catch(err => console.error('sendMailAndKakao failed', err));
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [5] ë‚´ë¶€ í—¬í¼ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const setKKOResult = async(seq_no, wYY, wMM, flg) => {
        var url = `https://daeseungtax.co.kr/kakao?flag=${flg}&seq=${seq_no}&work_yy=${wYY}&work_mm=${wMM}`;
        // iframe ì°¾ê¸° (ëª¨ë‹¬ ë‚´ë¶€)
        var iframe = findInModal("#kakaoIframe")[0]; 
        if (iframe) iframe.src = url;
    };
    //ë³´ë‚¼ë©”ì¼ ìƒì„±
    const setMailContent = async (seq_no, work_YY, work_MM, flag) => {
      $.ajax({
        url: "{% url 'getMailContent' %}",
        type: "POST",
        data: {
          seq_no: seq_no,
          work_YY: work_YY,
          work_MM: work_MM,
          flag:flag,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        dataType: "json",
        success: function (data) {
          let rec = data.recordset_adminInfo;
          let mem = data.recordset_member;
          let rows = data.recordset;
          let html = `
                <div class="card">
                  <div class="card-header border-bottom">
                    <h4 class="card-title fw-bold">[${rec.TXT_CorpName}] ${wYY}ë…„ ${wMM}ì›” ê³ ì§€ì„¸ì•¡ ì•ˆë‚´ - ${mem.biz_name}</h4>
                  </div>
                  <div class="card-body">
                    <div class="email-media">
                      <div class="mt-0 d-sm-flex">
                        <img class="me-2 rounded-circle avatar-xl" src="https://daeseungtax.co.kr/static/assets/images/faces/${rec.admin_name}.png" alt="avatar">
                        <div class="media-body">
                          <div class="media-title fw-bold mt-0">ì—…ë¬´ë‹´ë‹¹ì ${rec.admin_name} <span class="tx-13 fw-semibold">(<i class="fe fe-phone-call"></i> ${rec.admin_tel_no} )</span></div>
                          <p class="mb-0"> <span class="text-muted">ì±…ì„ì„¸ë¬´ì‚¬ ${rec.TXT_DutyCTA} (<i class="fe fe-smartphone"></i> ${rec.TXT_DutyCTAHP} )</span> </p>
                          <p class="mb-0"> <span class="text-muted">${rec.TXT_OfficeAddress} </span> </p>
                        </div>
                      </div>
                    </div>
                    <div class="eamil-body mt-5">
                      <h6 class="fw-bold">ì•ˆë…•í•˜ì„¸ìš” ì„¸ë¬´ë²•ì¸ëŒ€ìŠ¹ì…ë‹ˆë‹¤.</h6>
                      <p> í˜„ì¬ ì•„ë˜ ì•ˆë‚´ë“œë¦¬ëŠ” ì„¸ëª©ìœ¼ë¡œ ë¯¸ë‚©ì„¸ì•¡ì´ ìˆìœ¼ë‹ˆ ì¸í„°ë„· ë±…í‚¹ì˜ ê³µê³¼ê¸ˆ ë‚©ë¶€ ë©”ë‰´ì—ì„œ í•´ë‹¹ ì „ìë‚©ë¶€ë²ˆí˜¸ë¡œ ì¡°íšŒí•˜ì—¬ ë‚©ë¶€ê¸°í•œê¹Œì§€ ê³ ì§€ì„¸ì•¡ì„ ë‚©ë¶€í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. </p>
                      <p> ë‚©ë¶€ê¸°í•œê¹Œì§€ ë¯¸ë‚©í•  ê²½ìš° ì²´ë‚©ì„¸ì•¡ìœ¼ë¡œ ë¶„ë¥˜ë˜ë©° ê¸°ê°„ ê²½ê³¼ë¶„ì— ëŒ€í•œ ê°€ì‚°ì„¸ê°€ ì¶”ê°€ë˜ì–´ 1ê°œì›” ê²½ê³¼ëœ ë‚©ë¶€ì„œê°€ ì¬ë°œì†¡ë©ë‹ˆë‹¤.</p>
                      <p class="mb-0">ë” ê¶ê¸ˆí•œ ì‚¬í•­ì€ ì—…ë¬´ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜ë°”ëë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                      <hr>
                      <div class="email-attch">
                        <div class="float-center"><p class="text-teritary"><i class="fe fe-alert-circle" ></i> ê³ ì§€ì„¸ì•¡</p></div>
                        <table class='table table-bordered table-sm mb-0'>
                          <thead>
                            <tr>
                              <th style='text-align:center'>ì„¸ëª©</th>
                              <th style='text-align:center'>ê³ ì§€ì„¸ì•¡</th>
                              <th style='text-align:center'>ì „ìë‚©ë¶€ë²ˆí˜¸</th>
                              <th style='text-align:center'>ê´€í• <br>ì„¸ë¬´ì„œ</th>
                              <th style='text-align:center'>ë‚©ë¶€ê¸°í•œ</th>
                            </tr>
                          </thead>
                          <tbody>`;
          if(rows) {
              for (var j = 0; j < rows.length; j++) {
                  html += `
                  <tr>
                    <td style='text-align:center;width:80px'>${rows[j].taxMok}</td>
                    <td style='text-align:right;width:15%'>${Ext.util.Format.number(rows[j].taxAmt, '0,000')} ì›</td>
                    <td style='text-align:center;width:15%'>${rows[j].taxNapbuNum}</td>
                    <td style='text-align:center;width:30px'>${rows[j].taxOffice}</td>
                    <td style='text-align:center;width:45px;'>${rows[j].taxDuedate}</td>
                  </tr>`;
              }
          }
          html += `</tbody></table></div>
                <h4 class="fw-bold mt-4">ğŸ“© ë¬¸ì˜ ì‚¬í•­</h4>
                <p>ê³ ì§€ ë° ì²´ë‚©ì„¸ì•¡ì— ëŒ€í•˜ì—¬ ê¶ê¸ˆí•œ ì‚¬í•­ ìˆìœ¼ì‹œë©´ ì—…ë¬´ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                <p class="fw-bold">ê°ì‚¬í•©ë‹ˆë‹¤.</p>
            </div></div></div>`;
          findInModal('#mailContent').html(html);
        },
        error: function (request, status, error) {
          console.log('fail: ' + error);
        }
      });
    }; 

    function formatDate(value){
        return value ? Ext.Date.dateFormat(value, 'Y-m-d') : '';
    }        

    //ì´ê±´ ê³µí†µìœ¼ë¡œ ëº„ìˆ˜ì—†ë‹¤
    var comboDataStore = Ext.create('Ext.data.Store', {
        fields: ['id', 'name'],
        data: [] // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì›Œë‘ 
    });    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [6] Store ë° Grid ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var store = Ext.create('Ext.data.Store', {
        storeId: 'gojiStore_' + Math.random(), 
        autoLoad: true, 
        proxy: {
            type: 'ajax', 
            url: '{% url "kijang_goji_list" %}', // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
            extraParams: {
                work_YY: work_YY ,
                work_MM: work_MM,
                flag:flag
            },        
            reader: {
                type: 'json', // ì„œë²„ì—ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
                rootProperty: 'data', // ì‘ë‹µ JSONì—ì„œ ë°ì´í„° ë°°ì—´ì˜ ì†ì„± ì´ë¦„
                totalProperty: 'total', // ì‘ë‹µ JSONì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì†ì„± ì´ë¦„
            },
        },
        fields: [ // í•„ë“œ ì •ì˜ (ë°ì´í„°ì˜ ê° ì—´)
          {name: 'row_num'},
          {name: 'groupManager',type: 'string'},
          {name: 'seq_no',type: 'string'},      
          {name: 'biz_name', type: 'string'},
          {name: 'searchDate', type: 'date', dateFormat: 'Y-m-d'},     
          {name: 'taxMok',type: 'string'},
          {name: 'taxAmt', type: 'number'},
          {name: 'taxNapbuNum', type: 'string'},
          {name: 'taxOffice',type: 'string'},
          {name: 'taxDuedate', type: 'date', dateFormat: 'Y-m-d'},     
          {name: 'mailDate', type: 'string'},
          {name: 'mailExist', type: 'string'}
        ],
        groupField: 'groupManager'
    });



  mainGrid = Ext.create('Ext.grid.Panel', {
        renderTo: renderTarget,
        title: '{{ gridTitle }}',
        tools: [
            {
              xtype: 'textfield',
              emptyText: 'ê²€ìƒ‰ì–´ ì…ë ¥',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // ê·¸ë¦¬ë“œì˜ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // í•„í„° ì œê±°
                      } else {
                          store.clearFilter(true); // ê¸°ì¡´ í•„í„° ì œê±°
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              const ceoName = record.get('ceo_name')?.toLowerCase() || '';
                              return (
                                  bizName.includes(searchValue) || ceoName.includes(searchValue)
                              );
                          });
                      }
                  }
              }
            },
            {
                xtype: 'button',
                iconCls: 'icon icon-refresh',
                handler: function (btn) {
                    const grid = btn.up('grid');
                    if (grid) {
                        runAfterUnmask(() => grid.getStore().reload()); // ë§ˆìŠ¤í¬ í•´ì œ ì‹œì ì— ì¬ì¡°íšŒ
                    }
                },
                style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
            }
        ],            
        // layout: 'fit', // ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ìë™ í¬ê¸° ì¡°ì •
        width:'100%',
        height: getGridHeight(), // ì´ˆê¸° ë†’ì´ ì„¤ì •
        scrollable: 'y', // ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
        store: store,
        columnLines: false,
        features: [{
            id: 'groupManager',
            ftype: 'groupingsummary',
            startCollapsed: false,
            groupHeaderTpl: '{name}',
            hideGroupedHeader: false,
            enableGroupingMenu: true
        }],
        columns: [
          {   xtype: 'rownumberer',width: 30,	sortable: false    }, 
          {  id: 'groupManager',header: '<center>ê´€ë¦¬ì</center>', dataIndex: 'groupManager',width: 0       }, 
          {  header: 'SEQ', dataIndex: 'seq_no',width: 0          }, 
          {  id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',width: 160	   }, 
          {  header: '<center>ì¡°íšŒì¼</center>', dataIndex: 'searchDate',width: 100, align:'center',renderer: formatDate, 
              editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	        }, 
          {  header: '<center>ì„¸ëª©</center>',	 dataIndex: 'taxMok', flex:1,align:'center'        }, 
          {  header: '<center>ê³ ì§€ê¸ˆì•¡</center>', dataIndex: 'taxAmt',xtype: 'numbercolumn', align:'right',format:'0,000', editor: { allowBlank: false }	        },
          {  header: '<center>ì „ìë‚©ë¶€ë²ˆí˜¸</center>', dataIndex: 'taxNapbuNum',width: 220, align:'center'        },
          {  header: '<center>ê´€í• ì„¸ë¬´ì„œ</center>', dataIndex: 'taxOffice',width: 80, align:'center'        },
          {  header: '<center>ë‚©ë¶€ê¸°í•œ</center>', dataIndex: 'taxDuedate',width: 100, align:'center',
              renderer: formatDate, editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	        },
          {  header: '<center>ì „ì†¡ì‹œê°„</center>', dataIndex: 'mailDate',  width: 160, align:'center'        },            
          {  header: '<center>ë©”ì¼<br>ì „ì†¡</center>', dataIndex: 'mailExist', width: 60, align:'center',
            renderer: function (value, metaData, record) {
              let seq_no = record.get('seq_no');
              let biz_name = record.get('biz_name');
              return `<button class="btn btn-blue btn-sm" onclick="window.summitModal(${seq_no},'${biz_name}', ${work_YY}, ${work_MM}, '${flag}');">ì¹´í†¡</button>`;
            }          
          }
        ],
        viewConfig: {
          emptyText: '<div style="text-align:center;padding:50px;font-size:16px; font-weight:bold;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
        },
        dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          items: [{
            xtype: 'buttongroup',              
            columns: 5,
            frame:false,
            defaults: {
                enableToggle: true,
                toggleGroup: 'yearGroup',
                margin: '0 5 0 0', // ë²„íŠ¼ ê°„ê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ 5px ê°„ê²©)
                style: {
                    border: '1px solid #ccc',
                    padding: '5px 6px',
                    borderRadius: '5px',
                    transition: 'all 0.2s ease' // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
                }
            },
            items: Array.from({ length: 5 }, (_, i) => ({
              text: `${currentYear - i}ë…„`,
              pressed: currentYear - i === work_YY,
              handler: function () {
                var grid = this.up('grid');
                work_YY = parseInt(this.text, 10);
                grid.getStore().getProxy().extraParams.work_YY = work_YY;
                grid.getStore().reload();
              }
            })),
          }]
        },
        {
          xtype: 'buttongroup',
          title: null, // ì œëª© ì œê±°
          columns: 12, // í•œ ì¤„ì— ë²„íŠ¼ 12ê°œ
          defaults: {
              enableToggle: true,
              toggleGroup: 'monthGroup',
              margin: '0 5 0 0', // ë²„íŠ¼ ê°„ê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ 5px ê°„ê²©)
              style: {
                  //background: 'transparent', // ë²„íŠ¼ ë°°ê²½ íˆ¬ëª…
                  border: '1px solid #ccc', // ë²„íŠ¼ í…Œë‘ë¦¬ ìƒ‰ìƒ
                  padding: '5px 6px', // ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°±
                  borderRadius: '5px' // ë²„íŠ¼ ë‘¥ê¸€ê²Œ ì²˜ë¦¬
              }
          },
          items: Array.from({ length: 12 }, (_, i) => ({
              text: `${i + 1}ì›”`,
              pressed: i + 1 === work_MM,
              handler: function () {
                var grid = this.up('grid'); // â˜… this.up ì‚¬ìš©
                work_MM = parseInt(this.text, 10);
                var store = grid.getStore();
                store.getProxy().extraParams.work_MM = work_MM;
                store.reload();
              }
          })),
          style: {
              background: '#fff', // ë²„íŠ¼ ê·¸ë£¹ ë°°ê²½ ì œê±°
              border: '1px solid #ccc', // ë²„íŠ¼ ê·¸ë£¹ í…Œë‘ë¦¬ ì œê±°
              padding: '6px' // ë²„íŠ¼ ê·¸ë£¹ ë‚´ë¶€ ì—¬ë°±
          }
        }
      ],
      listeners: {
        afterrender: function(grid) {
             Ext.EventManager.onWindowResize(function() {
                 if(grid && !grid.isDestroyed) {
                     grid.setHeight(getGridHeight());
                     grid.doLayout();
                 }
             });
             setTimeout(function(){ grid.updateLayout(); }, 200);
        }
      }     
    });



    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }
})();  
</script>
