{% load static %}
{% load humanize %}
<style>
/* 프로필 사진 업로드 버튼 위치 조정 */
.avatar-icon-badge.upload {
    cursor: pointer;
}
/* 카드 높이 맞춤 */
.card {
    margin-bottom: 1.5rem;
}
.staff-scroll-container {
    position: absolute; /* 부모(.tab-pane) 기준으로 위치 고정 */
    top: 0; 
    bottom: 0; 
    left: 0; 
    right: 0;
    overflow-y: auto;   /* 세로 스크롤 허용 */
    overflow-x: hidden; /* 가로 스크롤 방지 */
    padding: 15px;      /* 내부 여백 */
}    
</style>   
<div class="staff-scroll-container">   
  <div class="row "> 
    <div class="col-xl-12 col-md-12 ">
        <div class="card">
            <div class="card-body ">
                <div class="row">
                    <div class="col-xl-6 col-md-12 ">
                        <div class="card mb-0 shadow-none border">
                            <div class="card-body">
                                <div class="client-title mt-0">
                                    <div class="card-body text-wrap d-flex flex-row justify-content-center">
                                        <div class="avatar-container avatar-xl ">
                                            <form method="POST" id="thumbForm" action="{% url 'fileupload' %}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                {% if userProfile %}
                                                <span class="avatar avatar-xxl brround cover-image cover-image" data-bs-image-src="{{ userProfile.image.url }}" style="background: url('{{ userProfile.image.url }}') center center;"></span>
                                                {% else %}
                                                <span class="avatar avatar-xxl brround cover-image cover-image" data-bs-image-src="{% static 'assets/images/faces/blank.jpg' %}" style="background: url('{% static 'assets/images/faces/blank.jpg' %}') center center;"></span>
                                                {% endif %}
                                                <input type="hidden" name="title" value="{{memadmin.seq_no}}" />
                                                <input type="hidden" name="description" value="{{dateNow}}" />
                                                <input class="real-upload" type="file" name="image" accept=" image/jpeg, image/png, text/html, application/zip, text/css, text/js" multiple style="display: none;" />
                                                <span class="badge bg-success rounded-pill ms-6 avatar-icon-badge upload"><i class="fe fe-camera "></i></span>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <h4 class="h4 mb-0 mt-3"><small class="op-0-7 pr-1">이름</small> {{memadmin.admin_name}}</h4>
                                    <div class="text-center my-4">
                                        </div>
                                    <p class="opacity-6 mb-6">주소</p>
                                </div>
                                <div class="d-flex align-items-center justify-content-center mt-4">
                                    <div class="pe-2 border-end d-flex align-items-center justify-content-center">
                                        <div class="main-profile-contact-list">
                                            <div class="media mx-1">
                                                <div class="media-icon bg-primary-transparent text-primary"><a href="tel:{{memadmin.admin_tel_no}}"><i class="fe fe-phone fs-21"></i></a></div>
                                                <div class="media-body ms-1">
                                                    <span class="text-muted">직통전화</span>
                                                    <p class="mb-0"> {{memadmin.admin_tel_no}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ms-2 d-flex align-items-center justify-content-center">
                                        <div class="main-profile-contact-list">
                                            <div class="media mx-1">
                                                <div class="media-icon bg-success-transparent text-success"> <i class="fe fe-mail fs-21"></i> </div>
                                                <div class="media-body ms-1">
                                                    <span class="text-muted">이메일</span>
                                                    <p class="mb-0"> {{memadmin.admin_email}} </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive p-0 mt-4">
                                    <table class="table row table-borderless">
                                        <tbody class="col-lg-12 col-xl-6 p-0">
                                            <tr>
                                                <td>입사일 : </td>
                                            </tr>
                                            <tr>
                                                <td>근속연수 : </td>
                                            </tr>
                                        </tbody>
                                        <tbody class="col-lg-12 col-xl-6 p-0 border-top-0">
                                            <tr>
                                                <td>소속 : </td>
                                            </tr>
                                            <tr>
                                                <td>직급 : </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-6 col-md-12 ">
                        <div class="card card-blog-overlay2 op-0-8 h-100 ">
                            <div class="card-body  text-white pt-xl-10 d-flex flex-column justify-content-center align-items-center" style="min-height: 400px;">
                                <div class="d-flex flex-row justify-content-center">
                                    <button class="btn-success-gradient btn-pill btn-lg ms-6" onclick="basicSheet('{{memadmin.Biz_Name}}','{{memadmin.Biz_Type}}')"> 근로계약서</button>
                                </div>
                            </div>

                            <div class="card-footer text-white z-index2 border-transparent">
                                <h3 class="card-title text-white">업무 요청사항 </h3>
                                <p>화이팅.   </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
</div>      
<div class="modal fade" id="modalBasicSheet">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content modal-content-demo">
            <div class="modal-header">
                <div class="btn-toolbar" role="toolbar">
                    {% for file in fileArr %}
                    <div class="btn-group" role="group" id="group1" data-group="1">
                        <button type="button" class="btn" onclick="switch_to_green(this,'{{file.disp_name}}','{{file.file_path}}')">{{file.disp_name}}</button>
                    </div>
                    {% endfor %}
                </div>
                <a href="#" class="option-dots" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fe fe-more-vertical"></i></a>
                <div class="dropdown-menu dropdown-menu-start">
                    <a class="dropdown-item" href="javascript:mailFile();"><i class="fe fe-mail me-2"></i> 메일보내기</a>
                    <a class="dropdown-item" href="javascript:saveFile();"><i class="fe fe-download me-2"></i> 저장하기</a>
                    <a class="dropdown-item" data-bs-dismiss="modal" href="#"><i class="fe fe-log-out me-2"></i> 닫기</a>
                </div>
            </div>
            <div class="modal-body">
                <div style="width:100%;max-height:850px;overflow-y: scroll; ">
                    <div id="divImage"></div>
                    <div id="divLoading" style="z-index: 10000; display:none">
                        <h1 style="display: inline;">Loading...</h1>
                        <img src="/static/image/loading.gif" alt="Loading..." />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMail">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content modal-content-demo border-0" style="background: url(static/assets/images/media/bg-1.jpg);">
            <div class="modal-body " style="background: var(--primary06);border:0px;margin:0px">
                <div class="row">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-6 col-md-12">
                                <div class="col mx-auto text-center  pt-7">
                                    <img src="{% static 'assets/images/media/lockscreen.png' %}" style="width: 300px;" alt="">
                                </div>
                            </div>
                            <div class="col-xl-6 col-md-12">
                                <div class="col-12 container-login100">
                                    <div class="row">
                                        <div class="col col-login mx-auto">
                                            <form class="card shadow-none" method="post">
                                                <div class="card-body">
                                                    <div class="text-center">
                                                        <span class="login100-form-title">
                                                            메일보내기
                                                        </span>
                                                        <p class="text-muted"><span>
                                                                <div id="dispStr" style="display:inline;"></div>을 받을 곳의 이메일 주소를 입력하세요
                                                            </p></span>
                                                    </div>
                                                    <div class="pt-3" id="forgot">
                                                        <div class="form-group">
                                                            <label class="form-label" for="eMail">E-Mail:</label>
                                                            <input class="form-control" id="eMail" placeholder="받는사람 이메일 주소" type="email">
                                                        </div>
                                                        <div class="submit">
                                                            <a class="btn btn-primary d-grid" href="javascript:sendMail();">전송</a>
                                                        </div>
                                                    </div>

                                                </div>
                                                <div class="card-footer">
                                                    <div class="d-flex flex-row justify-content-between">
                                                        <div class="p-sm-0 p-0">
                                                            <div id="spinnerDiv" class="spinner-border text-primary" role="status">
                                                                <span class="sr-only">Loading...</span>
                                                            </div>
                                                            <div id="sendOK">
                                                                <p class="text-muted">전송완료</p>
                                                            </div>
                                                            <div id="sendFail">
                                                                <p class="text-muted">전송오류입니다...</p>
                                                            </div>
                                                        </div>

                                                        <div class="p-sm-2 p-2 bg-gray-200 radius-30">
                                                            <img src="{% static 'assets/images/brand/DS_LOGO.svg' %}" style="width:30px;" alt="">
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
// 탭 전용 스크립트 캡슐화
(function() {  
  function getImageFiles(e) {
    const files = e.currentTarget.files;
    const reader = new FileReader();
    reader.onload = (e) => {
      //const preview = createElement(e, files[0]);
      $('#uploadImg').attr('src', e.target.result)
                    .width(100)
                    .height(80);
      $('#uploadImg').attr('data-file', files[0].name)
      //$('#uploadImg').appendChild(preview);
    };
    reader.readAsDataURL(files[0]);    
    document.forms["thumbForm"].submit();
    
  }

  const realUpload = document.querySelector('.real-upload');
  const upload = document.querySelector('.upload');
  if(upload && realUpload) {
        upload.addEventListener('click', () => realUpload.click());
        realUpload.addEventListener('change', getImageFiles);
    }

  /*  회사기초서류 준비 */ 
  $("#spinnerDiv").hide();
  $("#sendOK").hide();
  $("#sendFail").hide();
  // JSON 파싱 (Django 템플릿 변수)
  var fileArrStr = "{{fileArr|escapejs}}";
  var fileArr = [];
  if(fileArrStr) {
      fileArrStr = fileArrStr.replaceAll("'","\"");
      try { fileArr = JSON.parse(fileArrStr); } catch(e){}
  }

  window.basicSheet = function(bizName, bizType) {
      let g_buttons = document.querySelectorAll('#group1 .btn');
      for (let i = 0; i < g_buttons.length; i++) {
          g_buttons[i].classList.remove('btn-success');
      }
      if(g_buttons.length > 0 && fileArr.length > 0) {
          g_buttons[0].classList.add('btn-success');
          changeSheet(fileArr[0].disp_name, fileArr[0].file_path);
      }
  };

  window.switch_to_green = function(el, disp_name, file_path) {
      let g_buttons = document.querySelectorAll('#group1 .btn');
      for (let i = 0; i < g_buttons.length; i++) {
          g_buttons[i].classList.remove('btn-success');
      }
      el.classList.add('btn-success');
      changeSheet(disp_name, file_path);
  };
  var openedFile=[];
  var selectedPeriod;
  function changeSheet(disp_name,file_path){
    $.ajax({
      url:"{% url 'changeSheet' %}",
      data:{url:file_path},
      dataType:"text",
      success:function(data){
        var pyJson = JSON.parse(data);
        openedFile = pyJson;
        selectedPeriod = disp_name;
        $('[id="dispStr"]').html(disp_name)
        $('[id="divImage"]').html("<img id='openedImg' src=\'" + pyJson.fileName + "\' > ")
        $("#modalBasicSheet").modal('show');
      },
      error:function(request,status,error){
        console.log('fail:'+error);
      }
    })
  }
  window.mailFile = function() {
    $("#modalBasicSheet").modal('hide');
    $("#modalMail").modal('show');
  };
  
  window.saveFile = function() {
        const filename = openedFile.onlyFileName;
        const data = openedFile.onlyFilePath + filename;
        const link = document.createElement('a');
        link.href = data;
        link.download = filename;
        link.click();
        link.remove();
        $("#modalBasicSheet").modal('hide');
  };
  function ValidateEmail(input) {
    var validRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
    if (input.match(validRegex)) {
      return true;
    } else {
      alert("이메일 주소 형식에 맞지 않습니다");
      $('#eMail').focus();
      return false;
    }
  }  
  window.sendMail = function() {
    var emailAddr = $('#eMail').val();
    // ... (메일 전송 로직 구현, 여기서는 주석처리된 부분 참고) ...
    // 필요하다면 기존 sendMail 로직을 복원하세요.
    if(!emailAddr){
        alert("이메일 주소를 입력하세요");
        return;
    }
    // 예시 AJAX (실제 URL 확인 필요)
    /*
    $.ajax({
        url: "{% url 'sendMailCompInfo' %}", 
        // ...
    });
    */
  };
})();
</script>
