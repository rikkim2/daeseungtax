{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }    

    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table {
        width: auto !important; 
        margin: 0 !important;
    }
    
    /* ê·¸ë¦¬ë“œ ë˜í¼ */
    .ext-grid-wrapper {
        width: 100%;
        /* ë†’ì´ëŠ” JSì—ì„œ ì„¤ì • */
    }
</style>  

<div class="ext-grid-wrapper"></div>
<script>
(function () {
  var mainGrid, mainStore;
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();        
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
  var work_YY = '{{ request.session.workyearPay }}';
  var work_MM = '{{ request.session.workmonthPay }}';  
  // ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì„¤ì •
  if(!work_YY) work_YY = new Date().getFullYear();
  if(!work_MM) work_MM = new Date().getMonth() + 1;  
console.log(ADID)
  const currentYear = new Date().getFullYear();
  var payrollYear, selectedPeriod, selectedSheetID, selectedSheetName="";

  // 1. renderTopic
  window.renderTopic = function(value, p, record) {
      return Ext.String.format(
          `<div style="cursor:pointer; color:blue;" 
              onclick="window.summitModal(${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, ${work_MM}, 'pay');">
              ${Ext.String.htmlEncode(value)}
          </div>`    
      );
  };
  window.summitModal = async function(seq_no, biz_name, wYY, wMM, flag) {
  };
  function findRenderTarget() {
    // 1) ì „ì²´ì—ì„œ "Ext ì»´í¬ë„ŒíŠ¸ê°€ ì—†ëŠ” ë˜í¼" ì°¾ê¸°
    var el = $('.ext-grid-wrapper').filter(function () {
      return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
    }).last()[0];

    // 2) ì—†ìœ¼ë©´ í™œì„± íƒ­ì—ì„œ ë‹¤ì‹œ ì°¾ê¸°
    if (!el) {
      el = $('div.tab-pane.active .ext-grid-wrapper').filter(function () {
        return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
      }).last()[0];
    }
    return el || null;
  }
  if (isSuperuser){
    Ext.Ajax.request({
        url: '{% url "kijang_admin_combolist" %}', // ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
        method: 'GET',
        success: function (response) {
            const data = Ext.decode(response.responseText); // ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±
            comboDataStore.loadData(data); // storeì— ë°ì´í„° ë¡œë“œ
        },
        failure: function () {
            Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
  }

  function syncParamsAndReload() {
    var store = mainGrid.getStore();
    var proxy = store.getProxy();

    proxy.extraParams = proxy.extraParams || {};
    proxy.extraParams.input_workyear = work_YY;
    proxy.extraParams.work_mm        = work_MM;
    proxy.extraParams.ADID           = ADID;
    proxy.extraParams.flag           = flag;   // í•„ìš”í•˜ë©´

    console.log('ğŸ”„ Reloading store with params:', proxy.extraParams);

    store.reload({
      callback: function () {
        if (ADID === "ì „ì²´") store.group('groupManager');
      }
    });
  }

  function buildGrid() {
    if (mainGrid) return;

    var renderTarget = findRenderTarget();
    if (!renderTarget) return;

    // ë†’ì´ê°€ 0ì´ë©´ ìµœì†Œ ë†’ì´ ë¶€ì—¬ (íƒ­/ëª¨ë‹¬ ì´ˆê¸° ë Œë” íƒ€ì´ë° ë°©ì–´)
    if (renderTarget.clientHeight < 50) {
      renderTarget.style.minHeight = '600px';
    }

    Ext.define('Plant', {
      extend: 'Ext.data.Model',
      fields: [
        {name: 'groupManager',type: 'string'},
        {name: 'seq_no'},
        {name: 'biz_name', type: 'string'},
        {name: 'biz_type', type: 'string'},
        {name: 'isBanki', type: 'string'},
        {name: 'wh_Kunro',type: 'string'},
        {name: 'wh_sayoup',type: 'string'},
        {name: 'wh_kita',type: 'string'},
        { name: 'isKun', type: 'string' },
        { name: 'isKunAmt', type: 'string' },
        { name: 'isIlyoung', type: 'string' },
        { name: 'isSa', type: 'string' },
        { name: 'isSaAmt', type: 'string' },
        { name: 'isKi', type: 'string' },
        { name: 'isKiAmt', type: 'string' },
        { name: 'YN_9', type: 'string' },
        { name: 'isSkele', type: 'string' }
      ]
    });

    mainStore = Ext.create('Ext.data.Store', {
      model: 'Plant',
      groupField: (ADID === "ì „ì²´" ? 'groupManager' : null),
      sorters: {property: 'biz_name', direction: 'ASC'},
      proxy: {
        type: 'ajax',
        url: "{% url 'api_kani_sa_il_list' %}",
        reader: {
          type: 'json',
          root: 'rows',
          successProperty: 'ok'
        }
      },
      autoLoad: false,
      listeners: {
        load: function(store, records, successful, operation) {
          var response = operation && operation.response ? operation.response : null;
          console.log('Store load event:', {
            successful: successful,
            recordCount: records.length,
            rawResponse: response ? response.responseText : 'N/A'
          });
          if (!successful) {
            console.error('Load failed. Response:', response ? response.responseText : 'No response');
            Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          } else {
            console.log('âœ… Load successful! Records:', records.length);
          }
        }
      }
    });

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
        edit: function (editor, e) {
          Ext.Ajax.request({
            url: "{% url 'api_kani_sa_il_update' %}",
            method: "POST",
            params: {
              seq_no: e.record.get('seq_no'),
              field: e.field,
              work_YY: (window.STATE && STATE.work_YY) || '',
              work_MM: (window.STATE && STATE.work_MM) || '',
              val: e.record.get(e.field)
            },
            failure: function () {
              e.record.set(e.field, e.originalValue);
              Ext.Msg.alert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨");
            }
          });
        }
      }
    });
    // Docked Items Config ìƒì„±
    function onItemClickHandler(item) {
      ADID = item;
      syncParamsAndReload();
      updateScrollMenuText(item);
    }
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);      
    function renderFlagEmoji(v){
      return v ? "âœ…" : "";
    }
    function renderSkeletonEmoji(v){
      return v ? "ğŸ’€" : "";
    }       
    mainGrid = Ext.create('Ext.grid.Panel', {
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      store: mainStore,
      renderTo: renderTarget,
      title: 'ê°„ì´ì§€ê¸‰ëª…ì„¸ì„œ - ì‚¬ì—…,ì¼ìš©,ê¸°íƒ€ / ì¼ìš©ì§ ê·¼ë¡œë‚´ìš©í™•ì¸ì„œ',
      width: '100%',
      height: getGridHeight(),
      columnLines: true,
      ... (ADID === "ì „ì²´" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}),       
      plugins: [cellEditing],
      selModel: { selType: 'cellmodel' },
      columns: [
		    {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0}, 
        {  header: 'SEQ', dataIndex: 'seq_no',width: 50        }, 
        {  id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',width: 140	}, 
        { header:'ë°˜ê¸°', dataIndex:'isBanki', width:33, align:'center', renderer: renderFlagEmoji },
        {
          text: 'ì›ì²œì§•ìˆ˜ ì‹ ê³ ê¸ˆì•¡',
          columns: [
            { header: '<center>ì¼ìš©<br>(ì§€ê¸‰ì‹œê¸°)</center>', dataIndex: 'wh_Kunro',  width: 75, xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ì‚¬ì—…ì†Œë“</center>', dataIndex: 'wh_sayoup',  width: 75, xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ê¸°íƒ€ì†Œë“</center>', dataIndex: 'wh_kita',  width: 75, xtype: 'numbercolumn', align:'right',format:'0,000'            }
          ]		}, 
        {
          text: 'ì „ìì‹ ê³  ì ‘ìˆ˜ì—¬ë¶€',
          columns: [
            { header:'ì¼ìš©', dataIndex:'isKun', width:33, renderer: renderFlagEmoji },
            {	header: '<center>ì¼ìš©<br>ì§€ê¸‰ê¸ˆì•¡</center>', dataIndex: 'isKunAmt',  width: 75,xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ê·¼ë¡œë‚´ìš©í™•ì¸ì‹ ê³ <br>ì ‘ìˆ˜ë²ˆí˜¸</center>', dataIndex: 'isIlyoung',  width: 150, editor: { allowBlank: false }			}, 
            { header:'ì‚¬ì—…', dataIndex:'isSa',  width:33, renderer: renderFlagEmoji },
            {	header: '<center>ì‚¬ì—…<br>ì§€ê¸‰ê¸ˆì•¡</center>', dataIndex: 'isSaAmt',  width: 75,xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            { header:'ê¸°íƒ€', dataIndex:'isKi',  width:33, renderer: renderFlagEmoji },
            {	header: '<center>ê¸°íƒ€<br>ì§€ê¸‰ê¸ˆì•¡</center>', dataIndex: 'isKiAmt',  width: 75,xtype: 'numbercolumn', align:'right',format:'0,000'            }
          ]
		    }, 
        {	header: '<center>ì°¨ì´ì›ì¸ì„ ê¸°ë¡í•˜ì„¸ìš”</center>', dataIndex: 'YN_9',   width: 250, editor: { allowBlank: false }		}, 
        { header:'ì˜¤ë¥˜', dataIndex:'isSkele', width:35, renderer: renderSkeletonEmoji },
      ],
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
          items: [
            ...dockedItemsConfig,
            {
                xtype: 'buttongroup', columns: 5, frame: false,
                defaults: { enableToggle: true, toggleGroup: 'yearGroup', margin: '0 5 0 0', style: { border: '1px solid #ccc', padding: '5px 6px', borderRadius: '5px' } },
                items: Array.from({ length: 5 }, (_, i) => ({
                  text: `${currentYear - i}ë…„`,
                  pressed: currentYear - i === parseInt(work_YY, 10),
                  handler: function () {
                    work_YY = parseInt(this.text.replace('ë…„', ''), 10);
                    syncParamsAndReload();
                  }
                }))
            }
          ]
        },
        {
          xtype: 'buttongroup', columns: 12,
          defaults: { 
            enableToggle: true, toggleGroup: 'monthGroup', margin: '0 5 0 0', 
            style: { border: '1px solid #ccc', padding: '5px 6px', borderRadius: '5px' } 
          },
          items: Array.from({ length: 12 }, (_, i) => ({
              text: `${i + 1}ì›”`,
              pressed: i + 1 === parseInt(work_MM, 10),
              handler: function () {
                work_MM = parseInt(this.text.replace('ì›”', ''), 10);
                syncParamsAndReload();
              }
          })),
          style: { background: '#fff', border: '1px solid #ccc', padding: '6px' }
        }
      ],
      listeners: {
        afterrender: function(grid) {
             Ext.EventManager.onWindowResize(function() {
                 if(grid && !grid.isDestroyed) {
                     grid.setHeight(getGridHeight());
                     grid.doLayout();
                 }
             });
             setTimeout(function(){ grid.updateLayout(); }, 200);
        }
      }      
    });
    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }      
    
    // proxy.extraParams ì´ˆê¸°ê°’ ì„¸íŒ… í›„ ì¡°íšŒ
    var initialParams = {
      input_workyear: work_YY,
      work_mm: work_MM,
      ADID: ADID,
      flag: flag
    };
    mainStore.getProxy().extraParams = initialParams;
    console.log('ğŸ“¡ Initial load with params:', initialParams);

    mainStore.load({
      callback: function (records, operation, success) {
        console.log('Store load callback:', { records: records, success: success, recordCount: records ? records.length : 0 });
        if (success) {
          console.log('Data loaded successfully. Record count:', mainStore.getCount());
          if (ADID === "ì „ì²´") mainStore.group('groupManager');
        } else {
          console.error('Store load failed!', operation);
        }
      }
    });

    // ìƒì„± ì§í›„ ë ˆì´ì•„ì›ƒ 1íšŒ ë³´ì •(íƒ­/ëª¨ë‹¬ íƒ€ì´ë°)
    setTimeout(resizeGrid, 0);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getGridHeight() {
      var height = window.innerHeight - 180;
      return height > 300 ? height : 300;
  }
  function mkParams() {
    return {
      input_workyear: work_YY,
      work_mm: work_MM,
      ADID: ADID
    };
  }

  function resizeGrid() {
    if (!mainGrid) return;
    var wrap = mainGrid.el && mainGrid.el.dom ? mainGrid.el.dom.parentElement : null;
    if (!wrap) return;
    var h = wrap.clientHeight;
    if (h > 50) mainGrid.setHeight(h);
    mainGrid.doLayout();
  }

  Ext.onReady(function () {
    // ìµœì´ˆ active íƒ­ì´ë©´ ë°”ë¡œ ìƒì„±
    buildGrid();

    // íƒ­ ì „í™˜ ì‹œ ìƒì„± + ë¦¬ì‚¬ì´ì¦ˆ
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function (el) {
      el.addEventListener('shown.bs.tab', function () {
        buildGrid();
        resizeGrid();
      });
    });

    window.addEventListener('resize', resizeGrid);
  });
})();

</script>