{% load static %}

<style>
    .icon-refresh { color: white; }
    .modal-xxl { min-width: 1200px; max-width: 1400px; }    

    /* [í•µì‹¬] Bootstrapê³¼ ExtJS ì¶©ëŒ ë°©ì§€ */
    .ext-grid-wrapper .x-table {
        width: auto !important; 
        margin: 0 !important;
    }
    
    /* ê·¸ë¦¬ë“œ ë˜í¼ */
    .ext-grid-wrapper {
        width: 100%;
        /* ë†’ì´ëŠ” JSì—ì„œ ì„¤ì • */
    }

/* [ë””ìì¸ ìˆ˜ì •] í† ê¸€ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ì„ íƒ ì•ˆë¨) */
    .custom-toggle-btn {
        border-color: #d1d5db !important;
        background-image: none !important;
        background-color: #ffffff !important;
        color: #4b5563 !important;
        border-radius: 4px !important;
        box-shadow: none !important;
    }

    /* [ë””ìì¸ ìˆ˜ì •] í† ê¸€ ë²„íŠ¼ ì„ íƒë¨ (Pressed) */
    .custom-toggle-btn.x-btn-pressed {
        background-color: #667eea !important; /* í…Œë§ˆ ìƒ‰ìƒ (ë³´ë¼/ë¸”ë£¨) */
        border-color: #667eea !important;
        color: #ffffff !important;
        font-weight: bold !important;
    }

    /* [ë””ìì¸ ìˆ˜ì •] ë§ˆìš°ìŠ¤ í˜¸ë²„ íš¨ê³¼ */
    .custom-toggle-btn:hover:not(.x-btn-pressed) {
        background-color: #f3f4f6 !important;
        border-color: #9ca3af !important;
        color: #111827 !important;
    }
    
    /* ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ì¡°ì • */
    .custom-btn-group .x-btn-group-body {
        padding: 2px !important;
    }

/* [ì¶”ê°€] í•´ê³¨(ì˜¤ë¥˜) ë°œìƒ ì‹œ ë…¸ë€ìƒ‰ ë°°ê²½ */
    .row-yellow-warning .x-grid-cell {
        background-color: #ffffcc !important; /* ì—°í•œ ë…¸ë€ìƒ‰ */
    }
    
    /* (ì„ íƒì‚¬í•­) ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ìƒ‰ìƒ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ */
    /* .row-yellow-warning.x-grid-row-over .x-grid-cell {
        background-color: #ffffaa !important;
    } */
</style>  

<div class="ext-grid-wrapper"></div>
<script>
(function () {
  var mainGrid, mainStore;
  var flag = '{{ flag }}';
  var adminBizLevel = '{{ admin_biz_level }}'.trim();
  const isSuperuser = '{{ admin_grade }}' === 'SA';
  var ADID = '{{ ADID }}'.trim();        
  var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
  var work_YY = '{{ request.session.workyearPay }}';
  var work_MM = '{{ request.session.workmonthPay }}';  
  // ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì„¤ì •
  if(!work_YY) work_YY = new Date().getFullYear();
  if(!work_MM) work_MM = new Date().getMonth() + 1;  
console.log(ADID)
  const currentYear = new Date().getFullYear();
  var payrollYear, selectedPeriod, selectedSheetID, selectedSheetName="";

  // 1. renderTopic
  window.renderTopic = function(value, p, record) {
      return Ext.String.format(
          `<div style="cursor:pointer; color:blue;" 
              onclick="window.summitModal(${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, ${work_MM}, 'pay');">
              ${Ext.String.htmlEncode(value)}
          </div>`    
      );
  };
  window.summitModal = async function(seq_no, biz_name, wYY, wMM, flag) {
  };
  function findRenderTarget() {
    // 1) ì „ì²´ì—ì„œ "Ext ì»´í¬ë„ŒíŠ¸ê°€ ì—†ëŠ” ë˜í¼" ì°¾ê¸°
    var el = $('.ext-grid-wrapper').filter(function () {
      return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
    }).last()[0];

    // 2) ì—†ìœ¼ë©´ í™œì„± íƒ­ì—ì„œ ë‹¤ì‹œ ì°¾ê¸°
    if (!el) {
      el = $('div.tab-pane.active .ext-grid-wrapper').filter(function () {
        return $(this).find('.x-grid, .x-panel, .x-component').length === 0;
      }).last()[0];
    }
    return el || null;
  }
  if (isSuperuser){
    Ext.Ajax.request({
        url: '{% url "kijang_admin_combolist" %}', // ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
        method: 'GET',
        success: function (response) {
            const data = Ext.decode(response.responseText); // ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±
            comboDataStore.loadData(data); // storeì— ë°ì´í„° ë¡œë“œ
        },
        failure: function () {
            Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
  }

  function syncParamsAndReload() {
    var store = mainGrid.getStore();
    var proxy = store.getProxy();

    proxy.extraParams = proxy.extraParams || {};
    proxy.extraParams.input_workyear = work_YY;
    proxy.extraParams.work_mm        = work_MM;
    proxy.extraParams.ADID           = ADID;
    proxy.extraParams.flag           = flag;

    console.log('ğŸ”„ Reloading store with params:', proxy.extraParams);

    store.reload({
      callback: function () {
        if (ADID === "ì „ì²´") {
            // [í•µì‹¬ ìˆ˜ì •] ë°©í–¥ì„ 'ASC'ë¡œ ê°•ì œ ì§€ì •í•˜ì—¬ í† ê¸€ ë°©ì§€
            store.group({ property: 'groupManager', direction: 'ASC' });
            
            // ê·¸ë£¹ ë‚´ë¶€ì˜ ì—…ì²´ëª… ì •ë ¬ë„ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´ sorters ì¬í™•ì¸
            store.sort([
                { property: 'groupManager', direction: 'ASC' },
                { property: 'biz_name', direction: 'ASC' }
            ]);
        } else {
            store.clearGrouping();
        }
      }
    });
  }

  function buildGrid() {
    if (mainGrid) return;

    var renderTarget = findRenderTarget();
    if (!renderTarget) return;

    // ë†’ì´ê°€ 0ì´ë©´ ìµœì†Œ ë†’ì´ ë¶€ì—¬ (íƒ­/ëª¨ë‹¬ ì´ˆê¸° ë Œë” íƒ€ì´ë° ë°©ì–´)
    if (renderTarget.clientHeight < 50) {
      renderTarget.style.minHeight = '600px';
    }

    Ext.define('Plant', {
      extend: 'Ext.data.Model',
      fields: [
        {name: 'groupManager',type: 'string', convert: function(v){ return (v || '').trim(); }},
        {name: 'seq_no'},
        {name: 'biz_name', type: 'string'},
        {name: 'biz_type', type: 'string'},
        {name: 'isBanki', type: 'string'},
        {name: 'wh_Kunro',type: 'float', convert: function(v){ return parseFloat(v) || 0; }},
        {name: 'wh_sayoup',type: 'float', convert: function(v){ return parseFloat(v) || 0; }},
        {name: 'wh_kita',type: 'float', convert: function(v){ return parseFloat(v) || 0; }},
        { name: 'isKun', type: 'string' },
        { name: 'isKunAmt', type: 'float', convert: function(v){ return parseFloat(v) || 0; } },
        { name: 'isIlyoung', type: 'string' },
        { name: 'isSa', type: 'string' },
        { name: 'isSaAmt', type: 'float', convert: function(v){ return parseFloat(v) || 0; } },
        { name: 'isKi', type: 'string' },
        { name: 'isKiAmt', type: 'float', convert: function(v){ return parseFloat(v) || 0; } },
        { name: 'YN_9', type: 'string' },
        { name: 'isSkele', type: 'string' }
      ]
    });

    mainStore = Ext.create('Ext.data.Store', {
      model: 'Plant',
      groupField: (ADID === "ì „ì²´" ? 'groupManager' : null),
      // ê·¸ë£¹(ë‹´ë‹¹ì) ìˆœì„œê°€ ì¡°íšŒë§ˆë‹¤ ë°”ë€Œì§€ ì•Šë„ë¡ group/grouper/sorters ëª¨ë‘ ì§€ì •
      grouper: { property: 'groupManager', direction: 'ASC' },
      sorters: [
        {property: 'groupManager', direction: 'ASC'},
        {property: 'biz_name', direction: 'ASC'}
      ],
      proxy: {
        type: 'ajax',
        url: "{% url 'api_kani_sa_il_list' %}",
        reader: {
          type: 'json',
          root: 'rows',
          successProperty: 'ok'
        }
      },
      autoLoad: false,
      listeners: {
        load: function(store, records, successful, operation) {
          var response = operation && operation.response ? operation.response : null;
          if (!successful) {
            console.error('Load failed. Response:', response ? response.responseText : 'No response');
            Ext.Msg.alert('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          } else {
            console.log('Load successful! Records:', records.length);
          }
        }
      }
    });

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
        edit: function (editor, e) {
          Ext.Ajax.request({
            url: "{% url 'api_kani_sa_il_update' %}",
            method: "POST",
            params: {
              seq_no: e.record.get('seq_no'),
              field: e.field,
              work_YY: (window.STATE && STATE.work_YY) || '',
              work_MM: (window.STATE && STATE.work_MM) || '',
              val: e.record.get(e.field)
            },
            failure: function () {
              e.record.set(e.field, e.originalValue);
              Ext.Msg.alert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨");
            }
          });
        }
      }
    });
    // Docked Items Config ìƒì„±
    function onItemClickHandler(item) {
      ADID = item;
      syncParamsAndReload();
      updateScrollMenuText(item);
    }
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandler);      
    function renderFlagEmoji(v, meta, rec) {
      var colIndex = meta.column.dataIndex;

      // 1. [ë°˜ê¸°] ì»¬ëŸ¼: ê°’ì´ True(ë˜ëŠ” "1", "true")ì¸ ê²½ìš°ë§Œ ì²´í¬
      if (colIndex === 'isBanki') {
        // ì„œë²„ì—ì„œ booleanìœ¼ë¡œ ì˜¤ë”ë¼ë„ ExtJS Modelì´ stringìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬¸ìì—´ ì²´í¬ í¬í•¨
        return (v === true || String(v) === 'true' || String(v) === '1' || v === 'Y') ? "âœ…" : "";
      }

      // 2. [ì „ìì‹ ê³  ì ‘ìˆ˜ì—¬ë¶€] ì»¬ëŸ¼ë“¤ (isKun, isSa, isKi)
      // ì „ì²´ í•©ê³„ê°€ ì•„ë‹ˆë¼, "í•´ë‹¹ í•­ëª©"ì˜ ì‹ ê³ ê¸ˆì•¡ vs ì§€ê¸‰ê¸ˆì•¡ì„ ë¹„êµ
      var whAmt = 0;  // ì›ì²œì§•ìˆ˜ ì‹ ê³ ê¸ˆì•¡
      var payAmt = 0; // ì§€ê¸‰ê¸ˆì•¡

      if (colIndex === 'isKun') {       // ì¼ìš©
        whAmt = rec.get('wh_Kunro') || 0;
        payAmt = rec.get('isKunAmt') || 0;
      } else if (colIndex === 'isSa') { // ì‚¬ì—…
        whAmt = rec.get('wh_sayoup') || 0;
        payAmt = rec.get('isSaAmt') || 0;
      } else if (colIndex === 'isKi') { // ê¸°íƒ€
        whAmt = rec.get('wh_kita') || 0;
        payAmt = rec.get('isKiAmt') || 0;
      }

      // ì¡°ê±´: ì‹ ê³ ê¸ˆì•¡ 0ì´ê³  ì§€ê¸‰ê¸ˆì•¡ë„ 0ì´ë©´ ê³µë€
      if (whAmt === 0 && payAmt === 0) {
        return "";
      }

      // ê¸ˆì•¡ì´ ì¼ì¹˜í•˜ë©´ ì²´í¬ í‘œì‹œ (ë¶ˆì¼ì¹˜ ì‹œ ê³µë€, ë¶ˆì¼ì¹˜ëŠ” isSkele ì»¬ëŸ¼ì—ì„œ ì²˜ë¦¬ë¨)
      return (whAmt === payAmt) ? "âœ…" : "";
    }
    function renderSkeletonEmoji(v, meta, rec){
      // ì§€ê¸‰ê¸ˆì•¡/ì‹ ê³ ê¸ˆì•¡ ëª¨ë‘ 0ì´ë©´ ê³µë€, ë‹¤ë¥´ë©´ í•´ê³¨
      var wh_k = rec.get('wh_Kunro') || 0;
      var wh_s = rec.get('wh_sayoup') || 0;
      var wh_i = rec.get('wh_kita') || 0;
      var kunAmt = rec.get('isKunAmt') || 0;
      var saAmt  = rec.get('isSaAmt') || 0;
      var kiAmt  = rec.get('isKiAmt') || 0;
      var totalWh = wh_k + wh_s + wh_i;
      var totalPay = kunAmt + saAmt + kiAmt;
      if (totalWh === 0 && totalPay === 0) return "";
      return totalWh !== totalPay ? "ğŸ’€" : "";
    }       
    mainGrid = Ext.create('Ext.grid.Panel', {
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      store: mainStore,
      renderTo: renderTarget,
      title: 'ê°„ì´ì§€ê¸‰ëª…ì„¸ì„œ - ì‚¬ì—…,ì¼ìš©,ê¸°íƒ€ / ì¼ìš©ì§ ê·¼ë¡œë‚´ìš©í™•ì¸ì„œ',
      width: '100%',
      height: getGridHeight(),
      columnLines: true,
      viewConfig: {
          getRowClass: function(record, rowIndex, rowParams, store) {
              // ë°ì´í„° ëª¨ë¸ì˜ 'isSkele' ê°’ì´ true(ë˜ëŠ” "true")ì´ë©´ í´ë˜ìŠ¤ ì ìš©
              var isSkele = record.get('isSkele');
              if (isSkele === true || String(isSkele) === 'true') {
                  return 'row-yellow-warning';
              }
              return '';
          }
      },
      features: (ADID === "ì „ì²´"
        ? [{
            id: 'groupManager',
            ftype: 'groupingsummary',
            startCollapsed: false,
            groupHeaderTpl: '{name}',
            hideGroupedHeader: false,
            enableGroupingMenu: true
          }]
        : []),
      plugins: [cellEditing],
      selModel: { selType: 'cellmodel' },
      columns: [
		    {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>',  width: 0}, 
        {  header: 'SEQ', dataIndex: 'seq_no',width: 50        }, 
        {  id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',width: 150	}, 
        { header:'ë°˜ê¸°', dataIndex:'isBanki', width:50, align:'center', renderer: renderFlagEmoji },
        {
          text: 'ì›ì²œì§•ìˆ˜ ì‹ ê³ ê¸ˆì•¡',
          columns: [
            { header: '<center>ì¼ìš©<br>(ì§€ê¸‰ì‹œê¸°)</center>', dataIndex: 'wh_Kunro',  width: 100, xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ì‚¬ì—…ì†Œë“</center>', dataIndex: 'wh_sayoup',  width: 100, xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ê¸°íƒ€ì†Œë“</center>', dataIndex: 'wh_kita',  width: 100, xtype: 'numbercolumn', align:'right',format:'0,000'            }
          ]		}, 
        {
          text: 'ì „ìì‹ ê³  ì ‘ìˆ˜ì—¬ë¶€',
          columns: [
            { header:'ì¼ìš©', dataIndex:'isKun', width:50, renderer: renderFlagEmoji},
            { header: '<center>ì¼ìš©<br>ì§€ê¸‰ê¸ˆì•¡</center>',dataIndex: 'isKunAmt',  width: 100,xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            {	header: '<center>ê·¼ë¡œë‚´ìš©í™•ì¸ì‹ ê³ <br>ì ‘ìˆ˜ë²ˆí˜¸</center>', dataIndex: 'isIlyoung',  width: 150, editor: { allowBlank: true }			}, 
            { header:'ì‚¬ì—…', dataIndex:'isSa',  width:50, renderer: renderFlagEmoji },
            {	header: '<center>ì‚¬ì—…<br>ì§€ê¸‰ê¸ˆì•¡</center>', dataIndex: 'isSaAmt',  width: 100,xtype: 'numbercolumn', align:'right',format:'0,000'			}, 
            { header:'ê¸°íƒ€', dataIndex:'isKi',  width:50, renderer: renderFlagEmoji },
            {	header: '<center>ê¸°íƒ€<br>ì§€ê¸‰ê¸ˆì•¡</center>', dataIndex: 'isKiAmt',  width: 100,xtype: 'numbercolumn', align:'right',format:'0,000'            }
          ]
		    }, 
        {	header: '<center>ì°¨ì´ì›ì¸ì„ ê¸°ë¡í•˜ì„¸ìš”</center>', dataIndex: 'YN_9',   flex: 1, editor: { allowBlank: true }		}, 
        { header:'ì˜¤ë¥˜', dataIndex:'isSkele', width:50, renderer: renderSkeletonEmoji },
      ],
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          padding: '10 0 5 10', // ì—¬ë°±ì„ ì¢€ ë” ì£¼ì–´ ì‹œì›í•˜ê²Œ
          style: { background: '#fff', border: 'none' }, // [ìˆ˜ì •] ì¤‘ê°„ ì„  ì œê±°
          items: [
            ...dockedItemsConfig,
            { xtype: 'tbspacer', width: 20 }, // êµ¬ë¶„ ì—¬ë°±
            {
                xtype: 'buttongroup', 
                columns: 5, 
                frame: false,
                cls: 'custom-btn-group', // ê·¸ë£¹ìš© í´ë˜ìŠ¤ (í•„ìš”ì‹œ)
                bodyStyle: 'background: transparent;', // ë°°ê²½ íˆ¬ëª…
                border: false,
                // [ìˆ˜ì •] defaultsì— ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì ìš©
                defaults: { 
                    enableToggle: true, 
                    toggleGroup: 'yearGroup', 
                    margin: '0 4 0 0', 
                    cls: 'custom-toggle-btn', // â˜… ìœ„ì—ì„œ ì •ì˜í•œ CSS í´ë˜ìŠ¤ ì ìš©
                    height: 32, // ë²„íŠ¼ ë†’ì´ë¥¼ í‚¤ì›Œ í´ë¦­í•˜ê¸° ì‰½ê²Œ
                    width: 60   // ë²„íŠ¼ ë„ˆë¹„ ê³ ì •
                },
                items: Array.from({ length: 5 }, (_, i) => ({
                  text: `${currentYear - i}ë…„`,
                  pressed: currentYear - i === parseInt(work_YY, 10),
                  handler: function () {
                    work_YY = parseInt(this.text.replace('ë…„', ''), 10);
                    // ëª…ì‹œì ìœ¼ë¡œ pressed ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.toggle(true);
                    syncParamsAndReload();
                  }
                }))
            }
          ]
        },
        {
          xtype: 'toolbar', // buttongroupì„ toolbar ì•ˆì— ë„£ê±°ë‚˜ ì§ì ‘ ë°°ì¹˜
          dock: 'top',
          padding: '5 0 5 10',
          style: { background: '#fff', borderBottom: '1px solid #e9edf4' },
          items: [
            {
              xtype: 'buttongroup', 
              columns: 12,
              frame: false,
              bodyStyle: 'background: transparent;',
              border: false,
              // [ìˆ˜ì •] defaultsì— ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ ì ìš©
              defaults: { 
                  enableToggle: true, 
                  toggleGroup: 'monthGroup', 
                  margin: '0 4 0 0', 
                  cls: 'custom-toggle-btn', // â˜… ìœ„ì—ì„œ ì •ì˜í•œ CSS í´ë˜ìŠ¤ ì ìš©
                  height: 32,
                  width: 50
              },
              items: Array.from({ length: 12 }, (_, i) => ({
                  text: `${i + 1}ì›”`,
                  pressed: i + 1 === parseInt(work_MM, 10),
                  handler: function () {
                    work_MM = parseInt(this.text.replace('ì›”', ''), 10);
                    // ëª…ì‹œì ìœ¼ë¡œ pressed ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.toggle(true);
                    syncParamsAndReload();
                  }
              }))
            }
          ]
        }
      ],
      listeners: {
        afterrender: function(grid) {
             Ext.EventManager.onWindowResize(function() {
                 if(grid && !grid.isDestroyed) {
                     grid.setHeight(getGridHeight());
                     grid.doLayout();
                 }
             });
             setTimeout(function(){ grid.updateLayout(); }, 200);
        }
      }      
    });
    if (mainGrid) {
        attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
    }      
    
    // proxy.extraParams ì´ˆê¸°ê°’ ì„¸íŒ… í›„ ì¡°íšŒ
    var initialParams = {
      input_workyear: work_YY,
      work_mm: work_MM,
      ADID: ADID,
      flag: flag
    };
    mainStore.getProxy().extraParams = initialParams;
    console.log('ğŸ“¡ Initial load with params:', initialParams);

    mainStore.load({
      callback: function (records, operation, success) {
        console.log('Store load callback:', { records: records, success: success, recordCount: records ? records.length : 0 });
        if (success) {
          console.log('Data loaded successfully. Record count:', mainStore.getCount());
          if (ADID === "ì „ì²´") {
              // [í•µì‹¬ ìˆ˜ì •] ì´ˆê¸° ë¡œë“œ ì‹œì—ë„ ë°©í–¥ ëª…ì‹œ
              mainStore.group({ property: 'groupManager', direction: 'ASC' });
          }
        } else {
          console.error('Store load failed!', operation);
        }
      }
    });

    // ìƒì„± ì§í›„ ë ˆì´ì•„ì›ƒ 1íšŒ ë³´ì •(íƒ­/ëª¨ë‹¬ íƒ€ì´ë°)
    setTimeout(resizeGrid, 0);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getGridHeight() {
      var height = window.innerHeight - 180;
      return height > 300 ? height : 300;
  }
  function mkParams() {
    return {
      input_workyear: work_YY,
      work_mm: work_MM,
      ADID: ADID
    };
  }

  function resizeGrid() {
    if (!mainGrid) return;
    var wrap = mainGrid.el && mainGrid.el.dom ? mainGrid.el.dom.parentElement : null;
    if (!wrap) return;
    var h = wrap.clientHeight;
    if (h > 50) mainGrid.setHeight(h);
    mainGrid.doLayout();
  }

  Ext.onReady(function () {
    // ìµœì´ˆ active íƒ­ì´ë©´ ë°”ë¡œ ìƒì„±
    buildGrid();

    // íƒ­ ì „í™˜ ì‹œ ìƒì„± + ë¦¬ì‚¬ì´ì¦ˆ
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function (el) {
      el.addEventListener('shown.bs.tab', function () {
        buildGrid();
        resizeGrid();
      });
    });

    window.addEventListener('resize', resizeGrid);
  });
})();

</script>
