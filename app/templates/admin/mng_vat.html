{% load static %}
<style>
.icon-refresh { color: white; }
.modal-xxl { min-width: 1200px; max-width: 1400px; }    
#chartdiv { width: 100%; height: 500px; }
</style>  

<div class="ext-grid-wrapper" style="width:100%;"></div>
            
<div class="modal fade unique-summit-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered" role="document">
    <div class="modal-content modal-content-demo">
      <div class="modal-header ">
        <div class="summitModalTitle"></div> <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body p-0 border-top-0" >
        <div class="tabs-menu4 tabsMenu"></div> <div class="tab-content tabContent"></div> </div>
    </div>
  </div>
</div>	

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>

<script>
(function() {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [1] DOM ìš”ì†Œ í™•ë³´ (ì•ˆì „í•œ ë°©ì‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë‚´ìš©ë¬¼ì´ ì—†ëŠ”(ì•„ì§ ê·¸ë¦¬ë“œê°€ ì•ˆ ê·¸ë ¤ì§„) ë§ˆì§€ë§‰ ë˜í¼ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    var renderTarget = $('.ext-grid-wrapper').filter(function() {
        return $(this).children().length === 0;
    }).last()[0];

    // 2. ëª» ì°¾ì•˜ë‹¤ë©´, í™œì„± íƒ­ ë‚´ë¶€ì—ì„œ ë¹„ì–´ìˆëŠ” ë˜í¼ë¥¼ ë‹¤ì‹œ ì°¾ìŒ (ChatGPT í•´ê²°ì±…)
    if (!renderTarget) {
        renderTarget = $('div.tab-pane.active .ext-grid-wrapper')
            .filter(function () { return $(this).children().length === 0; })
            .last()[0];
    }
    
    // 3. ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    if (!renderTarget) {
        // console.warn('ë Œë” íƒ€ê²Ÿì´ ì—†ì–´ì„œ ê·¸ë¦¬ë“œë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    // ëª¨ë‹¬ ID ìƒì„± ë° í• ë‹¹
    var $wrapper = $(renderTarget).parent(); 
    var modalUniqueId = 'summitModal_' + Math.floor(Math.random() * 100000);
    var $modal = $wrapper.find('.unique-summit-modal');
    $modal.attr('id', modalUniqueId);

    function findInModal(selector) { return $modal.find(selector); }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë†’ì´ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getGridHeight() {
        var height = window.innerHeight - 160;
        return height > 200 ? height : 200;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] ë³€ìˆ˜ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var adminBizLevel = '{{ admin_biz_level }}';
    const isSuperuser = '{{ admin_grade }}' === 'SA';
    var ADID = '{{ ADID }}';        
    var arrADID = JSON.parse('{{ arr_ADID|safe|escapejs }}');
    var flag = '{{ flag }}';
    var work_YY = '{{ request.session.workyearVat }}';
    var work_QT = '{{ request.session.work_QT }}';
    
    if(!work_YY && window.getWorkYearAndMonth){
        work_YY = window.getWorkYearAndMonth('mng_vat').work_YY;
    }
    const currentYear = work_YY;
    let selectedSheetID = null;
    let selectedPeriod = null;
    let selectedSheetName = null;    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [3] í•¨ìˆ˜ ì •ì˜ (Ext.create ì´ì „ì— ì„ ì–¸ í•„ìˆ˜!) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // 1. renderTopic (ì—…ì²´ëª… í´ë¦­ ë Œë”ëŸ¬) - windowì— í• ë‹¹í•˜ì—¬ ì „ì—­ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ í•¨
    window.renderTopic = function(value, p, record) {
        let recordKey = `record_${record.data.seq_no}`;
        window[recordKey] = record.data; 
        const headerText = p.column?.text || '';
        
        return Ext.String.format(
            `<div style="cursor:pointer; color:blue;" 
                onclick="window.summitModal(window['${recordKey}'], ${record.data.seq_no}, '${Ext.String.htmlEncode(record.data.ceo_name)}', '${Ext.String.htmlEncode(record.data.biz_name)}', ${work_YY}, ${work_QT}, 'Vat', '${headerText}')">
                ${Ext.String.htmlEncode(value)}
            </div>`
        );
    };
    // 2. checkboxRender
    var checkboxRender = function(value) { 
        return "<input type='checkbox'" + (value ? "checked='checked'" : "") + ">"; 
    };
    // 3. formatDate
    function formatDate(value){
        return value ? Ext.Date.dateFormat(value, 'y-m-d') : '';
    }
    // 4. summitmodal
    window.summitModal = async function(record, seq_no,  ceo_name, biz_name, work_YY, work_QT, flag, headerText = '') {
      showLoading("loading...");

      let tmpHead = `
        <nav aria-label='breadcrumb'>
          <ol class='breadcrumb breadcrumb-style'>
            <li class='breadcrumb-item'>${biz_name}</li>
            <li class='breadcrumb-item'>${work_YY}ë…„ ${work_QT}ë¶„ê¸°</li>
            <li class='breadcrumb-item active'>ë¶€ê°€ê°€ì¹˜ì„¸ì‹ ê³ </li>
          </ol>
        </nav>
      `;  
      findInModal('.summitModalTitle').html(tmpHead);
 
      // íƒ­ ë©”ë‰´ HTML ìƒì„±
      let prePay = (record.YN_15 > 0) ? record.YN_15 : 0;
      let hasFee = (record.YN_12 > 0);
      let tmpTab = `
        <nav class="nav border-bottom px-4 d-block d-lg-flex flex-2">
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1 active" data-bs-toggle="tab" href="#task-0">ë¶€ê°€ì„¸ì‹ ê³ ì„œ</a>
          ${prePay>0? `
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-8">ì˜ˆì •ê³ ì§€ ì•ˆë‚´</a>
          `: `
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-1">ì‹ ê³ ë„ì›€ ì•ˆë‚´</a>
          `}
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-2">ë¶„ì„</a>
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-3">ê²€ì¦</a>
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-6">í†µí•©ì¡°íšŒ</a>
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-7">ì‹ ê³ ê²°ê³¼ ì•ˆë‚´</a>
          ${hasFee ? `
            <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-4">ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´</a>
          ` : ''}
          <a class="nav-link border border-bottom-0 py-1 br-5 mx-1 mx-md-1" data-bs-toggle="tab" href="#task-5">ë³´ë‚¸ ë©”ì¼</a>
        </nav>
      `;
      let tmpTab_Content = `
        <!--  #0 . ì‹ ê³ ì„œ  -->
        <div class="tab-pane active task-files-tab" id="task-0">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3 mt-2 ps-5" style="flex-basis: 35%;">
              <div class="btn-group">
                <button id="btn_selectedYear"  type="button" class="btn btn-info dropdown-toggle mb-2" data-bs-toggle="dropdown">
                  ${work_YY} ë…„ <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li class="dropdown-plus-title">
                    ì‘ì—…ì—°ë„
                    <b class="fa fa-angle-up" aria-hidden="true"></b>
                  </li>
                  <div class="list-group">
                    {% for node in vatYears %}
                      <li class="list-group-item list-group-item-action">
                        <a href="javascript:handleButtonClose(${seq_no}, '${ceo_name}', '${biz_name}',{{ node }})">{{ node }}ë…„</a>
                      </li>
                    {% endfor %}
                  </div>
                </ul>
              </div>          
              <div class="panel-group1" id="accordionLeft" role="tablist" aria-expanded="false" style="max-height: 860px; overflow-y: auto;"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 65%;">
              <div class="card-body" >
                <iframe id="singoseoPDFIframe" width="100%" height="850px" frameborder="0"></iframe>
              </div>
            </div>
          </div>              
        </div>
        <!--  #1 . ì‹ ê³ ë„ì›€  -->
        <div class="tab-pane task-files-tab" id="task-1">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
              <div class="container" id = "VatIntro"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 50%;">
              <div class="card-body" >
                <iframe id="VatIntroPDFIframe" width="100%" height="800px" frameborder="0"></iframe>
              </div>
            </div>
          </div>              
          <div class="modal-footer justify-content-center" id="btnKakaoSend1"></div>
        </div>
        <!--  #8 . ì˜ˆì •ê³ ì§€  -->
        <div class="tab-pane task-files-tab" id="task-8">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
              <div class="container" id = "VatPrepay"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 50%;">
              <div class="card-body" >
                <iframe id="VatPrepayPDFIframe" width="100%" height="800px" frameborder="0"></iframe>
              </div>
            </div>
          </div>              
          <div class="modal-footer justify-content-center" id="btnKakaoSend9"></div>
        </div>    
        <!-- #2. ë¶„ì„  -->
        <div class="tab-pane task-files-tab" id="task-2">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 60%;">
              <div class="card">
                <div class="card-body">
                  <div class="sales-stats d-flex">
                    <div>
                      <div class="text-muted fs-13">
                        <span class="p-2 br-5 text-success ms-3"><i class="fe fe-alert-circle"></i></span>
                        ë§‰ëŒ€ê·¸ë˜í”„ë¥¼ í´ë¦­í•˜ì‹œë©´ í•´ë‹¹ ê¸°ìˆ˜ë³„ ìƒì„¸ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                      </div>
                    </div>
                  </div>

                  <!-- chart ì˜ì—­ -->
                  <div id="chartdiv" style="height: 400px;"></div>

                  <!-- ì¹´ë“œ 2ê°œ ë‚˜ë€íˆ -->
                  <div class="d-flex mt-4 gap-3">
                    <!-- ì™¼ìª½ ì¹´ë“œ: íƒ­ íŒ¨ë„ -->
                    <div class="card flex-fill">
                      <div class="card-body">
                        <div class=" tab-menu-heading border-bottom-0 ms-3" style="border-left:0px">
                          <div class="tabs-menu1 ">
                            <ul class="nav panel-tabs">
                              <li><a id="anchor1" href="#tab1" data-bs-toggle="tab" class="active me-1 text-default my-1" >ë§¤ì¶œë‚´ì—­</a></li>
                              <li><a id="anchor2" href="#tab2" data-bs-toggle="tab" class="me-1 text-default my-1">ë§¤ì…ë‚´ì—­</a></li>
                            </ul>
                          </div>
                        </div>
                        <div class="panel-body tabs-menu-body border-1  mb-0">
                          <div class="tab-content" id="tabContent_SaleCost"></div>
                        </div>
                      </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ: ì ê²€ì‚¬í•­ -->
                    <div class="card flex-fill">
                      <div class="card-header border-bottom d-flex align-items-center">
                        <h4 class="card-title fw-semibold mb-0">ì ê²€ì‚¬í•­</h4>
                        <a href="#" class="ms-auto" id="anchor3">ìì„¸íˆ</a>
                      </div>
                      <div class="card-body p-2" id="divListGroup">
                        <!-- ì ê²€ ë¦¬ìŠ¤íŠ¸ ë‚´ìš© -->
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 40%;">
              <div class="card-body" >             
                <div id="donut_sale" style="width: 100%; height: 300px;"></div>    
                <div id="donut_cost" style="width:100%; height:300px; margin-top:20px;"></div>

              </div>
            </div>        
          </div>              
          <div class="modal-footer justify-content-center" id="btnKakaoSend2"></div>
        </div>    
        <!-- #3. ê²€ì¦ -->
        <div class="tab-pane task-files-tab" id="task-3">
          <div class="d-flex">
            <div class="flex-grow-1 ps-5 mt-5 d-flex flex-column" style="flex-basis: 20%; height: 100%;">
              <div id="InspectVat_LeftTop" class="card-body bg-primary-transparent p-3 " style="max-height: 500px; overflow-y: auto;"></div>
              <div id="InspectVat_LeftBottom" class="card-body bg-light-transparent p-3" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 80%;">
              <div class="card-body" >
                <div class="container" id = "InspectVat_Right"></div>
              </div>
            </div>
          </div>              
        </div>    
        <!-- #6. í†µí•©ì¡°íšŒ -->
        <div class="tab-pane task-files-tab" id="task-6">
          <div class="d-flex">
            <div class="flex-grow-1 ps-5 mt-5 d-flex flex-column" style="flex-basis: 20%; height: 100%;">
              <div id="tongVat_LeftTop" class="card-body bg-primary-transparent p-3 " style="max-height: 700px; overflow-y: auto;"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 80%;">
              <div class="card-body" >
                <div class="container" id = "TongVat_Right"></div>
              </div>
            </div>
          </div>              
        </div>      
        <!-- #7. ì‹ ê³ ê²°ê³¼  -->
        <div class="tab-pane task-files-tab" id="task-7">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
              <div class="container" id = "VatResult"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 50%;">
              <div class="card-body" >
                <iframe id="VatResultPDFIframe" width="100%" height="800px" frameborder="0"></iframe>
              </div>
            </div>        
          </div>              
          <div class="modal-footer justify-content-center" id="btnKakaoSend7"></div>
        </div>    
        <!-- #4. ìˆ˜ìˆ˜ë£Œ  -->
        <div class="tab-pane task-files-tab" id="task-4">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 70%;">
              <div class="container" id = "feeDiagnosys"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 30%;">
              <div class="card-header border-bottom">
                <h4 class="card-title fw-bold" id = "FeeHeader">ë¯¸ìˆ˜ ìˆ˜ìˆ˜ë£Œ ì²­êµ¬í•˜ê¸°</h4>
              </div>
              <div class="card-body" >
                <div class="container" id = "unpaidList"></div>
              </div>
            </div>
          </div> 
          <div class="modal-footer justify-content-center" id="btnKakaoSend8"></div>
        </div>
        <!-- #5. ë³´ë‚¸ë©”ì¼  -->
        <div class="tab-pane  task-files-tab" id="task-5">
          <div class="d-flex">
            <div class="flex-grow-1 pe-3" style="flex-basis: 50%;">
              <div class="container" id = "sentMailTable"></div>
            </div>
            <div class="flex-grow-0" style="flex-basis: 50%;">
              <div class="card-body" >
                <iframe id="mailIframe" width="100%" height="850px" frameborder="0"></iframe>
              </div>
            </div>
          </div>    
        </div>  
      `;
      
      // ëª¨ë‹¬ ë‚´ë¶€ DOM ì—…ë°ì´íŠ¸
      findInModal('.tabsMenu').html(tmpTab); 
      findInModal('.tabContent').html(tmpTab_Content);

      $modal.modal('show');
      // â± í—¤ë” í…ìŠ¤íŠ¸ì— ë”°ë¥¸ íƒ­ ID ë§¤í•‘
      const headerToTabId = {
        'ì—…ì²´ëª…': 'task-0',
        'ê²€ì¦ê²°ê³¼': 'task-3',
        'í†µí•©ì¡°íšŒ': 'task-6',
        'ë©”ì¼í†µë³´': 'task-5'
      };

      const tabId = headerToTabId[headerText] || 'task-0';
      setTimeout(() => {
        const $targetTab = $(`[data-bs-toggle="tab"][href="#${tabId}"]`);
        if ($targetTab.length) {
          $targetTab.tab('show');
        }
      }, 100);  

      await treeLoad(ADID,seq_no,ceo_name,biz_name,work_YY);   //#0 ì‹ ê³ ì„œë³´ê¸°
      if(prePay>0){
        await setMailContent(seq_no,work_YY,work_QT,'VatPrepay');   //#8. ì˜ˆì •ê³ ì§€ë©”ì¼ ë‚´ìš©ìƒì„±
        await setPDFIframe(ADID, seq_no,ceo_name,biz_name,work_YY,work_QT,'VatPrepay');  //#8. ì˜ˆì •ê³ ì§€ ì„œë¹„ìŠ¤ íŒŒì¼ ë¡œë”©
      }else{
        await setMailContent(seq_no,work_YY,work_QT,'VatIntro');   //#1. ì•ˆë‚´ë©”ì¼ ë‚´ìš©ìƒì„±
        await setPDFIframe(ADID, seq_no,ceo_name,biz_name,work_YY,work_QT,'VatIntro');  //#1. ì‹ ê³ ë„ì›€ ì„œë¹„ìŠ¤ íŒŒì¼ ë¡œë”©
      }

      await setPDFIframe(ADID, seq_no,ceo_name,biz_name,work_YY,work_QT,'VatResult');  //#7. ë‚©ë¶€ì„œ
      setAnaly(record, seq_no, work_YY, work_QT); //2. ë¶„ì„
      setInspectVat_LeftTop(record, seq_no, work_YY, work_QT); //3. ê²€ì¦
      setTongVat_LeftTop(record, seq_no, work_YY, work_QT); //6. í†µí•©ì¡°íšŒ
      setFee(record,seq_no,work_YY,work_QT);      //4. í• ì¸ìœ¨ ì ìš©

      // #1.ì‹ ê³ ë„ì›€ í•˜ë‹¨ ë³´ë‚´ê¸°ë²„íŠ¼  
      let tmpBtn1 = `<button class="btn btn-info" onclick="sendMailAndKakao('${ADID}',${seq_no},'${ceo_name}','${biz_name}', ${work_YY}, ${work_QT}, 'VatIntro')">
        <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
        </button> 
        <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
      $('[id="btnKakaoSend1"]').html(tmpBtn1);     
      // #8. ì˜ˆì •ê³ ì§€ í•˜ë‹¨ ë³´ë‚´ê¸°ë²„íŠ¼  
      let tmpBtn8 = `<button class="btn btn-info" onclick="sendMailAndKakao('${ADID}',${seq_no},'${ceo_name}','${biz_name}', ${work_YY}, ${work_QT}, 'VatPrepay')">
        <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
        </button> 
        <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
      $('[id="btnKakaoSend9"]').html(tmpBtn8);     
      //#2. ê²°ê³¼ì•ˆë‚´ í•˜ë‹¨ ë³´ë‚´ê¸°ë²„íŠ¼
      await setMailContent(seq_no, work_YY, work_QT, 'VatResult');  
      let tmpBtn2 = `<button class="btn btn-info" onclick="sendMailAndKakao('${ADID}',${seq_no},'${ceo_name}','${biz_name}', ${work_YY}, ${work_QT}, 'VatResult')">
        <i class="fa fa-envelope" style="color: black;"></i> <i class="fa fa-comment" style="color: black;"></i> ë©”ì¼ê³¼ ì¹´í†¡ í•¨ê»˜ë°œì†¡
        </button> 
        <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
      $('[id="btnKakaoSend7"]').html(tmpBtn2);   
      //#4. ìˆ˜ìˆ˜ë£Œë©”ì¼ ì‘ì„±
      await setMailContent(seq_no, work_YY, work_QT, 'VatFee');     
      let tmpBtn4 = `<button class="btn btn-warning" onclick="sendMailAndKakao('${ADID}',${seq_no},'${ceo_name}','${biz_name}', ${work_YY}, ${work_QT}, 'VatFee')">
        <i class="fa fa-comment" style="color: black;"></i> ìˆ˜ìˆ˜ë£Œ ì¹´í†¡(ë¬¸ì) ë³´ë‚´ê¸°
        </button> 
        <button class="btn btn-light" data-bs-dismiss="modal">ë‹«ê¸°</button>`;
      $('[id="btnKakaoSend8"]').html(tmpBtn4);   // ìˆ˜ìˆ˜ë£Œì•ˆë‚´ í•˜ë‹¨ ë³´ë‚´ê¸°ë²„íŠ¼   
      //#5. ë³´ë‚¸ë©”ì¼ í™•ì¸í•˜ê¸°
      await sentMailList(seq_no, flag,"{% url 'getSentMails' %}");  
      hideLoading(); // ë¡œë”© ë§ˆìŠ¤í¬ ìˆ¨ê¹€
    };
    // 5. check í•¨ìˆ˜ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ)
    window.check = function(seq_no, target, wYY, wQT, val) {
        $.ajax({
            url: "{% url 'mng_vat_update' %}",
            type: "POST",
            data: {
                seq_no: seq_no, target: target, work_YY: wYY, work_QT: wQT, val: val,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function(res) { if(res.status !== "success") console.error(res.message); }
        });
    };

    var store = Ext.create('Ext.data.Store', {
        storeId: 'vatStore_' + Math.random(),
        autoLoad: true, // Storeê°€ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¡œë“œ
        proxy: {
            type: 'ajax', // Ajaxë¥¼ í†µí•´ ì„œë²„ì™€ í†µì‹ 
            url: '{% url "mng_vat" %}', // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ API URL
            extraParams: {
                ADID:ADID,
                work_YY:work_YY,
                work_QT:work_QT
            },        
            reader: {
                type: 'json', // ì„œë²„ì—ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜
                rootProperty: 'data', // ì‘ë‹µ JSONì—ì„œ ë°ì´í„° ë°°ì—´ì˜ ì†ì„± ì´ë¦„
                totalProperty: 'total', // ì‘ë‹µ JSONì—ì„œ ì „ì²´ ë°ì´í„° ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì†ì„± ì´ë¦„
            },
        },   
        fields: [ // í•„ë“œ ì •ì˜ (ë°ì´í„°ì˜ ê° ì—´)
            {name: 'groupManager',type: 'string'},
            {name: 'seq_no'},
            {name: 'ceo_name', type: 'string'}, 
            {name: 'biz_name', type: 'string'}, 
            {name: 'biz_type', type: 'string'}, 
            {name: 'YN_7', type: 'bool'},   //ìˆ˜ê¸°ìë£Œ
            {name: 'YN_8',type: 'bool'},    //ì‹ ê³ ì„œ
            {name: 'Tel_sincaSale', type: 'string'},
            {name: 'mailSent', type: 'string'},		//ë©”ì¼í†µë³´
            {name: 'kakao', type: 'string'},		//ì¹´í†¡í†µë³´
            {name: 'SMS', type: 'string'},		//ë¬¸ìí†µë³´
            {name: 'YN_14',type: 'string'},		//í†µí•©ì¡°íšŒ
            {name: 'YN_15',type: 'string'},		//ì˜ˆì •ê³ ì§€
            {name: 'YN_18',type: 'string'},		//ë‚©ë¶€/í™˜ê¸‰ì„¸ì•¡
            {name: 'YN_10',type: 'bool'},     //ê²°ì¬ì™„ë£Œ
            {name: 'YN_13',type: 'string'},   //ë¹„ê³ 
            {name: 'isIssue', type: 'string'},
            {name: 'inspect_issue', type: 'string'},
            {name: 'inspect_elec', type: 'string'},
            {name: 'inspect_labor', type: 'string'},
            {name: 'JupsuID',type: 'string'},
            {name: 'YN_12',type: 'number'},   //ìˆ˜ìˆ˜ë£Œ
            {name: 'YN_11',type: 'bool'},     //ìˆ˜ê¸ˆ
            {name: 'YN_1',type: 'date', dateFormat: 'Y-m-d'},     //ê²°ì¬ì¼
            {name: 'YN_2',type: 'bool'},         //ë°œí–‰
            {name: 'YN_3', type: 'date', dateFormat: 'Y-m-d'},       //ë°œí–‰ì¼
            {name: 'YN_4',type: 'bool'},         //ì…ê¸ˆ
            {name: 'YN_5',type: 'bool'},         //ì¹´ë“œ
            {name: 'YN_6',type: 'bool'},         //cms
            {name: 'YN_Kisu',type: 'string'}
        ],
        ... (ADID === "ì „ì²´" ? { groupField: 'groupManager' } : {}) // âœ… ADIDê°€ "ì „ì²´"ì¼ ë•Œë§Œ groupField ì¶”ê°€
    });
    var comboDataStore = Ext.create('Ext.data.Store', {
        fields: ['id', 'name'],
        data: [] // ì´ˆê¸° ë°ì´í„°ëŠ” ë¹„ì›Œë‘ 
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [4] ì´ˆê¸°í™” ë° ê·¸ë¦¬ë“œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (isSuperuser){
        Ext.Ajax.request({
            url: '{% url "kijang_admin_combolist" %}',
            method: 'GET',
            success: function (response) { comboDataStore.loadData(Ext.decode(response.responseText)); }
        });
    }
    
    // ë„ì»¤ í•¸ë“¤ëŸ¬ (í•„í„° ìœ ì§€)
    const onItemClickHandlerWithFilter = function(newADID) {
        ADID = newADID;
        store.getProxy().extraParams.ADID = ADID;
        store.load();
        updateScrollMenuText(newADID);        
    };
    const dockedItemsConfig = createDockedItemsConfig(adminBizLevel, arrADID, ADID, onItemClickHandlerWithFilter);

    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
      clicksToEdit: 1,
      listeners: {
          edit: function (editor, e) {
              var field = e.field; 
              var value = e.value; 
              if (field === "Tel_sincaSale" && value === null) value = "";
              Ext.Ajax.request({
                  url: "{% url 'mng_vat_update' %}",
                  method: "POST",
                  params: {
                      seq_no: e.record.get('seq_no'),
                      target: target,
                      work_YY: work_YY,
                      work_QT: work_QT,
                      val: value,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                  },
                  success: function (response) {
                    Swal.fire({
                      title: 'ì‘ì—… ì„±ê³µ',
                      text: 'ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                      icon: 'success',
                      timer: 500,  // Set the timer to 3 seconds (3000 ms)
                      showConfirmButton: false,  // Hide the confirm button
                      willClose: () => {
                        // Optional: Perform any other action after the alert closes
                      }
                    });
                  },
                  failure: function (response) {
                    Swal.fire("ì˜¤ë¥˜", "ì „ì†¡ì˜¤ë¥˜ : " + response.message, "error");
                  }
              });
          }
      }
    });
    var mainGrid = Ext.create('Ext.grid.Panel', {
      renderTo: renderTarget,
      title: '{{ gridTitle }}',
      //header: false,  // í˜„ëŒ€ì  ë””ìì¸ (í—¤ë” ìˆ¨ê¹€)
      width:'100%',
      height: getGridHeight(),
      scrollable: 'y', // ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™”
      store: store,
      columnLines: true,
      loadMask : {msg: 'Loading Data...', msgCls: 'some-css-class'},
      tools: [  //ìµœìƒë‹¨ ì˜¤ë¥¸ìª½ íˆ´ë°”
          {
            xtype: 'button',
            text: 'ì ‘ìˆ˜ë²ˆí˜¸ì €ì¥',
            iconCls: 'fa fa-floppy-o',
            handler: function (btn) {
              Ext.create('Ext.window.Window', {
                title: 'ë°ì´í„° ë¶™ì—¬ë„£ê¸°',
                modal: true,
                frame:false,
                width: 800,
                height: 200,
                layout: 'fit',
                items: [{
                    xtype: 'textarea',
                    name: 'clipboardData',
                    emptyText: 'í™ˆíƒìŠ¤ ì „ìì‹ ê³  ê²°ê³¼ë¥¼ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'
                }],
                buttons: [
                  {
                    text: 'ì €ì¥',
                    handler: function(btn) {
                        var win = btn.up('window');
                        var clipboardData = win.down('textarea').getValue();
                        Ext.Ajax.request({
                          url: "{% url 'save_clipboard_Vat' %}",
                          method: 'POST',
                          params: {
                              clipboardData: clipboardData,
                              csrfmiddlewaretoken: "{{ csrf_token }}"
                          },
                          success: function(response) {
                            win.close();
                            Swal.fire({
                              title: 'ì‘ì—… ì„±ê³µ',
                              text: 'ì „ìì‹ ê³ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                              icon: 'success',
                              //timer: 500,  // Set the timer to 3 seconds (3000 ms)
                              showConfirmButton: true,  // Hide the confirm button
                              willClose: () => {
                                let store = Ext.getCmp('mainGrid').getStore();
                                Ext.each(response.sqnos, function (item) {
                                    let record = store.findRecord('seq_no', item.seq_no);
                                    if (record) {
                                        record.set('isIssue', "ğŸ’™"); // userIDì˜ ë§ˆì§€ë§‰ ë‘ ìë¦¬
                                    }
                                });
                                store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                              }
                            });                              
                          },
                          failure: function(response) {
                            Swal.fire("ì˜¤ë¥˜", "ì €ì¥ì˜¤ë¥˜ : " + response.message, "error");
                          }
                        });
                        win.close();
                    }
                  },
                  {
                    text: 'ì·¨ì†Œ',
                    handler: function(btn) {
                        btn.up('window').close();
                    }
                  }]
              }).show();
            },
            style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },      
          {
            xtype: 'button',
            text: 'ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œ',
            iconCls: 'fa fa-cloud-upload',
            handler: function () {
              let uploadWindow = Ext.create('Ext.window.Window', {
                    title: 'íŒŒì¼ ì—…ë¡œë“œ',
                    modal: true,
                    layout: 'fit',
                    items: [{
                        xtype: 'form',
                        bodyPadding: 10,
                        fileUpload: true,
                        items: [{
                            xtype: 'filefield',
                            name: 'uploadFile',
                            fieldLabel: 'íŒŒì¼ ì„ íƒ',
                            labelWidth: 70,
                            msgTarget: 'side',
                            allowBlank: false,
                            anchor: '100%',
                            buttonText: 'íŒŒì¼ ì°¾ê¸°...'
                        }],
                        buttons: [{
                            text: 'ì—…ë¡œë“œ',
                            handler: function (btn) {
                                var form = btn.up('form').getForm();
                                if (form.isValid()) {
                                  form.submit({
                                    url: "{% url 'save_elecfile_Vat' %}", // Django ì—…ë¡œë“œ URL
                                    params: {
                                        csrfmiddlewaretoken: "{{ csrf_token }}"
                                    },
                                    waitMsg: 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...',
                                    success: function (form, action) {
                                        Ext.Msg.alert('ì„±ê³µ', 'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                        let response = action.result;
                                        uploadWindow.close();
                                        let store = Ext.getCmp('mainGrid').getStore();
                                        let record = store.findRecord('seq_no', response.seq_no);
                                        record.set('JupsuID', response.userID.slice(-2));  
                                        store.commitChanges(); // ë³€ê²½ ì‚¬í•­ ì ìš©
                                    },
                                    failure: function (form, action) {
                                        Ext.Msg.alert('ì‹¤íŒ¨', 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                                    }
                                  });
                                }
                            }
                        }]
                    }]
                }).show();
            },
            style: 'margin-right: 10px;'
          },              
          {
              xtype: 'textfield',
              emptyText: 'ê²€ìƒ‰ì–´ ì…ë ¥',
              width: 200,
              listeners: {
                  change: function (field, newValue) {
                      const store = field.up('grid').getStore(); // ê·¸ë¦¬ë“œì˜ ìŠ¤í† ì–´ ê°€ì ¸ì˜¤ê¸°
                      if (!newValue || newValue.trim() === '') {
                          store.clearFilter(); // í•„í„° ì œê±°
                      } else {
                          store.clearFilter(true); // ê¸°ì¡´ í•„í„° ì œê±°
                          const searchValue = newValue.trim().toLowerCase();
                          store.filterBy(record => {
                              const bizName = record.get('biz_name')?.toLowerCase() || '';
                              return (
                                bizName.includes(searchValue) 
                              );
                          });
                      }
                  }
              }
              
          },
          {
              xtype: 'button',
              iconCls: 'icon icon-refresh',
              handler: function (btn) {
                  location.reload();
              },
              style: 'margin-right: 10px;' // ì˜¤ë¥¸ìª½ ê°„ê²© ì¶”ê°€
          },
      ],            
      ... (ADID === "ì „ì²´" ? { 
            features: [{
                id: 'groupManager',
                ftype: 'groupingsummary',
                startCollapsed: false,
                groupHeaderTpl: '{name}',
                hideGroupedHeader: false,
                enableGroupingMenu: true
            }]
        } : {}),        
      plugins: [cellEditing],
      columns: [
        {   xtype: 'rownumberer',width: 0,	sortable: false}, 
        {   dataIndex: 'groupManager',header: '<center>ê´€ë¦¬ì</center>', hidden:true       }, 
        {   header: 'SEQ', dataIndex: 'seq_no',width: 50        }, 
        {   header: 'ceo_name', dataIndex: 'ceo_name',width: 0        }, 
        {   id: 'biz_name',header: '<center>ì—…ì²´ëª…</center>', dataIndex: 'biz_name',flex:1,minWidth: 130,renderer: renderTopic 
        },{   header: '<center>ìœ í˜•</center>', dataIndex: 'biz_type',  width: 60,align:'center'  ,      
              renderer: function (value) {
                  if (value === '1') return '<i class="mdi mdi-domain" style="color: green;"></i>';
                  if (value === '2') return '<i class="mdi mdi-domain" style="color: red;">ë©´ì„¸</i>';
                  if (value === '3') return '<i class="mdi mdi-domain" style="color: red;">ë¹„ì˜ë¦¬</i>';
                  if (value === '4') return '<i class="mdi mdi-account" style="color: green;"></i>';
                  if (value === '5') return '<i class="mdi mdi-account-outline" style="color: blue;">ê°„ì´</i>';
                  if (value === '6') return '<i class="mdi mdi-account-outline" style="color: red;">ë©´ì„¸</i>';
                  return '<i class="mdi mdi-account-off" style="color: red;">ë¹„ì‚¬ì—…</i>';
              }
        }, {   
          header: '<center>ë°©ë¬¸<br>ìë£Œ</center>', dataIndex: 'YN_4',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, width: 40,align:'center',
          listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'YN_4',work_YY,work_QT,checked);	}}
        }, {
          header: '<center>ë§¤ì¶œ<br>ë§¤ì…</center>', dataIndex: 'YN_5',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, width: 40,align:'center',
          listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'YN_5',work_YY,work_QT,checked);	}}
        }, {   
          header: '<center>ì¹´ë“œ<br>ë§¤ì¶œ</center>', dataIndex: 'YN_6',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, width: 40,align:'center',
          listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'YN_6',work_YY,work_QT,checked);	}}              
        }, {
          header: '<center>ì¹´ë“œ<br>ë§¤ì…</center>', dataIndex: 'YN_7',  xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
          listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'YN_7',work_YY,work_QT,checked);	}}
        }, {
          header: '<center>ì‹ ê³ <br>ì„œ</center>', dataIndex: 'YN_8',  xtype: 'checkcolumn',renderer : checkboxRender, width: 40,
          listeners: {checkchange: function (column, recordIndex, checked) {	check(store.getAt(recordIndex).get('seq_no'),'YN_8',work_YY,work_QT,checked);	}}
        },{
          header: '<center>ì£¼ì˜ì‚¬í•­</center>', dataIndex: 'Tel_sincaSale',  width: 150,  align:'left', editor: { allowBlank: true }, renderer:tooltipRenderer2
        },{
          header: '<center>ì˜ˆì •ê³ ì§€</center>', dataIndex: 'YN_15',  width: 80,xtype: 'numbercolumn', align:'right',format:'0,000', editor: { allowBlank: false }
        }, {
          header: '<center>ë‚©ë¶€ì„¸ì•¡<br>(í™˜ê¸‰ì„¸ì•¡)</center>', dataIndex: 'YN_18',  width: 90,xtype: 'numbercolumn', align:'right',format:'0,000', editor: { allowBlank: false }
        }, {
          header: '<center>ê²°ì¬</center>', dataIndex: 'YN_10', width: 40,align:'center',
          xtype:  (isSuperuser) ? 'checkcolumn' : 'gridcolumn',
          renderer: (isSuperuser) ? checkboxRender : function (value) {
              return value ? "âœï¸" : '';  //  ê°’ì´ trueì´ë©´ âœï¸, falseì´ë©´ ë¹ˆ ë¬¸ìì—´
          },
          listeners: (isSuperuser) ? {
              checkchange: function (column, recordIndex, checked) {
                  check(store.getAt(recordIndex).get('seq_no'), 'YN_10', work_YY,work_QT, checked);
              }
          } : {}
        }, {
          header: '<center>ê²€ì¦<br>ê²°ê³¼</center>', dataIndex: 'inspect_issue',  width: 35,
          renderer: function (value, metaData, record) {
            if (!value) return ''; // ê°’ ì—†ìœ¼ë©´ ê³µë°±

            const issue_arr = value.split('#');
            let tooltipText = '';
            let feelingGrade = 0
            issue_arr.forEach(issueCode => {
              const code = parseInt(issueCode, 10);
              if (!isNaN(code)) {
                switch (code) {
                  case 1:
                    feelingGrade += 1;
                    break;
                  case 2:
                    tooltipText += '<b>*</b> í™ˆíƒìŠ¤ì—ì„œ ì¡°íšŒëœ ì‹ ìš©ì¹´ë“œ+í˜„ê¸ˆì˜ìˆ˜ì¦<br>ë§¤ì¶œê³¼ ì‹ ê³ ì„œ ì‘ì„±ê¸ˆì•¡ ì°¨ì´<br>';
                    feelingGrade += 1;
                    break;
                  case 3:
                    tooltipText += '<b>*</b> ì˜ˆì •ê³ ì§€ ë˜ëŠ” ë¯¸í™˜ê¸‰ì„¸ì•¡ì„ ì‹ ê³ ì„œì—<br>ë°˜ì˜í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ë°˜ì˜í•˜ë©´ ì•ˆë˜ëŠ” í™˜ê¸‰ê¸ˆì„ ë°˜ì˜í•˜ì˜€ìŒ<br>';
                    feelingGrade += 1;
                    break;
                  case 4:
                    tooltipText += '<b>*</b> ì§ì „ ì‹ ê³ ê¸°ê°„ì— ì¢…ì´ ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œê°€<br>ìˆì—ˆìœ¼ë‹ˆ ë‹¹ê¸° ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œ í™•ì¸<br>';
                    feelingGrade += 1;
                    break;
                  case 5:
                    tooltipText += '<b>*</b> ë©´ì„¸ë§¤ì¶œì´ ìˆìœ¼ë‚˜ ê³µí†µë§¤ì…ì„¸ì•¡<br>ì•ˆë¶„ê³„ì‚°ì„ í•˜ì§€ ì•Šì•˜ìŒ<br>';
                    feelingGrade += 1;
                    break;
                  case 6:
                    tooltipText += '<b>*</b> ì‹ ìš©ì¹´ë“œë°œí–‰ì„¸ì•¡ê³µì œ í•œë„ ì´ˆê³¼<br>';
                    feelingGrade += 1;
                    break;
                  case 7:
                    tooltipText += '<b>*</b> ë§¤ì¶œì„¸ê¸ˆê³„ì‚°ì„œ ì¤‘ ì „ìì™¸ ë°œí–‰ë¶„ ì¬ê²€í† <br>';
                    feelingGrade += 1;
                    break;
                  case 8:
                    tooltipText += '<b>*</b> ì§ì „ ê³¼ì„¸ê¸°ê°„ì— ê±´ë³„ë§¤ì¶œì´ ìˆì—ˆìœ¼ë‹ˆ<br>ë‹¹ê¸° í˜„ê¸ˆ ê±´ë³„ ë˜ëŠ” ì˜¨ë¼ì¸ ë§¤ì¶œ í™•ì¸ìš”ë§<br>';
                    feelingGrade += 1;
                    break;
                  case 9:
                    tooltipText += '<b>*</b> í™˜ê¸‰ì•¡ 500ë§Œì› ì´ˆê³¼ë¡œ<br>í™˜ê¸‰ì¡°ì‚¬ ëŒ€ë¹„ í™•ì¸<br>';
                    feelingGrade += 1;
                    break;
                  case 10:
                    tooltipText += '<b>*</b> ì§ì „ ê³¼ì„¸ê¸°ê°„ì— ì˜ì œë§¤ì…ê³µì œê°€ ìˆì—ˆìœ¼ë‚˜<br>ë‹¹ê¸°ì—ëŠ” ë¯¸ì ìš©í–ˆìœ¼ë‹ˆ í™•ì¸ìš”ë§<br>';
                    feelingGrade += 1;
                    break;
                  case 11:
                    tooltipText += '<b>*</b> ì§ì „ ê³¼ì„¸ê¸°ê°„ì— ì¬í™œìš©íìì›ê³µì œê°€ ìˆì—ˆìœ¼ë‚˜<br>ë‹¹ê¸°ì—ëŠ” ë¯¸ì ìš©í–ˆìœ¼ë‹ˆ í™•ì¸ìš”ë§<br>';
                    feelingGrade += 1;
                    break;
                  case 12:
                    tooltipText += '<b>*</b> ì§ì „ ê³¼ì„¸ê¸°ê°„ì— ë¶ˆê³µì œ ë§¤ì…ì´ ìˆì—ˆìœ¼ë‚˜<br>ë‹¹í•´ ì‹ ê³ ì‹œëŠ” ë°œìƒí•˜ì§€ ì•ŠìŒ<br>';
                    feelingGrade += 1;
                    break;
                }
              }
            });
            metaData.tdAttr = Ext.String.format('data-qtip="{0}"', tooltipText);
            const emojis = {
                0: "âŒ",  // value = -1
                5: "ğŸ˜¡",
                1: "âœ…", 
                2: "âš ï¸",  
                3: "âš ï¸",   
                4: "âš ï¸"   
            };
            const emoji = emojis[feelingGrade] || "âŒ";
            return Ext.String.format(
              `<div style="cursor:pointer;" onclick="summitModal(window['record_{0}'], {0}, '{1}', '{2}', {3}, {4}, 'Vat', 'ê²€ì¦ê²°ê³¼');">
                {5}
              </div>`,
              record.data.seq_no,
              Ext.String.htmlEncode(record.data.ceo_name),
              Ext.String.htmlEncode(record.data.biz_name),
              work_YY,
              work_QT,
              emoji
            );
          }
        }, {
          header: '<center>í†µí•©<br>ì¡°íšŒ</center>', dataIndex: 'YN_14',  width: 40, align:'center',
          renderer: function(value, metaData, record) {
            const intVal = parseInt(value, 10); // âœ… ë¬¸ìì—´ì„ ì •ìˆ˜ë¡œ ë³€í™˜
            let feelingGrade = 4 - intVal;
            if (feelingGrade<1){
              feelingGrade = 1;
            }
            const kisu = record.get('YN_Kisu');
            if (kisu==""){
              feelingGrade = 0;
            }
            const emojis = {
                0: "âŒ",  // value = -1
                5: "ğŸ“Œ",
                4: "âœ…", 
                3: "ğŸ˜„",  
                2: "ğŸ˜",   
                1: "ğŸ˜¡"   
            };
            const emoji = emojis[feelingGrade] || "âŒ";
            return Ext.String.format(
              `<div style="cursor:pointer;" onclick="summitModal(window['record_{0}'], {0}, '{1}', '{2}', {3}, {4}, 'Vat', 'í†µí•©ì¡°íšŒ');">
                {5}
              </div>`,
              record.data.seq_no,
              Ext.String.htmlEncode(record.data.ceo_name),
              Ext.String.htmlEncode(record.data.biz_name),
              work_YY,
              work_QT,
              emoji
            );
          }
        }, {
          header: '<center>ë©”ì¼<br>í†µë³´</center>', dataIndex: 'mailSent',   width: 40, align:'center',
          renderer: function(value, metaData, record) {
            let feelingGrade = 1; // ê¸°ë³¸ê°’ (ë¶ˆì¾Œ)
            if (value.includes("ì‹ ê³  ì ‘ìˆ˜ê²°ê³¼")) {
                feelingGrade = 4;
            } else if (value.includes("ì˜ˆì •ê³ ì§€")) {
                feelingGrade = 3;
            } else if (value.includes("ì‹ ê³  ì¤€ë¹„ì•ˆë‚´")) {
                feelingGrade = 2;
            }
            const emojis = {
                1: "âŒ",  // ë¶ˆì¾Œ
                2: "ğŸ˜",  // ì‹œë¬´ë£©
                3: "ğŸ˜„",  // ê¸°ì¨
                4: "âœ…"   // ë§¤ìš° ì¢‹ìŒ
            };
            const emoji = emojis[feelingGrade] || "âŒ";
            return Ext.String.format(
              `<div style="cursor:pointer;" onclick="summitModal(window['record_{0}'], {0}, '{1}', '{2}', {3}, {4}, 'Vat', 'ë©”ì¼í†µë³´');">
                {5}
              </div>`,
              record.data.seq_no,
              Ext.String.htmlEncode(record.data.ceo_name),
              Ext.String.htmlEncode(record.data.biz_name),
              work_YY,
              work_QT,
              emoji
            );
          }
        }, {
          header: '<center>ì¹´í†¡<br>í†µë³´</center>', dataIndex: 'kakao',   width: 40, align:'center',
          renderer: function(value) {
            let feelingGrade = 0; // ê¸°ë³¸ê°’ (ë¶ˆì¾Œ)
            if (value.includes("[ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³  ì•ˆë‚´]")) {
                feelingGrade = 1;
            } else if (value.includes("[ë¶€ê°€ê°€ì¹˜ì„¸ ê³ ì§€ ì•ˆë‚´]") || value.includes("ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ìˆ˜ìˆ˜ë£Œ ì•ˆë‚´]")) {
                feelingGrade = 3;
            } else if (value.includes("[ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³  ì ‘ìˆ˜]")) {
                feelingGrade = 2;
            }
            const emojis = {
                0: "âŒ",  // ë¶ˆì¾Œ
                1: "ğŸ˜",
                2: "ğŸ˜„",  // ê¸°ì¨
                3: "â˜‘ï¸"   // ë§¤ìš° ì¢‹ìŒ
            };
            return value.trim() ?  emojis[feelingGrade] : "";  // ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
          }
        }, {
          header: '<center>ë¬¸ì<br>í†µë³´</center>', dataIndex: 'SMS',   width: 40, align:'center',
          renderer: function(value) {
            return value.trim() ?  "ğŸ‘" : "";  // ë“±ê¸‰ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
          }
        },{  
          header: '<center>ë¹„ê³ </center>', dataIndex: 'YN_13',  width: 150, editor: { allowBlank: true }, renderer:tooltipRenderer2          
        }, {
          header: '<center>ì˜ë¬´<br>ì „ì</center>', dataIndex: 'inspect_elec',  width: 35,
          renderer: function (value) {
            return parseInt(value, 10) === 1 ? 'âš ï¸' : '';
          }
        }, {
          header: '<center>ì„±ì‹¤<br>ì‹ ê³ </center>', dataIndex: 'inspect_labor',  width: 35,
          renderer: function (value) {
            return parseInt(value, 10) === 1 ? 'âš ï¸' : '';
          }
        },{  
          header: '<center>ì „ì<br>ì‹ ê³ </center>', dataIndex: 'isIssue',  width: 40,align:'center',renderer: value => value ? "ğŸ’™" : ""     
        }, {  
          header: '<center>ì ‘ìˆ˜<br>ID</center>', dataIndex: 'JupsuID',  width: 40,
          renderer: function(value) {
            // ê°’ì´ ì¡´ì¬í•˜ë©´ ëì—ì„œ ë‘ ìë¦¬ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.
            if (value && value.length >= 2) {
                return value.slice(-2);
            }
            return value;
          }
        },{  
          header: '<center>ìˆ˜ìˆ˜ë£Œ</center>', dataIndex: 'YN_12',  width: 90,xtype: 'numbercolumn', align:'right',format:'0,000', editor: { allowBlank: true }        
          , summaryType: 'sum', summaryRenderer: function(value) {  return Ext.util.Format.number(value, '0,000');}
        }, {
          header: '<center>ìˆ˜ê¸ˆ</center>', dataIndex: 'YN_11',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender,align:'center',
          listeners: {
              checkchange: function(checkColumn, rowIndex, checked) {
                  var grid = this.up('grid'),
                      store = grid.getStore(),
                      rec = store.getAt(rowIndex);
                  
                  // ê¸°ì¡´ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (seq_no ê°’ì„ ì‚¬ìš©)
                  check(rec.get('seq_no'), 'YN_11', work_YY,work_QT, checked);
                  
                  if (checked) {
                      // ì²´í¬ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
                      var today = Ext.Date.format(new Date(), 'Y-m-d');
                      rec.set('YN_1', today);
                  } else {
                      // ì²´í¬ í•´ì œ ì‹œ ê²°ì¬ì¼ ì´ˆê¸°í™”
                      rec.set('YN_1', '');
                  }
              }
          }
        },{  
          header: '<center>ìˆ˜ê¸ˆì¼</center>', dataIndex: 'YN_1',  width: 90 ,renderer: formatDate, editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	
        },{
          text: 'ì„¸ê¸ˆê³„ì‚°ì„œ',
          columns: [
          {   header: '<center>ë°œí–‰</center>', dataIndex: 'YN_2',  width: 40, xtype: 'checkcolumn',renderer : checkboxRender, width: 40,align:'center',
              listeners: {
                  checkchange: function(checkColumn, rowIndex, checked) {
                      var grid = this.up('grid'),
                          store = grid.getStore(),
                          rec = store.getAt(rowIndex);
                      
                      check(rec.get('seq_no'), 'YN_2', work_YY,work_QT, checked);
                      
                      if (checked) {
                          // ì²´í¬ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
                          var today = Ext.Date.format(new Date(), 'Y-m-d');
                          rec.set('YN_3', today);
                      } else {
                          // ì²´í¬ í•´ì œ ì‹œ ê²°ì¬ì¼ ì´ˆê¸°í™”
                          rec.set('YN_3', '');
                      }
                  }
              }          
          },{  
            header: '<center>ë°œí–‰ì¼</center>', dataIndex: 'YN_3',  width: 90,renderer: formatDate, editor: {		xtype: 'datefield',	format: 'y-m-d'		},allowBlank: true	}
        ]},
        {
          header: '<center>YN_Kisu</center>', dataIndex: 'YN_Kisu',  width: 0
        }
      ],      
      viewConfig: {
        emptyText: '<div style="text-align:center;padding:50px;font-size:16px; font-weight:bold;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
      },                  
      dockedItems: [
        {
          dock: 'top',
          xtype: 'toolbar',
          items: 
          [...dockedItemsConfig,
            {
              xtype: 'buttongroup',              
              columns: 5,
              frame:false,
              defaults: {
                enableToggle: true,
                toggleGroup: 'yearGroup',
                margin: '0 5 0 0', // ë²„íŠ¼ ê°„ê²© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ 5px ê°„ê²©)
                style: {
                    border: '1px solid #ccc',
                    padding: '5px 6px',
                    borderRadius: '5px',
                    transition: 'all 0.2s ease' // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
                }
              },
              items: Array.from({ length: 5 }, (_, i) => ({
                text: `${currentYear - i}ë…„`,
                pressed: currentYear - i === parseInt(work_YY, 10),
                handler: function () {
                  var grid = this.up('grid');
                  work_YY = parseInt(this.text.replace('ë…„', ''));
                  grid.getStore().getProxy().extraParams.work_YY = work_YY;
                  grid.getStore().reload();

                  // const store = grid.getStore();
                  // const selectedBiz = getSelectedBizType(grid);  // â˜… ì„ íƒê°’ ë³´ê´€

                  // const selectedYear = parseInt(this.text.replace('ë…„', ''));
                  // work_YY = selectedYear;                  

                  // const data = {
                  //     ADID: ADID,
                  //     work_YY : work_YY,
                  //     work_QT : work_QT
                  // };
                  // // ë¡œë”© ë§ˆìŠ¤í¬ ìƒì„± (ëŒ€ìƒ: ê·¸ë¦¬ë“œë‚˜ íŒ¨ë„)
                  // var targetComponent = Ext.getCmp('mainGrid') || Ext.getBody(); // ëŒ€ìƒ ì„¤ì • (ê·¸ë¦¬ë“œ IDë‚˜ body)
                  // var loadMask = new Ext.LoadMask({
                  //     msg: 'ì—°ë„ë¥¼ ë³€ê²½ì¤‘ì…ë‹ˆë‹¤...', 
                  //     target: targetComponent
                  // });
                  // loadMask.show(); // ë¡œë”© í‘œì‹œ ì‹œì‘
                  // Ext.Ajax.request({
                  //     url: '{% url "mng_vat" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                  //     method: 'GET',
                  //     params: data, // ë°ì´í„°ë¥¼ GET íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
                  //     success: function (response) {
                  //         try {
                  //             const jsonResponse = Ext.decode(response.responseText); // JSON íŒŒì‹±
                  //             store.loadData(jsonResponse); // ë°ì´í„° ë¡œë“œ
                  //             applyBizTypeFilter(store, selectedBiz);  // â˜… ì¬ì ìš©
                  //         } catch (e) {
                  //             console.error('Failed to parse response:', e, response.responseText);
                  //         } finally {
                  //             loadMask.hide(); // ë¡œë”© ì¢…ë£Œ
                  //         }
                  //     },
                  //     failure: function (response) {
                  //         alert('Request failed:', response);
                  //         loadMask.hide(); // ë¡œë”© ì¢…ë£Œ
                  //     }
                  // });
                }//handler
              }))//items
            },
            '->',  // ìš°ì¸¡ ì •ë ¬ì„ ìœ„í•œ tbfill
            {
              xtype: 'displayfield',
              fieldLabel: 'ì „ì²´',
              itemId: 'totalCommissionDisplay',
              value: '0'
            },{
              xtype: 'displayfield',
              fieldLabel: 'ìˆ˜ê¸ˆ',
              itemId: 'collectedCommissionDisplay',
              margin: '0 10 0 10',
              value: '0',
              
            }     
          ]//dockeditems
        },
        {
          xtype: 'toolbar',
          items:[{
            xtype: 'radiogroup',
            itemId: 'bizTypeGroup',           // â˜… ì‹ë³„ì
            layout: 'hbox',
            defaults: {
                name: 'bizTypeGroup',
                margin: '0 10 0 0'
            },
            value: { bizTypeGroup: 'all' }, // âœ… ê¸°ë³¸ê°’ 'ì „ì²´' ì„¤ì •
            items: [
                { boxLabel: 'ì „ì²´', inputValue: 'all' },
                { boxLabel: 'ë²•ì¸', inputValue: 'corp' },
                { boxLabel: 'ê°œì¸', inputValue: 'person' }
            ],
            style: {
                background: '#fff', // ê·¸ë£¹ ë°°ê²½ìƒ‰ ì§€ì •
                border: '0px #fff',
            },
            listeners: {
              change: function (group, newValue, oldValue) {
                  // â˜… ì—¬ê¸°ì„œ grid ë³€ìˆ˜ ì—ëŸ¬ ë°œìƒí•¨ -> group.up('grid')ë¡œ ìˆ˜ì •
                  const grid = group.up('grid');
                  const store = grid.getStore();
                  const selected = newValue.bizTypeGroup;

                  if (selected === 'corp') {
                      store.clearFilter();
                      store.filterBy(record => parseInt(record.get('biz_type'), 10) <= 3);
                  } else if (selected === 'person') {
                      store.clearFilter();
                      store.filterBy(record => parseInt(record.get('biz_type'), 10) >= 4);
                  } else {
                      store.clearFilter();
                  }
              }
            }
          },{
            xtype: 'buttongroup',
            title: null, // ì œëª© ì œê±°
            columns: 4, // í•œ ì¤„ì— ë²„íŠ¼ 4ê°œ (ë¶„ê¸° ê¸°ì¤€)
            frame:false,
            border:0,
            defaults: {
                enableToggle: true,
                toggleGroup: 'quarterGroup',
                margin: '0 5 0 0', // ë²„íŠ¼ ê°„ê²© (ì˜¤ë¥¸ìª½ 5px)
                style: {
                    border: '1px solid #ccc', // ë²„íŠ¼ í…Œë‘ë¦¬ ìƒ‰ìƒ
                    padding: '5px 6px', // ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°±
                    borderRadius: '5px' // ë²„íŠ¼ ë‘¥ê¸€ê²Œ ì²˜ë¦¬
                }
            },
            // Array.fromì„ ì‚¬ìš©í•´ 4ê°œì˜ ë²„íŠ¼ ìƒì„± ("1ë¶„ê¸°" ~ "4ë¶„ê¸°")
            items: Array.from({ length: 4 }, (_, i) => ({
                text: `${i + 1}ë¶„ê¸°`,
                // ë¶„ê¸° ì„ íƒ ë³€ìˆ˜ work_QTì™€ ë¹„êµ (ìˆ«ìë¡œ ë³€í™˜)
                pressed: (i + 1) === parseInt(work_QT, 10),
                handler: function () {
                    var grid = this.up('grid');
                    if (!grid) return;
                    var store = grid.getStore();
                    // 2. ì„ íƒëœ ë¶„ê¸° ê°’ ê°±ì‹ 
                    var selectedQuarter = parseInt(this.text.replace('ë¶„ê¸°', ''), 10);
                    work_QT = selectedQuarter;

                    // 3. ìŠ¤í† ì–´ íŒŒë¼ë¯¸í„° ê°±ì‹  ë° ë¦¬ë¡œë“œ (í•µì‹¬!)
                    var proxy = store.getProxy();
                    proxy.extraParams.work_QT = work_QT;
                    store.load(); // ë˜ëŠ” store.reload();
                }
            })),
            style: {
                background: '#fff', // ê·¸ë£¹ ë°°ê²½ìƒ‰ ì§€ì •
                //border: '1px solid #ccc',
                //padding: '6px'
            }
          }]
        }      
      ],
      listeners: {
        afterrender: function(grid) {
          grid.getStore().on('datachanged', function() {
              var total = 0, collected = 0;
              store.each(function(rec) {
                  var comm = rec.get('YN_12') || 0;
                  total += comm;
                  if (rec.get('YN_11')) collected += comm;
              });
              // í•˜ë‹¨ displayfieldê°€ ìˆë‹¤ë©´ ê°’ ì—…ë°ì´íŠ¸ (IDê°€ ì•„ë‹ˆë¼ itemIdë¡œ ì°¾ì•„ì•¼ í•¨)
              var totalDisp = grid.down('#totalCommissionDisplay');
              if(totalDisp) totalDisp.setValue(Ext.util.Format.number(total, '0,000'));
          });
          // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë†’ì´ ì¬ê³„ì‚° (ë°˜ì‘í˜• ì²˜ë¦¬)
          Ext.EventManager.onWindowResize(function() {
              if(grid && !grid.isDestroyed) {
                  grid.setHeight(getGridHeight());
                  grid.doLayout();
              }
          });        
        }
      }
    });

    if (mainGrid) {
      attachGridToolTip(mainGrid, '{% url "kijang_member_popup" %}?seq_no={seq_no}');
      attachGridToolTip_JupsuSummit(mainGrid,work_YY,work_QT);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [5] ì „ì—­ ë…¸ì¶œ í•¨ìˆ˜ (onclick ëŒ€ì‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


    // â”€â”€ bizTypeGroup í˜„ì¬ ì„ íƒê°’ ì½ê¸°
    function getSelectedBizType(mainGrid) {
      const rg = mainGrid && mainGrid.down && mainGrid.down('#bizTypeGroup');
      return (rg && rg.getValue && rg.getValue().bizTypeGroup) || 'all';
    }

    // â”€â”€ ì„ íƒê°’ì— ë”°ë¥¸ í•„í„° ì ìš©
    function applyBizTypeFilter(store, selected) {
      // Ext 4/5/6 í˜¸í™˜ ì´ˆê¸°í™”
      if (store.getFilters && store.getFilters().removeAll) {
        store.getFilters().removeAll();
      } else if (store.clearFilter) {
        store.clearFilter();
      }

      if (selected === 'corp') {
        store.filterBy(r => {
          const t = parseInt(r.get('biz_type'), 10);
          return t >= 1 && t <= 3;
        });
      } else if (selected === 'person') {
        store.filterBy(r => {
          const t = parseInt(r.get('biz_type'), 10);
          return t >= 4 && t <= 6;
        });
      }
    }

    var tooltipRenderer2 = function(value, metaData,record) {
      metaData.tdAttr = Ext.String.format('data-qtip="{0}"', value	);
      return value;
    };

    // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ ì •ì˜
    const debounce = (func, delay) => {
      let timeoutId;
      return function (...args) {
        const context = this;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(context, args), delay);
      };
    };

    //############# 0.ì‹ ê³ ì„œ ë³´ê¸°
    const treeLoad = (ADID,seq_no,ceo_name,biz_name,work_YY) => {
      srcpath = biz_name
      if (ADID=="í™”ë¬¼") {
        srcpath = `í™”ë¬¼ì—°ëŒ€/${ceo_name}`
      }
      $('#accordionLeft').empty();// ê¸°ì¡´ ìš”ì†Œ ë¹„ìš°ê¸°
      $.ajax({
        url: "{% url 'path_to_vat_admin' %}",
        type: "POST",
        data: {
          seq_no:seq_no,
          path: `static/cert_DS/${srcpath}/${work_YY}/ë¶€ê°€ì„¸/`
        },
        dataType: "json",
        success: function (data) {
          const gridData = data.nodes;
          const fragment = document.createDocumentFragment(); // âœ… ì—¬ê¸°ì„œ ì‚¬ìš©
          let selectedSheetID = "";
          let selectedPeriod = "";

          gridData.forEach((item, index) => {
            const divCard = document.createElement("div");
            divCard.className = "card overflow-hidden mb-2 border-0";
            divCard.id = "collapseHead" + index;

            // Anchor (Header)
            const anchor = document.createElement("a");
            anchor.className = "accordion-toggle panel-heading1 collapsed";
            anchor.setAttribute("data-bs-toggle", "collapse");
            anchor.setAttribute("aria-expanded", "false");
            anchor.href = "#collapse" + index;
            anchor.innerText = `${item.displayName} :: ${item.singoDur}`;
            divCard.appendChild(anchor);

            // Panel body
            const divPanel = document.createElement("div");
            divPanel.className = "panel-collapse collapse" + (index === gridData.length - 1 ? " show" : "");
            divPanel.id = "collapse" + index;
            divPanel.setAttribute("role", "tabpanel");
            divPanel.setAttribute("aria-expanded", "false");
            divPanel.setAttribute("data-bs-parent", "#accordionAcnt");

            // Sheet ì„ íƒ ì²˜ë¦¬
            if (index === gridData.length - 1) {
              selectedSheetID = `${gridData.length}@0`;
              selectedPeriod = item.displayName;
            }

            // ul íƒœê·¸
            const ul = document.createElement("ul");
            ul.className = "nav1 nav-column flex-column br-7";
            ul.id = "singoList" + index;

            divPanel.appendChild(ul);
            divCard.appendChild(divPanel);
            document.getElementById('accordionLeft').appendChild(divCard);

            singoListDetail(ul, item.totalPath, item.displayName, index + 1, item.dueDate, selectedSheetID);
          });

          // âœ… í•œ ë²ˆë§Œ DOMì— ì¶”ê°€ (ë¦¬í˜ì¸íŠ¸ ìµœì†Œí™”)
          document.getElementById('accordionLeft').appendChild(fragment);
        },
        error: function (xhr, status, error) {
          console.error('ğŸ“› ë¶€ê°€ì„¸ í´ë” ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      });
    };

    const singoListDetail = async (ul, path, singoPeriod, quarter, dueDate, selSheetID) => {
      try {
        const response = await $.ajax({
          url: "{% url 'path_to_file_admin' %}",
          data: {
            path: path,
            singoPeriod: singoPeriod,
            quarter: quarter
          },
          dataType: "json"
        });

        ul.innerHTML = ""; // ì´ˆê¸°í™” (ì¤‘ë³µ ì‚½ì… ë°©ì§€)
        let selectedRow = null;

        response.rows.forEach(row => {
          const { id, íŒŒì¼ëª…, totalPath, fileNum } = row;

          const li = document.createElement("li");
          li.id = `li${id}`;
          li.className = "nav-item1 mt-0";

          const anchor = document.createElement("a");
          anchor.href = `javascript:changeSheet('${id}','${singoPeriod}','${íŒŒì¼ëª…}','${totalPath}')`;
          anchor.className = `nav-link thumb ${id === selSheetID ? 'active' : ''}`;
          anchor.id = id;

          // í‘œì‹œ í…ìŠ¤íŠ¸ êµ¬ì„±
          let content = íŒŒì¼ëª…;

          if (fileNum === "200") {
            content += `<span class="badge badge-sm bg-danger badge-hide ms-4">ë‚©ê¸°:${dueDate}</span>`;
          } else if (fileNum === "300") {
            content += `<span class="badge badge-sm bg-secondary badge-hide ms-6">NTS</span>`;
          } else if (fileNum === "0") {
            content = `<i class="fa fa-star text-yellow me-2"></i>${íŒŒì¼ëª…}<i class="fa fa-star text-yellow ms-2"></i>`;
          }

          anchor.innerHTML = content;
          li.appendChild(anchor);
          ul.appendChild(li);

          if (id === selSheetID) {
            selectedRow = row; // ë£¨í”„ ëë‚œ í›„ changeSheet í˜¸ì¶œ
          }
        });

        // ë§ˆì§€ë§‰ì— changeSheet ì‹¤í–‰
        if (selectedRow) {
          changeSheet(selectedRow.id, singoPeriod, selectedRow.íŒŒì¼ëª…, selectedRow.totalPath);
        }
      } catch (error) {
        console.error('ğŸ“› singoListDetail ì‹¤íŒ¨:', error);
      }
    };

    window.changeSheet = function(selSheetID, selPeriod, selSheetName, file_path) {
      selPeriod = decodeURIComponent(selPeriod);
      selSheetName = decodeURIComponent(selSheetName);
      file_path = decodeURIComponent(file_path);

      if (selectedSheetID) {
        const prev = document.getElementById(selectedSheetID);
        if (prev) prev.className = "nav-link thumb";
      }
      const current = document.getElementById(selSheetID);
      if (current) current.className = "nav-link thumb active";

      const iframe = document.getElementById("singoseoPDFIframe");
      if (iframe) iframe.src = file_path;

      selectedSheetID = selSheetID;
      selectedPeriod = selPeriod;
      selectedSheetName = selSheetName;
    };


    window.handleButtonClose = function(seq_no, ceo_name, biz_name,ev)  {
      const btnElement  = document.getElementById('btn_selectedYear');
      btnElement.innerHTML = ev+" ë…„";
      treeLoad(ADID,seq_no,ceo_name,biz_name,ev)
    };  
    //############# 2. ë¶„ì„
    function setAnaly(record, seq_no, work_YY, work_QT){
      // ì™¼ìª½ ë§‰ëŒ€ê·¸ë˜í”„
      $.ajax({
        url: "{% url 'get_IssueVatList_Analy' %}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          seq_no: seq_no,
          work_YY: work_YY,
          work_QT: work_QT
        }),
        success: function (response) {
          const reversedList = [...(response.totIssueList || [])].reverse();
          changeAll(response.totIssueList[0])
          am5.ready(function() {
            var root = am5.Root.new("chartdiv");
            var data = reversedList;
            root.setThemes([
              am5themes_Animated.new(root)
            ]);
            root.numberFormatter.setAll({
              numberFormat: "#a",
              bigNumberPrefixes: [
                { "number": 1e+4, "suffix": "ë§Œ" },
                { "number": 1e+6, "suffix": "ë°±ë§Œ" },
                { "number": 1e+8, "suffix": "ì–µ" }
              ],
              smallNumberPrefixes: []
            });
            var chart = root.container.children.push(am5xy.XYChart.new(root, {
              panX: true,
              panY: false,
              wheelX: "panX",
              wheelY: "zoomX",
              layout: root.verticalLayout
            }));

            //ìƒë‹¨ìŠ¤í¬ë¡¤ë°”
            // chart.set("scrollbarX", am5.Scrollbar.new(root, {
            //   orientation: "horizontal"
            // }));
            var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
              categoryField: "ê³¼ì„¸ê¸°ê°„",
              renderer: am5xy.AxisRendererX.new(root, {}),
              tooltip: am5.Tooltip.new(root, {
                themeTags: ["axis"],
                animationDuration: 200
              })
            }));
            xAxis.data.setAll(data);

            var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
              min: 0,
              renderer: am5xy.AxisRendererY.new(root, {})
            }));
            var zAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
              min: 0,
              renderer: am5xy.AxisRendererY.new(root, {})
            }));

            var series0 = chart.series.push(am5xy.ColumnSeries.new(root, {
              name: "ë§¤ì…í•©ê³„",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "ë§¤ì…í•©ê³„",
              categoryXField: "ê³¼ì„¸ê¸°ê°„",
              clustered: false,
              tooltip: am5.Tooltip.new(root, {
                labelText: "ë§¤ì…í•©ê³„: {valueY}"
              })
            }));
            series0.columns.template.setAll({
              width: am5.percent(80),
              tooltipY: 0
            });
            series0.data.setAll(data);
            
            var series1 = chart.series.push(am5xy.ColumnSeries.new(root, {
              name: "ë§¤ì¶œí•©ê³„",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "ë§¤ì¶œí•©ê³„",
              categoryXField: "ê³¼ì„¸ê¸°ê°„",
              clustered: false,
              tooltip: am5.Tooltip.new(root, {
                labelText: "ë§¤ì¶œí•©ê³„: {valueY}"
              })
            }));
            series1.columns.template.setAll({
              width: am5.percent(50),
              tooltipY: 0
            });
            series1.data.setAll(data);

            var series2 = chart.series.push(am5xy.LineSeries.new(root, {
              name: "ë‚©ë¶€ì„¸ì•¡",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "ë‚©ë¶€ì„¸ì•¡",
              categoryXField: "ê³¼ì„¸ê¸°ê°„",
              clustered: false,
              tooltip: am5.Tooltip.new(root, {
                labelText: "ë‚©ë¶€ì„¸ì•¡: {valueY}"
              })
            }));
            series2.strokes.template.setAll({ strokeWidth: 2 });
            series2.bullets.push(function() {
              return am5.Bullet.new(root, {
                sprite: am5.Circle.new(root, {
                  strokeWidth: 3,
                  stroke: series2.get("stroke"),
                  radius: 5,
                  fill: root.interfaceColors.get("background")
                })
              });
            });
            series2.data.setAll(data);  

            //ìƒ‰ìƒ
            series0.set("fill", am5.color(0xFF9E9B));   //ë§¤ì…ì•¡
            series1.set("fill", am5.color(0x87cefa));   //ë§¤ì¶œì•¡
            series2.set("fill", am5.color(0x50b300));   //ë‚©ë¶€ì„¸ì•¡

            series1.columns.template.events.on("click", function(ev) {
              changeAll(ev.target._dataItem.dataContext);
            });
            series0.columns.template.events.on("click", function(ev) {
              changeAll(ev.target._dataItem.dataContext);
            });
            var cursor = chart.set("cursor", am5xy.XYCursor.new(root, {}));
            chart.appear(1000, 100);
            series0.appear();
            series1.appear();
          }); 
        },
        error: function (xhr, status, error) {
          alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + error);
        }
      });

      am5.addLicense("AM5C372573951");
    }
    const setDivInspect = (tmpIssueList) => {
      var costCard = tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ê¸°íƒ€ì¹´ë“œ*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í˜„ê¸ˆì˜ìˆ˜ì¦*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í™”ë¬¼ë³µì§€*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ì‚¬ì—…ìš©ì¹´ë“œ*1;
      $("#divListGroup").empty();
      var tmpHtml="";
      tmpHtml += "            <div class='list-group py-1'>"
      tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
      tmpHtml += "                <div class='list-group-item border-0'>"
      tmpHtml += "                  <div class='media mt-0 align-items-center'>"
      tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-chevrons-right'></i>"
      tmpHtml += "                    </div>"
      tmpHtml += "                    <div class='media-body'>"
      tmpHtml += "                      <div class='d-flex align-items-center'>"
      tmpHtml += "                        <div class='mt-0'>"
      tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë¶€ê°€ìœ¨</h5>"
      tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>(ë‚©ë¶€ì„¸ì•¡+ê³ ì •ìì‚°ë§¤ì…ì„¸ì•¡)/ë§¤ì¶œì„¸ì•¡</p>"
      tmpHtml += "                        </div>"
      tmpHtml += "                        <span class='ms-auto fs-13'>"
      tmpHtml += "                          <span class='float-end text-dark'>"+((tmpIssueList.ë‚©ë¶€í™˜ê¸‰ì„¸ì•¡+tmpIssueList.ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œìˆ˜ì·¨ê³ ì •ìì‚°ì„¸ì•¡)/tmpIssueList.ì‚°ì¶œì„¸ì•¡*100).toFixed(2)+" %</span>"
      tmpHtml += "                        </span>"
      tmpHtml += "                      </div>"
      tmpHtml += "                    </div>"
      tmpHtml += "                  </div>"
      tmpHtml += "                </div>"
      tmpHtml += "              </a>"
      tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
      tmpHtml += "                <div class='list-group-item border-0'>"
      tmpHtml += "                  <div class='media mt-0 align-items-center'>"
      tmpHtml += "                    <div class='transaction-icon'>"
      tmpHtml += "                      <i class='fe fe-scissors'></i>"
      tmpHtml += "                    </div>"
      tmpHtml += "                    <div class='media-body'>"
      tmpHtml += "                      <div class='d-flex align-items-center'>"
      tmpHtml += "                        <div class='mt-0'>"
      tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë§¤ì…ì„¸ì•¡ <span class='fs-13 fw-semibold ms-1'>ë¶ˆê³µì œ</span></h5>"
      tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ìŠ¹ìš©ì°¨ê´€ë ¨Â·ì ‘ëŒ€ë¹„Â·í† ì§€ê´€ë ¨ ë“±</p>"
      tmpHtml += "                        </div>"
      tmpHtml += "                        <span class='ms-auto fs-13'>"
      tmpHtml += "                          <span class='float-end text-dark'>"+numberWithCommas(tmpIssueList.ë¶ˆê³µì œ)+"</span>"
      tmpHtml += "                        </span>"
      tmpHtml += "                      </div>"
      tmpHtml += "                    </div>"
      tmpHtml += "                  </div>"
      tmpHtml += "                </div>"
      tmpHtml += "              </a>"
      tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
      tmpHtml += "                <div class='list-group-item border-0'>"
      tmpHtml += "                  <div class='media mt-0 align-items-center'>"
      tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-briefcase'></i>"
      tmpHtml += "                    </div>"
      tmpHtml += "                    <div class='media-body'>"
      tmpHtml += "                      <div class='d-flex align-items-center'>"
      tmpHtml += "                        <div class='mt-0'>"
      tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ì‹ ìš©ì¹´ë“œ <span class='fs-13 fw-semibold ms-1'>ë§¤ì…ì„¸ì•¡ ê³µì œìœ¨</span></h5>"
      tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ì´ ì¹´ë“œì‚¬ìš©ì•¡ "+numberWithCommas(tmpIssueList.ì¹´ë“œí˜„ì˜ì‚¬ìš©ì´ì•¡)+"</p>"
      tmpHtml += "                        </div>"
      tmpHtml += "                        <span class='ms-auto fs-13'>"
      tmpHtml += "                          <span class='float-end text-dark'>"+(costCard/tmpIssueList.ì¹´ë“œí˜„ì˜ì‚¬ìš©ì´ì•¡*100).toFixed(2)+" %</span>"
      tmpHtml += "                        </span>"
      tmpHtml += "                      </div>"
      tmpHtml += "                    </div>"
      tmpHtml += "                  </div>"
      tmpHtml += "                </div>"
      tmpHtml += "              </a>"
      tmpHtml += "              <a href='javascript:void(0);' class='border-0'>"
      tmpHtml += "                <div class='list-group-item border-0'>"
      tmpHtml += "                  <div class='media mt-0 align-items-center'>"
      tmpHtml += "                    <div class='transaction-icon'><i class='fe fe-file-text'></i>"
      tmpHtml += "                    </div>"
      tmpHtml += "                    <div class='media-body'>"
      tmpHtml += "                      <div class='d-flex align-items-center'>"
      tmpHtml += "                        <div class='mt-0'>"
      tmpHtml += "                          <h5 class='mb-1 fs-13 fw-normal text-dark'>ë¶€ê°€ê°€ì¹˜ì„¸ <span class='fs-13 fw-semibold ms-1'>ê°€ì‚°ì„¸</span></h5>"
      tmpHtml += "                          <p class='mb-0 fs-12 text-muted'>ì „ìì„¸ê¸ˆê³„ì‚°ì„œê´€ë ¨Â·ë¶ˆì„±ì‹¤ ë“±</p>"
      tmpHtml += "                        </div>"
      tmpHtml += "                        <span class='ms-auto fs-13'>"
      tmpHtml += "                          <span class='float-end text-dark'>"+numberWithCommas(tmpIssueList.ê°€ì‚°ì„¸ì•¡ê³„)+"</span>"
      tmpHtml += "                        </span>"
      tmpHtml += "                      </div>"
      tmpHtml += "                    </div>"
      tmpHtml += "                  </div>"
      tmpHtml += "                </div>"
      tmpHtml += "              </a>"
      tmpHtml += "            </div>"
      document.getElementById('divListGroup').innerHTML = tmpHtml;
    }
    const setDivTitle = (tmpIssueList) => {  
      var anchor3 = document.getElementById("anchor3")
      anchor3.innerText = tmpIssueList.ê³¼ì„¸ê¸°ê°„.substring(0,5)+" "+tmpIssueList.startDt + " ~ " + tmpIssueList.endDt
    }
    const setTabContent = (tmpIssueList) => {
      var totalSale = tmpIssueList.ë§¤ì¶œí•©ê³„;
      var saleTI = tmpIssueList.ë§¤ì¶œì„¸ê¸ˆê³„ì‚°ì„œ;
      var saleNonTI = tmpIssueList.ë©´ì„¸ë§¤ì¶œ;
      var saleZeroTI = tmpIssueList.ì˜ì„¸ìœ¨ë§¤ì¶œ;
      var saleCard = tmpIssueList.ì¹´ë“œë§¤ì¶œ;
      var saleKita = tmpIssueList.ê¸°íƒ€ë§¤ì¶œ;
      var anchor1 = document.getElementById("anchor1")
      var anchor2 = document.getElementById("anchor2")  
      anchor1.setAttribute("class","active me-1 text-default my-1");
      anchor2.setAttribute("class","me-1 text-default my-1");  
      $("#tabContent_SaleCost").empty();
      var tmpHtml="";
      tmpHtml += "<div class='tab-pane active' id='tab1'>"
      tmpHtml += "	<div class='storage-percent'>"
      tmpHtml += "	  <div class='progress fileprogress h-auto ps-0 shadow1'>"
      if (Math.round(saleTI / totalSale *100)>0 ) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleTI / totalSale *100)+" bg-primary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round((saleNonTI+saleZeroTI) / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round((saleNonTI+saleZeroTI) / totalSale *100)+" bg-secondary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round(saleCard / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleCard / totalSale *100)+" bg-custom-yellow' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round(saleKita / totalSale *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(saleKita / totalSale *100)+" bg-teritary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      tmpHtml += "	  </div>"
      tmpHtml += "	  <div class='remaining-storage'>"
      tmpHtml += "		<div class='text-muted fs-13 mb-1 mt-3'>ë§¤ì¶œ ê³µê¸‰ê°€ì•¡</div>"
      tmpHtml += "		<div class='fw-semibold fs-14 mb-1 mt-3'>"+numberWithCommas(totalSale)+"</div>"
      tmpHtml += "	  </div>"
      tmpHtml += "	</div>"
      tmpHtml += "	<div class='content-main mt-5'>"
      tmpHtml += "	  <ul class='task-list1 row mx-auto'>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-primary me-3'></i>ì„¸ê¸ˆê³„ì‚°ì„œ</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(saleTI)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-secondary'></i>ì˜ì„¸ìœ¨Â·ê³„ì‚°ì„œ</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(saleZeroTI+saleNonTI)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-custom-yellow'></i>ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(saleCard)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6 mb-xl-0'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-teritary'></i>ê¸°íƒ€(ì˜¨ë¼ì¸Â·í˜„ê¸ˆ)</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(saleKita)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "	  </ul>"
      tmpHtml += "	</div>"
      tmpHtml += "</div>"

      //var totalCost = tmpIssueList.ë§¤ì…í•©ê³„;
      var costTI = tmpIssueList.ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œ - tmpIssueList.ë¶ˆê³µì œ;
      var costNonTI = tmpIssueList.ë©´ì„¸ë§¤ì…;
      var costBulgong = tmpIssueList.ë¶ˆê³µì œ;
      var costCard = tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ê¸°íƒ€ì¹´ë“œ*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í˜„ê¸ˆì˜ìˆ˜ì¦*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨í™”ë¬¼ë³µì§€*1 + tmpIssueList.ì‹ ìš©ì¹´ë“œìˆ˜ì·¨ì‚¬ì—…ìš©ì¹´ë“œ*1;
      var costRevive = tmpIssueList.ì˜ì œë§¤ì…ì„¸ì•¡ê³µì œ*1 + tmpIssueList.ì¬í™œìš©íìì›ë“±ë§¤ì…ì„¸ì•¡*1
      var costGongje = tmpIssueList.ê²½ê°ê³µì œì„¸ì•¡;
      var totalCost = costTI + costNonTI + costCard + costRevive

      tmpHtml += "<div class='tab-pane ' id='tab2'>"
      tmpHtml += "	<div class='storage-percent'>"
      tmpHtml += "	  <div class='progress fileprogress h-auto ps-0 shadow1'>"
      if (Math.round(costTI / totalCost *100)>0 ) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costTI / totalCost *100)+" bg-primary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round(costNonTI / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costNonTI / totalCost *100)+" bg-secondary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round(costCard / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costCard / totalCost *100)+" bg-custom-yellow' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      if (Math.round(costRevive / totalCost *100)) tmpHtml += "		<span class='progress-bar progress-bar-xs wp-"+Math.round(costRevive / totalCost *100)+" bg-teritary' role='progressbar'  aria-valuemin='0' aria-valuemax='100'></span>"
      tmpHtml += "	  </div>"
      tmpHtml += "	  <div class='remaining-storage'>"
      tmpHtml += "		<div class='text-muted fs-13 mb-1 mt-3'>ë§¤ì… ê³µê¸‰ê°€ì•¡</div>"
      tmpHtml += "		<div class='fw-semibold fs-14 mb-1 mt-3'>"+numberWithCommas(totalCost)+"</div>"
      tmpHtml += "	  </div>"
      tmpHtml += "	</div>"
      tmpHtml += "	<div class='content-main mt-5'>"
      tmpHtml += "	  <ul class='task-list1 row mx-auto'>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-primary me-3'></i>ì„¸ê¸ˆê³„ì‚°ì„œ</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(costTI)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-secondary'></i>ê³„ì‚°ì„œ</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(costNonTI)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-custom-yellow'></i>ì¹´ë“œÂ·í˜„ê¸ˆì˜ìˆ˜ì¦</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(costCard)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "		<li class='col-xl-6 mb-xl-0'>"
      tmpHtml += "		  <span class='mb-0 fs-13 me-1'><i class='task-icon1 bg-teritary'></i>ì˜ì œÂ·ì¬í™œìš©ë§¤ì…</span>"
      tmpHtml += "		  <span class='text-success fw-semibold fs-12'>"
      tmpHtml += "			<span class=''>"+numberWithCommas(costRevive)+"</span>"
      tmpHtml += "		  </span>"
      tmpHtml += "		</li>"
      tmpHtml += "	  </ul>"
      tmpHtml += "	</div>"
      tmpHtml += "</div>"
      document.getElementById('tabContent_SaleCost').innerHTML = tmpHtml;
    }
    const setTraderList = (tmpIssueList) => {
      // ì˜¤ë¥¸ìª½ ë„ë„›ê·¸ë˜í”„
      $.ajax({
        url: "{% url 'get_TraderList' %}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          seq_no: tmpIssueList.seq_no,
          work_YY: tmpIssueList.work_YY,
          period: tmpIssueList.ê³¼ì„¸ê¸°ê°„,
          youhyung: tmpIssueList.ê³¼ì„¸ìœ í˜•
        }),
        success: function(data) {
          // âœ… sale, cost, card ë°ì´í„° ê°ê° ë„ë„›ìœ¼ë¡œ í‘œì‹œ
          createDonut("donut_sale", data.sale, "ë§¤ì¶œ",tmpIssueList.work_YY+"ë…„ "+tmpIssueList.work_QT, "#87CBF4")
          createDonut("donut_cost", data.cost, "ë§¤ì…",tmpIssueList.work_YY+"ë…„ "+tmpIssueList.work_QT, "#F3A1A1")
          //createDonut("donut_card", data.card, "ì¹´ë“œ (Card)", "#f5c04f"); // ë…¸ë‘ê³„ì—´
        },
        error: function(xhr, status, error) {
          console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
      });

      // âœ… ê³µí†µ ë„ë„›ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
      function createDonut(divId, sourceData, MainText,SubText, baseColor) {
        // ë°ì´í„° ì •ë¦¬ (Top5 + ê¸°íƒ€)
        var sortedData = sourceData.sort((a, b) => Number(b.ê¸ˆì•¡) - Number(a.ê¸ˆì•¡));
        var top5 = sortedData.slice(0, 5);
        var others = sortedData.slice(5);
        if (others.length > 0) {
          var otherSum = others.reduce((acc, cur) => acc + Number(cur.ê¸ˆì•¡), 0);
          top5.push({ ê±°ë˜ì²˜ëª…: "ê¸°íƒ€", ê¸ˆì•¡: otherSum });
        }

        var chartData = top5.map(item => ({
          category: item.ê±°ë˜ì²˜ëª…,
          value: Number(item.ê¸ˆì•¡) || 0
        }));

        am5.ready(function() {
          am5.registry.rootElements.forEach(root => {
            if (root.dom.id === divId) root.dispose();
          });

          var root = am5.Root.new(divId);
          root.setThemes([am5themes_Animated.new(root)]);

          // âœ… ë„ë„› í¬ê¸° ê³ ì •
          var chart = root.container.children.push(
            am5percent.PieChart.new(root, {
              layout: root.verticalLayout,
              innerRadius: am5.percent(50),  // ë„ë„› ë‘ê»˜
              radius: am5.percent(70)        // âœ… ë„ë„› í¬ê¸° ì¼ì •í•˜ê²Œ ìœ ì§€
            })
          );

          var series = chart.series.push(
            am5percent.PieSeries.new(root, {
              valueField: "value",
              categoryField: "category"
            })
          );

          var colorSet = am5.ColorSet.new(root, {
            colors: [am5.color(baseColor)]
          });
          series.set("colors", colorSet);

          series.data.setAll(chartData);

          // âœ… ë©”ì¸ ë¼ë²¨ (í° ê¸€ì”¨)
          series.children.push(
            am5.Label.new(root, {
              text: MainText,
              fontSize: 22,       // âœ… í¬ê²Œ
              fontWeight: "bold",
              centerX: am5.p50,
              centerY: am5.p50,
              textAlign: "center"
            })
          );

          // âœ… ì„œë¸Œ ë¼ë²¨ (ì‘ì€ ê¸€ì”¨, ì•„ë˜ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™)
          series.children.push(
            am5.Label.new(root, {
              text: SubText,
              fontSize: 14,       // âœ… ì‘ê²Œ
              centerX: am5.p50,
              centerY: am5.p50,
              dy: 18,             // âœ… ì•„ë˜ìª½ìœ¼ë¡œ 18px ë‚´ë ¤ì„œ ë°°ì¹˜
              textAlign: "center"
            })
          );

          // âœ… ë²”ë¡€ (ì°¨íŠ¸ ì•„ë˜ìª½ ë°°ì¹˜)
          var legend = chart.children.push(
            am5.Legend.new(root, {
              centerX: am5.p50,
              x: am5.p50,
              marginTop: 10,
              maxHeight: 100,
              scrollable: true
            })
          );
          legend.data.setAll(series.dataItems);
        });
      }


      am5.addLicense("AM5C372573951");
    }
    const changeAll = (tmpIssueList)=>{
      console.log(tmpIssueList)
      setDivInspect(tmpIssueList);    //ì ê²€ì‚¬í•­
      setDivTitle(tmpIssueList);      //ì‹ ê³ ê¸°ê°„ íƒ€ì´í‹€ ì„¤ì •
      setTabContent(tmpIssueList);    //ë§¤ì¶œ/ë§¤ì…ë‚´ì—­  
      setTraderList(tmpIssueList);    //ì™¼ìª½ ê±°ë˜ì²˜ë³„ ë„ë„›
    }
    //############# 3. ê²€ì¦
    function setInspectVat_LeftTop(record, seq_no, work_YY, work_QT) {
      $.ajax({
        url: "{% url 'get_IssueVatList' %}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ seq_no: seq_no, work_YY: work_YY, work_QT: work_QT }),
        dataType: "json",
        success: function (res) {
          if (res.status !== "success" || !Array.isArray(res.data)) {
            console.error("ì‘ë‹µ ì˜¤ë¥˜:", res);
            return;
          }

          const selectedClass = 'selected-row-inspect';

          const rowsHtml = res.data.map((row, index) => `
            <tr class="hoverable-row inspect-row" data-index="${index}" data-skgb="${row.ê³¼ì„¸ìœ í˜• || ''}">
              <td>${row.ê³¼ì„¸ê¸°ê°„ || ""}</td>
              <td>${row.ì‹ ê³ êµ¬ë¶„ || ""}</td>
              <td>${row.í™˜ê¸‰êµ¬ë¶„ || ""}</td>
              <td style="display:none;">${row.ê³¼ì„¸ìœ í˜• || ""}</td>
            </tr>
          `).join("");

          const tmpTable = `
            <div class="table-responsive">
              <table class="table text-nowrap text-md-nowrap table-bordered">
                <thead>
                  <tr>
                    <th class="wp-20">ê³¼ì„¸ê¸°ê°„</th>
                    <th class="wp-20">ì‹ ê³ êµ¬ë¶„</th>
                    <th class="wp-20">êµ¬ë¶„</th>
                    <th class="wp-0" style="display:none;">ê³¼ì„¸ìœ í˜•</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;

          $('#InspectVat_LeftTop').html(tmpTable);

          // âœ… ì²« í–‰ ì„ íƒ
          const firstRow = $('#InspectVat_LeftTop .inspect-row').first();
          if (firstRow.length) {
            firstRow.addClass(selectedClass).css({
              'background-color': '#ffd700',
              'font-weight': 'bold'
            });

            const rowIndex = firstRow.data('index');
            const selectedRow = res.data[rowIndex];
            handleInspectRowClick(seq_no, work_YY, work_QT, selectedRow);
          }

          // âœ… ì´ë²¤íŠ¸ ë°”ì¸ë”©
          $('#InspectVat_LeftTop .inspect-row')
            .on('mouseenter', function () {
              if (!$(this).hasClass(selectedClass)) {
                $(this).css({
                  'background-color': '#fffacd',
                  'font-weight': 'bold'
                });
              }
            })
            .on('mouseleave', function () {
              if (!$(this).hasClass(selectedClass)) {
                $(this).css({
                  'background-color': '',
                  'font-weight': ''
                });
              }
            })
            .on('click', function () {
              $('#InspectVat_LeftTop .inspect-row').removeClass(selectedClass).css({
                'background-color': '',
                'font-weight': ''
              });

              $(this).addClass(selectedClass).css({
                'background-color': '#ffd700',
                'font-weight': 'bold'
              });

              const rowIndex = $(this).data('index');
              const selectedRow = res.data[rowIndex];
              handleInspectRowClick(seq_no, work_YY, work_QT, selectedRow);
            });
        },
        error: function (xhr, status, error) {
          console.error("AJAX ì˜¤ë¥˜:", error);
        }
      });
    }
    function handleInspectRowClick(seq_no, work_YY, work_QT,selectedRow){
      kwasekikan = selectedRow.ê³¼ì„¸ê¸°ê°„
      SKGB = selectedRow.ì‹ ê³ êµ¬ë¶„
      KSUH = selectedRow.ê³¼ì„¸ìœ í˜•
      $.ajax({
          url: "{% url 'get_InspectVat' %}",  // Django API ì—”ë“œí¬ì¸íŠ¸
          type: "POST",
          contentType: "application/json",  // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
          data: JSON.stringify({ seq_no: seq_no, work_YY:work_YY, work_QT:work_QT, kwasekikan:kwasekikan, SKGB:SKGB, KSUH:KSUH }),  // JSON ë°ì´í„°ë¡œ ë³€í™˜
          dataType: "json",
          success: function (res) {
            if (res.status !== "success" ) {
              $('#InspectVat_Right').html(res.data);
            }
            let result = res.data;
            let tmpTable = `
              <h4>ğŸ“‹ ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³  ê²€ì¦ ê²°ê³¼ :: ${kwasekikan} ${SKGB}</h4>
              <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">
                <thead style="background-color:#f2f2f2;">
                  <tr>
                    <th  style="width:50%;"">ì ê²€ì‚¬í•­</th>
                    <th>ê²€ì¦ëŒ€ìƒê¸ˆì•¡</th>
                    <th>ì‹ ê³ ì„œ ì‘ì„±ê¸ˆì•¡</th>
                    <th>ì í•©ì—¬ë¶€</th>
                    <th>ì°¨ì´ ì›ì¸</th>
                  </tr>
                </thead>
                <tbody>
            `;
            // ë°°ì—´ì¸ì§€ í™•ì¸
            if (!Array.isArray(result)) {
              console.error("ì„œë²„ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹˜:", result);
              $('#InspectVat_Right').html(`<p style="color:red;">âš ï¸ ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>`);
              return;
            }        
            result.forEach((row, idx) => {
              const [
                item, targetAmt, reportedAmt, status, message
              ] = row;

              // Decimal ê°ì²´ê°€ ë¬¸ìì—´ë¡œ ë„˜ì–´ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìˆ«ì ë³€í™˜ ì‹œ ì²˜ë¦¬
              const formatAmt = (val) => {
                if (typeof val === "number") return val.toLocaleString();
                if (typeof val === "string" && !isNaN(val)) return parseFloat(val).toLocaleString();
                return val; // '-', null ë“± ê·¸ëŒ€ë¡œ ì¶œë ¥
              };

              const rowColor = status === "âš ï¸" ? ' style="background-color:#fff3cd;"' : "";

              tmpTable += `
                <tr${rowColor}>
                  <td>${item}</td>
                  <td style="text-align:right;">${formatAmt(targetAmt)}</td>
                  <td style="text-align:right;">${formatAmt(reportedAmt)}</td>
                  <td style="text-align:center;">${status}</td>
                  <td>${message || "-"}</td>
                </tr>`;
            });
            tmpTable += `
                </tbody>
              </table>
            `;
            $('#InspectVat_Right').html(tmpTable);
          },
          error: function (xhr, status, error) {
              console.error("AJAX ì˜¤ë¥˜:", error);
          }
      });
    }
    //############# 4. í†µí•©ì¡°íšŒ
    function setTongVat_LeftTop(record, seq_no, work_YY, work_QT) {
      $.ajax({
        url: "{% url 'get_IssueVatList' %}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ seq_no: seq_no, work_YY: work_YY, work_QT: work_QT }),
        dataType: "json",
        success: function (res) {
          if (res.status !== "success" || !Array.isArray(res.data)) {
            console.error("ì‘ë‹µ ì˜¤ë¥˜:", res);
            return;
          }

          const selectedClass = 'selected-row-tong';

          const rowsHtml = res.data.map((row, index) => `
            <tr class="hoverable-row tong-row" data-index="${index}" data-skgb="${row.ê³¼ì„¸ìœ í˜• || ''}">
              <td>${row.ê³¼ì„¸ê¸°ê°„ || ""}</td>
              <td>${row.ì‹ ê³ êµ¬ë¶„ || ""}</td>
              <td>${row.í™˜ê¸‰êµ¬ë¶„ || ""}</td>
              <td style="display:none;">${row.ê³¼ì„¸ìœ í˜• || ""}</td>
            </tr>
          `).join("");

          const tmpTable = `
            <div class="table-responsive">
              <table class="table text-nowrap text-md-nowrap table-bordered">
                <thead>
                  <tr>
                    <th class="wp-20">ê³¼ì„¸ê¸°ê°„</th>
                    <th class="wp-20">ì‹ ê³ êµ¬ë¶„</th>
                    <th class="wp-20">êµ¬ë¶„</th>
                    <th class="wp-0" style="display:none;">ê³¼ì„¸ìœ í˜•</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;

          // âœ… ì˜ëª»ëœ ìœ„ì¹˜ ìˆ˜ì •
          $('#tongVat_LeftTop').html(tmpTable);

          // âœ… ìµœì´ˆ ìë™ ì„ íƒ
          const $firstRow = $('#tongVat_LeftTop .tong-row').first();
          if ($firstRow.length) {
            $firstRow.addClass(selectedClass).css({
              'background-color': '#ffd700',
              'font-weight': 'bold'
            });

            const rowIndex = $firstRow.data('index');
            const selectedRow = res.data[rowIndex];
            handleTongRowClick(seq_no, work_YY, work_QT, selectedRow);
          }

          // âœ… ì´ë²¤íŠ¸ ë°”ì¸ë”©ì€ tong-rowì—ë§Œ
          $('#tongVat_LeftTop .tong-row')
            .on('mouseenter', function () {
              if (!$(this).hasClass(selectedClass)) {
                $(this).css({
                  'background-color': '#fffacd',
                  'font-weight': 'bold'
                });
              }
            })
            .on('mouseleave', function () {
              if (!$(this).hasClass(selectedClass)) {
                $(this).css({
                  'background-color': '',
                  'font-weight': ''
                });
              }
            })
            .on('click', function () {
              $('#tongVat_LeftTop .tong-row').removeClass(selectedClass).css({
                'background-color': '',
                'font-weight': ''
              });

              $(this).addClass(selectedClass).css({
                'background-color': '#ffd700',
                'font-weight': 'bold'
              });

              const rowIndex = $(this).data('index');
              const selectedRow = res.data[rowIndex];
              handleTongRowClick(seq_no, work_YY, work_QT, selectedRow);
            });
        },
        error: function (xhr, status, error) {
          console.error("AJAX ì˜¤ë¥˜:", error);
        }
      });
    } 
    function handleTongRowClick(seq_no, work_YY, work_QT,selectedRow){
      kwasekikan = selectedRow.ê³¼ì„¸ê¸°ê°„
      SKGB = selectedRow.ì‹ ê³ êµ¬ë¶„
      KSUH = selectedRow.ê³¼ì„¸ìœ í˜•
      if (KSUH === '') {
        KSUH = 'C07';
        if (parseInt(work_QT) === 1 || parseInt(work_QT) === 3) {
          KSUH = 'C17';
        }
      }
      $.ajax({
          url: "{% url 'get_TongVat' %}",  // Django API ì—”ë“œí¬ì¸íŠ¸
          type: "POST",
          contentType: "application/json",  // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
          data: JSON.stringify({ seq_no: seq_no, work_YY:work_YY, work_QT:work_QT, kwasekikan:kwasekikan, SKGB:SKGB, KSUH:KSUH }),  // JSON ë°ì´í„°ë¡œ ë³€í™˜
          dataType: "json",
          success: function (res) {
            if (res.status === "success") {
              renderTongVatRightLayout(res);
            } else {
              $('#TongVat_Right').html(`<div class="alert alert-warning">${res.data}</div>`);
            }
          },
          error: function (xhr, status, error) {
              console.error("AJAX ì˜¤ë¥˜:", error);
          }
      });
    }
    function renderCard_Tong(title, height, headers, rows) {
      return `
        <div class="card mb-3">
          <div class="card-header">${title}</div>
          <div class="card-body p-0">
            <table class="table table-bordered text-center mb-0">
              <thead>
                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr>
                    ${row.map(cell => {
                      const cleaned = String(cell).replace(/,/g, '').trim();
                      const isNumber = cleaned !== '' && !isNaN(cleaned);
                      const cls = isNumber ? 'text-end' : '';
                      return `<td class="${cls}">${cell}</td>`;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    function renderTongVatRightLayout(data) {
      let leftCards = '';
      leftCards += renderCard_Tong("ë§¤ì¶œ ì¡°íšŒ ê²°ê³¼",350, ["êµ¬ë¶„", "ê³µê¸‰ëŒ€ê°€", "ê³µê¸‰ê°€ì•¡", "ì„¸ì•¡", "ì „ìì‹ ê³  ê³µê¸‰ê°€ì•¡", "ê²€ì¦"], data.sales_result);
      leftCards += renderCard_Tong("ë§¤ì… ì¡°íšŒ ê²°ê³¼",400, ["êµ¬ë¶„", "ê³µê¸‰ëŒ€ê°€", "ê³µê¸‰ê°€ì•¡", "ì„¸ì•¡", "ê²€ì¦"], data.purchase_result);
      leftCards += renderCard_Tong("ì˜ˆì •ì„¸ì•¡ ì¡°íšŒ ê²°ê³¼",200, ["êµ¬ë¶„", "ì˜ˆì •ê³ ì§€", "ì˜ˆì •ë¯¸í™˜ê¸‰", "ì˜ˆì •ë¶€ê³¼ê°„ì´", "ì˜ˆì •ì‹ ê³ ê°„ì´", "ë§¤ì…ìíŠ¹ë¡€ë‚©ë¶€", "ê²€ì¦"], data.expected_tax_result);

      let rightCards = '';
      rightCards += renderCard_Tong("ì „ì²´ë§¤ì¶œ(ì‹ ì¹´+íŒë§¤ëŒ€í–‰+í˜„ì˜) í•©ê³„",300, ["êµ¬ë¶„", "ê³µê¸‰ëŒ€ê°€", "ê³µê¸‰ê°€ì•¡", "ì„¸ì•¡", "ê±´ ìˆ˜"], data.total_result);
      rightCards += renderCard_Tong("ì‹ ìš©ì¹´ë“œë§¤ì¶œ",300, ["êµ¬ë¶„", "ê³µê¸‰ëŒ€ê°€", "ê³µê¸‰ê°€ì•¡", "ì„¸ì•¡", "ê±´ ìˆ˜"], data.sinca_result);
      rightCards += renderCard_Tong("í˜„ê¸ˆì˜ìˆ˜ì¦ ë§¤ì¶œ",300, ["êµ¬ë¶„", "ê³µê¸‰ëŒ€ê°€", "ê³µê¸‰ê°€ì•¡", "ì„¸ì•¡", "ê±´ ìˆ˜"], data.cash_result);
      rightCards += renderCard_Tong("íŒë§¤ëŒ€í–‰ ë§¤ì¶œ",300, ["êµ¬ë¶„", "ë§¤ì¶œì•¡ê³„", "ì‹ ìš©ì¹´ë“œì¤‘ë³µ", "êµ¬ë§¤ëŒ€í–‰ì¹´ë“œ", "ê±´ ìˆ˜", "ëŒ€í–‰ì‚¬"], data.pmdh_result);

      const html = `
        <div class="row">
          <div class="col-md-6">${leftCards}</div>
          <div class="col-md-6">${rightCards}</div>
        </div>
      `;

      $('#TongVat_Right').html(html);
    }
    //############# 4. ìˆ˜ìˆ˜ë£Œ 
    function setFee(record, seq_no, work_YY, work_QT){
      $.ajax({
          url: "{% url 'get_Fee_data'%}",  // Django API ì—”ë“œí¬ì¸íŠ¸
          type: "POST",
          data: {
            seq_no: seq_no,
            work_YY: work_YY,
            work_QT:work_QT,
            csrfmiddlewaretoken: "{{ csrf_token }}"
          },
          dataType: "json",
          success: function (data) {
            if (data.error) {
                console.error(data.error);
                return;
            }

            // ğŸ“Œ í…Œì´ë¸”ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•œ í›„ ë°ì´í„° ì ìš©
            let tmpTable = `
              <style>
                .fee-table {
                  width: 100%;
                  border-collapse: collapse;
                  margin-top: 20px;
                  font-size: 14px;
                }

                .fee-table thead {
                  background-color: #f8f9fa;
                }

                .fee-table th, .fee-table td {
                  padding: 10px;
                  border: 1px solid #dee2e6;
                  text-align: center;
                }

                .fee-table tbody tr:nth-child(even) {
                  background-color: #f6fafd;
                }

                .fee-table tbody tr:nth-child(odd) {
                  background-color: #ffffff;
                }

                .fee-table td.status-yes {
                  color: #2e8b57;
                  font-weight: bold;
                }

                .fee-table td.status-no {
                  color: #dc3545;
                  font-weight: bold;
                }

                .fee-table td.empty {
                  color: #bbb;
                }
              </style>

              <div class="table-responsive">
                <table class="fee-table">
                  <thead>
                    <tr>
                      <th>ë¶„ë¥˜</th>
                      <th>ê·€ì†ë…„ë„</th>
                      <th>êµ¬ë¶„</th>
                      <th>ìˆ˜ìˆ˜ë£Œ</th>
                      <th>ìˆ˜ê¸ˆì—¬ë¶€</th>
                      <th>ìˆ˜ê¸ˆì¼</th>
                      <th>ë°œí–‰ì—¬ë¶€</th>
                      <th>ë°œí–‰ì¼</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            // â–¶ 1. ë¶„ë¥˜ë³„ë¡œ ê·¸ë£¹í•‘
            const groups = {};
            data.forEach(row => {
              if (!groups[row.ë¶„ë¥˜]) groups[row.ë¶„ë¥˜] = [];
              groups[row.ë¶„ë¥˜].push(row);
            });

            // â–¶ 2. ê·¸ë£¹ë³„ë¡œ rowspan ê³„ì‚° í›„ ë Œë”ë§
            for (const ë¶„ë¥˜ in groups) {
              const rows = groups[ë¶„ë¥˜];
              const rowspan = rows.length;

              rows.forEach((row, index) => {
                tmpTable += `<tr>`;

                // ì²« ì¤„ì—ë§Œ ë¶„ë¥˜ + rowspan ì¶œë ¥
                if (index === 0) {
                  tmpTable += `<td rowspan="${rowspan}">${ë¶„ë¥˜}</td>`;
                }

                tmpTable += `
                  <td>${row.ê·€ì†ë…„ë„ || ''}</td>
                  <td>${row.êµ¬ë¶„ || ''}</td>
                  <td>${Number(row.ìˆ˜ìˆ˜ë£Œ || 0).toLocaleString()}ì›</td>
                  <td class="${row.ìˆ˜ê¸ˆì—¬ë¶€ === '1' ? 'status-yes' : row.ìˆ˜ê¸ˆì—¬ë¶€ === '0' ? 'status-no' : 'empty'}">
                    ${row.ìˆ˜ê¸ˆì—¬ë¶€ === '1' ? 'ì˜ˆ' : row.ìˆ˜ê¸ˆì—¬ë¶€ === '0' ? 'ì•„ë‹ˆì˜¤' : '-'}
                  </td>
                  <td class="${row.ìˆ˜ê¸ˆì¼ === '0' || !row.ìˆ˜ê¸ˆì¼ ? 'empty' : ''}">
                    ${row.ìˆ˜ê¸ˆì¼ && row.ìˆ˜ê¸ˆì¼ !== '0' ? row.ìˆ˜ê¸ˆì¼ : '-'}
                  </td>
                  <td class="${row.ë°œí–‰ì—¬ë¶€ === '1' ? 'status-yes' : row.ë°œí–‰ì—¬ë¶€ === '0' ? 'status-no' : 'empty'}">
                    ${row.ë°œí–‰ì—¬ë¶€ === '1' ? 'ì˜ˆ' : row.ë°œí–‰ì—¬ë¶€ === '0' ? 'ì•„ë‹ˆì˜¤' : '-'}
                  </td>
                  <td class="${row.ë°œí–‰ì¼ === '0' || !row.ë°œí–‰ì¼ ? 'empty' : ''}">
                    ${row.ë°œí–‰ì¼ && row.ë°œí–‰ì¼ !== '0' ? row.ë°œí–‰ì¼ : '-'}
                  </td>
                </tr>`;
              });
            }

            tmpTable += `
                  </tbody>
                </table>
              </div>
            `;

            // ğŸ“Œ #4 ìˆ˜ìˆ˜ë£Œë‚´ì—­ ì™¼ìª½
            $('[id="feeDiagnosys"]').html(tmpTable);

            // ğŸ“Œ #4 ìˆ˜ìˆ˜ë£Œë‚´ì—­ ì˜¤ë¥¸ìª½ - ì§€ë‚œ ë¯¸ìˆ˜ê¸ˆ 
            const unpaidList = [];
            const selectedSeq = [];  // ì²­êµ¬í•  í•­ëª©ë“¤

            let unpaidHtml = `<ul class="list-group list-group-flush">`;

            data.forEach((row, idx) => {
              const unpaid = row.ìˆ˜ê¸ˆì—¬ë¶€ !== "1";  // ë¯¸ìˆ˜ ìƒíƒœ

              if (unpaid) {
                unpaidList.push(row);
                const uid = `chk_${idx}`;

                unpaidHtml += `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="${idx}" id="${uid}" onchange="toggleUnpaidSelection(this)">
                      <label class="form-check-label" for="${uid}">
                        [${row.ë¶„ë¥˜}] ${row.ê·€ì†ë…„ë„} ${row.êµ¬ë¶„} - ${Number(row.ìˆ˜ìˆ˜ë£Œ || 0).toLocaleString()}ì›
                      </label>
                    </div>
                  </li>`;
              }
            });

            unpaidHtml += `</ul>`;
            $('[id="unpaidList"]').html(unpaidHtml);
            // document.getElementById("unpaidList").innerHTML = unpaidHtml;

          },
          error: function (xhr, status, error) {
              console.error("AJAX ì˜¤ë¥˜:", error);
          }
      });
    }
    // ìˆ«ìë¥¼ ì„¸ìë¦¬ ì½¤ë§ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    window.formatNumberInput = function(input) {
      // ìŒìˆ˜ì™€ ìˆ«ìë§Œ í—ˆìš©
      let value = input.value.replace(/[^0-9-]/g, '');

      // ìŒìˆ˜ ì²˜ë¦¬
      let isNegative = value.startsWith('-');
      if (isNegative) {
        value = value.slice(1).replace(/[^0-9]/g, '');
      } else {
        value = value.replace(/[^0-9]/g, '');
      }

      // ë¹ˆ ì…ë ¥ ì²˜ë¦¬
      if (!value) {
        input.value = '';
        return;
      }

      // í¬ë§·íŒ…
      let number = Number(value);
      input.value = (isNegative ? '-' : '') + number.toLocaleString('en-US', { minimumFractionDigits: 0 });
    }

    //############# ì•ˆë‚´ ì¹´í†¡ë‚´ìš© ìƒì„±
    // ì ‘ìˆ˜ê²°ê³¼ ê¸°ë³¸ì€ false, ì „ìì‹ ê³ íŒŒì¼ ì—…ë¡œë“œì‹œ true
    let resultAndFee = false;
    const setMailContent = async (seq_no, work_YY, work_QT, flag) => {
      $.ajax({
        url: "{% url 'getMailContent' %}",
        type: "POST",
        data: {
          seq_no: seq_no,
          work_YY: work_YY,
          work_QT: work_QT,
          flag:flag,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        dataType: "json",
        success: function (data) {
          var bodyContent = data.email_content
          $('[id="' + flag + '"]').html(bodyContent);
        },
        error: function (request, status, error) {
          console.log('fail: '+flag + error);
        }
      });
    };
    const setPDFIframe = async (ADID, seq_no,ceo_name,biz_name,work_YY,work_QT,flag) => {
      let kskk = "";  
      switch (work_QT) {
        case 1:
        kskk = "1ê¸°ì˜ˆì •";
          break;
        case 2:
        kskk = "1ê¸°í™•ì •";
          break;
        case 3:
        kskk = "2ê¸°ì˜ˆì •";
          break;
        case 4:
        kskk = "2ê¸°í™•ì •";
          break;
        default:
        kskk = "ê¸°ìˆ˜ë¯¸ì •";
          break;
      }
    
      srcpath = biz_name
      if (ADID=="í™”ë¬¼") {
        srcpath = `í™”ë¬¼ì—°ëŒ€/${ceo_name}`
      }
      let pdfFile = `static/cert_DS/${srcpath}/${work_YY}/ë¶€ê°€ì„¸/${kskk}/300.pdf`;  
      if (flag=="VatResult" || flag=="VatPrepay") {
        pdfFile = `static/cert_DS/${srcpath}/${work_YY}/ë¶€ê°€ì„¸/${kskk}/200.pdf`;  
      }
      const iframe = document.getElementById(`${flag}PDFIframe`);
      if (!iframe) { console.warn('iframe not found', flag); return; }
      try {
          // HEAD ìš”ì²­ì€ íŒŒì¼ì˜ ë‚´ìš©ì„ ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³ , íŒŒì¼ì˜ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸í•¨.
          let response = await fetch(pdfFile, { method: 'HEAD' });    
          if (response.ok) {
              // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° iframe ì—…ë°ì´íŠ¸
              
              if (iframe) {
                  iframe.src = pdfFile;  // âœ… íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ iframeì— í‘œì‹œ
              } else {
                iframe.innerHTML = "ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(300.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                if (flag=="VatResult" || flag=="VatPrepay") {
                  iframe.innerHTML = "ë¶€ê°€ê°€ì¹˜ì„¸ ë‚©ë¶€ì„œ(200.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                }
              }
          } else {
            iframe.innerHTML = "ë¶€ê°€ê°€ì¹˜ì„¸ ì‹ ê³ ë„ì›€ ì•ˆë‚´ë¬¸(300.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
            if (flag=="VatResult" || flag=="VatPrepay") {
              iframe.innerHTML = "ë¶€ê°€ê°€ì¹˜ì„¸ ë‚©ë¶€ì„œ(200.pdf)ì„ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
            }        
          }
      } catch (error) {
        iframe.innerHTML = "PDF íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:"+ error;
      }
    };

    // í•˜ë‹¨ ì¹´í†¡&ë©”ì¼ ë³´ë‚´ê¸°
    const sendMailAndKakao = async (ADID, seq_no, ceo_name, biz_name, work_YY, work_QT, mail_class) => {
      let kskk = "";
      switch (work_QT) {
        case 1:
        kskk = "1ê¸°ì˜ˆì •";
          break;
        case 2:
        kskk = "1ê¸°í™•ì •";
          break;
        case 3:
        kskk = "2ê¸°ì˜ˆì •";
          break;
        case 4:
        kskk = "2ê¸°í™•ì •";
          break;
        default:
        kskk = "ê¸°ìˆ˜ë¯¸ì •";
          break;
      }  
      const objectUrl = "{% url 'sendMail' %}";
      const objectUrl_kakao = "{% url 'send_kakao_notification' %}";
      srcpath = biz_name
      if (ADID=="í™”ë¬¼") {
        srcpath = `í™”ë¬¼ì—°ëŒ€/${ceo_name}`
      }  
      const user_path = `static/cert_DS/${srcpath}/${work_YY}/ë¶€ê°€ì„¸/${kskk}`;
      var user_file_names = []
      var targetUrl = '';
      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      let allIsGood = true;

      if(mail_class=="VatIntro"){
        targetUrl = 'admin/mail/vat_intro.html';
        checkfileName = "300.pdf";
        let filePath = `${user_path}/${checkfileName}`;
        let exists = await fileExists(filePath);
        if (!exists) {
          allIsGood = false;
          alert(`íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
        } else {
          user_file_names.push(checkfileName)
        }   
      } else if(mail_class=="VatPrepay"){
        targetUrl = 'admin/mail/vat_prepay.html';
        checkfileName = "200.pdf";
        let filePath = `${user_path}/${checkfileName}`;
        let exists = await fileExists(filePath);
        if (!exists) {
          allIsGood = false;
          alert(`íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
        } else {
          user_file_names.push(checkfileName)
        }       
      } else if(mail_class=="VatResult"){
        targetUrl = 'admin/mail/vat_result.html';   
        const response = await fetch("{% url 'isVatNapbu' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ seq_no: seq_no, work_YY: work_YY, work_QT: work_QT })
        });
        const result = await response.json();
        if (result.result) {
          
          checkfileName = "200.pdf";
          let filePath = `${user_path}/${checkfileName}`;
          let exists = await fileExists(filePath);
          if (!exists) {
            allIsGood = false;
            alert(`íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${filePath}`);
          } else {
            user_file_names.push(checkfileName)
          } 
        } else {
          //ì²¨ë¶€íŒŒì¼ ë„£ì„ í•„ìš”ê°€ ì—†ë‹¤
          allIsGood = true;
        }
        
      } else if(mail_class=="VatFee"){
        targetUrl = 'admin/mail/vat_fee.html';
        checkYN12(seq_no, work_YY, work_QT).then(function (exists) {
            if (!exists) {
                allIsGood = false;
                alert("ìˆ˜ìˆ˜ë£Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        });
      }
      // ê¸°ë³¸ì€ ë°œì†¡; íŒŒì¼ ì¡´ì¬ì‹œ ì—¬ë¶€ ì²´í¬í•´ì„œ ì—†ìœ¼ë©´ false
      // ë¶€ê°€ì„¸ ìˆ˜ìˆ˜ë£ŒëŠ” ì¼ë‹¨ ì¹´í†¡ë§Œ ë³´ë‚´ê¸°ë¡œ í•œë‹¤
      if (allIsGood) {
        if(mail_class!="VatFee"){
          sendMail(seq_no, work_YY, work_QT*3, mail_class, objectUrl, targetUrl,user_file_names, user_path);
        }
        sendKakao(seq_no, work_YY, work_QT*3, mail_class, objectUrl_kakao);
      } else {
        alert("ë©”ì¼ê³¼ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì†¡ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    };
    function checkYN12(seq_no, work_YY,work_QT) {
        return $.ajax({
            url: "{% url 'check_yn12' %}",
            type: "POST",
            data: { seq_no: seq_no, work_YY: work_YY,work_QT:work_QT },
            dataType: "json"
        }).then(function (data) {
            return data.exists; // YN_12 ê°’ì´ ì¡´ì¬í•˜ë©´ true, ì—†ìœ¼ë©´ false
        }).catch(function (error) {
            console.error("ğŸš¨ API í˜¸ì¶œ ì˜¤ë¥˜:", error);
            return false;
        });
    }
    // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
    const fileExists = async (filePath) => {
      try {
        let response = await fetch(filePath, { method: 'HEAD' });
        return response.ok; // íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ true, ì—†ìœ¼ë©´ false
      } catch (error) {
        console.error("íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        return false;
      }
    };

    //ì ‘ìˆ˜ì¦ ë§ˆìš°ìŠ¤ í´ë¦­ì‹œ íˆ´íŒë°œìƒ
    function attachGridToolTip_JupsuSummit(grid,work_YY,work_QT){
      Ext.create('Ext.tip.ToolTip', {
          target: grid.getEl(),
          delegate: '.x-grid-cell', // ì…€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦´ ë•Œë§Œ í™œì„±í™”
          trackMouse: false, // ë§ˆìš°ìŠ¤ë¥¼ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ
          dismissDelay: 0, // ìë™ ë‹«í˜ ë¹„í™œì„±í™”
          autoHide: true, // ë§ˆìš°ìŠ¤ê°€ ë– ë‚˜ë©´ ìˆ¨ê¹€
          maxWidth: 600, // ìµœëŒ€ ë„ˆë¹„ë¥¼ í™•ì¥
          minWidth: 300, // ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •   
          anchorToTarget: true, // íˆ´íŒì´ ì…€ì— ë§ê²Œ ìœ„ì¹˜ ì¡°ì •
          mouseOffset: [-350, -20], // ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •      
          renderTo: Ext.getBody(),
          listeners: {
            beforeshow: function (tip) {
              const cell = Ext.get(tip.triggerElement);
              const record = grid.getView().getRecord(cell.parent());
              const columnIndex = cell.dom.cellIndex;
              const column = grid.headerCt.getHeaderAtIndex(columnIndex);
            
              if (column.dataIndex === 'isIssue') {
                const seqNo = record.get('seq_no');
                Ext.Ajax.request({
                    url: '{% url "mng_vat_jupsuSummit" %}',//ì´ ë¶€ë¶„ ìˆ˜ì •í•´ì•¼í•œë‹¤
                    method: 'POST',
                    params: {
                      seq_no:seqNo,
                      work_YY:work_YY,
                      work_QT:work_QT,
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                    }, 
                    success: function (response) {
                        const data = Ext.decode(response.responseText);
                        tip.update(`
                    <div class="notifications-menu ps3 overflow-hidden">
                        <div class="drop-heading border-bottom position-relative">
                            <div class="d-flex">
                                <div class="counter-icon bg-primary dash d-flex box-shadow-primary">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="fill-white" enable-background="new 0 0 24 24" viewBox="0 0 24 24"><path d="M12,8c-2.2091675,0-4,1.7908325-4,4s1.7908325,4,4,4c2.208252-0.0021973,3.9978027-1.791748,4-4C16,9.7908325,14.2091675,8,12,8z M12,15c-1.6568604,0-3-1.3431396-3-3s1.3431396-3,3-3c1.6561279,0.0018311,2.9981689,1.3438721,3,3C15,13.6568604,13.6568604,15,12,15z M21.960022,11.8046875C19.9189453,6.9902344,16.1025391,4,12,4s-7.9189453,2.9902344-9.960022,7.8046875c-0.0537109,0.1246948-0.0537109,0.2659302,0,0.390625C4.0810547,17.0097656,7.8974609,20,12,20s7.9190063-2.9902344,9.960022-7.8046875C22.0137329,12.0706177,22.0137329,11.9293823,21.960022,11.8046875z M12,19c-3.6396484,0-7.0556641-2.6767578-8.9550781-7C4.9443359,7.6767578,8.3603516,5,12,5s7.0556641,2.6767578,8.9550781,7C19.0556641,16.3232422,15.6396484,19,12,19z"/></svg>
                                </div>
                                <div class="ms-3">
                                    <h6 class="mt-1 mb-0 fs-15 text-dark">ë²•ì¸ì„¸ ì „ìì‹ ê³  ì ‘ìˆ˜ì¦</h6>
                                    <span class="text-muted">${Ext.String.htmlEncode(data.biz_name)} - ${Ext.String.htmlEncode(data.ceo_name)}</span>
                                </div>
                            </div>
                            <button type="button" class="btn-close position-absolute end-0 top-50 translate-middle-y me-2" aria-label="Close" id="tooltipCloseBtn"><i class="fe fe-x"></i></button>
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">${data.ì‹ ê³ ì„œì¢…ë¥˜}</span>
                                </div>
                            </div>                                                                                    
                        </div>                                                                                    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">íšŒê³„ê¸°ê°„ ì¢…ë£Œì›” ${data.ê³¼ì„¸ë…„ì›”}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>      
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ìœ í˜• : ${data.ì‹ ê³ ìœ í˜•}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                                                                                              
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ë²ˆí˜¸</span>
                                  <span class="notification-label ">${data.ì‹ ê³ ë²ˆí˜¸}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>    
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì‹ ê³ ì‹œê° ${data.ì‹ ê³ ì‹œê°}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                          
                        <div class="dropdown-divider m-0"></div>        
                        <div class="dropdown-item">
                            <div class="notification-each d-flex">
                                <div class="me-3 notifyimg  bg-info brround">
                                    <i class="icon icon-organization"></i>
                                </div>
                                <div>
                                  <span class="notification-label mb-1">ì ‘ìˆ˜ID ${data.ì‚¬ìš©ìID}</span>
                                </div>                  
                            </div>                                                                                    
                        </div>                                              
                    </div>
                        `);
                          // ë‹«ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                          Ext.defer(() => {
                              const closeButton = document.getElementById("tooltipCloseBtn");
                              if (closeButton) {
                                  closeButton.addEventListener("click", function () {
                                      tip.hide();
                                  });
                              }
                          }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ì¤˜ì„œ DOMì´ ë Œë”ë§ëœ í›„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
                    },
                    failure: function () {
                        tip.update('<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
                    }
                });
              } else {
                  return false; // ë‹¤ë¥¸ ì—´ì—ì„œëŠ” íŒì˜¤ë²„ë¥¼ ìˆ¨ê¹€
              }
            }
          }
      });  
    }


})();
</script>
