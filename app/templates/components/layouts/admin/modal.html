{% load static %}
<style>
    /* 디자인 커스텀 스타일 */
    #smsModal .modal-content { border-radius: 12px; overflow: hidden; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    #smsModal .modal-header { background: #f8f9fa; border-bottom: 1px solid #eee; padding: 1rem 1.5rem; }
    #smsModal .nav-tabs { border-bottom: 2px solid #f0f0f0; padding: 0 1rem; }
		/* 활성화된 탭의 글자색과 배경색을 명시적으로 지정 */
		#smsModal .nav-link.active { 
				color: #007bff !important;      /* 활성 탭 글자색 (파란색) */
				background-color: #ffffff !important; /* 활성 탭 배경색 (흰색) */
				border-bottom: 2px solid #007bff !important; 
				font-weight: bold !important;   /* 글자를 두껍게 하여 가독성 향상 */
		}

		/* 비활성 탭 글자색도 명확하게 지정 */
		#smsModal .nav-link { 
				color: #495057 !important;      /* 비활성 탭 글자색 (짙은 회색) */
				background: transparent;
				border: none;
		}
    
    .sms-container { display: flex; flex-wrap: wrap; }
    .sms-form-section { flex: 1; min-width: 300px; padding: 20px; border-right: 1px solid #eee; }
    .sms-template-section { width: 320px; padding: 20px; background: #fafafa; max-height: 650px; overflow-y: auto; }
    
    .template-card { 
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; 
        margin-bottom: 10px; cursor: pointer; transition: all 0.2s; 
    }
    .template-card:hover { border-color: #007bff; background: #f0f7ff; transform: translateY(-2px); }
    .template-card h6 { margin-bottom: 5px; font-size: 14px; color: #333; font-weight: 600; }
    .template-card p { font-size: 12px; color: #888; margin-bottom: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .balance-badge { background: #eef4ff; color: #007bff; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 13px; }
    .reserve-card { background: #fdfdfd; border: 1px dashed #ddd; border-radius: 8px; }
    #smsContent { font-family: 'Malgun Gothic', sans-serif; line-height: 1.5; resize: none; border-radius: 8px; }

		/* 탭 가독성 보정 */
		#smsModal .nav-link.active { 
				color: #007bff !important; 
				background-color: #fff !important; 
				border-bottom: 2px solid #007bff !important; 
				font-weight: bold !important; 
		}
		#smsModal .nav-link { color: #555 !important; }

		/* 리스트 호버 효과 */
		#smsSentTable tbody tr:hover { background-color: #f0f7ff; }
		#smsSentTable .badge { font-size: 11px; font-weight: 500; }		
		/* 구분 뱃지 색상 명시 (흰 글자 문제 방지) */
		#smsSentTable .badge.bg-outline-primary {
				color: #0d6efd !important;
				background-color: #e7f1ff !important;
				border: 1px solid #0d6efd !important;
		}
		/* 리스트 행 스타일 */
    .sms-row { transition: background-color 0.2s; border-bottom: 1px solid #f0f0f0; }
    .sms-row:hover { background-color: #f8fbff !important; }
    
    /* 열려있는 행 강조 */
    .active-row { background-color: #eef4ff !important; border-left: 4px solid #007bff !important; }

    /* 상세 내용 박스 (타원형 방지 및 박스 정돈) */
    .sms-detail-content { background-color: #fafafa !important; }
		/* 1. 타원형 방지: 테두리 곡률을 4px로 고정하고 좌측 포인트 강조 */
    .sms-detail-container {
        border: 1px solid #dee2e6 !important;
        border-radius: 4px !important; /* 타원형이 되지 않도록 작은 값 고정 */
        background-color: #ffffff !important;
        padding: 15px;
        margin: 5px 0;
        border-left: 5px solid #007bff !important; /* 좌측에 파란 선을 주어 강조 */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        white-space: pre-wrap;
        font-size: 13px;
        line-height: 1.6;
        color: #333;
    }

    /* 2. 행 강조 스타일 */
    .sms-row.active-row {
        background-color: #f0f7ff !important;
    }
</style>

<div class="modal fade" id="smsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h6 class="modal-title d-flex align-items-center">
                    <i class="fe fe-message-square me-2 text-primary"></i> 문자 발송 시스템
                </h6>
                <div class="d-flex align-items-center">
                    <span class="balance-badge me-2">
                        잔여 <span id="smsBalanceCount" class="highlighter-rouge">...</span> 건
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-light text-dark" id="smsRefreshBalance">
                        <i class="fe fe-refresh-cw"></i>
                    </button>
                    <button type="button" class="btn-close ms-3" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>

            <ul class="nav nav-tabs" id="smsTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#task-1">문자발송</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#task-2">발송내역조회</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="task-1">
                    <div class="sms-container">
                        <div class="sms-form-section">
                            <form id="smsForm">
                                <input type="hidden" id="smsSeqNo">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">발신번호</label>
                                        <input type="text" class="form-control" id="smsSender" placeholder="담당자 번호 자동적용">
                                        <div id="smsSenderHint" class="form-text text-primary" style="font-size: 11px;"></div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">수신번호</label>
                                        <input type="text" class="form-control" id="smsReceiver" placeholder="010-0000-0000">
                                        <div id="smsReceiverHint" class="form-text text-primary" style="font-size: 11px;"></div>
                                    </div>
                                </div>

                                <div class="reserve-card p-3 mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fe fe-calendar me-1 text-muted"></i>
                                        <span class="small fw-bold">예약 발송 설정 (선택)</span>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" id="smsReserveDate">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" class="form-control form-control-sm" id="smsReserveHour" placeholder="시(0-23)">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" class="form-control form-control-sm" id="smsReserveMin" placeholder="분(0-59)">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label class="form-label fw-bold">발송 내용</label>
                                    <textarea class="form-control" id="smsContent" rows="10" placeholder="내용을 입력하거나 우측 템플릿을 선택하세요."></textarea>
                                </div>

                                <div class="d-flex justify-content-between align-items-center bg-light p-2 br-5">
                                    <span id="smsCharCount" class="badge bg-secondary">0자 / 1000자</span>
                                    <div class="sms-status text-danger fw-bold small"></div>
                                </div>

                                <div class="mt-4 text-end">
                                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-primary px-5" id="smsSendBtn">
                                        <i class="fe fe-send me-1"></i> 문자 발송하기
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="sms-template-section">
                            <h6 class="fw-bold mb-3"><i class="fe fe-layers me-1"></i> 자주 쓰는 템플릿</h6>
                            <div class="template-card" onclick="applyTemplate(0)">
                                <h6>홈택스 수임동의</h6>
                                <p>원활한 업무진행을 위하여 아래 홈택스...</p>
                            </div>                            
                            <div class="template-card" onclick="applyTemplate(1)">
                                <h6>신규사업자(법인)</h6>
                                <p>사업자등록증, 법인등기부등본 등...</p>
                            </div>
                            <div class="template-card" onclick="applyTemplate(2)">
                                <h6>신규사업자(개인)</h6>
                                <p>사업자등록증, 임대차계약서 등...</p>
                            </div>
                            <div class="template-card" onclick="applyTemplate(3)">
                                <h6>법인세 신고 서류</h6>
                                <p>법인통장 거래내역, 주식변동 등...</p>
                            </div>
                            <div class="template-card" onclick="applyTemplate(4)">
                                <h6>종소세 신고안내</h6>
                                <p>신고도움 안내문, 기부금영수증 등...</p>
                            </div>
                            <div class="template-card" onclick="applyTemplate(5)">
                                <h6>종소세(화물) 안내</h6>
                                <p>유가보조금, 부가세신고서 등...</p>
                            </div>
                            <div class="template-card" onclick="applyTemplate(6)">
                                <h6>화물 부가세 종이세금</h6>
                                <p>하반기 부가세신고 관련 안내...</p>
                            </div>
                        </div>
                    </div>
                </div>

								<div class="tab-pane fade" id="task-2">
										<div class="p-3">
												<div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
														<table class="table table-sm" id="smsSentTable">
																<thead class="bg-light sticky-top">
																		<tr>
																				<th class="p-2" style="width: 80px;">구분</th>
																				<th class="p-2">내용 요약</th>
																				<th class="p-2" style="width: 110px;">수신번호</th>
																				<th class="p-2" style="width: 140px;">발송일시</th>
																		</tr>
																</thead>
																<tbody id="smsSentListBody">
																		</tbody>
														</table>
												</div>
										</div>
								</div>

            </div>
        </div>
    </div>
</div>

<script>
// 템플릿 데이터 정의
const smsTemplates = {
	  0: `[홈택스 수임동의 안내]\n원활한 업무진행을 위하여 아래 홈택스수임동의 절차를 진행해 주시기 바랍니다.\n\n- 홈택스 로그인 > 조회/발급 > 나의세무대리인수임동의 > 세무법인대승 체크 > 확인\n\n기존에 수임되었던 대리인이 등록되어 있는 경우 해당 세무대리인 해임을 먼저 진행하고 저희 사무실로 연락주시기 바랍니다. `,
    1: `[신규사업자 요청서류(법인)]\n- 사업자등록증\n- 법인등기부등본\n- 주주명부\n- 정관\n- 임대차계약서\n- 대표자신분증사본\n- 홈택스 아이디/패스워드\n- 수수료 자동이체계좌\n- 업무용 이메일주소\n- 차량등록증(법인명의 차량 있는 경우)\n보내실 메일 : daeseung23@gmail.com입니다`,
    2: `[신규사업자 요청서류(개인)]\n- 사업자등록증\n- 주민등록등본(부양가족있는경우)\n- 임대차계약서\n- 대표자신분증사본\n- 홈택스 아이디/패스워드\n- 수수료 자동이체계좌\n- 사업용신용카드 앞면(번호부분)사진\n- 업무용 이메일주소\n- 차량등록증(대표명의 차량 있는 경우)\n보내실 메일 : daeseung23@gmail.com입니다`,
    3: `[법인세 신고 요청서류]\n금번 법인세 신고를 위한 다음 자료를 준비해 주시기 바랍니다.\n- 법인통장 : 거래내역(1.1~12.31)\n- 주식변동내역(주식거래가 있는 경우)\n- 차량등록증(신규 구매가 있는 경우)\n- 채권채무현황(12월말일 현재 거래처 미수금/미지급금)\n\n보내실 곳\n이메일 daeseung23@gmail.com\n팩스 0505-914-3884\n\n감사합니다`,
    4: `[종소세 신고안내]\n- 세무서 신고도움 안내문(문자수신내역)\n- 사업/근로 소득지급명세서\n- 신용카드사용세부내역\n- 기부금영수증\n- 주민등록등본\n- 환급계좌\n\n보내실 곳\n이메일 daeseung23@gmail.com\n팩스 0505-914-3884\n\n감사합니다`,
    5: `[종소세(화물) 신고안내]\n- 사업자등록증\n- 차량등록증\n- 세무서 신고도움 안내문(문자수신내역)\n- 유가보조금내역\n- 부가가치세신고서\n- 신용카드사용세부내역\n- 기부금영수증(있는경우)\n- 주민등본(부양가족있는경우)\n\n보내실 곳\n서울시 강남구 강남대로84길 15,\n206호(세무법인대승)\n팩스 0505-914-3884\n\n감사합니다.`,
    6: `[화물 부가세 중간 종이세금계산서 요청]\n사장님 안녕하세요. 세무법인 대승 입니다.\n하반기 부가세신고를 신속하고 원활하게 진행하기 위하여 7월~9월 종이세금계산서를 준비 되시는대로 이달 15일-30일 사이 우편으로 보내주시기 바랍니다.\n\n주소: 서울시 강남구 강남대로84길 15, 206호(세무법인대승)\n\n오늘도 안전운전 하시고 즐거운 주말 되세요~\n감사합니다.`
};

function applyTemplate(id) {
    if(smsTemplates[id]) {
        document.getElementById('smsContent').value = smsTemplates[id];
        // 글자수 업데이트 호출 (기존에 정의된 함수)
        if(typeof updateCharCount === 'function') updateCharCount();
    }
}
// 1. 전역 함수로 노출 (IIFE 외부 또는 window 객체 활용)
window.loadSmsSentList = function(seq_no) {
    const $tbody = $('#smsSentListBody');
    if (!$tbody.length) return;
    
    $tbody.html('<tr><td colspan="4" class="text-center p-4">데이터 로딩 중...</td></tr>');

    $.ajax({
        url: "{% url 'get_sent_sms_list' %}", // utils.py 연결
        type: "POST",
        data: { 
            seq_no: seq_no, 
            csrfmiddlewaretoken: '{{ csrf_token }}' 
        },
        success: function(res) {
            if (res.status === 'success' && res.data.length > 0) {
                let html = '';
                res.data.forEach((item, idx) => {
                    const shortContent = item.sms_contents.length > 30 ? 
                                        item.sms_contents.substring(0, 30) + '...' : item.sms_contents;
                    html += `
                        <tr class="sms-row" onclick="toggleSmsDetail(${idx})">
                            <td class="p-2"><span class="badge bg-outline-primary">${item.sms_class_nm}</span></td>
                            <td class="p-2 text-dark font-weight-bold">${shortContent}</td>
                            <td class="p-2 text-muted small">${item.sms_tel_no}</td>
                            <td class="p-2 text-muted small">${item.sms_send_dt}</td>
                        </tr>
                        <tr id="smsDetail_${idx}" class="sms-detail-content" style="display:none; background-color: #fafafa;">
                            <td colspan="4" class="p-3">
                                <div class="sms-detail-container">${item.sms_contents}</div>
                            </td>
                        </tr>
                    `;
                });
                $tbody.html(html);
            } else {
                $tbody.html('<tr><td colspan="4" class="text-center p-4 text-muted">발송 내역이 없습니다.</td></tr>');
            }
        },
        error: function() {
            $tbody.html('<tr><td colspan="4" class="text-center p-4 text-danger">로딩 실패</td></tr>');
        }
    });
};
// 아코디언 토글 함수 - 배타적 토글(하나만 열기) 적용
window.toggleSmsDetail = function(idx) {
    const $target = $(`#smsDetail_${idx}`);
    const $currentRow = $target.prev('.sms-row');

    // 다른 열려있는 내용 닫기
    $('.sms-detail-content').not($target).hide();
    $('.sms-row').not($currentRow).removeClass('active-row');

    // 현재 대상 토글
    if ($target.is(':visible')) {
        $target.hide();
        $currentRow.removeClass('active-row');
    } else {
        $target.fadeIn(150);
        $currentRow.addClass('active-row');
    }
};
(function() {
	const $modal = $('#smsModal');
	if (!$modal.length) return;
	const $form = $modal.find('#smsForm');
	const $content = $modal.find('#smsContent');
	const $charCount = $modal.find('#smsCharCount');
	const $status = $modal.find('.sms-status');

	// [중요] 3. 처음부터 내역 탭이 열려있거나, 탭을 전환할 때 호출하는 통합 로직
	function checkAndLoadHistory() {
			// 현재 활성화된 탭 확인 (id가 task-2인 탭이 active인지)
			const isActiveHistoryTab = $('#smsTabs .nav-link.active').attr('href') === '#task-2';
			const seq_no = $('#smsSeqNo').val();

			if (isActiveHistoryTab && seq_no) {
					console.log('[History] 내역 로드 실행');
					window.loadSmsSentList(seq_no);
			}
	}

	// 모달이 완전히 화면에 떴을 때 실행 (처음부터 task-2가 active인 경우 대비)
	$modal.on('shown.bs.modal', function() {
			checkAndLoadHistory();
	});
	// 사용자가 탭을 클릭해서 전환했을 때 실행
	$(document).on('shown.bs.tab', 'a[data-bs-toggle="tab"]', function (e) {
			if ($(e.target).attr('href') === '#task-2') {
					const seq_no = $('#smsSeqNo').val();
					if (seq_no) window.loadSmsSentList(seq_no);
			}
	});

	function updateCharCount() {
		const len = ($content.val() || '').length;
		$charCount.text(len + '자');
	}

	function getCsrfToken() {
		return $form.find('input[name="csrfmiddlewaretoken"]').val() || '{{ csrf_token }}';
	}
	// [modal.html] <script> 내부의 window.prepareSmsModal 수정
	window.prepareSmsModal = function(seq_no, receiver, sender) {
			$('#smsForm')[0].reset();
      $('#smsSeqNo').val(seq_no || '');
			$form[0].reset();
			$modal.find('#smsSeqNo').val(seq_no || '');
			$status.text('').removeClass('text-success').addClass('text-danger');
      // 새 회원 선택 시 항상 1번 탭으로 되돌리고 이전 내역 초기화
      const tabTriggerEl = document.querySelector('#smsTabs a[href="#task-1"]');
      if (tabTriggerEl) {
          const tabInstance = bootstrap.Tab.getOrCreateInstance(tabTriggerEl);
          tabInstance.show();
      }
      $('#smsSentListBody').html('<tr><td colspan="4" class="text-center p-4 text-muted">발송 내역을 보려면 탭을 열어주세요.</td></tr>');

			const setHints = (recv, send) => {
					if (recv) {
							$modal.find('#smsReceiver').val(recv);
							$modal.find('#smsReceiverHint').text('수신자: ' + recv);
					} else {
							$modal.find('#smsReceiverHint').text('');
					}
					if (send) {
							$modal.find('#smsSender').val(send);
							$modal.find('#smsSenderHint').text('발신자(담당자): ' + send);
					} else {
							$modal.find('#smsSenderHint').text('담당자 번호가 자동 적용됩니다.');
					}
			};

			// 프리필 먼저 세팅
			setHints(receiver, sender);

			// 잔여 포인트 조회
			$.ajax({
					url: "{% url 'get_popbill_balance' %}",
					type: "GET",
					success: function(res) {
							if (res && res.status === 'success') {
									$modal.find('.highlighter-rouge').text(Math.floor(res.availableCount));
							} else {
									$modal.find('.highlighter-rouge').text('조회실패');
							}
					},
					error: function(xhr) {
							console.error('[prepareSmsModal] balance error', xhr);
							$modal.find('.highlighter-rouge').text('조회실패');
					}
			});

			// 번호 프리필(get_sms_prefill) 항상 시도
			if (seq_no) {
					$.ajax({
							url: "{% url 'get_sms_prefill' %}",
							type: "GET",
							data: { seq_no: seq_no },
							success: function(res) {
									if (res && res.status === 'success') {
											setHints(res.receiver, res.sender);
									}
							},
							error: function(xhr) {
									console.error('[prepareSmsModal] prefill error', xhr);
							}
					});
			}

			updateCharCount();
	};

	// 잔여 포인트 새로고침 버튼
	$modal.on('click', '#smsRefreshBalance', function() {
		$modal.find('.highlighter-rouge').text('조회 중...');
		$.ajax({
			url: "{% url 'get_popbill_balance' %}",
			type: "GET",
			success: function(res) {
				if (res && res.status === 'success') {
					$modal.find('.highlighter-rouge').text(Math.floor(res.remainPoint));
				} else {
					$modal.find('.highlighter-rouge').text('조회실패');
				}
			},
			error: function(xhr) {
				console.error('[smsRefreshBalance] balance error', xhr);
				$modal.find('.highlighter-rouge').text('조회실패');
			}
		});
	});

	$content.on('input', updateCharCount);
	updateCharCount();

	$modal.on('click', '#smsSendBtn', function() {
		const payload = {
			seq_no: $modal.find('#smsSeqNo').val(),
			sender: ($modal.find('#smsSender').val() || '').trim(),
			receiver: ($modal.find('#smsReceiver').val() || '').trim(),
			reserve_date: ($modal.find('#smsReserveDate').val() || '').trim(),
			reserve_hour: ($modal.find('#smsReserveHour').val() || '').trim(),
			reserve_min: ($modal.find('#smsReserveMin').val() || '').trim(),
			content: ($modal.find('#smsContent').val() || '').trim(),
			csrfmiddlewaretoken: getCsrfToken()
		};

		if (!payload.receiver || !payload.content) {
			$status.text('수신번호와 내용을 확인하세요.').removeClass('text-success').addClass('text-danger');
			return;
		}

		$status.text('발송 중...').removeClass('text-danger').addClass('text-muted');

		$.ajax({
			url: "{% url 'send_sms_popbill' %}",
			type: "POST",
			data: payload,
			success: function(res) {
				if (res && res.status === 'success') {
					$status.text('발송을 접수했습니다. 접수번호: ' + res.receiptNum).removeClass('text-danger text-muted').addClass('text-success');
				} else {
					$status.text(res && res.message ? res.message : '발송 처리 중 오류가 발생했습니다.').removeClass('text-success text-muted').addClass('text-danger');
				}
			},
			error: function(xhr) {
				const msg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : '발송 실패';
				$status.text(msg).removeClass('text-success text-muted').addClass('text-danger');
			}
		});
	});
  // 이미 바인딩되어 있으면 제거 후 재바인딩
  $(document).off('shown.bs.tab.sms', '#smsTabs a[data-bs-toggle="tab"]');

  $(document).on('shown.bs.tab.sms', '#smsTabs a[data-bs-toggle="tab"]', function (e) {
    const targetHash = e.target.getAttribute('href') || e.target.getAttribute('data-bs-target');
    const seq_no = $('#smsSeqNo').val();

    console.log('[shown.bs.tab] target=', targetHash, 'seq_no=', seq_no);

    if (targetHash === '#task-2') {
      if (seq_no) window.loadSmsSentList(seq_no);
      else console.warn('[Tab Switch] seq_no가 비어있음(prepareSmsModal 호출/세팅 확인 필요)');
    }
  });

  // shown 이벤트가 막히는 경우를 대비해 클릭 시에도 로드 (위임)
  $('#smsTabs').off('click.smsTask2').on('click.smsTask2', 'a[href="#task-2"]', function () {
    const seq_no = $('#smsSeqNo').val();
    console.log('[tab click] seq_no=', seq_no);
    if (seq_no) window.loadSmsSentList(seq_no);
  });

  // 모달 백드롭 정리 공통 함수
  function cleanupBackdrop() {
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('padding-right', '');
  }

  // 메인 모달 닫힐 때: 상세 모달이 열려 있으면 함께 닫고 백드롭 정리
  $modal.on('hidden.bs.modal', function () {
    const $detail = $('#smsDetailViewModal');
    if ($detail.hasClass('show')) {
      $detail.modal('hide');
    }
    // 비동기로 한 번 더 정리해 중복 백드롭을 제거
    setTimeout(cleanupBackdrop, 0);
  });

// 상세 모달이 닫힐 때 메인 모달로 포커스 복구
  $('#smsDetailViewModal').on('hidden.bs.modal', function () {
    $('#smsModal').removeAttr('aria-hidden');
    // 중첩 모달 닫기 후 본문 스크롤 잠김 방지
    if ($('.modal.show').length > 0) {
      $('body').addClass('modal-open');
    }
  });

  // [핵심] 메인 모달이 닫힐 때 모든 마스크 강제 정리 로직
  $modal.on('hide.bs.modal', function () {
    // 1. 상세 모달 인스턴스가 있으면 먼저 닫기
    const detailModalEl = document.getElementById('smsDetailViewModal');
    const detailModal = bootstrap.Modal.getInstance(detailModalEl);
    if (detailModal) {
      detailModal.hide();
    }
  });

  $modal.on('hidden.bs.modal', function () {
    // 2. 부트스트랩이 남긴 모든 잔여물(백드롭, 스타일) 강제 제거
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css({
      'padding-right': '',
      'overflow': ''
    });
  });
})();	
</script>
